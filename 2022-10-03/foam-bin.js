// Generated: Mon Oct 03 2022 00:17:32 GMT-0400 (Eastern Daylight Time)
//
var foam = { main: function() { /* prevent POM loading since code is in-lined below */ } };
(function(){var scripts="";var foam=globalThis.foam=Object.assign({isServer:false,defaultFlags:{dev:true,debug:true,java:false,js:true,node:false,swift:false,web:true},setupFlags:function(){var flags=globalThis.foam.flags;var defaultFlags=foam.defaultFlags;for(var key in defaultFlags)if(!flags.hasOwnProperty(key))flags[key]=defaultFlags[key]},setup:function(){foam.setupFlags();var urlParams=new URLSearchParams(window.location.search);for(var pair of urlParams.entries()){globalThis.foam.flags[pair[0]]=pair[1]=="true"}var path=document.currentScript&&document.currentScript.src;path=path&&path.length>3&&path.substring(0,path.lastIndexOf("src/")+4)||"";if(!globalThis.FOAM_ROOT)globalThis.FOAM_ROOT=path;foam.cwd=path;foam.main()},main:function(){foam.require(document.currentScript.getAttribute("project")||"pom",false,true)},checkFlags:function(flags){if(!flags)return true;function and(fs){fs=fs.split("&");for(var i=0;i<fs.length;i++){if(!foam.flags[fs[i]])return false}return true}for(var i=0;i<flags.length;i++){if(and(flags[i]))return true}return false},require:function(fn,batch,isProject){if(fn){fn=foam.cwd+fn;if(!isProject&&foam.seen(fn))return;scripts+='<script type="text/javascript" src="'+fn+'.js"><\/script>\n'}if(!batch||isProject){document.writeln(scripts);scripts=""}},loadJSLibs:function(libs){libs&&libs.forEach(f=>{var s='<script type="text/javascript" src="'+f.name+'"';if(f.defer)s+=" defer";if(f.async)s+=" async";s+="><\/script>\n";document.writeln(s)})},flags:{},loaded:{},seen:function(fn){if(foam.loaded[fn]){console.warn(`Duplicated load of '${fn}'`);return true}foam.loaded[fn]=true;return false},adaptFlags:function(flags){return typeof flags==="string"?flags.split("|"):flags},checkForFlag:function(flags,desired){if(flags)for(var f of flags){if(f.split("&").includes(desired))return true}return false},core:{},util:{path:function(root,path,opt_ensure){var a=path.split(".");for(var i=0;i<a.length;i++){var nextRoot=root[a[i]];if(nextRoot===undefined){if(opt_ensure){nextRoot=root[a[i]]={}}else{return}}root=nextRoot}return root}},language:typeof navigator==="undefined"?"en":navigator.language,next$UID:function(){var id=1;return function next$UID(){return id++}}(),SCRIPT:function(m){m.class="__Script__";if(foam.checkFlags(m.flags)){m.code();return}m.code()},POM:function(pom){if(globalThis.document){var src=document.currentScript.src;var i=src.lastIndexOf("/");foam.cwd=src.substring(0,i+1);console.log(foam.cwd)}function loadFiles(files,isProjects){files&&files.forEach(f=>{var name=f.name;f.flags=foam.adaptFlags(f.flags);if(!foam.checkFlags(f.flags))return;if(f.predicate&&!f.predicate())return;foam.currentFlags=f.flags||[];foam.require(name,!isProjects,isProjects)})}(foam.loadModules||loadFiles)(pom.projects,true);(foam.loadFiles||loadFiles)(pom.files,false);foam.require(null,false);foam.loadJSLibs(pom.JSLibs)},assert:console.assert.bind(console)},globalThis.foam||{});foam.setup()})();Object.defineProperty(Object.prototype,"$UID",{get:function(){if(!Object.hasOwnProperty.call(this,"$UID__")&&!Object.isFrozen(this)){Object.defineProperty(this,"$UID__",{value:foam.next$UID(),enumerable:false})}return this.$UID__},enumerable:false});foam.LIB=function LIB(model){var root=foam.util.path(globalThis,model.name,true);if(model.constants){foam.assert(typeof model.constants==="object","Constants must be a map.");if(Array.isArray(model.constants)){for(const v of model.constants){root[foam.String.constantize(v.name)]=v.value||v.factory.call(root)}}else{for(var key in model.constants){var v=root[key]=model.constants[key];if(foam.Object.isInstance(v)&&v.class){v=foam.lookup(v.class).create(v)}root[key]=v}}}if(model.methods){foam.assert(Array.isArray(model.methods),"Methods must be an array.");for(i=0;i<model.methods.length;i++){var m=model.methods[i];foam.assert(typeof m==="object"||typeof m==="function","Methods must be a map of a function");foam.assert(typeof m!=="object"||typeof m.code==="function","Methods must have a code key which is a function");var name=m.name||foam.Function.getName(m);foam.assert(name,"Methods must be named with a non-empty string");root[name]=m.code||m}}};foam.LIB({name:"foam.Function",methods:[{name:"getName",code:function named(){}.name==="named"?function(method){return method.name}:function(method){if(typeof method!=="function")return method.name;var match=method.toString().match(/^function\s+([A-Za-z_$][0-9A-Za-z_$]*)\s*\(/);foam.assert(match,"Unable to deduce method name from function");return match[1]}}]});foam.LIB({name:"foam.Undefined",methods:[function isInstance(o){return o===undefined},function is(a,b){return b===undefined},function clone(o){return o},function equals(_,b){return b===undefined},function compare(_,b){return b===undefined?0:1},function hashCode(){return-2}]});foam.LIB({name:"foam.Null",methods:[function isInstance(o){return o===null},function is(a,b){return b===null},function clone(o){return o},function equals(_,b){return b===null},function compare(_,b){return b===null?0:1},function hashCode(){return-3}]});foam.LIB({name:"foam.Boolean",methods:[function isInstance(o){return typeof o==="boolean"},function is(a,b){return a===b},function clone(o){return o},function equals(a,b){return a===b},function compare(a,b){if(!foam.Boolean.isInstance(b))return 1;return a?b?0:1:b?-1:0},function hashCode(o){return o?1:-1}]});foam.LIB({name:"foam.Promise",methods:[{name:"inOrder",code:function inOrder(arry,fn,opt_parentPromise){var parentPromise=opt_parentPromise||Promise.resolve();return arry.reduce((p,v)=>p.then(()=>fn(v)),parentPromise)}}]});foam.LIB({name:"foam.Function",methods:[function isInstance(o){return typeof o==="function"},function is(a,b){return a===b},function clone(o){return o},function equals(a,b){return b?a.toString()===b.toString():false},function compare(a,b){if(!foam.Function.isInstance(b))return 1;return b?foam.String.compare(a.toString(),b.toString()):1},function hashCode(o){return foam.String.hashCode(o.toString())},function bind(f,that,a1,a2,a3,a4){switch(arguments.length){case 1:console.error("No arguments given to bind to.");break;case 2:return function(){return f.apply(that,arguments)};case 3:return function(b1,b2,b3,b4){switch(arguments.length){case 0:return f.call(that,a1);case 1:return f.call(that,a1,b1);case 2:return f.call(that,a1,b1,b2);case 3:return f.call(that,a1,b1,b2,b3);case 4:return f.call(that,a1,b1,b2,b3,b4)}};case 4:return function(b1,b2,b3,b4){switch(arguments.length){case 0:return f.call(that,a1,a2);case 1:return f.call(that,a1,a2,b1);case 2:return f.call(that,a1,a2,b1,b2);case 3:return f.call(that,a1,a2,b1,b2,b3);case 4:return f.call(that,a1,a2,b1,b2,b3,b4)}};case 5:return function(b1,b2,b3,b4){switch(arguments.length){case 0:return f.call(that,a1,a2,a3);case 1:return f.call(that,a1,a2,a3,b1);case 2:return f.call(that,a1,a2,a3,b1,b2);case 3:return f.call(that,a1,a2,a3,b1,b2,b3);case 4:return f.call(that,a1,a2,a3,b1,b2,b3,b4)}};case 6:return function(b1,b2,b3,b4){switch(arguments.length){case 0:return f.call(that,a1,a2,a3,a4);case 1:return f.call(that,a1,a2,a3,a4,b1);case 2:return f.call(that,a1,a2,a3,a4,b1,b2);case 3:return f.call(that,a1,a2,a3,a4,b1,b2,b3);case 4:return f.call(that,a1,a2,a3,a4,b1,b2,b3,b4)}}}console.error("Attempt to foam.Function.bind more than 4 arguments.")},function memoize0(f){var set=false,cache;var ret=foam.Function.setName(function(){if(!set){set=true;cache=f()}return cache},"memoize0("+f.name+")");ret.toString=function(){return f.toString();return`foam.Function.memoize0(${f.toString()})`};ret.args=[];return ret},function memoize1(f){var cache={};var ret=foam.Function.setName(function(key){foam.assert(arguments.length===1,"Memoize1'ed functions must take exactly one argument.");var mKey=key===null?"___null___":key===undefined?"___undefined___":key;if(!cache.hasOwnProperty(mKey))cache[mKey]=f.call(this,key);return cache[mKey]},"memoize1("+f.name+")");ret.toString=function(){return f.toString();return`foam.Function.memoize1(${f.toString()})`};ret.args=[];return ret},function setName(f,name){Object.defineProperty(f,"name",{value:name,configurable:true});return f},function appendArguments(a,args,start){start=start||0;for(var i=start;i<args.length;i++)a.push(args[i]);return a},function argsStr(f){var str=f.toString().replace(/(\r\n|\n|\r)/gm,"");var isArrowFunction=!/(async )?function/.test(str);var match=isArrowFunction?match=str.match(/^(\(([^)]*)\)[^=]*|([^=]+))=>/):match=str.match(/^(async )?function(\s+[_$\w]+|\s*)\((.*?)\)/);if(!match){throw new TypeError("foam.Function.argsStr could not parse input function:\n"+(f?f.toString():"undefined"))}return isArrowFunction?match[2]||match[1]||"":match[3]||""},function argNames(f){var args=foam.Function.argsStr(f);args+=",";var ret=[];var argMatcher=/(\s*\/\*.*?\*\/)?\s*((?:\.\.\.)?[\w_$]+)\s*(\/\*.*?\*\/)?\s*\,+/g;var typeMatch;while((typeMatch=argMatcher.exec(args))!==null){ret.push(typeMatch[2])}return ret},function functionComment(f){var match=f.toString().replace(/\n/g,"_#_%_%_").match(/^function(\s+[_$\w]+|\s*)\(.*?\)(?:\_\#\_\%\_\%\_|\s)*\{(?:\_\#\_\%\_\%\_|\s)*\/\*\*?\s*(.*?)\*?\*\/.*\}/);if(!match){return""}else{return match[2]&&match[2].replace(/_#_%_%_/g,"\n")||""}},function breakdown(f){var ident="([^,\\s\\)]+)";var ws="\\s*";var comment="(?:\\/\\*(?:.|\\s)*?\\*\\/)?";var skip="(?:"+ws+comment+ws+")*";var functionHeader="(async )?"+"function"+skip+ident+"?"+ws+"\\(";var arrowHeader="\\(";var arg="(?:"+skip+ident+skip+")";var nextArg="(?:,"+skip+arg+")";var argEnd=skip+"\\)";var headerToBody=skip+"(?:\\=\\>)?"+skip;var bodyText="((?:.|\\s)*)";var body="\\{"+bodyText+"\\}";var arrowBody=bodyText;var breakdown={name:"",args:[],body:""};var source=f.toString();var lastIndex=0;var currentRegex;function again(){var match=currentRegex.exec(source);if(match)lastIndex=currentRegex.lastIndex;return match}function next(e){prep(e);return again()}function prep(e){currentRegex=new RegExp(e,"my");currentRegex.lastIndex=lastIndex}var isArrow=false;var match=next(functionHeader);if(match){breakdown.async=!!match[1];if(match[2])breakdown.name=match[2]}else{match=next(arrowHeader);if(!match)return null;isArrow=true}match=next(arg);if(match){breakdown.args.push(match[1]);prep(nextArg);while(match=again()){breakdown.args.push(match[1])}}match=next(argEnd);if(!match)return null;if(!next(headerToBody))return null;match=isArrow?next(arrowBody):next(body);if(!match)return null;breakdown.body=match[1];return breakdown},function withArgs(fn,source,opt_self){var argNames=foam.Function.argNames(fn);var args=[];for(var i=0;i<argNames.length;i++){var a=foam.core.FObject.isInstance(source)&&argNames[i].indexOf("$")!=-1?source.slot(argNames[i]).get():source[argNames[i]];if(typeof a==="function")a=a.bind(source);args.push(a)}return fn.apply(opt_self||source,args)},function closure(fn){var ret=fn();ret.toString=function(){return"foam.Function.closure("+fn.toString()+")"};return ret}]});(function(){try{foam.Function.setName(function(){},"")}catch(x){console.warn("foam.Function.setName is not supported on your platform. "+"Stack traces will be harder to decipher, but no "+"functionality will be lost");foam.LIB({name:"foam.Function",methods:[function setName(f){return f}]})}})();foam.LIB({name:"foam.Number",methods:[function isInstance(o){return typeof o==="number"},function is(a,b){return foam.Number.compare(a,b)==0},function clone(o){return o},function equals(a,b){return foam.Number.compare(a,b)==0},function compare(a,b){if(!foam.Number.isInstance(b)||isNaN(a)&&!isNaN(b))return 1;if(!isNaN(a)&&isNaN(b))return-1;return a<b?-1:a>b?1:0},function(){var bufForHash=new ArrayBuffer(8);var floatArrayForHash=new Float64Array(bufForHash);var intArrayForHash=new Int32Array(bufForHash);return function hashCode(n){if(Number.isInteger(n))return n&n;floatArrayForHash[0]=n;var hash=(intArrayForHash[0]<<5)-intArrayForHash[0]+intArrayForHash[1];return hash&hash}}(),{name:"clamp",code:function(min,value,max){if(min!=null&&max==null)return Math.max(min,value);if(min==null&&max!=null)return Math.min(value,max);if(min==null&&max==null)return value;return Math.max(Math.min(value,max),min)}}]});foam.LIB({name:"foam.String",methods:[function isInstance(o){return typeof o==="string"},function is(a,b){return a===b},function clone(o){return o},function equals(a,b){return a===b},function compare(a,b){if(!foam.String.isInstance(b))return 1;return b!=null?a.localeCompare(b):1},function hashCode(s){var hash=-4;for(var i=0;i<s.length;i++){var code=s.charCodeAt(i);hash=(hash<<5)-hash+code;hash&=hash}return hash},{name:"constantize",code:foam.Function.memoize1(function(str){return str.replace(/([a-z])([^0-9a-z_])/g,"$1_$2").toUpperCase()})},{name:"labelize",code:foam.Function.memoize1(function(str){if(str===""||str===null||foam.Undefined.isInstance(str))return"";return this.capitalize(str.replace(/_/g," ").replace(/[a-z][A-Z]/g,function(a){return a.charAt(0)+" "+a.charAt(1)}))})},{name:"capitalize",code:foam.Function.memoize1(function(str){foam.assert(typeof str==="string","Cannot capitalize non-string values.");if(!str)return"";return str[0].toUpperCase()+str.substring(1)})},{name:"pluralize",code:foam.Function.memoize1(function(str){if(str.endsWith("s"))return str+"es";if(str.endsWith("y"))return str.substring(0,str.length-1)+"ies";return str+"s"})},{name:"toSlotName",code:foam.Function.memoize1(function toSlotName(key){foam.assert(typeof key==="string","Cannot toSlotName non-string values.  Attempted: ",key);return key+"$"})},{name:"toUpperCase",code:foam.Function.memoize1(function(str){foam.assert(typeof str==="string","Cannot toUpperCase non-string values.");return str.toUpperCase()})},{name:"toLowerCase",code:foam.Function.memoize1(function(str){foam.assert(typeof str==="string","Cannot toLowerCase non-string values.");return str.toLowerCase()})},{name:"cssClassize",code:foam.Function.memoize1(function(str){foam.assert(typeof str==="string","Cannot cssClassize non-string values.");return str.replace(/\./g,"-")})},function pad(obj,size){return size<0?(new Array(-size).join(" ")+obj).slice(size):(obj+new Array(size).join(" ")).substring(0,size)},function startsWithIC(a,b){foam.assert(typeof a==="string"&&typeof b==="string","Cannot startsWithIC non-string values.");return a.toUpperCase().startsWith(b.toUpperCase())},function(){var map={};return function intern(val){return map[val]||(map[val]=val.toString())}}(),{name:"applyFormat",code:function applyFormat(string,formatString,placeholder,escapeChar){placeholder=placeholder||"x";escapeChar=escapeChar||"\\";var newString="";var escaping=false;var safe=true;formatString.split("").forEach(chr=>{if(escaping){newString+=chr;escaping=false;return}if(chr==escapeChar){escaping=true;return}if(chr==placeholder){if(string.length<1){safe=false;return}newString+=string[0];string=string.slice(1);return}newString+=chr});safe=safe&&string.length==0;if(!safe)console.warn("performed foam.String.applyMask with unsafe inputs");return newString}}]});foam.LIB({name:"foam.Array",methods:[function isInstance(o){return Array.isArray(o)},function is(a,b){return a===b},function shallowClone(o){var ret=new Array(o.length);for(var i=0;i<o.length;i++){ret[i]=o[i]}return ret},function clone(o){var ret=new Array(o.length);for(var i=0;i<o.length;i++){ret[i]=foam.util.clone(o[i])}return ret},function diff(a,b){var added=b.slice(0);var removed=[];for(var i=0;i<a.length;i++){for(var j=0;j<added.length;j++){if(foam.util.equals(a[i],added[j])){added.splice(j,1);j--;break}}if(j===added.length)removed.push(a[i])}return{added:added,removed:removed}},function equals(a,b){if(!b||!Array.isArray(b)||a.length!==b.length)return false;for(var i=0;i<a.length;i++){if(!foam.util.equals(a[i],b[i]))return false}return true},function compare(a,b){if(!b||!Array.isArray(b))return 1;var l=Math.min(a.length,b.length);for(var i=0;i<l;i++){var c=foam.util.compare(a[i],b[i]);if(c)return c}return a.length===b.length?0:a.length<b.length?-1:1},function hashCode(a){var hash=-5;for(var i=0;i<a.length;i++){hash=(hash<<5)-hash+foam.util.hashCode(a[i])}return hash},function remove(a,o){for(var i=0;i<a.length;i++){if(o===a[i]){a.splice(i,1)}}},function unique(a,comparator){var comparator=comparator||foam.util.compare;var sorted=a.sort(comparator);return sorted.reduce(function(acc,value){if(!acc.length||comparator(acc[acc.length-1],value)!=0)acc.push(value);return acc},[])},function filter(a,p){let filtered=[];for(var i=0;i<a.length;i++){if(p.f(a[i]))filtered.push(a[i])}return filtered}]});foam.LIB({name:"foam.RegExp",methods:[function isInstance(o){return o instanceof RegExp},function is(a,b){return a===b},function clone(o){return new RegExp(o)},function equals(a,b){return this.compare(a,b)==0},function compare(a,b){if(!foam.RegExp.isInstance(b))return 1;return foam.String.compare(a.toString(),b.toString())},function hashCode(d){foam.String.hashCode(d.toString())}]});foam.LIB({name:"foam.core.FObject",methods:[function isInstance(o){return false},function clone(o){return o?o.clone():this},function is(a,b){return a===b},function diff(a,b){return a.diff(b)},function equals(a,b){return a.equals(b)},function compare(a,b){if(!foam.core.FObject.isInstance(b))return 1;return a.compareTo(b)},function hashCode(o){return o.hashCode()}]});foam.LIB({name:"foam.Object",methods:[function forEach(obj,f){for(var key in obj){if(obj.hasOwnProperty(key))f(obj[key],key)}},function is(a,b){return a===b},function isInstance(o){return typeof o==="object"&&!Array.isArray(o)&&!foam.core.FObject.isInstance(o)&&!foam.Null.isInstance(o)},function shallowClone(o){const newObj={};for(var key in o){if(o.hasOwnProperty(key)){newObj[key]=o[key]}}return newObj},function clone(o){const newObj={};for(var key in o){if(o.hasOwnProperty(key)){newObj[key]=foam.util.clone(o[key])}}return newObj},function keys(o){return Object.keys(o)},function equals(a,b){if(foam.Object.is(a,b))return true;if(!foam.Object.isInstance(a)||!foam.Object.isInstance(b))return false;if(this.keys(a).length!==this.keys(b).length)return false;for(var key in a){if(!a.hasOwnProperty(key)||!b.hasOwnProperty(key)||!foam.util.equals(a[key],b[key])){return false}}return true},function compare(a,b){if(!foam.Object.isInstance(b))return 1;return foam.Number.compare(a.$UID,b?b.$UID:-1)},function hashCode(o){var hash=19;for(var key in o){if(!o.hasOwnProperty(key))continue;hash=(hash<<5)-hash+foam.util.hashCode(o[key])}return hash},function freeze(o){o.$UID__=foam.next$UID();Object.freeze(o)}]});foam.LIB({name:"foam.Date",constants:{MIN_DATE:new Date(-864e13),MAX_DATE:new Date(864e13)},methods:[function isInstance(o){return o instanceof Date},function is(a,b){return a===b},function clone(o){return new Date(o)},function getTime(d){return d&&d.getTime?d.getTime():d},function equals(a,b){return this.getTime(a)===this.getTime(b)},function compare(a,b){if(!foam.Date.isInstance(b))return 1;return foam.Number.compare(this.getTime(a),this.getTime(b))},function hashCode(d){var n=d.getTime();return n&n},function relativeDateString(date){var seconds=Math.trunc((Date.now()-date.getTime())/1e3);if(seconds>=0&&seconds<60)return"moments ago";if(seconds<0&&seconds>-60)return"in moments";var minutes=Math.trunc(seconds/60);if(minutes===1)return"1 minute ago";if(minutes===-1)return"in 1 minute";if(minutes>=0&&minutes<60)return minutes+" minutes ago";if(minutes<0&&minutes>-60)return"in "+-minutes+" minutes";var hours=Math.trunc(minutes/60);if(hours===1)return"1 hour ago";if(hours===-1)return"in 1 hour";if(hours>=0&&hours<24)return hours+" hours ago";if(hours<0&&hours>-24)return"in "+-hours+" hours";var days=Math.trunc(hours/24);if(days===1)return"1 day ago";if(days===-1)return"in 1 day";if(days>=0&&days<7)return days+" days ago";if(days<0&&days>-7)return"in "+-days+" days";if(days>=0&&days<365||days<0&&days>-365){var year=1900+date.getYear();var noyear=date.toDateString().replace(" "+year,"");return noyear.substring(4)}return date.toDateString().substring(4)},function formatDate(date,timeFirst){if(date===undefined)return"";if(typeof date==="number")date=new Date(date);if(!(date instanceof Date))return"";var formattedDate=date.toLocaleDateString(foam.locale,{year:"numeric",month:"short",day:"2-digit"});if(arguments.length==1)return formattedDate;var formattedTime=date.toLocaleTimeString(foam.locale,{hour12:false,hour:"2-digit",minute:"2-digit",second:"2-digit"});return(timeFirst?formattedTime+" ":"")+formattedDate+(!timeFirst?" "+formattedTime:"")}]});foam.typeOf=function(){var tNumber=foam.Number;var tString=foam.String;var tUndefined=foam.Undefined;var tNull=foam.Null;var tBoolean=foam.Boolean;var tArray=foam.Array;var tDate=foam.Date;var tFObject=foam.core.FObject;var tFunction=foam.Function;var tObject=foam.Object;var tRegExp=foam.RegExp;return function typeOf(o){if(tNumber.isInstance(o))return tNumber;if(tString.isInstance(o))return tString;if(tUndefined.isInstance(o))return tUndefined;if(tNull.isInstance(o))return tNull;if(tBoolean.isInstance(o))return tBoolean;if(tArray.isInstance(o))return tArray;if(tDate.isInstance(o))return tDate;if(tFunction.isInstance(o))return tFunction;if(tFObject.isInstance(o))return tFObject;if(tRegExp.isInstance(o))return tRegExp;return tObject}}();foam.core.FObject.ordinal=0;foam.Date.ordinal=1;foam.RegExp.ordinal=2;foam.Object.ordinal=3;foam.Function.ordinal=4;foam.Array.ordinal=5;foam.String.ordinal=6;foam.Number.ordinal=7;foam.Boolean.ordinal=8;foam.Null.ordinal=9;foam.Undefined.ordinal=10;foam.LIB({name:"foam",methods:[function mmethod(map,opt_defaultMethod){var uid="__mmethod__"+foam.next$UID()+"__";var first=true;var name;for(var key in map){name=map[key].name;break}var f=function(arg1){if(first){for(var key in map){var type=key==="FObject"?foam.core.FObject:foam[key]||foam.lookup(key);type[uid]=map[key]}first=false}var type=arg1&&arg1.cls_&&arg1.cls_[uid]?arg1.cls_:foam.typeOf(arg1);if(!opt_defaultMethod){foam.assert(type,"Unknown type: ",arg1,"and no default method provided");foam.assert(type[uid],"Missing "+name+" multi-method for type ",arg1," map: ",map,"and no default method provided")}return(type[uid]||opt_defaultMethod).apply(this,arguments)};f.toString=function(){var mapString="{";var first=true;for(var key in map){if(!first)mapString+=",";mapString+=`"${key}":${map[key].toString()}`;first=false}mapString+="}";var defaultMethodStr=opt_defaultMethod?opt_defaultMethod.toString():"null";return`foam.mmethod(${mapString}, ${defaultMethodStr})`};f.map=map;f.defaultMethod=opt_defaultMethod;f.args=[];return f}]});(function(){var typeOf=foam.typeOf;foam.LIB({name:"foam.util",methods:[function clone(o){return typeOf(o).clone(o)},function equals(a,b){var typeA=typeOf(a);var typeB=typeOf(b);return typeA===typeB&&typeA.equals(a,b)},function is(a,b){var aType=typeOf(a);var bType=typeOf(b);return aType===bType&&aType.is(a,b)},function compare(a,b){var aType=typeOf(a);var bType=typeOf(b);return aType.ordinal>bType.ordinal?1:aType.ordinal<bType.ordinal?-1:aType.compare(a,b)},function hashCode(o){return typeOf(o).hashCode(o)},function diff(a,b){var t=typeOf(a);return t.diff?t.diff(a,b):undefined},function flagFilter(flags){return function(a){if(!flags)return true;if(!a.flags||!a.flags.length)return true;for(var i=0,f;f=flags[i];i++){if(a.flags.indexOf(f)!=-1)return true}return false}},function isPrimitive(value){return typeof value==="string"||typeof value==="number"||typeof value==="boolean"||foam.Date.isInstance(value)}]})})();foam.LIB({name:"foam.package",methods:[function registerClass(cls){foam.assert(typeof cls==="object","cls must be an object");foam.assert(typeof cls.name==="string"&&cls.name!=="","cls must have a non-empty string name");var pkg=foam.package.ensurePackage(globalThis,cls.package);pkg[cls.name]=cls},function registerClassFactory(m,thunk){var pkg=foam.package.ensurePackage(globalThis,m.package);var tmp;Object.defineProperty(pkg,m.name,{configurable:true,get:function(){if(tmp)return tmp;tmp=thunk();return tmp}})},function ensurePackage(root,path){if(!path)return root;foam.assert(typeof path==="string","Cannot make a package path of a non-string");return foam.util.path(root,path,true)}]});foam.LIB({name:"foam.uuid",methods:[function randomGUID(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(c){var r=Math.random()*16|0;var v=c==="x"?r:r&3|8;return v.toString(16)})}]});foam.LIB({name:"foam.compare",methods:[function toCompare(c){return foam.Array.isInstance(c)?foam.compare.compound(c):foam.Function.isInstance(c)?{compare:c}:c},function compound(args){var cs=args.map(foam.compare.toCompare);if(cs.lengh===1)return cs[0];var f={compare:function(o1,o2){for(var i=0;i<cs.length;i++){var r=cs[i].compare(o1,o2);if(r!=0)return r}return 0}};return f}]});foam.LIB({name:"foam.CSS",methods:[function getTokenValue(tokenString,cls,ctx){if(!tokenString?.startsWith("$"))return tokenString;var[tokenName,cls]=foam.CSS.returnTokenAndClass(tokenString,cls);var result=cls&&cls[foam.String.constantize(tokenName)];if(!result){var defaultsCls=ctx.lookup("foam.u2.CSSTokens");result=defaultsCls[foam.String.constantize(tokenName)]}if(foam.Function.isInstance(result?.value)){const expr=foam.css.TokenUtilsBuilder.create();var ret=result.value(expr).f({cls_:cls,__subContext__:ctx});if(ret)ret=foam.CSS.returnTokenValue(ret,cls,ctx);return ret||result.fallback||`/* failed mlang token replacement ${tokenString}, ${cls}*/`}if(result?.value?.startsWith("$")){var ret=this.getTokenValue(result.value,cls,ctx);return ret||result.fallback||`/* failed token replacement ${tokenString}, ${cls}*/`}return result?.value||result?.fallback},function returnTokenAndClass(tokenString,cls){tokenString=tokenString.substring(1);if(tokenString.indexOf(".")!=-1){fullString=tokenString;tokenName=tokenString.substring(tokenString.lastIndexOf(".")+1);cls=foam.maybeLookup(tokenString.substring(0,tokenString.lastIndexOf(".")))||""}else{tokenName=tokenString;cls=foam.String.isInstance(cls)?foam.maybeLookup(cls)||"":cls;fullString=cls?.id+"."+tokenName}return[tokenName,cls,fullString]},function returnTokenValue(token,cls,ctx){let tokenFinder=ctx?.cssTokenOverrideService?.getTokenValue||foam.CSS.getTokenValue;return tokenFinder(token,cls,ctx)},function replaceTokens(text,cls,ctx,opt_tokenPattern){let foundTokens=[];const tokenPattern=opt_tokenPattern||new RegExp(/\$[^;!]*/,"g");let tokensToFind=text.match(tokenPattern);if(!tokensToFind?.length)return text;for(var i=0;i<tokensToFind.length;i++){let sanitizedToken=opt_tokenPattern?tokensToFind[i].match(/\$[^\*\s]*/)[0]:tokensToFind[i];let replacement=foam.CSS.returnTokenValue(sanitizedToken,cls,ctx);foundTokens[tokensToFind[i]]={sanitizedToken:sanitizedToken,value:replacement}}return text.replace(tokenPattern,function(match){return foundTokens[match]?`/*${foundTokens[match].sanitizedToken}*/ ${foundTokens[match].value}`:"/* Token not found */"})}]});foam.LIB({name:"foam.events",methods:[function oneTime(listener){return function(subscription){subscription.detach();listener.apply(this,Array.from(arguments))}},function consoleLog(listener){return function(){var args=Array.from(arguments);console.log(args);listener&&listener.apply(this,args)}}]});foam.SCRIPT({package:"foam.core",name:"ContextScript",requires:["foam.core.ConstantSlot"],code:function(){(function(){var __context__={isContext:true,lookup:function(id){var ret=typeof id==="string"&&this.__cache__[id];foam.assert(ret,"Could not find any registered class for",id);return foam.Function.isInstance(ret)?ret():ret},maybeLookup:function(id){var ret=foam.String.isInstance(id)&&this.__cache__[id];return foam.Function.isInstance(ret)?ret():ret},register:function(cls,opt_id){foam.assert(typeof cls==="object","Cannot register non-objects into a context.");if(this===foam.__context__)foam.package.registerClass(cls);if(opt_id){this.registerInCache_(cls,this.__cache__,opt_id)}else{foam.assert(typeof cls.id==="string","Must have an .id property to be registered in a context.");this.registerInCache_(cls,this.__cache__,cls.id);if(cls.package==="foam.core"){this.registerInCache_(cls,this.__cache__,cls.name)}}},registerFactory:function(m,factory){foam.assert(typeof m.id==="string","Must have an .id property to be registered in a context.");if(this===foam.__context__)foam.package.registerClassFactory(m,factory);this.registerInCache_(factory,this.__cache__,m.id);if(m.package==="foam.core"){this.registerInCache_(factory,this.__cache__,m.name)}},isRegistered:function(id){return!!this.__cache__[id]},isDefined:function(id){return!!this.__cache__[id]&&!foam.Function.isInstance(this.__cache__[id])},registerInCache_:function registerInCache_(cls,cache,name){var hasOld=Object.prototype.hasOwnProperty.call(cache,name);var old=cache[name];foam.assert(!hasOld||foam.Function.isInstance(old)&&!foam.Function.isInstance(cls),name,"is already registered in this context.");cache[name]=cls},toSlotName_:foam.Function.memoize1(function toSlotName_(key){return key+"$"}),createSubContext:function createSubContext(opt_args,opt_name){if(!opt_args)return this;foam.assert(opt_name===undefined||typeof opt_name==="string","opt_name must be left undefined or be a string.");var sub=Object.create(this);if(opt_name){Object.defineProperty(sub,"NAME",{value:opt_name,enumerable:false})}for(var key in opt_args){if(opt_args.hasOwnProperty(key)){let v=opt_args[key];if(!foam.core.Slot.isInstance(v)){Object.defineProperty(sub,this.toSlotName_(key),{value:foam.core.ConstantSlot.create({value:v}),enumerable:true});Object.defineProperty(sub,key,{value:v,enumerable:true})}else{Object.defineProperty(sub,this.toSlotName_(key),{value:v,enumerable:true});Object.defineProperty(sub,key,{get:function(){return v.get()},enumerable:true})}}}Object.defineProperty(sub,"__cache__",{value:Object.create(this.__cache__),enumerable:false});foam.Object.freeze(sub);return sub},clone:function(){return this}};Object.defineProperty(__context__,"__cache__",{value:{},enumerable:false});foam.lookup=function(id){return foam.__context__.lookup(id)};foam.maybeLookup=function(id){return foam.__context__.maybeLookup(id)};foam.register=function(cls,opt_id){foam.__context__.register(cls,opt_id)};foam.createSubContext=function(opt_args,opt_name){return foam.__context__.createSubContext(opt_args,opt_name)};foam.isRegistered=function(id){return foam.__context__.isRegistered(id)};foam.isDefined=function(id){return foam.__context__.isDefined(id)};foam.__context__=__context__})()}});foam.LIB({name:"foam.boot",constants:{startTime:Date.now()},methods:[function buildClass(x){var context=x||this.__context__||foam.__context__;var cls;if(this.refines){if(!foam.checkFlags(this.flags)){return context.lookup(this.refines)}cls=context.lookup(this.refines);foam.assert(cls,"Unknown refinement class: "+this.refines+" in: "+this.id)}else{foam.assert(this.name,"Missing class name.",this);foam.assert(this.id,"Missing class id: ",this.name);var parent=this.extends?context.lookup(this.extends):foam.core.FObject;foam.assert(parent,"Missing parent.",this.name);cls=parent.createSubClass_();cls.prototype.cls_=cls;cls.prototype.model_=this;cls.count_=0;cls.id=this.id;cls.package=this.package;cls.name=this.name;cls.model_=this;if(cls!==foam.core.FObject){cls.pubsub_=foam.core.FObject.create();parent.pubsub_&&parent.pubsub_.sub("installAxiom",function(_,a1,a2,a3){cls.private_.axiomCache={};cls.pubsub_.pub(a1,a2,a3)})}}cls.installModel(this);return cls},function start(){var buildClass=this.buildClass;foam.CLASS=function(m){m.class=m.class||"foam.core.Model";m.id=m.package+"."+m.name;var cls=buildClass.call(m);foam.assert(!m.refines,"Refines is not supported in early bootstrap");foam.register(cls);return cls};let l=globalThis.localStorage&&globalThis.localStorage.getItem("localeLanguage");var locale_;Object.defineProperty(foam,"locale",{get:function(){return locale_},set:function(l){locale_=l;foam.lang=l.substring(0,2);foam.variant=l.substring(3)},configurable:false});foam.locale=l||"en";foam.xmsg=globalThis.window&&globalThis.window.location.href.indexOf("XMSG")!=-1},function phase2(){foam.pubsub=foam.core.FObject.create();foam.CLASS=function(m,skipRegistration){var cls=m.class?foam.lookup(m.class):foam.core.Model;var model=cls.create(m);model.validate();cls=model.buildClass();cls.validate();if(skipRegistration)return cls;if(!m.refines){foam.register(cls);foam.pubsub.pub("defineClass",cls.id,cls)}return cls};for(var key in foam.core){var m=foam.lookup(key).model_;m.refines=m.id;foam.CLASS(m,true)}},function phase3(){foam.core.FObject.installModel=function installModel(m){if(m.source)m.axioms_.forEach(function(a){a.source=m.source});this.installAxioms(m.axioms_)}},function end(){var Model=foam.core.Model;for(var key in foam.core){var c=foam.core[key];c.prototype.model_=c.model_=Model.create(c.model_)}delete foam.boot}]});foam.boot.start();foam.LIB({name:"foam.core.FObject",constants:{prototype:{get __context__(){return foam.__context__}},axiomMap_:{},private_:{axiomCache:{}}},methods:[function create(args,opt_parent){var obj=Object.create(this.prototype);this.count_++;obj.instance_={};obj.initArgs(args,opt_parent);var axioms=this.getInitAgents();for(var i=0;i<axioms.length;i++){axioms[i].initObject(obj)}obj.init();return obj},function createSubClass_(){foam.core.FObject.createSubClass_=function(){var cls=Object.create(this);cls.prototype=Object.create(this.prototype);cls.axiomMap_=Object.create(this.axiomMap_);cls.private_={axiomCache:{}};return cls};return this},function getSuperClass(){return this.model_.__context__.lookup(this.model_.extends)},function installAxioms(axs){if(!axs||!axs.length)return;this.private_.axiomCache={};axs=axs.sort(function(a,b){return foam.Number.compare(b.priority||100,a.priority||100)});var existing=new Array(axs.length);for(var i=0;i<axs.length;i++){if(foam.String.isInstance(axs[i].class)){var axsCls=foam.maybeLookup(axs[i].class);if(axsCls)axs[i]=axsCls.create(axs[i])}var a=axs[i];a.sourceCls_=this;if(Object.prototype.hasOwnProperty.call(this.axiomMap_,a.name)){existing[i]=this.axiomMap_[a.name]}this.axiomMap_[a.name]=a}for(var i=0;i<axs.length;i++){var a=axs[i];var superAxiom=this.getSuperAxiomByName(a.name);a.installInClass&&a.installInClass(this,superAxiom,existing[i]);a.installInProto&&a.installInProto(this.prototype,superAxiom,existing[i]);if(a.name){this.pubsub_&&this.pubsub_.pub("installAxiom",a.name,a)}}},function installAxiom(a){this.installAxioms([a])},function installConstant(key,value){var cName=foam.String.constantize(key);var prev=this[cName];if(prev&&prev.name!==key){throw"Class constant conflict: "+this.id+"."+cName+" from: "+key+" and "+prev.name}else{this.prototype[cName]=this[cName]=value}},function isInstance(o){return!!(o&&o.cls_&&this.isSubClass(o.cls_))},function isSubClass(c){if(!c||!c.id||!c.prototype)return false;var cache=this.private_.isSubClassCache||(this.private_.isSubClassCache={});if(cache[c.id]===undefined){cache[c.id]=c===this.prototype.cls_||c.getAxiomByName&&!!c.getAxiomByName("implements_"+this.id)||this.isSubClass(c.__proto__)}return cache[c.id]},function getAxiomByName(name){return this.axiomMap_[name]},function getAxiomsByClass(cls){var as=this.private_.axiomCache[cls.id];if(!as){as=[];for(var key in this.axiomMap_){var a=this.axiomMap_[key];if(cls.isInstance(a))as.push(a)}this.private_.axiomCache[cls.id]=as}return as},function getSuperAxiomByName(name){return this.axiomMap_.__proto__[name]},function hasOwnAxiom(name){return Object.hasOwnProperty.call(this.axiomMap_,name)},function getOwnAxiomsByClass(cls){return this.getAxiomsByClass(cls).filter(function(a){return this.hasOwnAxiom(a.name)}.bind(this))},function getOwnAxioms(){return this.getAxioms().filter(function(a){return this.hasOwnAxiom(a.name)}.bind(this))},function getAxioms(){var as=this.private_.axiomCache[""];if(!as){as=[];for(var key in this.axiomMap_)as.push(this.axiomMap_[key]);this.private_.axiomCache[""]=as}return as},function getInitAgents(){if(!this.private_.initAgentsCache){this.private_.initAgentsCache=[];for(var key in this.axiomMap_){var axiom=this.axiomMap_[key];if(axiom.initObject)this.private_.initAgentsCache.push(axiom)}}return this.private_.initAgentsCache},function validate(){},function toString(){return this.name+"Class"},function installModel(m){if(m.methods){for(var i=0;i<m.methods.length;i++){var a=m.methods[i];if(foam.Function.isInstance(a)){var name=foam.Function.getName(a);m.methods[i]=a={name:name,code:a}}if(foam.core.Method){foam.assert(a.cls_!==foam.core.Method,"Method",a.name,"on",m.name,"has already been upgraded to a Method");a=foam.core.Method.create(a);this.installAxiom(a)}else{this.prototype[a.name]=a.code}}}if(foam.core.Property&&m.properties){for(var i=0;i<m.properties.length;i++){var a=m.properties[i];if(Array.isArray(a)){m.properties[i]=a={name:a[0],value:a[1]}}else if(foam.String.isInstance(a)){m.properties[i]=a={name:a}}var type=foam.maybeLookup(a.class)||foam.core.Property;foam.assert(type!==a.cls_,"Property",a.name,"on",m.name,"has already been upgraded to a Property.");a=type.create(a);this.installAxiom(a)}}}]});
foam.CLASS({package:"foam.core",name:"FObject",methods:[function init(){},function initArgs(args){if(!args)return;for(var key in args)this[key]=args[key]},function hasOwnProperty(name){return!foam.Undefined.isInstance(this.instance_[name])},function hasDefaultValue(name){if(!this.hasOwnProperty(name))return true;var axiom=this.cls_.getAxiomByName(name);return axiom.isDefaultValue(this[name])},function clearProperty(name){var prop=this.cls_.getAxiomByName(name);foam.assert(prop&&foam.core.Property.isInstance(prop),"Attempted to clear non-property",name);if(this.hasOwnProperty(name)){var oldValue=this[name];this.instance_[name]=undefined;this.clearPrivate_(name);if(this.hasListeners("propertyChange",name)){this.pub("propertyChange",name,this.slot(name))}}},function setPrivate_(name,value){(this.private_||(this.private_={}))[name]=value;return value},function getPrivate_(name){return this.private_&&this.private_[name]},function hasOwnPrivate_(name){return this.private_&&!foam.Undefined.isInstance(this.private_[name])},function clearPrivate_(name){if(this.private_)this.private_[name]=undefined},function validate(){var as=this.cls_.getAxioms();for(var i=0;i<as.length;i++){var a=as[i];a.validateInstance&&a.validateInstance(this)}},function createListenerList_(){return{next:null}},function listeners_(){return this.getPrivate_("listeners")||this.setPrivate_("listeners",this.createListenerList_())},function notify_(listeners,a){var count=0;while(listeners){var l=listeners.l;var s=listeners.sub;try{switch(a.length){case 0:l(s);break;case 1:l(s,a[0]);break;case 2:l(s,a[0],a[1]);break;case 3:l(s,a[0],a[1],a[2]);break;case 4:l(s,a[0],a[1],a[2],a[3]);break;case 5:l(s,a[0],a[1],a[2],a[3],a[4]);break;case 6:l(s,a[0],a[1],a[2],a[3],a[4],a[5]);break;case 7:l(s,a[0],a[1],a[2],a[3],a[4],a[5],a[6]);break;case 8:l(s,a[0],a[1],a[2],a[3],a[4],a[5],a[6],a[7]);break;case 9:l(s,a[0],a[1],a[2],a[3],a[4],a[5],a[6],a[7],a[8]);break;default:l.apply(l,[s].concat(Array.from(a)))}}catch(x){if(foam._IS_DEBUG_)console.warn("Listener threw exception",x)}listeners=listeners.next;count++}return count},function hasListeners(){var listeners=this.getPrivate_("listeners");for(var i=0;listeners;i++){if(listeners.next)return true;if(i==arguments.length)return false;listeners=listeners.children&&listeners.children[arguments[i]]}return false},function pub(a1,a2,a3,a4,a5,a6,a7,a8){switch(arguments.length){case 0:return this.pub_([]);case 1:return this.pub_([a1]);case 2:return this.pub_([a1,a2]);case 3:return this.pub_([a1,a2,a3]);case 4:return this.pub_([a1,a2,a3,a4]);case 5:return this.pub_([a1,a2,a3,a4,a5]);case 6:return this.pub_([a1,a2,a3,a4,a5,a6]);case 7:return this.pub_([a1,a2,a3,a4,a5,a6,a7]);case 8:return this.pub_([a1,a2,a3,a4,a5,a6,a7,a8]);default:return this.pub_(arguments)}},function pub_(args){if(!this.hasOwnPrivate_("listeners"))return 0;var listeners=this.listeners_();var count=this.notify_(listeners.next,args);for(var i=0;i<args.length;i++){listeners=listeners.children&&listeners.children[args[i]];if(!listeners)break;count+=this.notify_(listeners.next,args)}return count},function sub(){var l=arguments[arguments.length-1];foam.assert(foam.Function.isInstance(l),"Listener must be a function");var listeners=this.listeners_();for(var i=0;i<arguments.length-1;i++){var children=listeners.children||(listeners.children={});listeners=children[arguments[i]]||(children[arguments[i]]=this.createListenerList_())}var node={sub:{src:this},next:listeners.next,prev:listeners,l:l};node.sub.detach=function(){if(node.prev){node.prev.next=node.next;if(node.next)node.next.prev=node.prev}node.prev=null};if(listeners.next)listeners.next.prev=node;listeners.next=node;return node.sub},function pubPropertyChange_(prop,oldValue,newValue){if(Object.is(oldValue,newValue))return;if(foam.Date.isInstance(newValue)&&foam.Date.equals(newValue,oldValue))return;if(!this.hasListeners("propertyChange",prop.name))return;var slot=prop.toSlot(this);slot.setPrev(oldValue);this.pub("propertyChange",prop.name,slot)},function slot(obj){if(typeof obj==="function"){return foam.core.ExpressionSlot.create(arguments.length===1?{code:obj,obj:this}:{code:obj,obj:this,args:Array.prototype.slice.call(arguments,1)})}if(foam.Array.isInstance(obj)){return foam.core.ExpressionSlot.create({obj:this,args:obj[0].map(this.slot.bind(this)),code:obj[1]})}if(obj.includes("$")&&this[obj+"$"]){return this[obj+"$"]}var split=obj.indexOf("$");var axiom=this.cls_.getAxiomByName(split<0?obj:obj.slice(0,split));if(axiom==null){throw new Error(`slot() called with unknown axiom: '${obj}' on model '${this.cls_.id}'.`)}else if(!axiom.toSlot){throw new Error(`Called slot() on unslottable axiom: '${obj}' on model '${this.cls_.id}'.`)}var slot=axiom.toSlot(this);if(split>=0)slot=slot.dot(obj.slice(split+1));return slot},function onDetach(d){foam.assert(!d||foam.Function.isInstance(d.detach)||foam.Function.isInstance(d),"Argument to onDetach() must be callable or detachable.");if(d)this.sub("detach",d.detach?d.detach.bind(d):d);return d},function detach(){if(this.instance_.detaching_)return;this.instance_.detaching_=true;this.pub("detach");this.instance_.detaching_=false;this.clearPrivate_("listeners")},function isDetached(){return this.hasOwnProperty("detaching_")},function equals(other){return this.compareTo(other)===0},function compareTo(other){if(other===this)return 0;if(!other)return 1;if(this.model_!==other.model_){return other.model_?foam.util.compare(this.model_.id,other.model_.id):1}var ps=this.cls_.getAxiomsByClass(foam.core.Property).filter(p=>{return!foam.dao.DAOProperty.isInstance(p)&&!foam.dao.ManyToManyRelationshipProperty.isInstance(p)});for(var i=0;i<ps.length;i++){var r=ps[i].compare(this,other);if(r)return r}return 0},function diff(other){var d={};foam.assert(other,"Attempt to diff against null.");foam.assert(other.cls_===this.cls_,"Attempt to diff objects with different classes.",this,other);var ps=this.cls_.getAxiomsByClass(foam.core.Property);for(var i=0,property;property=ps[i];i++){property.diffProperty(this,other,d,property)}return d},function hashCode(){var hash=17;var ps=this.cls_.getAxiomsByClass(foam.core.Property);for(var i=0;i<ps.length;i++){var prop=this[ps[i].name];if(prop.includeInHash){hash=(hash<<5)-hash+foam.util.hashCode(prop);hash&=hash}}return hash},function clone(opt_X){var m={};for(var key in this.instance_){if(this.instance_[key]===undefined)continue;var value=this[key];this.cls_.getAxiomByName(key).cloneProperty(value,m,opt_X,this)}return this.cls_.create(m,opt_X||this.__context__)},function shallowClone(opt_X){var m={};for(var key in this.instance_){if(this.instance_[key]===undefined)continue;var value=this.instance_[key];m[key]=value}return this.cls_.create(m,opt_X||this.__context__)},function copyFrom(o,opt_warn){if(!o)return this;if(o.__proto__===Object.prototype||!o.__proto__){for(var key in o){var name=key.endsWith("$")?key.substring(0,key.length-1):key;var a=this.cls_.getAxiomByName(name);if(a){if(foam.core.Property.isInstance(a)){this[key]=o[key]}else if(foam.core.Import.isInstance(a)){var slot=foam.core.ConstantSlot.create({value:o[key]});Object.defineProperty(this,key+"$",{get:function(){return slot},configurable:true,enumerable:false})}}else if(opt_warn){this.unknownArg(key,o[key])}}return this}var props=this.cls_.getAxiomsByClass(foam.core.Property);if(o.cls_&&(o.cls_===this.cls_||o.cls_.isSubClass(this.cls_))){for(var i=0;i<props.length;i++){var name=props[i].name;if(o.hasOwnProperty(name)||props[i].factory){if(!props[i].copyValueFrom||!props[i].copyValueFrom(this,o))this[name]=o[name]}}return this}if(foam.core.FObject.isInstance(o)){for(var i=0;i<props.length;i++){var name=props[i].name;var otherProp=o.cls_.getAxiomByName(name);if(otherProp&&foam.core.Property.isInstance(otherProp)){if(!props[i].copyValueFrom||!props[i].copyValueFrom(this,o))this[name]=o[name]}}return this}for(var i=0;i<props.length;i++){var name=props[i].name;if(typeof o[name]!=="undefined"){this[name]=o[name]}}return this},function toString(){return this.cls_.id+(this.cls_.prototype===this?"Proto":"")},function toSummary(){return this.id},function dot(name){return this[name+"$"]}]});
foam.CLASS({package:"foam.core",name:"Model",imports:["translationService"],properties:[{name:"id",hidden:true,transient:true,getter:function(){return this.package?this.package+"."+this.name:this.name}},{name:"package",factory:function(){if(this.refines){var i=this.refines.lastIndexOf(".");return i==-1?"":this.refines.substring(0,i)}return""}},"abstract",{name:"name",factory:function(){if(this.refines){var i=this.refines.lastIndexOf(".");return i==-1?this.refines:this.refines.substring(i+1)}return""}},{name:"flags",},{name:"label",expression:function(name,id){var name_=ctrl.__subContext__.translationService.getTranslation(foam.locale,id,name);return foam.String.labelize(name_)}},["extends","FObject"],"refines","javaExtends","order",{name:"documentation",adapt:function(_,d){return typeof d==="function"?foam.String.multiline(d).trim():d}},{name:"axioms_",transient:true,hidden:true,factory:function(){return[]}},{name:"axioms",hidden:true,factory:function(){return[]},postSet:function(_,a){this.axioms_.push.apply(this.axioms_,a)},adapt:function(_,v){if(!Array.isArray(v))return v;var copy;for(var i=0;i<v.length;i++){if(v[i].class){if(!copy)copy=v.slice();copy[i]=foam.lookup(v[i].class).create(v[i])}}return copy||v}},{of:"Property",name:"properties"},{of:"Method",name:"methods"}],methods:[foam.boot.buildClass]});
foam.CLASS({package:"foam.core",name:"Property",extends:"FObject",requires:["foam.core.internal.PropertySlot"],properties:[{name:"name",required:true},{name:"label",expression:function(name){return foam.String.labelize(name)}},"documentation","help",{class:"Boolean",name:"hidden"},"value","factory","adapt","preSet","assertValue","postSet","expression","getter","setter",["cloneProperty",function(value,cloneMap){cloneMap[this.name]=value&&value.clone?value.clone():foam.util.clone(value)}],"final","required",{class:"Boolean",name:"readPermissionRequired",value:false},{class:"Boolean",name:"writePermissionRequired",value:false},{class:"Boolean",name:"includeInHash",value:true},"flags",["fromString",function(str){return str}],["comparePropertyValues",function(o1,o2){return foam.util.compare(o1,o2)}],["isDefaultValue",function(v){return!this.comparePropertyValues(this.value,v)}],{name:"f",transient:true,factory:function(){var name=this.name;return function f(o){return o!=null?o[name]:null}}},{name:"compare",transient:true,factory:function(){var comparePropertyValues=this.comparePropertyValues;var f=this.f;return function compare(o1,o2){return comparePropertyValues(f(o1),f(o2))}}},{name:"diffPropertyValues",transient:true,value:function(v1,v2,diff){if(Array.isArray(v1)){var subdiff=foam.Array.diff(v1,v2);if(subdiff.added.length!==0||subdiff.removed.length!==0){diff[this.name]=subdiff}}else if(!foam.util.equals(v1,v2)){diff[this.name]=v2}return diff}},{name:"diffProperty",transient:true,value:function diffProperty(o1,o2,diff,prop){return prop.diffPropertyValues(prop.f(o1),prop.f(o2),diff)}},{name:"forClass_",transient:true},{class:"Boolean",name:"containsPII"},{class:"Boolean",name:"containsDeletablePII"},{name:"type"},{class:"Boolean",name:"sortable",value:true},{class:"Boolean",name:"sheetsOutput"},"valueToString","unitPropValueToString",{name:"dependsOnPropertiesWithNames",value:[]},"initObject"],methods:[function installInClass(c,superProp,existingProp){var prop=this;if(existingProp)superProp=existingProp;if(superProp&&foam.core.Property.isInstance(superProp)){prop=superProp.createChildProperty_(prop);var es=foam.core.Property.SHADOW_MAP||{};for(var key in es){var e=es[key];for(var j=0;j<e.length;j++){if(this.hasOwnProperty(e[j])&&superProp[key]){prop.clearProperty(key);break}}}c.axiomMap_[prop.name]=prop}if(this.forClass_&&this.forClass_!==c.id&&prop===this){prop=this.clone();prop.sourceCls_=c;c.axiomMap_[prop.name]=prop}prop.forClass_=c.id;c.installConstant(prop.name,prop)},function installInProto(proto){var prop=proto.cls_.getAxiomByName(this.name);if(prop!==this){prop.installInProto(proto);return}var name=prop.name;var adapt=prop.adapt;var assertValue=prop.assertValue;var preSet=prop.preSet;var postSet=prop.postSet;var factory=prop.factory;var getter=prop.getter;var value=prop.value;var hasValue=typeof value!=="undefined";var slotName=name+"$";var isFinal=prop.final;var eFactory=this.exprFactory(prop.expression);var FIP=factory&&prop.name+"_fip";var fip=0;if(factory&&factory.toString().indexOf("/* ignoreWarning */")==-1&&(factory.toString().indexOf("then(")!=-1||factory.toString().indexOf("await")!=-1)){console.error("Invalid Asynchronous Function",proto.cls_.id+"."+prop.name+".factory=",factory)}if(eFactory&&eFactory.toString().indexOf("/* ignoreWarning */")==-1&&(eFactory.toString().indexOf("then(")!=-1||eFactory.toString().indexOf("await")!=-1)){console.error("Invalid Asynchronous Function",proto.cls_.id+"."+prop.name+".expression=",eFactory)}Object.defineProperty(proto,slotName,{get:function propertySlotGetter(){return prop.toSlot(this)},set:function propertySlotSetter(slot2){this.onDetach(prop.toSlot(this).linkFrom(slot2))},configurable:true,enumerable:false});var get=getter?function(){return getter.call(this,prop)}:factory?function factoryGetter(){var v=this.instance_[name];if(v!==undefined)return v;if(fip>10&&this.getPrivate_(FIP)){console.warn("reentrant factory for property:",name);return undefined}var oldFip=fip;fip++;if(oldFip===10)this.setPrivate_(FIP,true);v=factory.call(this,prop);this[name]=v===undefined?null:v;if(oldFip===10)this.clearPrivate_(FIP);fip--;return this.instance_[name]}:eFactory?function eFactoryGetter(){return this.hasOwnProperty(name)?this.instance_[name]:this.hasOwnPrivate_(name)?this.getPrivate_(name):this.setPrivate_(name,eFactory.call(this))}:hasValue?function valueGetter(){var v=this.instance_[name];return v!==undefined?v:value}:function simpleGetter(){return this.instance_[name]};var set=prop.setter?prop.setter:!(postSet||factory||eFactory||adapt||assertValue||preSet||isFinal)?function simplePropSetter(newValue){if(newValue===undefined){this.clearProperty(name);return}var oldValue=this.instance_[name];this.instance_[name]=newValue;this.pubPropertyChange_(prop,oldValue,newValue)}:factory&&!(postSet||eFactory||adapt||assertValue||preSet||isFinal)?function factoryPropSetter(newValue){if(newValue===undefined){this.clearProperty(name);return}var oldValue=this.hasOwnProperty(name)?this[name]:undefined;this.instance_[name]=newValue;if(oldValue!==undefined)this.pubPropertyChange_(prop,oldValue,newValue)}:function propSetter(newValue){if(newValue===undefined){this.clearProperty(name);return}var oldValue=factory?this.hasOwnProperty(name)?this[name]:undefined:eFactory?this.hasOwnPrivate_(name)||this.hasOwnProperty(name)?this[name]:undefined:this[name];if(adapt)newValue=adapt.call(this,oldValue,newValue,prop);if(assertValue)assertValue.call(this,newValue,prop);if(preSet)newValue=preSet.call(this,oldValue,newValue,prop);this.instance_[name]=newValue;if(isFinal){Object.defineProperty(this,name,{value:newValue,writable:false,configurable:true})}if(!factory||oldValue!==undefined)this.pubPropertyChange_(prop,oldValue,newValue);if(postSet)postSet.call(this,oldValue,newValue,prop)};Object.defineProperty(proto,name,{get:get,set:set,configurable:true})},function validateInstance(o){if(this.required&&!o[this.name]){throw"Required property "+o.cls_.id+"."+this.name+" not defined."}},function exprFactory(e){if(!e)return null;var argNames=foam.Function.argNames(e);var name=this.name;return function exportedFactory(){var self=this;var args=new Array(argNames.length);var subs=[];var l=function(){if(!self.hasOwnProperty(name)){var oldValue=self[name];self.clearPrivate_(name);if(self.hasListeners("propertyChange",name)){self.pub("propertyChange",name,self.slot(name))}}for(var i=0;i<subs.length;i++)subs[i].detach()};for(var i=0;i<argNames.length;i++){var slot=this.slot(argNames[i]);if(slot){var s=slot.sub(l);s&&subs.push(s);args[i]=slot.get()}}var ret=e.apply(this,args);if(ret===undefined)this.__context__.warn("Expression returned undefined: ",e,this.name);return ret}},function toString(){return this.name},function get(o){return o[this.name]},function set(o,value){o[this.name]=value;return this},function createChildProperty_(child){var prop=this.clone();if(child.cls_!==foam.core.Property&&child.cls_!==this.cls_){if(this.cls_!==foam.core.Property){this.__context__.warn("Unsupported change of property type from",this.cls_.id,"to",child.cls_.id,"property name",this.name)}return child}prop.sourceCls_=child.sourceCls_;for(var key in child.instance_){prop.instance_[key]=child.instance_[key]}return prop},function exportAs(obj,sourcePath){var slot=this.toSlot(obj);for(var i=0;sourcePath&&i<sourcePath.length;i++){slot=slot.dot(sourcePath[i])}return slot},function toSlot(obj){var slotName=this.slotName_||(this.slotName_=this.name+"$");var slot=obj.getPrivate_(slotName);if(!slot){slot=foam.core.internal.PropertySlot.create();slot.obj=obj;slot.prop=this;obj.setPrivate_(slotName,slot)}return slot},function clone(opt_X){return this.shallowClone(opt_X)}]});
foam.CLASS({package:"foam.core",name:"Simple",extends:"Property",methods:[function installInProto(proto){}]});
foam.CLASS({package:"foam.core",name:"AbstractMethod",properties:[{name:"signature",postSet:function(_,signature){var i3=signature.indexOf("{");if(i3!=-1){this.javaCode=signature.substring(i3+1,signature.lastIndexOf("}")).trim();signature=signature.substring(0,i3).trim()}var[meth,throws]=signature.split(" throws ");var i=meth.indexOf(" ");var type=meth.substring(0,i);var sig=meth.substring(i+1);var i2=sig.indexOf("(");var name=sig.substring(0,i2);var args=sig.substring(i2+1,sig.length-1);this.name=name;this.args=args;this.type=type;if(throws)this.javaThrows=throws.split(",")}},{name:"name",required:true},{name:"code",required:false},"documentation","flags",{name:"type",value:"Void"},{class:"Boolean",name:"async"},{class:"Boolean",name:"synchronized"},{class:"Boolean",name:"remote"},{name:"args",factory:function(){if(this.code)try{var bd=foam.Function.breakdown(this.code);return bd.args}catch(e){console.warn("Unable to parse args:",e)}return[]}}],methods:[function override_(proto,method,superMethod){if(!method){if(this.name=="toDisjunctiveNormalForm"){console.warn("Method code missing for",this.name)}return}if(method.toString().indexOf("SUPER")==-1)return method;var superMethod_=proto.cls_.getSuperAxiomByName(this.name);var super_;if(!superMethod_){var name=this.name;if(name!=="override_"){super_=function(){console.warn("Attempted to use SUPER() in",name,"on",proto.cls_.id,"but no parent method exists.")};super_()}}else{foam.assert(foam.core.AbstractMethod.isInstance(superMethod_),"Attempt to override non-method",this.name,"on",proto.cls_.id);super_=proto.__proto__[this.name]}function SUPER(){return super_.apply(this,arguments)}var f=function superWrapper(){var oldSuper=this.SUPER;this.SUPER=SUPER;try{return method.apply(this,arguments)}finally{this.SUPER=oldSuper}return ret};foam.Function.setName(f,this.name);f.toString=function(){return method.toString()};return f},function createChildMethod_(child){return child},function installInClass(cls,superMethod,existingMethod){var method=this;var parent=superMethod;if(parent&&foam.core.AbstractMethod.isInstance(parent)){method=parent.createChildMethod_(method)}cls.axiomMap_[method.name]=method}]});
foam.CLASS({package:"foam.core",name:"Method",extends:"foam.core.AbstractMethod",methods:[function installInProto(proto,superAxiom){proto[this.name]=this.override_(proto,this.code,superAxiom)},function exportAs(obj){var m=obj[this.name];var f=function exportedMethod(){return m.apply(obj,arguments)};f.toString=()=>{return"exportedMethod "+this.name+" "+m};return f}]});foam.SCRIPT({package:"foam.core",name:"BootPhase2",code:function(){foam.boot.phase2()}});
foam.CLASS({package:"foam.core",name:"Boolean",extends:"Property",properties:[["type","Boolean"],["value",false],["adapt",function adaptBoolean(_,v){return!!v}],["fromString",function(s){s=s.trim().toLowerCase();return s==="true"||s==="t"||s==="1"||s==="yes"||s==="on"}]]});
foam.CLASS({package:"foam.core",name:"AxiomArray",extends:"Property",properties:[{name:"of",required:true},["type","Any[]"],{name:"adapt",value:function(_,a,prop){if(!Array.isArray(a))return a;var copy;for(var i=0;i<a.length;i++){var b=prop.adaptArrayElement.call(this,a[i],prop);if(b!==a[i]){if(!copy)copy=a.slice();copy[i]=b}}return copy||a}},{name:"assertValue",value:function(v,prop){foam.assert(Array.isArray(v),"Tried to set",prop.name,"to non array value");var of=this.__context__.maybeLookup(prop.of);foam.assert(of,'Unknown "of" Model in AxiomArray: property=',prop.name," of=",prop.of);for(var i=0;i<v.length;i++){foam.assert(of.isInstance(v[i]),"Element",i,"of",prop.name,"is not an instance of",prop.of,"at",this.package+"."+this.name,"[",v[i].name,"]")}}},{name:"adaptArrayElement",value:function(a,prop){if(a.class){var m=this.__context__.lookup(a.class);if(!m)throw"Unknown class : "+a.class;return m.create(a,this)}var of=this.__context__.lookup(prop.of);return of.isInstance(a)?a:of.create(a,this)}},["postSet",function(_,a){this.axioms_.push.apply(this.axioms_,a)}]]});foam.core.Property.SHADOW_MAP={setter:["adapt","preSet","postSet"],getter:["factory","expression","value"],factory:["expression","value"],expression:["value"]};
foam.CLASS({refines:"foam.core.Model",properties:[{class:"AxiomArray",of:"Property",name:"properties",adaptArrayElement:function(o){if(typeof o==="string"){var p=foam.core.Property.create();p.name=o;return p}if(Array.isArray(o)){var p=foam.core.Property.create();p.name=o[0];p.value=o[1];return p}if(o.class){var m=this.__context__.lookup(o.class);if(!m)throw"Unknown class : "+o.class;if(!foam.core.Property.isSubClass(m))throw o.class+" isn't a sub-class of Property. Try using class: 'FObjectProperty', of: '"+o.class+"'";return m.create(o,this)}return foam.core.Property.isInstance(o)?o:foam.core.Property.create(o)}},{class:"AxiomArray",of:"Method",name:"methods",adaptArrayElement:function(o,prop){if(typeof o==="function"){var name=foam.Function.getName(o);foam.assert(name,"Method must be named");var m=this.__context__.lookup(prop.of).create();m.name=name;m.code=o;return m}if(this.__context__.lookup(prop.of).isInstance(o))return o;if(o.class)return this.__context__.lookup(o.class).create(o,this);return foam.lookup(prop.of).create(o)}},{class:"String",name:"plural",expression:function(name){return foam.String.labelize(foam.String.pluralize(name))}}]});foam.boot.phase3();
foam.CLASS({refines:"foam.core.FObject",axioms:[{name:"__context__",installInProto:function(p){Object.defineProperty(p,"__context__",{get:function(){var x=this.getPrivate_("__context__");if(!x){var contextParent=this.getPrivate_("contextParent");if(contextParent){this.setPrivate_("__context__",x=contextParent.__subContext__||contextParent.__context__);this.setPrivate_("contextParent",undefined)}else{x=foam.__context__}}return x},set:function(x){if(x){this.setPrivate_(foam.core.FObject.isInstance(x)?"contextParent":"__context__",x)}}});Object.defineProperty(p,"__subContext__",{get:function(){return this.__context__},set:function(){throw new Error("Attempted to set unsettable __subContext__ in "+this.cls_.id)}})}}],methods:[function initArgs(args,ctx){if(ctx)this.__context__=ctx;if(args)this.copyFrom(args,true)},function unknownArg(key,value){}]});foam.boot.end();
foam.CLASS({refines:"foam.core.Property",properties:[{class:"Boolean",name:"transient"},{class:"Boolean",name:"networkTransient",expression:function(transient){return transient}},{class:"Boolean",name:"externalTransient",expression:function(transient){return transient}},{class:"Boolean",name:"storageTransient",expression:function(transient){return transient}},{class:"Boolean",name:"storageOptional"},{class:"Boolean",name:"clusterTransient",expression:function(transient){return transient}}]});(function(){foam.__count=0;foam.__LIBS__=[];foam.__SCRIPTS__=[];var foamLIB=foam.LIB;foam.LIB=function(model){foam.__LIBS__.push(model);foamLIB(model);model.order=foam.__count++};var foamSCRIPT=foam.SCRIPT;foam.SCRIPT=function(model){foam.__SCRIPTS__.push(model);foamSCRIPT(model);model.order=foam.__count++};foam.USED={};foam.UNUSED={};var CLASS=foam.CLASS;foam.CLASS=function(m){if(!m.source&&globalThis.document&&globalThis.document.currentScript){m.source=globalThis.document.currentScript.src}if(!m.name)throw new Error("Unnamed model"+m.refines);m.order=foam.__count++;m.id=m.package?m.package+"."+m.name:m.name;foam.UNUSED[m.id]=m;if(m.refines){if(foam.__context__.isDefined(m.refines)){delete foam.UNUSED[m.id];CLASS(m);foam.USED[m.id]=m}else{foam.pubsub.sub("defineClass",m.refines,function(s){s.detach();delete foam.UNUSED[m.id];CLASS(m);foam.USED[m.id]=m})}return}if(!m.flags&&foam.currentFlags)m.flags=foam.currentFlags;var f=foam.Function.memoize0(function(){delete foam.UNUSED[m.id];try{var c=CLASS(m);foam.USED[m.id]=m;return c}catch(x){console.log("ERROR: Class definition error in",m.id,x);throw x}});foam.__context__.registerFactory(m,f)}})();
foam.CLASS({package:"foam.core",name:"Script",properties:[{class:"String",name:"id",getter:function(){return this.package?this.package+"."+this.name:this.name}},{class:"String",name:"package"},{class:"String",name:"name"},{class:"Function",name:"code"},{name:"flags"},{class:"StringArray",name:"requires"},"order"]});
foam.CLASS({package:"foam.pattern",name:"Faceted",methods:[function installInClass(cls){const axiom=this;var oldCreate=cls.create;cls.getFacetOf=function(of,X){if(!of)return this;X=foam.core.FObject.isInstance(X)?X.__context__:X||foam.__context__;var name;var pkg;if(foam.String.isInstance(of)){name=of.substring(of.lastIndexOf(".")+1);pkg=of.substring(0,of.lastIndexOf("."))}else{name=of.name;pkg=of.package}var id=(pkg?pkg+".":"")+name+this.name;let facet=X.maybeLookup(id)||of[this.name]||this;if(axiom.inherit&&facet===this){const ofCls=foam.String.isInstance(of)?X.maybeLookup(of):of;if(!ofCls||!ofCls.model_.extends)return facet;if(ofCls==foam.core.FObject)return facet;return cls.getFacetOf(X.maybeLookup(ofCls.model_.extends))||facet}return facet};cls.create=function(args,X,ignoreFacets){if(!ignoreFacets){var of=args&&(args.of||args.data&&(args.data.of||args.data.cls_));var facetCls=this.getFacetOf(of,X);if(facetCls!==this)return facetCls.create(args,X,true)}return oldCreate.apply(this,arguments)}}],properties:[["name","foam.pattern.Faceted"],{class:"Boolean",name:"inherit",}]});
foam.CLASS({package:"foam.core",name:"Glyph",imports:["theme?"],properties:[{name:"template",class:"String",expression:function(themeName){if(!this.theme)return"";return this.theme.glyphs[themeName]?this.theme.glyphs[themeName].template:""}},{name:"themeName",class:"String"}],methods:[function expandSVG(values){var val=this.template;if(!val)return;for(k in values)if(values.hasOwnProperty(k)){let K=k.toUpperCase();val=val.replace(new RegExp("/\\*%"+K+'%\\*/[^\\"]*',"g"),values[k])}return val},function getDataUrl(values){var svgText=this.expandSVG(values);return"data:image/svg+xml;base64,"+btoa(svgText.replace(/\n/g,"").trim())}]});
foam.CLASS({package:"foam.core",name:"Int",extends:"Property",properties:["units",["value",0],"min","max",["type","Integer"],["adapt",function adaptInt(_,v){return typeof v==="number"?Math.trunc(v):v?parseInt(v):0}],["fromString",function intFromString(str){return str?parseInt(str):0}]]});
foam.CLASS({package:"foam.core",name:"String",extends:"Property",properties:[{class:"Boolean",name:"trim",value:false},{class:"Int",name:"width",value:30},{name:"adapt",value:function(_,a,p){if(foam.Object.isInstance(a)){if(a[foam.locale]!==undefined)return a[foam.locale];if(a[foam.locale.substring(0,foam.locale.indexOf("-"))]!==undefined)return a[foam.locale.substring(0,foam.locale.indexOf("-"))];return a["en"]}var s=typeof a==="function"||typeof a==="number"?String(a):a&&a.toString?a.toString():"";return p.trim?s.trim():s}},["type","String"],["value",""]]});
foam.CLASS({package:"foam.core",name:"I18NString",extends:"String",properties:[{name:"getter_",value:function(proto,prop,obj,key){if(foam.core.I18NString.GETTER__)return foam.core.I18NString.GETTER__(proto,prop,obj,key);var msg_=obj.instance_[key];if(!foam.i18n||!foam.xmsg)return msg_;return foam.i18n.Lib.createText(prop.sourceCls_.id+"."+this.name,msg_)}},{name:"expression",preSet:function(o,n){var prop=this;var name=this.name;if(!foam.i18n||!foam.xmsg)return n;n.apply=function(o,a){var ret=n.call(o,a[0],a[1],a[2],a[3],a[4],a[5],a[6]);if(!foam.i18n||!foam.xmsg)return ret;return foam.i18n.Lib.createText(prop.sourceCls_.id+"."+name,ret,ret)};return n}}]});
foam.CLASS({package:"foam.core",name:"FormattedString",extends:"String",properties:[{class:"FObjectProperty",of:"foam.u2.TextFormatter",name:"formatter",value:null,}],methods:[function installInClass(cls){this.SUPER(cls);var capitalized=foam.String.capitalize(this.name);var constantize=foam.String.constantize(this.name);var prop=foam.core.String.create({forClass_:cls.id,sourceCls_:cls,name:"formatted"+capitalized,hidden:true,});cls.axiomMap_[prop.name]=prop}]});
foam.CLASS({package:"foam.core",name:"ModelDocumentationRefinement",refines:"foam.core.Model",properties:[{class:"String",name:"documentation"}]});
foam.CLASS({package:"foam.core",name:"Date",extends:"Property",label:"Date",properties:[{name:"toJSON",value:function toJSON(value,outputter){return value==null?null:outputter.formatDatesAsNumbers?value.getTime():value.toISOString()}},{name:"adapt",value:function(_,d){if(typeof d==="number")d=new Date(d);if(typeof d==="string"){var ret=new Date(d);if(isNaN(ret.getTime())){ret=foam.Date.MAX_DATE;console.warn("Invalid date: "+d+"; assuming "+ret.toISOString()+".");return ret}d=ret}if(d==foam.Date.MAX_DATE||d==foam.Date.MIN_DATE)return d;if(foam.Date.isInstance(d)){const DAY=1e3*60*60*24;var timeOfDay=(d.getTime()+1e5*DAY)%DAY;return new Date(d.getTime()-timeOfDay+12*60*6e4)}return d}},["type","Date"],{name:"comparePropertyValues",value:function(o1,o2){if(!o1)return o2?-1:0;if(!o2)return 1;return foam.Date.compare(o1,o2)}},{name:"format",value:function(val){return foam.Date.formatDate(val)}}]});
foam.CLASS({package:"foam.core",name:"DateTime",extends:"Date",label:"Date and time",properties:[["type","DateTime"],{name:"adapt",value:function(_,d){if(typeof d==="number")return new Date(d);if(typeof d==="string"){var ret=new Date(d);if(isNaN(ret.getTime())){ret=foam.Date.MAX_DATE;console.warn("Invalid date: "+d+"; assuming "+ret.toISOString()+".")}return ret}return d}},{name:"format",value:function(val,timeFirst=false){return foam.Date.formatDate(val,timeFirst)}}]});
foam.CLASS({package:"foam.core",name:"Time",extends:"String",label:"Time",properties:[["type","Time"]]});
foam.CLASS({package:"foam.core",name:"Byte",extends:"Int",label:"Round byte numbers",properties:[["type","Byte"],["min",-128],["max",127]]});
foam.CLASS({package:"foam.core",name:"Short",extends:"Int",label:"Round short numbers",properties:[["type","Short"],["min",-32768],["max",32767]]});
foam.CLASS({package:"foam.core",name:"Long",extends:"Int",label:"Round long numbers",properties:[["type","Long"]]});
foam.CLASS({package:"foam.core",name:"Float",extends:"Int",label:"Decimal numbers",properties:["precision",["adapt",function(_,v){return typeof v==="number"?v:v?parseFloat(v):0}],["type","Float"]]});
foam.CLASS({package:"foam.core",name:"Double",extends:"Float",properties:[["type","Double"]]});
foam.CLASS({package:"foam.core",name:"Function",extends:"Property",label:"Code that can be run",properties:[["value",function(){}],["assertValue",function(value,prop){foam.assert(typeof value==="function",prop.name,"Cannot set to non function type.")}]]});
foam.CLASS({package:"foam.core",name:"Object",extends:"Property",properties:[["type","Any"]]});
foam.CLASS({package:"foam.core",name:"Array",extends:"Property",properties:[["factory",function(){return[]}],["isDefaultValue",function(v){return!v||!v.length}],["type","Any[]"]],methods:[function installInProto(proto){this.SUPER(proto);var self=this;["push","splice","unshift"].forEach(func=>{Object.defineProperty(proto,self.name+"$"+func,{get:function classGetter(){return function(...args){let val=this[self.name][func](...args);this.propertyChange.pub(self.name,this.slot(self.name));return val}},configurable:true})});Object.defineProperty(proto,self.name+"$remove",{get:function classGetter(){return function(predicate){let oldArry=this[self.name];let newArry=[];for(let i=0;i<oldArry.length;i++){if(!predicate.f(oldArry[i])){newArry.push(oldArry[i])}}this[self.name]=newArry}},configurable:true});Object.defineProperty(proto,self.name+"$replace",{get:function classGetter(){return function(predicate,value){let arry=this[self.name];for(let i=0;i<arry.length;i++){if(predicate.f(arry[i])){arry[i]=value}}this.propertyChange.pub(self.name,this.slot(self.name))}},configurable:true});Object.defineProperty(proto,self.name+"$filter",{get:function classGetter(){return function(predicate){return foam.Array.filter(this[self.name],predicate)}},configurable:true})}]});
foam.CLASS({package:"foam.core",name:"List",extends:"foam.core.Object",properties:[["type","List"],["factory",function(){return[]}]]});
foam.CLASS({package:"foam.core",name:"StringArray",extends:"Property",label:"List of text strings",properties:[{name:"of",value:"String",},["type","String[]"],["factory",function(){return[]}],["adapt",function(_,v,prop){if(!Array.isArray(v))return v;var copy;for(var i=0;i<v.length;i++){if(typeof v[i]!=="string"){if(!copy)copy=v.slice();copy[i]=prop.adaptArrayElement.call(this,v[i],prop)}}return copy||v}],["adaptArrayElement",function(o,prop){return String(o)}],["assertValue",function(v,prop){if(v===null)return;foam.assert(Array.isArray(v),prop.name,"Tried to set StringArray to non-array type.");for(var i=0;i<v.length;i++){foam.assert(typeof v[i]==="string",prop.name,"Element",i,"is not a string",v[i])}}]]});
foam.CLASS({package:"foam.core",name:"Class",extends:"Property",properties:[{name:"toJSON",value:function toJSON(value,_){return value&&value.id}},["adapt",function(_,v){if(v&&v.class==="__Class__")return v.forClass_;return v}],["type","Class"],["displayWidth",80],["cloneProperty",function(value,cloneMap,_,obj){cloneMap[this.name]=obj.instance_[this.name]}]],methods:[function installInProto(proto){this.SUPER(proto);var name=this.name;var desc=Object.getOwnPropertyDescriptor(proto,name);var adapt=function(value){if(foam.String.isInstance(value)){var cls=this.__context__.maybeLookup(value);if(!cls){console.error(`Property '${name}' of type '${this.model_.name}' was set to '${value}', which isn't a valid class (yet).`);return null}return cls}return value};var get=desc.get;desc.get=function(){return adapt.call(this,get.call(this))};Object.defineProperty(proto,name,desc)}]});
foam.CLASS({package:"foam.core",name:"EMail",extends:"String",label:"Email address",properties:[["displayWidth",50],["preSet",function(_,v){return v.toLowerCase().trim()}]]});
foam.CLASS({package:"foam.core",name:"Image",extends:"String",label:"Image data or link",properties:[["displayWidth",80]]});
foam.CLASS({package:"foam.core",name:"URL",extends:"String",label:"Web link (URL or internet address)",properties:[["displayWidth",80]]});
foam.CLASS({package:"foam.core",name:"Website",extends:"URL",label:`Websites (requires 'http(s)'/'www' links)`});
foam.CLASS({package:"foam.core",name:"Color",extends:"String",label:"Color",properties:[["displayWidth",20]]});
foam.CLASS({package:"foam.core",name:"Password",extends:"String",label:"Password that displays protected or hidden text"});
foam.CLASS({package:"foam.core",name:"PhoneNumber",extends:"String",label:"Phone number",properties:[["displayWidth",20]]});
foam.CLASS({package:"foam.core",name:"Code",extends:"String"});
foam.CLASS({package:"foam.core",name:"UnitValue",extends:"Long",properties:[{class:"String",name:"unitPropName",},{name:"unitPropValueToString",value:async function(x,val,unitPropName){if(unitPropName){const unitProp=await x.currencyDAO.find(unitPropName);if(unitProp)return unitProp.format(val)}return val}}]});
foam.CLASS({package:"foam.core",name:"Map",extends:"Property",properties:[["factory",function(){return{}}],["comparePropertyValues",function(o1,o2){if(foam.typeOf(o1)!=foam.typeOf(o2))return-1;var keys1=Object.keys(o1).sort();var keys2=Object.keys(o2).sort();if(keys1.length<keys2.length)return-1;if(keys1.length>keys2.length)return 1;for(var i=0;i<keys1.length;i++){var c=foam.String.compare(keys1[i],keys2[i]);if(c!=0)return c;c=foam.util.compare(o1[keys1[i]],o2[keys2[i]]);if(c!=0)return c}return 0}],["cloneProperty",function(value,cloneMap){if(value){var tmp=cloneMap[this.name]={};for(var key in value){tmp[key]=value[key]}}}],["diffPropertyValues",function(o1,o2){}],["type","Map"]],methods:[function installInProto(proto){this.SUPER(proto);var self=this;Object.defineProperty(proto,self.name+"$set",{get:function mapSet(){return function(k,v){this[self.name][k]=v;this.propertyChange.pub(self.name,this.slot(self.name))}},configurable:true});Object.defineProperty(proto,self.name+"$remove",{get:function mapRemove(){return function(k){delete this[self.name][k];this.propertyChange.pub(self.name,this.slot(self.name))}},configurable:true})}]});
foam.CLASS({package:"foam.core",name:"FObjectProperty",extends:"Property",properties:[{class:"Class",name:"of",value:"foam.core.FObject"},{name:"type",factory:function(){return this.of.id}},{name:"fromJSON",value:function(json,ctx,prop){return foam.json.parse(json,foam.lookup(prop.type),ctx)}},{name:"adapt",value:function(_,v,prop){if(v===null)return v;var type=foam.lookup(prop.type);return type.isInstance(v)?v:(v.class?this.__context__.lookup(v.class):type).create(v,this.__subContext__)}},{name:"cloneProperty",value:function(value,cloneMap,opt_X){cloneMap[this.name]=value&&value.clone?value.clone(opt_X):value}}],methods:[function xinitObject(obj){var s1,s2;obj.onDetach(function(){s1&&s1.detach();s2&&s2.detach()});var name=this.name;var slot=this.toSlot(obj);function proxyListener(sub){var args=["nestedPropertyChange",name,slot].concat(Array.from(arguments).slice(1));obj.pub.apply(obj,args)}function attach(inner){s1&&s1.detach();s1=inner&&inner.sub&&inner.sub("propertyChange",proxyListener);s2&&s2.detach();s2=inner&&inner.sub&&inner.sub("nestedPropertyChange",proxyListener)}function listener(s,pc,name,slot){attach(slot.get())}obj.sub("propertyChange",name,listener);if(obj[name])attach(obj[name])},function copyValueFrom(targetObj,sourceObj){var name=this.name;if(targetObj[name]&&sourceObj[name]){targetObj[name].copyFrom(sourceObj[name]);return true}return false}]});
foam.CLASS({package:"foam.core",name:"Reference",extends:"Property",properties:[{class:"Class",name:"of"},["type","Any"],{class:"String",name:"targetDAOKey",expression:function(of){if(!of){console.error("invalid 'of' for property with targetDAOKey",this.name)}return foam.String.daoize(of.name)}},{class:"Boolean",name:"enableLink",value:true},{name:"menuKeys",},{class:"String",name:"unauthorizedTargetDAOKey",},{name:"adapt",value:function(oldValue,newValue,prop){return prop.of.isInstance(newValue)?newValue.id:newValue}},{name:"value",expression:function(of){if(of&&!of.ID){console.warn("of.ID not found for: "+of+"."+this.name)}var ret=of?of.ID.value:null;if(!of){console.warn("Of not found for: "+this.name);console.warn("Possible circular reference: Please explicitly set a default value on: "+this.name)}if(ret===undefined){console.warn("Default value is undefined for: "+of.name+"."+this.name);ret=null}return ret}}],methods:[function installInProto(proto){this.SUPER(proto);var self=this;var daoName=self.name+"$dao";Object.defineProperty(proto,daoName,{get:function classGetter(){return this.__subContext__[self.targetDAOKey]||this[self.targetDAOKey]},configurable:true});Object.defineProperty(proto,self.name+"$find",{get:function classGetter(){return this[daoName].find(this[self.name])},configurable:true})}]});
foam.CLASS({package:"foam.core",name:"PropertyShortNameRefinement",refines:"Property",properties:[{class:"String",name:"name",required:true},{class:"I18NString",name:"label",expression:function(name){return foam.String.labelize(name)}},{name:"labelFormatter",value:function(_,prop){this.add(prop.label$)}},{class:"String",name:"shortName"}]});
foam.CLASS({package:"foam.core",name:"ModelUpgradeTypesRefinement",refines:"foam.core.Model",properties:[{class:"String",name:"name"},{class:"I18NString",name:"label",expression:function(name){return foam.String.labelize(name)}},{class:"Boolean",name:"abstract"}]});
foam.CLASS({package:"foam.core",name:"FacetedPropertyRefinement",refines:"foam.core.Property",axioms:[foam.pattern.Faceted.create()],properties:[{name:"of"}]});
foam.CLASS({package:"foam.core",name:"AbstractMethodUpgradeTypesRefinement",refines:"foam.core.AbstractMethod",properties:[{class:"Boolean",name:"async",value:false}]});
foam.CLASS({package:"foam.core",name:"GlyphProperty",extends:"FObjectProperty",requires:["foam.core.Glyph"],properties:[["value",null],{name:"adapt",value:function(_,v,prop){if(!v)return;if(foam.String.isInstance(v)){return prop.Glyph.create({themeName:v})}if(!foam.core.FObject.isInstance(v)){return prop.Glyph.create(v)}return v}}]});
foam.CLASS({package:"foam.core",name:"FUIDProperty",extends:"Property",properties:[{name:"adapt",value:function(_,a){return a?a.toString().trim():""}},["type","String"],["value",""]]});
foam.CLASS({package:"foam.core",name:"Duration",extends:"Long",static:[{name:"duration",code:function(value,precision=2,useShort=true){var negative=value<0;value=Math.abs(value);var ts=ctrl.__subContext__.translationService;var values=[];precision<1&&(precision=1);foam.time.TimeUnit.VALUES.forEach(unit=>{var numUnits=Math.floor(value/unit.conversionFactorMs);var label=useShort?ts.getTranslation(foam.locale,`foam.time.TimeUnit.${unit.name}.shorthand`,unit.shorthand):numUnits>1?ts.getTranslation(foam.locale,`foam.time.TimeUnit.${unit.name}.plural`,unit.plural):ts.getTranslation(foam.locale,`foam.time.TimeUnit.${unit.name}.label`,unit.label);values.push([numUnits,label]);value-=numUnits*unit.conversionFactorMs});var formatted=values.reduce((acc,cur)=>{if(cur[0]>0&&precision>0)acc=acc.concat([cur[0]+cur[1]]);if(acc.length)precision--;return acc},[]).join(" ");return formatted||"0ms"}}]});
foam.CLASS({package:"foam.core",name:"FObjectArray",extends:"foam.core.Array",methods:[function installInProto(proto){this.SUPER(proto);var self=this;Object.defineProperty(proto,self.name+"$"+"errors$",{get:function getArrayErrorSlot(){var errors_$=foam.core.SimpleSlot.create({value:[]});var sub=foam.core.FObject.create();var setErrors=errorLists=>{let errors=errorLists.flat(1).filter(v=>v);errors_$.set(errors.length>0?errors:null)};var subToArray=val=>{var errorSlots=val.map(v=>v.errors_$);setErrors(val.map(v=>v.errors_));var l=()=>{val.forEach(v=>{let _=v.errors_});setErrors(val.map(v=>v.errors_))};var subs=errorSlots.map(s=>s.sub(l));sub.onDetach({detach:()=>{subs.forEach(s=>s.detach())}})};var val=this[self.name];if(Array.isArray(val))subToArray(val);self.toSlot(this).sub(()=>{sub.detach();sub=foam.core.FObject.create();var val=this[self.name];if(Array.isArray(val))subToArray(val)});return errors_$},configurable:true})}],properties:[{name:"of",required:true},{name:"type",factory:function(){return this.of+"[]"}},["adapt",function(_,a,prop){if(!a)return[];if(!Array.isArray(a))return a;var anyChange=false;var b=new Array(a.length);for(var i=0;i<a.length;i++){b[i]=prop.adaptArrayElement(a[i],this);if(a[i]!=b[i])anyChange=true}if(!anyChange)return a;return b}],["assertValue",function(v,prop){foam.assert(Array.isArray(v),prop.name,"Attempt to set array property to non-array value",v)}],["adaptArrayElement",function(o,obj){var ctx=obj.__subContext__||foam;var of=o.class||this.of;var cls=ctx.lookup(of);if(cls==null)cls=obj[of];return cls.isInstance(o)?o:cls.create(o,ctx)}],{name:"fromJSON",value:function(value,ctx,prop){return foam.json.parse(value,prop.of,ctx)}}]});
foam.CLASS({package:"foam.core",name:"Constant",properties:["name",{class:"Class",name:"of"},{name:"type"},{class:"StringArray",name:"flags"},{name:"value",expression:function(factory){return factory?factory():null}},"factory","documentation"],methods:[function installInClass(cls){if(this.hasOwnProperty("factory")){Object.defineProperty(cls,foam.String.constantize(this.name),{get:()=>this.value,configurable:false})}else{Object.defineProperty(cls,foam.String.constantize(this.name),{value:this.value,configurable:false})}},function installInProto(proto){this.installInClass(proto)}]});
foam.CLASS({refines:"foam.core.Model",package:"foam.core",name:"ModelConstantRefine",properties:[{class:"AxiomArray",of:"Constant",name:"constants",adapt:function(_,a,prop){if(!a)return[];if(!Array.isArray(a)){var cs=[];for(var key in a){cs.push(foam.core.Constant.create({name:key,value:a[key]}))}return cs}var b=new Array(a.length);for(var i=0;i<a.length;i++){b[i]=prop.adaptArrayElement.call(this,a[i],prop)}return b}}]});
foam.CLASS({package:"foam.core",name:"Topic",properties:["name","description",{class:"FObjectArray",of:"Topic",name:"topics",adaptArrayElement:function(o){return typeof o==="string"?foam.core.Topic.create({name:o},this):foam.core.Topic.create(o,this)}}],methods:[function installInProto(proto){var name=this.name;var topic=this;var makeTopic=this.makeTopic;Object.defineProperty(proto,name,{get:function topicGetter(){if(!this.hasOwnPrivate_(name)){this.setPrivate_(name,makeTopic(topic,this))}return this.getPrivate_(name)},configurable:true,enumerable:false})},function makeTopic(topic,parent){var name=topic.name;var topics=topic.topics||[];var ret={pub:foam.Function.bind(parent.pub,parent,name),sub:foam.Function.bind(parent.sub,parent,name),hasListeners:foam.Function.bind(parent.hasListeners,parent,name),toString:function(){return"Topic("+name+")"}};for(var i=0;i<topics.length;i++){ret[topics[i].name]=makeTopic(topics[i],ret)}return ret}]});
foam.CLASS({package:"foam.core",name:"ModelTopicRefinement",refines:"foam.core.Model",properties:[{class:"AxiomArray",of:"Topic",name:"topics",adaptArrayElement:function(o){return typeof o==="string"?foam.core.Topic.create({name:o}):foam.core.Topic.create(o)}}]});
foam.CLASS({package:"foam.core",name:"FObjectPropertyChangeTopicRefinement",refines:"foam.core.FObject",topics:["propertyChange"]});
foam.CLASS({package:"foam.core",name:"InnerClass",properties:[{name:"name",getter:function(){return this.model.name}},{name:"model",adapt:function(_,m){return this.modelAdapt_(m)}}],methods:[function modelAdapt_(m){return foam.core.Model.isInstance(m)?m:foam.core.EnumModel.isInstance(m)?m:foam.core.InnerClass.isInstance(m)?this.modelAdapt_(m.model):m.class?foam.lookup(m.class).create(m):foam.core.Model.create(m)},function installInClass(cls){this.model.package=cls.id;cls[this.model.name]=this.model.buildClass();foam.register(cls[this.model.name],cls.id+"."+this.model.name)},function installInProto(proto){var name=this.model.name;var cls=proto.cls_[name];Object.defineProperty(proto,name,{get:function innerClassGetter(){if(!this.hasOwnPrivate_(name)){var parent=this;var c=Object.create(cls);c.create=function innerClassCreate(args,ctx){return cls.create(args,ctx||parent)};this.setPrivate_(name,c)}return this.getPrivate_(name)},configurable:true,enumerable:false})}]});
foam.CLASS({package:"foam.core",name:"ModelInnerClassRefinement",refines:"foam.core.Model",properties:[{class:"AxiomArray",of:"InnerClass",name:"classes",adaptArrayElement:function(o){var ic=foam.core.InnerClass.isInstance(o)?o:o.model?foam.core.InnerClass.create(o):foam.core.InnerClass.create({model:o});if(!ic.model_.flags)ic.model_.flags=this.flags;return ic}}]});
foam.CLASS({package:"foam.core",name:"InnerEnum",properties:[{name:"name",getter:function(){return this.model.name}},{name:"model",adapt:function(_,m){return foam.core.EnumModel.isInstance(m)?m:foam.core.EnumModel.create(m)}}],methods:[function installInClass(cls){cls[this.model.name]=this.model.buildClass()},function installInProto(proto){var name=this.model.name;var cls=proto.cls_[name];proto[name]=cls}]});
foam.CLASS({package:"foam.core",name:"InnerEnumModelRefine",refines:"foam.core.Model",properties:[{class:"AxiomArray",of:"InnerEnum",name:"enums",adaptArrayElement:function(o){return foam.core.InnerEnum.isInstance(o)?o:o.class?this.__context__.lookup(o.class).create(o):o.model?foam.core.InnerEnum.create(o):foam.core.InnerEnum.create({model:o})}}]});
foam.CLASS({package:"foam.core",name:"Mixin",properties:[{name:"name",getter:function(){return"mixin_"+this.path}},"flags","path",["priority",200]],methods:[function installInClass(cls){var m=this.__context__.maybeLookup(this.path);if(m){cls.installAxioms(m.getOwnAxioms())}else{console.warn("Missing mixin ",this.path," in ",cls.name,".")}}]});
foam.CLASS({refines:"foam.core.Model",package:"foam.core",name:"MixinModelRefine",properties:[{class:"AxiomArray",of:"Mixin",name:"mixins",adaptArrayElement:function(o){return typeof o==="string"?foam.core.Mixin.create({path:o}):foam.core.Mixin.create(o)}}]});
foam.CLASS({package:"foam.core",name:"Implements",properties:[{name:"name",getter:function(){return"implements_"+this.path}},"flags","path",["priority",200]],methods:[function installInClass(cls){var m=this.__context__.lookup(this.path);if(!m){throw"No such interface: "+this.path}m.getOwnAxiomsByClass(foam.core.Property).forEach(p=>{if(!cls.getAxiomByName(p.name)){cls.installAxiom(p)}});var aMap=cls.axiomMap_;var sMap=Object.create(aMap.__proto__);aMap.__proto__=sMap;cls.axiomMap_=sMap;cls.installAxioms(m.getOwnAxioms());cls.axiomMap_=aMap}]});
foam.CLASS({refines:"foam.core.Model",package:"foam.core",name:"ImplementsModelRefine",properties:[{class:"AxiomArray",of:"Implements",name:"implements",adaptArrayElement:function(o){return typeof o==="string"?foam.core.Implements.create({path:o}):foam.core.Implements.create(o)}}]});
foam.CLASS({package:"foam.core",name:"Import",properties:[{class:"String",name:"name"},"key","of",{name:"type"},{class:"Boolean",name:"required",value:true},{name:"slotName_",factory:function(){return foam.String.toSlotName(this.name)}}],methods:[function installInProto(proto){foam.assert(this.key,"No key for import: "+this.name);var name=this.name;var key=foam.String.toSlotName(this.key);var slotName=this.slotName_;var required=this.required;Object.defineProperty(proto,slotName,{get:function importsSlotGetter(){return this.__context__[key]},configurable:true,enumerable:false});Object.defineProperty(proto,name,{get:function importsGetter(){var slot=this[slotName];if(slot)return slot.get();if(required){console.warn("Access missing import:",name)}return undefined},set:function importsSetter(v){var slot=this[slotName];if(slot)slot.set(v);else console.warn("Attempt to set missing import:",name)},configurable:true,enumerable:false})},function toSlot(obj){return obj[this.slotName_]}]});
foam.CLASS({package:"foam.core",name:"Export",properties:[{class:"String",name:"name"},{name:"exportName",postSet:function(_,name){this.name="export_"+name}},"key"],methods:[function getExportMap(){var m={};var bs=this.cls_.getAxiomsByClass(foam.core.Export);for(var i=0;i<bs.length;i++){var b=bs[i];if(b.key){var path=b.key.split(".");var a=this.cls_.getAxiomByName(path[0]);if(a){var e=a.exportAs?a.exportAs(this,path.slice(1)):this[path[0]];m[b.exportName]=e}else{foam.assert(a,'Unknown axiom: "',path[0],'" in model: ',this.cls_.id,", trying to export: '",b.key,"'");m[b.exportName]=this}}else{m[b.exportName]=this}}return m},function installInProto(proto){if(Object.prototype.hasOwnProperty.call(proto,"__subContext__")){return}var axiom=this;Object.defineProperty(proto,"__subContext__",{get:function YGetter(){if(!this.hasOwnPrivate_("__subContext__")){var ctx=this.__context__;var m=axiom.getExportMap.call(this);this.setPrivate_("__subContext__",ctx.createSubContext(m))}return this.getPrivate_("__subContext__")},set:function(){throw new Error("Attempted to set unsettable __subContext__ in "+this.cls_.id)},configurable:true,enumerable:false})}]});
foam.CLASS({refines:"foam.core.Model",package:"foam.core",name:"ImportExportModelRefine",requires:["foam.core.Import","foam.core.Export"],properties:[{class:"AxiomArray",of:"Import",name:"imports",adaptArrayElement:function(o){if(foam.String.isInstance(o)){let res=/(?:(?:([\w.$]+)\s+)(?!as))?([\w$?]+)(?:\s+as\s+([\w$]+))?/g.exec(o);let javaType=res[1];let key=res[2];let name=res[3];var optional=key.endsWith("?");if(optional)key=key.slice(0,key.length-1);return foam.core.Import.create({name:name||key,key:key,required:!optional,javaType:javaType||"null"})}return foam.core.Import.create(o)}},{class:"AxiomArray",of:"Export",name:"exports",adaptArrayElement:function(o){if(typeof o==="string"){var a=o.split(" ");switch(a.length){case 1:return foam.core.Export.create({exportName:a[0],key:a[0]});case 2:foam.assert(a[0]==="as","Invalid export syntax: key [as value] | as value");return foam.core.Export.create({exportName:a[1],key:null});case 3:foam.assert(a[1]==="as","Invalid export syntax: key [as value] | as value");return foam.core.Export.create({exportName:a[2],key:a[0]});default:foam.assert(false,"Invalid export syntax: key [as value] | as value")}}return foam.core.Export.create(o)}}]});
foam.CLASS({package:"foam.core",name:"Listener",extends:"foam.core.AbstractMethod",requires:["foam.core.Argument"],properties:[{class:"Boolean",name:"isFramed",value:false},{class:"Boolean",name:"isMerged",value:false},{class:"Int",name:"mergeDelay",value:16,units:"ms"},{class:"FObjectArray",of:"foam.core.Argument",name:"args",factory:function(){return[this.Argument.create({name:"sub",type:"Detachable"})]}}],methods:[function installInProto(proto,superAxiom){if(!this.code)return;foam.assert(!superAxiom||foam.core.Listener.isInstance(superAxiom),"Attempt to override non-listener",this.name);var name=this.name;var code=this.override_(proto,foam.Function.setName(this.code,name),superAxiom);var isMerged=this.isMerged;var isFramed=this.isFramed;var mergeDelay=this.mergeDelay;Object.defineProperty(proto,name,{get:function listenerGetter(){if(this.cls_.prototype===this)return code;if(!this.hasOwnPrivate_(name)){var self=this;var l=function(sub){return code.apply(self,arguments)};if(isMerged){l=this.__context__.merged(l,mergeDelay)}else if(isFramed){l=this.__context__.framed(l)}this.setPrivate_(name,l)}return this.getPrivate_(name)},configurable:true,enumerable:false})}]});
foam.CLASS({refines:"foam.core.Model",package:"foam.core",name:"ListenerModelRefine",properties:[{class:"AxiomArray",of:"Listener",name:"listeners",adaptArrayElement:function(o){if(typeof o==="function"){var name=foam.Function.getName(o);foam.assert(name,"Listener must be named");return foam.core.Listener.create({name:name,code:o})}return foam.core.Listener.isInstance(o)?o:foam.core.Listener.create(o)}}]});
foam.CLASS({package:"foam.core",name:"IDAlias",extends:"foam.core.Object",properties:[["name","id"],{class:"String",name:"propName"},["hidden",true],{name:"targetProperty",transient:true},["getter",function(){return this.cls_.ID.targetProperty.f(this)}],["setter",function(v){this.cls_.ID.targetProperty.set(this,v)}],"value"],methods:[function installInClass(c){var prop=c.getAxiomByName(this.propName);foam.assert(foam.core.Property.isInstance(prop),"Ids property: "+c.id+"."+this.propName,"is not a Property");this.targetProperty=prop;this.value=prop.value;this.SUPER(c)}]});
foam.CLASS({package:"foam.core",name:"MultiPartID",extends:"foam.core.FObjectProperty",properties:[["name","id"],["transient",true],["hidden",true],{class:"Class",name:"of",transient:true,required:false,value:null},{class:"StringArray",name:"propNames",required:true},["getter",function multiPartGetter(){return this.cls_.ID.of.create(this)}],["setter",function multiPartSetter(a){if(!foam.Array.isInstance(a)){this.copyFrom(a);return}var names=this.cls_.ID.propNames;foam.assert(names.length===a.length,`Improperly sized array for ${this.cls_.id} array value`);for(var i=0;i<names.length;i++){this[names[i]]=a[i]}}]],methods:[function installInClass(c){var generatedId=c.package?c.package+"."+c.name+"Id":c.name+"Id";var arr=[];for(var i=0;i<this.propNames.length;i++){var name=foam.String.capitalize(this.propNames[i]);arr.push(`get${name}()`)}var javaToStringMethod="return "+arr.join(' + "-" + ')+";";
foam.CLASS({package:c.package,name:c.name+"Id",flags:c.model_.flags,properties:this.propNames.map(function(n){var prop=c.getAxiomByName(n);foam.assert(prop,"Unknown ids property:",c.id+"."+n);foam.assert(foam.core.Property.isInstance(prop),"Ids property:",c.id+"."+n,"is not a Property.");return prop.clone()}),methods:[{name:"toString",code:function(){var arr=[];for(var prop in this.instance_){arr.push(this[prop]?this[prop].toString():"")}return arr.join("-")},javaCode:javaToStringMethod}]});c.installAxiom(foam.core.Requires.create({name:c.name+"Id",path:generatedId}));this.of=foam.lookup(generatedId);this.SUPER(c)}]});
foam.CLASS({package:"foam.core",name:"ModelIDRefine",refines:"foam.core.Model",requires:["foam.core.IDAlias","foam.core.MultiPartID"],properties:[{name:"ids",postSet:function(_,ids){foam.assert(foam.Array.isInstance(ids),"Ids must be an array.");foam.assert(ids.length,"Ids must contain at least one property.");if(ids.length==1)this.axioms_.push(foam.core.IDAlias.create({propName:ids[0]}));else this.axioms_.push(foam.core.MultiPartID.create({propNames:ids}))}}]});
foam.CLASS({package:"foam.core",name:"Requires",properties:[{name:"name",factory:function(){return this.path.split(".").pop()}},["priority",90],"path","flags"],methods:[function installInProto(proto){var name=this.name;var path=this.path;var setCls;Object.defineProperty(proto,name,{get:function requiresGetter(){if(!this.hasOwnPrivate_(name)){var cls=setCls||(this.__context__||foam).lookup(path);var parent=this;foam.assert(cls,"Requires: Unknown class: ",path);var c=Object.create(cls);c.create=function requiresCreate(args,ctx){return cls.create(args,ctx||parent)};this.setPrivate_(name,c)}return this.getPrivate_(name)},set:function(cls){this.clearPrivate_(name);setCls=cls},configurable:true,enumerable:false})}]});
foam.CLASS({refines:"foam.core.Model",package:"foam.core",name:"ModelRequiresRefines",properties:[{class:"AxiomArray",of:"Requires",name:"requires",adaptArrayElement:function(o){if(typeof o==="string"){var a=o.split(" as ");var path=a[0];var r=foam.core.Requires.create({path:path},this);if(a[1])r.name=a[1];return r}return foam.core.Requires.create(o,this)}}]});
foam.CLASS({package:"foam.core",name:"Slot",requires:["foam.core.internal.And","foam.core.internal.Or","foam.core.internal.Not","foam.core.internal.SubSlot"],methods:[function valueSub(){var self=this;var args=Array.from(arguments);var s;var l=function(){var v=self.get();if(s)s.detach();if(v)s=v.sub.apply(v,args)};l();this.sub(l)},function dot(name){var i=name.indexOf("$");if(i!=-1){var left=name.substring(0,i);var right=name.substring(i+1);return this.SubSlot.create({parent:this,name:left}).dot(right)}else{return this.SubSlot.create({parent:this,name:name})}},function link(other){console.warn("deprecated use of link(), use linkFrom() instead");return this.linkFrom(other)},function linkFrom(s2){var s1=this;var feedback1=false;var feedback2=false;var l1=function(e){if(feedback1)return;if(!foam.util.is(s1.get(),s2.get())){feedback1=true;try{s2.set(s1.get());if(!foam.util.is(s1.get(),s2.get()))s1.set(s2.get())}finally{feedback1=false}}};var l2=function(e){if(feedback2)return;if(!foam.util.is(s1.get(),s2.get())){feedback2=true;try{s1.set(s2.get());if(!foam.util.is(s1.get(),s2.get()))s2.set(s1.get())}finally{feedback2=false}}};var sub1=s1.sub(l1);var sub2=s2.sub(l2);l2();return{detach:function(){sub1&&sub1.detach();sub2&&sub2.detach();sub1=sub2=null}}},function linkTo(other){return other.linkFrom(this)},function follow(other){foam.assert(other,"Slot.follow requires Slot argument.");var self=this;var l=function(){if(!foam.util.is(self.get(),other.get())){self.set(other.get())}};l();return other.sub(l)},function and(other){return this.And.create({a$:this,b$:other}).output$},function or(other){return this.Or.create({a$:this,b$:other}).output$},function not(){return this.Not.create({a$:this}).output$},function mapFrom(other,f){var self=this;var l=function(){self.set(f(other.get()))};l();return other.sub(l)},function mapTo(other,f){return other.mapFrom(this,f)},function map(f){return foam.core.ExpressionSlot.create({code:f,args:[this]})},function relateTo(other,f,fPrime){var self=this;var feedback=false;var sub=foam.core.FObject.create();var l1=function(){if(feedback)return;feedback=true;other.set(f(self.get()));feedback=false};var l2=function(){if(feedback)return;feedback=true;self.set(fPrime(other.get()));feedback=false};sub.onDetach(this.sub(l1));sub.onDetach(other.sub(l2));l1();return sub},function relateFrom(other,f,fPrime){return other.relateTo(this,fPrime,f)},function toE(){return this}]});
foam.CLASS({package:"foam.core.internal",name:"PropertySlot",extends:"foam.core.Slot",methods:[function initArgs(){},function init(){},function get(){return this.prop.get(this.obj)},function set(value){return this.prop.set(this.obj,value)},function getPrev(){return this.oldValue},function setPrev(value){return this.oldValue=value},function sub(l){var s=this.obj.sub("propertyChange",this.prop.name,l);s.src=this;return s},function isDefined(){return this.obj.hasOwnProperty(this.prop.name)},function clear(){this.obj.clearProperty(this.prop.name)},function toString(){return"PropertySlot("+this.obj.$UID+","+this.obj.cls_.id+"."+this.prop.name+")"}]});
foam.CLASS({package:"foam.core.internal",name:"SubSlot",extends:"foam.core.Slot",properties:["parent","name","value","prevSub"],methods:[function init(){this.parent.sub(this.parentChange);this.parentChange()},function get(){var o=this.parent.get();return o&&o[this.name]},function set(value){var o=this.parent.get();if(o)o[this.name]=value},function getPrev(){return this.oldValue},function setPrev(value){return this.oldValue=value},function sub(l){return this.SUPER("propertyChange","value",l)},function isDefined(){return this.parent.get().hasOwnProperty(this.name)},function clear(){this.parent.get().clearProperty(this.name)},function toString(){return"SubSlot("+this.parent+","+this.name+")"}],listeners:[function parentChange(s){this.prevSub&&this.prevSub.detach();var o=this.parent.get();if(o&&o.cls_.getAxiomByName(this.name)==null){this.prevSub=null;this.detach();return}this.prevSub=o&&o.slot&&o.slot(this.name).sub(this.valueChange);this.valueChange()},function valueChange(){var parentValue=this.parent.get();this.value=parentValue?parentValue[this.name]:undefined}]});
foam.CLASS({package:"foam.core.internal",name:"Or",properties:["a","b",{name:"output",expression:function(a,b){return a||b}}]});
foam.CLASS({package:"foam.core.internal",name:"And",properties:["a","b",{name:"output",expression:function(a,b){return a&&b}}]});
foam.CLASS({package:"foam.core.internal",name:"Not",properties:["a",{name:"output",expression:function(a){return!a}}]});
foam.CLASS({package:"foam.core",name:"ConstantSlot",extends:"foam.core.Slot",properties:[{name:"value",getter:function(){return this.value_},setter:function(){}}],methods:[function initArgs(args){this.value_=args&&args.value},function get(){return this.value},function set(){throw new Error("Tried to mutate immutable ConstantSlot.")},function sub(l){},function follow(other){},function linkFrom(s2){},function linkTo(s2){s2.set(this.get())},function mapFrom(other,f){}]});
foam.CLASS({package:"foam.core",name:"ExpressionSlot",extends:"foam.core.PromiseSlot",properties:["obj","code",{name:"args",expression:function(obj){foam.assert(obj,'ExpressionSlot: "obj" or "args" required.');var args=foam.Function.argNames(this.code);for(var i=0;i<args.length;i++){args[i]=obj.slot(args[i])}this.subToArgs_(args);return args},postSet:function(_,args){this.subToArgs_(args)}},{name:"value",preSet:function(o,n){if(n&&n.then){this.promise=n;n=foam.Undefined.isInstance(o)?null:o}else{this.promise=null}return n},factory:function(){return this.code.apply(this.obj||this,this.args.map(function(a){return a.get()}))}},"cleanup_"],methods:[function init(){this.onDetach(this.cleanup)},function set(){},function subToArgs_(args){this.cleanup();var cleanup=foam.core.FObject.create();for(var i=0;i<args.length;i++){cleanup.onDetach(args[i].sub(this.invalidate))}this.cleanup_=cleanup}],listeners:[function cleanup(){this.cleanup_&&this.cleanup_.detach()},function invalidate(){this.clearProperty("value")}]});
foam.CLASS({package:"foam.core",name:"PromiseSlot",extends:"foam.core.SimpleSlot",properties:[{name:"promise",postSet:function(_,n){n&&n.then(function(v){if(n===this.promise)this.value=v}.bind(this))}}],methods:[function set(){throw new Error(this.cls_.id+" does not support setting.")}]});
foam.CLASS({package:"foam.core",name:"ArraySlot",extends:"foam.core.Slot",properties:[{class:"FObjectArray",of:"foam.core.Slot",name:"slots"}],methods:[function get(){return this.slots.map(s=>s.get())},function set(arr){if(!foam.Array.isInstance(arr))throw new Error("ArraySlot can only set an array.");arr.forEach((v,i)=>this.slots[i].set(v))},function sub(l){if(arguments.length!=1)return this.SUPER.apply(this,arguments);var subs=this.slots.map(s=>s.sub(l));return{detach:function(){subs.forEach(s=>s.detach())}}}]});
foam.CLASS({package:"foam.core",name:"SimpleSlot",extends:"foam.core.Slot",properties:[{name:"value"}],methods:[function get(){return this.value},function set(v){this.value=v},function sub(l){return arguments.length===1?this.SUPER("propertyChange","value",l):this.SUPER.apply(this,arguments)}]});
foam.CLASS({package:"foam.core",name:"ProxySlot",extends:"foam.core.SimpleSlot",properties:[{name:"sub_"},{name:"delegate",postSet:function(_,n){if(this.sub_)this.sub_.detach();if(foam.core.Slot.isInstance(n)){this.sub_=this.linkFrom(n)}}}]});
foam.CLASS({package:"foam.core",name:"ProxyExpressionSlot",extends:"foam.core.ProxySlot",requires:["foam.core.ExpressionSlot"],properties:[{name:"obj",postSet:function(){this.update()}},{name:"code",postSet:function(){this.update()}},{name:"args",postSet:function(){this.update()}}],methods:[function update(){if(!this.code||!this.obj)return;this.delegate=this.ExpressionSlot.create({args:this.args,code:this.code,obj:this.obj})}]});
foam.CLASS({package:"foam.core",name:"Proxy",extends:"Property",requires:["foam.core.EventProxy","foam.core.ProxiedMethod","foam.core.ProxySub"],properties:[{name:"of",required:true},{name:"type",factory:function(){return this.of}},{class:"StringArray",name:"topics"},{class:"StringArray",name:"forwards",factory:null,value:null},{class:"StringArray",name:"delegates",factory:null,value:null},{name:"fromJSON",value:function(json,ctx){return foam.json.parse(json,null,ctx)}},{name:"cloneProperty",value:function(value,cloneMap,opt_X){cloneMap[this.name]=value&&value.clone?value.clone(opt_X):value}}],methods:[function installInClass(cls){this.SUPER(cls);var name=this.name;var delegate=this.__context__.lookup(this.of);function resolveName(name){var m=delegate.getAxiomByName(name);foam.assert(foam.core.Method.isInstance(m),"Cannot proxy non-method",name);return m}var delegates=this.delegates?this.delegates.map(resolveName):[];var forwards=this.forwards?this.forwards.map(resolveName):delegate.getOwnAxiomsByClass(foam.core.Method);var axioms=[];for(var i=0;i<forwards.length;i++){var method=forwards[i];axioms.push(this.ProxiedMethod.create({flags:this.flags,name:method.name,type:method.type,property:name,args:method.args}))}for(var i=0;i<delegates.length;i++){var method=delegates[i];axioms.push(this.ProxiedMethod.create({flags:this.flags,name:method.name,type:method.type,property:name,args:method.args,delegate:true}))}if(!this.topics||this.topics.length){axioms.push(this.ProxySub.create({topics:this.topics,flags:this.flags,prop:this.name}))}cls.installAxioms(axioms)}]});
foam.CLASS({package:"foam.core",name:"ProxiedMethod",extends:"Method",properties:[{class:"String",name:"property"},{class:"Boolean",name:"delegate",value:false},{name:"code",expression:function(name,property,type,delegate){return delegate?function delegate(){return this[property][name].apply(this,arguments)}:function forward(){return this[property][name].apply(this[property],arguments)}}}]});
foam.CLASS({package:"foam.core",name:"EventProxy",properties:[{name:"dest",},{class:"StringArray",name:"topic",factory:function(){return[]}},{class:"Boolean",name:"active",value:false,postSet:function(old,a){for(var key in this.children){this.children[key].active=!a}if(old!==a){if(a){this.doSub()}else{this.doUnsub()}}},},{name:"parent",},{name:"children",factory:function(){return{}},},{name:"src",postSet:function(o,src){if(this.active)this.doSub();for(var key in this.children){this.children[key].src=src}}},{name:"subscription"}],methods:[{name:"init",code:function(){this.onDetach(foam.Function.bind(function(){this.subscription&&this.subscription.detach();if(this.parent){this.parent.removeChild(this);this.parent.active=true}},this))},},{name:"doSub",code:function doSub(){if(this.subscription)this.subscription.detach();if(!this.src)return;var args=this.topic.slice();args.push(this.onEvent);this.subscription=this.src.sub.apply(this.src,args)},},{name:"doUnsub",code:function doUnsub(){if(this.subscription)this.subscription.detach()},},{name:"removeChild",args:[{name:"c",type:"foam.core.EventProxy"}],code:function removeChild(c){for(var key in this.children){if(this.children[key]===c){delete this.children[key];return}}},},{name:"getChild",args:[{name:"key",type:"String"}],type:"foam.core.EventProxy",code:function getChild(key){if(!this.children[key]){this.children[key]=this.cls_.create({parent:this,dest:this.dest,src:this.src,topic:this.topic.slice().concat(key)})}return this.children[key]},},{name:"addProxy",args:[{name:"topics",type:"String[]"}],code:function addProxy(topic){var c=this;var active=true;for(var i=0;i<topic.length;i++){active=active&&!c.active;c=c.getChild(topic[i])}c.active=active},}],listeners:[{name:"onEvent",code:function(){if(this.active){var args=foam.Function.appendArguments([],arguments,1);var c=this.dest.pub.apply(this.dest,args);if(!c)this.detach()}},}]});
foam.CLASS({package:"foam.core",name:"ProxySub",extends:"Method",properties:[{name:"name",getter:function(){return"sub"}},{class:"String",name:"prop"},{class:"StringArray",name:"topics",factory:null},{name:"code",expression:function(prop,topics){var privateName=prop+"EventProxy_";return function subProxy(a1){if(!topics||topics.indexOf(a1)!=-1){var proxy=this.getPrivate_(privateName);if(!proxy){proxy=foam.core.EventProxy.create({dest:this,src:this[prop]});this.setPrivate_(privateName,proxy);proxy.src$.follow(this.slot(prop))}proxy.addProxy(Array.from(arguments).slice(0,-1))}return this.SUPER.apply(this,arguments)}}}]});
foam.CLASS({package:"foam.core",name:"Latch",properties:["promise","resolve","reject"],methods:[function init(){this.promise=new Promise((resolve,reject)=>{this.resolve=resolve;this.reject=reject})},function then(resolve,reject){return this.promise.then(resolve,reject)}]});
foam.CLASS({package:"foam.core",name:"Lock",static:[function test__(){var lock=foam.core.Lock.create();for(let i=0;i<10;i++){lock.then(function(){return new Promise(function(resolve){console.log("start locked task "+i);setTimeout(function(){console.log("end locked task "+i);resolve()},Math.random()*1e3)})}).catch(e=>{console.error(e)})}}],properties:[{name:"promise",factory:function(){return Promise.resolve()}}],methods:[function then(resolve){this.promise=this.promise.then(resolve)}]});
foam.CLASS({package:"foam.core",name:"CountingSemaphore",requires:["foam.core.Latch"],static:[function test__(){var lock=foam.core.CountingSemaphore.create({limit:1});for(let i=0;i<10;i++){lock.then(function(){return new Promise(function(resolve){console.log("start locked task "+i);setTimeout(function(){console.log("end locked task "+i);resolve()},Math.random()*1e3)})}).catch(e=>{console.error(e)})}}],properties:[{class:"Int",name:"count_"},{class:"Int",name:"limit",value:10},{name:"queue_",factory:function(){return[]}}],methods:[function decr(){this.count_--;var latch=this.queue_.shift();if(latch)return latch.resolve()},function then(resolve){if(this.count_++<this.limit){resolve().then(this.decr.bind(this));return Promise.resolve()}var latch=this.Latch.create();this.queue_.push(latch);return latch.then(resolve).then(this.decr.bind(this))}]});
foam.CLASS({package:"foam.core",name:"PromisedMethod",extends:"ProxiedMethod",properties:[{name:"code",expression:function(name,property,type){return type?function(){var args=arguments;return this.delegate[property].then(function(d){return d[name].apply(d,args)})}:function(){var args=arguments;this.delegate[property].then(function(d){d[name].apply(d,args)})}}}]});
foam.CLASS({package:"foam.core",name:"Promised",extends:"Property",requires:["foam.core.PromisedMethod"],properties:[{name:"of",required:true},{class:"StringArray",name:"methods",value:null,factory:null},{class:"StringArray",name:"topics",value:null,factory:null},{class:"String",name:"stateName",expression:function(name){return name+"State"}},{name:"postSet",expression:function(stateName){return function(_,p){var self=this;this[stateName]=undefined;p.then(function(d){self[stateName]=d})}}}],methods:[function installInClass(cls){this.SUPER(cls);var myName=this.name;var stateName=this.stateName;var pendingState="Pending"+foam.String.capitalize(myName);var delegate=this.__context__.lookup(this.of);function resolveName(name){var m=delegate.getAxiomByName(name);foam.assert(foam.core.Method.isInstance(m),"Cannot proxy non-method",name);return m}var methods=this.methods?this.methods.map(resolveName):delegate.getOwnAxiomsByClass(foam.core.Method);var methodNames=methods.map(function(m){return m.name});var myAxioms=[foam.core.Proxy.create({name:stateName,of:this.of,forwards:methodNames,factory:function(){return this[pendingState].create({delegate:this})},transient:true}),foam.core.ProxySub.create({topics:this.topics,prop:stateName})];var pendingMethods=[];methods=delegate.getOwnAxiomsByClass(foam.core.Method);for(var i=0;i<methods.length;i++){pendingMethods.push(foam.core.PromisedMethod.create({name:methods[i].name,property:myName,delegate:false}))}myAxioms=myAxioms.concat(foam.core.InnerClass.create({model:{name:pendingState,implements:[this.of],methods:pendingMethods,properties:[{class:"FObjectProperty",of:cls.id,name:"delegate"}]}}));cls.installAxioms(myAxioms)}]});
foam.CLASS({package:"foam.core.internal",name:"InterfaceMethod",extends:"foam.core.Method",properties:[{name:"code",required:false},{class:"Boolean",name:"abstract",value:true}],methods:[function installInProto(){},function installInClass(cls,superMethod,existingMethod){cls.axiomMap_[this.name]=this}]});
foam.CLASS({package:"foam.core",name:"InterfaceModel",extends:"foam.core.Model",properties:[["extends","foam.core.AbstractInterface"],{class:"Boolean",name:"proxy",label:"Generate Proxy",help:"If enabled, causes automatic proxy generation."},{class:"Boolean",name:"client",label:"Generate Client Stub",help:"If enabled, causes automatic client generation."},{class:"Boolean",name:"skeleton",label:"Generate Server Skeleton",help:"If enabled, causes automatic skeleton generation."},{class:"AxiomArray",name:"methods",of:"foam.core.internal.InterfaceMethod",adaptArrayElement:function(m){return foam.core.internal.InterfaceMethod.create(foam.String.isInstance(m)?{signature:m}:m)}},{class:"StringArray",name:"javaExtends"}],methods:[function init(){this.SUPER();if(this.proxy)
foam.CLASS({package:this.package,name:"Proxy"+this.name,implements:[this.id],flags:this.flags,source:this.source,properties:[{class:"Proxy",of:this.id,name:"delegate"}]});if(this.client)
foam.CLASS({package:this.package,name:"Client"+this.name,implements:[this.id],flags:this.flags,source:this.source,properties:[{class:"Stub",of:this.id,name:"delegate"}]})},function validate(){if(this.extends!=="foam.core.AbstractInterface")throw"INTERFACE: "+this.id+" does not extend AbstractInterface.  Did you mean impelments [ '"+this.extends+"' ], ?"}]});
foam.CLASS({package:"foam.core",name:"AbstractInterface",axioms:[{installInClass:function(cls){cls.create=function(){throw new Error("Cannot instantiate Interface: "+this.name)}}}]});foam.LIB({name:"foam",methods:[function INTERFACE(m){if(m.refines){var i=foam.__context__.lookup(m.refines);if(m.methods){var i2=foam.core.InterfaceModel.create(m);for(var m of i2.methods){var j=i.model_.methods.find(m2=>m2.name==m.name);if(j==undefined){i.model_.methods.push(m)}else{i.model_.methods[j]=m}}}}else{m.class=m.class||"foam.core.InterfaceModel";foam.CLASS(m);if(m.proxy){let id=m.package+".Proxy"+m.name;foam.__context__.registerFactory({id:id,package:m.package,name:"Proxy"+m.name},function(){foam.lookup(m.id);return foam.lookup(id)})}if(m.client){let id=m.package+".Client"+m.name;foam.__context__.registerFactory({id:id,package:m.package,name:"Client"+m.name},function(){foam.lookup(m.id);return foam.lookup(id)})}}}]});foam.LIB({name:"foam.core.type",methods:[function toType(str){if(!str){return foam.core.type.Any.create()}if(foam.isRegistered("foam.core.type."+str)){return foam.lookup("foam.core.type."+str).create()}if(str.endsWith("[]")){return foam.core.type.Array.create({type:foam.core.type.toType(str.substring(0,str.lastIndexOf("[]")))})}if(foam.isRegistered(str)){return foam.core.type.FObject.create({of:str})}return foam.core.type.SimpleType.create({java:str,swift:str})}]});foam.INTERFACE({package:"foam.core.type",name:"Type",methods:[{name:"refs",type:"String[]"},{name:"toJavaType",type:"String"},{name:"toSwiftType",args:[{type:"Boolean",name:"optional"}],type:"String"}]});
foam.CLASS({package:"foam.core.type",name:"SimpleType",properties:[{class:"String",name:"java"},{class:"String",name:"swift"}],methods:[function refs(){return[]},function toJavaType(){return this.java},function toSwiftType(optional){return this.swift+(optional?"?":"")}]});
foam.CLASS({package:"foam.core.type",name:"Any",implements:["foam.core.type.Type"],axioms:[{class:"foam.pattern.Singleton"}],methods:[function refs(){return[]},function toJavaType(){return"Object"},function toSwiftType(){return"Any?"}]});
foam.CLASS({package:"foam.core.type",name:"Object",extends:"foam.core.type.SimpleType",axioms:[{class:"foam.pattern.Singleton"}],properties:[["java","Object"],["swift","Any"]]});
foam.CLASS({package:"foam.core.type",name:"Byte",implements:["foam.core.type.Type"],axioms:[{class:"foam.pattern.Singleton"}],methods:[function refs(){return[]},function toJavaType(){return"byte"},function toSwiftType(){return"Int8"}]});
foam.CLASS({package:"foam.core.type",name:"Short",implements:["foam.core.type.Type"],axioms:[{class:"foam.pattern.Singleton"}],methods:[function refs(){return[]},function toJavaType(){return"short"},function toSwiftType(){return"Int16"}]});
foam.CLASS({package:"foam.core.type",name:"Integer",implements:["foam.core.type.Type"],axioms:[{class:"foam.pattern.Singleton"}],methods:[function refs(){return[]},function toJavaType(){return"int"},function toSwiftType(){return"Int"}]});
foam.CLASS({package:"foam.core.type",name:"Void",implements:["foam.core.type.Type"],axioms:[{class:"foam.pattern.Singleton"}],methods:[function refs(){return[]},function toJavaType(){return"void"},function toSwiftType(){return"Void"}]});
foam.CLASS({package:"foam.core.type",name:"String",extends:"foam.core.type.SimpleType",axioms:[{class:"foam.pattern.Singleton"}],properties:[["java","String"],["swift","String"]]});
foam.CLASS({package:"foam.core.type",name:"Long",implements:["foam.core.type.Type"],axioms:[{class:"foam.pattern.Singleton"}],methods:[function refs(){return[]},function toJavaType(){return"long"},function toSwiftType(){return"Int"}]});
foam.CLASS({package:"foam.core.type",name:"Array",implements:["foam.core.type.Type"],properties:[{name:"type"}],methods:[function refs(){return this.type.refs()},function toJavaType(){return`${this.type.toJavaType()}[]`},function toSwiftType(optional){return`[${this.type.toSwiftType()}]`+(optional?"?":"")}]});
foam.CLASS({package:"foam.core.type",name:"Boolean",implements:["foam.core.type.Type"],axioms:[{class:"foam.pattern.Singleton"}],methods:[function refs(){return[]},function toJavaType(){return"boolean"},function toSwiftType(){return"Bool"}]});
foam.CLASS({package:"foam.core.type",name:"FObject",implements:["foam.core.type.Type"],properties:[{class:"Class",name:"of",value:"foam.core.FObject"}],methods:[function refs(){return[this.of.id]},function toJavaType(){return this.of.id},function toSwiftType(optional){return this.of.model_.swiftName+(optional?"?":"")}]});
foam.CLASS({package:"foam.core.type",name:"Char",implements:["foam.core.type.Type"],axioms:[{class:"foam.pattern.Singleton"}],methods:[function refs(){return[]},function toJavaType(){return"char"},function toSwiftType(){return"Character"}]});
foam.CLASS({package:"foam.core.type",name:"DateTime",extends:"foam.core.type.SimpleType",axioms:[{class:"foam.pattern.Singleton"}],properties:[["java","java.util.Date"],["swift","Date"]]});
foam.CLASS({package:"foam.core.type",name:"Time",extends:"foam.core.type.SimpleType",axioms:[{class:"foam.pattern.Singleton"}],properties:[["java","java.util.Date"],["swift","Date"]]});
foam.CLASS({package:"foam.core.type",name:"Date",extends:"foam.core.type.SimpleType",axioms:[{class:"foam.pattern.Singleton"}],properties:[["java","java.util.Date"],["swift","Date"]]});
foam.CLASS({package:"foam.core.type",name:"Context",extends:"foam.core.type.SimpleType",axioms:[{class:"foam.pattern.Singleton"}],properties:[["java","foam.core.X"],["swift","Context"]]});
foam.CLASS({package:"foam.core.type",name:"Number",extends:"foam.core.type.SimpleType",axioms:[{class:"foam.pattern.Singleton"}],properties:[["java","float"],["swift","Float"]]});
foam.CLASS({package:"foam.core.type",name:"Float",extends:"foam.core.type.SimpleType",axioms:[{class:"foam.pattern.Singleton"}],properties:[["java","float"],["swift","Float"]]});
foam.CLASS({package:"foam.core.type",name:"List",extends:"foam.core.type.SimpleType",axioms:[{class:"foam.pattern.Singleton"}],properties:[["java","java.util.List"],["swift","[Any?]"]]});
foam.CLASS({package:"foam.core.type",name:"Map",extends:"foam.core.type.SimpleType",axioms:[{class:"foam.pattern.Singleton"}],properties:[["java","java.util.Map"],["swift","[AnyHashable:Any?]"]]});
foam.CLASS({package:"foam.core.type",name:"Class",extends:"foam.core.type.SimpleType",axioms:[{class:"foam.pattern.Singleton"}],properties:[["java","foam.core.ClassInfo"],["swift","ClassInfo"]]});
foam.CLASS({package:"foam.core.type",name:"Double",extends:"foam.core.type.SimpleType",axioms:[{class:"foam.pattern.Singleton"}],properties:[["java","double"],["swift","Double"]]});
foam.CLASS({package:"foam.core.type",name:"Regex",extends:"foam.core.type.SimpleType",axioms:[{class:"foam.pattern.Singleton"}],properties:[["java","java.util.regex.Pattern"],["swift","String"]]});foam.INTERFACE({package:"foam.core",name:"Axiom",methods:[{name:"getName",type:"String"}]});
foam.CLASS({package:"foam.core",name:"ContextMethod",extends:"foam.core.Method",methods:[function exportAs(obj){var m=obj[this.name];return function(){var ctx=foam.core.FObject.isInstance(this)?this.__context__:this;return m.apply(obj,foam.Function.appendArguments([ctx],arguments,0))}}]});foam.INTERFACE({package:"foam.core",name:"Exception",swiftImplements:["Error"],properties:[{name:"isClientException",type:"Boolean"}]});foam.INTERFACE({package:"foam.core",name:"ExceptionInterface",methods:[{name:"getClientRethrowException",type:"RuntimeException",visibility:"public"}]});
foam.CLASS({package:"foam.core",name:"FOAMException",implements:["foam.core.Exception"],imports:["translationService?"],properties:[{name:"id",class:"String",factory:function(){return this.cls_.id},externalTransient:true,storageTransient:true},{name:"exceptionMessage",class:"String",value:"{{message}}",externalTransient:true,visibility:"RO"},{name:"message",class:"String",storageTransient:true,visibility:"RO",},{name:"errorCode",class:"String",visibility:"RO"},{name:"hostname",class:"String",visibilty:"RO"}],methods:[{name:"getTranslation",type:"String",code:function(){if(!this.translationService)return msg;var msg=this.translationService.getTranslation(foam.locale,this.cls_.id+"."+this.exceptionMessage,this.exceptionMessage);let m=this.getTemplateValues();for(let[key,value]of m.entries()){msg=msg.replaceAll(key,value)}return msg},},{name:"renderMessage",args:[{name:"msg",type:"String"}],type:"String",},{name:"getTemplateValues",type:"Map",code:function(){var m=new Map;var ps=this.cls_.getAxiomsByClass(foam.core.Property);for(var i=0,property;property=ps[i];i++){if(!property.externalTransient){m.set("{{"+property.name+"}}",this[property.name]||"")}}return m},},{name:"toString",type:"String",code:function(){var s=this.id+",";s+="["+this.hostname+"],";if(this.errorCode){s+="("+this.errorCode+"),"}s+=this.message;return s},}]});
foam.CLASS({package:"foam.core",name:"FOAMExceptionTest",extends:"foam.nanos.test.Test",methods:[{name:"runTest",}]});
foam.CLASS({package:"foam.core",name:"Window",exports:["getElementsByClassName","getElementById","async","cancelAnimationFrame","clearInterval","clearTimeout","console","debug","delayed","document","error","framed","info","installCSS","log","merged","requestAnimationFrame","returnExpandedCSS","setInterval","setTimeout","warn","params","window"],properties:[["name","window"],"window",{name:"document",factory:function(){return this.window.document}},{name:"console",factory:function(){return this.window.console}},{name:"params",factory:function(){var m={};this.window.location.search.substring(1).split("&").forEach(p=>{var a=p.split("=");m[a[0]]=a[1]});return m}}],methods:[function init(){this.installCSS(`
.foam-u2-Element-hidden {
display: none !important;
}
`,"global","Window")},function getElementById(id){return this.document.getElementById(id)},function getElementsByClassName(cls){return this.document.getElementsByClassName(cls)},function debug(){this.console.debug.apply(this.console,arguments)},function error(){this.console.error.apply(this.console,arguments)},function info(){this.console.info.apply(this.console,arguments)},function log(){this.console.log.apply(this.console,arguments)},function warn(){this.console.warn.apply(this.console,arguments)},function async(l){return this.delayed(l,0)},function delayed(l,delay){return foam.Function.bind(function(){this.setTimeout(function(){l.apply(this,arguments)},delay)},this)},function merged(l,opt_delay){var delay=opt_delay||16;var ctx=this;return foam.Function.setName(function(){var triggered=false;var lastArgs=null;function mergedListener(){triggered=false;var args=Array.from(lastArgs);lastArgs=null;l.apply(this,args)}var f=function(){lastArgs=arguments;if(!triggered){triggered=true;ctx.setTimeout(mergedListener,delay)}};return f}(),"merged("+l.name+")")},function framed(l){var ctx=this;return foam.Function.setName(function(){var triggered=false;var lastArgs=null;function frameFired(){triggered=false;var args=lastArgs;lastArgs=null;l.apply(this,args)}var f=function framed(){lastArgs=arguments;if(!triggered){triggered=true;ctx.requestAnimationFrame(frameFired)}};return f}(),"framed("+l.name+")")},function setTimeout(f,t){return this.window.setTimeout(f,t)},function clearTimeout(id){this.window.clearTimeout(id)},function setInterval(f,t){return this.window.setInterval(f,t)},function clearInterval(id){this.window.clearInterval(id)},function requestAnimationFrame(f){return this.window.requestAnimationFrame(f)},function cancelAnimationFrame(id){this.window.cancelAnimationFrame(id)},function installCSS(text,owner,id){this.document&&this.document.head&&this.document.head.insertAdjacentHTML("beforeend","<style"+(id?' id="'+id+'"':"")+(owner?' owner="'+owner+'"':"")+">"+text+"</style>")},function returnExpandedCSS(a){return a}]});
foam.CLASS({package:"foam.core",name:"WindowNodeJSRefinement",refines:"foam.core.Window",flags:["node"],methods:[function requestAnimationFrame(f){return this.setTimeout(f,16)},function cancelAnimationFrame(id){this.clearTimeout(id)}]});foam.SCRIPT({package:"foam.core",name:"WindowScript",requires:["foam.core.Window"],code:function(){foam.__context__=foam.core.Window.create({window:globalThis},foam.__context__).__subContext__}});
foam.CLASS({package:"foam.core.internal",name:"ContextMultipleInheritence",exports:["createSubContext"],methods:[{class:"ContextMethod",name:"createSubContext",code:function createSubContext(X,opt_args,opt_name){if(foam.core.FObject.isInstance(opt_args)){var obj=opt_args;var exports=obj.cls_.getAxiomsByClass(foam.core.Export);if(!exports||!exports.length)return X;opt_args=exports[0].getExportMap.call(obj)}return this.__context__.createSubContext.call(X,opt_args,opt_name)}}]});foam.SCRIPT({package:"foam.core",name:"ContextMultipleInheritenceScript",requires:["foam.core.internal.ContextMultipleInheritence"],code:function(){var tmp=foam.core.internal.ContextMultipleInheritence.create();tmp.setPrivate_("__context__",foam.__context__);foam.__context__=tmp.__subContext__}});
foam.CLASS({package:"foam.core",name:"Argument",properties:[{name:"name"},{name:"type"},{name:"of",postSet:function(_,of){console.warn("Deprecated usage of Argument.of",this.name,of);this.type=of}},{class:"String",name:"documentation"}]});
foam.CLASS({package:"foam.core",name:"MethodArgumentRefine",refines:"foam.core.AbstractMethod",properties:[{class:"FObjectArray",of:"foam.core.Argument",name:"args",adapt:function(o,n,prop){if(foam.String.isInstance(n)){if(n==="")return[];n=n.split(", ")}return foam.core.FObjectArray.ADAPT.value.call(this,o,n,prop)},adaptArrayElement:function(e,obj){if(foam.String.isInstance(e)){let res=/(?:([\S.$]+)\s+)?([\w$?]+)/g.exec(e);let type=res[1];let name=res[2];e={name:name};if(type)e.type=type}var ctx=obj.__subContext__||foam;var of=e.class||this.of;var cls=ctx.lookup(of);return cls.isInstance(e)?e:foam.String.isInstance(e)?cls.create({name:e}):cls.create(e,obj)}}]});
foam.CLASS({refines:"foam.core.AbstractMethod",package:"foam.core",name:"CreateChildRefines",methods:[function createChildMethod_(child){var result=child.clone();var props=child.cls_.getAxiomsByClass(foam.core.Property);for(var i=0;i<props.length;i++){var prop=props[i];if(this.hasOwnProperty(prop.name)&&!child.hasOwnProperty(prop.name)){prop.set(result,prop.get(this))}}var i=0;var resultArgs=[];for(;i<this.args.length;i++)resultArgs.push(this.args[i].clone().copyFrom(child.args[i]));for(;i<child.args.length;i++)resultArgs.push(child.args[i]);result.args=resultArgs;return result}]});
foam.CLASS({package:"foam.core",name:"MultiMethod",extends:"foam.core.AbstractMethod",properties:[{name:"name",factory:function(){return this.methodName+this.args.map(function(a){return a.type}).join(":")}},{name:"methodName",required:true}],methods:[function installInProto(proto){var key=this.cls_.id.replace(/\./g,":")+":"+this.methodName;console.log("Installing: "+key);var dispath=this.createDispatch(proto,key,0,this.args);displatch.code=this.code},function createDispatch(proto,prefix,pos,args){var d=proto[prefix];if(!d){var prefix2=prefix+":"+args[pos]+typeName;proto[prefix]=function dispatch(){if(arguments.length===pos){return arguments.callee.code.apply(this,arguments)}var t=foam.typeOf(arguments[pos]);var f=t[prefix2];return f.apply(this,arguments)}}if(pos===args.length)return proto[prefix]},function exportAs(obj){var m=obj[this.name];debugger;var f=function exportedMethod(){return m.apply(obj,arguments)};f.toString=()=>{return"exportedMultiMethod "+this.name+" "+m};return f}]});foam._IS_DEBUG_=true;
foam.CLASS({package:"foam.core",name:"ModelSourceRefinement",refines:"foam.core.Model",flags:["debug"],properties:[{name:"source",transient:true}],methods:[function validate(){this.SUPER();if(this.refines){if(this.hasOwnProperty("extends")){throw this.id+': "extends" and "refines" are mutually exclusive.'}}for(var i=0;i<this.axioms_.length;i++){this.axioms_[i].validate&&this.axioms_[i].validate(this)}}]});
foam.CLASS({package:"foam.core",name:"ListenerValidateRefinement",refines:"foam.core.Listener",flags:["debug"],methods:[function validate(){foam.assert(!this.isMerged||!this.isFramed,"Listener can't be both isMerged and isFramed: ",this.name)}]});
foam.CLASS({package:"foam.core",name:"PropertyValidateRefinement",refines:"foam.core.Property",flags:["debug"],properties:[{name:"source",transient:true}],methods:[function validate(model){this.SUPER();foam.assert(!this.name.endsWith("$"),'Illegal Property Name: Can\'t end with "$": ',this.name);var mName;var es=foam.core.Property.SHADOW_MAP||{};for(var key in es){var e=es[key];if(this[key]){for(var j=0;j<e.length;j++){if(this.hasOwnProperty(e[j])){if(!mName){mName=model.id?model.id+".":model.refines?model.refines+".":""}var source=this.source;this.__context__.warn((source?source+" ":"")+"Property "+mName+this.name+' "'+e[j]+'" hidden by "'+key+'"')}}}}},function validateClass(cls){if(this.expression){var expression=this.expression;var pName=cls.id+"."+this.name+".expression: ";var argNames=foam.Function.breakdown(expression).args.map(function(a){return a.split("$").shift()});for(var i=0;i<argNames.length;i++){var name=argNames[i];var axiom=cls.getAxiomByName(name);foam.assert(axiom,"Unknown argument ",name," in ",pName,expression);axiom&&foam.assert(axiom.toSlot,"Non-Slot argument ",name," in ",pName,expression)}}}]});foam.SCRIPT({package:"foam.core",name:"DebugScript",flags:["debug"],code:function(){foam.core.FObject.describe=function(opt_name){console.log("CLASS:  ",this.name);console.log("extends:",this.model_.extends);console.log("Axiom Type           Source Class   Name                 Source Path");console.log("-------------------------------------------------------------------------------------------------");for(var key in this.axiomMap_){var a=this.axiomMap_[key];console.log(foam.String.pad(a.cls_?a.cls_.name:"anonymous",20),foam.String.pad(a.sourceCls_&&a.sourceCls_.name||"unknown",14),foam.String.pad(a.name,20),a.source||"")}console.log("\n")};foam.core.FObject.installModel=function(){var superInstallModel=foam.core.FObject.installModel;return function(m){var names={};for(var i=0;i<m.axioms_.length;i++){var a=m.axioms_[i];foam.assert(!names.hasOwnProperty(a.name),"Axiom name conflict in",m.id||m.refines,":",a.name);var prevA=this.getAxiomByName(a.name);var Property=foam.core.Property;if(prevA&&prevA.cls_!==a.cls_&&!(prevA.cls_===Property&&Property.isSubClass(a.cls_))&&!(Property.isSubClass(prevA.cls_)&&a.cls_===Property)){var prevCls=prevA.cls_?prevA.cls_.id:"anonymous";var aCls=a.cls_?a.cls_.id:"anonymous";if(Property.isSubClass(prevA.cls_)&&!Property.isSubClass(a.cls_)){throw"Illegal to change Property to non-Property: "+this.id+"."+a.name+" changed to "+aCls}else if(foam.core.Method.isSubClass(prevA.cls_)&&foam.core.Method.isSubClass(a.cls_)){}else if(prevA.cls_){console.warn("Change of Axiom "+this.id+"."+a.name+" type from "+prevCls+" to "+aCls+" in model "+m.id)}}names[a.name]=a}superInstallModel.call(this,m)}}();foam.core.FObject.validate=function(){for(var key in this.axiomMap_){var a=this.axiomMap_[key];a.validateClass&&a.validateClass(this)}};if(false&&globalThis.Proxy){(function(){var IGNORE={oldValue:true,SUPER:true,obj:true,private_:true,prop:true,slotName_:true,sourceCls_:true,value:true};var oldCreate=foam.core.FObject.create;foam.core.FObject.create=function(args,ctx){return new Proxy(oldCreate.call(this,args,ctx),{get:function(target,prop,receiver){return Reflect.get(target,prop,receiver)},set:function(target,prop,value,receiver){foam.assert(IGNORE[prop]||target.cls_.getAxiomByName(prop.endsWith("$")?prop.substring(0,prop.length-1):prop),"Invalid Set: ",target.cls_.id,prop,value);Reflect.set(target,prop,value,receiver);return true}})}})()}}});
foam.CLASS({package:"foam.core",name:"FObjectDescribeRefinement",refines:"foam.core.FObject",flags:["debug"],methods:[function unknownArg(key,value){},function describe(opt_name){this.__context__.log("Instance of",this.cls_.name);this.__context__.log("Axiom Type           Name           Value");this.__context__.log("----------------------------------------------------");var ps=this.cls_.getAxiomsByClass(foam.core.Property);for(var i=0;i<ps.length;i++){var p=ps[i];var value;try{value=p.hidden?"-hidden-":this[p.name]}catch(x){value="-"}if(foam.Array.isInstance(value)){}else if(value&&value.toString){value=value.toString()}console.log(foam.String.pad(p.cls_?p.cls_.name:"anonymous",20),foam.String.pad(p.name,14),value)}this.__context__.log("\n")}]});foam.SCRIPT({package:"foam.core",name:"DebugDescribeScript",flags:["debug"],code:function(){foam.__context__=foam.__context__.createSubContext({describe:function(){this.log("Context:",this.hasOwnProperty("NAME")?this.NAME:"anonymous "+this.$UID);this.log("KEY                                      Type                                     Value");this.log("--------------------------------------------------------------------------------------------------");for(var key in this){try{var value=this[key];var type=foam.core.FObject.isInstance(value)?value.cls_.name:typeof value;if(type=="PropertySlot")value=value.get();if(type=="ConstantSlot")value=value.get();if(foam.core.FObject.isInstance(value))value=value.cls_.name;this.log(foam.String.pad(key,40),foam.String.pad(type,40),value)}catch(x){}}this.log("\n")}})}});
foam.CLASS({package:"foam.debug",name:"Window",exports:["merged","framed"],methods:[function merged(l,opt_delay){var f=this.__context__.merged(l,opt_delay);f.toString=function(){return"MERGED("+opt_delay+", "+listener.$UID+", "+listener+")"};return f},function framed(l){var f=this.__context__.framed(l);f.toString=function(){return"ANIMATE("+l.$UID+", "+l+")"};return f}]});foam.SCRIPT({package:"foam.core",name:"DebugContextScript",requires:["foam.debug.Window"],flags:["debug"],code:function(){foam.__context__=foam.debug.Window.create(null,foam.__context__).__subContext__}});foam.SCRIPT({package:"foam.core",name:"DebugImportScript",code:function(){foam.core.Import}});
foam.CLASS({package:"foam.core",name:"FObjectValidateImportsRefinement",refines:"foam.core.FObject",flags:["debug"],methods:[function init(){var is=this.cls_.getAxiomsByClass(foam.core.Import);for(var i=0;i<is.length;i++){var imp=is[i];if(imp.required&&!this.__context__[imp.key+"$"]){var m="Missing required import: "+imp.key+" in "+this.cls_.id;foam.assert(false,m)}}}]});
foam.CLASS({package:"foam.core",name:"ImportValidationRefinement",refines:"foam.core.Import",flags:["debug"],properties:[{name:"name",assertValue:function(n){if(!/^[a-zA-Z][a-zA-Z0-9_]*?$/.test(n)){var m='Import name "'+n+'" must be a valid variable name.';if(n.indexOf(".")!==-1)m+=" Did you mean requires:?";foam.assert(false,m)}}}]});
foam.CLASS({package:"foam.core",name:"FObjectDescribeListenersRefinement",refines:"foam.core.FObject",flags:["debug"],methods:[function describeListeners(){var self=this;var count=0;function show(ls,path){var next=ls.next;for(var next=ls.next;next;next=next.next){count++;self.log(path,{l:next.l})}for(var key in ls.children){show(ls.children[key],path?path+"."+key:key)}}show(this.getPrivate_("listeners"));this.__context__.log(count,"subscriptions")}]});foam.LIB({name:"foam.debug",methods:[function showCreates(){var lastCounts_=this.lastCounts_||(this.lastCounts_={});console.log("Class                                         Count      Delta");console.log("-----------------------------------------------------------------");for(var key in foam.USED){var c=foam.USED[key];if(c.count_){var lc=lastCounts_[key]||0;lastCounts_[key]=c.count_;console.log(foam.String.pad(c.id,45),foam.String.pad(c.count_+"",10),c.count_-lc)}}}]});
foam.CLASS({package:"foam.core",name:"CoreTypesValidationTestModel",properties:[{name:"id",class:"String"},{name:"testDate",class:"DateTime"}]});
foam.CLASS({package:"foam.core",name:"CoreTypesValidationTest",extends:"foam.nanos.test.Test",methods:[{name:"runTest",}]});
foam.CLASS({package:"foam.pattern",name:"Singleton",properties:[["name","create"]],methods:[function installInClass(cls){var oldCreate=cls.create;var newCreate=cls.create=function(){if(this.create!==newCreate)return oldCreate.apply(this,arguments);return this.private_.instance_||(this.private_.instance_=oldCreate.apply(this,arguments))}},function installInProto(p){p.clone=function(){return this};p.equals=function(o){return this===o}}]});
foam.CLASS({package:"foam.pattern",name:"SingletonSingletonRefinement",refines:"foam.pattern.Singleton",axioms:[foam.pattern.Singleton.create()]});
foam.CLASS({package:"foam.pattern",name:"Multiton",properties:[["name","create"],{class:"String",name:"property"}],methods:[function installInClass(cls){var property=this.property;var oldCreate=cls.create;cls.create=function(args){var instances=this.private_.instances||(this.private_.instances={});var key=args[property];if(key===undefined){key=cls.getAxiomByName(property).value}return instances[key]||(instances[key]=oldCreate.apply(this,arguments))}},function installInProto(p){p.clone=function(){return this};p.equals=function(o){return this===o}}]});
foam.CLASS({package:"foam.core.internal",name:"EnumValueAxiom",properties:[{name:"ordinal",getter:function(){return this.definition.ordinal},setter:function(o){this.definition.ordinal=o}},{name:"name",getter:function(){return this.definition.name}},"definition",["priority",50]],methods:[function installInClass(cls){var e=cls.create(this.definition);cls.installConstant(this.name,e);cls.VALUES.push(e)}]});
foam.CLASS({package:"foam.core",name:"EnumModel",extends:"Model",requires:["foam.core.internal.EnumValueAxiom"],properties:[["extends","foam.core.AbstractEnum"],{class:"AxiomArray",of:"foam.core.internal.EnumValueAxiom",name:"values",toJSON:function(values,out){return values.map(function(v){return v.definition})},adapt:function(_,v){var used={};var next=0;for(var i=0;i<v.length;i++){var def=v[i];if(foam.String.isInstance(def)){def={label:def,name:foam.String.constantize(def)}}def=this.EnumValueAxiom.isInstance(def)?def:def.class?this.__context__.lookup(def.class).create(def):this.EnumValueAxiom.create({definition:def});v[i]=def;if(def.definition.ordinal==undefined){def.ordinal=next}next=Math.max(def.ordinal+1,next);if(used[def.ordinal]){throw this.id+" Enum error: duplicate ordinal found "+def.name+" "+used[def.ordinal]+" both have an ordinal of "+def.ordinal}used[def.ordinal]=def.name}return v}}]});
foam.CLASS({package:"foam.core",name:"AbstractEnum",axioms:[foam.pattern.Multiton.create({property:"ordinal"}),{installInClass:function(cls){Object.defineProperty(cls,"VALUES",{get:function(){return this.private_.VALUES||(this.private_.VALUES=[])},configurable:true,enumerable:false})},installInProto:function(p){Object.defineProperty(p,"VALUES",{get:function(){return this.cls_.VALUES},configurable:true,enumerable:false})}}],static:[function forOrdinal(i){return this.VALUES.find(e=>e.ordinal==i)}],properties:[{class:"String",name:"documentation",transient:true},{class:"Int",name:"ordinal",value:-1,final:true},{class:"String",name:"name",transient:true,final:true},{class:"String",name:"label",transient:true,factory:function(){return this.name.toUpperCase()==this.name?this.name.split("_").map(l=>foam.String.labelize(l.toLowerCase())).join(" "):this.name}},{class:"String",name:"color"},{class:"String",name:"background"},{class:"String",name:"glyphFill",factory:function(){return this.color}},{class:"String",name:"glyphBackground",factory:function(){return this.background}},{class:"Boolean",name:"isItalic"},{class:"Boolean",name:"isBold"},{class:"StringArray",name:"extraClasses",generateJava:false},{class:"GlyphProperty",name:"glyph"}],methods:[function outputFObject(o){o.out(this.ordinal)},function toSummary(){return this.label},function toStyle(){var style={display:"inline-block"};if(this.color)style.color=this.color;if(this.background)style.background=this.background;if(this.isItalic)style["font-style"]="italic";if(this.isBold)style["font-weight"]="bold";return style},function classes(){return this.extraClasses.concat(foam.String.cssClassize(this.cls_.id)+"-"+this.name)},function toString(){return this.name}]});
foam.CLASS({package:"foam.core",name:"Enum",extends:"Property",properties:[{class:"Class",name:"of",required:true},{name:"type",factory:function(){return this.of.id}},{name:"value",adapt:function(_,n){if(foam.String.isInstance(n))n=foam.lookup(this.type)[n];if(foam.Object.isInstance(n)&&n.class)n=foam.lookup(n.class).create(n);return n},expression:function(type){return type&&foam.lookup(type).VALUES[0]}},{name:"javaValue",flags:["java"],expression:function(type,value){return foam.lookup(type).id+"."+value}},["adapt",function(o,n,prop){var type=foam.lookup(prop.type);if(n&&typeof n==="function")n=n();if(n&&n.cls_===type)return n;var valueType=foam.typeOf(n),ret;if(valueType===foam.String){ret=type[foam.String.constantize(n)]}else if(valueType===foam.Number){ret=type.create({ordinal:n},foam.__context__)}else if(valueType===foam.Object){ret=type.create(n,foam.__context__)}if(ret)return ret;throw new Error("Attempt to set invalid Enum value. Enum: "+type.id+", value: "+n)}],{name:"toJSON",value:function(value){return value.ordinal}}]});foam.LIB({name:"foam",methods:[function ENUM(m){m.class=m.class||"foam.core.EnumModel";return foam.CLASS(m)}]});
foam.CLASS({package:"foam.core",name:"PropertyToFromJSONRefinement",refines:"foam.core.Property",properties:[{name:"fromJSON",value:function fromJSON(value,ctx,prop,json){return foam.json.parse(value,null,ctx)}},{name:"toJSON",value:function toJSON(value,outputter){return value}}],methods:[function outputJSON(o){if(o.passPropertiesByReference){o.output({class:"__Property__",forClass_:this.forClass_,name:this.name})}else{o.outputFObject_(this)}}]});
foam.CLASS({package:"foam.core",name:"__Property__",axioms:[{name:"create",installInClass:function(c){var oldCreate=c.create;c.create=function(args,X){var clsName=args.forClass_;var name=args.name;var cls=X.maybeLookup(clsName);if(!cls){clsName=args.forClass_.substring(0,args.forClass_.lastIndexOf("."));name=args.forClass_.substring(args.forClass_.lastIndexOf(".")+1);cls=X.lookup(clsName)}var prop=cls.getAxiomByName(name);foam.assert(prop,'Could not find property "',args.forClass_+"."+name,'"');return prop}}}]});
foam.CLASS({package:"foam.core",name:"__Class__",axioms:[{name:"create",installInClass:function(cls){cls.create=function(args,x){return foam.maybeLookup(args.forClass_)}}}]});
foam.CLASS({package:"foam.core",name:"__Timestamp__",axioms:[{name:"create",installInClass:function(cls){cls.create=function(args){return new Date(args.value)}}}]});
foam.CLASS({package:"foam.core",name:"FObjectStringifyRefinement",refines:"foam.core.FObject",methods:[function stringify(){return foam.json.Pretty.stringify(this)}]});
foam.CLASS({package:"foam.json",name:"Outputter",properties:[{class:"String",name:"buf_",value:""},{class:"Boolean",name:"pretty",value:true,postSet:function(_,p){if(p){this.clearProperty("indentStr");this.clearProperty("nlStr");this.clearProperty("postColonStr");this.clearProperty("useShortNames")}else{this.indentStr=this.nlStr=this.postColonStr=null}}},{class:"Boolean",name:"strict",value:true,postSet:function(_,s){if(s){this.useShortNames=false;this.formatDatesAsNumbers=false;this.alwaysQuoteKeys=true;this.formatFunctionsAsStrings=true}else{this.alwaysQuoteKeys=false;this.formatFunctionsAsStrings=false}}},{class:"Int",name:"indentLevel_",value:0},{class:"String",name:"indentStr",value:"\t"},{class:"String",name:"nlStr",value:"\n"},{class:"String",name:"postColonStr",value:" "},{class:"Boolean",name:"useTemplateLiterals",help:"If true, multiline strings will be outputted using template literals (i.e. surrounded by backticks)",value:false},{class:"Boolean",name:"alwaysQuoteKeys",help:"If true, keys are always quoted, as required by the JSON standard. If false, only quote keys which aren'tvalid JS identifiers.",value:true},{class:"Boolean",name:"passPropertiesByReference",help:"If true, Property objects are passed as __Property__ references rather than by value.",value:true},{class:"Boolean",name:"formatDatesAsNumbers",value:false},{class:"Boolean",name:"formatFunctionsAsStrings",value:true},{class:"Boolean",name:"outputDefaultValues",value:true},{class:"Boolean",name:"outputOwnPropertiesOnly",value:true},{class:"Boolean",name:"outputClassNames",value:true},{class:"Function",name:"propertyPredicate",value:function(o,p){return!p.transient}},{class:"Function",name:"objectKeyValuePredicate",value:function(k,v){return true}},{class:"Boolean",name:"useShortNames",value:false},{class:"Boolean",name:"sortObjectKeys",value:false},{class:"Boolean",name:"convertUnserializableToStubs",value:false}],methods:[function reset(){this.indentLevel_=0;this.buf_="";return this},function escape(str){return str.replace(/\\/g,"\\\\").replace(/"/g,'\\"').replace(/[\x00-\x1f]/g,function(c){return"\\u00"+(c.charCodeAt(0)<16?"0"+c.charCodeAt(0).toString(16):c.charCodeAt(0).toString(16))})},function maybeEscapeKey(str){return this.alwaysQuoteKeys||!/^[a-zA-Z\$_][0-9a-zA-Z$_]*$/.test(str)?'"'+str+'"':str},function out(){for(var i=0;i<arguments.length;i++)this.buf_+=arguments[i];return this},function start(c){if(c)this.out(c).nl();if(this.indentStr){this.indentLevel_++;this.indent()}return this},function end(c){if(this.indent)this.indentLevel_--;if(c)this.nl().indent().out(c);return this},function nl(){if(this.nlStr&&this.nlStr.length)this.out(this.nlStr);return this},function indent(){for(var i=0;i<this.indentLevel_;i++)this.out(this.indentStr);return this},function outputPropertyName(p){this.out(this.maybeEscapeKey(this.useShortNames&&p.shortName?p.shortName:p.name));return this},function outputProperty(o,p,includeComma){if(!this.propertyPredicate(o,p))return false;if(!this.outputDefaultValues&&p.isDefaultValue(o[p.name]))return false;if(this.outputOwnPropertiesOnly&&!o.hasOwnProperty(p.name))return false;var v=o[p.name];if(includeComma)this.out(",");this.nl().indent().outputPropertyName(p).out(":",this.postColonStr);this.output(p.toJSON(v,this),p.of);return true},function outputString(str){if(this.useTemplateLiterals&&str.indexOf("\n")!=-1){this.out("`",str.replace(/`/g,"\\`"),"`")}else{this.out('"',this.escape(str),'"')}},function outputDate(o){this.out('{"class":"__Timestamp__","value":');this.output(this.formatDatesAsNumbers?o.getTime():o.toISOString());this.out("}")},function outputFunction(o){if(this.formatFunctionsAsStrings){this.output(o.toString())}else{this.out(o.toString())}},function outputRegExp(o){this.outputFunction(o)},function outputFObject(o,opt_cls){if(o.outputJSON){o.outputJSON(this)}else{this.outputFObject_(o,opt_cls)}},function outputFObject_(o,opt_cls){this.start("{");var cls=this.getCls(opt_cls);var outputClassName=this.outputClassNames&&o.cls_!==cls;if(outputClassName){this.out(this.maybeEscapeKey("class"),":",this.postColonStr,'"',o.cls_.id,'"')}var ps=o.cls_.getAxiomsByClass(foam.core.Property);var outputComma=outputClassName;for(var i=0;i<ps.length;i++){outputComma=this.outputProperty(o,ps[i],outputComma)||outputComma}this.end("}")},function outputObjectKeyValue_(key,value,first){if(this.objectKeyValuePredicate(key,value)){if(!first)this.out(",").nl().indent();this.out(this.maybeEscapeKey(key),":",this.postColonStr).output(value);return true}return false},function outputObjectKeyValues_(o){var first=true;for(var key in o){first=!this.outputObjectKeyValue_(key,o[key],first)&&first}},function outputSortedObjectKeyValues_(o){var key,keys=[];for(key in o)keys.push(key);keys.sort();var first=true;for(var i=0;i<keys.length;i++){key=keys[i];first=!this.outputObjectKeyValue_(key,o[key],first)&&first}},function outputClassInfo(o){this.out('{"class":"__Class__","forClass_":');this.outputString(o.id);this.out("}")},{name:"output",code:foam.mmethod({Undefined:function(o){this.out("null")},Null:function(o){this.out("null")},String:function(o){this.outputString(o)},Number:function(o){this.out(o)},Boolean:function(o){this.out(o)},Date:function(o){this.outputDate(o)},Function:function(o){this.outputFunction(o)},RegExp:function(o){this.outputRegExp(o)},FObject:function(o,opt_cls){this.outputFObject(o,opt_cls)},Array:function(o,opt_cls){this.start("[");var cls=this.getCls(opt_cls);for(var i=0;i<o.length;i++){this.output(o[i],cls);if(i<o.length-1)this.out(",").nl().indent()}this.end("]")},Object:function(o){if(foam.core.FObject.isSubClass(o)){this.outputClassInfo(o)}else if(o.outputJSON){o.outputJSON(this)}else{this.start("{");if(this.sortObjectKeys){this.outputSortedObjectKeyValues_(o)}else{this.outputObjectKeyValues_(o)}this.end("}")}}})},function stringify(o,opt_cls){this.buf_="";this.output(o,opt_cls);var ret=this.buf_;this.reset();return ret},{name:"objectify",code:foam.mmethod({Date:function(o){return this.formatDatesAsNumbers?o.valueOf():o},Function:function(o){return this.formatFunctionsAsStrings?o.toString():o},FObject:function(o,opt_cls){var m={};var cls=this.getCls(opt_cls);if(this.outputClassNames&&o.cls_!==cls){m.class=o.cls_.id}var ps=o.cls_.getAxiomsByClass(foam.core.Property);for(var i=0;i<ps.length;i++){var p=ps[i];if(!this.propertyPredicate(o,p))continue;if(!this.outputDefaultValues&&p.isDefaultValue(o[p.name]))continue;m[p.name]=this.objectify(p.toJSON(o[p.name],this),p.of)}return m},Array:function(o,opt_cls){var a=[];var cls=this.getCls(opt_cls);for(var i=0;i<o.length;i++){a[i]=this.objectify(o[i],cls)}return a},Object:function(o){var ret={};for(var key in o){if(o.hasOwnProperty(key))ret[key]=this.objectify(o[key])}return ret}},function(o){return o})},function getCls(opt_cls){return foam.typeOf(opt_cls)===foam.String?this.__context__.maybeLookup(opt_cls):opt_cls}]});
foam.CLASS({package:"foam.json",name:"Parser",properties:[{class:"Boolean",name:"strict",value:true},{name:"creationContext"},{name:"fonParser_",expression:function(creationContext){return foam.parsers.FON.create({creationContext:creationContext})}}],methods:[function parseString(str,opt_ctx){return this.parseClassFromString(str,null,opt_ctx)},function aparse(str,opt_ctx){var x=this.__context__;var json=JSON.parse(str);var references=foam.json.references(x,json);return Promise.all(references).then(()=>{return foam.json.parse(json,undefined,opt_ctx||this.creationContext)})},function parseClassFromString(str,opt_cls,opt_ctx){return this.strict?foam.json.parse(JSON.parse(str),opt_cls,opt_ctx||this.creationContext):opt_ctx?foam.parsers.FON.create({creationContext:opt_ctx||this.creationContext}).parseClassFromString(str,opt_cls):this.fonParser_.parseClassFromString(str,opt_cls)},function clone(){return this}]});foam.LIB({name:"foam.json",constants:{Pretty:foam.json.Outputter.create({strict:false}),Strict:foam.json.Outputter.create({pretty:false,strict:true}),PrettyStrict:foam.json.Outputter.create({pretty:true,strict:true}),Compact:foam.json.Outputter.create({pretty:false,strict:false,formatDatesAsNumbers:true,outputDefaultValues:false}),Short:foam.json.Outputter.create({pretty:false,strict:false,formatDatesAsNumbers:true,outputDefaultValues:false,useShortNames:false}),Network:foam.json.Outputter.create({pretty:false,strict:true,formatDatesAsNumbers:true,outputDefaultValues:true,useShortNames:false,convertUnserializableToStubs:true,propertyPredicate:function(o,p){return!p.networkTransient}}),Dig:foam.json.Outputter.create({pretty:true,strict:false,formatDatesAsNumbers:false,outputDefaultValues:true,useShortNames:false,convertUnserializableToStubs:true,propertyPredicate:function(o,p){return!p.externalTransient&&!p.networkTransient}}),Storage:foam.json.Outputter.create({pretty:false,strict:false,formatDatesAsNumbers:true,outputDefaultValues:false,useShortNames:false,propertyPredicate:function(o,p){return!p.storageTransient}}),StorageStrict:foam.json.Outputter.create({pretty:false,strict:true,formatDatesAsNumbers:true,outputDefaultValues:false,useShortNames:false,propertyPredicate:function(o,p){return!p.storageTransient}}),Cluster:foam.json.Outputter.create({pretty:false,strict:false,formatDatesAsNumbers:true,outputDefaultValues:false,useShortNames:false,propertyPredicate:function(o,p){return!p.clusterTransient}})},methods:[{name:"parse",args:[{type:"Any",name:"o"},{type:"Class",name:"opt_class"},{type:"Context",name:"opt_ctx"}],code:foam.mmethod({Array:function(o,opt_class,opt_ctx){if(foam.String.isInstance(opt_class))opt_class=(opt_ctx||foam).lookup(opt_class);var a=new Array(o.length);for(var i=0;i<o.length;i++){a[i]=this.parse(o[i],opt_class,opt_ctx)}return a},FObject:function(o){return o},Object:function(json,opt_class,opt_ctx){if(foam.String.isInstance(opt_class))opt_class=(opt_ctx||foam).lookup(opt_class);var c=json.class||opt_class;if(foam.String.isInstance(c))c=(opt_ctx||foam).lookup(c);if(c){if(json.class&&json.class!=c.id){if(foam.Undefined.isInstance(c)){console.warn("In foam.core.JSON.parse(Object): JSON parser tried to deserialize class '"+json.class+"' and failed. Is this class available to the client?");return null}}if(c.PARSE_JSON)return c.PARSE_JSON(json,opt_class,opt_ctx);var pMap=c.model_.getPrivate_("axiomsByNameOrShortnameMap");if(!pMap){pMap=c.model_.setPrivate_("axiomsByNameOrShortnameMap",{});c.getAxiomsByClass(foam.core.Property).forEach(function(p){pMap[p.name]=p;if(p.shortName)pMap[p.shortName]=p})}for(var key in json){var prop=pMap[key];if(prop){var js=prop.fromJSON(json[key],opt_ctx,prop,this);if(js==null&&json[key]!="null"){console.warn('Unable to parse property "'+key+'"',"in",json)}else{json[prop.name]=js}}}var o=c.create(json,opt_ctx);return o}for(var key in json){var o=json[key];json[key]=this.parse(json[key],null,opt_ctx)}return json}},function(o){return o})},{name:"references",code:function(x,o,r){r=r||[];if(foam.Array.isInstance(o)){for(var i=0;i<o.length;i++){foam.json.references(x,o[i],r)}}else if(foam.core.FObject.isSubClass(o)){return r}else if(foam.Object.isInstance(o)){for(var key in o){if(!o[key])continue;if(key==="type"&&foam.String.isInstance(o[key])){foam.core.type.toType(o[key]).refs().forEach(function(id){r.push(x.classloader.maybeLoad(id))});continue}if((key==="of"||key==="class"||key==="view"||key==="sourceModel"||key==="targetModel"||key==="refines")&&foam.String.isInstance(o[key])){r.push(x.classloader.maybeLoad(o[key]));continue}foam.json.references(x,o[key],r)}return r}}},function parseString(jsonStr,opt_ctx){return this.parse(eval("("+jsonStr+")"),undefined,opt_ctx)},function stringify(o){return foam.json.Compact.stringify(o)},function objectify(o){return foam.json.Compact.objectify(o)}]});
foam.CLASS({package:"foam.core",name:"PropertyXMLRefinement",refines:"foam.core.Property",properties:[{class:"Boolean",name:"xmlAttribute",value:false},{class:"Boolean",name:"xmlTextNode",value:false},{name:"fromXML",hidden:true,value:function fromXML(value,ctx,prop,xml){return foam.xml.parse(value,null,ctx)}},{name:"toXML",hidden:true,value:function toXML(value,Outputter){return value}}],methods:[function outputXML(o){o.output({class:"__Property__",forClass_:this.forClass_,name:this.name})}]});
foam.CLASS({package:"foam.core",name:"FObjectXMLStringify",refines:"foam.core.FObject",methods:[function toXML(){return foam.xml.Pretty.stringify(this)}]});
foam.CLASS({package:"foam.xml",name:"Outputter",properties:[{class:"String",name:"buf_",value:""},{class:"Int",name:"indentLevel_",value:0},{class:"String",name:"indentStr",value:"\t"},{class:"String",name:"nlStr",value:"\n"},{class:"Boolean",name:"outputDefaultValues",value:true},{class:"Boolean",name:"outputDefinedValues",value:true},{class:"Boolean",name:"formatDatesAsNumbers",value:false},{class:"Boolean",name:"outputClassNames",value:true},{class:"Function",name:"propertyPredicate",value:function(o,p){return!p.transient}},{class:"Boolean",name:"useShortNames",value:false},{class:"Boolean",name:"sortObjectKeys",value:false},{class:"Boolean",name:"pretty",value:true,postSet:function(_,p){if(p){this.clearProperty("indentStr");this.clearProperty("nlStr");this.clearProperty("useShortNames")}else{this.indentStr=this.nlStr=null}}}],methods:[function reset(){this.indentLevel_=0;this.buf_="";return this},function escape(str){return str&&str.toString().replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")},function maybeEscapeKey(str){return this.alwaysQuoteKeys||!/^[a-zA-Z\$_][0-9a-zA-Z$_]*$/.test(str)?'"'+str+'"':str},function escapeAttr(str){return str&&str.replace(/"/g,"&quot;")},function out(){for(var i=0;i<arguments.length;i++)this.buf_+=arguments[i];return this},function start(c){if(c)this.out(c);if(this.indentStr){this.indentLevel_++;this.indent()}},function end(c){if(this.indent){this.indentLevel_--}if(c)this.nl().indent().out(c);return this},function nl(){if(this.nlStr&&this.nlStr.length){this.out(this.nlStr)}return this},function indent(){for(var i=0;i<this.indentLevel_;i++)this.out(this.indentStr);return this},function outputPropertyName(p){this.out(this.maybeEscapeKey(this.useShortNames&&p.shortName?p.shortName:p.name));return this},function outputAttributes(v){var attributes=v.cls_.getAxiomsByClass(foam.core.Property).filter(function(p){return p.xmlAttribute});if(attributes.length===0)return this;for(var i=0;i<attributes.length;i++){this.out(" "+attributes[i].name+'="'+this.escapeAttr(attributes[i].get(v))+'"')}return this},function propertyName(p){return this.maybeEscapeKey(this.useShortNames&&p.shortName?p.shortName:p.name)},function outputProperty_(o,p){if(!this.propertyPredicate(o,p))return;if(this.outputDefinedValues){if(!o.hasOwnProperty(p.name))return}else if(this.outputDefaultValues){if(p.isDefaultValue(o[p.name]))return}var v=o[p.name];if(!v||v instanceof Array&&v.length===0){return}this.nl().indent();this.outputProperty(v,p)},{name:"outputProperty",code:foam.mmethod({Undefined:function(v,p){},String:function(v,p){this.outputPrimitive(v,p)},Number:function(v,p){this.outputPrimitive(v,p)},Boolean:function(v,p){this.outputPrimitive(v,p)},Date:function(v,p){this.outputPrimitive(v,p)},AbstractEnum:function(v,p){this.outputPrimitive(v.name,p)},Array:function(v,p){for(var i=0;i<v.length;i++){if(foam.core.FObjectArray.isInstance(p)){this.start("<"+this.propertyName(p)+">");this.output(p.toXML(v[i],this));this.end("</"+this.propertyName(p)+">")}else{this.outputPrimitive(v[i],p)}if(i!=v.length-1)this.nl().indent()}},FObject:function(v,p){if(v.text){if(foam.core.FObject.isInstance(v.text)){this.start("<"+this.propertyName(p)+this.outputAttributes(v)+">");this.output(p.toXML(v,this));this.end("</"+this.propertyName(p)+">")}else{this.out("<").outputPropertyName(p).outputAttributes(v).out(">");this.out(p.toXML(v.text,this));this.out("</").outputPropertyName(p).out(">")}}else{this.start("<"+this.propertyName(p)+">");this.output(p.toXML(v,this));this.end("</"+this.propertyName(p)+">")}},Object:function(v,p){this.outputPrimitive(v,p)}})},function outputPrimitive(v,p){this.out("<").outputPropertyName(p).out(">");this.output(p.toXML(v,this));this.out("</").outputPropertyName(p).out(">")},function outputDate(o){if(this.formatDatesAsNumbers){this.out(o.valueOf())}else{this.out(o.toISOString())}},function outputFunction(o){if(this.formatFunctionsAsStrings){this.output(o.toString())}else{this.out(o.toString())}},function outputObjectKeyValue_(key,value,first){if(!first)this.out(",").nl().indent();this.out(this.maybeEscapeKey(key),":").output(value)},function outputObjectKeyValues_(o){var first=true;for(var key in o){this.outputObjectKeyValue_(key,o[key],first);first=false}},function outputSortedObjectKeyValues_(o){var key,keys=[];for(key in o)keys.push(key);keys.sort();var first=true;for(var i=0;i<keys.length;i++){key=keys[i];this.outputObjectKeyValue_(key,o[key],first);first=false}},{name:"output",code:foam.mmethod({Undefined:function(o){this.out("null")},Null:function(o){this.out("null")},String:function(o){this.out(this.escape(o))},Number:function(o){this.out(o)},Boolean:function(o){this.out(o)},Date:function(o){this.outputDate(o)},Function:function(o){this.outputFunction(o)},AbstractEnum:function(o){},FObject:function(o){if(o.outputXML){o.outputXML(this);return}var clsName=o.cls_.id;var ps=o.cls_.getAxiomsByClass(foam.core.Property);for(var i=0;i<ps.length;i++){if(ps[i].xmlAttribute)continue;this.outputProperty_(o,ps[i])}},Array:function(o,opt_cls){this.start("<objects>\n");var cls=this.getCls(opt_cls);for(var i=0;i<o.length;i++){this.start("<object>\n");this.output(o[i],cls);this.end("\n</object>");if(i<o.length-1)this.out("\n").nl().indent()}this.end("\n</objects>")},Object:function(o){if(o.outputXML){o.outputXML(this)}else{var oName=o.name;this.start("<object name='"+oName+"'>");if(this.sortObjectKeys){this.outputSortedObjectKeyValues_(o)}else{this.outputObjectKeyValues_(o)}this.end("</object>")}}})},function stringify(o){this.output(o);var ret=this.buf_;this.reset();return ret},function objectify(doc,cls){var obj=cls.create();var children=doc.children;for(var i=0;i<children.length;i++){var node=children[i];var prop=obj.cls_.getAxiomByName(node.tagName);if(foam.core.FObjectProperty.isInstance(prop)){prop.set(obj,this.objectify(node,prop.of))}else if(foam.core.FObjectArray.isInstance(prop)){prop.get(obj).push(this.objectify(node,foam.lookup(prop.of)))}else if(foam.core.StringArray.isInstance(prop)){prop.get(obj).push(node.firstChild?node.firstChild.nodeValue:null)}else{prop.set(obj,node.firstChild?node.firstChild.nodeValue:null)}}var textProp=obj.cls_.getAxiomByName("text");if(textProp){var attributes=doc.attributes;for(var i=0;i<attributes.length;i++){var attribute=attributes[i];var prop=obj.cls_.getAxiomByName(attribute.name);prop.set(obj,attribute.value)}if(foam.core.FObjectProperty.isInstance(textProp)){textProp.set(obj,this.objectify(doc,textProp.of))}else{textProp.set(obj,doc.firstChild?doc.firstChild.nodeValue:null)}}return obj},function parseString(str,opt_class){var parser=new DOMParser;var doc=parser.parseFromString(str,"text/xml");var root=doc.firstChild;var rootClass=root.getAttribute("class");if(rootClass)return this.objectify(root,foam.lookup(rootClass));if(opt_class){if(typeof opt_class==="string")opt_class=foam.lookup(opt_class);return this.objectify(root,opt_class)}throw new Error("Class not provided")},function getCls(opt_cls){return foam.String.isInstance(opt_cls)}]});foam.LIB({name:"foam.xml",constants:{Pretty:foam.xml.Outputter.create({outputDefaultValues:false,outputDefinedValues:true}),Compact:foam.xml.Outputter.create({pretty:false,formatDatesAsNumbers:true,outputDefaultValues:false,outputDefinedValues:false}),Short:foam.xml.Outputter.create({pretty:false,formatDatesAsNumbers:true,outputDefaultValues:false,outputDefinedValues:false,useShortNames:false})},methods:[function stringify(o){return foam.xml.Compact.stringify(o)},function objectify(o){return foam.xml.Compact.objectify(o)}]});
foam.CLASS({package:"foam.core",name:"IntHolder",properties:[{name:"value",class:"Int"}]});
foam.CLASS({package:"foam.core",name:"StringHolder",properties:[{name:"value",class:"String"}],methods:[function toString(){return this.value}]});
foam.CLASS({package:"foam.core",name:"BooleanHolder",properties:[{name:"value",class:"Boolean"}]});
foam.CLASS({package:"foam.core",name:"RequiredBooleanHolder",extends:"foam.core.BooleanHolder",messages:[{name:"WRONG_VALUE",message:"Wrong value"}],properties:[{name:"value",class:"Boolean",validationPredicates:[{args:["value"],query:"value==true",errorMessage:"WRONG_VALUE"}]}]});
foam.CLASS({package:"foam.core",name:"MapHolder",properties:[{name:"value",class:"Map"}]});
foam.CLASS({package:"foam.core",name:"AnyHolder",properties:["value"]});
foam.CLASS({name:"CompoundException",package:"foam.core",extends:"foam.core.FOAMException",implements:["foam.core.ExceptionInterface"],methods:[{name:"getExceptions",type:"Throwable[]",},{name:"getClientRethrowException",type:"RuntimeException",visibility:"public",},{name:"add",args:[{name:"t",}],},{name:"maybeThrow",},{name:"getMessage",type:"String",}]});
foam.CLASS({package:"foam.lib.csv",name:"CSVParser",requires:["foam.parse.ImperativeGrammar"],properties:[{class:"String",name:"delimiter"},{class:"String",name:"nestedObjectSeperator"},{name:"stringParser",factory:function(){var X=this.X;var self=this;return this.ImperativeGrammar.create({symbols:function(alt,anyChar,literal,literalIC,not,notChars,optional,plus,range,repeat,repeat0,seq,seq1,str,sym){return{START:seq1(1,sym("ws"),repeat(sym("field"),literal(self.delimiter)),sym("ws")),field:alt(sym("quotedText"),sym("unquotedText"),""),unquotedText:repeat(not(literal(self.delimiter),anyChar()),"",1),quotedText:seq1(1,'"',repeat(alt(sym("escapedQuote"),not('"',anyChar()))),'"'),escapedQuote:'""',white:alt(" ","\t","\r","\n"),ws:repeat0(sym("white"))}}}).addActions({unquotedText:function(a){return{node:"unquotedText",value:a.join("")}},quotedText:function(a){return{node:"quotedText",value:a.join("")}},escapedQuote:function(){return'"'}})}},{name:"headerParser",factory:function(){var X=this.X;var self=this;return this.ImperativeGrammar.create({symbols:function(alt,anyChar,literal,literalIC,not,notChars,optional,plus,range,repeat,repeat0,seq,seq1,str,sym){return{START:seq1(1,sym("ws"),repeat(sym("field"),literal(self.nestedObjectSeperator)),sym("ws")),field:alt(sym("text"),""),text:repeat(alt(sym("escapedSeperator"),not(self.nestedObjectSeperator,anyChar())),"",1),escapedSeperator:literal(self.nestedObjectSeperator+self.nestedObjectSeperator),white:alt(" ","\t","\r","\n"),ws:repeat0(sym("white"))}}}).addActions({text:function(a){return{node:"text",value:self.recoverHeaderTitle(a.join(""))}},escapedQuote:function(){return'"'}})}}],methods:[function parseString(str,delimiter){this.delimiter=delimiter;return this.stringParser.parseString(str)},function parseHeader(str,nestedObjectSeperator){this.nestedObjectSeperator=nestedObjectSeperator;return this.headerParser.parseString(str)},function recoverHeaderTitle(t){return t.replace(new RegExp(this.nestedObjectSeperator+this.nestedObjectSeperator,"g"),this.nestedObjectSeperator)}]});foam.INTERFACE({package:"foam.lib.csv",name:"CSVOutputter",proxy:true,methods:[{name:"outputValue",args:[{name:"value"}]},{name:"outputFObject",args:[{type:"Context",name:"x"},{type:"FObject",name:"obj"}]},{name:"flush"}]});
foam.CLASS({package:"foam.lib.csv",name:"CSVOutputterImpl",implements:["foam.lib.csv.CSVOutputter"],properties:[{class:"Class",name:"of",required:true},{class:"StringArray",name:"props",factory:null,expression:function(of){return of.getAxiomByName("tableColumns")?of.getAxiomByName("tableColumns").columns:of.getAxiomsByClass().filter(p=>!p.networkTransient).map(p=>p.name)},},{class:"Boolean",name:"isFirstRow",value:true},{class:"Boolean",name:"isFirstColumn",value:true},{class:"String",name:"csv",view:"foam.u2.tag.TextArea",flags:["js"]},{class:"Object",name:"sb",flags:["java"],}],methods:[{name:"outputValue",code:function(value){if(!this.isFirstColumn)this.csv+=",";this.isFirstColumn=false;this.outputValue_(value)},},{name:"outputValue_",args:[{type:"Any",name:"value"}],code:foam.mmethod({String:function(value){if(value.includes(","))value=`"${value.replace(/\"/g,'""')}"`;this.csv+=value},Date:function(value){this.outputValue_(value.toDateString())},Undefined:function(value){},Null:function(value){}},function(value){this.outputValue_(value.toString())}),},{name:"newLine_",code:function(){this.csv+="\n";this.isFirstColumn=true},},{name:"toString",code:function(){if(this.isFirstRow)this.outputHeader(this.__context__);return this.csv},},{name:"outputHeader",args:[{type:"Context",name:"x"}],code:function(x){this.props.map(name=>this.of.getAxiomByName(name)).forEach(p=>{if(foam.core.Property.isInstance(p))p.toCSVLabel.call(p,x,this)});this.newLine_();this.isFirstRow=false},},{name:"outputFObject",code:function(x,obj){if(!this.of)this.of=obj.cls_;if(this.isFirstRow)this.outputHeader(x);this.props.map(name=>this.of.getAxiomByName(name)).forEach(p=>{if(foam.core.Property.isInstance(p))p.toCSV.call(p,x,obj,this)});this.newLine_()},},{name:"flush",code:function(){this.csv="";this.isFirstColumn=undefined;this.isFirstRow=undefined},}]});
foam.CLASS({package:"foam.lib.csv",name:"PrefixedCSVOutputter",extends:"foam.lib.csv.ProxyCSVOutputter",properties:[{class:"String",name:"prefix"}],methods:[{name:"outputValue",code:function(value){this.delegate.outputValue(this.prefix+value.toString())},}]});
foam.CLASS({package:"foam.lib.csv",name:"DynamicHeaderCSVParser",requires:["foam.parse.StringPStream"],grammars:[{name:"csvRow",symbols:function(){return{START:seq1(0,repeat(sym("field"),",")),field:alt(sym("quotedText"),sym("unquotedText"),""),unquotedText:repeat(not(alt(",","\n","\r"),anyChar()),"",1),quotedText:seq1(1,'"',repeat(alt(sym("escapedQuote"),not('"',anyChar()))),'"'),escapedQuote:'""'}},actions:{unquotedText:function(a){return a.join("")},quotedText:function(a){return a.join("")},escapedQuote:function(){return'"'}}}],methods:[function fromCSV(cls,s,sink){var propMap=cls.getAxiomsByClass(foam.core.Property).reduce((map,p)=>{p.fromCSVLabelMapping(map,p);return map},{});var ps=this.StringPStream.create();ps.setString(s);ps=ps.apply(this.csvRow.getSymbol("START"),this.csvRow);var headers=ps.value;headers.forEach(h=>{if(!propMap[h.trim()]){console.warn("Unknown label",h,"for class",cls.id)}});while(ps.tail.valid){ps=ps.tail.apply(this.csvRow.getSymbol("START"),this.csvRow);var obj=cls.create();ps.value.forEach((v,i)=>{var prop=propMap[headers[i]];prop&&prop.set(obj,v)});sink.put(obj)}}]});
foam.CLASS({package:"foam.lib.csv",name:"PropertyFromCSV",refines:"foam.core.Property",properties:[{class:"Function",name:"fromCSVLabelMapping",value:function(map,prop){map[prop.name]=prop}}]});
foam.CLASS({package:"foam.lib.csv",name:"FObjectPropertyFromCSV",refines:"foam.core.FObjectProperty",properties:[{class:"Function",name:"fromCSVLabelMapping",value:function(map,prop){prop.of.getAxiomsByClass(foam.core.Property).forEach(a=>{var m={};a.fromCSVLabelMapping(m,a);Object.keys(m).forEach(k=>{map[prop.name+"."+k]={set:function(o,value){o[prop.name]=o[prop.name]||prop.of.create();m[k].set(o[prop.name],value)}}})})}}]});
foam.CLASS({package:"foam.lib.csv",name:"FObjectArrayFromCSV",refines:"foam.core.FObjectArray",properties:[{class:"Function",name:"fromCSVLabelMapping",value:function(map,prop){map[prop.name]={set:function(o,value){o[prop.name]=foam.json.parseString(value)}}}}]});
foam.CLASS({package:"foam.lib.csv",name:"ArrayFromCSV",refines:"foam.core.Array",properties:[{class:"Function",name:"fromCSVLabelMapping",value:function(map,prop){map[prop.name]={set:function(o,value){o[prop.name]=foam.json.parseString(value)}}}}]});
foam.CLASS({package:"foam.lib.csv",name:"StringArrayFromCSV",refines:"foam.core.StringArray",properties:[{class:"Function",name:"fromCSVLabelMapping",value:function(map,prop){map[prop.name]={set:function(o,value){o[prop.name]=foam.json.parseString(value)}}}}]});
foam.CLASS({package:"foam.lib.http",name:"QueryStringOutputter",requires:["foam.core.Map"],properties:[{class:"Boolean",name:"combineMaps"}],methods:[function output(obj){const parts=[];const properties=obj.cls_.getOwnAxiomsByClass(foam.core.Property);for(const prop of properties){if(this.Map.isInstance(prop)&&this.combineMaps){const map=obj[prop.name];for(const k in map){parts.push(k+"="+encodeURIComponent(""+map[k]))}continue}parts.push(prop.name+"="+encodeURIComponent(""+obj[prop.name]))}return parts.join("&")}]});
foam.CLASS({package:"foam.parse",name:"StringPStream",properties:[{name:"str",class:"Simple"},{name:"pos",class:"Simple"},{name:"head",getter:function(){return this.str[0][this.pos]}},{name:"tail",getter:function(){if(!this.instance_.tail){var ps=this.cls_.create();ps.str=this.str;ps.pos=this.pos+1;this.instance_.tail=ps}return this.instance_.tail},setter:function(value){this.instance_.tail=value}},{name:"valid",getter:function(){return this.pos<this.str[0].length}},{name:"value",setter:function(value){this.instance_.value=value},getter:function(){return this.instance_.value!==undefined?this.instance_.value:this.str[0].charAt(this.pos-1)}}],methods:[function initArgs(){},function setValue(value){if(value===undefined)value=null;var ps=this.cls_.create();ps.str=this.str;ps.pos=this.pos;ps.tail=this.tail;ps.value=value;return ps},function setString(s){if(!this.pos)this.pos=0;if(!this.str)this.str=[];this.str[0]=s},function substring(end){foam.assert(this.str===end.str&&end.pos>=this.pos,"Cannot make substring: end PStream is not a tail of this.");return this.str[0].substring(this.pos,end.pos)},function apply(p,obj){return p.parse(this,obj)},function compareTo(o){return this.pos-o.pos}]});foam.INTERFACE({package:"foam.core",name:"Validator",methods:[{name:"validate",type:"Void",args:[{name:"x",type:"foam.core.X"},{name:"obj",type:"foam.core.FObject"}]}]});
foam.CLASS({package:"foam.core",name:"ValidationException",extends:"foam.core.ClientRuntimeException",properties:[{class:"Object",of:"foam.core.PropertyInfo",name:"propertyInfo"},{class:"String",name:"propName"}],});
foam.CLASS({name:"ClientRuntimeException",package:"foam.core",extends:"foam.core.FOAMException",implements:["foam.core.ExceptionInterface"],methods:[{name:"getClientRethrowException",type:"RuntimeException",visibility:"public",}]});foam.ENUM({package:"foam.core",name:"OptionalBoolean",values:[{name:"FALSE",label:"False",ordinal:0},{name:"TRUE",label:"True",ordinal:1},{name:"UNKNOWN",label:"Unknown",ordinal:2}]});
foam.CLASS({package:"foam.parse",name:"ErrorReportingPStream",properties:[{class:"Simple",name:"delegate"},{name:"intro"},{name:"pos",value:0},{name:"limit",value:100},{name:"head",getter:function(){return this.delegate.head}},{name:"tail",getter:function(){if(!this.instance_.tail){var ps=this.cls_.create();ps.delegate=this.delegate.tail;ps.report=this.report;ps.pos=this.pos+1;ps.limit=this.limit;ps.intro=ps.pos>ps.limit?this.intro.tail:this.intro;this.instance_.tail=ps}return this.instance_.tail},setter:function(tail){this.instance_.tail=tail}},{name:"valid",getter:function(){return this.delegate.valid}},{name:"value",setter:function(value){this.delegate.value=value},getter:function(){return this.delegate.value}},{class:"Simple",name:"report"}],methods:[function init(){this.intro=this},function setValue(value){if(value===undefined)value=null;var ps=this.cls_.create();ps.pos=this.pos;ps.limit=this.limit;ps.intro=this.intro;ps.report=this.report;ps.delegate=this.delegate.setValue(value);ps.tail=this.tail;return ps},function substring(end){return this.delegate.substring(end.delegate)},function compareTo(o){return this.delegate.compareTo(o.delegate)},function getIntroString(){return this.intro.substring(this)},function apply(p,obj){var res=p.parse(this,obj);if(!res)this.report(this,p,obj);return res}]});
foam.CLASS({package:"foam.parse",name:"TrapPStream",properties:[{name:"delegate"},{name:"head",getter:function(){return this.delegate.head}},{name:"tail",getter:function(){throw"trap";return foam.parse.InvalidPStream.create()},setter:function(){}},{name:"valid",getter:function(){return this.delegate.valid}},{name:"value",getter:function(){return this.delegate.value}}],methods:[function initArgs(){},function setValue(value){if(value===undefined)value=null;var ps=this.cls_.create();ps.delegate=this.delegate.setValue(value);ps.report=this.report;return ps},function substring(end){return null},function apply(p,obj){return p.parse(this,obj)},function compareTo(other){return this.delegate.compareTo(other.delegate)}]});
foam.CLASS({package:"foam.parse",name:"InvalidPStream",properties:[{name:"head",getter:function(){return undefined},setter:function(){}},{name:"tail",getter:function(){return this},setter:function(){}},{name:"value",setter:function(v){this.instance_.value=v},getter:function(){return this.instance_.value}},{name:"valid",getter:function(){return false}}],methods:[function initArgs(){},function setValue(value){if(value===undefined)value=null;var ps=this.cls_.create();ps.value=value;return ps},function substring(end){return null},function apply(p,obj){return undefined}]});
foam.CLASS({package:"foam.parse",name:"ParserArray",extends:"FObjectArray",properties:[["of","foam.lib.parse.Parser"],["adapt",function(_,a){if(!a)return[];var b=new Array(a.length);for(var i=0;i<a.length;i++){b[i]=typeof a[i]==="string"?foam.parse.Literal.create({s:a[i]}):a[i]}return b}]]});
foam.CLASS({package:"foam.parse",name:"ParserProperty",extends:"Property",properties:[{name:"adapt",value:function(_,v){return typeof v==="string"?foam.parse.Literal.create({s:v}):v}}]});
foam.CLASS({package:"foam.parse",name:"ParserDecorator",properties:[{name:"p",class:"foam.parse.ParserProperty",final:true}],methods:[function toString(){return this.p.toString()}]});
foam.CLASS({package:"foam.parse",name:"Literal",properties:[{name:"s",final:true},{name:"value",final:true}],methods:[function parse(ps){var str=this.s;for(var i=0;i<str.length;i++,ps=ps.tail){if(str.charAt(i)!==ps.head){return undefined}}return ps.setValue(this.value!==undefined?this.value:str)},function toString(){return'"'+this.s+'"'}]});
foam.CLASS({package:"foam.parse",name:"LiteralIC",properties:[{name:"s",final:true,postSet:function(old,nu){this.lower=nu.toLowerCase()}},{name:"lower",final:true},{name:"value",final:true}],methods:[function parse(ps){var str=this.lower;for(var i=0;i<str.length;i++,ps=ps.tail){if(!ps.head||str.charAt(i)!==ps.head.toLowerCase()){return undefined}}return ps.setValue(this.value!==undefined?this.value:this.s)},function toString(){return'ignoreCase("'+this.lower+'")'}]});
foam.CLASS({package:"foam.parse",name:"EOF",axioms:[foam.pattern.Singleton.create()],methods:[function parse(ps){return ps.valid?undefined:ps},function toString(){return"eof()"}]});
foam.CLASS({package:"foam.parse",name:"Alternate",properties:[{name:"args",final:true,class:"foam.parse.ParserArray"}],methods:[function parse(ps,obj){var args=this.args;for(var i=0,p;p=args[i];i++){var ret=ps.apply(p,obj);if(ret)return ret}return undefined},function toString(){var args=this.args;var strs=new Array(args.length);for(var i=0;i<args.length;i++){strs[i]=args[i].toString()}return"alt("+strs.join(", ")+")"}]});
foam.CLASS({package:"foam.parse",name:"Sequence",properties:[{name:"args",final:true,class:"foam.parse.ParserArray"}],methods:[function parse(ps,obj){var ret=[];var args=this.args;for(var i=0,p;p=args[i];i++){if(!(ps=ps.apply(p,obj)))return undefined;ret.push(ps.value)}return ps.setValue(ret)},function toString(){var args=this.args;var strs=new Array(args.length);for(var i=0;i<args.length;i++){strs[i]=args[i].toString()}return"seq("+strs.join(", ")+")"}]});
foam.CLASS({package:"foam.parse",name:"String",extends:"foam.parse.ParserDecorator",methods:[function parse(ps,obj){ps=ps.apply(this.p,obj);return ps?ps.setValue(ps.value.join("")):undefined},function toString(){return"str("+this.SUPER()+")"}]});
foam.CLASS({package:"foam.parse",name:"Substring",extends:"foam.parse.ParserDecorator",methods:[function parse(ps,obj){var start=ps;ps=ps.apply(this.p,obj);return ps?ps.setValue(start.substring(ps)):undefined},function toString(){return"str("+this.SUPER()+")"}]});
foam.CLASS({package:"foam.parse",name:"Sequence0",properties:[{name:"args",final:true,class:"foam.parse.ParserArray"}],methods:[function parse(ps,obj){var args=this.args;for(var i=0,p;p=args[i];i++){if(!(ps=ps.apply(p,obj)))return undefined}return ps},function toString(){var args=this.args;var strs=new Array(args.length);for(var i=0;i<args.length;i++){strs[i]=args[i].toString()}return"seq0("+strs.join(", ")+")"}]});
foam.CLASS({package:"foam.parse",name:"Sequence1",properties:[{name:"args",final:true,class:"foam.parse.ParserArray"},{name:"n",final:true}],methods:[function parse(ps,obj){var ret;var args=this.args;var n=this.n;for(var i=0,p;p=args[i];i++){if(!(ps=ps.apply(p,obj)))return undefined;if(i===n)ret=ps.value}return ps.setValue(ret)},function toString(){var args=this.args;var strs=new Array(args.length);for(var i=0;i<args.length;i++){strs[i]=args[i].toString()}return"seq1("+this.n+", "+strs.join(", ")+")"}]});
foam.CLASS({package:"foam.parse",name:"Optional",extends:"foam.parse.ParserDecorator",properties:[{name:"default",value:null}],methods:[function parse(ps,obj){return ps.apply(this.p,obj)||ps.setValue(this.default)},function toString(){return"opt("+this.SUPER()+")"}]});
foam.CLASS({package:"foam.parse",name:"AnyChar",axioms:[foam.pattern.Singleton.create()],methods:[function parse(ps){return ps.head?ps.tail:undefined},function toString(){return"anyChar()"}]});
foam.CLASS({package:"foam.parse",name:"NotChars",properties:[{name:"string",final:true}],methods:[function parse(ps){return ps.head&&this.string.indexOf(ps.head)===-1?ps.tail:undefined},function toString(){var str=this.string;var chars=new Array(str.length);for(var i=0;i<str.length;i++){chars[i]=str.charAt(i)}return'notChars("'+chars.join('", "')+'")'}]});
foam.CLASS({package:"foam.parse",name:"Chars",properties:[{name:"string",final:true}],methods:[function parse(ps){return ps.valid&&this.string.indexOf(ps.head)!==-1?ps.tail:undefined},function toString(){var str=this.string;var chars=new Array(str.length);for(var i=0;i<str.length;i++){chars[i]=str.charAt(i)}return'chars("'+chars.join('", "')+'")'}]});
foam.CLASS({package:"foam.parse",name:"Range",properties:[{name:"from",final:true},{name:"to",final:true}],methods:[function parse(ps){if(!ps.head)return undefined;return this.from<=ps.head&&ps.head<=this.to?ps.tail.setValue(ps.head):undefined},function toString(){return'range("'+this.from+'", "'+this.to+'")'}]});
foam.CLASS({package:"foam.parse",name:"Repeat",extends:"foam.parse.ParserDecorator",properties:[{class:"foam.parse.ParserProperty",name:"delimiter"},{class:"Int",name:"minimum"}],methods:[function parse(ps,obj){var ret=[];var p=this.p;var delim=this.delimiter;while(ps.valid){var res;if(delim&&ret.length!=0){if(!(res=ps.apply(delim,obj)))break}else{res=ps}if(!(res=res.apply(p,obj)))break;ret.push(res.value);ps=res}if(this.minimum>0&&ret.length<this.minimum)return undefined;return ps.setValue(ret)},function toString(){var str="repeat("+this.SUPER();if(this.delimiter)str+=", "+this.delimiter;if(this.minimum)str+=", "+this.minimum;str+=")";return str}]});
foam.CLASS({package:"foam.parse",name:"Until",extends:"foam.parse.ParserDecorator",methods:[function parse(ps,obj){var ret=[];var p=this.p;while(true){var res;if(res=ps.apply(p,obj)){return res.setValue(ret)}ret.push(ps.head);ps=ps.tail}return undefined},function toString(){return"until("+this.SUPER()+")"}]});
foam.CLASS({package:"foam.parse",name:"Join",extends:"foam.parse.ParserDecorator",methods:[function parse(ps,obj){ps=ps.apply(this.p,obj);return ps?ps.setValue(ps.value.join("")):undefined},function toString(){return"join("+this.SUPER()+")"}]});
foam.CLASS({package:"foam.parse",name:"Plus",extends:"foam.parse.Repeat",properties:[["minimum",1]],methods:[function toString(){var str="plus("+this.p.toString();if(this.delimiter)str+=", "+this.delimiter;str+=")";return str}]});
foam.CLASS({package:"foam.parse",name:"Repeat0",extends:"foam.parse.Repeat",methods:[function parse(ps,obj){var p=this.p;var last;var delim=this.delimiter;var i=0;while(ps){last=ps;ps=ps.apply(p,obj);if(ps)i++;if(delim&&ps){ps=ps.apply(delim,obj)||ps}}if(this.minimum>0&&i<this.minimum)return undefined;return last},function toString(){var str="repeat0("+this.p.toString();if(this.delimiter)str+=", "+this.delimiter;if(this.minimum)str+=", "+this.minimum;str+=")";return str}]});
foam.CLASS({package:"foam.parse",name:"Not",extends:"foam.parse.ParserDecorator",properties:[{name:"else",final:true,class:"foam.parse.ParserProperty"}],methods:[function parse(ps,obj){return ps.apply(this.p,obj)?undefined:this.else?ps.apply(this.else,obj):ps},function toString(){var str="not("+this.SUPER();if(this.else)str+=", "+this.else.toString();str+=")";return str}]});
foam.CLASS({package:"foam.parse",name:"ParserWithAction",extends:"foam.parse.ParserDecorator",constants:[{type:"Object",name:"NO_PARSE",factory:function(){return{}}}],properties:["action"],methods:[function parse(ps,obj){ps=ps.apply(this.p,obj);if(!!!ps)return undefined;var ret=this.action(ps.value);return ret===foam.parse.ParserWithAction.NO_PARSE?undefined:ps.setValue(ret)}]});
foam.CLASS({package:"foam.parse",name:"Symbol",properties:[{name:"name",final:true}],methods:[function parse(ps,grammar){var p=grammar.getSymbol(this.name);if(!p){console.error("No symbol found for",this.name);return undefined}return ps.apply(p,grammar)},function toString(){return'sym("'+this.name+'")'}]});
foam.CLASS({package:"foam.parse",name:"Parsers",requires:["foam.parse.Alternate","foam.parse.AnyChar","foam.parse.Chars","foam.parse.Literal","foam.parse.LiteralIC","foam.parse.EOF","foam.parse.Not","foam.parse.NotChars","foam.parse.Optional","foam.parse.Plus","foam.parse.Range","foam.parse.Repeat","foam.parse.Repeat0","foam.parse.Sequence","foam.parse.Sequence0","foam.parse.Sequence1","foam.parse.String","foam.parse.Substring","foam.parse.Symbol","foam.parse.Until","foam.parse.Join"],axioms:[foam.pattern.Singleton.create()],methods:[function seq(){return this.Sequence.create({args:Array.from(arguments)})},function repeat0(p,delim,min){return this.Repeat0.create({p:p,minimum:min||0,delimiter:delim})},function simpleAlt(){return this.Alternate.create({args:Array.from(arguments)})},function alt(){return this.Alternate.create({args:Array.from(arguments)})},function sym(name){return this.Symbol.create({name:name})},function seq1(n){return this.Sequence1.create({n:n,args:Array.from(arguments).slice(1)})},function seq0(){return this.Sequence0.create({args:Array.from(arguments)})},function repeat(p,delim,min){return this.Repeat.create({p:p,minimum:min||0,delimiter:delim})},function until(p){return this.Until.create({p:p})},function join(p){return this.Join.create({p:p})},function plus(p,delim){return this.Plus.create({p:p,delimiter:delim})},function str(p){return this.String.create({p:p})},function substring(p){return this.Substring.create({p:p})},function range(a,b){return this.Range.create({from:a,to:b})},function notChars(s){return this.NotChars.create({string:s})},function chars(s){return this.Chars.create({string:s})},function not(p,opt_else){return this.Not.create({p:p,else:opt_else})},function optional(p,opt_default){return this.Optional.create({p:p,default:opt_default||null})},function literal(s,value){return this.Literal.create({s:s,value:value})},function literalIC(s,value){return this.LiteralIC.create({s:s,value:value})},function eof(){return this.EOF.create()},function anyChar(){return this.AnyChar.create()}]});
foam.CLASS({package:"foam.parse",name:"PSymbol",properties:["name","parser"]});
foam.CLASS({package:"foam.parse",name:"Grammar",requires:["foam.parse.StringPStream","foam.parse.ParserWithAction","foam.parse.Parsers"],properties:[{class:"FObjectArray",of:"foam.parse.PSymbol",name:"symbols",adapt:function(_,o){if(Array.isArray(o))return o;if(typeof o==="function"){var args=o.toString().match(/\((.*?)\)/);if(!args){throw"Could not parse arguments from parser factory function"}o=foam.Function.withArgs(o,this.Parsers.create(),this)}var a=[];for(var key in o){a.push(foam.parse.PSymbol.create({name:key,parser:o[key]}))}return a}},{name:"symbolMap_",expression:function(symbols){var m={};for(var i=0;i<symbols.length;i++){if(m[symbols[i].name]){console.error("Duplicate symbol found",symbols[i].name)}m[symbols[i].name]=symbols[i]}return m}},{name:"ps",factory:function(){return this.StringPStream.create()}},{name:"lastStart"}],methods:[function parseString(str,opt_name){opt_name=opt_name||"START";this.ps.setString(str);var start=this.getSymbol(opt_name);foam.assert(start,"No symbol found for",opt_name);this.lastStart=start;var result=this.ps.apply(start,this);return result&&result.value},function getLastError(){var errorPs=foam.parse.ErrorReportingPStream.create();errorPs.delegate=this.ps;var lastError;function report(ps,p,obj){if(!lastError)lastError=[ps,p,obj];else if(ps.compareTo(lastError[0])>0)lastError=[ps,p,obj]}errorPs.report=report;var result=errorPs.apply(this.lastStart,this);if(!lastError)return"No error.";var validChars=[];var trap=foam.parse.TrapPStream.create();var ps=foam.parse.StringPStream.create();for(var i=0;i<=255;i++){var str=String.fromCodePoint(i);ps.setString(str);trap.delegate=ps;try{trap.apply(lastError[1],lastError[2])}catch(e){if(e==="trap")validChars.push(str);else throw e}}function toPrintable(s){var ret="";for(var i=0;i<s.length;i++){var code=s.codePointAt(i);if(code<32)ret+="\\u"+code.toString(16);else ret+=s[i]}return ret}return"Unexpected character '"+lastError[0].head+"' at index: "+lastError[0].pos+", Expected one of: ["+toPrintable(validChars.join(","))+"], Text leading up to this was: "+lastError[0].getIntroString()},function getSymbol(name){foam.assert(this.symbolMap_[name],"No symbol found for '",name,"'");return this.symbolMap_[name].parser},function addSymbol(name,parser){this.symbols.push(foam.parse.PSymbol.create({name:name,parser:parser}))},function addActions(map){for(var key in map){this.addAction(key,map[key])}return this},function addAction(name,action){for(var i=0;i<this.symbols.length;i++){if(this.symbols[i].name===name){this.symbols[i].parser=this.ParserWithAction.create({p:this.symbols[i].parser,action:action})}}this.pub("propertyChange","symbols",this.slot("symbols"));return this}]});
foam.CLASS({package:"foam.parse",name:"GrammarAxiom",properties:[{class:"String",name:"name"},{class:"String",name:"language",value:"foam.parse.Parsers"},{name:"symbols"},{class:"Array",name:"actions",adapt:function(_,v){if(foam.Array.isInstance(v))return v;if(foam.Object.isInstance(v)){var a=[];for(var key in v){a.push({name:key,code:v[key]})}v=a}return v}},{class:"Boolean",name:"withArgs"}],methods:[function installInProto(proto){var name=this.name;var axiom=this;Object.defineProperty(proto,name,{get:function(){var g=this.getPrivate_(name);if(!g){this.setPrivate_(name,g=axiom.buildGrammar(this))}return this.getPrivate_(name)}})},function buildGrammar(obj){var g=foam.lookup("foam.parse.Grammar").create(null,obj);var symbols;if(typeof this.symbols=="function"){var language=foam.lookup(this.language).create();if(this.withArgs){symbols=foam.Function.withArgs(this.symbols,language)}else{with(foam.lookup(this.language).create()){symbols=eval("("+this.symbols.toString()+")()")}}}else{symbols=this.symbols}for(var key in symbols){g.addSymbol(key,symbols[key])}for(var i=0;i<this.actions.length;i++){g.addAction(this.actions[i].name,(this.actions[i].code||this.actions[i]).bind(obj))}return g}]});
foam.CLASS({package:"foam.parse",name:"ModelGrammarsRefinement",refines:"foam.core.Model",properties:[{class:"AxiomArray",name:"grammars",of:"foam.parse.GrammarAxiom"}]});
foam.CLASS({package:"foam.parse",name:"ImperativeGrammar",extends:"foam.parse.Grammar"});
foam.CLASS({package:"foam.parse.json",name:"String",constants:{CHAR_CODE_0:"0".charCodeAt(0),CHAR_CODE_9:"9".charCodeAt(0),CHAR_CODE_A_LOWER:"a".charCodeAt(0),CHAR_CODE_F_LOWER:"f".charCodeAt(0),CHAR_CODE_A_UPPER:"A".charCodeAt(0),CHAR_CODE_F_UPPER:"F".charCodeAt(0)},properties:[{class:"String",name:"escape",value:"\\"},{name:"escapeChars",value:{n:"\n",f:"\f",b:"\b",r:"\r",t:"\t"}}],methods:[function parse(ps,obj){var delim=ps.head;var escape=this.escape;if(delim!=='"'&&delim!=="'")return undefined;ps=ps.tail;var lastc=delim;var str="";while(ps.valid){var c=ps.head;if(c===delim&&lastc!==escape)break;if(c!==escape){str+=c}else{var next=ps.tail.head;if(next===escape){str+=escape;ps=ps.tail}else if(ps.tail.head==="u"){var hexCharCode=ps.tail.str[0].substr(ps.pos+2,4);for(var i=0;i<hexCharCode.length;i++){var hexDigitCharCode=hexCharCode.charCodeAt(i);if(!this.isHexDigitCharCode_(hexDigitCharCode))throw new Error("FON string parse error at "+ps.pos+": "+"Invalid unicode escape sequence: \\u"+hexCharCode)}var charCode=parseInt(hexCharCode,16);c=String.fromCharCode(charCode);str+=c;ps=ps.tail.tail.tail.tail.tail}else if(this.escapeChars[ps.tail.head]){c=this.escapeChars[ps.tail.head];str+=c;ps=ps.tail}}lastc=c;ps=ps.tail}return ps.tail.setValue(str)},function isHexDigitCharCode_(charCode){return charCode>=this.CHAR_CODE_0&&charCode<=this.CHAR_CODE_9||charCode>=this.CHAR_CODE_A_LOWER&&charCode<=this.CHAR_CODE_F_LOWER||charCode>=this.CHAR_CODE_A_UPPER&&charCode<=this.CHAR_CODE_F_UPPER}]});
foam.CLASS({package:"foam.parse.json",name:"Parsers",extends:"foam.parse.Parsers",methods:[function string(){return foam.parse.json.String.create()}]});
foam.CLASS({package:"foam.parsers",name:"FON",implements:["foam.json.Parser"],properties:[{name:"creationContext"}],methods:[function parseString(str){return this.parseClassFromString(str,null)},function parseClassFromString(str,opt_cls){foam.assert(this.creationContext,"No creation context assigned.");var res=this.grammar.parseString(str,"obj");if(!res)return null;return foam.json.parse(res,opt_cls,this.creationContext)}],grammars:[{name:"grammar",language:"foam.parse.json.Parsers",symbols:function(){return{obj:seq1(3,sym("ws"),"{",sym("ws"),repeat(sym("keyValue"),seq0(",",sym("ws"))),sym("ws"),"}",sym("ws")),keyValue:seq(sym("key"),sym("ws"),":",sym("ws"),sym("value"),sym("ws")),key:alt(string(),sym("identifier")),ws:repeat0(chars(" \t\r\n")),id_start:alt(range("a","z"),range("A","Z"),"_","$"),identifier:substring(seq0(sym("id_start"),repeat0(alt(range("0","9"),sym("id_start"))))),value:alt(string(),sym("null"),sym("undefined"),sym("number"),sym("bool"),sym("array"),sym("obj")),null:literal("null",null),undefined:literal("undefined",undefined),number:substring(seq0(optional("-"),repeat0(range("0","9"),null,1),optional(seq0(".",repeat0(range("0","9")))),optional(seq0("e",alt("-","+"),repeat0(range("0","9")))))),bool:alt(literal("true",true),literal("false",false)),array:seq1(2,"[",sym("ws"),repeat(sym("value"),seq0(",",sym("ws"))),sym("ws"),"]",sym("ws"))}},actions:[function obj(a){var obj={};for(var i=0;i<a.length;i++){obj[a[i][0]]=a[i][4]}return obj},function number(a){return parseFloat(a)}]}]});
foam.CLASS({package:"foam.templates",name:"TemplateOutput",properties:[{name:"buf",factory:function(){return[]}}],methods:[function output(){for(var i=0;i<arguments.length;i++){var o=arguments[i];if(typeof o==="object"){this.buf.push(o.toString())}else{this.buf.push(o)}}},function toString(){return this.buf.length==0?"":this.buf.length==1?this.buf[0]:this.buf.join("")}]});
foam.CLASS({package:"foam.templates",name:"TemplateUtil",axioms:[foam.pattern.Singleton.create()],requires:["foam.parse.ImperativeGrammar as Grammar","foam.templates.TemplateOutput"],constants:{HEADER:"var self = this, ctx = this.__context__, Y = this.__subContext__;\n"+"var output = opt_outputter ? opt_outputter : TOC(this);\n"+"var out = output.output.bind(output);\n"+"out('",FOOTER:"');\nreturn opt_outputter ? output : output.toString();\n"},properties:[{name:"jsGrammar",factory:function(){var g=this.createAbstractGrammar();var self=this;g.addActions({markup:function(v){var wasSimple=self.simple;var ret=wasSimple?null:self.out.join("");self.out=[];self.simple=true;return[wasSimple,ret]},"simple value":function(v){self.push("',\n self.",v[1].join(""),v[2],",\n'")},"raw values tag":function(v){self.push("',\n",v[1].join(""),",\n'")},"code tag":function(v){self.push("');\n",v[1].join(""),";out('")},"single quote":function(){self.push("\\'")},newline:function(){self.push("\\n")},text:function(v){self.pushSimple(v)}});return g}},{name:"javaGrammar",factory:function(){var g=this.createAbstractGrammar();var self=this;g.addActions({markup:function(v){var ret="";var wasSimple=self.simple;for(var i=0;i<self.out.length;i++){if(self.out[i].length==1&&(i==0||self.out[i-1].length>1)){ret+='builder.append("'}ret+=self.out[i];if(self.out[i].length==1&&(i==self.out.length-1||self.out[i+1].length>1))ret+='");\n'}ret=wasSimple?null:ret;self.out=[];self.simple=true;return[wasSimple,ret]},"simple value":function(v){self.push("',\n self.",v[1].join(""),v[2],",\n'")},"raw values tag":function(v){var value=v[1].join("").replace(/\s/g,"");var argExist=self.argsSet.includes(value);if(!argExist)value="get"+value.charAt(0).toUpperCase()+value.slice(1)+"()";self.push("builder.append("+value+");\n")},"code tag":function(v){self.push(v[1].join("")+"\n")},"single quote":function(){self.push("\\'")},newline:function(){self.push("\\n")},text:function(v){self.pushSimple(v)}});return g}},{name:"out",factory:function(){return[]}},{name:"simple",value:true},"argsSet"],methods:[function createAbstractGrammar(){return this.Grammar.create({symbols:function(repeat0,simpleAlt,sym,seq1,seq,repeat,notChars,anyChar,not,optional,literal){return{START:sym("markup"),markup:repeat0(simpleAlt(sym("comment"),sym("simple value"),sym("raw values tag"),sym("code tag"),sym("ignored newline"),sym("newline"),sym("single quote"),sym("text"))),comment:seq1(1,"\x3c!--",repeat0(not("--\x3e",anyChar())),"--\x3e"),"simple value":seq("%%",repeat(notChars(' ()-"\r\n><:;,')),optional("()")),"raw values tag":simpleAlt(seq("<%=",repeat(not("%>",anyChar())),"%>")),"code tag":seq("<%",repeat(not("%>",anyChar())),"%>"),"ignored newline":simpleAlt(literal("\\\r\\\n"),literal("\\\n")),newline:simpleAlt(literal("\r\n"),literal("\n")),"single quote":literal("'"),text:anyChar()}}})},function push(){this.simple=false;this.pushSimple.apply(this,arguments)},function pushSimple(){this.out.push.apply(this.out,arguments)},function compile(t,name,args){var result=this.jsGrammar.parseString(t);if(!result)throw"Error parsing template "+name;var code=this.HEADER+(result[0]?t:result[1])+this.FOOTER;var newArgs=["opt_outputter"].concat(args.map(function(a){return a.name||a}));var f=eval("(function() { "+"var TOC = function(o) { return foam.templates.TemplateOutput.create(); };"+"var f = function("+newArgs.join(",")+"){"+code+"};"+"return function() { "+"if ( arguments.length && arguments[0] && ! arguments[0].output ) return f.apply(this, [undefined].concat(Array.from(arguments)));"+"return f.apply(this, arguments);};})()");return f},function compileJava(t,name,args){this.argsSet=args.map(ar=>ar.name);var result=this.javaGrammar.parseString(t);if(!result)throw"Error parsing template "+name;var code=result[1];return code},function lazyCompile(t,name,args){return function(util){var delegate;return function(){if(!delegate)delegate=util.compile(t,name,args);return delegate.apply(this,arguments)}}(this)}]});
foam.CLASS({package:"foam.templates",name:"TemplateAxiom",extends:"Method",requires:["foam.templates.TemplateUtil"],properties:[{name:"template",class:"String"},{name:"code",required:false},"args"],methods:[function installInProto(proto){proto[this.name]=foam.templates.TemplateUtil.create().lazyCompile(this.template,this.name,this.args||[])}]});
foam.CLASS({package:"foam.templates",name:"TemplateExtension",refines:"foam.core.Model",properties:[{name:"templates",class:"AxiomArray",of:"foam.templates.TemplateAxiom",adaptArrayElement:function(o,prop){return this.__context__.lookup(prop.of).create(o)}}]});foam.SCRIPT({package:"foam.i18n",name:"LocaleScript",code:function(){foam.locale=foam.locale||"en"}});foam.LIB({name:"foam.i18n.Lib",methods:[function createText(source,text,defaultText){if(!foam.xmsg)return text;return{__proto__:text,toString:function(){return defaultText||text},toE:function(_,X){return foam.i18n.InlineLocaleEditor.create({source:source,defaultText:defaultText||text,data:text},X)}}}]});
foam.CLASS({package:"foam.i18n",name:"MessageAxiom",properties:[{class:"String",name:"name",preSet:function(o,n){return foam.String.constantize(n)}},{class:"String",name:"description"},{class:"Object",name:"messageMap",help:"Map of language codes to the message in that language.",factory:function(){return{}}},{class:"String",name:"message",getter:function(){var msg=this.message_;if(foam.Undefined.isInstance(msg)){if(foam.locale)msg=this.messageMap[foam.locale]||this.messageMap[foam.lang];msg=msg||this.messageMap.en;msg=this.message_=foam.i18n&&foam.xmsg?foam.i18n.Lib.createText(this.sourceCls_.id+"."+this.name,msg,msg):msg}return msg},setter:function(m){this.messageMap[foam.locale]=m;this.message_=undefined}},{class:"Simple",name:"message_"}],methods:[function installInClass(cls){var self=this;Object.defineProperty(cls,this.name,{get:function(){return self.message},set:function(v){self.messageMap[foam.locale]=v;self.message_=undefined},configurable:false})},function installInProto(proto){var name=this.name;Object.defineProperty(proto,this.name,{get:function(){return this.cls_[name]},configurable:false})}]});
foam.CLASS({package:"foam.i18n",name:"MessagesExtension",refines:"foam.core.Model",properties:[{name:"messages",class:"AxiomArray",of:"foam.i18n.MessageAxiom"}]});
foam.CLASS({package:"foam.core",name:"ValidationPredicate",properties:[{class:"String",name:"query"},{class:"StringArray",name:"args"},{class:"Function",name:"jsFunc",expression:function(query,jsErr){return function(obj){var predicate=foam.mlang.predicate.FScript.create({query:query,prop:this});if(!predicate.f(obj))return jsErr(obj)}}},{class:"String",name:"errorMessage",},{class:"String",name:"errorString",},{class:"Function",name:"jsErr",expression:function(errorString,errorMessage){return function(obj){if(errorMessage&&obj){if(obj[errorMessage])return obj[errorMessage];console.warn("Error finding message",errorMessage,". No such message on object.",obj)}return errorString}}}],methods:[function createErrorSlotFor(data){return data.slot(this.jsFunc,this.args)}]});
foam.CLASS({package:"foam.core",name:"PropertyValidationRefinement",refines:"foam.core.Property",messages:[{name:"PLEASE_ENTER",message:"Please enter"}],properties:[{class:"FObjectArray",of:"foam.core.ValidationPredicate",name:"validationPredicates",compare:function(){return 0}},{name:"validateObj",factory:function(prop){var name=this.name;var label=this.label;var required=this.required;var self_=this;var validationPredicates=this.validationPredicates;if(validationPredicates.length){var args=foam.Array.unique(validationPredicates.map(vp=>vp.args).flat());return[args,function(){for(var i=0;i<validationPredicates.length;i++){var vp=validationPredicates[i];var self=this;if(vp.jsFunc.call(self_,this))return vp.jsErr.call(self,self)}return null}]}return!required?null:[[name],function(){const axiom=this.cls_.getAxiomByName(name);return axiom.isDefaultValue(this[name])&&`${this.PLEASE_ENTER} ${label.toLowerCase()}`}]}}]});
foam.CLASS({package:"foam.core",name:"StringPropertyValidationRefinement",refines:"foam.core.String",messages:[{name:"REQUIRED",message:"required"},{name:"SHOULD_BE_LEAST",message:"should be at least"},{name:"SHOULD_BE_MOST",message:"should be at most"},{name:"CHARACTER",message:"character"}],properties:["minLength","maxLength",{class:"FObjectArray",of:"foam.core.ValidationPredicate",name:"validationPredicates",factory:function(){var self=this;var a=[];if(foam.Number.isInstance(this.minLength)){a.push({args:[this.name],query:"thisValue.len>="+self.minLength,errorString:`${this.label} ${foam.core.String.SHOULD_BE_LEAST} ${this.minLength} ${foam.core.String.CHARACTER}${this.minLength>1?"s":""}`})}if(foam.Number.isInstance(this.maxLength)){a.push({args:[this.name],query:this.name+".len<="+self.maxLength,errorString:`${this.label} ${foam.core.String.SHOULD_BE_MOST} ${this.maxLength} ${foam.core.String.CHARACTER}${this.maxLength>1?"s":""}`})}if(this.required&&!foam.Number.isInstance(this.minLength)){a.push({args:[this.name],query:this.name+".len!=0",errorString:foam.core.String.REQUIRED})}return a}}]});
foam.CLASS({package:"foam.core",name:"FObjectPropertyValidationRefinement",refines:"foam.core.FObjectProperty",messages:[{name:"PLEASE_ENTER_VALID",message:"Please enter valid"}],properties:[{class:"Boolean",name:"autoValidate"},{name:"validateObj",expression:function(name,label,required,validationPredicates,autoValidate){if(autoValidate){var self=this;return[[`${name}$errors_`],function(errs){return errs?`${self.PLEASE_ENTER_VALID} ${(label||name).toLowerCase()}`:null}]}return foam.core.Property.VALIDATE_OBJ.factory.apply(this,this.VALIDATE_OBJ)}}]});
foam.CLASS({package:"foam.core",name:"FObjectArrayValidationRefinement",refines:"foam.core.FObjectArray",messages:[{name:"PLEASE_ENTER_VALID",message:"Please enter valid"}],properties:[{class:"Boolean",name:"autoValidate",},{name:"validateObj",expression:function(name,label,required,validationPredicates,autoValidate){if(autoValidate){var self=this;return[[`${name}$errors`],function(errs){return errs?`${self.PLEASE_ENTER_VALID} ${(label||name).toLowerCase()}`:null}]}return foam.core.Property.VALIDATE_OBJ.factory.apply(this,this.VALIDATE_OBJ)}}]});
foam.CLASS({package:"foam.core",name:"IntPropertyValidationRefinement",refines:"foam.core.Int",properties:[{class:"Boolean",name:"autoValidate"},{name:"validationPredicates",factory:function(){if(!this.autoValidate)return[];var self=this;var a=[];if(foam.Number.isInstance(self.min)){a.push({args:[self.name],query:self.name+">="+self.min,errorString:`Please enter ${self.label.toLowerCase()} greater than or equal to ${self.min}.`})}if(foam.Number.isInstance(self.max)){a.push({args:[self.name],query:self.name+"<="+self.max,errorString:`Please enter ${self.label.toLowerCase()} less than or equal to ${self.max}`})}return a}}]});
foam.CLASS({package:"foam.core.internal",name:"Errors",properties:[["name","errors_"]],methods:[function installInProto(proto){var self=this;Object.defineProperty(proto,"errors_",{get:function(){return self.toSlot(this).get()},configurable:true,enumerable:false});Object.defineProperty(proto,"errors_$",{get:function(){return self.toSlot(this)},configurable:true,enumerable:false})},function toSlot(obj){var slotName=this.slotName_||(this.slotName_=this.name+"$");var slot=obj.getPrivate_(slotName);if(!slot){slot=this.createErrorSlot_(obj);obj.setPrivate_(slotName,slot)}return slot},function createErrorSlot_(obj){var args=[];var ps=obj.cls_.getAxiomsByClass(foam.core.Property).filter(function(a){return a.validateObj});for(var i=0;i<ps.length;i++){var p=ps[i];args.push(obj.slot(p.validateObj))}function validateObject(){var ret;for(var i=0;i<ps.length;i++){var p=ps[i];var err=args[i].get();if(err)(ret||(ret=[])).push([p,err])}return ret}return foam.core.ExpressionSlot.create({obj:obj,code:validateObject,args:args})}]});
foam.CLASS({package:"foam.core",name:"ValidationFObjectRefinement",refines:"foam.core.FObject",axioms:[foam.core.internal.Errors.create()]});
foam.CLASS({package:"foam.core",name:"EmailPropertyValidationRefinement",refines:"foam.core.EMail",messages:[{name:"EMAIL_REQUIRED",message:"Email address required"},{name:"VALID_EMAIL_REQUIRED",message:"Valid email address required"}],properties:[{class:"FObjectArray",of:"foam.core.ValidationPredicate",name:"validationPredicates",factory:function(){var self=this;var ret=[];if(this.required){ret.push({args:[this.name],query:this.name+'!=""',errorString:this.EMAIL_REQUIRED})}ret.push({args:[this.name],query:this.name+'==""||'+this.name+"~/\\S+@\\S+\\.\\S+/",errorString:this.VALID_EMAIL_REQUIRED});return ret}}]});
foam.CLASS({package:"foam.core",name:"PhoneNumberPropertyValidationRefinement",refines:"foam.core.PhoneNumber",messages:[{name:"PHONE_NUMBER_REQUIRED",message:"Phone number required"},{name:"INVALID_PHONE_NUMBER",message:"Valid phone number required"}],properties:[{class:"FObjectArray",of:"foam.core.ValidationPredicate",name:"validationPredicates",factory:function(){var self=this;return this.required?[{args:[this.name],query:this.name+" exists",errorString:this.PHONE_NUMBER_REQUIRED},{args:[this.name],query:this.name+"~"+foam.nanos.auth.Phone.PHONE_NUMBER_REGEX,errorString:this.INVALID_PHONE_NUMBER}]:[{args:[this.name],query:this.name+" !exists||"+this.name+"~"+foam.nanos.auth.Phone.PHONE_NUMBER_REGEX,errorString:this.INVALID_PHONE_NUMBER}]}}]});
foam.CLASS({package:"foam.core",name:"DatePropertyValidationRefinement",refines:"foam.core.Date",properties:[{class:"FObjectArray",of:"foam.core.ValidationPredicate",name:"validationPredicates",factory:function(){var self=this;return[{args:[self.name],query:"thisValue !exists||thisValue<="+foam.Date.MAX_DATE.toISOString().slice(1,16)+"&&thisValue>="+foam.Date.MIN_DATE.toISOString().slice(0,16),errorString:"Invalid date value"}]}}]});
foam.CLASS({package:"foam.core",name:"URLValidationRefinement",refines:"foam.core.URL",messages:[{name:"INVALID_URL",message:"Invalid URL"}],properties:[{class:"FObjectArray",of:"foam.core.ValidationPredicate",name:"validationPredicates",factory:function(){var self=this;var urlRegex=/((([A-Za-z]{3,9}:(?:\/\/)?)(?:[\-;:&=\+\$,\w]+@)?[A-Za-z0-9\.\-]+|(?:www\.|[\-;:&=\+\$,\w]+@)[A-Za-z0-9\.\-]+)((?:\/[\+~%\/\.\w\-_]*)?\??(?:[\-\+=&;%@\.\w_]*)#?(?:[\.\!\/\\\w]*))?)/;return[{args:[this.name],query:'thisValue==""||thisValue~'+urlRegex,errorString:this.INVALID_URL}]}}]});
foam.CLASS({package:"foam.core",name:"WebsiteValidationRefinement",refines:"foam.core.Website",messages:[{name:"INVALID_Website",message:"Invalid Website"}],properties:[{class:"FObjectArray",of:"foam.core.ValidationPredicate",name:"validationPredicates",factory:function(){var self=this;var websiteRegex=/(https?:\/\/(?:www\.|(?!www))[a-zA-Z0-9][a-zA-Z0-9-]+[a-zA-Z0-9]\.[^\s]{2,}|www\.[a-zA-Z0-9][a-zA-Z0-9-]+[a-zA-Z0-9]\.[^\s]{2,}|https?:\/\/(?:www\.|(?!www))[a-zA-Z0-9]\.[^\s]{2,}|www\.[a-zA-Z0-9]\.[^\s]{2,})/;return[{args:[this.name],query:'thisValue==""||thisValue~'+websiteRegex,errorString:this.INVALID_WEBSITE}]}}]});
foam.CLASS({package:"foam.core",name:"Action",requires:["foam.core.ConstantSlot","foam.core.ExpressionSlot","foam.core.PromiseSlot"],properties:[{class:"String",generateJava:false,name:"name",required:true},{class:"String",generateJava:false,name:"documentation"},{class:"String",generateJava:false,name:"buttonStyle"},{class:"String",generateJava:false,name:"label",expression:function(name){return foam.String.labelize(name)}},{class:"String",generateJava:false,name:"ariaLabel",expression:function(name){return this.label||foam.String.labelize(name)}},{generateJava:false,class:"String",name:"toolTip"},{name:"icon",generateJava:false},{class:"Function",generateJava:false,name:"confirmationRequired",value:null},{class:"String",generateJava:false,name:"iconFontFamily",value:"Material Icons"},{class:"String",generateJava:false,name:"iconFontClass",value:"material-icons"},{class:"String",generateJava:false,name:"iconFontName"},{class:"Array",generateJava:false,name:"keyboardShortcuts"},{class:"String",generateJava:false,name:"help"},{class:"Boolean",generateJava:false,name:"isDefault",help:"Indicates if this is the default action.",value:false},{class:"Function",generateJava:false,name:"isAvailable",label:"Available",help:"Function to determine if action is available.",value:null},{class:"Function",generateJava:false,name:"isEnabled",label:"Enabled",help:"Function to determine if action is enabled.",value:null},{class:"Function",name:"code",required:true,value:null},{class:"Function",generateJava:false,name:"confirmationView",value:null},{class:"StringArray",generateJava:false,name:"availablePermissions",},{class:"StringArray",generateJava:false,name:"enabledPermissions",},{class:"StringArray",generateJava:false,name:"confirmationRequiredPermissions",},{name:"enabledPermissionsSlot_",generateJava:false,transient:true},{name:"availablePermissionsSlot_",generateJava:false,transient:true},{name:"confirmationRequiredPermissionsSlot_",generateJava:false,transient:true},{name:"runningMap",generateJava:false,factory:function(){return new WeakMap},cloneProperty:function(){return new WeakMap},hidden:true,transient:true,},{class:"String",name:"mementoName",generateJava:false,value:""}],methods:[function addPermissionsCheck_(x,slot,data,permissionsName){var permissions=this[permissionsName+"Permissions"];if(!x.auth||!permissions.length)return slot;var pName=permissionsName+"PermissionsSlot_";if(!this[pName]){this[pName]=foam.core.PromiseSlot.create({promise:Promise.all(permissions.map(p=>x.auth.check(null,p))).then(function(perms){return perms.every(p=>p)})})}return foam.core.ExpressionSlot.create({args:[this[pName],slot],code:function(a,b){return a&&b}})},function createSlotFor_(x,data,expression,permissionsName){if(foam.core.Slot.isInstance(data)){console.warn("Action createIsEnabled$ and createIsAvailable$ does not support data as a slot.");data=data.get()}var slot=expression?data.slot(expression):foam.core.ConstantSlot.create({value:true});return this.addPermissionsCheck_(x,slot,data,permissionsName)},function createIsEnabled$(x,data){var running=this.getRunning$(data);var slot=this.createSlotFor_(x,data,this.isEnabled,"enabled");return foam.core.ExpressionSlot.create({args:[running,slot],code:function(a,b){return!a&&b}})},function createIsAvailable$(x,data){return this.createSlotFor_(x,data,this.isAvailable,"available")},function createConfirmationRequired$(x,data){return this.createSlotFor_(x,data,this.confirmationRequired,"confirmationRequired")},function getRunning$(data){var running=this.runningMap.get(data);if(!running){running=foam.core.SimpleSlot.create({value:false});if(data)this.runningMap.set(data,running)}return running},function maybeCall(x,data){var self=this;function call(){var running=self.getRunning$(data);if(running.get()){x.warn("Attempted to call action that is in progress.");return}var ret=self.code.call(data,x,self);if(ret&&ret.then){running.set(true);ret.then(function(){running.set(false)},function(){running.set(false)})}data&&data.pub&&data.pub("action",self.name,self);return ret}if(this.isAvailable&&!foam.Function.withArgs(this.isAvailable,data)||this.isEnabled&&!foam.Function.withArgs(this.isEnabled,data))return;if(!x.auth||!(this.availablePermissions.length||this.enabledPermissions.length)){call();return}var permissions=this.availablePermissions.concat(this.enabledPermissions);permissions=foam.Array.unique(permissions);Promise.all(permissions.map(p=>x.auth.check(null,p))).then(function(args){if(args.every(b=>b))call()})},function installInClass(c){c.installConstant(this.name,this)},function installInProto(proto){var action=this;proto[this.name]=function(){action.maybeCall(this.__context__,this)}}]});
foam.CLASS({refines:"foam.core.Model",package:"foam.core",name:"ModelActionRefine",properties:[{class:"AxiomArray",of:"Action",name:"actions",generateJava:false,adaptArrayElement:function(o,prop){return typeof o==="function"?foam.core.Action.create({name:o.name,code:o}):this.__context__.lookup(prop.of).create(o)}}]});
foam.CLASS({package:"foam.core",name:"Static",extends:"foam.core.AbstractMethod",methods:[function isStatic(){return true},function installInClass(cls){Object.defineProperty(cls,this.name,{value:this.code,configurable:false})},function installInProto(proto){this.installInClass(proto)}]});
foam.CLASS({package:"foam.core",name:"ModelStaticRefinement",refines:"foam.core.Model",properties:[{class:"AxiomArray",of:"Static",name:"static",adaptArrayElement:function(o){if(typeof o==="function"){var name=foam.Function.getName(o);foam.assert(name,"Static must be named");return foam.core.Static.create({name:name,code:o})}return foam.core.Static.isInstance(o)?o:foam.core.Static.create(o)}}]});
foam.CLASS({package:"foam.core",name:"Reaction",properties:[{name:"name",expression:function(target,topic,listener){return"reaction_"+target+"$$"+topic+"$$"+listener}},{class:"String",name:"target"},{class:"StringArray",name:"topic"},{name:"listener"}],methods:[function initObject(obj){var listener=obj[this.listener];var topic=this.topic;if(this.target===""){obj.onDetach(obj.sub.apply(obj,this.topic.concat(listener)));return}var path=this.target.split(".");var slot=obj;for(var i=0;i<path.length;i++){slot=slot.dot(path[i])}if(topic.length){var l=listener;var prevSub;var args=topic.concat(l);listener=function(){prevSub&&prevSub.detach();var target=slot.get();if(target&&foam.core.FObject.isInstance(target)){obj.onDetach(prevSub=target.sub.apply(target,args))}};listener()}obj.onDetach(slot.sub(listener))}]});
foam.CLASS({package:"foam.core",name:"ModelReactionsRefinement",refines:"foam.core.Model",properties:[{class:"AxiomArray",name:"reactions",of:"foam.core.Reaction",adaptArrayElement:function(e,prop){return foam.Array.isInstance(e)?foam.core.Reaction.create({target:e[0],topic:e[1]?e[1].split("."):[],listener:e[2]}):e.class?this.__context__.lookup(e.class).create(e,this):this.__context__.lookup(prop.of).create(e,this)}}]});foam.INTERFACE({package:"foam.core",name:"Serializable",});foam.INTERFACE({package:"foam.core",name:"Freezable",methods:[{name:"beforeFreeze",async:true,type:"Void"},{name:"freeze",async:true,type:"FObject"},{name:"isFrozen",async:true,type:"Boolean"}]});foam.INTERFACE({package:"foam.core",name:"Detachable",methods:[{name:"detach",type:"Void",async:true}]});foam.INTERFACE({package:"foam.core",name:"ContextAgent",methods:[{name:"execute",type:"Void",args:[{name:"x",type:"Context"}]}]});
foam.CLASS({package:"foam.core",name:"CompoundContextAgency",extends:"foam.core.AbstractAgency",properties:[{name:"agents",class:"List",}],methods:[{name:"execute",args:[{name:"x",type:"X"}],},{name:"submit",args:[{name:"x",type:"X"},{name:"agent",type:"ContextAgent"},{name:"description",type:"String"}],},{name:"toString",type:"String",},{name:"describeAgents",type:"String[]",}],});foam.INTERFACE({package:"foam.core",name:"Validatable",methods:[{name:"validate",args:[{name:"x",type:"Context"}],javaThrows:["IllegalStateException"]}]});
foam.CLASS({package:"foam.core",name:"AxiomCloner",properties:[{class:"Class",name:"from"},{class:"String",name:"axiom"},{class:"String",name:"name",transient:true,expression:function(axiom){return axiom+"_cloner"}},{class:"Map",name:"config"}],methods:[function installInClass(cls){var axiom=this.from.getAxiomByName(this.axiom);if(!axiom){throw`Cannot find ${this.axiom} on ${this.from.id}`}axiom=axiom.clone().copyFrom(this.config);cls.installAxiom(axiom)}]});foam.LIB({name:"foam",methods:[function axiomCloner(from,axiom,config){return{class:"foam.core.AxiomCloner",from:from,axiom:axiom,config:config}}]});
foam.CLASS({package:"foam.u2",name:"ModalOverlay",extends:"foam.u2.Element",imports:["document"],exports:["as overlay"],properties:["innerE",{name:"redirectToInner_",value:true},{class:"Array",name:"innerQueue_"}],methods:[function render(){this.redirectToInner_=false;var container=this.addClass().start().addClass(this.myClass("container"));container.start().addClass(this.myClass("background")).on("click",this.close.bind(this)).end();this.innerE=container.start().addClass(this.myClass("inner"));for(var i=0;i<this.innerQueue_.length;i++){this.innerE.add.apply(this.innerE,this.innerQueue_[i])}this.innerE.end();this.redirectToInner_=true},function add(){if(this.redirectToInner_){if(this.innerE)this.innerE.add.apply(this.innerE,arguments);else this.innerQueue_.push(Array.prototype.slice.call(arguments));return this}return this.SUPER.apply(this,arguments)},function open(){this.document.body.insertAdjacentHTML("beforeend",this.outerHTML);this.load()},function close(){this.remove()}],css:`
^ {
align-items: center;
bottom: 0;
display: flex;
justify-content: space-around;
left: 0;
position: fixed;
right: 0;
top: 0;
z-index: 1000;
}
^container {
align-items: center;
display: flex;
height: 100%;
justify-content: space-around;
position: relative;
width: 100%;
}
^background {
background-color: #000;
bottom: 0;
left: 0;
opacity: 0.4;
position: absolute;
right: 0;
top: 0;
}
^inner {
z-index: 3;
}
`});foam.INTERFACE({package:"foam.core",name:"Agency",methods:[{name:"submit",type:"Void",args:[{name:"x",type:"Context"},{name:"agent",type:"foam.core.ContextAgent"},{name:"description",type:"String"}]},{name:"schedule",type:"Void",args:[{name:"x",type:"Context"},{name:"agent",type:"foam.core.ContextAgent"},{name:"key",type:"String"},{name:"delay",type:"long"}]}]});
foam.CLASS({package:"foam.core",name:"AbstractAgency",abstract:true,implements:["foam.core.Agency"],});
foam.CLASS({package:"foam.i18n",name:"TranslationFormatStringParser",requires:["foam.parse.Parsers","foam.parse.ImperativeGrammar"],properties:[{name:"value",value:"Hello ${toName} from ${fromName}"},{name:"parsedValue",expression:function(valueParserResults){return valueParserResults.parsedValue}},{name:"translationHint",value:"${fromName} is who it was from. ${toName} is who it is to."},{name:"parsedTranslationHint",expression:function(translationHint,valueParserResults){var matches=valueParserResults.matches;if(!translationHint||!matches)return"";this.onMatchFn=function(a){return matches[a[1]]||a.join("")};return this.grammar.parseString(translationHint)}},{name:"stringSymbol",value:"@"},{name:"onMatchFn",hidden:true},{name:"valueParserResults",hidden:true,expression:function(value,stringSymbol){var matches={};this.onMatchFn=function(a){if(!matches[a[1]]){matches[a[1]]=["%",Object.keys(matches).length+1,"$",stringSymbol].join("")}return matches[a[1]]};var parsedValue=this.grammar.parseString(value);return{matches:matches,parsedValue:parsedValue}}}],grammars:[{name:"grammar",language:"foam.parse.json.Parsers",symbols:function(){return{START:sym("string"),string:repeat(alt(sym("parameter"),anyChar())),parameter:seq("${",sym("identifier"),"}"),identifier:repeat(not("}",anyChar()))}},actions:[function parameter(a){return this.onMatchFn(a)},function identifier(a){return a.join("")},function string(a){return a.join("")}]}]});foam.LIB({name:"foam.Color",constants:[{name:"NAME_TO_COLOR",value:{black:"#000000",navy:"#000080",darkblue:"#00008b",mediumblue:"#0000cd",blue:"#0000ff",darkgreen:"#006400",green:"#008000",teal:"#008080",darkcyan:"#008b8b",deepskyblue:"#00bfff",darkturquoise:"#00ced1",mediumspringgreen:"#00fa9a",lime:"#00ff00",springgreen:"#00ff7f",aqua:"#00ffff",cyan:"#00ffff",midnightblue:"#191970",dodgerblue:"#1e90ff",lightseagreen:"#20b2aa",forestgreen:"#228b22",seagreen:"#2e8b57",darkslategray:"#2f4f4f",darkslategrey:"#2f4f4f",limegreen:"#32cd32",mediumseagreen:"#3cb371",turquoise:"#40e0d0",royalblue:"#4169e1",steelblue:"#4682b4",darkslateblue:"#483d8b",mediumturquoise:"#48d1cc",indigo:"#4b0082",darkolivegreen:"#556b2f",cadetblue:"#5f9ea0",cornflowerblue:"#6495ed",rebeccapurple:"#663399",mediumaquamarine:"#66cdaa",dimgray:"#696969",dimgrey:"#696969",slateblue:"#6a5acd",olivedrab:"#6b8e23",slategray:"#708090",slategrey:"#708090",lightslategray:"#778899",lightslategrey:"#778899",mediumslateblue:"#7b68ee",lawngreen:"#7cfc00",chartreuse:"#7fff00",aquamarine:"#7fffd4",maroon:"#800000",purple:"#800080",olive:"#808000",gray:"#808080",grey:"#808080",skyblue:"#87ceeb",lightskyblue:"#87cefa",blueviolet:"#8a2be2",darkred:"#8b0000",darkmagenta:"#8b008b",saddlebrown:"#8b4513",darkseagreen:"#8fbc8f",lightgreen:"#90ee90",mediumpurple:"#9370db",darkviolet:"#9400d3",palegreen:"#98fb98",darkorchid:"#9932cc",yellowgreen:"#9acd32",sienna:"#a0522d",brown:"#a52a2a",darkgray:"#a9a9a9",darkgrey:"#a9a9a9",lightblue:"#add8e6",greenyellow:"#adff2f",paleturquoise:"#afeeee",lightsteelblue:"#b0c4de",powderblue:"#b0e0e6",firebrick:"#b22222",darkgoldenrod:"#b8860b",mediumorchid:"#ba55d3",rosybrown:"#bc8f8f",darkkhaki:"#bdb76b",silver:"#c0c0c0",mediumvioletred:"#c71585",indianred:"#cd5c5c",peru:"#cd853f",chocolate:"#d2691e",tan:"#d2b48c",lightgray:"#d3d3d3",lightgrey:"#d3d3d3",thistle:"#d8bfd8",orchid:"#da70d6",goldenrod:"#daa520",palevioletred:"#db7093",crimson:"#dc143c",gainsboro:"#dcdcdc",plum:"#dda0dd",burlywood:"#deb887",lightcyan:"#e0ffff",lavender:"#e6e6fa",darksalmon:"#e9967a",violet:"#ee82ee",palegoldenrod:"#eee8aa",lightcoral:"#f08080",khaki:"#f0e68c",aliceblue:"#f0f8ff",honeydew:"#f0fff0",azure:"#f0ffff",sandybrown:"#f4a460",wheat:"#f5deb3",beige:"#f5f5dc",whitesmoke:"#f5f5f5",mintcream:"#f5fffa",ghostwhite:"#f8f8ff",salmon:"#fa8072",antiquewhite:"#faebd7",linen:"#faf0e6",lightgoldenrodyellow:"#fafad2",oldlace:"#fdf5e6",red:"#ff0000",fuchsia:"#ff00ff",magenta:"#ff00ff",deeppink:"#ff1493",orangered:"#ff4500",tomato:"#ff6347",hotpink:"#ff69b4",coral:"#ff7f50",darkorange:"#ff8c00",lightsalmon:"#ffa07a",orange:"#ffa500",lightpink:"#ffb6c1",pink:"#ffc0cb",gold:"#ffd700",peachpuff:"#ffdab9",navajowhite:"#ffdead",moccasin:"#ffe4b5",bisque:"#ffe4c4",mistyrose:"#ffe4e1",blanchedalmond:"#ffebcd",papayawhip:"#ffefd5",lavenderblush:"#fff0f5",seashell:"#fff5ee",cornsilk:"#fff8dc",lemonchiffon:"#fffacd",floralwhite:"#fffaf0",snow:"#fffafa",yellow:"#ffff00",lightyellow:"#ffffe0",ivory:"#fffff0",white:"#ffffff"}},{name:"COLOR_TO_NAME",factory:function(){return Object.entries(this.NAME_TO_COLOR).reduce((o,[k,v])=>(o[v]=k,o),{})}}],methods:[function parse(str){str=str.trim();if(foam.Color.NAME_TO_COLOR.hasOwnProperty(str)){str=foam.Color.NAME_TO_COLOR[str]}var components;if(str.startsWith("#")){str=str.slice(1);foam.assert(str.length==6||str.length==8);components=str.match(/../g).map(v=>parseInt(v,16))}else if(str.startsWith("rgb")){components=str.substring(str.startsWith("rgba")?5:4,str.length-1).split(",")}return{red:components[0],green:components[1],blue:components[2],alpha:components[3]}},function getBestForeground(str,black,white){with(foam.Color.parse(str)){return red*.299+green*.587+blue*.114>186?black:white}},function lighten(str,value){colorObj=foam.Color.parse(str);var[r,g,b]=[colorObj.red,colorObj.green,colorObj.blue];let l=foam.Color.rgbToGrey([r,g,b])*1e3;let scale=l+l*(value/100);var[r,g,b]=foam.Color.adjustRGBBrightness([r,g,b],scale/1e3);return`rgb(${r.toFixed(4)},${g.toFixed(4)},${b.toFixed(4)})`},function rgbToGrey(rgb){var[r,g,b]=rgb;return.299*r/255+.587*g/255+.114*b/255},function adjustRGBBrightness(rgb,desired){var[r,g,b]=rgb;var gr=foam.Color.rgbToGrey(rgb);if(desired>=gr){var mix=(desired-gr)/(1-gr);return[255*mix+(1-mix)*r,255*mix+(1-mix)*g,255*mix+(1-mix)*b]}var scale=desired/gr;return[scale*r,scale*g,scale*b]}]});foam.INTERFACE({package:"foam.core",name:"PropertyInfo",javaExtends:["Axiom","ClassInfoAware","Comparable","Comparator","Expr","Hasher","Signer","SQLStatement","Validator"],methods:["boolean getExternalTransient() { return false; }","boolean getNetworkTransient() { return false; }","boolean getReadPermissionRequired() { return false; }","boolean getWritePermissionRequired() { return false; }","boolean getStorageTransient() { return false; }","boolean getStorageOptional() { return false; }","boolean getClusterTransient() { return false; }","boolean getXMLAttribute() { return false; }","boolean getXMLTextNode() { return false; }","boolean getRequired() { return false; }","java.lang.Class getValueClass()","String getName()","String[] getAliases()","String getShortName() { return null; }","byte[] getNameAsByteArray()","Object get(Object obj)","void set(Object obj, Object value)","void clear(Object obj)","Parser jsonParser()","Parser queryParser()","Parser csvParser()","void toJSON(foam.lib.json.Outputter outputter, Object value) { outputter.output(value); }","void format(foam.lib.formatter.FObjectFormatter outputter, FObject obj)","void formatJSON(foam.lib.formatter.FObjectFormatter formatter, FObject obj) { format(formatter, obj); }","void toCSV(X x, Object obj, foam.lib.csv.CSVOutputter outputter) { outputter.outputValue(obj != null ? get(obj) : null); }","void toCSVLabel(X x, foam.lib.csv.CSVOutputter outputter) { outputter.outputValue(getName()); }","void toXML(foam.lib.xml.Outputter outputter, Object value) { outputter.output(value); }",`void diff(FObject o1, FObject o2, Map diff, PropertyInfo prop) {
if ( prop.compare(o1, o2) != 0 ) {
diff.put(prop.getName(), prop.f(o2));
}
}`,{signature:"boolean hardDiff(FObject o1, FObject o2, FObject diff)",},"Object fromString(String value)","void setFromString(Object obj, String value) { this.set(obj, fromString(value));}",`Object fromXML(X x, javax.xml.stream.XMLStreamReader reader) {
// Moves reader to characters state in order for value reading for various data types (date, boolean, short ...)
try {
reader.next();
} catch (javax.xml.stream.XMLStreamException ex) {
foam.nanos.logger.Logger logger = (foam.nanos.logger.Logger) x.get("logger");
logger.error("Premature end of XML file");
}
return "";
}`,"int comparePropertyToObject(Object key, Object o)","int comparePropertyToValue(Object key, Object value)","String getSQLType()","boolean includeInID() { return false; }","boolean isSet(Object obj)","boolean isDefaultValue(Object obj)","void setStatementValue(IndexedPreparedStatement stmt, FObject o) throws java.sql.SQLException","void setFromResultSet(java.sql.ResultSet resultSet, int index, FObject o) throws java.sql.SQLException","void cloneProperty(FObject source, FObject dest) { set(dest, foam.util.SafetyUtil.deepClone(get(source))); }","boolean containsPII() { return false; }","boolean containsDeletablePII() { return false; }",`void validateObj(foam.core.X x, foam.core.FObject obj) {
/* Template Method: override in subclass if required. */
if ( getRequired() && ! isSet(obj) ) {
throw new ValidationException(getName() + " required");
}
}`,"void fromCSVLabelMapping(java.util.Map<String,foam.lib.csv.FromCSVSetter> map)","boolean getSheetsOutput() { return false; }","Object castObject(Object value) { return value; }"]});foam.LIB({name:"foam.java.Util",methods:[{name:"limitSplit",code:function(str,maxWords){res=[];var arr=str.split(" ");var line="";for(i=0;i<arr.length;i++){line+=arr[i]+" ";if(i%maxWords==0&&i>0){res.push(line);line=""}}res.push(line);return res}},{name:"removeSpacing",code:function(str){var res=str.replace(/\s+(?= )/g," ");return res}}]});
foam.CLASS({package:"foam.core",name:"Fluent",methods:[function add(){throw new Error('This DSL cannot ".add()"')},function call(f,args){f.apply(this,args);return this},function callIf(bool,f,args){if(bool)f.apply(this,args);return this},function callIfElse(bool,iff,elsef,args){(bool?iff:elsef).apply(this,args);return this},function forEach(array,fn){if(foam.core.Slot.isInstance(array)){this.add(array.map(a=>this.E().forEach(a,fn)))}else{array.forEach(fn.bind(this))}return this}]});
foam.CLASS({package:"foam.util",name:"FObjectSpec",extends:"foam.core.FObjectProperty",properties:[["fromJSON",function fromJSON(value,ctx,prop,json){return value}],["adapt",function(_,spec,prop){return foam.String.isInstance(spec)?{class:spec}:spec}],["javaJSONParser","foam.lib.json.UnknownFObjectParser.instance()"],["displayWidth",80],["view","foam.u2.view.MapView"]]});
foam.CLASS({package:"foam.util",name:"FObjectSpecArray",extends:"foam.core.FObjectArray",properties:[["fromJSON",function fromJSON(value,ctx,prop,json){return value}],["adapt",function(_,specArray,prop){return specArray.map(spec=>foam.String.isInstance(spec)?{class:spec}:spec)}],["javaJSONParser","foam.lib.json.UnknownFObjectParser.instance()"],["displayWidth",80]]});foam.INTERFACE({package:"foam.util",name:"FluentSpec",flags:["web"],methods:[{name:"apply",args:[{name:"fluent",type:"foam.core.Fluent"}]}]});
foam.CLASS({package:"foam.util",name:"BaseFluentSpec",implements:[{flags:["web"],path:"foam.util.FluentSpec"}],properties:[{class:"String",name:"id",factory:function(){return this.$UID}}]});
foam.CLASS({package:"foam.util",name:"AddFluentSpec",extends:"foam.util.BaseFluentSpec",properties:[{class:"foam.util.FObjectSpec",name:"spec"}],methods:[function apply(fluent){fluent.add(this.spec)}]});
foam.CLASS({package:"foam.util",name:"RemoveFluentSpec",extends:"foam.util.BaseFluentSpec",properties:[{class:"String",name:"reference"}],methods:[function apply(fluent){fluent.remove(this.reference)}]});
foam.CLASS({package:"foam.util",name:"AddBeforeFluentSpec",extends:"foam.util.BaseFluentSpec",properties:[{class:"String",name:"reference"},{class:"foam.util.FObjectSpec",name:"spec"}],methods:[function apply(fluent){fluent.addBefore(this.reference,this.spec)}]});
foam.CLASS({package:"foam.util",name:"Timer",swiftName:"FoamTimer",properties:[{class:"Int",name:"interval",help:"Interval of time between updating time.",value:10},{class:"Int",name:"i",value:0},{class:"Float",name:"timeWarp",value:1},{class:"Int",name:"duration",units:"ms",value:-1},{class:"Float",name:"percent",value:0},{class:"Long",name:"startTime",value:0},{class:"Long",name:"time",help:"The current time in milliseconds since epoch.",adapt:function(_,t){return Math.ceil(t)},swiftAdapt:`
if let newValue = newValue as? Double {
return Int(ceil(newValue))
}
return newValue as! Int
`,value:0},{class:"Int",name:"second",help:"The second of the current minute.",value:0},{class:"Int",name:"minute",help:"The minute of the current hour.",value:0},{class:"Int",name:"hour",help:"The hour of the current day.",value:0},{class:"Boolean",name:"isStarted",hidden:true},{class:"Long",name:"startTime_",hidden:true}],methods:[{name:"cycle",args:[{name:"frequency",},{name:"a",},{name:"b",}],code:function(frequency,a,b){var s=Math.sin(this.time/1e3*frequency*Math.PI*2);if(arguments.length===1)return s;if(arguments.length===2)return s*a;return a+(1+s)*(b-a)/2},}],actions:[{name:"start",help:"Start the timer.",isEnabled:function(isStarted){return!isStarted},code:function(){this.startTime_=Date.now();this.isStarted=true;this.tick()},},{name:"step",help:"Step the timer.",code:function(){this.i++;this.time+=this.interval*this.timeWarp;this.second=this.time/1e3%60<<0;this.minute=this.time/6e4%60<<0;this.hour=this.time/36e5%24<<0},},{name:"stop",help:"Stop the timer.",isEnabled:function(isStarted){return isStarted},code:function(){this.isStarted=false},}],listeners:[{name:"tick",isFramed:true,code:function(){if(!this.isStarted)return;var prevTime=this.startTime_;this.startTime_=Date.now();this.interval=this.startTime_-prevTime;this.step();this.tick()},}]});foam.LIB({name:"foam.util.AddressUtil",methods:[{name:"parseAddress",args:[{name:"address1",type:"String"},{name:"address2",type:"String"}],type:"StringArray",code:function(address1,address2){var suitePattern=/\d+/g;if(address1.indexOf("Unit")>0){var parts=address1.split("Unit");address1=parts[0].trim();address2=parts[1].trim()}if(address1.endsWith(",")){address1.split(",")[0]}if(address1.indexOf(",")>0){var parts=address1.split(",");address1=parts[0];address2=parts[1]}var street=address1;var suite=address2.match(suitePattern);if(address1.indexOf("-")>0){var parts=address1.split("-");suite=parts[0].match(suitePattern);street=parts[1].trim()}street=street.replace(/[\#"]/g,"");var n=street.indexOf(" ");return[street.slice(0,n),street.slice(n+1)]}}]});
foam.CLASS({package:"foam.util",name:"EmailTest",extends:"foam.nanos.test.Test",methods:[{name:"runTest",}]});
foam.CLASS({package:"foam.util",name:"PasswordTest",extends:"foam.nanos.test.Test",methods:[{name:"runTest",},{name:"Password_HashWithInvalidInput_IllegalArgumentException",args:[{type:"String",name:"input"},{type:"String",name:"message"}],},{name:"Password_HashWithValidInput_Succeeds",args:[{type:"String",name:"input"}],},{name:"Password_Verify",args:[{type:"String",name:"password"},{type:"String",name:"hash"},{type:"Boolean",name:"expected"},{type:"String",name:"message"}],},{name:"Password_IsValid",args:[{type:"Context",name:"x"},{type:"String",name:"input"},{type:"Boolean",name:"expected"},{type:"String",name:"message"}],}]});
foam.CLASS({package:"foam.util",name:"SecurityUtilTest",extends:"foam.nanos.test.Test",constants:[{type:"String",name:"DSA_MD5",value:"MD5:43:97:1c:aa:f8:ba:1a:8f:20:b7:27:9a:40:94:b3:f6"},{type:"String",name:"DSA_SHA1",value:"SHA1:7xSlLFBn7ZC51vEd2EZEFv3RQhs"},{type:"String",name:"DSA_SHA256",value:"SHA256:bPwHkmzpJXRc/R1prQR0ZsKh3q86jpUWWoK6GMw2SRM"},{type:"String",name:"RSA_MD5",value:"MD5:73:2d:4b:2c:59:37:d2:ac:36:19:2d:d9:da:91:12:3d"},{type:"String",name:"RSA_SHA1",value:"SHA1:fa0C/aP0RS8yBboDD8CPTLxwdzk"},{type:"String",name:"RSA_SHA256",value:"SHA256:vaLx6BKF2YLID22PTiUAufKhmHB4Mfq3ewLTdF3rhLE"},{type:"String",name:"EC_256_MD5",value:"MD5:21:e3:ad:fb:f9:15:69:1e:63:1c:15:91:64:e3:59:10"},{type:"String",name:"EC_256_SHA1",value:"SHA1:PDwtkaOhM6sNak3QHL1HjeSEW+o"},{type:"String",name:"EC_256_SHA256",value:"SHA256:nBapDbPxvU/9kOg9yoOc8MEgq/U7bUmo5c8gL4CzX5E"},{type:"String",name:"EC_384_MD5",value:"MD5:0d:d0:d2:e5:80:cb:44:7f:41:b0:cf:7e:c5:78:10:b9"},{type:"String",name:"EC_384_SHA1",value:"SHA1:DS3tKzzvtT1ufBVFGAt7xZIhH90"},{type:"String",name:"EC_384_SHA256",value:"SHA256:Y6WV/e/H5Fz3ZUkJnsh0i2rw5/oJ9F3/PG5CNr5SSBY"},{type:"String",name:"EC_521_MD5",value:"MD5:87:dd:44:f5:b7:9c:5e:f5:07:24:5f:e4:f6:72:8e:aa"},{type:"String",name:"EC_521_SHA1",value:"SHA1:3thS3QfijLyQxvSgfmW0DEBW9s0"},{type:"String",name:"EC_521_SHA256",value:"SHA256:mC+U1T2p0Fzq5FmOHUgJ/ofA/MoNkcDWynTnxfrJghw"}],methods:[{name:"runTest",},{name:"SecurityUtil_GenerateSSHKeyFingerprint_DSAPublicKey_1024",},{name:"SecurityUtil_GenerateSSHKeyFingerprint_RSAPublicKey_4096",},{name:"SecurityUtil_GenerateSSHKeyFingerprint_ECPublicKey_256",},{name:"SecurityUtil_GenerateSSHKeyFingerprint_ECPublicKey_384",},{name:"SecurityUtil_GenerateSSHKeyFingerprint_ECPublicKey_521",}]});
foam.CLASS({package:"foam.util.async",name:"Sequence",extends:"foam.core.Fluent",implements:["foam.core.ContextAgent","foam.mlang.Expressions"],requires:["foam.core.NullAgent"],exports:["as sequence"],properties:[{name:"contextAgentSpecs",class:"FObjectArray",of:"FObject"},{name:"halted_",class:"Boolean"},{class:"Duration",name:"timeout",value:1e3}],methods:[function add(spec,args){return this.addAs(spec.name,spec,args)},function addAs(name,spec,args){this.contextAgentSpecs$push(this.Step.create({name:name,spec:spec,args:args}));return this},function addBefore(name,spec,args){for(var i=0;i<this.contextAgentSpecs.length;i++){let ca=this.contextAgentSpecs[i];if(name==ca.name){break}}var firstHalf=this.contextAgentSpecs.slice(0,i);var secondHalf=this.contextAgentSpecs.slice(i);this.contextAgentSpecs=[...firstHalf,this.Step.create({name:spec.name||spec.class?.split(".").slice(-1)[0],spec:spec,args:args}),...secondHalf];return this},function addAfter(name,spec,args){for(var i=0;i<this.contextAgentSpecs.length;i++){let ca=this.contextAgentSpecs[i];if(name==ca.name){break}}var firstHalf=this.contextAgentSpecs.slice(0,i+1);var secondHalf=this.contextAgentSpecs.slice(i+1);this.contextAgentSpecs=[...firstHalf,this.Step.create({name:spec.name,spec:spec,args:args}),...secondHalf];return this},function reconfigure(name,args){for(let ca of this.contextAgentSpecs){if(name==ca.name){ca.args={...ca.args,...args};break}}return this},function contains(name){for(let ca of this.contextAgentSpecs){if(name==ca.name&&ca.spec!==this.NullAgent){return true}}return false},function get(name){for(let ca of this.contextAgentSpecs){if(name==ca.name){return ca}}},function remove(name){this.contextAgentSpecs$replace(this.EQ(this.Step.NAME,name),this.Step.create({name:name,spec:this.NullAgent}));return this},function execute(){let i=0;let nextStep=x=>{if(i>=this.contextAgentSpecs.length)return Promise.resolve(x);if(this.halted_)return Promise.resolve(x);let seqspec=this.contextAgentSpecs[i++];let contextAgent;var spec=seqspec.spec;var args=seqspec.args;if(spec.create){contextAgent=spec.create(args,x)}else{var cls=foam.core.FObject.isSubClass(spec.class)?spec.class:this.__subContext__.lookup(spec.class);if(!cls)foam.assert(false,"Argument to Sequence.add specifies unknown class: ",spec.class);contextAgent=cls.create(spec,x).copyFrom(args||{})}const stepResolvedTimeout=setTimeout(()=>{console.warn(`context agent still pending after ${this.timeout}ms; `+`open the object for helpful details.`,seqspec)},this.timeout);return contextAgent.execute().then(newX=>{clearTimeout(stepResolvedTimeout);return nextStep(newX||contextAgent.__subContext__)})};return nextStep(this.__subContext__)},function endSequence(){this.halted_=true}],classes:[{name:"Step",properties:[{name:"name",class:"String"},{name:"spec",class:"Class"},{name:"args",class:"Object"}]}]});
foam.CLASS({package:"foam.util",name:"UIDGenerator",abstract:true,flags:["java"],properties:[{name:"salt",class:"String"},{name:"machineId",class:"Int",},{name:"minLength",class:"Int"}],methods:[{abstract:true,name:"generate_",args:["StringBuilder id"]},{name:"generate",type:"String",},{name:"calcChecksum",visibility:"protected",type:"Integer",args:[{name:"id",type:"String"}],},{name:"getNext",type:"Object",args:["java.lang.Class type"],},{name:"getNextString",type:"String",},{name:"getNextLong",type:"Long",},{name:"getHashKey",type:"Integer",}]});
foam.CLASS({package:"foam.util",name:"AUIDGenerator",extends:"foam.util.UIDGenerator",flags:["java"],constants:[{name:"EPOCH",type:"Long",value:16357392e5}],properties:[{name:"seqNo",class:"Int"},{name:"lastSecondCalled",class:"Long",}],methods:[{name:"getNext",args:["java.lang.Class type"],type:"Object",},{name:"getNextLong",},{name:"generate_",}]});
foam.CLASS({package:"foam.util",name:"NUIDGenerator",extends:"foam.util.UIDGenerator",flags:["java"],properties:[{class:"String",name:"salt",},{class:"foam.dao.DAOProperty",name:"dao"},{class:"FObjectProperty",name:"propertyInfo",hidden:true,javaInfoType:"foam.core.AbstractObjectPropertyInfo"}],methods:[{name:"init_",},{name:"getNext",args:["java.lang.Class type"],type:"Object",},{name:"generate_",},{name:"initMaxSeqNo",},{name:"assertLongId",},{name:"maybeUpdateSeqNo",args:"Long id",}]});
foam.CLASS({package:"foam.util.test",name:"DummyNuid",properties:[{class:"Long",name:"id"}]});
foam.CLASS({package:"foam.util.test",name:"UIDGeneratorTest",extends:"foam.nanos.test.Test",methods:[{name:"runTest",},{name:"UIDGeneratorTest_GenerateVerifiableUniqueStringIDs",args:["UIDGenerator uidgen","int hash"],},{name:"UIDGeneratorTest_GenerateVerifiableUniqueLongIDs",args:["Context x","UIDGenerator uidgen","int hash"],},{name:"calcSimilarityScore",type:"Integer",args:["String id1","String id2"],},{name:"UIDGeneratorTest_CheckGeneratedUIDsSimilarity",args:["AUIDGenerator uidgen","int startSeqNo","int threshold"],},{name:"UIDGeneratorTest_SetMinLength",args:"AUIDGenerator uidgen, Integer minLength",}]});
foam.CLASS({package:"foam.util.test",name:"UIDUniquenessTest",extends:"foam.nanos.test.Test",properties:[{class:"Int",name:"size",value:1e5}],methods:[{name:"runTest",},{name:"testDuplicateFound",args:["Boolean expected","String message","UIDGenerator... uidGenerators"],},{name:"UIDUniquenessTest_No_duplicate_on_same_instance",args:["Context x"],},{name:"UIDUniquenessTest_Could_generate_duplicate_on_instances_with_same_machineId",args:["Context x"],},{name:"UIDUniquenessTest_No_duplicate_on_instances_with_different_machineId",args:["Context x"],}]});foam.INTERFACE({package:"foam.util.uid",name:"GlobalSearchService",skeleton:true,methods:[{name:"searchById",type:"Map",async:true,args:["Context x","String id"]}]});
foam.CLASS({package:"foam.util.uid",name:"FuidSearchService",implements:["foam.util.uid.GlobalSearchService"],imports:["DAO fuidKeyDAO"],constants:[{name:"NUID_ID_PATTERN",type:"Regex",value:/^\d*$/}],methods:[{name:"searchById",type:"Map",args:["Context x","String id"],},{name:"findById",args:["Context x","Object id","List daoList","Map result"],},{name:"getDaoList",type:"List",args:["Integer key"],}]});
foam.CLASS({package:"foam.util.uid",name:"ClientGlobalSearchService",implements:["foam.util.uid.GlobalSearchService"],requires:["foam.box.SessionClientBox","foam.box.HTTPBox"],properties:[{class:"String",name:"serviceName"},{class:"Stub",of:"foam.util.uid.GlobalSearchService",name:"delegate",factory:function(){return this.SessionClientBox.create({delegate:this.HTTPBox.create({method:"POST",url:this.serviceName})})}}]});
foam.CLASS({package:"foam.util.uid",name:"FuidKey",plural:"Fuid Keys",ids:["daoName"],properties:[{class:"String",name:"daoName"},{class:"Int",name:"key"}]});
foam.CLASS({package:"foam.util",name:"DeFeedback",description:"Mixin to add de-feedback functionality to a class",properties:[{class:"Boolean",name:"feedback_"}],methods:[function deFeedback(fn){if(this.feedback_)return;this.feedback_=true;try{fn()}catch(x){}this.feedback_=false}]});foam.ENUM({package:"foam.log",name:"LogLevel",properties:[{class:"String",name:"shortName"},{class:"String",name:"consoleMethodName"}],values:[{name:"DEBUG",shortName:"DEBG",label:"Debug",color:"blue",consoleMethodName:"debug"},{name:"INFO",shortName:"INFO",label:"Info",color:"#0000cc",consoleMethodName:"info"},{name:"WARN",shortName:"WARN",label:"Warn",color:"#ffa500",consoleMethodName:"warn"},{name:"ERROR",shortName:"ERRR",label:"Error",color:"red",consoleMethodName:"error"}]});foam.INTERFACE({package:"foam.log",name:"Logger",proxy:true,methods:[{name:"debug",},{name:"log",},{name:"info",},{name:"warn",},{name:"error",}]});
foam.CLASS({package:"foam.log",name:"ConsoleLogger",implements:["foam.log.Logger"],requires:["foam.log.LogLevel"],imports:["debug as debug_","log as log_","info as info_","warn as warn_","error as error_"],exports:["debug","log","info","warn","error"],properties:[{class:"Function",name:"debug",factory:function(){return this.put.bind(this,this.LogLevel.DEBUG)}},{class:"Function",name:"log",factory:function(){return this.put.bind(this,this.LogLevel.INFO)}},{class:"Function",name:"info",factory:function(){return this.put.bind(this,this.LogLevel.INFO)}},{class:"Function",name:"warn",factory:function(){return this.put.bind(this,this.LogLevel.WARN)}},{class:"Function",name:"error",factory:function(){return this.put.bind(this,this.LogLevel.ERROR)}},{class:"Function",name:"getDateString",factory:function(){return function(){return(new Date).toString()}}}],methods:[function put(logLevel){var args=[logLevel.shortName,"["+this.getDateString()+"]"].concat(Array.from(arguments).slice(1));this[logLevel.consoleMethodName+"_"].apply(this,args)}]});
foam.CLASS({package:"foam.memento",name:"MementoMgr",properties:[{name:"memento"},{name:"stack",factory:function(){return[]}},{name:"redo",factory:function(){return[]}},"posFeedback_",{class:"Int",name:"position",postSet:function(_,n){if(this.posFeedback_)return;while(n<this.stackSize_)this.back();while(n>this.stackSize_)this.forth()}},"stackSize_","redoSize_","totalSize_"],methods:[function init(){this.memento$.sub(this.onMementoChange)},function updateSizes(){this.posFeedback_=true;this.stackSize_=this.stack.length;this.redoSize_=this.redo.length;this.totalSize_=this.stack.length+this.redo.length;this.position=this.stack.length;this.posFeedback_=false},function remember(memento){this.dumpState("preRemember");this.stack.push(memento);this.updateSizes();this.dumpState("postRemember")},function restore(memento){this.dumpState("preRestore");this.ignore_=true;this.memento=memento;this.ignore_=false;this.dumpState("postRestore")},function dumpState(spot){}],actions:[{name:"back",label:" <-- ",help:"Go to previous view",isEnabled:function(stackSize_){return!!stackSize_},code:function(){this.dumpState("preBack");this.redo.push(this.memento);this.restore(this.stack.pop());this.updateSizes();this.dumpState("postBack")}},{name:"forth",label:" --\x3e ",help:"Undo the previous back.",isEnabled:function(redoSize_){return!!redoSize_},code:function(){this.dumpState("preForth");this.remember(this.memento);this.restore(this.redo.pop());this.updateSizes();this.dumpState("postForth")}}],listeners:[function onMementoChange(_,__,___,memento$){if(this.ignore_)return;this.remember(memento$.oldValue);this.redo=[];this.updateSizes()}]});
foam.CLASS({package:"foam.web",name:"DetachedURLState",requires:["foam.json.Outputter","foam.json.Parser"],imports:["warn","window"],properties:[{name:"serializer",factory:function(){return this.Outputter.create({pretty:false,formatDatesAsNumbers:true,outputDefaultValues:false,strict:true})}},{name:"deserializer",factory:function(){return this.Parser.create({strict:true,creationContext:this.__subContext__})}},{name:"bindingsMap_",factory:function(){return{}}},{name:"subMap_",factory:function(){return{}}},{name:"unboundMap_",factory:function(){return{}}},{class:"String",name:"path_",postSet:function(old,nu){if(old!==nu)this.onStateChange()}},{class:"String",name:"hash_",}],methods:[function init(){this.SUPER();this.hashToState_()},function getHash(){return this.hash_},function setHash(hash){this.hash_=hash;this.hashToState_()},function getPath(){return this.path_},function setPath(path){return this.path_=path},function getSlot(name){return this.bindingsMap_[name]||null},function addBinding(name,slot){if(this.bindingsMap_.hasOwnProperty(name)){this.__context__.warn("Overwriting URLState:",name,this.bindingsMap_[name],"with",slot);this.subMap_[name].detach()}if(this.unboundMap_.hasOwnProperty(name)){slot.set(this.unboundMap_[name]);delete this.unboundMap_[name]}this.bindingsMap_[name]=slot;this.subMap_[name]=slot.sub(this.onStateChange);this.onStateChange()},function removeBinding(name){if(!this.bindingsMap_.hasOwnProperty(name))return;this.subMap_[name].detach();delete this.subMap_[name];delete this.bindingsMap_[name];this.onStateChange()},function clearBindings(){var subMap=this.subMap_;for(var key in subMap){if(!subMap.hasOwnProperty(key))continue;subMap[key].detach()}this.subMap_={};this.bindingsMap_={};this.unboundMap_={};this.onStateChange()},function stateToHash_(){var stateStr="";stateStr=this.appendMapToStateStr_(stateStr,this.bindingsMap_,this.getBoundValue);stateStr=this.appendMapToStateStr_(stateStr,this.unboundMap_,this.getUnboundValue);this.hash_="#"+this.path_+"?"+stateStr},function appendMapToStateStr_(str,map,getMapValue){for(var key in map){if(!map.hasOwnProperty(key))continue;if(str!=="")str+="&";var value=this.serializer.stringify(getMapValue(key));str+=this.window.encodeURIComponent(key)+"="+this.window.encodeURIComponent(value)}return str},function hashToState_(){var hash=this.hash_;var res=this.hashGrammar.parseString(hash,"hash");foam.assert(res,"Invalid URLState hash: "+hash);this.path_=this.window.decodeURIComponent(res.path);var bindingsMap=this.bindingsMap_;var bindings=res.bindings;for(var i=0;i<bindings.length;i++){var binding=bindings[i];var key=this.window.decodeURIComponent(binding.key);var value=this.deserializer.parseString(this.window.decodeURIComponent(binding.value));if(bindingsMap.hasOwnProperty(key)){if(!foam.util.equals(bindingsMap[key].get(),value))bindingsMap[key].set(value)}else{this.unboundMap_[key]=value}}}],listeners:[function onStateChange(){this.stateToHash_()},function getBoundValue(key){return this.bindingsMap_[key]&&this.bindingsMap_[key].get()},function getUnboundValue(key){return this.unboundMap_[key]}],grammars:[{name:"hashGrammar",language:"foam.parse.json.Parsers",symbols:function(){return{hash:optional(seq("#",optional(sym("path")),optional(seq1(1,"?",repeat(sym("binding"),"&"))))),path:str(repeat(notChars("?"))),binding:seq(sym("key"),optional(seq1(1,"=",sym("value")))),key:str(plus(notChars("=&"))),value:str(plus(notChars("=&")))}},actions:[function binding(v){return{key:v[0],value:v[1]}},function hash(v){return{path:v&&v[1]||"",bindings:v&&v[2]||[]}}]}]});
foam.CLASS({package:"foam.web",name:"URLState",extends:"foam.web.DetachedURLState",requires:["foam.json.Outputter","foam.json.Parser"],imports:["warn","window"],methods:[function init(){this.SUPER();this.setHash(this.window.location.hash);this.window.addEventListener("hashchange",this.onHashChange)}],listeners:[function onHashChange(){this.setHash(this.window.location.hash);this.hashToState_()},{name:"onStateChange",isMerged:true,mergeDelay:150,code:function(){this.stateToHash_();this.window.location.hash=this.hash_}}]});
foam.CLASS({package:"foam.input",name:"TouchEvent",properties:[{class:"Float",name:"x"},{class:"Float",name:"y"},{class:"Boolean",name:"claimed",value:false}]});
foam.CLASS({package:"foam.input",name:"Mouse",topics:["down","move","touch","up"],properties:["lastTouch","x","y",{name:"element",postSet:function(old,e){if(old){old.removeEventListener("mousedown",this.onMouseDown);old.removeEventListener("mouseup",this.onMouseUp);old.removeEventListener("mousemove",this.onMouseMove)}e.addEventListener("mousedown",this.onMouseDown);e.addEventListener("mouseup",this.onMouseUp);e.addEventListener("mousemove",this.onMouseMove)}}],methods:[function install(element){this.ref=element}],listeners:[{name:"onMouseDown",code:function(e){var bounds=this.element.getBoundingClientRect();this.x=e.clientX-bounds.left;this.y=e.clientY-bounds.top;this.down.pub();if(this.touch.hasListeners()){if(this.lastTouch)this.lastTouch.detach();this.lastTouch=foam.input.TouchEvent.create();this.lastTouch.onDetach(this.lastTouch.x$.follow(this.x$));this.lastTouch.onDetach(this.lastTouch.y$.follow(this.y$));this.touch.pub(this.lastTouch);if(this.lastTouch&&this.lastTouch.claimed)e.preventDefault()}window.addEventListener("mouseup",this.onMouseUp);window.addEventListener("mousemove",this.onMouseMove)}},{name:"onMouseUp",code:function(e){this.up.pub();if(this.lastTouch){this.lastTouch.detach();this.lastTouch=undefined}window.removeEventListener("mouseup",this.onMouseUp);window.removeEventListener("mousemove",this.onMouseMove)}},{name:"onMouseMove",code:function(e){if(this.lastTouch||this.hasListeners("propertyChange")||this.move.hasListeners()){var bounds=this.element.getBoundingClientRect();this.x=e.clientX-bounds.left;this.y=e.clientY-bounds.top;this.move.pub();if(this.lastTouch&&this.lastTouch.claimed)e.preventDefault()}}}]});
foam.CLASS({package:"foam.input",name:"Touch",topics:["touch"],properties:[{name:"touches",factory:function(){return{}}},{name:"element",postSet:function(old,e){if(old){old.removeEventListener("touchstart",this.onTouchStart);old.removeEventListener("touchmove",this.onTouchMove);old.removeEventListener("touchend",this.onTouchEnd)}e.addEventListener("touchstart",this.onTouchStart);e.addEventListener("touchmove",this.onTouchMove);e.addEventListener("touchend",this.onTouchEnd)}}],listeners:[function onTouchStart(e){var newTouches=e.changedTouches;var bounds=this.element.getBoundingClientRect();for(var i=0;i<newTouches.length;i++){var touch=newTouches.item(i);var touchEvent=foam.input.TouchEvent.create({x:touch.clientX-bounds.left,y:touch.clientY-bounds.top});this.touch.pub(touchEvent);if(touchEvent.claimed)e.preventDefault();this.touches[touch.identifier]=touchEvent}},function onTouchMove(e){var changed=e.changedTouches;var bounds=this.element.getBoundingClientRect();for(var i=0;i<changed.length;i++){var touch=changed.item(i);var event=this.touches[touch.identifier];event.x=touch.clientX-bounds.left;event.y=touch.clientY-bounds.top;if(event.claimed)e.preventDefault()}},function onTouchEnd(e){var changed=e.changedTouches;for(var i=0;i<changed.length;i++){var touch=changed.item(i);this.touches[touch.identifier].detach();delete this.touches[touch.identifier]}}]});
foam.CLASS({package:"foam.input",name:"Pointer",requires:["foam.input.Mouse","foam.input.Touch"],topics:["touch"],properties:[{name:"element",required:true},{name:"mouseInput",factory:function(){var m=this.Mouse.create();this.onDetach(m.element$.follow(this.element$));this.onDetach(m.touch.sub(this.onTouch));return m}},{name:"touchInput",factory:function(){var t=this.Touch.create();this.onDetach(t.element$.follow(this.element$));this.onDetach(t.touch.sub(this.onTouch));return t}}],methods:[function init(){var mi=this.mouseInput;var ti=this.touchInput}],listeners:[function onTouch(e,_,t){this.touch.pub(t)}]});
foam.CLASS({package:"foam.box",name:"Remote",properties:[{class:"String",name:"clientClass"}],methods:[function installInClass(cls){var clientClass=this.clientClass||cls.getAxiomsByClass(foam.core.Implements)[0].path;cls.installAxiom(foam.core.Method.create({name:"outputJSON",code:function(outputter){var cls=this.__context__.maybeLookup(clientClass);if(!cls){throw new Error("Could not find "+clientClass+" to serialize "+this.cls_.id)}if(!foam.core.Stub.isInstance(cls.getAxiomByName("delegate"))){throw new Error('Expected stub property to be named "delegate" for '+cls.id)}var X=this.__subContext__;var registry=X.registry;var box=foam.box.SkeletonBox.create({data:this},X);box=registry.register(null,null,box);var obj=cls.create(null,X);obj.delegate=box;outputter.output(obj)}}))}]});
foam.CLASS({package:"foam.u2",name:"DeleteModal",extends:"foam.u2.View",requires:["foam.log.LogLevel"],imports:["notify"],css:`
^ {
border-radius: 3px;
background-color: #fff;
/* Don't let the modal exceed the screen size, minus some margin. */
max-width: calc(100vw - 48px);
max-height: calc(100vh - 116px);
overflow-y: auto;
/* The line below accounts for the top nav bar. */
}
^main {
padding: 24px;
}
^main > h2:first-child {
margin-top: 0;
}
^ .buttons {
padding: 24px;
box-sizing: border-box;
display: flex;
justify-content: flex-end;
}
`,messages:[{name:"TITLE",message:"Delete "},{name:"CONFIRM_DELETE_1",message:"Are you sure you want to delete"},{name:"SUCCESS_MSG",message:" deleted"},{name:"FAIL_MSG",message:"Failed to delete"}],properties:[{class:"foam.dao.DAOProperty",name:"dao"},{class:"Function",name:"onDelete"},{class:"FObjectProperty",name:"data"},{class:"String",name:"label"}],methods:[function render(){this.SUPER();this.addClass(this.myClass()).start().addClass(this.myClass("main")).start("h2").add(this.TITLE).add(this.label?this.label:this.data.model_.label).add("?").end().start("p").add(`${this.CONFIRM_DELETE_1} `).add(this.label?this.label:`${this.data.toSummary()}`).add("?").end().end().start().addClass("buttons").startContext({data:this}).tag(this.CANCEL,{buttonStyle:"SECONDARY"}).tag(this.DELETE,{isDestructive:true}).endContext().end()}],actions:[{name:"delete",label:"Delete",code:function(X){this.dao.remove(this.data).then(o=>{if(foam.comics.v2.userfeedback.UserFeedbackAware.isInstance(o)&&o.userFeedback){var currentFeedback=o.userFeedback;while(currentFeedback){this.notify(currentFeedback.message,"",this.LogLevel.INFO,true);currentFeedback=currentFeedback.next}}else{this.notify(this.data.model_.label+this.SUCCESS_MSG,"",this.LogLevel.INFO,true)}this.onDelete()}).catch(err=>{if(err.exception&&err.exception.userFeedback){var currentFeedback=err.exception.userFeedback;while(currentFeedback){this.notify(currentFeedback.message,"",this.LogLevel.INFO,true);currentFeedback=currentFeedback.next}}else{this.notify(err.message||this.FAIL_MSG,"",this.LogLevel.ERROR,true)}});X.closeDialog()}},{name:"cancel",label:"Cancel",code:function(X){X.closeDialog()}}]});
foam.CLASS({package:"foam.u2",name:"EasyDialog",extends:"foam.u2.ModalOverlay",requires:["foam.u2.Dialog"],constants:{CSS_CLASS:"foam-u2-ModalOverlay"},properties:[{type:"String",name:"confirmLabel",value:"OK"},{type:"String",name:"cancelLabel",value:"Cancel"},{name:"title",},{name:"body",},{type:"Function",name:"onConfirm",value:null},{name:"buttons",factory:function(){if(this.onConfirm){return[[function(){this.close();this.onConfirm()}.bind(this),this.confirmLabel],[this.close.bind(this),this.cancelLabel]]}return[[this.close.bind(this),this.confirmLabel]]}},{type:"Boolean",name:"padding",attribute:true,value:true},{name:"dialog_",factory:function(){return this.Dialog.create({title:this.title,body:this.body,buttons:this.buttons,padding:this.padding})}}],methods:[function init(){this.add(this.dialog_);this.SUPER()}]});
foam.CLASS({package:"foam.u2",name:"MemoModal",extends:"foam.u2.View",imports:["notify"],requires:["foam.u2.ControllerMode"],css:`
^ {
border-radius: 3px;
background-color: #fff;
/* Don't let the modal exceed the screen size, minus some margin. */
max-width: calc(100vw - 48px);
max-height: calc(100vh - 116px);
overflow-y: auto;
/* The line below accounts for the top nav bar. */
}
^title {
padding: 32px 0px;
font-size: 1.5em;
font-weight: bold;
}
^main {
padding: 0px 32px;
}
^ .buttons {
padding: 32px;
box-sizing: border-box;
display: flex;
justify-content: flex-end;
}
`,messages:[{name:"CONFIRM_DELETE_1",message:"Are you sure you want to delete"},{name:"SUCCESS_MSG",message:" deleted"},{name:"FAIL_MSG",message:"Failed to delete"},{name:"NOTE_REQUIRED",message:"Please provide a note (required)"},{name:"NOTE_OPTIONAL",message:"Please provide a note (optional)"}],properties:[{class:"Function",name:"onExecute"},{class:"String",name:"title",expression:function(isMemoRequired){if(isMemoRequired)return this.NOTE_REQUIRED;return this.NOTE_OPTIONAL}},{class:"String",name:"memo",view:{class:"foam.u2.tag.TextArea",rows:"8px",onKey:true}},{class:"Boolean",name:"isMemoRequired"}],methods:[function render(){this.SUPER();this.addClass(this.myClass()).start().addClass(this.myClass("main")).start().addClass(this.myClass("title")).add(this.title).end().startContext({data:this,controllerMode:this.ControllerMode.EDIT}).tag(this.MEMO).endContext().end().start().addClass("buttons").startContext({data:this}).tag(this.CANCEL,{buttonStyle:"SECONDARY"}).tag(this.OK).endContext().end()}],actions:[{name:"ok",isEnabled:(isMemoRequired,memo)=>{if(!isMemoRequired)return true;return memo!=""},code:function(X){this.onExecute(this.memo);X.closeDialog()}},{name:"cancel",code:function(X){X.closeDialog()}}]});
foam.CLASS({package:"foam.u2",name:"PropertyModal",extends:"foam.u2.dialog.StyledModal",imports:["notify"],requires:["foam.u2.ControllerMode","foam.u2.PropertyBorder"],messages:[{name:"CONFIRM_DELETE_1",message:"Are you sure you want to delete"},{name:"SUCCESS_MSG",message:" deleted"},{name:"FAIL_MSG",message:"Failed to delete"},{name:"DEFAULT_TITLE",message:"Please fill out the following"},{name:"REQUIRED",message:"Required"},{name:"OPTIONAL",message:"Optional"}],css:`
^inner {
align-items: stretch;
}
`,properties:[{class:"Function",name:"onExecute"},{name:"title",expression:function(isModalRequired){if(isModalRequired)return`${this.DEFAULT_TITLE} (${this.REQUIRED})`;return`${this.DEFAULT_TITLE} (${this.OPTIONAL})`}},{class:"Property",name:"property"},{class:"Boolean",name:"isModalRequired"},{name:"propertyData",attribute:true},"data"],methods:[function addBody(){return this.E().startContext({controllerMode:this.ControllerMode.EDIT,data:this.data}).tag(this.PropertyBorder,{prop:this.property,data$:this.data$}).endContext()},function addActions(){var actions=this.E().startContext({data:this});actions.tag(this.OK,{isDestructive:this.modalStyle=="DESTRUCTIVE"});if(this.showCancel){actions.tag(this.CANCEL)}return actions.endContext()}],actions:[{name:"ok",buttonStyle:"PRIMARY",isEnabled:(isModalRequired,propertyData)=>{if(!isModalRequired)return true;return propertyData},code:function(X){this.onExecute();X.closeDialog()}},{name:"cancel",code:function(X){X.closeDialog()}}]});
foam.CLASS({package:"foam.u2",name:"ModalHeader",extends:"foam.u2.View",imports:["stack"],properties:["title"],css:`
^ {
display: flex;
flex-direction: row;
align-items: center;
width: 100%; /* This is to fit the width of its parent container */
padding: 24px 24px 20px;
box-sizing: border-box;
border-bottom: solid 1px #CBCFD4;
}
^title{
font-family: /*%FONT1%*/ 'IBM Plex Sans';
font-style: normal;
font-weight: 600;
font-size: 2.4rem;
line-height: 28px;
color: #000000;
margin: 0;
flex: none;
}
^ .foam-u2-ActionView-closeModal{
background: transparent !important;
margin-top: 0;
border: none !important;
}
`,methods:[function render(){this.SUPER();this.addClass(this.myClass()).start().addClass(this.myClass("title")).add(this.title).end()}]});
foam.CLASS({package:"foam.u2",name:"ExportModal",extends:"foam.u2.View",imports:["exportDriverRegistryDAO","filteredTableColumns","serviceName"],messages:[{name:"EXPORT",message:"Export"},{name:"DATA_TYPE_MSG",message:"Data Type"},{name:"RESPONSE",message:"Response"}],requires:["foam.u2.layout.Cols","foam.u2.ModalHeader"],css:`
^{
width: 448px;
margin: auto;
padding-bottom: 24px;
}
^ .property-dataType {
margin-right: 24px;
}
^ .foam-u2-tag-Select {
width: 100%;
border-radius: 0;
padding: 6px 10px;
border: solid 1px rgba(164, 179, 184, 0.5);
background-color:/*%WHITE%*/ #ffffff;
outline: none;
background: #ffffff url('/images/dropdown-icon.svg') no-repeat 98% 50%;
-webkit-appearance: none;
}
^ .foam-u2-ModalHeader {
border-bottom: none;
}
^ .foam-u2-tag-Select:hover {
cursor: pointer;
}
^ .foam-u2-tag-Select:focus {
border: solid 1px #59A5D5;
}
^ .label{
font-family: /*%FONT1%*/ 'IBM Plex Sans';
font-style: normal;
font-weight: normal;
font-size: 1.1rem;
line-height: 14px;
color: #000000;
margin: 10px 0px 0px 24px;
}
^ .note {
height: 150px;
width: 398px;
margin-left: 24px;
}
^buttons {
padding: 12px 12px 0px 24px;
position: relative;
top: 10;
}
^ .foam-u2-ActionView-primary {
margin: 12px;
}
`,properties:[{class:"String",name:"dataType",view:function(_,X){return foam.u2.view.ChoiceView.create({dao:X.exportDriverRegistryDAO.where(X.data.predicate),objToChoice:function(a){return[a.id,a.id]},placeholder:"Select"},X)}},{name:"isDataTypeSelected",expression:function(dataType){return dataType!=""}},{name:"note",view:"foam.u2.tag.TextArea",value:""},{class:"FObjectProperty",of:"foam.mlang.predicate.Predicate",name:"predicate",factory:function(){return foam.mlang.predicate.True.create()}},{name:"unknownExportDriverRegistry",factory:function(){return foam.nanos.export.ExportDriverRegistry.create()}},"exportData","exportObj",{name:"exportAllColumns",view:{class:"foam.u2.CheckBox",label:"Export all columns"},class:"Boolean"},"exportDriverReg",{class:"Boolean",name:"isConvertAvailable"},{class:"Boolean",name:"isDownloadAvailable"},{class:"Boolean",name:"isOpenAvailable"},"exportDriver"],methods:[function render(){var self=this;this.SUPER();this.exportDriverReg=this.unknownExportDriverRegistry;this.exportDriver=undefined;self.dataType$.sub(function(){self.exportDriverRegistryDAO.find(self.dataType).then(function(val){if(!val){self.exportDriverReg=self.unknownExportDriverRegistry;self.exportDriver=undefined}else{self.exportDriverReg=val;self.exportDriver=foam.lookup(self.exportDriverReg.driverName).create()}})});self.exportDriverReg$.sub(function(){self.isConvertAvailable=self.exportDriverReg.isConvertible;self.isDownloadAvailable=self.exportDriverReg.isDownloadable;self.isOpenAvailable=self.exportDriverReg.isOpenable});this.tag(this.ModalHeader.create({title:this.EXPORT})).addClass(this.myClass()).startContext({data:this}).start().start().addClass("label").style({"padding-top":"14px"}).add(this.DATA_TYPE_MSG).end().start().style({"margin-left":"24px"}).add(this.DATA_TYPE).end().add(this.slot(function(exportDriver){return this.E().show(exportDriver&&exportDriver.cls_.getAxiomsByClass(foam.core.Property).some(p=>!p.hidden)).add(exportDriver)})).start().show(this.isDataTypeSelected$).start().addClass("label").style({"padding-top":"14px"}).add(this.RESPONSE).end().start(this.NOTE).addClass("input-box").addClass("note").end().add(self.slot(function(exportDriverReg$exportAllColumns){if(exportDriverReg$exportAllColumns){return self.E().start().addClass("label").startContext({data:self}).tag(self.EXPORT_ALL_COLUMNS).endContext().end()}})).start(this.Cols).style({"justify-content":"flex-start"}).addClass(this.myClass("buttons")).start(this.DOWNLOAD).end().start(this.CONVERT).end().start(this.OPEN).end().end().end().end().endContext()}],actions:[{name:"convert",isAvailable:function(isConvertAvailable){return isConvertAvailable},code:async function(){if(!this.exportData&&!this.exportObj){console.log("Neither exportData nor exportObj exist");return}var filteredColumnsCopy=this.filteredTableColumns;if(this.exportAllColumns)this.filteredTableColumns=null;try{this.note=this.exportData?await this.exportDriver.exportDAO(this.__context__,this.exportData):await this.exportDriver.exportFObject(this.__context__,this.exportObj)}finally{if(this.exportAllColumns)this.filteredTableColumns=filteredColumnsCopy}}},{name:"download",isAvailable:function(isDownloadAvailable){return isDownloadAvailable},code:async function download(){var self=this;if(!this.exportData&&!this.exportObj){console.log("Neither exportData nor exportObj exist");return}var filteredColumnsCopy=this.filteredTableColumns;if(this.exportAllColumns)this.filteredTableColumns=null;var p=this.exportData?Promise.resolve(this.exportDriver.exportDAO(this.__context__,this.exportData)):Promise.resolve(this.exportDriver.exportFObject(this.__context__,this.exportObj));var exportDataResult;p.then(result=>{exportDataResult=result;var link=document.createElement("a");var href="";if(self.exportDriverReg.mimeType&&self.exportDriverReg.mimeType.length!=0){var prefix="data:"+self.exportDriverReg.mimeType+",";href=encodeURI(prefix+result)}else{href=result}if(href.length>524288){var blob=new Blob([result],{type:self.exportDriverReg.mimeType});href=URL.createObjectURL(blob)}link.setAttribute("href",href);link.setAttribute("download","data."+self.exportDriverReg.extension);document.body.appendChild(link);link.click();if(blob)URL.revokeObjectURL(link.href);document.body.removeChild(link)}).finally(()=>{if(this.exportAllColumns)this.filteredTableColumns=filteredColumnsCopy})}},{name:"open",isAvailable:function(isOpenAvailable){return isOpenAvailable},code:async function(){var filteredColumnsCopy=this.filteredTableColumns;if(this.exportAllColumns)this.filteredTableColumns=null;var url;try{url=this.exportData?await this.exportDriver.exportDAO(this.__context__,this.exportData):await this.exportDriver.exportFObject(this.__context__,this.exportObj)}finally{if(this.exportAllColumns)this.filteredTableColumns=filteredColumnsCopy}if(url&&url.length>0)window.location.replace(url)}}]});
foam.CLASS({package:"foam.u2",name:"MultiView",extends:"foam.u2.View",imports:["data as parentData"],exports:["parentData as data"],css:`
^wrapper {
display: flex;
}
^wrapper^vertical {
flex-direction: column;
}
^container {
margin: 2px 8px 2px 0;
}
^container:last-child {
margin-right: 0;
}
`,properties:[{class:"Boolean",name:"horizontal",value:true},{class:"Array",name:"views",adapt:function(_,a){return foam.Array.isInstance(a)?a.map(o=>foam.String.isInstance(o)?{class:o}:o):a}},"prop"],methods:[function render(){this.SUPER();var self=this;this.addClass();this.add(this.slot(function(views){return self.E().addClass(this.myClass("wrapper")).enableClass(this.myClass("vertical"),this.horizontal$.map(v=>!v)).forEach(views,function(v,i){return this.start().addClass(self.myClass("container")).start(v,{data$:self.data$}).call(function(){self.prop&&this.fromProperty&&this.fromProperty(self.prop)}).end().end()})}))},function fromProperty(prop){this.prop=prop}]});
foam.CLASS({package:"foam.u2",name:"AttrSlot",extends:"foam.core.Slot",properties:[{name:"element",required:true},"value",["property","value"],["event","change"]],methods:[function get(){return this.element.getAttribute(this.property)},function set(value){this.element.setAttribute(this.property,value);this.value=value},function sub(l){var self=this;const valueUpdateListener=function(){self.set(self.get())};if(!this.hasListeners()){this.element.on(this.event,valueUpdateListener)}var detachable=this.SUPER("propertyChange","value",l);return{detach:function(){if(self.hasListeners()){self.element.removeEventListener(self.event,valueUpdateListener)}detachable.detach()}}},function follow(other){this.SUPER(other);this.set(other.get())},function toString(){return"AttrSlot("+this.event+", "+this.property+")"}]});
foam.CLASS({package:"foam.u2",name:"ViewSpec",extends:"foam.core.FObjectProperty",axioms:[{installInClass:function(cls){var Element;var FObject=foam.core.FObject;var Str=foam.String;cls.createView=function(spec,args,self,ctx,disableWarning){if(!Element)Element=foam.u2.Element;if(FObject.isInstance(ctx))ctx=ctx.__subContext__;if(!spec||Str.isInstance(spec)){if(args){if(spec)args.nodeName=spec;return Element.create(args,ctx)}var e=Element.create(null,ctx);if(spec)e.nodeName=spec;return e}if(Element.isInstance(spec)){if(foam.debug&&!disableWarning){console.warn("Warning: Use of literal View as ViewSpec: ",spec.cls_.id)}return spec.copyFrom(args)}if(foam.core.Slot.isInstance(spec))return spec;if(spec&&spec.toE)return spec.toE(args,ctx);if(foam.Function.isInstance(spec))return foam.u2.ViewSpec.createView(spec.call(self,args,ctx,true),args,self,ctx,true);if(foam.Object.isInstance(spec)){var ret;if(spec.create){ret=spec.create(args,ctx)}else{var cls=foam.core.FObject.isSubClass(spec.class)?spec.class:ctx.lookup(spec.class);if(!cls){foam.assert(false,"ViewSpec specifies unknown class: ",spec.class)}ret=cls.create(spec,ctx).copyFrom(args||{})}if(spec.children){for(var i=0;i<spec.children.length;i++){ret.tag(spec.children[0])}}foam.assert(Element.isInstance(ret)||ret.toE,"ViewSpec result must extend foam.u2.Element or be toE()-able.");return ret}if(FObject.isSubClass(spec)){var ret=spec.create(args,ctx);foam.assert(Element.isInstance(ret),"ViewSpec class must extend foam.u2.Element or be toE()-able.");return ret}throw"Invalid ViewSpec, must provide an Element, Slot, toE()-able, Function, {create: function() {}}, {class: 'name'}, Class, or String, but received: "+spec}}}],properties:[["fromJSON",function fromJSON(value,ctx,prop,json){return value}],{name:"view",value:{class:"foam.u2.view.MapView"}},{name:"adapt",value:function(_,spec,prop){if(foam.String.isInstance(spec)){spec=spec.trim();return spec.startsWith("{")?JSON.parse(spec):{class:spec}}return spec}},["javaJSONParser","foam.lib.json.UnknownFObjectParser.instance()"],["displayWidth",80]]});
foam.CLASS({package:"foam.u2",name:"Tooltip",extends:"foam.u2.View",imports:["window"],requires:["foam.u2.TooltipView"],properties:[{name:"text",required:true},{name:"target",required:true},"timer","screenWidth","top","left","right","tooltipStore"],methods:[function init(){this.target.removeAttribute("title");this.target.on("mouseover",this.loadTooltip);this.target.onDetach(this.close);this.SUPER()},async function setTooltip(evt){var el=await this.target.el();this.tooltipStore=this.TooltipView.create({data:this.text});var domRect=el.getBoundingClientRect();this.screenWidth=this.window.innerWidth;var screenHeight=this.window.innerHeight;var scrollY=this.window.scrollY;var height=this.tooltipStore.getBoundingClientRect().height;this.top=domRect.top-scrollY>screenHeight/2?evt.pageY-30-height:evt.pageY+20;if(domRect.left>3*(this.screenWidth/4)){this.left="auto";this.right=this.screenWidth-evt.pageX+10}else{this.left=evt.pageX+10;this.right="auto"}this.tooltipStore.style({"max-width":this.screenWidth/2+"px",top:this.top$,left:this.left$,right:this.right$});this.tooltipStore.write()}],listeners:[function onMouseOver(evt){if(this.timer!==undefined){clearTimeout(this.timer)}this.timer=setTimeout(()=>{this.setTooltip(evt)},500);this.target.on("mousemove",evt=>{this.close();this.setTooltip(evt)})},function close(){if(this.tooltipStore){this.tooltipStore.remove()}clearTimeout(this.timer)},async function loadTooltip(evt){if(!this.target){console.error("Target not found");return}var el=await this.target.el();this.target.on("mouseover",this.onMouseOver);this.target.on("mousedown",this.close);this.target.on("mouseleave",this.close);this.target.on("mouseout",this.close);this.target.on("touchstart",this.close,{passive:true});this.target.on("unload",this.close);this.onMouseOver(evt)}]});
foam.CLASS({package:"foam.u2",name:"TooltipView",extends:"foam.u2.View",methods:[function render(data){this.SUPER();this.add(this.data).style({background:"rgba(80, 80, 80, 0.9)","border-radius":"5px",color:"white",padding:"5px 8px",position:"absolute","z-index":"2000"})}]});foam.INTERFACE({package:"foam.u2",name:"RowFormatter",methods:[function format(data,opt_columns){}]});if(!globalThis.WeakMap){Object.defineProperty(globalThis,"WeakMap",{configurable:true,writable:true,value:function WeakMap(){var id="__WEAK_MAP__"+this.$UID;function del(key){delete key[id]}function get(key){return key[id]}function set(key,value){key[id]=value}function has(key){return!!key[id]}return{__proto__:this,delete:del,get:get,set:set,has:has}}})}foam.ENUM({package:"foam.u2",name:"ControllerMode",properties:[{class:"String",name:"modePropertyName"},{name:"restrictDisplayMode",value:function(mode){return mode}}],methods:[function getVisibilityValue(prop){return prop.visibility||prop[this.modePropertyName]}],values:[{name:"CREATE",modePropertyName:"createVisibility"},{name:"VIEW",modePropertyName:"readVisibility",restrictDisplayMode:function(mode){return mode==foam.u2.DisplayMode.RW?foam.u2.DisplayMode.RO:mode}},{name:"EDIT",modePropertyName:"updateVisibility"}]});foam.ENUM({package:"foam.u2",name:"DisplayMode",properties:[{name:"restrictDisplayMode",value:function(mode){return mode===foam.u2.DisplayMode.RW?this:mode}}],values:[{name:"RW",label:"Read-Write"},{name:"DISABLED"},{name:"RO",label:"Read-Only"},{name:"HIDDEN",restrictDisplayMode:function(){return foam.u2.DisplayMode.HIDDEN}}]});
foam.CLASS({package:"foam.u2",name:"Entity",properties:[{name:"name",assertValue:function(nu){if(!nu.match(/^[a-z#]\w*$/i)){throw new Error("Invalid Entity name: "+nu)}}}],methods:[function output(out){out("&",this.name,";")},function toE(){return this}]});
foam.CLASS({package:"foam.u2",name:"CSS",properties:[{class:"String",name:"code"},{name:"name",factory:function(){return"CSS-"+Math.abs(foam.util.hashCode(this.code))}},{class:"Boolean",name:"expands_",expression:function(code){return code.includes("^")||code.includes("$")}}],methods:[function maybeInstallInDocument(X,cls){var document=X.document;if(!document)return;var installedStyles=document.installedStyles||(document.installedStyles={});if(this.expands_){var map=installedStyles[this.$UID]||(installedStyles[this.$UID]={});if(!map[cls.id]){map[cls.id]=true;X.installCSS(this.expandCSS(cls,this.code,X),cls.id)}}else{if(!installedStyles[this.$UID]){installedStyles[this.$UID]=true;X.installCSS(this.expandCSS(cls,this.code,X),cls.id)}}},function installInClass(cls){var oldCreate=cls.create;var axiom=this;var isFirstCSS=!cls.private_.hasCSS;if(isFirstCSS)cls.private_.hasCSS=true;cls.create=function(args,opt_parent){var X=opt_parent?opt_parent.__subContext__||opt_parent.__context__||opt_parent:foam.__context__;try{return oldCreate.call(this,args,X)}finally{var lastClassToInstallCSSFor=X.lastClassToInstallCSSFor;if(!lastClassToInstallCSSFor||lastClassToInstallCSSFor==cls){axiom.maybeInstallInDocument(X,this)}if(!lastClassToInstallCSSFor&&!this.model_.inheritCSS){X=X.createSubContext({lastClassToInstallCSSFor:this,originalX:X})}if(lastClassToInstallCSSFor&&isFirstCSS)X=X.originalX}}},function expandCSS(cls,text,ctx){if(!this.expands_)return text;var base="."+foam.String.cssClassize(cls.id);text=text.replace(/\^(.)/g,function(match,next){var c=next.charCodeAt(0);if(65<=c&&c<=90||97<=c&&c<=122||48<=c&&c<=57||c===45||c===95){return base+"-"+next}return base+next});return foam.CSS.replaceTokens(text,cls,ctx)}]});
foam.CLASS({package:"foam.u2",name:"JsLib",constants:{LOADED:{}},properties:[{class:"String",name:"src"},{name:"name",factory:function(){return"JsLib-"+this.src}},["priority",20]],methods:[function installInProto(proto){var oldRender=proto.render,self=this;proto.render=async function(){await self.installLib();oldRender.apply(this,arguments)}},function installLib(){if(!document)return;var installedStyles=document.installedStyles||(document.installedStyles={});if(!this.LOADED[this.name]){var self=this;this.LOADED[this.name]=new Promise(function(resolve,reject){var id=foam.next$UID();let e=document.createElement("script");e.setAttribute("id",id);e.setAttribute("src",self.src);document.body.appendChild(e);e.onload=function(){resolve(true)}})}return this.LOADED[this.name]}]});
foam.CLASS({package:"foam.u2",name:"DefaultValidator",axioms:[foam.pattern.Singleton.create()],methods:[function validateNodeName(name){return true},function validateAttributeName(name){},function validateAttributeValue(value){},function validateStyleName(name){},function validateStyleValue(value){},function sanitizeText(text){if(!text)return text;text=text.toString();if(text.search(/[&<"']/)==-1)return text;return text.replace(/[&<"']/g,m=>{switch(m){case"&":return"&amp;";case"<":return"&lt;";case'"':return"&quot;";case"'":return"&#039"}})}]});
foam.CLASS({package:"foam.u2",name:"ElementState",methods:[function el(){},function output(out){},function load(){},function unload(){},function onRemove(){},function onSetClass(){},function onFocus(){},function onAddListener(){},function onRemoveListener(){},function onSetStyle(){},function onSetAttr(){},function onRemoveAttr(){},function onAddChildren(){},function onInsertChildren(){},function onReplaceChild(){},function onRemoveChild(){},function getBoundingClientRect(){return{left:0,right:0,bottom:0,top:0,width:0,height:0}}]});
foam.CLASS({package:"foam.u2",name:"InitialElementState",extends:"foam.u2.UnloadedElementState",axioms:[foam.pattern.Singleton.create()],methods:[function el(){var self=this;return new Promise(function(resolve,reject){self.sub("onload",()=>resolve(self.el_()))})},function output(out){this.render();this.state=this.OUTPUT;this.output_(out);return out},function toString(){return"INITIAL"}]});
foam.CLASS({package:"foam.u2",name:"OutputElementState",extends:"foam.u2.ElementState",methods:[function el(){var self=this;return new Promise(function(resolve,reject){self.sub("onload",()=>resolve(self.el_()))})},function output(out){this.__context__.warn("ERROR: Duplicate output.");return this.UNLOADED.output.call(this,out)},function load(){if(this.hasOwnProperty("elListeners")){var ls=this.elListeners;for(var i=0;i<ls.length;i+=3){this.addEventListener_(ls[i],ls[i+1],ls[i+2]||false)}}this.visitChildren("load");this.state=this.LOADED;if(this.tabIndex)this.setAttribute("tabindex",this.tabIndex);if(this.focused)this.el().then(el=>el.focus())},function unload(){this.state=this.UNLOADED;this.visitChildren("unload");this.detach()},function onSetClass(){throw new Error("Mutations not allowed in OUTPUT state.")},function onFocus(){throw new Error("Mutations not allowed in OUTPUT state.")},function onAddListener(){throw new Error("Mutations not allowed in OUTPUT state.")},function onRemoveListener(){throw new Error("Mutations not allowed in OUTPUT state.")},function onSetStyle(){throw new Error("Mutations not allowed in OUTPUT state.")},function onSetAttr(){throw new Error("Mutations not allowed in OUTPUT state.")},function onRemoveAttr(){throw new Error("Mutations not allowed in OUTPUT state.")},function onAddChildren(){throw new Error("Mutations not allowed in OUTPUT state.")},function onInsertChildren(){throw new Error("Mutations not allowed in OUTPUT state.")},function onReplaceChild(){throw new Error("Mutations not allowed in OUTPUT state.")},function onRemoveChild(){throw new Error("Mutations not allowed in OUTPUT state.")},function toString(){return"OUTPUT"}]});
foam.CLASS({package:"foam.u2",name:"LoadedElementState",extends:"foam.u2.ElementState",methods:[function el(){return Promise.resolve(this.el_())},function output(out){this.__context__.warn("Duplicate output.");return this.UNLOADED.output.call(this,out)},function load(){this.__console__.warn("Duplicate load.")},function unload(){if(!this.parentNode||this.parentNode.state===this.LOADED){var e=this.el_();if(e)e.remove()}this.state=this.UNLOADED;this.visitChildren("unload");this.detach()},function onRemove(){this.unload()},function onSetClass(cls,enabled){var e=this.el_();if(e){e.classList[enabled?"add":"remove"](cls)}else{this.__context__.warn("Missing Element: ",this.id)}},function onFocus(){this.el_().focus()},function onAddListener(topic,listener,opt_args){this.addEventListener_(topic,listener,opt_args)},function onRemoveListener(topic,listener){this.addRemoveListener_(topic,listener)},function onSetStyle(key,value){this.el_().style[key]=value},function onSetAttr(key,value){if(this.PSEDO_ATTRIBUTES[key]){this.el_()[key]=value}else{this.el_().setAttribute(key,value===true?"":value)}},function onRemoveAttr(key){if(this.PSEDO_ATTRIBUTES[key]){this.el_()[key]=""}else{this.el_().removeAttribute(key)}},function onAddChildren(){var e=this.el_();if(!e){this.__context__.warn("Missing Element: ",this.id);return}var out=this.createOutputStream();for(var i=0;i<arguments.length;i++){out(arguments[i])}e.insertAdjacentHTML("beforeend",out);for(var i=0;i<arguments.length;i++){arguments[i].load&&arguments[i].load()}},function onInsertChildren(children,reference,where){var e=this.el_();if(!e){this.__context__.warn("Missing Element: ",this.id);return}var out=this.createOutputStream();for(var i=0;i<children.length;i++){out(children[i])}reference.el_().insertAdjacentHTML(where,out);for(var i=0;i<children.length;i++){children[i].load&&children[i].load()}},function onReplaceChild(oldE,newE){var e=this.el_();if(!e){this.__context__.warn("Missing Element: ",this.id);return}var out=this.createOutputStream();out(newE);oldE.el_().outerHTML=out.toString();newE.load&&newE.load()},function onRemoveChild(child,index){if(typeof child==="string"){this.el_().childNodes[index].remove()}else{child.remove()}},function getBoundingClientRect(){return this.el_().getBoundingClientRect()},function toString(){return"LOADED"}]});
foam.CLASS({package:"foam.u2",name:"UnloadedElementState",extends:"foam.u2.ElementState",methods:[function el(){return{then:function(){},catch:function(){}}},function output(out){this.__context__.warn("Outputting unloaded element can cause event/binding bugs.",this.cls_.id);this.state=this.OUTPUT;this.output_(out);return out},function load(){this.__context__.warn("Must output before loading.")},function unload(){this.__context__.warn("Must output before loading.")},function toString(){return"UNLOADED"}]});
foam.CLASS({package:"foam.u2",name:"RenderSink",implements:["foam.dao.Sink"],axioms:[{class:"foam.box.Remote",clientClass:"foam.dao.ClientSink"}],properties:[{class:"foam.dao.DAOProperty",name:"dao"},{class:"Function",name:"addRow",},{class:"Function",name:"cleanup",},{class:"Int",name:"batch",},"comparator"],methods:[function put(obj,s){this.reset()},function remove(obj,s){this.reset()},function reset(){this.paint()}],listeners:[{name:"paint",isFramed:true,code:function(){var batch=++this.batch;var self=this;if(!foam.dao.DAO.isInstance(this.dao)){throw new Exception("You must set the 'dao' property of RenderSink.")}var dao=this.dao;this.dao.select().then(function(a){if(self.batch!==batch)return;var objs=a.array;if(self.comparator)objs.sort(self.comparator.compare.bind(self.comparator));self.cleanup();for(var i=0;i<objs.length;i++){self.addRow(objs[i])}})}}]});
foam.CLASS({package:"foam.u2",name:"Element",requires:[{path:"foam.core.PromiseSlot",flags:["js"]},{path:"foam.u2.ViewSpec",flags:["js"]},"foam.dao.MergedResetSink","foam.u2.AttrSlot","foam.u2.Entity","foam.u2.RenderSink","foam.u2.Tooltip"],imports:["document","elementValidator","framed","getElementById","translationService?"],implements:["foam.mlang.Expressions"],topics:["onload","onunload"],constants:[{name:"CSS_CLASSNAME_PATTERN",factory:function(){return/^[a-z_-][a-z\d_-]*$/i}},{name:"PSEDO_ATTRIBUTES",value:{value:true,checked:true}},{name:"DEFAULT_VALIDATOR",type:"foam.u2.DefaultValidator",flags:["js"],factory:function(){return foam.u2.DefaultValidator.create()}},{name:"INITIAL",type:"foam.u2.InitialElementState",flags:["js"],factory:function(){return foam.u2.InitialElementState.create()}},{name:"OUTPUT",type:"foam.u2.OutputElementState",flags:["js"],factory:function(){return foam.u2.OutputElementState.create()}},{name:"LOADED",type:"foam.u2.LoadedElementState",flags:["js"],factory:function(){return foam.u2.LoadedElementState.create()}},{name:"UNLOADED",type:"foam.u2.UnloadedElementState",flags:["js"],factory:function(){return foam.u2.UnloadedElementState.create()}},{name:"OPTIONAL_CLOSE_TAGS",value:{BODY:true,COLGROUP:true,DD:true,DT:true,HEAD:true,HTML:true,LI:true,OPTION:true,P:true,TBODY:true,TD:true,TFOOT:true,TH:true,THEAD:true,TR:true}},{name:"ILLEGAL_CLOSE_TAGS",value:{AREA:true,BASE:true,BASEFONT:true,BR:true,COL:true,FRAME:true,HR:true,IMG:true,INPUT:true,ISINDEX:true,LINK:true,META:true,PARAM:true}},{name:"__ID__",value:[1]},{name:"NEXT_ID",flags:["js"],value:function(){return this.__ID__[0]++}},{name:"KEYPRESS_CODES",value:{8:true,13:true,27:true,33:true,34:true,37:true,38:true,39:true,40:true}},{name:"NAMED_CODES",value:{13:"enter",37:"left",38:"up",39:"right",40:"down"}}],messages:[{name:"SELECT_BAD_USAGE",message:`You're using Element.select() wrong. The function passed to it must return an Element. Don't try to modify the view by side effects.`}],properties:[{class:"Object",name:"id",transient:true,factory:function(){return this.NEXT_ID()}},{class:"Enum",of:"foam.u2.ControllerMode",name:"controllerMode",factory:function(){return this.__context__.controllerMode||foam.u2.ControllerMode.CREATE}},{name:"state",class:"Proxy",of:"foam.u2.ElementState",flags:["js"],transient:true,topics:[],delegates:foam.u2.ElementState.getOwnAxiomsByClass(foam.core.Method).map(function(m){return m.name}),factory:function(){return this.INITIAL},postSet:function(oldState,state){if(state===this.LOADED){this.pub("onload")}else if(state===this.UNLOADED){this.pub("onunload")}}},{name:"content",preSet:function(o,n){return n===this?null:n}},{class:"String",name:"tooltip",postSet:function(o,n){if(n&&!o&&this.state==this.LOADED)this.initTooltip();return n}},{name:"parentNode",transient:true},{class:"Boolean",name:"shown",value:true,postSet:function(o,n){if(o===n)return;if(n){this.removeClass("foam-u2-Element-hidden")}else{this.addClass("foam-u2-Element-hidden")}}},{class:"Proxy",of:"foam.u2.DefaultValidator",name:"validator",flags:["js"],topics:[],factory:function(){return this.elementValidator$?this.elementValidator:this.DEFAULT_VALIDATOR}},{name:"nodeName",adapt:function(_,v){return foam.String.toUpperCase(v)},value:"DIV"},{name:"attributeMap",transient:true,factory:function(){return{}}},{name:"attributes",factory:function(){return[]},postSet:function(_,attrs){this.attributeMap={};for(var i=0;i<attrs.length;i++){this.attributeMap[attrs[i].name]=attrs[i]}}},{name:"classes",factory:function(){return{}}},{name:"css",factory:function(){return{}}},{name:"childNodes",factory:function(){return[]}},{name:"elListeners",factory:function(){return[]}},{name:"children",transient:true,getter:function(){return this.childNodes.filter(function(c){return typeof c!=="string"})}},{class:"Boolean",name:"focused",postSet:function(o,n){if(n)this.onFocus()}},{name:"outerHTML",transient:true,hidden:true,getter:function(){return this.output(this.createOutputStream()).toString()}},{name:"innerHTML",transient:true,hidden:true,getter:function(){return this.outputInnerHTML(this.createOutputStream()).toString()}},{name:"scrollHeight"},{class:"Int",name:"tabIndex"},{name:"clickTarget_"},{name:"__subSubContext__",factory:function(){return this.__subContext__}},"keyMap_"],methods:[function init(){this.onDetach(this.visitChildren.bind(this,"detach"))},function render(){this.initTooltip();this.initKeyboardShortcuts()},async function observeScrollHeight(){var self=this;var observer=new MutationObserver(async function(mutations){var el=await self.el();self.scrollHeight=el.scrollHeight});var config={attributes:true,childList:true,characterData:true};var e=await this.el();observer.observe(e,config);this.onunload.sub(function(s){observer.disconnect()});return this},function evtToCharCode(evt){var s="";if(evt.altKey)s+="alt-";if(evt.ctrlKey)s+="ctrl-";if(evt.shiftKey&&evt.type==="keydown")s+="shift-";if(evt.metaKey)s+="meta-";s+=evt.type==="keydown"?this.NAMED_CODES[evt.which]||String.fromCharCode(evt.which):String.fromCharCode(evt.charCode);return s},function initKeyMap_(keyMap,cls){var keyMap;if(!cls.hasOwnProperty("keyMap__")){var count=0;keyMap={};var as=cls.getAxiomsByClass(foam.core.Action);for(var i=0;i<as.length;i++){var a=as[i];for(var j=0;a.keyboardShortcuts&&j<a.keyboardShortcuts.length;j++,count++){var key=a.keyboardShortcuts[j];if(this.NAMED_CODES[key]){key=this.NAMED_CODES[key]}else if(typeof key==="number"){key=String.fromCharCode(key)}keyMap[key]=a}}if(count==0)keyMap=null;cls.keyMap__=keyMap}else{keyMap=cls.keyMap__}if(!keyMap)return null;var map={};for(var key in keyMap)map[key]=keyMap[key].maybeCall.bind(keyMap[key],this.__subContext__,this);return map},function initTooltip(){if(this.tooltip){this.Tooltip.create({target:this,text$:this.tooltip$})}else if(this.getAttribute("title")){this.Tooltip.create({target:this,text$:this.attrSlot("title")})}},function initKeyboardShortcuts(){var keyMap=this.initKeyMap_(keyMap,this.cls_);if(keyMap){this.keyMap_=keyMap;var target=this.parentNode||this;target.tabIndex=target.tabIndex||1;target.on("keydown",this.onKeyboardShortcut);target.on("keypress",this.onKeyboardShortcut)}},function el_(){return this.getElementById(this.id)},function findChildForEvent(e){var src=e.srcElement;var el=this.el_();var cMap={};var cs=this.children;if(!el)return;for(var i=0;i<cs.length;i++){var c=cs[i];cMap[c.id]=c}while(src!==el){var c=cMap[src.id];if(c)return c;src=src.parentElement}},function E(opt_nodeName){return this.__subSubContext__.E(opt_nodeName)},function attrSlot(opt_name,opt_event){var args={element:this};if(opt_name)args.property=opt_name;if(opt_event)args.event=opt_event;return this.AttrSlot.create(args)},function myClass(opt_extra){var f=this.cls_.hasOwnProperty("myClass_")&&this.cls_.myClass_;if(!f){var base=this.cls_.hasOwnProperty("CSS_CLASS")?this.cls_.CSS_CLASS.split(/ +/):foam.String.cssClassize(this.cls_.id).split(/ +/);f=this.cls_.myClass_=foam.Function.memoize1(function(e){return base.map(function(c){return c+(e?"-"+e:"")}).join(" ")})}return f(opt_extra)},function instanceClass(opt_extra){return this.myClass(this.id+"-"+opt_extra)},function visitChildren(methodName){var cs=this.childNodes;for(var i=0;i<cs.length;i++){var c=cs[i];c[methodName]&&c[methodName].call(c)}},function focus(){this.focused=true;return this},function blur(){this.focused=false;return this},function show(opt_shown){if(opt_shown===undefined){this.shown=true}else if(foam.core.Slot.isInstance(opt_shown)){this.onDetach(this.shown$.follow(opt_shown))}else{this.shown=opt_shown}return this},function hide(opt_hidden){return this.show(opt_hidden===undefined?false:foam.core.Slot.isInstance(opt_hidden)?opt_hidden.map(function(s){return!s}):!opt_hidden)},function setAttribute(name,value){if(name==="tabindex")this.tabIndex=parseInt(value);if(name.endsWith("$")){this[name]=value;return}var prop=this.cls_.getAxiomByName(name);if(prop&&foam.core.Property.isInstance(prop)&&prop.attribute){if(typeof value==="string"){this[name]=prop.fromString?prop.fromString(value):value}else if(foam.core.Slot.isInstance(value)){this.onDetach(this.slot(name).follow(value))}else{this[name]=value}}else{if(value===undefined||value===null||value===false){this.removeAttribute(name);return this}if(foam.core.Slot.isInstance(value)){this.slotAttr_(name,value)}else{foam.assert(foam.util.isPrimitive(value),"Attribute value must be a primitive type.");var attr=this.getAttributeNode(name);if(attr){attr.value=value}else{attr={name:name,value:value};this.attributes.push(attr);this.attributeMap[name]=attr}this.onSetAttr(name,value)}}return this},function removeAttribute(name){for(var i=0;i<this.attributes.length;i++){if(this.attributes[i].name===name){this.attributes.splice(i,1);delete this.attributeMap[name];this.onRemoveAttr(name);return}}},function getAttributeNode(name){return this.attributeMap[name]},function getAttribute(name){if(this.PSEDO_ATTRIBUTES[name]&&this.el_()){var value=this.el_()[name];var attr=this.getAttributeNode(name);if(attr){attr.value=value}else{attr={name:name,value:value};this.attributes.push(attr);this.attributeMap[name]=attr}return value}var attr=this.getAttributeNode(name);return attr&&attr.value},function appendChild(c){this.childNodes.push(c)},function removeChild(c){var cs=this.childNodes;for(var i=0;i<cs.length;++i){if(cs[i]===c){cs.splice(i,1);this.state.onRemoveChild.call(this,c,i);return}}},function replaceChild(newE,oldE){var cs=this.childNodes;for(var i=0;i<cs.length;++i){if(cs[i]===oldE){cs[i]=newE;newE.parentNode=this;this.state.onReplaceChild.call(this,oldE,newE);oldE.unload&&oldE.unload();return}}},function insertBefore(child,reference){return this.insertAt_(child,reference,true)},function insertAfter(child,reference){return this.insertAt_(child,reference,false)},function remove(){this.onRemove();if(this.parentNode){var cs=this.parentNode.childNodes;for(var i=0;i<cs.length;i++){if(cs[i]===this){cs.splice(i,1);return}}this.parentNode=undefined}},function addEventListener(topic,listener,opt_args){this.elListeners.push(topic,listener,opt_args);this.onAddListener(topic,listener,opt_args)},function removeEventListener(topic,listener){var ls=this.elListeners;for(var i=0;i<ls.length;i+=3){var t=ls[i],l=ls[i+1];if(t===topic&&l===listener){ls.splice(i,3);this.onRemoveListener(topic,listener);return}}},function setNodeName(name){this.nodeName=name;return this},function setID(id){this.id=id;return this},function entity(name){this.add(this.Entity.create({name:name}));return this},function nbsp(){return this.entity("nbsp")},function cssClass(cls){console.warn("Deprecated use of cssClass(). Use addClass() instead in ",this.cls_.name);return this.addClass(cls)},function addClass(cls){var self=this;if(cls===undefined){this.addClass_(null,this.myClass())}else if(foam.core.Slot.isInstance(cls)){var lastValue=null;var l=function(){var v=cls.get();self.addClass_(lastValue,v);lastValue=v};this.onDetach(cls.sub(l));l()}else if(typeof cls==="string"){this.addClass_(null,cls)}else{this.error("cssClass type error. Must be Slot or String.")}return this},function addClasses(a){a&&a.forEach(i=>this.addClass(i));return this},function enableClass(cls,enabled,opt_negate){function negate(a,b){return b?!a:a}if(foam.core.Slot.isInstance(enabled)){var self=this;var value=enabled;var l=function(){self.enableClass(cls,value.get(),opt_negate)};this.onDetach(value.sub(l));l()}else{enabled=negate(enabled,opt_negate);var parts=cls.split(" ");for(var i=0;i<parts.length;i++){this.classes[parts[i]]=enabled;this.onSetClass(parts[i],enabled)}}return this},function removeClass(cls){if(cls){delete this.classes[cls];this.onSetClass(cls,false)}return this},function on(topic,listener,opt_args){this.addEventListener(topic,listener,opt_args);return this},function attr(key,value){this.setAttribute(key,value);return this},function attrs(map){for(var key in map)this.setAttribute(key,map[key]);return this},function style(map){for(var key in map){var value=map[key];if(foam.core.Slot.isInstance(value)){this.slotStyle_(key,value)}else{this.style_(key,value)}}return this},function tag(spec,args,slot){var c=this.createChild_(spec,args);this.add(c);if(slot)slot.set(c);return this},function br(){return this.tag("br")},function startContext(map){var m={};Object.assign(m,map);m.__oldAddContext__=this.__subSubContext__;this.__subSubContext__=this.__subSubContext__.createSubContext(m);return this},function endContext(){this.__subSubContext__=this.__subSubContext__.__oldAddContext__;return this},function createChild_(spec,args){return foam.u2.ViewSpec.createView(spec,args,this,this.__subSubContext__)},function start(spec,args,slot){var c=this.createChild_(spec,args);this.add(c);if(slot)slot.set(c);return c},function end(){return this.parentNode},function translate(source,opt_default){var translationService=this.translationService;if(translationService){var translation=this.translationService.getTranslation(foam.locale,source,opt_default);if(foam.xmsg){return this.tag({class:"foam.i18n.InlineLocaleEditor",source:source,defaultText:opt_default,data:translation})}return this.add(translation)}console.warn("Missing Translation Service in ",this.cls_.name);if(opt_default===undefined)opt_default="NO TRANSLATION SERVICE OR DEFAULT";return this.add(opt_default)},function add(){if(this.content){this.content.add_(arguments,this)}else{this.add_(arguments,this)}return this},function toE(){return this},function add_(cs,parentNode){if(cs.length==1&&typeof cs[0]==="string"){var sanitized=this.sanitizeText(cs[0]);this.childNodes.push(sanitized);this.onAddChildren(sanitized);return this}var es=[];var Y=this.__subSubContext__;for(var i=0;i<cs.length;i++){var c=cs[i];if(c===undefined||c===null){}else if(c.toE){var e=c.toE(null,Y);if(foam.core.Slot.isInstance(e)){var v=this.slotE_(c);if(Array.isArray(v)){for(var j=0;j<v.length;j++){var u=v[j];es.push(u.toE?u.toE(null,Y):u)}}else{es.push(v.toE?v.toE(null,Y):v)}}else{es.push(e)}}else if(Array.isArray(c)){for(var j=0;j<c.length;j++){var v=c[j];es.push(v.toE?v.toE(null,Y):v)}}else if(c.then){this.add(this.PromiseSlot.create({promise:c}))}else if(typeof c==="function"){throw new Error("Unsupported")}else{es.push(c)}}if(es.length){for(var i=0;i<es.length;i++){if(foam.u2.Element.isInstance(es[i])){es[i].parentNode=parentNode}else if(es[i].cls_&&es[i].cls_.id==="foam.u2.Entity"){}else{es[i]=this.sanitizeText(es[i])}}this.childNodes.push.apply(this.childNodes,es);this.onAddChildren.apply(this,es)}return this},function addBefore(reference){var children=[];for(var i=1;i<arguments.length;i++){children.push(arguments[i])}return this.insertAt_(children,reference,true)},function removeAllChildren(){var cs=this.childNodes;while(cs.length){this.removeChild(cs[0])}return this},function setChildren(slot){var l=function(){this.removeAllChildren();this.add.apply(this,slot.get())}.bind(this);this.onDetach(slot.sub(l));l();return this},function repeat(s,e,f){for(var i=s;i<=e;i++){f.call(this,i)}return this},function daoSlot(dao,sink){var slot=foam.dao.DAOSlot.create({dao:dao,sink:sink});this.onDetach(slot);return slot},function select(dao,f,update,opt_comparator){var es={};var self=this;var listener=this.RenderSink.create({dao:dao,comparator:opt_comparator,addRow:function(o){if(self.state===foam.u2.Element.UNLOADED)return;if(update){o=o.clone();o.propertyChange.sub(function(){o.copyFrom(dao.put(o.clone()))})}self.startContext({data:o});var e=f.call(self,o);if(e===undefined)this.__context__.warn(self.SELECT_BAD_USAGE);self.endContext();if(es[o.id]){self.replaceChild(es[o.id],e)}else{self.add(e)}es[o.id]=e},cleanup:function(){for(var key in es)es[key]&&es[key].remove();es={}}},this);listener=this.MergedResetSink.create({delegate:listener},this);this.onDetach(dao.listen(listener));listener.delegate.paint();return this},function call(f,args){f.apply(this,args);return this},function callIf(bool,f,args){if(bool)f.apply(this,args);return this},function callIfElse(bool,iff,elsef,args){(bool?iff:elsef).apply(this,args);return this},function forEach(array,fn){if(foam.core.Slot.isInstance(array)){this.add(array.map(a=>this.E().forEach(a,fn)))}else{array.forEach(fn.bind(this))}return this},function outputInnerHTML(out){var cs=this.childNodes;for(var i=0;i<cs.length;i++){out(cs[i])}return out},function createOutputStream(){var buf="";var Element=foam.u2.Element;var Entity=this.Entity;var f=function templateOut(){for(var i=0;i<arguments.length;i++){var o=arguments[i];if(o===null||o===undefined){}else if(typeof o==="string"){buf+=o}else if(typeof o==="number"){buf+=o}else if(Element.isInstance(o)||Entity.isInstance(o)){o.output(f)}}};f.toString=function(){return buf};return f},function write(){this.document.body.insertAdjacentHTML("beforeend",this.outerHTML);this.load();return this},function toString(){return this.cls_.id+"(id="+this.id+", nodeName="+this.nodeName+", state="+this.state+")"},function insertAt_(children,reference,before){var i=this.childNodes.indexOf(reference);if(i===-1){this.__context__.warn("Reference node isn't a child of this.");return this}if(!Array.isArray(children))children=[children];var Y=this.__subSubContext__;children=children.map(e=>{e=e.toE?e.toE(null,Y):e;e.parentNode=this;return e});var index=before?i:i+1;this.childNodes.splice.apply(this.childNodes,[index,0].concat(children));this.state.onInsertChildren.call(this,children,reference,before?"beforebegin":"afterend");return this},function addClass_(oldClass,newClass){if(oldClass===newClass)return;if(oldClass)this.removeClass(oldClass);if(newClass){if(!this.CSS_CLASSNAME_PATTERN.test(newClass)){console.log("!!!!!!!!!!!!!!!!!!! Invalid CSS ClassName: ",newClass);throw"Invalid CSS classname"}this.classes[newClass]=true;this.onSetClass(newClass,true)}},function slotAttr_(key,value){var self=this;var l=function(){self.setAttribute(key,value.get())};this.onDetach(value.sub(l));l()},function slotStyle_(key,v){var self=this;var l=function(value){self.style_(key,v.get())};this.onDetach(v.sub(l));l()},function style_(key,value){this.css[key]=value;this.onSetStyle(key,value);return this},function slotE_(slot){var self=this;var ctx=this.__subSubContext__;function nextE(){var oldCtx=self.__subSubContext__;self.__subSubContext__=ctx;var e=slot.get();if(e===undefined||e===null||e===""){e=self.E("SPAN")}else if(Array.isArray(e)){if(e.length){if(typeof e[0]==="string"){e[0]=self.E("SPAN").add(e[0])}}else{e=self.E("SPAN")}}else if(!foam.u2.Element.isInstance(e)){e=self.E("SPAN").add(e)}self.__subSubContext__=oldCtx;return e}var e=nextE();var l=this.framed(function(){if(self.state!==self.LOADED){return}var first=Array.isArray(e)?e[0]:e;if(first&&first.state==first.INITIAL){first.onload.sub(foam.events.oneTime(l));return}var tmp=self.E();self.insertBefore(tmp,first);if(Array.isArray(e)){for(var i=0;i<e.length;i++){if(e[i].state===e[i].LOADED){e[i].remove();e[i].detach()}}}else{if(e.state===e.LOADED){e.remove();e.detach()}}var e2=nextE();self.insertBefore(e2,tmp);tmp.remove();e=e2});this.onDetach(slot.sub(l));return e},function addEventListener_(topic,listener,opt_args){var el=this.el_();el&&el.addEventListener(topic,listener,opt_args||false)},function removeEventListener_(topic,listener){var el=this.el_();el&&el.removeEventListener(topic,listener)},function output_(out){out("<",this.nodeName);if(this.id!==null)out(' id="',this.id.replace?this.id.replace(/"/g,"&quot;"):this.id,'"');var first=true;if(this.hasOwnProperty("classes")){var cs=this.classes;for(var key in cs){if(!cs[key])continue;if(first){out(' class="');first=false}else{out(" ")}out(key)}if(!first)out('"')}if(this.hasOwnProperty("css")){first=true;var cs=this.css;for(var key in cs){var value=cs[key];if(first){out(' style="');first=false}out(key,":",value,";")}if(!first)out('"')}if(this.hasOwnProperty("attributes")){var as=this.attributes;for(var i=0;i<as.length;i++){var attr=as[i];var name=attr.name;var value=attr.value;if(value!==false){out(" ",name,'="');out(foam.String.isInstance(value)?value.replace(/"/g,"&quot;"):value);out('"')}}}if(!this.ILLEGAL_CLOSE_TAGS[this.nodeName]){var hasChildren=this.hasOwnProperty("childNodes")&&this.childNodes.length;if(hasChildren||!this.OPTIONAL_CLOSE_TAGS[this.nodeName]){out(">");if(hasChildren)this.outputInnerHTML(out);out("</",this.nodeName)}}out(">")}],listeners:[{name:"onKeyboardShortcut",code:function(evt){if(evt.type==="keydown"&&!this.KEYPRESS_CODES[evt.which])return;var action=this.keyMap_[this.evtToCharCode(evt)];if(action){action();evt.preventDefault();evt.stopPropagation()}}}]});
foam.CLASS({package:"foam.u2",name:"U2Context",exports:["E","registerElement","elementForName"],properties:[{name:"elementMap",factory:function(){return{}}}],methods:[{class:"foam.core.ContextMethod",name:"E",code:function E(ctx,opt_nodeName){var nodeName=(opt_nodeName||"DIV").toUpperCase();return(ctx.elementForName(nodeName)||foam.u2.Element).create({nodeName:nodeName},ctx)}},function registerElement(elClass,opt_elName){var key=opt_elName||elClass.name;this.elementMap[key.toUpperCase()]=elClass},function elementForName(nodeName){return this.elementMap[nodeName]}]});foam.SCRIPT({package:"foam.u2",name:"U2ContextScript",requires:["foam.u2.U2Context"],flags:["web"],code:function(){foam.__context__=foam.u2.U2Context.create().__subContext__}});
foam.CLASS({package:"foam.u2",name:"FObjectToERefinement",refines:"foam.core.FObject",methods:[function toE(args,X){return foam.u2.ViewSpec.createView({class:"foam.u2.DetailView",showActions:true,data:this},args,this,X)}]});
foam.CLASS({package:"foam.u2",name:"PropertyViewRefinements",refines:"foam.core.Property",requires:["foam.u2.TextField"],properties:[{name:"attribute",value:false},{class:"String",name:"placeholder"},{class:"foam.u2.ViewSpec",name:"view",value:{class:"foam.u2.TextField"}},{name:"visibility",adapt:function(o,n){if(foam.Object.isInstance(n))return foam.u2.DisplayMode.create(n);return foam.String.isInstance(n)?foam.u2.DisplayMode[n]:n},},{name:"createVisibility",adapt:function(o,n){if(foam.Object.isInstance(n))return foam.u2.DisplayMode.create(n);return foam.String.isInstance(n)?foam.u2.DisplayMode[n]:n},factory:function(){return foam.u2.DisplayMode.RW}},{name:"readVisibility",adapt:function(o,n){if(foam.Object.isInstance(n))return foam.u2.DisplayMode.create(n);return foam.String.isInstance(n)?foam.u2.DisplayMode[n]:n},factory:function(){return foam.u2.DisplayMode.RO}},{name:"updateVisibility",adapt:function(o,n){if(foam.Object.isInstance(n))return foam.u2.DisplayMode.create(n);return foam.String.isInstance(n)?foam.u2.DisplayMode[n]:n},factory:function(){return foam.u2.DisplayMode.RW}},{class:"Boolean",name:"validationTextVisible",value:true},{class:"Boolean",name:"validationStyleEnabled",value:true},{class:"Int",name:"order",value:Number.MAX_SAFE_INTEGER},{class:"Boolean",name:"onKey"},{name:"__",transient:true,factory:function(){return{__proto__:this,toE:this.toPropertyView}}}],methods:[function toE(args,X){return this.toE_(args,X)},function toE_(args,X){var e=this.createElFromSpec_(this.view,args,X);e.addClass&&e.addClass("property-"+this.name);return e},function toPropertyView(args,X){return this.createElFromSpec_({class:"foam.u2.PropertyBorder",prop:this},args,X)},function createElFromSpec_(spec,args,X){let el=foam.u2.ViewSpec.createView(spec,args,this,X);if(X.data$&&!(args&&(args.data||args.data$))){el.data$=X.data$.dot(this.name)}el.fromProperty&&el.fromProperty(this);return el},function combineControllerModeAndVisibility_(data$,controllerMode$){const DisplayMode=foam.u2.DisplayMode;return foam.core.ProxySlot.create({delegate$:controllerMode$.map(controllerMode=>{var visibility=controllerMode.getVisibilityValue(this);if(foam.String.isInstance(visibility))visibility=foam.u2.DisplayMode[visibility];if(DisplayMode.isInstance(visibility))return foam.core.ConstantSlot.create({value:visibility});if(foam.Function.isInstance(visibility)){var slot=foam.core.ExpressionSlot.create({obj$:data$,code:visibility});slot.args;slot.code=function(){return controllerMode.restrictDisplayMode(visibility.apply(this,arguments))};return slot}if(foam.core.Slot.isInstance(visibility))return visibility;throw new Error("Property.visibility must be set to one of the following: (1) a value of DisplayMode, (2) a function that returns a value of DisplayMode, or (3) a slot whose value is a value of DisplayMode. Property "+this.name+" was set to "+visibility+" instead.")})})},function createVisibilityFor(data$,controllerMode$){var vis=this.combineControllerModeAndVisibility_(data$,controllerMode$);if(!this.readPermissionRequired&&!this.writePermissionRequired)return vis;const DisplayMode=foam.u2.DisplayMode;var perm=data$.map(data=>{if(!data||!data.__subContext__.auth)return DisplayMode.HIDDEN;var auth=data.__subContext__.auth;var propName=this.name.toLowerCase();var clsName=data.cls_.name.toLowerCase();var canRead=this.readPermissionRequired===false;return auth.check(null,`${clsName}.rw.${propName}`).then(function(rw){if(rw)return DisplayMode.RW;if(canRead)return DisplayMode.RO;return auth.check(null,`${clsName}.ro.${propName}`).then(ro=>ro?DisplayMode.RO:DisplayMode.HIDDEN)})});return foam.core.ArraySlot.create({slots:[vis,perm]}).map(arr=>{return arr[0].restrictDisplayMode(arr[1]||DisplayMode.HIDDEN)})}]});
foam.CLASS({package:"foam.u2",name:"StringDisplayWidthRefinement",refines:"foam.core.String",requires:["foam.u2.view.StringView"],properties:[{class:"Int",name:"displayWidth",expression:function(width){return width}},["view",{class:"foam.u2.view.StringView"}]]});
foam.CLASS({package:"foam.u2",name:"FormattedStringViewRefinement",refines:"foam.core.FormattedString",requires:["foam.u2.FormattedTextField"],properties:[{name:"view",factory:function(){return{class:"foam.u2.FormattedTextField",formatter:this.formatter,returnFormatted:false}}}]});
foam.CLASS({package:"foam.u2",name:"ArrayViewRefinement",refines:"foam.core.Array",requires:["foam.u2.view.ArrayView"],properties:[["view",{class:"foam.u2.view.ArrayView"}]]});
foam.CLASS({package:"foam.u2",name:"EMailViewRefinement",refines:"foam.core.EMail",requires:["foam.u2.view.StringView"],properties:[{name:"view",value:{class:"foam.u2.view.StringView",writeView:{class:"foam.u2.TextField",type:"email"}}}]});
foam.CLASS({package:"foam.u2",name:"StringArrayViewRefinement",refines:"foam.core.StringArray",requires:["foam.u2.view.StringArrayView"],properties:[["view",{class:"foam.u2.view.StringArrayView"}]]});
foam.CLASS({package:"foam.u2",name:"DateViewRefinement",refines:"foam.core.Date",requires:["foam.u2.view.DateView"],properties:[["view",{class:"foam.u2.view.DateView"}]]});
foam.CLASS({package:"foam.u2",name:"DateTimeViewRefinement",refines:"foam.core.DateTime",requires:["foam.u2.view.DateTimeView"],properties:[["view",{class:"foam.u2.view.DateTimeView"}]]});
foam.CLASS({package:"foam.u2",name:"TimeViewRefinement",refines:"foam.core.Time",requires:["foam.u2.view.TimeView"],properties:[["view",{class:"foam.u2.view.TimeView"}]]});
foam.CLASS({package:"foam.u2",name:"FloatViewRefinement",refines:"foam.core.Float",requires:["foam.u2.view.FloatView"],properties:[["displayWidth",12],["view",{class:"foam.u2.view.FloatView"}]]});
foam.CLASS({package:"foam.u2",name:"IntViewRefinement",refines:"foam.core.Int",requires:["foam.u2.view.IntView"],properties:[["displayWidth",10],["view",{class:"foam.u2.view.IntView"}]]});
foam.CLASS({package:"foam.u2",name:"UnitValueViewRefinement",refines:"foam.core.UnitValue",requires:["foam.u2.view.CurrencyView"],properties:[["displayWidth",15],["view",{class:"foam.u2.view.CurrencyView",onKey:false}]]});
foam.CLASS({package:"foam.u2",name:"BooleanViewRefinement",refines:"foam.core.Boolean",requires:["foam.u2.CheckBox"],properties:[{name:"view",expression:function(label,checkboxLabelFormatter){return{class:"foam.u2.CheckBox",label:this.help,labelFormatter:checkboxLabelFormatter}}},{name:"checkboxLabelFormatter"}]});
foam.CLASS({package:"foam.u2",name:"ColorViewRefinement",refines:"foam.core.Color",requires:["foam.u2.MultiView","foam.u2.TextField","foam.u2.view.ColorPicker","foam.u2.view.ModeAltView","foam.u2.view.ReadColorView"],properties:[{name:"view",value:{class:"foam.u2.view.ModeAltView",readView:{class:"foam.u2.view.ReadColorView"},writeView:{class:"foam.u2.view.ColorEditView"}}}]});
foam.CLASS({package:"foam.u2",name:"FObjectPropertyViewRefinement",refines:"foam.core.FObjectProperty",requires:["foam.u2.view.FObjectPropertyView"],properties:[{name:"view",value:{class:"foam.u2.view.FObjectPropertyView"}},{name:"validationTextVisible",value:false},{name:"validationStyleEnabled",value:false}]});
foam.CLASS({package:"foam.u2",name:"FObjectArrayViewRefinement",refines:"foam.core.FObjectArray",properties:[{name:"view",expression:function(of){return{class:"foam.u2.view.TitledArrayView",of:of}}}]});
foam.CLASS({package:"foam.u2",name:"MapViewRefinement",refines:"foam.core.Map",properties:[{name:"view",value:{class:"foam.u2.view.MapView"}}]});
foam.CLASS({package:"foam.u2",name:"ClassViewRefinement",refines:"foam.core.Class",properties:[["view",{class:"foam.u2.ClassView"}]]});
foam.CLASS({package:"foam.u2",name:"ReferenceViewRefinement",refines:"foam.core.Reference",requires:["foam.u2.view.ReferencePropertyView"],properties:[["view",{class:"foam.u2.view.ReferencePropertyView"}]]});
foam.CLASS({package:"foam.u2",name:"EnumViewRefinement",refines:"foam.core.Enum",requires:["foam.u2.view.EnumView"],properties:[["view",{class:"foam.u2.view.EnumView"}],["tableCellView",function(obj){return this.get(obj).label}]]});
foam.CLASS({package:"foam.u2",name:"ObjectViewRefinement",refines:"foam.core.Object",requires:["foam.u2.view.AnyView"],properties:[["view",{class:"foam.u2.view.AnyView"}]]});
foam.CLASS({package:"foam.u2",name:"CodeViewRefinement",refines:"foam.core.Code",requires:["foam.u2.view.CodeView"],properties:[["view",{class:"foam.u2.view.CodeView"}]]});
foam.CLASS({package:"foam.u2",name:"DurationViewRefinement",refines:"foam.core.Duration",requires:["foam.u2.view.IntView","foam.u2.view.TableCellFormatterReadView"],properties:[["view",{class:"foam.u2.view.IntView",readView:{class:"foam.u2.view.TableCellFormatterReadView"}}]]});
foam.CLASS({package:"foam.u2",name:"PredicatePropertyRefinement",refines:"foam.mlang.predicate.PredicateProperty",requires:["foam.u2.view.FObjectPropertyView","foam.u2.view.FObjectView"],properties:[{name:"view",value:{class:"foam.u2.view.FObjectPropertyView",writeView:{class:"foam.u2.view.FObjectView",of:"foam.mlang.predicate.Predicate"}}}]});
foam.CLASS({package:"foam.u2",name:"ExprPropertyRefinement",refines:"foam.mlang.ExprProperty",requires:["foam.u2.view.FObjectPropertyView","foam.u2.view.FObjectView"],properties:[{name:"view",value:{class:"foam.u2.view.FObjectPropertyView",writeView:{class:"foam.u2.view.FObjectView",of:"foam.mlang.Expr"}}}]});
foam.CLASS({package:"foam.u2",name:"PasswordPropertyRefinement",refines:"foam.core.Password",requires:["foam.u2.view.PasswordView"],properties:[{name:"view",value:{class:"foam.u2.view.PasswordView",passwordIcon:true}}]});
foam.CLASS({package:"foam.u2",name:"ImageViewRefinement",refines:"foam.core.Image",requires:["foam.u2.tag.Image"],properties:[["view",{class:"foam.u2.tag.Image"}]]});
foam.CLASS({package:"foam.u2",name:"View",extends:"foam.u2.Element",exports:["data"],properties:[{name:"data",attribute:true},{class:"Enum",of:"foam.u2.DisplayMode",name:"mode",attribute:true,postSet:function(_,mode){this.updateMode_(mode)},expression:function(controllerMode){return controllerMode===foam.u2.ControllerMode.VIEW?foam.u2.DisplayMode.RO:foam.u2.DisplayMode.RW}}],methods:[function render(){this.SUPER();this.updateMode_(this.mode);this.setAttribute("title",this.error_$)},function updateMode_(){},function fromProperty(p){this.attr("name",p.name)}]});
foam.CLASS({package:"foam.u2",name:"Controller",extends:"foam.u2.Element",exports:["as data"]});
foam.CLASS({package:"foam.u2",name:"ActionViewRefinement",refines:"foam.core.Action",requires:["foam.u2.ActionView"],properties:[{name:"view",value:function(args,X){return{class:"foam.u2.ActionView",action:this}}}],methods:[function toE(args,X){var view=foam.u2.ViewSpec.createView(this.view,args,this,X);if(X.data$&&!(args&&(args.data||args.data$))){view.data$=X.data$}return view}]});
foam.CLASS({package:"foam.u2",name:"TableColumns",properties:[["name","tableColumns"],"columns"]});
foam.CLASS({package:"foam.u2",name:"SearchColumns",properties:[["name","searchColumns"],"columns"]});
foam.CLASS({package:"foam.u2",name:"ModelU2Refinements",refines:"foam.core.Model",properties:[{class:"String",name:"css",postSet:function(_,code){var css=foam.u2.CSS.create({code:code});css.name=css.name+"-"+this.id;this.axioms_.push(css)}},{class:"Boolean",name:"inheritCSS",value:true},{name:"tableColumns",postSet:function(_,cs){this.axioms_.push(foam.u2.TableColumns.create({columns:cs}))}},{name:"searchColumns",postSet:function(_,cs){this.axioms_.push(foam.u2.SearchColumns.create({columns:cs}))}}]});
foam.CLASS({package:"foam.u2",name:"HTMLValidator",extends:"foam.u2.DefaultValidator",axioms:[foam.pattern.Singleton.create()],methods:[function sanitizeText(text){return text}]});
foam.CLASS({package:"foam.u2",name:"HTMLElement",extends:"foam.u2.Element",requires:["foam.u2.HTMLValidator"],exports:["validator as elementValidator"],properties:[{class:"Proxy",of:"foam.u2.DefaultValidator",name:"validator",factory:function(){return this.HTMLValidator.create()}}]});
foam.CLASS({package:"foam.u2",name:"HTMLView",extends:"foam.u2.HTMLElement",css:"^ { padding: 6px 0; }",properties:[{name:"data",attribute:true}],methods:[function render(){this.SUPER();this.addClass();this.add(this.data$)}]});
foam.CLASS({package:"foam.u2",name:"MNRowFormatter",implements:["foam.u2.RowFormatter"],css:`
.mn-row {
height: 100%;
display: flex;
}
.mn-row .row-id {
flex-grow: 1;
}
.mn-row .row-data {
display: flex;
flex-grow: 3;
}
.mn-row .row-value {
flex-grow: 1;
background-color: #ddd;
justify-content: center;
align-items: center;
display: flex;
}
.mn-row .row-value.yes {
background-color: #0f0;
}
.mn-row .row-value.no {
background-color: #f00;
}
.mn-row .row-value * {
background-color: inherit;
}
`,methods:[function format(data){if(!data){console.log("Render missing data");return`<div class="mn-row"></div>`}var dataMarkup="";var innerData=data.data;for(var i=0;i<innerData.length;i++){var datum=innerData[i];dataMarkup+=`<div class="row-value ${datum?"yes":"no"}">
${datum?"&#10003;":"&#215;"}
</div>`}return`<div class="mn-row">
<div class="row-id">${data.id}</div>
<div class="row-data">
${dataMarkup}
</div>
</div>`}]});
foam.CLASS({package:"foam.u2",name:"ProgressView",extends:"foam.u2.View",css:`
^ {
width: 183px;
}
`,properties:[["nodeName","progress"]],methods:[function render(){this.addClass(this.myClass()).attrs({max:100}).attrSlot().follow(this.data$)}]});
foam.CLASS({package:"foam.u2",name:"PropertyBorder",extends:"foam.u2.Element",requires:["foam.core.ArraySlot","foam.core.ConstantSlot","foam.u2.borders.ExpandableBorder","foam.u2.DisplayMode","foam.u2.tag.CircleIndicator"],imports:["theme?"],messages:[{name:"HELP",message:"Help"},{name:"LEARN_MORE",message:"Click to learn more"}],css:`
^ {
display: flex;
flex-direction: column;
align-items: flex-start;
justify-content: center;
gap: 0.4rem;
width: 100%;
}
^ .error input, ^ .error input:focus {
border-color: /*%DESTRUCTIVE3%*/ red !important;
}
^colorText {
color: /*%DESTRUCTIVE3%*/ red;
}
^label {
line-height: 1;
min-height: 1em;
width: 100%;
}
^errorText {
display: flex;
align-items: center;
line-height: 1.25;
/*
Have to use this style here since nanos uses CSS resets to
set 1 rem = 10px instead of the default 16px
May cause weird styling outside nanos
*/
font-size: 1.2rem;
min-height: 1.25em;
justify-content: flex-start;
gap: 0.2rem;
}
^errorText svg {
width: 1rem;
height: 1rem;
}
^propHolder {
display: flex;
align-items: center;
justify-content: space-between;
width: 100%;
gap: 0.2rem
}
^propHolder > :first-child{
display: flex;
align-items: center;
justify-content: flex-start;
gap: 0.4rem;
width: 100%;
}
`,properties:["prop",{class:"Map",name:"viewArgs",},{class:"Map",name:"config",},{class:"Boolean",name:"reserveLabelSpace",value:true,},["helpEnabled",false]],methods:[function render(){var self=this;this.prop=this.prop.clone().copyFrom(this.config);var prop=this.prop;this.SUPER();var data=this.__context__.data;var errorSlot=prop.validateObj&&prop.validationTextVisible?data.slot(prop.validateObj):this.ConstantSlot.create({value:null});var modeSlot=this.prop.createVisibilityFor(this.__context__.data$,this.controllerMode$);var visibilitySlot=modeSlot.map(m=>m!=foam.u2.DisplayMode.HIDDEN);var colorSlot=this.__context__.data$.dot(prop.name).map(v=>!!v);this.addClass().show(visibilitySlot).add(this.slot(function(reserveLabelSpace,prop$label){let el=this.E().addClasses([this.myClass("label"),"p-semiBold"]);return prop$label?el.call(prop.labelFormatter,[data,prop]):reserveLabelSpace?el:undefined})).start().addClass(this.myClass("propHolder")).start().add(prop.view$.map(v=>{return this.E().add(prop.toE_({...self.viewArgs,mode$:modeSlot},this.__context__)).style({"flex-grow":1,"max-width":"100%"}).enableClass("error",errorSlot.and(colorSlot))})).add(prop.units$).end().callIf(prop.help,function(){this.start().addClass(self.myClass("helper-icon")).start("",{tooltip:self.LEARN_MORE}).start(self.CircleIndicator,{icon:self.theme?self.theme.glyphs.helpIcon.getDataUrl({fill:self.theme.black}):"/images/question-icon.svg",size:20}).on("click",()=>{self.helpEnabled=!self.helpEnabled}).end().end().end()}).end().start().addClass(this.myClass("errorText")).enableClass(this.myClass("colorText"),colorSlot).show(modeSlot.map(m=>m==foam.u2.DisplayMode.RW)).start({class:"foam.u2.tag.Image",data:"/images/inline-error-icon.svg",embedSVG:true}).show(errorSlot.and(colorSlot)).end().add(" ",errorSlot).end().callIf(prop.help,function(){this.start(self.ExpandableBorder,{expanded$:self.helpEnabled$,title:self.HELP}).style({"flex-basis":"100%",width:"100%"}).start("p").add(prop.help).end().end()})}]});
foam.CLASS({package:"foam.u2",name:"LoadingSpinner",extends:"foam.u2.View",imports:["theme"],css:`
^{
position: relative;
border-radius: 50%;
display: flex;
align-items: center;
justify-content: center;
flex-direction: column;
}
^.hidden {
display: none;
}
^ .processing-notice {
padding-top: 8px;
text-align: center;
}`,properties:[{class:"Boolean",name:"isHidden",value:false},{class:"Boolean",name:"showText",value:false},{class:"String",name:"text"},{class:"Int",name:"angle"},"size"],methods:[function render(){this.SUPER();this.addClass(this.myClass()).enableClass("hidden",this.isHidden$).start().style({width:foam.core.Int.isInstance(this.size)?this.size+"px":this.size}).start("svg").attrs({width:"100%",viewBox:"0 0 24 24","transform-origin":"center",preserveAspectRatio:"xMidYMid meet"}).start("g").style({"transform-origin":"center","transform-box":"fill-box",transform:this.angle$.map(a=>"rotate("+a+"deg)")}).start("path").attrs({d:"M12 0C14.5832 3.08049e-08 17.0975 0.833605 19.1691 2.3769C21.2407 3.92019 22.7589 6.09077 23.4982 8.56598C24.2374 11.0412 24.1582 13.6889 23.2722 16.1155C22.3863 18.542 20.741 20.6179 18.5808 22.0346C16.4207 23.4512 13.861 24.133 11.2824 23.9785C8.70379 23.824 6.24386 22.8416 4.26828 21.1772C2.29271 19.5128 0.906976 17.2553 0.317073 14.7403C-0.272831 12.2253 -0.0354082 9.5871 0.994048 7.21784L3.74025 8.41109C2.96766 10.1892 2.78948 12.1691 3.23219 14.0565C3.67491 15.944 4.71487 17.6382 6.1975 18.8873C7.68013 20.1364 9.52626 20.8737 11.4615 20.9896C13.3967 21.1056 15.3176 20.5939 16.9388 19.5308C18.5599 18.4676 19.7947 16.9097 20.4596 15.0886C21.1245 13.2675 21.1839 11.2804 20.6291 9.42284C20.0743 7.56524 18.9349 5.93626 17.3803 4.77805C15.8256 3.61984 13.9387 2.99424 12 2.99424L12 0Z",fill:this.theme?this.theme.primary3:"#406dea"}).end().end().end().end().start().addClasses(["p","processing-notice"]).show(this.showText$).add(this.text).end();this.tick()},function show(){this.isHidden=false;this.tick()},function hide(){this.isHidden=true}],listeners:[{name:"tick",isFramed:"true",code:function(){if(this.isHidden)return;this.angle=(this.angle+3)%360;this.tick()}}]});
foam.CLASS({package:"foam.u2",name:"ListCreateController",extends:"foam.u2.stack.StackView",requires:["foam.u2.DetailView","foam.u2.TableView"],exports:["createLabel","dao","data as stack","data","detailView","createDetailView","factory","memento","summaryView","showActions"],properties:["dao",{name:"summaryView",value:{class:"foam.u2.TableView"}},{name:"detailView",value:{class:"foam.u2.DetailView"}},{name:"createDetailView",value:{class:"foam.u2.DetailView"}},{name:"factory",value:function(){return this.dao.of.create()}},{class:"String",name:"createLabel"},["showActions",true],"memento"],methods:[function render(){this.push(this.ListController)},function push(view){this.data.push(view,this)},function back(){this.data.back()}],actions:[{name:"create",code:function(){this.data.push(this.detailView)}}],classes:[{name:"ListController",extends:"foam.u2.Element",imports:["createLabel","dao","memento","stack","summaryView"],exports:["as data"],properties:[{name:"selection",postSet:function(o,n){this.memento=n?n.id:""}}],methods:[function render(){this.start(this.CREATE,this.createLabel&&{label:this.createLabel}).style({float:"right"}).end().tag(this.summaryView,{data:this.dao,selection$:this.selection$});var self=this;this.selection$.sub(function(){if(self.selection){var selection=self.selection;self.stack.push(function(){return foam.u2.ListCreateController.ViewController.create({obj:selection},self)})}})}],actions:[function create(X){this.stack.push(function(){return foam.u2.ListCreateController.CreateController.create(null,X)})}],listeners:[function onMementoChange(){if(this.memento){var self=this;this.dao.find(this.memento).then(function(obj){self.selection=obj})}else{this.selection=null}}]},{name:"CreateController",extends:"foam.u2.Element",imports:["createDetailView","detailView","stack","dao","factory","showActions"],exports:["as data"],properties:[{name:"obj",factory:function(){return this.factory()}}],methods:[function render(){var view=this.createDetailView?this.createDetailView:this.detailView;this.tag(view,{data:this.obj});if(this.showActions)this.add(this.CANCEL,this.SAVE)}],actions:[function cancel(X){this.stack.back()},function save(X){this.dao.put(this.obj);this.stack.back()}]},{name:"ViewController",extends:"foam.u2.Element",imports:["stack","detailView","showActions"],exports:["as data"],properties:[{name:"obj",factory:function(){return this.factory()}}],methods:[function render(){this.tag(this.detailView,{data:this.obj,controllerMode:foam.u2.ControllerMode.VIEW});if(this.showActions)this.add(this.BACK)}],actions:[function back(X){this.stack.back()}]}]});
foam.CLASS({package:"foam.u2",name:"CSSToken",properties:[{class:"String",name:"name"},{class:"String",name:"description"},{name:"value",preSet:function(o,d){var f=!d||foam.util.isPrimitive(d)||foam.Function.isInstance(d);if(!f){this.__context__.warn("Trying to set invalid token value:"+d);return o}return d}},{name:"fallback",preSet:function(o,d){var f=!d||foam.util.isPrimitive(d);if(!f){this.__context__.warn("Set Token fallback to non-primitive:"+d);return o}return d}},"sourceCls_"],methods:[function toSummary(){return`name: ${this.name}, value: ${this.value}, fallback: ${this.fallback}`},function installInClass(cls){var axiom=this;axiom.sourceCls_=cls;Object.defineProperty(cls,foam.String.constantize(this.name),{get:function(){return axiom}})},function installInProto(proto){this.installInClass(proto)}]});
foam.CLASS({package:"foam.u2",name:"CSSTokenRefinement",refines:"foam.core.Model",properties:[{name:"cssTokens",class:"AxiomArray",of:"foam.u2.CSSToken",adapt:function(_,a,prop){if(!a)return[];if(!Array.isArray(a)){var cs=[];for(var key in a){cs.push(foam.u2.CSSToken.create({name:key,value:a[key]}))}return cs}return foam.core.AxiomArray.ADAPT.value.call(this,_,a,prop)},adaptArrayElement:function(o,prop){if(Array.isArray(o)){return foam.u2.CSSToken.create({name:o[0],value:o[1]})}return foam.core.AxiomArray.ADAPT_ARRAY_ELEMENT.value.call(this,o,prop)}}]});
foam.CLASS({package:"foam.u2",name:"ColorToken",extends:"foam.u2.CSSToken",requires:["foam.u2.CSSToken"],properties:[{class:"Int",name:"hoverModifier",value:-20},{class:"Int",name:"activeModifier",value:-40},{class:"Int",name:"disabledModifier",value:40},{class:"String",name:"onLight",value:"$Black"},{class:"String",name:"onDark",value:"$White"}],methods:[function installInClass(cls){this.SUPER(cls);let ax=this;["hover","active","disabled"].forEach(a=>{let n=`${ax.name}$${a}`;Object.defineProperty(cls,foam.String.constantize(n),{get:function(){return foam.u2.CSSToken.create({name:n,value:function(e){return e.LIGHTEN(e.TOKEN("$"+ax.name),ax[`${a}Modifier`])},fallback:ax.fallback})}})});["","hover","active","disbaled"].forEach(a=>{let n=a?`${ax.name}$${a}$foreground`:ax.name+"$foreground";Object.defineProperty(cls,foam.String.constantize(n),{get:function(){return foam.u2.CSSToken.create({name:n,value:function(e){return e.FOREGROUND(e.TOKEN(a?`$${ax.name}$${a}`:"$"+ax.name),e.TOKEN(ax.onLight),e.TOKEN(ax.onDark))}})}})})}]});
foam.CLASS({package:"foam.u2",name:"CSSTokens",cssTokens:{Blue50:"#D7E4FF",Blue100:"#96B8F9",Blue200:"#6795EE",Blue300:"#366EDC",Blue400:"#0A4AC6",Blue500:"#04338D",Blue600:"#022568",Blue700:"#011B4E",Yellow100:"#FFF3BF",Yellow200:"#FFEFAC",Yellow300:"#F9E48B",Yellow400:"#F5DB6B",Yellow500:"#DCC252",Yellow600:"#BF9C06",Yellow700:"#846B02",Yellow50:"#FFFCEC",Orange50:"#FFEEE2",Orange100:"#FFC499",Orange200:"#F9A264",Orange300:"#F79651",Orange400:"#FC7F27",Orange500:"#EC6D14",Orange600:"#B04A01",Orange700:"#773100",Purple50:"#F5EEFF",Purple100:"#CEAFF6",Purple200:"#B98AF5",Purple300:"#9863DD",Purple400:"#8843DF",Purple500:"#702AC8",Purple600:"#4D1299",Purple700:"#2B0061",Green50:"#E8FFED",Green100:"#9AECAC",Green200:"#77D98D",Green300:"#59D374",Green400:"#34CF56",Green500:"#06A92A",Green600:"#02801D",Green700:"#005112",Red50:"#FFEFF0",Red100:"#FA9095",Red200:"#F05B63",Red300:"#E93F48",Red400:"#E11721",Red500:"#C40610",Red600:"#96060D",Red700:"#650005",Grey50:"#F7F7F7",Grey100:"#EFEFEF",Grey200:"#DADADA",Grey300:"#A8A8A8",Grey400:"#8D8D8D",Grey500:"#6F6F6F",Grey600:"#525252",Grey700:"#393939",warmGrey50:"#FBF9F6",warmGrey100:"#EDEAE5",warmGrey200:"#E7E4DF",warmGrey300:"#D1CDC5",warmGrey400:"#B1AEA7",warmGrey500:"#969289",warmGrey600:"#747067",warmGrey700:"#545048",Black50:"#373737",Black100:"#292929",Black200:"#202020",Black300:"#1B1B1B",Black400:"#1C1C1C",Black500:"#0F0F0F",Black600:"#0C0C0C",Black700:"#0D0D0D",Primary50:"$Blue50",Primary100:"$Blue100",Primary200:"$Blue200",Primary300:"$Blue300",Primary400:"$Blue400",Primary500:"$Blue500",Primary600:"$Blue600",Primary700:"$Blue700",White:"#FFFFFF",Black:"#000000",Error:"#E11721",Info:"#FC7F27",Warn:"#F5DB6B",Success:"#34CF56"}});
foam.CLASS({package:"foam.u2.view",name:"SearchViewWrapper",extends:"foam.u2.View",requires:["foam.mlang.predicate.True","foam.parse.QueryParser"],imports:["searchManager","memento"],css:`
^ {
background-color: /*%WHITE%*/ #ffffff;
border-bottom: 1px solid #e9e9e9;
color: /*%BLACK%*/ #1e1f21;
padding: 0;
}
^ .form-element-container {
background-color: #f6f9f9;
border-top: 1px solid #e9e9e9;
}
^ .section {
padding: 8px 16px;
}
^ .section:first-of-type {
display: flex;
align-items: center;
}
^ .section:first-of-type label {
position: initial;
margin: 0 0 0 8px;
}
^ .foam-u2-search-TextSearchView {
position: relative;
}
^ .foam-u2-search-GroupBySearchView .foam-u2-tag-Select {
background-color: rgba(0, 0, 0, 0);
border: 0;
width: 100%;
}
^ .foam-u2-search-GroupBySearchView .foam-u2-tag-Select > option:hover {
background-color: rgba(164, 179, 184, 0.3);
}
^ .foam-u2-search-GroupBySearchView .foam-u2-tag-Select > option {
color: /*%BLACK%*/ #1e1f21;
font-weight: normal;
font-style: normal;
font-stretch: normal;
line-height: 1.6;
letter-spacing: 0.2px;
padding: 0 21px;
}
`,properties:[{name:"searchView",required:true},{name:"checkbox",},{class:"Boolean",name:"active",},{name:"searchViewElement_"},"container_","property","dao",{class:"Boolean",name:"firstTime_",value:true},"view_",{name:"queryParser",factory:function(){return this.QueryParser.create({of:this.dao.of||this.__subContext__.lookup(this.property.forClass_)})}}],methods:[function render(){this.SUPER();this.addClass(this.myClass()).start().addClass("section").tag({class:"foam.u2.CheckBox"},{label:this.property.label},this.checkbox$).end().start("div",null,this.container_$).addClass("section").addClass("form-element-container").show(this.active$).end();this.checkbox.data$.sub(this.checkboxChanged);var predicate=this.getPredicateFromMemento();if(predicate)this.checkbox.data=true},function getPredicateFromMemento(){if(this.memento&&this.memento.head.length>0){var predicate=this.queryParser.parseString(this.memento.head);if(predicate){return predicate.partialEval()}}}],listeners:[function checkboxChanged(){this.active=!this.active;var self=this;if(this.active){if(this.firstTime_){this.container_.tag(this.searchView,{property:this.property,dao:this.dao},this.view_$);var predicate=this.getPredicateFromMemento();if(predicate){this.view_.restoreFromPredicate(predicate)}this.searchManager.add(this.view_$.get());this.firstTime_=false}if(this.view_){this.view_.onDetach(self.view_.predicate$.sub(function(){var pred;if(Object.keys(self.view_.predicate).length>0&&!foam.mlang.predicate.True.isInstance(self.view_.predicate))pred=self.view_.predicate.toMQL&&self.view_.predicate.toMQL();if(pred){self.memento.head=pred?pred:""}else{self.memento.head=""}}))}}else{if(this.view_)this.view_.clear()}}]});
foam.CLASS({package:"foam.u2.view",name:"StringArrayRowView",extends:"foam.u2.view.ArrayView",properties:[{name:"valueView",value:{class:"foam.u2.TextField"}}]});
foam.CLASS({package:"foam.u2.borders",name:"BrowserSupportBorder",extends:"foam.u2.Element",css:`
^browser-message {
margin-right: 20%;
float: right;
}
`,messages:[{name:"BROWSER_SUPPORT",message:"This application is optimized for "}],methods:[function init(){this.start().addClass(this.myClass()).start("div",null,this.content$).addClass(this.myClass("content")).end().end();if(!this.isChrome()){var tmp=this.content;this.content=undefined;this.start("div").addClass(this.myClass("browser-message")).add(this.BROWSER_SUPPORT).start("a").attrs({href:"https://www.google.com/chrome/"}).add("Google Chrome").end().end();this.content=tmp}},function isChrome(){return navigator.userAgent.includes("Chrome")&&navigator.vendor.includes("Google Inc")}]});
foam.CLASS({package:"foam.u2.borders",name:"NullBorder",extends:"foam.u2.Element",properties:[{class:"StringArray",name:"cssClasses"}],methods:[function render(){this.addClasses(this.cssClasses).tag("",{},this.contents$)}]});
foam.CLASS({package:"foam.u2.borders",name:"CardBorder",extends:"foam.u2.Element",css:`
^ {
min-height: 60px;
background-color: /*%WHITE%*/ #ffffff;
border: solid 1px /*%GREY4%*/;
border-radius: 5px;
padding: 16px;
transition: all 0.2s linear;
}
`,methods:[function render(){this.addClass()}]});
foam.CLASS({package:"foam.u2.borders",name:"TopBorderCard",extends:"foam.u2.View",css:`
^container {
width: 100%;
padding: 2.4rem;
background: #ffffff;
border: 1px solid/*%GREY5%*/ #f5f7fa;
border-top: none;
border-bottom-left-radius: 4px;
border-bottom-right-radius: 4px;
}
^bar {
width: 100%;
height: 8px;
border-top-left-radius: 4px;
border-top-right-radius: 4px;
}
`,properties:[{class:"Color",name:"color"}],methods:[function init(){this.addClass().start().addClass(this.myClass("bar")).style({background:this.color$,border:"1px solid"+this.color$}).end().start("div",null,this.content$).addClass(this.myClass("container")).end()}]});
foam.CLASS({package:"foam.u2.borders",name:"BackgroundCard",extends:"foam.u2.View",css:`
^ {
width: 100%;
padding: 2.4rem;
border-radius: 4px;
overflow: auto;
}
^.disablePadding {
padding: 0;
}
`,properties:[{class:"Color",name:"backgroundColor"},{class:"Boolean",name:"padding",value:true}],methods:[function init(){this.addClass().enableClass("disablePadding",this.padding$.map(v=>!v)).style({background:this.backgroundColor$}).tag("",null,this.content$)}]});
foam.CLASS({package:"foam.u2.borders",name:"CollapseBorder",extends:"foam.u2.Controller",requires:["foam.u2.ActionView","foam.u2.tag.Image"],css:`
^ {
position: relative;
padding: 0.8rem;
display: flex;
flex-direction: column;
}
^.expanded {
}
^control {
display: inline;
position: relative;
width: 30px;
}
^toolbar {
display: flex;
flex-direction: row;
justify-content: space-between;
align-items: center;
left: 1.5vmin;
top: max(-12px, -2vmin);
color: #666;
cursor: pointer;
/* button overrides */
width: 100%;
border: none;
background: none;
}
^.expanded > ^toolbar {
padding-bottom: 0.8rem;
}
^toggle-button {
font-size: inherit !important;
border: none;
outline: none;
}
^toggle-button:focus {
background-color: /*%WHITE%*/ #ffffff;
}
^control {
transition: transform 0.3s;
}
^.expanded ^control {
transform: rotate(90deg);
}
^control svg {
max-height: 1em;
fill: /*%BLACK%*/ #000;
}
`,properties:["title",{class:"Boolean",name:"expanded",value:true},{name:"label",value:"▽"},{class:"String",name:"controlGlyph",value:"next"}],methods:[function init(){this.addClass(this.myClass()).enableClass("expanded",this.expanded$).start("button").attrs({name:this.TOGGLE.name,"aria-label":this.TOGGLE.ariaLabel}).on("click",this.toggle.bind(this)).addClass(this.myClass("toolbar")).start("span").addClass("p-bold").add(this.title$).end().start(this.Image,{glyph:this.controlGlyph}).addClass(this.myClass("control")).end().end().start("div",null,this.content$).show(this.expanded$).addClass(this.myClass("content")).end()}],actions:[function toggle(){this.expanded=!this.expanded}]});
foam.CLASS({package:"foam.u2.borders",name:"ExpandableBorder",extends:"foam.u2.Element",css:`
^ {
box-shadow: 0px 10px 15px rgba(0, 0, 0, 0.1), 0px 4px 6px rgba(0, 0, 0, 0.05);
display: inline-block;
max-height: 0;
overflow: hidden;
transition: max-height 0.5s;
}
^.expanded { 
max-height: 500px;
}
^container{
background:/*%WHITE%*/ white; 
border-radius: 4px;
border: 1px solid /*%GREY3%*/ #B2B6BD;
padding: 24px;
}
^ h6{
font-size: 1.4rem;
font-weight: 600;
margin: 0px;
padding-bottom: 12px;
}
`,properties:["expanded","title"],methods:[function init(){this.addClass(this.myClass()).enableClass("expanded",this.expanded$).start().addClass(this.myClass("container")).start("h6").add(this.title).end().start("div",null,this.content$).style({overflow:"auto"}).end().end()}]});
foam.CLASS({package:"foam.u2.borders",name:"SpacingBorder",extends:"foam.u2.Element",imports:["returnExpandedCSS"],properties:[{class:"String",name:"padding",value:`1rem`},{class:"String",name:"margin"}],methods:[function render(){this.style({margin:this.margin$.map(this.returnExpandedCSS),padding:this.padding$.map(this.returnExpandedCSS)})}]});
foam.CLASS({package:"foam.u2.borders",name:"SplitScreenBorder",extends:"foam.u2.Element",css:`
^ {
height: 100vh;
width: 100vw;
background: /*%WHITE%*/ #fff;
}
^ .left-block {
width: 55vw;
display: inline-block;
background: transparent;
text-align: center;
}
^ .right-block {
width: 43vw;
display: inline-block;
background: transparent;
height: auto;
float: right;
}
^content {
width: -moz-available;
width: -webkit-fill-available;
width: fill-available;
position: relative;
padding-bottom: 4vh;
}
^ .wrapper-outer {
overflow: auto;
height: 100%;
}
`,properties:["leftPanel","rightPanel"],methods:[function init(){this.addClass().start().addClass("wrapper-outer").start().addClass("left-block").start("div",null,this.leftPanel$).addClass(this.myClass("content")).end().end().start().addClass("right-block").start("div",null,this.rightPanel$).addClass(this.myClass("content")).end().end().end()}]});
foam.CLASS({package:"foam.u2.borders",name:"SplitScreenGridBorder",extends:"foam.u2.Element",imports:["displayWidth"],requires:["foam.u2.layout.Grid","foam.u2.layout.GUnit"],css:`
^{
display: flex;
flex-direction: column;
justify-content: center;
padding: 0 4vw;
background-color: /*%WHITE%*/ white;
height: 100%;
}
^grid {
grid-gap: clamp(1rem, 1.5vmax, 5rem);
}
/* vertically center the 2 sides of splitscreen */
^split-screen {
display: flex;
align-content: center;
justify-content: center;
align-items: center;
}
/* TODO: Remove this when U3 allows non-E() adds */
^split-screen > *{
width: 100%;
display: flex;
justify-content: center;
}
`,properties:["leftPanel","rightPanel",{name:"columnsConfig",flags:["web"],value:{class:"foam.u2.layout.GridColumns",columns:12,lgColumns:6,xlColumns:6}}],methods:[function init(){this.SUPER();var right=this.GUnit.create({columns:this.columnsConfig}).addClass(this.myClass("split-screen")).tag("",null,this.rightPanel$);var left=this.GUnit.create({columns:this.columnsConfig}).addClass(this.myClass("split-screen")).tag("",null,this.leftPanel$);var grid=this.Grid.create();grid.addClass(this.myClass("grid")).add(left,right);this.start().addClass(this.myClass()).add(grid).end()}]});
foam.CLASS({package:"foam.u2.borders",name:"SideViewBorder",extends:"foam.u2.Element",css:`
^ {
position: relative;
}
^side {
position: absolute;
overflow: hidden;
visibility: hidden;
width: 0;
height: 100%;
top: 0;
right: 0;
padding: 10px;
border-left: 4px solid rgba(0,0,0,0.4);
display: flex;
flex-direction: column;
gap: 10px;
z-index: 1000;
}
^side^open {
width: 50%;
background-color: rgba(255,255,255,0.7);
visibility: visible;
}
^side ^container {
flex-grow: 1;
overflow-x: hidden;
overflow-y: auto;
}
`,properties:[{class:"Boolean",name:"sideVisible"},{class:"foam.u2.ViewSpec",name:"sideView",factory:function(){return{class:"foam.u2.borders.NullBorder"}}},{class:"FObjectProperty",name:"sideData"}],methods:[function init(){const self=this;this.start("div",null,this.content$).end().start().addClass(this.myClass("side")).enableClass(this.myClass("open"),this.sideVisible$).startContext({data:this}).tag(this.HIDE,{buttonStyle:"PRIMARY"}).endContext().add(this.slot(function(sideView){return this.E().addClass(self.myClass("container")).startContext({data$:self.sideData$}).tag(self.sideView).endContext()})).end()}],actions:[{name:"hide",label:"close",code:function(){this.sideVisible=false}}]});foam.ENUM({package:"foam.u2.borders",name:"LoadingLevel",flags:["java"],values:[{name:"idle"},{name:"pending"},{name:"loading"}]});
foam.CLASS({package:"foam.u2.borders",name:"LoadingBorder",extends:"foam.u2.Element",flags:[],requires:["foam.u2.LoadingSpinner","foam.u2.borders.LoadingLevel"],messages:[{name:"MESSAGE",message:"Please wait..."}],css:`
^ {
position: relative;
}
^overlay {
position: absolute;
top: 0; left: 0;
/* extra width covers right-side padding of wizard */
width: calc(100% + 2*48px);
height: 100%;
background-color: hsla(216,33%,97%,0.7);
/* negative margin covers left-side padding of wizard */
margin: 0 -48px;
z-index: 1000;
/* ease-out animation makes things feel stable */
transition: all 200ms ease-out;
}
^container {
position: absolute;
top: 50%;
left: 50%;
transform: translate(-50%, -50%);
padding: 15pt;
transition: all 200ms ease-out;
}
^overlay .foam-u2-LoadingSpinner {
/* ease-out animation makes things feel stable */
transition: all 200ms ease-out;
}
^overlay .foam-u2-LoadingSpinner img {
width: 100%;
height: 100%;
}
^overlay^idle {
opacity: 0;
pointer-events: none;
}
^overlay^pending {
opacity: 1;
background-color: hsla(216,33%,97%,0);
pointer-events: none;
}
^message {
display: none;
line-height: 32pt;
font-size: 24pt;
margin-left: 15pt;
color: /*%PRIMARY3*/ #604aff;
}
`,properties:[{name:"loadingLevel",class:"Enum",of:"foam.u2.borders.LoadingLevel"}],methods:[function init(){var self=this;this.addClass(this.myClass()).start().addClass(this.myClass("overlay")).addClass(this.loadingLevel$.map(v=>this.myClass(v.name.toLowerCase()))).add(this.slot(loadingLevel=>{return loadingLevel!=this.LoadingLevel.IDLE?this.E().start().addClass(this.myClass("container")).tag(this.LoadingSpinner,{size:32}).start().addClass(this.myClass("message")).add(this.MESSAGE).end().end():this.E()})).end().start("div",null,this.content$).on("keypress",this.onKey).on("keydown",this.onKey).addClass(this.myClass("content")).end()}],listeners:[function onKey(e){if(this.loadingLevel==this.LoadingLevel.LOADING){e.preventDefault();e.stopPropagation()}}]});
foam.CLASS({package:"foam.u2.borders",name:"Block",extends:"foam.u2.Element",css:`
^ {
border-left: 4px solid /*%GREY4%*/ #e7eaec;
padding-left: 16px;
}
`,methods:[function render(){this.addClass()}]});
foam.CLASS({package:"foam.u2.borders",name:"MultiBorder",extends:"foam.u2.Element",properties:[{class:"Array",name:"borders"}],methods:[function init(){let e=this;for(let border of this.borders){e=e.start(border)}e.tag("div",null,this.content$)}]});
foam.CLASS({package:"foam.nanos.u2.navigation",name:"IFrameTopNavigation",extends:"foam.u2.View",css:`
.foam-comics-DAOControllerView {
margin: 96 auto;
}
`,methods:[function render(){this.addClass(this.myClass())}]});
foam.CLASS({package:"foam.version",name:"VersionTrait",properties:[{class:"Int",name:"version_",value:-1},{class:"Boolean",name:"deleted_"}]});
foam.CLASS({package:"foam.version",name:"VersionedClass",axioms:[foam.pattern.Multiton.create({property:"of"})],requires:["foam.core.Model"],properties:[{class:"Class",name:"of",required:true},{class:"String",name:"package",factory:function(){return this.of.package}},{class:"String",name:"name",factory:function(){return`Versioned${this.of.name}`}},{class:"String",name:"id",factory:function(){return`${this.package}.${this.name}`}},{class:"FObjectProperty",of:"Model",name:"versionedModel",factory:function(){return this.Model.create({package:this.package,name:this.name,extends:this.of.id,implements:["foam.version.VersionTrait"]})}},{name:"versionedCls",factory:function(){return this.buildClass_()}}],methods:[function init(){this.validate();this.SUPER()},function buildClass_(){this.versionedModel.validate();var cls=this.versionedModel.buildClass();cls.validate();this.__subContext__.register(cls);foam.package.registerClass(cls);return this.versionedModel.buildClass()}]});
foam.CLASS({package:"foam.version",name:"VersionedClassFactory",requires:["foam.version.VersionTrait","foam.version.VersionedClass"],methods:[function get(cls){return this.VersionTrait.isSubClass(cls)?cls:this.VersionedClass.create({of:cls}).versionedCls}]});
foam.CLASS({package:"foam.version",name:"VersionedClassFactorySingleton",extends:"foam.version.VersionedClassFactory",axioms:[foam.pattern.Singleton.create()]});
foam.CLASS({package:"foam.dao",name:"NullJournal",extends:"foam.dao.AbstractF3FileJournal",flags:["java"],implements:["foam.dao.Journal"],methods:[{name:"put",type:"FObject",args:["Context x","String prefix","DAO dao","foam.core.FObject obj"],},{name:"remove",type:"FObject",args:["Context x","String prefix","DAO dao","foam.core.FObject obj"],},{name:"replay",args:[{name:"x",type:"Context"},{name:"dao",type:"foam.dao.DAO"}],}]});foam.INTERFACE({package:"foam.dao",name:"Sink",methods:[{name:"put",args:[{name:"obj",type:"Any"},{name:"sub",type:"foam.core.Detachable"}]},{name:"remove",args:[{name:"obj",type:"Any"},{name:"sub",type:"foam.core.Detachable"}]},{name:"eof"},{name:"reset",args:[{name:"sub",type:"foam.core.Detachable"}]}]});
foam.CLASS({package:"foam.dao",name:"ProxySink",implements:["foam.dao.Sink"],properties:[{class:"Proxy",of:"foam.dao.Sink",name:"delegate",factory:function(){return foam.dao.ArraySink.create()}}]});
foam.CLASS({package:"foam.dao",name:"AbstractSink",implements:["foam.dao.Sink"],methods:[{name:"put",code:function(){},},{name:"remove",code:function(){},},{name:"eof",code:function(){},},{name:"reset",code:function(){},}]});
foam.CLASS({package:"foam.dao",name:"PipeSink",extends:"foam.dao.ProxySink",axioms:[{class:"foam.box.Remote",clientClass:"foam.dao.ClientSink"}],properties:["dao"],methods:[function reset(sub){this.SUPER(sub);this.dao.select(this.delegate)}]});
foam.CLASS({package:"foam.dao",name:"ResetListener",extends:"foam.dao.ProxySink",methods:[{name:"put",code:function put(_,sub){this.reset(sub)},},{name:"remove",code:function remove(_,sub){this.reset(sub)},}]});
foam.CLASS({package:"foam.dao",name:"DAOSlot",implements:["foam.core.Slot"],extends:"foam.dao.ResetListener",flags:[],properties:[{name:"dao",postSet:function(){this.start_()}},{name:"sink",postSet:function(_,s){this.value=s;this.start_()}},{name:"value"},{name:"subscription",postSet:function(old,nu){old&&old.detach();this.onDetach(nu)}},{class:"Int",name:"batch",value:0}],methods:[function sub(l){return arguments.length===1?this.SUPER("propertyChange","value",l):this.SUPER.apply(this,arguments)},function get(){return this.value},function set(){},function start_(){if(!this.dao||!this.sink)return;this.subscription=this.dao.listen(this);this.update()},function reset(){this.update()}],listeners:[{name:"update",isMerged:100,code:function(){var batch=++this.batch;var self=this;this.dao.select(this.sink.clone()).then(function(s){if(self.batch!==batch)return;self.value=s})}}]});
foam.CLASS({package:"foam.dao",name:"QuickSink",extends:"foam.dao.AbstractSink",axioms:[{class:"foam.box.Remote",clientClass:"foam.dao.ClientSink"}],properties:[{class:"Function",name:"putFn"},{class:"Function",name:"removeFn"},{class:"Function",name:"eofFn"},{class:"Function",name:"resetFn"}],methods:[function put(){return this.putFn&&this.putFn.apply(this,arguments)},function remove(){return this.removeFn&&this.removeFn.apply(this,arguments)},function eof(){return this.eofFn&&this.eofFn.apply(this,arguments)},function reset(){return this.resetFn&&this.resetFn.apply(this,arguments)}]});
foam.CLASS({package:"foam.dao",name:"AnonymousSink",implements:["foam.dao.Sink"],flags:[],axioms:[{class:"foam.box.Remote",clientClass:"foam.dao.ClientSink"}],properties:["sink"],methods:[function put(obj,sub){var s=this.sink;s&&s.put&&s.put(obj,sub)},function remove(obj,sub){var s=this.sink;s&&s.remove&&s.remove(obj,sub)},function eof(){var s=this.sink;s&&s.eof&&s.eof()},function reset(sub){var s=this.sink;s&&s.reset&&s.reset(sub)}]});
foam.CLASS({package:"foam.dao",name:"PredicatedSink",extends:"foam.dao.ProxySink",properties:[{class:"FObjectProperty",of:"foam.mlang.predicate.Predicate",required:true,name:"predicate"}],methods:[{name:"put",code:function put(obj,sub){if(this.predicate.f(obj))this.delegate.put(obj,sub)},},{name:"remove",code:function remove(obj,sub){if(this.predicate.f(obj))this.delegate.remove(obj,sub)},}]});
foam.CLASS({package:"foam.dao",name:"LimitedSink",extends:"foam.dao.ProxySink",properties:[{class:"Long",name:"limit"},{name:"count",class:"Int",value:0}],methods:[{name:"put",code:function put(obj,sub){if(this.count++>=this.limit){sub&&sub.detach()}else{this.delegate.put(obj,sub)}},},{name:"remove",code:function remove(obj,sub){if(this.count++>=this.limit){sub&&sub.detach()}else{this.delegate.remove(obj,sub)}},}]});
foam.CLASS({package:"foam.dao",name:"SkipSink",extends:"foam.dao.ProxySink",properties:[{class:"Long",name:"skip"},{name:"count",class:"Int",value:0}],methods:[{name:"put",code:function put(obj,sub){if(this.count<this.skip){this.count++;return}this.delegate.put(obj,sub)},},{name:"remove",code:function remove(obj,sub){this.reset(sub)},},{name:"reset",code:function(sub){this.count=0;this.delegate.reset(sub)},}]});
foam.CLASS({package:"foam.dao",name:"OrderedSink",extends:"foam.dao.ProxySink",properties:[{class:"FObjectProperty",type:"foam.mlang.order.Comparator",required:true,name:"comparator"},{class:"List",name:"array",factory:function(){return[]}}],methods:[{name:"put",code:function put(obj,sub){this.array.push(obj)},},{name:"eof",code:function eof(){var comparator=this.comparator;this.array.sort(function(o1,o2){return comparator.compare(o1,o2)});var sub=foam.core.FObject.create();var detached=false;sub.onDetach(function(){detached=true});for(var i=0;i<this.array.length;i++){this.delegate.put(this.array[i],sub);if(detached)break}},},{name:"remove",code:function remove(obj,sub){},}]});
foam.CLASS({package:"foam.dao",name:"DedupSink",extends:"foam.dao.ProxySink",properties:[{class:"Object",name:"results",hidden:true,factory:function(){return{}}}],methods:[{name:"put",code:function put(obj,sub){if(!this.results[obj.id]){this.results[obj.id]=true;return this.delegate.put(obj,sub)}},}]});
foam.CLASS({package:"foam.dao",name:"DescribeSink",implements:["foam.dao.Sink"],flags:[],methods:[function put(o){o.describe()},function remove(){},function eof(){},function reset(){}]});
foam.CLASS({package:"foam.dao",name:"FnSink",implements:["foam.dao.Sink"],flags:[],axioms:[{class:"foam.box.Remote",clientClass:"foam.dao.ClientSink"}],properties:[{name:"fn",swiftRequiresEscaping:true}],methods:[{name:"put",code:function(obj,s){this.fn("put",obj,s)},},{name:"remove",code:function(obj,s){this.fn("remove",obj,s)},},function eof(){this.fn("eof")},{name:"reset",code:function(s){this.fn("reset",s)},}]});
foam.CLASS({package:"foam.dao",name:"FramedSink",extends:"foam.dao.ProxySink",flags:[],properties:[{class:"Array",name:"calls"}],methods:[{name:"put",code:function(obj,s){this.calls.push(["put",[obj,s]]);this.flushCalls()}},{name:"remove",code:function(obj,s){this.calls.push(["remove",[obj,s]]);this.flushCalls()}},{name:"eof",code:function(){this.calls.push(["eof",[]]);this.flushCalls()}},{name:"reset",code:function(s){this.calls=[["reset",[s]]];this.flushCalls()}}],listeners:[{name:"flushCalls",isMerged:100,code:function(){var calls=this.calls;this.calls=[];for(var i=0,o;o=calls[i];i++){this.delegate[o[0]].apply(this.delegate,o[1])}}}]});
foam.CLASS({package:"foam.dao",name:"DAOSink",implements:["foam.dao.Sink"],properties:[{class:"foam.dao.DAOProperty",name:"dao"}],axioms:[{class:"foam.box.Remote",clientClass:"foam.dao.ClientSink"}],methods:[{name:"put",code:function(o){this.dao.put(o)},},{name:"remove",code:function(o){this.dao.remove(o)},},{name:"eof",code:function(){},},{name:"reset",code:function(){this.dao.removeAll()},}]});
foam.CLASS({package:"foam.dao",name:"JournalSink",implements:["foam.dao.Sink"],flags:[],properties:[{name:"journal",class:"FObjectProperty",of:"foam.dao.Journal"},{name:"dao",class:"foam.dao.DAOProperty"},{name:"prefix",class:"String"}],methods:[{name:"put",code:function(o){var x=this.__context__;this.journal.put(x,"",this.dao,o)}},{name:"remove",code:function(o){var x=this.__context__;this.journal.remove(x,"",this.dao,o)}},{name:"eof",code:function(){}},{name:"reset",code:function(){console.warn("use of unimplemented JournalSink.reset()")}}]});foam.INTERFACE({package:"foam.dao",name:"DAO",skeleton:true,constants:[{name:"RESET_CMD",type:"String",value:"RESET_CMD"},{name:"LAST_CMD",type:"String",value:"LAST_CMD"},{name:"PURGE_CMD",type:"String",value:"PURGE_CMD"}],methods:[{name:"put",async:true,type:"FObject",args:["FObject obj"]},{name:"put_",async:true,type:"FObject",args:"Context x, FObject obj"},{name:"remove",async:true,type:"FObject",args:["FObject obj"]},{name:"remove_",async:true,type:"FObject",args:"Context x, FObject obj"},{name:"find",async:true,type:"FObject",args:"Object id"},{name:"find_",async:true,type:"FObject",args:"Context x, Object id"},{name:"select",async:true,type:"foam.dao.Sink",args:"foam.dao.Sink sink"},{name:"select_",async:true,type:"foam.dao.Sink",args:["Context x",{name:"sink",type:"foam.dao.Sink",},{name:"skip",type:"Long",},{name:"limit",type:"Long",},{name:"order",type:"foam.mlang.order.Comparator",},{name:"predicate",type:"foam.mlang.predicate.Predicate",}]},{name:"removeAll",async:true,},{name:"removeAll_",async:true,args:["Context x",{name:"skip",type:"Long",},{name:"limit",type:"Long",},{name:"order",type:"foam.mlang.order.Comparator",},{name:"predicate",type:"foam.mlang.predicate.Predicate",}]},{name:"listen",type:"Detachable",async:true,args:[{name:"sink",type:"foam.dao.Sink",},{name:"predicate",type:"foam.mlang.predicate.Predicate",}]},{name:"listen_",type:"Detachable",async:true,args:["Context x",{name:"sink",type:"foam.dao.Sink",},{name:"predicate",type:"foam.mlang.predicate.Predicate",}]},{name:"pipe",type:"Void",args:"foam.dao.Sink sink"},{name:"pipe_",type:"Void",args:["Context x","foam.dao.Sink sink",{name:"predicate",type:"foam.mlang.predicate.Predicate",}]},{name:"where",type:"foam.dao.DAO",args:[{name:"predicate",type:"foam.mlang.predicate.Predicate",}]},{name:"orderBy",type:"foam.dao.DAO",args:"foam.mlang.order.Comparator comparator"},{name:"skip",type:"foam.dao.DAO",args:"Long count"},{name:"limit",type:"foam.dao.DAO",args:"Long count"},{name:"inX",type:"foam.dao.DAO",args:"Context x"},{name:"cmd",async:true,type:"Any",args:"Any obj"},{name:"cmd_",async:true,type:"Any",args:"Context x, Any obj"},{name:"getOf",flags:["java"],type:"Class",}]});foam.ENUM({package:"foam.dao",name:"DOP",values:[{name:"PUT",label:"put"},{name:"PUT_",label:"put_"},{name:"FIND",label:"find"},{name:"FIND_",label:"find_"},{name:"SELECT",label:"select"},{name:"SELECT_",label:"select_"},{name:"REMOVE",label:"remove"},{name:"REMOVE_",label:"remove_"},{name:"REMOVE_ALL",label:"removeAll"},{name:"REMOVE_ALL_",label:"removeAll_"},{name:"CMD",label:"cmd"},{name:"CMD_",label:"cmd_"}]});
foam.CLASS({package:"foam.dao",name:"PredicatedDualDelegateDAO",extends:"foam.dao.ProxyDAO",properties:[{class:"foam.dao.DAOProperty",name:"predicatedDelegate"},{class:"foam.mlang.predicate.PredicateProperty",name:"predicate",factory:function(){return foam.mlang.predicate.True.create()},}],methods:[{name:"put_",},{name:"remove_",},{name:"getDelegateFor",type:"foam.dao.DAO",args:[{name:"obj",type:"foam.core.FObject"}],}]});
foam.CLASS({package:"foam.dao",name:"ProxyDAO",extends:"foam.dao.AbstractDAO",requires:["foam.dao.NullDAO","foam.dao.ProxyListener"],properties:[{class:"Proxy",of:"foam.dao.DAO",name:"delegate",forwards:["put_","remove_","find_","select_","removeAll_","cmd_","listen_"],topics:["on"],factory:function(){return this.NullDAO.create()},postSet:function(old,nu){if(old)this.on.reset.pub()},},{name:"of",expression:function(delegate){return delegate.of},swiftExpressionArgs:["delegate$of"],swiftExpression:"return delegate$of as! ClassInfo",}],methods:[{name:"listen_",code:function listen_(context,sink,predicate){var listener=this.ProxyListener.create({delegate:sink,predicate:predicate,dao:this},context);listener.onDetach(this.sub("propertyChange","delegate",listener.update));listener.update();return listener},},{name:"fclone",type:"FObject",}],axioms:[{buildJavaClass:function(cls){cls.extras.push(`
public ProxyDAO(foam.core.X x, foam.dao.DAO delegate) {
setX(x);
setDelegate(delegate);
}
public ProxyDAO(foam.core.X x, foam.core.ClassInfo of, foam.dao.DAO delegate) {
setX(x);
setOf(of);
setDelegate(delegate);
}
`)}}]});
foam.CLASS({package:"foam.dao",name:"ProxyListener",flags:["js","swift"],implements:["foam.dao.Sink"],properties:[{name:"predicate",},{class:"Proxy",of:"foam.dao.Sink",name:"delegate"},{name:"innerSub",type:"foam.core.Detachable",postSet:function(_,s){if(s)this.onDetach(s)},},{class:"foam.dao.DAOProperty",name:"dao",}],methods:[{name:"put",code:function put(obj,s){this.delegate.put(obj,this)},},function outputJSON(outputter){outputter.output(this.delegate)},{name:"remove",code:function remove(obj,s){this.delegate.remove(obj,this)},},{name:"reset",code:function reset(s){this.delegate.reset(this)},}],listeners:[{name:"update",code:function(){var old=this.innerSub;old&&old.detach();this.innerSub=this.dao&&this.dao.delegate&&this.dao.delegate.listen_(this.__context__,this,this.predicate);this.reset()}}]});
foam.CLASS({package:"foam.dao",name:"PromisedDAO",extends:"foam.dao.AbstractDAO",properties:[{class:"Promised",of:"foam.dao.DAO",methods:["put_","remove_","find_","select_","removeAll_","listen_","cmd_"],name:"promise",factory:function(){return foam.core.Latch.create()}}],methods:[{name:"listen_",flags:["js"],code:function(x,sink,predicate){this.promise.then(function(dao){dao.listen_(x,sink,predicate)})}}]});
foam.CLASS({package:"foam.dao",name:"LocalStorageDAO",extends:"foam.dao.ArrayDAO",flags:[],properties:[{name:"name",label:"Store Name",class:"foam.core.String"}],methods:[function init(){var objs=localStorage.getItem(this.name);if(objs)this.array=foam.json.parseString(objs,this.__context__);this.on.put.sub(this.updated);this.on.remove.sub(this.updated)}],listeners:[{name:"updated",isMerged:true,mergeDelay:100,code:function(){localStorage.setItem(this.name,foam.json.stringify(this.array))}}]});foam.LIB({name:"foam.String",methods:[{name:"daoize",code:foam.Function.memoize1(function(str){return str.substring(0,1).toLowerCase()+str.substring(1)+"DAO"})}]});
foam.CLASS({package:"foam.dao",name:"InvalidArgumentException",extends:"foam.dao.ExternalException",properties:[{class:"String",name:"message"}]});
foam.CLASS({package:"foam.dao",name:"ArraySink",extends:"foam.dao.AbstractSink",constants:[{name:"PARSE_JSON",flags:["js"],value:function(json,opt_cls,opt_ctx){var cls=json.of||opt_cls;var array=json.array;if(!array)return foam.dao.ArraySink.create({of:cls},opt_ctx);if(foam.typeOf(cls)===foam.String)cls=(opt_ctx||foam).lookup(cls);return foam.dao.ArraySink.create({of:cls,array:foam.json.parse(array,cls,opt_ctx)},opt_ctx)}}],properties:[{class:"List",name:"array",adapt:function(old,nu){if(!this.of)return nu;var cls=this.of;for(var i=0;i<nu.length;i++){if(!cls.isInstance(nu[i]))nu[i]=cls.create(nu[i],this.__subContext__)}return nu},factory:function(){return[]},},{class:"Class",name:"of"},{name:"a",transient:true,getter:function(){this.__context__.warn("Use of deprecated ArraySink.a");return this.array}}],methods:[{name:"put",code:function put(o,sub){var cls=this.of;if(!cls){this.array.push(o);return}if(cls.isInstance(o))this.array.push(o);else this.array.push(cls.create(o,this.__subContext__))},},function outputJSON(outputter){outputter.start("{");var outputClassName=outputter.outputClassNames;if(outputClassName){outputter.nl().indent().out(outputter.maybeEscapeKey("class"),":",outputter.postColonStr,'"',this.cls_.id,'"')}var array=this.array;var outputComma=outputClassName;if(this.of){outputter.outputProperty(this,this.OF,outputComma);outputComma=true}if(array.length>0){if(outputComma)outputter.out(",");outputter.nl().indent().outputPropertyName(this.ARRAY).out(":",outputter.postColonStr).output(array,this.of)}outputter.nl().end("}")}]});
foam.CLASS({package:"foam.dao",name:"RemoveSink",extends:"foam.dao.AbstractSink",flags:["js","java"],implements:["foam.core.ContextAware"],properties:[{class:"foam.dao.DAOProperty",name:"dao"}],methods:[{name:"put",args:[{type:"Object",name:"obj"},{type:"foam.core.Detachable",name:"sub"}],code:function(obj,sub){this.dao.remove_(this.__context__,obj)},}]});
foam.CLASS({package:"foam.dao",name:"DAOCopySink",extends:"foam.dao.AbstractSink",properties:[{class:"Class",name:"of"},{class:"Object",name:"outputDAO",},{class:"Boolean",name:"cloneOnPut",value:true}],methods:[{name:"put",code:function put(o,sub){this.outputDAO.put(this.cloneOnPut?o.clone():o)},}]});foam.INTERFACE({package:"foam.dao",name:"DAOInterceptor",methods:[{name:"write",type:"foam.core.FObject",async:true,args:[{name:"context",type:"Context"},{name:"dao",type:"foam.dao.DAO"},{name:"obj",type:"FObject"},{name:"existing",type:"FObject"}]},{name:"read",type:"foam.core.FObject",async:true,args:[{name:"context",type:"Context"},{name:"dao",type:"foam.dao.DAO"},{name:"obj",type:"FObject"}]},{name:"remove",type:"foam.core.FObject",async:true,args:[{name:"context",type:"Context"},{name:"dao",type:"foam.dao.DAO"},{name:"obj",type:"FObject"}]}]});
foam.CLASS({package:"foam.dao",name:"AbstractDAODecorator",implements:["foam.dao.DAOInterceptor"],flags:[],methods:[function write(X,dao,obj,existing){return Promise.resolve(obj)},function read(X,dao,obj){return Promise.resolve(obj)},function remove(X,dao,obj){return Promise.resolve(obj)}]});
foam.CLASS({package:"foam.dao",name:"CompoundDAODecorator",flags:[],implements:["foam.dao.DAOInterceptor"],properties:[{class:"Array",name:"decorators"}],methods:[function write(X,dao,obj,existing){var i=0;var d=this.decorators;return Promise.resolve(obj).then(function a(obj){return d[i]?d[i++].write(X,dao,obj,existing).then(a):obj})},function read(X,dao,obj){var i=0;var d=this.decorators;return Promise.resolve(obj).then(function a(obj){return d[i]?d[i++].read(X,dao,obj).then(a):obj})},function remove(X,dao,obj){var i=0;var d=this.decorators;return Promise.resolve(obj).then(function a(obj){return d[i]?d[i++].remove(X,dao,obj).then(a):obj})}]});
foam.CLASS({package:"foam.dao",name:"InterceptedDAO",extends:"foam.dao.ProxyDAO",requires:["foam.mlang.sink.Count","foam.mlang.sink.GroupBy"],properties:[{name:"decorator"},{class:"foam.dao.DAOProperty",name:"dao",factory:function(){return this.delegate}}],methods:[{name:"put_",code:function(x,obj){var self=this;return(!obj.id?Promise.resolve(null):this.dao.find_(x,obj.id)).then(function(existing){return self.decorator.write(x,self.dao,obj,existing)}).then(function(obj){return self.delegate.put_(x,obj)})}},{name:"remove_",code:function(x,obj){var self=this;return this.decorator.remove(x,self.dao,obj).then(function(obj){if(obj)return self.delegate.remove_(x,obj);return Promise.resolve()})}},{name:"find_",code:function(x,id){var self=this;return this.delegate.find_(x,id).then(function(obj){return self.decorator.read(x,self.dao,obj)})}}]});
foam.CLASS({package:"foam.dao",name:"AbstractDAO",implements:["foam.dao.DAO"],abstract:true,requires:["foam.dao.ExternalException","foam.dao.FilteredDAO","foam.dao.InternalException","foam.dao.LimitedDAO","foam.dao.LimitedSink","foam.dao.OrderedDAO","foam.dao.OrderedSink","foam.dao.PipeSink","foam.dao.PredicatedSink","foam.dao.ProxyDAO","foam.dao.ResetListener","foam.dao.SkipDAO","foam.dao.SkipSink"],topics:[{name:"on",topics:["put","remove","reset"]}],properties:[{class:"Class",javaInfoType:"foam.core.AbstractObjectPropertyInfo",name:"of"},{javaInfoType:"foam.core.AbstractObjectPropertyInfo",name:"primaryKey",swiftExpressionArgs:["of"],swiftExpression:'return of.axiom(byName: "id") as! PropertyInfo',}],methods:[{name:"inX",code:function(x){return this.ProxyDAO.create({delegate:this},x)},},{name:"where",code:function where(p){foam.assert(foam.mlang.predicate.Predicate.isInstance(p),`DAO.where() was called with an argument that isn't a predicate!`);return this.FilteredDAO.create({delegate:this,predicate:p})},},{name:"orderBy",code:function orderBy(){return this.OrderedDAO.create({delegate:this,comparator:foam.compare.toCompare(Array.from(arguments))})},},{name:"skip",code:function skip(s){return this.SkipDAO.create({delegate:this,skip_:s})},},{name:"limit",code:function limit(l){return this.LimitedDAO.create({delegate:this,limit_:l})},},{name:"put",code:function(obj){return this.put_(this.__context__,obj)},},{name:"pipe",code:function(sink){this.pipe_(this.__context__,sink,undefined)},},{name:"pipe_",code:function(x,sink,predicate){var dao=this;var sink=this.PipeSink.create({delegate:sink,dao:this});var sub=this.listen(sink);sink.reset();return sub},},{name:"listen",code:function(sink){if(!foam.core.FObject.isInstance(sink)){sink=foam.dao.AnonymousSink.create({sink:sink},this)}return this.listen_(this.__context__,sink,undefined)},},{name:"listen_",code:function(x,sink,predicate){var mySink=this.decorateListener_(sink,predicate);var sub=foam.core.FObject.create();sub.onDetach(this.on.sub(function(s,on,e,obj){switch(e){case"put":mySink.put(obj,sub);break;case"remove":mySink.remove(obj,sub);break;case"reset":mySink.reset(sub);break}}));return sub},},{name:"decorateListener_",type:"foam.dao.Sink",args:[{name:"sink",type:"foam.dao.Sink"},{name:"predicate",type:"foam.mlang.predicate.Predicate"}],code:function decorateListener_(sink,predicate){if(predicate){return this.ResetListener.create({delegate:sink})}return sink},},{name:"decorateSink_",type:"foam.dao.Sink",args:[{name:"sink",type:"foam.dao.Sink"},{name:"skip",type:"Long"},{name:"limit",type:"Long"},{name:"order",type:"foam.mlang.order.Comparator"},{name:"predicate",type:"foam.mlang.predicate.Predicate"}],code:function decorateSink_(sink,skip,limit,order,predicate){if(limit!=undefined){sink=this.LimitedSink.create({limit:limit,delegate:sink})}if(skip!=undefined){sink=this.SkipSink.create({skip:skip,delegate:sink})}if(order!=undefined){sink=this.OrderedSink.create({comparator:order,delegate:sink})}if(predicate!=undefined){sink=this.PredicatedSink.create({predicate:predicate.partialEval?predicate.partialEval():predicate,delegate:sink})}return sink},},{name:"remove",code:function remove(obj){return this.remove_(this.__context__,obj)},},{name:"removeAll",code:function removeAll(){return this.removeAll_(this.__context__,undefined,undefined,undefined,undefined)},},function compareTo(other){if(!other)return 1;return this===other?0:foam.util.compare(this.$UID,other.$UID)},function prepareSink_(sink){if(!sink)return foam.dao.ArraySink.create();if(foam.Function.isInstance(sink))sink={put:sink,eof:function(){}};else if(sink==console||sink==console.log)sink={put:function(o){console.log(o,foam.json.Pretty.stringify(o))},eof:function(){}};else if(sink==globalThis.document)sink={put:function(o){foam.u2.DetailView.create({data:o}).write(document)},eof:function(){}};if(!foam.core.FObject.isInstance(sink)){sink=foam.dao.AnonymousSink.create({sink:sink})}return sink},{name:"select",code:function select(sink){return this.select_(this.__context__,this.prepareSink_(sink),undefined,undefined,undefined,undefined)},},{name:"find",code:function find(id){if(foam.mlang.predicate.Predicate.isInstance(id)){var self=this;return new Promise(function(resolve){self.where(id).limit(1).select().then(function(a){resolve(a.array.length?a.array[0]:null)})})}return this.find_(this.__context__,id)},},{name:"cmd_",code:function cmd_(x,obj){console.warn("Unrecognized command");return undefined},},{name:"cmd",code:function cmd(obj){return this.cmd_(this.__context__,obj)},},function eof(){},function reset(){},{name:"removeAll_",},function clone(){return this}],static:[{name:"decorateSink",type:"foam.dao.Sink",args:[{name:"x",type:"Context"},{name:"sink",type:"foam.dao.Sink"},{name:"skip",type:"Long"},{name:"limit",type:"Long"},{name:"order",type:"foam.mlang.order.Comparator"},{name:"predicate",type:"foam.mlang.predicate.Predicate"}],}],axioms:[{buildJavaClass:function(cls){cls.extras.push(`
public final static long MAX_SAFE_INTEGER = 9007199254740991l;
public Object getPK(foam.core.FObject obj) {
return getPrimaryKey().get(obj);
}
protected class DAOListener implements foam.core.Detachable {
protected Sink sink;
protected java.util.Collection listeners;
public DAOListener(Sink sink, java.util.Collection listeners) {
this.sink = sink;
this.listeners = listeners;
}
public void detach() {
listeners.remove(this);
}
public void put(foam.core.FObject obj) {
try {
sink.put(obj, this);
} catch (java.lang.Exception e) {
detach();
}
}
public void remove(foam.core.FObject obj) {
try {
sink.remove(obj, this);
} catch (java.lang.Exception e) {
detach();
}
}
public void reset() {
try {
sink.reset(this);
} catch (java.lang.Exception e) {
detach();
}
}
}
protected java.util.List<DAOListener> listeners_ = new java.util.concurrent.CopyOnWriteArrayList<DAOListener>();
protected void onPut(foam.core.FObject obj) {
java.util.Iterator<DAOListener> iter = listeners_.iterator();
while ( iter.hasNext() ) {
DAOListener s = iter.next();
s.put(obj);
}
}
protected void onRemove(foam.core.FObject obj) {
java.util.Iterator<DAOListener> iter = listeners_.iterator();
while ( iter.hasNext() ) {
DAOListener s = iter.next();
s.remove(obj);
}
}
protected void onReset() {
java.util.Iterator<DAOListener> iter = listeners_.iterator();
while ( iter.hasNext() ) {
DAOListener s = iter.next();
s.reset();
}
}
protected Sink prepareSink(Sink s) {
return s == null ? new ArraySink() : s;
}
public Sink select() {
return select(null);
}
public static Sink decorateDedupSink_(Sink sink) {
sink = new DedupSink(new java.util.HashSet(), sink);
return sink;
}
`)}}]});
foam.CLASS({package:"foam.dao",name:"FilteredDAO",extends:"foam.dao.ProxyDAO",requires:["foam.mlang.predicate.And"],properties:[{class:"FObjectProperty",of:"foam.mlang.predicate.Predicate",name:"predicate"}],methods:[{name:"find_",code:function find_(x,key){var predicate=this.predicate;return this.delegate.find_(x,key).then(function(o){return o&&predicate.f(o)?o:null})},},{name:"select_",code:function(x,sink,skip,limit,order,predicate){return this.delegate.select_(x,sink,skip,limit,order,predicate?this.And.create({args:[this.predicate,predicate]}):this.predicate)},},{name:"removeAll_",code:function removeAll_(x,skip,limit,order,predicate){return this.delegate.removeAll_(x,skip,limit,order,predicate?this.And.create({args:[this.predicate,predicate]}):this.predicate)},},{name:"listen_",code:function listen_(x,sink,predicate){return this.delegate.listen_(x,sink,predicate?this.And.create({args:[this.predicate,predicate]}):this.predicate)},}]});
foam.CLASS({package:"foam.dao",name:"DAOProperty",extends:"FObjectProperty",requires:["foam.dao.ProxyDAO"],properties:[{name:"view",value:{class:"foam.comics.InlineBrowserView"}},{name:"createVisibility",value:"HIDDEN"},["transient",true],["of","foam.dao.DAO"],{name:"javaInfoType",flags:["java"],value:"foam.core.AbstractDAOPropertyPropertyInfo"},{name:"adapt",value:function(o,v,prop){if(!v)return;if(foam.String.isInstance(v)&&this.__subContext__)return this.__subContext__[v];return foam.core.FObjectProperty.ADAPT.value.call(this,o,v,prop)}}],methods:[function installInProto(proto){this.SUPER(proto);var name=this.name;var prop=this;Object.defineProperty(proto,name+"$proxy",{get:function daoProxyGetter(){var proxy=prop.ProxyDAO.create({delegate:this[name]},this[name]);this[name+"$proxy"]=proxy;this.sub("propertyChange",name,function(_,__,___,s){proxy.delegate=s.get()});return proxy},configurable:true})}]});
foam.CLASS({package:"foam.dao",name:"PipelinePMDAO",extends:"foam.dao.ProxyDAO",implements:["foam.nanos.boot.NSpecAware"],requires:["foam.nanos.pm.PM"],properties:[{class:"Int",name:"level"},{name:"nSpec",class:"FObjectProperty",type:"foam.nanos.boot.NSpec"},{name:"classType",class:"Class",hidden:true},{name:"putName",class:"String",visibility:"RO"},{name:"findName",class:"String",visibility:"RO"},{name:"selectName",class:"String",visibility:"RO"},{name:"removeName",class:"String",visibility:"RO"},{name:"removeAllName",class:"String",visibility:"RO"},{name:"cmdName",class:"String",visibility:"RO"}],methods:[{name:"createName_",args:[{name:"name",type:"String "}],},{name:"createPM",args:[{name:"x",type:"Context"},{name:"op",type:"String"}],},{name:"createPipeline",},{name:"reset",args:[{name:"x",type:"X"},{name:"old",type:"PM"}],},{name:"put_",},{name:"find_",},{name:"select_",},{name:"remove_",},{name:"removeAll_",},{name:"cmd_",}],classes:[{name:"EndPipelinePMDAO",extends:"foam.dao.ProxyDAO",requires:["foam.nanos.pm.PM"],methods:[{name:"log",args:[{name:"x",type:"X"}],},{name:"put_",},{name:"find_",},{name:"select_",},{name:"remove_",},{name:"removeAll_",},{name:"cmd_",}]}]});foam.INTERFACE({package:"foam.dao",name:"SQLStatement",methods:[{name:"createStatement",type:"String"},{name:"prepareStatement",type:"Void",args:[{name:"stmt",}]}]});
foam.CLASS({package:"foam.dao",name:"CSVSink",extends:"foam.dao.AbstractSink",implements:["foam.core.Serializable"],properties:[{class:"String",name:"csv",view:"foam.u2.tag.TextArea",factory:function(){return this.outputter.toString()},},{class:"Class",name:"of",visibility:"HIDDEN"},{class:"StringArray",name:"props",factory:function(){if(!this.of)return[];if(tc=this.of.getAxiomByName("tableColumns"))return tc.columns;return this.of.getAxiomsByClass(foam.core.Property).filter(p=>!p.networkTransient).map(p=>p.name)},},{name:"outputter",class:"FObjectProperty",of:"foam.lib.csv.CSVOutputter",transient:true,factory:function(){return foam.lib.csv.CSVOutputterImpl.create({of:this.of,props:this.props})},}],methods:[{name:"put",code:function(obj){this.outputter.outputFObject(this.__context__,obj)},},{name:"eof",code:function(){this.csv=this.outputter.toString()},},{name:"reset",code:function(){this.outputter.flush();this.csv=""},}]});
foam.CLASS({package:"foam.dao",name:"PropertyCSVRefinement",refines:"foam.core.Property",properties:[{class:"Function",name:"toCSV",value:function(x,obj,outputter){outputter.outputValue(obj?this.f(obj):null)}},{class:"Function",name:"toCSVLabel",value:function(x,outputter){outputter.outputValue(this.name)}}]});
foam.CLASS({package:"foam.dao",name:"FObjectPropertyCSVRefinement",requires:["foam.lib.csv.PrefixedCSVOutputter"],refines:"foam.core.FObjectProperty",properties:[{name:"toCSV",value:function(x,obj,outputter){if(!this.of){outputter.outputValue(obj?this.f(obj):null);return}this.of.getAxiomsByClass(foam.core.Property).forEach(p=>{p.toCSV.call(p,x,obj?this.f(obj):null,outputter)})}},{name:"javaToCSV",class:"String",value:`
if ( of() instanceof foam.core.EmptyClassInfo ) {
outputter.outputValue(obj != null ? f(obj) : null);
return;
}
for ( foam.core.PropertyInfo p : (java.util.List<foam.core.PropertyInfo>) of().getAxiomsByClass(foam.core.PropertyInfo.class) ) {
p.toCSV(x, obj != null ? f(obj) : null, outputter);
}
`},{name:"toCSVLabel",class:"Function",value:function(x,outputter){if(!this.of){outputter.outputValue(this.name);return}outputter=this.PrefixedCSVOutputter.create({prefix:this.name+".",delegate:outputter});this.of.getAxiomsByClass(foam.core.Property).forEach(p=>{p.toCSVLabel.call(p,x,outputter)})}},{name:"javaToCSVLabel",class:"String",value:`
if ( of() instanceof foam.core.EmptyClassInfo ) {
outputter.outputValue(getName());
return;
}
outputter = new foam.lib.csv.PrefixedCSVOutputter.Builder(x)
.setPrefix(getName() + ".")
.setDelegate(outputter)
.build();
for ( foam.core.PropertyInfo p : (java.util.List<foam.core.PropertyInfo>) of().getAxiomsByClass(foam.core.PropertyInfo.class) ) {
p.toCSVLabel(x, outputter);
}
`}]});
foam.CLASS({package:"foam.dao",name:"LimitedDAO",extends:"foam.dao.ProxyDAO",properties:[{class:"Int",name:"limit_"}],methods:[{name:"select_",code:function select_(x,sink,skip,limit,order,predicate){return this.delegate.select_(x,sink,skip,limit!==undefined?Math.min(this.limit_,limit):this.limit_,order,predicate)},},function removeAll_(x,skip,limit,order,predicate){return this.delegate.removeAll_(x,skip,limit!==undefined?Math.min(this.limit_,limit):this.limit_,order,predicate)}]});
foam.CLASS({package:"foam.dao",name:"LockDAO",extends:"foam.dao.ProxyDAO",requires:["foam.core.Lock"],properties:[{name:"lock",class:"FObjectProperty",of:"foam.core.Lock",factory:function(){return this.Lock.create()}}],methods:[function put_(x,obj){return new Promise(resolve=>{this.lock.then(()=>{return this.delegate.put_(x,obj).then(o=>{resolve(o)})})})},function remove_(x,obj){return new Promise(resolve=>{this.lock.then(()=>{return this.delegate.remove_(x,obj).then(o=>{resolve(o)})})})},function removeAll_(x,sink,skip,limit,order,predicate){return new Promise(resolve=>{this.lock.then(()=>{return this.delegate.removeAll_(x,sink,skip,limit,order,predicate).then(o=>{resolve(o)})})})}]});
foam.CLASS({package:"foam.dao",name:"SkipDAO",extends:"foam.dao.ProxyDAO",properties:[{class:"Int",name:"skip_"}],methods:[{name:"select_",code:function select_(x,sink,skip,limit,order,predicate){return this.delegate.select_(x,sink,this.skip_,limit,order,predicate)},},function removeAll_(x,skip,limit,order,predicate){return this.delegate.removeAll_(x,this.skip_,limit,order,predicate)}]});
foam.CLASS({package:"foam.dao",name:"OrderedDAO",extends:"foam.dao.ProxyDAO",properties:[{class:"FObjectProperty",type:"foam.mlang.order.Comparator",name:"comparator"}],methods:[{name:"select_",code:function(x,sink,skip,limit,order,predicate){return this.delegate.select_(x,sink,skip,limit,order||this.comparator,predicate)},},{name:"removeAll_",code:function(x,skip,limit,order,predicate){return this.delegate.removeAll_(x,skip,limit,order||this.comparator,predicate)},}]});
foam.CLASS({package:"foam.dao",name:"InternalException",extends:"foam.core.FOAMException"});
foam.CLASS({package:"foam.dao",name:"ExternalException",extends:"foam.core.FOAMException"});
foam.CLASS({name:"UniqueConstraintException",package:"foam.dao",extends:"foam.core.FOAMException",});
foam.CLASS({package:"foam.dao",name:"CompositeRelationship",properties:[{name:"primaryRelationships",factory:function(){return[]}},{name:"secondaryRelationships",factory:function(){return[]}}],methods:[{name:"getPrimaryInverseNames",code:function(){return this.primaryRelationships.map(relationship=>relationship.inverseName)}},{name:"getPrimaryForwardNames",code:function(){return this.primaryRelationships.map(relationship=>relationship.forwardName)}},{name:"getSecondaryInverseNames",code:function(){return this.secondaryRelationships.map(relationship=>relationship.inverseName)}},{name:"getSecondaryForwardNames",code:function(){return this.secondaryRelationships.map(relationship=>relationship.forwardName)}}]});foam.INTERFACE({package:"foam.mlang.order",name:"Comparator",implements:["foam.dao.SQLStatement"],methods:[{name:"compare",type:"Integer",args:[{name:"o1",type:"Any"},{name:"o2",type:"Any"}]}]});
foam.CLASS({package:"foam.mlang.sink",name:"Count",extends:"foam.dao.AbstractSink",implements:["foam.core.Serializable"],properties:[{class:"Long",name:"value"},{class:"String",name:"label",value:"Count"}],methods:[{name:"put",code:function(){this.value++},},{name:"remove",code:function(){this.value--},},{name:"reset",code:function(){this.value=0},},function toString(){return"COUNT()"}]});
foam.CLASS({package:"foam.mlang.sink",name:"Sequence",extends:"foam.dao.AbstractSink",implements:["foam.core.Serializable"],properties:[{class:"Array",type:"foam.dao.Sink[]",name:"args"}],methods:[{name:"put",code:function(obj,s){this.args.forEach(function(a){a.put(obj,s)})},},{name:"remove",code:function(obj,s){this.args.forEach(function(a){a.remove(obj,s)})},},{name:"reset",code:function(s){this.args.forEach(function(a){a.reset(s)})},},function toString(){return"SEQ("+this.args.map(function(a){return a.toString()}).join(",")+")"}]});
foam.CLASS({package:"foam.mlang.sink",name:"NullSink",extends:"foam.dao.AbstractSink",implements:["foam.core.Serializable"],axioms:[foam.pattern.Singleton.create()]});foam.INTERFACE({package:"foam.mlang",name:"F",methods:[{name:"f",type:"Any",args:[{name:"obj",type:"Any"}]}]});foam.INTERFACE({package:"foam.mlang",name:"Expr",implements:["foam.dao.SQLStatement","foam.mlang.F"],methods:[{name:"partialEval",type:"foam.mlang.Expr"},{name:"authorize",flags:["java"],type:"Void",args:[{name:"x",type:"Context"}]}]});
foam.CLASS({package:"foam.mlang",name:"ExprProperty",extends:"FObjectProperty",flags:[],properties:[{name:"adapt",value:function(_,o,p){return p.adaptValue(o)}},{name:"type",value:"foam.mlang.Expr"},["javaJSONParser","foam.lib.json.ExprParser.instance()"],{name:"view",value:{class:"foam.u2.view.FObjectView",of:"foam.mlang.Expr"}}],methods:[function adaptValue(o){if(o===null)return foam.mlang.Constant.create({value:null});if(!o.f&&typeof o==="function")return foam.mlang.predicate.Func.create({fn:o});if(typeof o!=="object")return foam.mlang.Constant.create({value:o});if(o instanceof Date)return foam.mlang.Constant.create({value:o});if(Array.isArray(o))return foam.mlang.Constant.create({value:o});if(foam.core.AbstractEnum.isInstance(o))return foam.mlang.Constant.create({value:o});if(foam.core.FObject.isInstance(o)){if(!foam.Function.isInstance(o.f))return foam.mlang.Constant.create({value:o});return o}if(o.class&&this.__context__.maybeLookup(o.class)){return this.adaptValue(this.__context__.lookup(o.class).create(o,this.__subContext__))}if(foam.core.FObject.isSubClass(o)){return foam.mlang.Constant.create({value:o})}console.error("Invalid expression value: ",o)}]});
foam.CLASS({package:"foam.mlang",name:"ExprArrayProperty",extends:"FObjectArray",flags:[],requires:["foam.mlang.ExprProperty"],properties:[["of","foam.mlang.Expr"],{name:"adaptArrayElement",value:function(o){return this.ExprProperty.prototype.adaptValue.call(this,o)}}]});
foam.CLASS({package:"foam.mlang",name:"SinkProperty",extends:"FObjectProperty",flags:[],properties:[{name:"type",value:"foam.dao.Sink"},["javaJSONParser","foam.lib.json.FObjectParser.instance()"],{name:"view",value:{class:"foam.u2.view.FObjectView"}}],});foam.INTERFACE({package:"foam.mlang.predicate",name:"Predicate",implements:["foam.dao.SQLStatement"],methods:[{name:"f",type:"Boolean",args:[{name:"obj",type:"Any"}]},{name:"partialEval",type:"foam.mlang.predicate.Predicate"},{name:"toIndex",flags:["js"],args:[{name:"tail",type:"foam.dao.index.Index"}],type:"foam.dao.index.Index"},{name:"toDisjunctiveNormalForm",flags:["js","java"],javaSupport:false,type:"foam.mlang.predicate.Predicate"},{name:"authorize",flags:["java"],type:"Void",args:[{name:"x",type:"Context"}]}]});
foam.CLASS({package:"foam.mlang.predicate",name:"PredicateProperty",extends:"FObjectProperty",flags:[],properties:[["type","foam.mlang.predicate.Predicate"],{name:"adapt",value:function(_,o){if(typeof o==="function"&&!o.f)return foam.mlang.predicate.Func.create({fn:o});return o}}]});
foam.CLASS({package:"foam.mlang.predicate",name:"PredicateArray",extends:"FObjectArray",flags:[],properties:[{name:"of",value:"foam.mlang.predicate.Predicate"},["type","foam.mlang.predicate.Predicate[]"],{name:"adaptArrayElement",value:function(o){if(o===null)return foam.mlang.Constant.create({value:o});if(!o.f&&typeof o==="function")return foam.mlang.predicate.Func.create({fn:o});if(typeof o!=="object")return foam.mlang.Constant.create({value:o});if(Array.isArray(o))return foam.mlang.Constant.create({value:o});if(o===true)return foam.mlang.predicate.True.create();if(o===false)return foam.mlang.predicate.False.create();if(foam.core.FObject.isInstance(o))return o;if(o.class&&this.__context__.maybeLookup(o.class)){return this.adaptArrayElement(this.__context__.lookup(o.class).create(o,this))}console.error("Invalid expression value: ",o)}}]});
foam.CLASS({package:"foam.mlang.predicate",name:"AbstractPredicate",abstract:true,implements:["foam.mlang.predicate.Predicate"],methods:[{name:"f",type:"Boolean",args:[{name:"obj",type:"Any"}],},{name:"toIndex",flags:["js"],code:function(){}},{name:"toDisjunctiveNormalForm",flags:["js"],code:function(){return this},},{name:"partialEval",code:function(){return this},},function reduceAnd(other){return foam.util.equals(this,other)?this:null},function reduceOr(other){return foam.util.equals(this,other)?this:null},{name:"toString",code:function toString(){return this.cls_.name},},{name:"createStatement",type:"String",},{name:"prepareStatement",type:"Void",args:[{name:"stmt",}],},{name:"authorize",}]});
foam.CLASS({package:"foam.mlang",name:"AbstractExpr",abstract:true,implements:["foam.mlang.Expr"],methods:[{name:"partialEval",code:function partialEval(){return this},},{name:"createStatement",type:"String",},{name:"prepareStatement",args:[{name:"stmt",}],},{name:"authorize",type:"Void",}]});
foam.CLASS({package:"foam.mlang.predicate",name:"True",extends:"foam.mlang.predicate.AbstractPredicate",implements:["foam.core.Serializable"],axioms:[foam.pattern.Singleton.create()],methods:[{type:"FObject",name:"fclone",},{name:"f",code:function(){return true},},{name:"partialEval",code:function(){return this},}]});
foam.CLASS({package:"foam.mlang.predicate",name:"False",extends:"foam.mlang.predicate.AbstractPredicate",implements:["foam.core.Serializable"],axioms:[foam.pattern.Singleton.create()],methods:[{type:"FObject",name:"fclone",},{name:"f",code:function f(){return false},},{name:"createStatement",type:"String",code:function(){return"1 <> 1"}},{name:"partialEval",code:function(){return this},}]});
foam.CLASS({package:"foam.mlang.predicate",name:"Unary",extends:"foam.mlang.predicate.AbstractPredicate",abstract:true,properties:[{class:"foam.mlang.ExprProperty",name:"arg1"}],methods:[function toIndex(tail){return this.arg1&&this.arg1.toIndex(tail)},function toString(){return foam.String.constantize(this.cls_.name)+"("+this.arg1.toString()+")"},{name:"prepareStatement",},{name:"authorize",}]});
foam.CLASS({package:"foam.mlang",name:"Absolute",properties:[{class:"foam.mlang.ExprProperty",name:"delegate"}],methods:[{name:"f",code:function(obj){return Math.abs(this.delegate.f(obj))}}]});
foam.CLASS({package:"foam.mlang",name:"Mux",properties:[{name:"cond"},{name:"a"},{name:"b"}],methods:[{name:"put",code:function(obj,s){if(this.cond.f(obj))this.a.put(obj,s);else this.b.put(obj,s)}}]});
foam.CLASS({package:"foam.mlang",name:"Partition",properties:[{name:"arg1"},{name:"delegate"},{class:"Array",name:"partitions",factory:function(){return[]}}],methods:[{name:"put",code:function(obj,s){this.findPartition_(this.arg1.f(obj)).put(obj,s)}},{name:"remove",code:function(obj,s){this.findPartition_(this.arg1.f(obj)).remove(obj,s)}},{name:"reset",code:function(s){this.partitions.forEach(function(p){p.reset(s)})}},{name:"findPartition_",code:function(key){for(var i=0;i<this.partitions.length;i++){if(foam.util.equals(this.partitions[i][0],key))return this.partitions[i][1]}this.partitions.push([key,this.delegate.clone()]);return this.partitions[this.partitions.length-1][1]}}]});
foam.CLASS({package:"foam.mlang.predicate",name:"Binary",extends:"foam.mlang.predicate.AbstractPredicate",abstract:true,properties:[{class:"foam.mlang.ExprProperty",name:"arg1",gridColumns:6},{class:"foam.mlang.ExprProperty",name:"arg2",gridColumns:6,adapt:function(old,nu,prop){var value=prop.adaptValue(nu);var arg1=this.arg1;if(foam.mlang.Constant.isInstance(value)&&arg1&&arg1.adapt)value.value=this.arg1.adapt.call(null,old,value.value,arg1);return value},}],methods:[{type:"FObject",name:"fclone",},function toIndex(tail){return this.arg1&&this.arg1.toIndex(tail)},function toSummary(){return this.toString()},{name:"toString",code:function(){return foam.String.constantize(this.cls_.name)+"("+(this.arg1&&this.arg1.toString()||"NA")+", "+(this.arg2&&this.arg2.toString()||"NA")+")"},},{name:"prepareStatement",},{name:"authorize",},function arg2ToMQL(){return this.arg2&&this.arg2.toMQL?this.arg2.toMQL():this.arg2}]});
foam.CLASS({package:"foam.mlang.predicate",name:"Nary",extends:"foam.mlang.predicate.AbstractPredicate",abstract:true,properties:[{class:"foam.mlang.predicate.PredicateArray",name:"args"}],methods:[function toSummary(){return this.toString()},{name:"toString",code:function(){return foam.String.constantize(this.cls_.name)+"("+this.args.map(a=>a.toString())+")"},},function reduce_(args,shortCircuit,methodName){for(var i=0;i<args.length-1;i++){for(var j=i+1;j<args.length;j++){if(args[i][methodName]){var newArg=args[i][methodName](args[j]);if(newArg){if(newArg===shortCircuit)return shortCircuit;args[i]=newArg;args.splice(j,1)}}}}return args},{name:"prepareStatement",},{name:"authorize",}]});
foam.CLASS({package:"foam.mlang.predicate",name:"Or",extends:"foam.mlang.predicate.Nary",implements:["foam.core.Serializable"],requires:["foam.mlang.predicate.False","foam.mlang.predicate.True"],methods:[{name:"f",code:function f(o){for(var i=0;i<this.args.length;i++){if(this.args[i].f(o))return true}return false},},{name:"createStatement",type:"String",},{name:"partialEval",code:function partialEval(){var newArgs=[];var updated=false;var TRUE=this.True.create();var FALSE=this.False.create();for(var i=0;i<this.args.length;i++){var a=this.args[i];var newA=this.args[i].partialEval();if(newA===TRUE)return TRUE;if(this.cls_.isInstance(newA)){for(var j=0;j<newA.args.length;j++){newArgs.push(newA.args[j])}updated=true}else{if(newA!==FALSE){newArgs.push(newA)}if(a!==newA)updated=true}}this.reduce_(newArgs,FALSE,"reduceAnd");if(newArgs.length===0)return FALSE;if(newArgs.length===1)return newArgs[0];return updated?this.cls_.create({args:newArgs}):this},},function toIndex(tail){},function toDisjunctiveNormalForm(){var oldArgs=this.args;var newArgs=[];var changed=false;for(var i=0;i<oldArgs.length;i++){var a=oldArgs[i].toDisjunctiveNormalForm();if(a!==oldArgs[i])changed=true;newArgs[i]=a}var self=this;if(changed){self=this.clone();self.args=newArgs;self=self.partialEval()}return self},function toMQL(){var mqlStringsArr=[];for(var a in this.args){if(!this.args[a].toMQL)throw new Error("Predicate's argument does not support toMQL");var mql=this.args[a].toMQL();if(mql)mqlStringsArr.push(mql)}return mqlStringsArr.join(" OR ")}]});
foam.CLASS({package:"foam.mlang.predicate",name:"And",extends:"foam.mlang.predicate.Nary",implements:["foam.core.Serializable"],requires:["foam.mlang.predicate.Or"],methods:[{name:"f",code:function(o){for(var i=0;i<this.args.length;i++){if(!this.args[i].f(o))return false}return true},},{name:"createStatement",type:"String",},{name:"partialEval",code:function partialEval(){var newArgs=[];var updated=false;var FALSE=foam.mlang.predicate.False.create();var TRUE=foam.mlang.predicate.True.create();for(var i=0;i<this.args.length;i++){var a=this.args[i];var newA=this.args[i].partialEval();if(newA===FALSE)return FALSE;if(this.cls_.isInstance(newA)){for(var j=0;j<newA.args.length;j++){newArgs.push(newA.args[j])}updated=true}else{if(newA===TRUE){updated=true}else{newArgs.push(newA);if(a!==newA)updated=true}}}this.reduce_(newArgs,TRUE,"reduceOr");if(newArgs.length===0)return TRUE;if(newArgs.length===1)return newArgs[0];return updated?this.cls_.create({args:newArgs}):this},},function toIndex(tail,depth){depth=depth||99;if(depth===1){var bestCost=Number.MAX_VALUE;var bestIndex;var args=this.args;for(var i=0;i<args.length;i++){var arg=args[i];var idx=arg.toIndex(tail);if(!idx)continue;var idxCost=Math.floor(idx.estimate(1e3,undefined,undefined,undefined,undefined,arg));if(bestCost>idxCost){bestIndex=idx;bestCost=idxCost}}return bestIndex}else{var sortedArgs=Object.create(null);var costs=[];var args=this.args;var dupes={};for(var i=0;i<args.length;i++){var arg=args[i];var idx=arg.toIndex(tail);if(!idx)continue;var idxString=idx.toString();if(dupes[idxString])continue;dupes[idxString]=true;var idxCost=Math.floor(idx.estimate(1e3,undefined,undefined,undefined,undefined,arg));var costKey=idxCost+i/1e3;sortedArgs[costKey]=arg;costs.push(costKey)}costs=costs.sort(foam.Number.compare);var tailRet=tail;var chainDepth=Math.min(costs.length-1,depth-1);for(var i=chainDepth;i>=0;i--){var arg=sortedArgs[costs[i]];tailRet=arg.toIndex(tailRet)}return tailRet}},function toDisjunctiveNormalForm(){var andArgs=[];var orArgs=[];var oldArgs=this.args;for(var i=0;i<oldArgs.length;i++){var a=oldArgs[i].toDisjunctiveNormalForm();if(this.Or.isInstance(a)){orArgs.push(a)}else{andArgs.push(a)}}if(orArgs.length>0){var newAndGroups=[];var orArgsOffsets=new Array(orArgs.length).fill(0);var active=true;var idx=orArgsOffsets.length-1;orArgsOffsets[idx]=-1;while(active){while(++orArgsOffsets[idx]>=orArgs[idx].args.length){if(idx===0){active=false;break}orArgsOffsets[idx]=0;idx--}idx=orArgsOffsets.length-1;if(!active)break;var newAndArgs=[];for(var j=orArgsOffsets.length-1;j>=0;j--){newAndArgs.push(orArgs[j].args[orArgsOffsets[j]])}newAndArgs=newAndArgs.concat(andArgs);newAndGroups.push(this.cls_.create({args:newAndArgs}))}return this.Or.create({args:newAndGroups}).partialEval()}else{return this}},function toMQL(){var mqlStringsArr=[];for(var a in this.args){if(!this.args[a].toMQL)throw new Error("Predicate's argument does not support toMQL");var mql=this.args[a].toMQL();if(mql)mqlStringsArr.push(mql)}return mqlStringsArr.join(" AND ")}]});
foam.CLASS({package:"foam.mlang.predicate",name:"Contains",extends:"foam.mlang.predicate.Binary",implements:["foam.core.Serializable"],methods:[{name:"f",code:function(o){var arg1=this.arg1.f(o);var arg2=this.arg2.f(o);if(Array.isArray(arg1)){return arg1.some(function(a){return a.indexOf(arg2)!==-1})}return arg1?arg1.indexOf(arg2)!==-1:false},},{name:"createStatement",}]});
foam.CLASS({package:"foam.mlang.predicate",name:"ContainsIC",extends:"foam.mlang.predicate.Binary",implements:["foam.core.Serializable"],methods:[{name:"f",code:function f(o){var arg1=this.arg1.f(o);var arg2=this.arg2.f(o).toString().toUpperCase();if(Array.isArray(arg1)){return arg1.some(function(a){return a.toString().toUpperCase().indexOf(arg2)!==-1})}return arg1?arg1.toString().toUpperCase().indexOf(arg2)!==-1:false},},{name:"createStatement",type:"String",}]});
foam.CLASS({package:"foam.mlang.predicate",name:"StartsWith",extends:"foam.mlang.predicate.Binary",implements:["foam.core.Serializable"],methods:[{name:"f",code:function(o){var arg1=this.arg1.f(o);var arg2=this.arg2.f(o);if(Array.isArray(arg1)){return arg1.some(function(arg){return arg.startsWith(arg2)})}return arg1.startsWith(arg2)},},{name:"createStatement",}]});
foam.CLASS({package:"foam.mlang.predicate",name:"StartsWithIC",extends:"foam.mlang.predicate.Binary",implements:["foam.core.Serializable"],methods:[{name:"f",code:function f(o){var arg1=this.arg1.f(o);var arg2=this.arg2.f(o);if(Array.isArray(arg1)){return arg1.some(function(arg){return foam.String.startsWithIC(arg,arg2)})}return foam.String.startsWithIC(arg1,arg2)},},{name:"createStatement",}]});
foam.CLASS({package:"foam.mlang.predicate",name:"EndsWith",extends:"foam.mlang.predicate.Binary",implements:["foam.core.Serializable"],methods:[{name:"f",code:function(o){var arg1=this.arg1.f(o);var arg2=this.arg2.f(o);if(Array.isArray(arg1)){return arg1.some(function(arg){return arg.endsWith(arg2)})}return arg1.endsWith(arg2)},},{name:"createStatement",}]});
foam.CLASS({package:"foam.mlang.predicate",name:"ArrayBinary",extends:"foam.mlang.predicate.Binary",abstract:true,properties:[{name:"arg2",postSet:function(){this.valueSet_=null},adapt:function(old,nu,prop){var value=prop.adaptValue(nu);var arg1=this.arg1;if(foam.mlang.Constant.isInstance(value)&&value.value&&arg1&&arg1.adapt){var arrayValue=value.value;for(var i=0;i<arrayValue.length;i++){arrayValue[i]=arg1.adapt.call(null,old&&old[i],arrayValue[i],arg1)}}return value},},{name:"valueSet_",hidden:true}],methods:[{name:"toString",code:function(){return foam.String.constantize(this.cls_.name)+"("+this.arg1.toString()+", "+this.arg2.toString()+")"},}]});
foam.CLASS({package:"foam.mlang.predicate",name:"In",extends:"foam.mlang.predicate.ArrayBinary",implements:["foam.core.Serializable",{path:"foam.mlang.Expressions",flags:["js"],java:false}],requires:["foam.mlang.Constant"],properties:[{name:"arg1",postSet:function(old,nu){this.upperCase_=nu&&foam.core.Enum.isInstance(nu)}},{name:"upperCase_",hidden:"true"}],methods:[{name:"f",code:function f(o){var lhs=this.arg1.f(o);var rhs=this.arg2.f(o);if(!rhs)return false;for(var i=0;i<rhs.length;i++){var v=rhs[i];if(foam.String.isInstance(v)&&this.upperCase_)v=v.toUpperCase();if(foam.util.equals(lhs,v))return true}return false;if(this.Constant.isInstance(this.arg2)){if(!this.valueSet_){var set={};for(var i=0;i<rhs.length;i++){var s=rhs[i];if(this.upperCase_)s=s.toString().toUpperCase();set[s]=true}this.valueSet_=set}return!!this.valueSet_[lhs]}return rhs?rhs.indexOf(lhs)!==-1:false},},{name:"createStatement",type:"String",},{name:"partialEval",code:function partialEval(){var value=this.arg2;if(this.Constant.isInstance(this.arg2))value=this.arg2.value;if(!value)return this.FALSE;if(foam.Array.isInstance(value)&&value.length==1)return this.Eq.create({arg1:this.arg1,arg2:value[0]});return this},},function toMQL(){var arg2=this.arg2ToMQL();if(!arg2)return null;return this.arg1.name+":"+arg2.join(",")}]});
foam.CLASS({package:"foam.mlang.predicate",name:"InIC",extends:"foam.mlang.predicate.ArrayBinary",implements:["foam.core.Serializable"],methods:[function f(o){var lhs=this.arg1.f(o);var rhs=this.arg2.f(o);if(lhs.toUpperCase)lhs=lhs.toString().toUpperCase();if(foam.mlang.Constant.isInstance(this.arg2)){if(!this.valueSet_){var set={};for(var i=0;i<rhs.length;i++){set[rhs[i].toString().toUpperCase()]=true}this.valueSet_=set}return!!this.valueSet_[lhs]}else{if(!rhs)return false;return rhs.toString().toUpperCase().indexOf(lhs)!==-1}}]});
foam.CLASS({package:"foam.mlang",name:"Constant",extends:"foam.mlang.AbstractExpr",implements:["foam.core.Serializable"],properties:[{class:"Object",name:"value"}],methods:[{type:"FObject",name:"fclone",},{name:"f",code:function(){return this.value},},{name:"createStatement",},{name:"prepareStatement",},function toString_(x){return typeof x==="number"?""+x:typeof x==="string"?'"'+x+'"':Array.isArray(x)?"["+x.map(this.toString_.bind(this)).join(", ")+"]":x&&x.toString?.()},{name:"toString",code:function(){return this.toString_(this.value)},},function xxoutputJSON(os){os.output(this.value)},function toMQL(){if(this.value&&foam.Date.isInstance(this.value)){var isoDateString=this.value.toISOString();return isoDateString.substr(0,isoDateString.indexOf(":",isoDateString.indexOf(":")+1))}if(foam.String.isInstance(this.value))return'"'+this.value+'"';return this.value}]});
foam.CLASS({package:"foam.mlang",name:"ArrayConstant",extends:"foam.mlang.AbstractExpr",implements:["foam.core.Serializable"],properties:[{class:"Array",name:"value"}],axioms:[{name:"javaExtras",buildJavaClass:function(cls){cls.extras.push(foam.java.Code.create({data:`protected ThreadLocal<StringBuilder> sb = new ThreadLocal<StringBuilder>() {
@Override
protected StringBuilder initialValue() {
return new StringBuilder();
}
@Override
public StringBuilder get() {
StringBuilder b = super.get();
b.setLength(0);
return b;
}
};`}))}}],methods:[{name:"f",code:function(){return this.value},},{name:"createStatement",},{name:"prepareStatement",},{name:"escapeCommasAndAppend",args:[{name:"builder",},{name:"o",type:"Any"}],type:"Void",},{name:"toString",code:function(){return Array.isArray(this.value)?"["+this.value.map(this.toString_.bind(this)).join(", ")+"]":this.value.toString?this.value.toString:x},}]});
foam.CLASS({package:"foam.mlang.predicate",name:"Func",extends:"foam.mlang.predicate.AbstractPredicate",properties:[{name:"fn"}],methods:[function f(o){return this.fn(o)},function toString(){return"FUNC("+fn.toString()+")"}]});
foam.CLASS({package:"foam.mlang.predicate",name:"Eq",extends:"foam.mlang.predicate.Binary",implements:["foam.core.Serializable"],methods:[{name:"f",code:function(o){var v1=this.arg1.f(o);var v2=this.arg2.f(o);return v1===undefined&&v2===null||foam.util.equals(v1,v2)},},{name:"createStatement",},function reduceAnd(other){var myArg1=this.arg1;var myArg2=this.arg2;var otherArg1=other.arg1;var otherArg2=other.arg2;var isConst=foam.mlang.Constant.isInstance.bind(foam.mlang.Constant);var myArg1IsConst=isConst(myArg1);var myArg2IsConst=isConst(myArg2);var otherArg1IsConst=isConst(otherArg1);var otherArg2IsConst=isConst(otherArg2);if(myArg1IsConst===myArg2IsConst||otherArg1IsConst===otherArg2IsConst)return this.SUPER(other);var myExpr=myArg1IsConst?myArg2:myArg1;var otherExpr=otherArg1IsConst?otherArg2:otherArg1;var equals=foam.util.equals;if(!equals(myExpr,otherExpr))return this.SUPER(other);var myConst=myArg1IsConst?myArg1:myArg2;var otherConst=otherArg1IsConst?otherArg1:otherArg2;return equals(myConst,otherConst)?this.SUPER(other):this.FALSE},function toMQL(){var arg2=this.arg2ToMQL();if(!arg2)return null;return this.arg1.name+"="+arg2}]});
foam.CLASS({package:"foam.mlang.predicate",name:"Neq",extends:"foam.mlang.predicate.Binary",implements:["foam.core.Serializable"],methods:[{name:"f",code:function(o){var v1=this.arg1.f(o);var v2=this.arg2.f(o);return(v1!==undefined||v2!==null)&&!foam.util.equals(v1,v2)},},{name:"createStatement",},function toMQL(){var arg2=this.arg2ToMQL();if(!arg2)return null;return"-"+this.arg1.name+"="+arg2}]});
foam.CLASS({package:"foam.mlang.predicate",name:"Lt",extends:"foam.mlang.predicate.Binary",implements:["foam.core.Serializable"],methods:[{name:"f",code:function(o){return foam.util.compare(this.arg1.f(o),this.arg2.f(o))<0},},{name:"createStatement",},function toMQL(){var arg2=this.arg2ToMQL();if(!arg2)return null;return this.arg1.name+"<"+arg2}]});
foam.CLASS({package:"foam.mlang.predicate",name:"Lte",extends:"foam.mlang.predicate.Binary",implements:["foam.core.Serializable"],methods:[{name:"f",code:function(o){return foam.util.compare(this.arg1.f(o),this.arg2.f(o))<=0},},{name:"createStatement",},function toMQL(){var arg2=this.arg2ToMQL();if(!arg2)return null;return this.arg1.name+"<="+arg2}]});
foam.CLASS({package:"foam.mlang.predicate",name:"Gt",extends:"foam.mlang.predicate.Binary",implements:["foam.core.Serializable"],methods:[{name:"f",code:function(o){return foam.util.compare(this.arg1.f(o),this.arg2.f(o))>0},},{name:"createStatement",},function toMQL(){var arg2=this.arg2ToMQL();if(!arg2)return null;return this.arg1.name+">"+arg2}]});
foam.CLASS({package:"foam.mlang.predicate",name:"Gte",extends:"foam.mlang.predicate.Binary",implements:["foam.core.Serializable"],methods:[{name:"f",code:function(o){return foam.util.compare(this.arg1.f(o),this.arg2.f(o))>=0},},{name:"createStatement",},function toMQL(){var arg2=this.arg2ToMQL();if(!arg2)return null;return this.arg1.name+">="+arg2}]});
foam.CLASS({package:"foam.mlang.predicate",name:"Has",extends:"foam.mlang.predicate.Unary",implements:["foam.core.Serializable"],requires:["foam.mlang.expr.PropertyExpr"],properties:[{name:"arg1",factory:function(){return this.PropertyExpr.create()}}],methods:[{type:"FObject",name:"fclone",},{name:"f",code:function f(obj){var value=this.arg1.f(obj);return!(value===0||value===undefined||value===null||value===""||Array.isArray(value)&&value.length===0)},},{name:"createStatement",}]});
foam.CLASS({package:"foam.mlang.predicate",name:"Not",extends:"foam.mlang.predicate.AbstractPredicate",implements:["foam.core.Serializable",{path:"foam.mlang.Expressions",flags:["js"],java:false}],properties:[{class:"foam.mlang.predicate.PredicateProperty",name:"arg1"}],methods:[{type:"FObject",name:"fclone",},{name:"f",code:function f(obj){return!this.arg1.f(obj)},},{name:"toString",code:function(){return foam.String.constantize(this.cls_.name)+"("+this.arg1.toString()+")"},},{name:"partialEval",code:function(){if(this.arg1&&this.arg1.partialEval){this.arg1=this.arg1.partialEval()}if(this.Not.isInstance(this.arg1)){this.arg1=this.arg1.partialEval();if(!this.arg2){return this.arg1}}else if(this.Eq.isInstance(this.arg1)){return this.Neq.create({arg1:this.arg1.arg1,arg2:this.arg1.arg2})}else if(this.Neq.isInstance(this.arg1)){return this.Eq.create({arg1:this.arg1.arg1,arg2:this.arg1.arg2})}else if(this.Lt.isInstance(this.arg1)){return this.Gte.create({arg1:this.arg1.arg1,arg2:this.arg1.arg2})}else if(this.Gte.isInstance(this.arg1)){return this.Lt.create({arg1:this.arg1.arg1,arg2:this.arg1.arg2})}else if(this.Gt.isInstance(this.arg1)){return this.Lte.create({arg1:this.arg1.arg1,arg2:this.arg1.arg22})}else if(this.Lte.isInstance(this.arg1)){return this.Gt.create({arg1:this.arg1.arg1,arg2:this.arg1.arg2})}else if(this.And.isInstance(this.arg1)){for(var i=0;i<this.arg1.args.length;i++){this.arg1.args[i]=this.Not.create(this.arg1.args[i])}return this.Or.create({args:this.arg1.args[i]})}else if(this.Or.isInstance(this.arg1)){for(var i=0;i<this.arg1.args.length;i++){this.arg1.args[i]=this.Not.create(this.arg1.args[i])}return this.And.create({args:this.arg1.args[i]})}return this},},{name:"createStatement",},{name:"prepareStatement",},{name:"authorize",}]});
foam.CLASS({package:"foam.mlang.predicate",name:"IsInstanceOf",extends:"foam.mlang.predicate.AbstractPredicate",implements:["foam.core.Serializable"],properties:[{class:"Class",name:"targetClass",view:{class:"foam.u2.view.StrategizerChoiceView",desiredModelId:"foam.Class"}},{class:"FObjectProperty",name:"propExpr"}],methods:[{type:"FObject",name:"fclone",},{name:"f",code:function f(obj){return this.propExpr==null||this.propExpr==undefined?this.targetClass.isInstance(obj):this.targetClass.isInstance(this.propExpr.f(obj))},},{name:"toString",code:function toString(){return foam.String.constantize(this.cls_.name)+"("+this.targetClass.id+")"},}]});
foam.CLASS({package:"foam.mlang.predicate",name:"Keyword",extends:"foam.mlang.predicate.Unary",implements:["foam.core.Serializable"],requires:[{name:"String",path:"foam.core.String",flags:["js"]},{name:"FObjectProperty",path:"foam.core.FObjectProperty",flags:["js"]},{name:"Long",path:"foam.core.Long",flags:["js"]},{name:"Enum",path:"foam.core.Enum",flags:["js"]},{name:"Date",path:"foam.core.Date",flags:["js"]}],properties:[{class:"Boolean",name:"checkingNestedFObject_",value:false,transient:true,visibility:"HIDDEN",}],methods:[{name:"f",code:function f(obj){var arg=this.arg1.f(obj);if(!arg||typeof arg!=="string")return false;arg=arg.toLowerCase();var s="";const props=obj.cls_.getAxiomsByClass(foam.core.Property);for(let i=0;i<props.length;i++){try{const prop=props[i];if(this.FObjectProperty.isInstance(prop)){if(this.checkNestedFObject(prop.f(obj)))return true}else if(this.Enum.isInstance(prop)){s=prop.f(obj).label.toLowerCase()}else if(this.Long.isInstance(prop)){s=prop.f(obj).toString().toLowerCase()}else if(this.Date.isInstance(prop)){s=prop.f(obj).toISOString().toLowerCase()}else{s=prop.f(obj);s=String(s)}}catch(err){}if(s.toLowerCase().includes(arg))return true}return false},},{name:"checkNestedFObject",type:"Boolean",args:[{name:"obj",type:"Any"}],code:function(obj){if(obj===undefined||obj===null||this.checkingNestedFObject_){return false}this.checkingNestedFObject_=true;return this.f(obj)},},{name:"toString",code:function(){return"Keyword("+this.arg1.toString()+")"},},function toMQL(){}]});
foam.CLASS({package:"foam.mlang.sink",name:"Map",extends:"foam.dao.ProxySink",properties:[{class:"foam.mlang.ExprProperty",name:"arg1"}],methods:[{name:"f",type:"Any",args:[{name:"obj",type:"Any"}],code:function f(obj){return this.arg1.f(obj)},},{name:"put",code:function put(o,sub){this.delegate.put(this.f(o),sub)},},function toString(){return"MAP("+this.arg1.toString()+","+this.f.toString()+")"}]});
foam.CLASS({package:"foam.mlang.sink",name:"GroupBy",extends:"foam.dao.AbstractSink",implements:["foam.core.Serializable"],properties:[{class:"foam.mlang.ExprProperty",name:"arg1"},{class:"foam.mlang.SinkProperty",name:"arg2"},{class:"Int",name:"groupLimit",value:-1},{class:"Map",name:"groups",hidden:true,factory:function(){return{}},},{class:"List",hidden:true,name:"groupKeys",transient:true,factory:function(){return Object.keys(this.groups)}},{class:"Boolean",hidden:true,name:"processArrayValuesIndividually",factory:function(){return!foam.core.MultiPartID.isInstance(this.arg1)}}],methods:[{name:"sortedKeys",args:[{name:"comparator",type:"foam.mlang.order.Comparator"}],code:function sortedKeys(opt_comparator){this.groupKeys.sort(opt_comparator||this.arg1.comparePropertyValues);return this.groupKeys},},{name:"putInGroup_",args:[{name:"sub",type:"foam.core.Detachable"},{name:"key",type:"Object"},{name:"obj",type:"Object"}],code:function putInGroup_(sub,key,obj){var group=this.groups.hasOwnProperty(key)&&this.groups[key];if(!group){group=this.arg2.clone();this.groups[key]=group;if(!this.groupKeys.includes(key))this.groupKeys.push(key)}group.put(obj,sub);this.pub("propertyChange","groups")},},function reset(){this.arg2.reset();this.groups=undefined;this.groupKeys=undefined},{name:"put",code:function put(obj,sub){var key=this.arg1.f(obj);if(this.processArrayValuesIndividually&&Array.isArray(key)){if(key.length){for(var i=0;i<key.length;i++){this.putInGroup_(sub,key[i],obj)}}else{this.putInGroup_(sub,"",obj)}}else{this.putInGroup_(sub,key,obj)}if(this.groupLimit==this.groups.size)sub.detach()},},function eof(){},{name:"clone",type:"foam.mlang.sink.GroupBy",code:function clone(){return this.cls_.create({arg1:this.arg1,arg2:this.arg2})},},{name:"toString",code:function toString(){return"groupBy("+this.arg1+","+this.arg2+","+this.groupLimit+")"},},function toE(_,x){return x.E("table").add(this.slot(function(arg1,groups){return x.E("tbody").forEach(Object.keys(groups),function(g){this.start("tr").start("td").add(g).end().start("td").add(groups[g]).end()})}))}]});
foam.CLASS({package:"foam.mlang.sink",name:"Projection",extends:"foam.dao.AbstractSink",implements:["foam.core.Serializable"],constants:[{name:"CLS_OR_OBJ_INDEX",type:"Integer",value:0},{name:"PROJECTION_VALUES_OFFSET",type:"Integer",value:1}],properties:[{class:"Array",type:"foam.mlang.Expr[]",name:"exprs",},{class:"Boolean",name:"useProjection",value:true},{class:"List",name:"projectionWithClass",factory:function(){return[]},},{class:"List",name:"projection",transient:true,getter:function(){return this.projectionWithClass.map(p=>p.slice(this.PROJECTION_VALUES_OFFSET))},},{class:"List",name:"array",factory:function(){return this.projectionWithClass.map(p=>{if(this.useProjection){var o=foam.lookup(p[this.CLS_OR_OBJ_INDEX]).create(null,this);for(var i=0;i<this.exprs.length;i++){try{this.exprs[i].set(o,p[i+this.PROJECTION_VALUES_OFFSET])}catch(x){}}return o}return p[this.CLS_OR_OBJ_INDEX]})},}],methods:[{name:"put",code:function put(o,sub){var a;if(this.useProjection){a=[o.cls_.id];for(var i=0;i<this.exprs.length;i++)a[i+this.PROJECTION_VALUES_OFFSET]=this.exprs[i].f(o)}else{a=[o]}this.projectionWithClass.push(a)},},{name:"toString",code:function(){return this.cls_.name+"("+this.exprs.join(",")+")"},}]});
foam.CLASS({package:"foam.mlang.sink",name:"Plot",extends:"foam.dao.AbstractSink",implements:["foam.core.Serializable"],properties:[{class:"foam.mlang.ExprArrayProperty",name:"args"},{class:"List",name:"data",factory:function(){return[]}}],methods:[{name:"put",code:function put(obj){this.data.push(this.args.map(a=>a.f(obj)))},}]});
foam.CLASS({package:"foam.mlang.sink",name:"Unique",extends:"foam.dao.ProxySink",implements:["foam.core.Serializable"],properties:[{class:"foam.mlang.ExprProperty",name:"expr"},{name:"values",class:"Map",factory:function(){return{}},}],methods:[{name:"put",code:function put(obj,sub){var value=this.expr.f(obj);if(Array.isArray(value)){throw"Unique does not support Array values."}else{if(!this.values.hasOwnProperty(value)){this.values[value]=obj;this.delegate.put(obj)}}},},function eof(){},function clone(){return this.cls_.create({expr:this.expr,delegate:this.delegate})},function toString(){return this.uniqueValues.toString()}]});
foam.CLASS({package:"foam.mlang.sink",name:"Explain",extends:"foam.dao.ProxySink",implements:["foam.core.Serializable"],properties:[{class:"String",name:"plan",help:"Execution Plan"}],methods:[function toString(){return this.plan}]});
foam.CLASS({package:"foam.mlang",name:"PropertyComparatorRefinement",refines:"foam.core.Property",implements:["foam.mlang.order.Comparator"],methods:[{name:"orderTail",code:function(){return},},{name:"orderPrimaryProperty",code:function(){return this},},{name:"orderDirection",code:function(){return 1},}]});
foam.CLASS({package:"foam.mlang.order",name:"Desc",implements:["foam.mlang.order.Comparator","foam.core.Serializable","foam.dao.SQLStatement"],properties:[{class:"FObjectProperty",name:"arg1",type:"foam.mlang.order.Comparator",adapt:function(o,n,prop){var ret=foam.compare.toCompare(n);var type=foam.lookup(prop.type);if(type.isInstance(ret)){return ret}return foam.core.FObjectProperty.ADAPT.value.call(this,o,n,prop)},javaJSONParser:"foam.lib.json.ExprParser.instance()"}],methods:[{name:"compare",code:function compare(o1,o2){return-1*this.arg1.compare(o1,o2)},},{name:"createStatement",},{name:"prepareStatement",},{name:"toString",code:function toString(){return"DESC("+this.arg1.toString()+")"},},function toIndex(tail){return this.arg1&&this.arg1.toIndex(tail)},function orderTail(){return},function orderPrimaryProperty(){return this.arg1},function orderDirection(){return-1*this.arg1.orderDirection()}]});
foam.CLASS({package:"foam.mlang.order",name:"ThenBy",implements:["foam.core.Serializable","foam.mlang.order.Comparator"],properties:[{class:"FObjectProperty",type:"foam.mlang.order.Comparator",adapt:function(_,a){return a},javaJSONParser:"foam.lib.json.ExprParser.instance()",name:"head"},{class:"FObjectProperty",type:"foam.mlang.order.Comparator",adapt:function(_,a){return a},javaJSONParser:"foam.lib.json.ExprParser.instance()",name:"tail"}],methods:[{name:"compare",code:function(o1,o2){return this.head.compare(o1,o2)||this.tail.compare(o1,o2)},},{name:"toString",code:function(){return"THEN_BY("+this.head.toString()+", "+this.tail.toString()+")"},},{name:"createStatement",},{name:"prepareStatement",},function toIndex(tail){return this.head&&this.tail&&this.head.toIndex(this.tail.toIndex(tail))},function orderTail(){return this.tail},function orderPrimaryProperty(){return this.head.orderPrimaryProperty()},function orderDirection(){return this.head.orderDirection()}]});
foam.CLASS({package:"foam.mlang.order",name:"CustomComparator",implements:["foam.mlang.order.Comparator"],flags:[],properties:[{class:"Function",name:"compareFn"}],methods:[{name:"compare",code:function(o1,o2){return this.compareFn(o1,o2)}},{name:"toString",code:function(){return"CUSTOM_COMPARE("+this.compareFn.toString()+")"}},{name:"orderTail",code:function(){return undefined},},{name:"orderPrimaryProperty",code:function(){return undefined}},{name:"orderDirection",code:function(){return 1}}]});foam.LIB({name:"foam.compare",methods:[function desc(c){return foam.mlang.order.Desc.create({arg1:c})},function toCompare(c){return foam.Array.isInstance(c)?foam.compare.compound(c):foam.Function.isInstance(c)?foam.mlang.order.CustomComparator.create({compareFn:c}):c},function compound(args){var cs=args.map(foam.compare.toCompare);if(cs.length===0)return;if(cs.length===1)return cs[0];var ThenBy=foam.mlang.order.ThenBy;var ret,tail;ret=tail=ThenBy.create({head:cs[0],tail:cs[1]});for(var i=2;i<cs.length;i++){tail=tail.tail=ThenBy.create({head:tail.tail,tail:cs[i]})}return ret}]});
foam.CLASS({package:"foam.mlang.sink",name:"AbstractUnarySink",extends:"foam.dao.AbstractSink",implements:["foam.core.Serializable"],properties:[{class:"foam.mlang.ExprProperty",name:"arg1"}],methods:[function toString(){return foam.String.constantize(this.cls_.name)+"("+this.arg1.toString()+")"}]});
foam.CLASS({package:"foam.mlang.sink",name:"Max",extends:"foam.mlang.sink.AbstractUnarySink",properties:[{class:"Object",name:"value"}],methods:[{name:"put",code:function(obj,sub){if(!this.hasOwnProperty("value")||foam.util.compare(this.value,this.arg1.f(obj))<0){this.value=this.arg1.f(obj)}},}]});
foam.CLASS({package:"foam.mlang.sink",name:"Min",extends:"foam.mlang.sink.AbstractUnarySink",properties:[{class:"Object",name:"value"}],methods:[{name:"put",code:function put(obj,s){if(!this.hasOwnProperty("value")||foam.util.compare(this.value,this.arg1.f(obj))>0){this.value=this.arg1.f(obj)}},}]});
foam.CLASS({package:"foam.mlang.sink",name:"Sum",extends:"foam.mlang.sink.AbstractUnarySink",properties:[{class:"foam.mlang.ExprProperty",name:"arg1"},{class:"Double",name:"value",value:0}],methods:[{name:"put",code:function put(obj,sub){this.value+=this.arg1.f(obj)},}]});
foam.CLASS({package:"foam.mlang.sink",name:"Average",extends:"foam.mlang.sink.AbstractUnarySink",properties:[{class:"foam.mlang.ExprProperty",name:"arg1"},{class:"Double",name:"value",value:0},{class:"Long",name:"count",value:0}],methods:[{name:"put",code:function put(obj,sub){this.count++;this.value=(this.value+this.arg1.f(obj))/this.count},}]});
foam.CLASS({package:"foam.mlang.expr",name:"Dot",extends:"foam.mlang.AbstractExpr",implements:["foam.core.Serializable"],properties:[{class:"foam.mlang.ExprProperty",name:"arg1"},{class:"foam.mlang.ExprProperty",name:"arg2"}],methods:[{name:"f",code:function(o){return this.arg2.f(this.arg1.f(o))},},function toString(){return this.arg1+"."+this.arg2},function comparePropertyValues(o1,o2){return this.arg2.comparePropertyValues(o1,o2)}]});
foam.CLASS({package:"foam.mlang.predicate",name:"DotF",extends:"foam.mlang.predicate.Binary",implements:["foam.core.Serializable"],methods:[{name:"f",code:function(o){const predicate=this.arg1.f(o);if(foam.mlang.predicate.Predicate.isInstance(predicate)){return predicate.f(this.arg2.f(o))}return false}},{name:"deepClone",type:"FObject",}]});
foam.CLASS({package:"foam.mlang",name:"PredicatedExpr",extends:"foam.mlang.AbstractExpr",implements:["foam.core.Serializable"],properties:[{class:"foam.mlang.predicate.PredicateProperty",name:"arg1"}],methods:[{name:"f",}]});
foam.CLASS({package:"foam.mlang",name:"ContextObject",extends:"foam.mlang.AbstractExpr",implements:["foam.core.Serializable"],properties:[{class:"String",name:"key"}],methods:[{name:"f",code:function(o){return o[this.key]},}]});
foam.CLASS({package:"foam.mlang.predicate",name:"IsClassOf",extends:"foam.mlang.predicate.AbstractPredicate",implements:["foam.core.Serializable"],properties:[{class:"Class",name:"targetClass",view:{class:"foam.u2.view.StrategizerChoiceView",desiredModelId:"foam.Class"}}],methods:[{name:"f",code:function(obj){return obj&&this.targetClass.id==obj.cls_.id},},function toString(){return foam.String.constantize(this.cls_.name)+"("+this.targetClass.id+")"}]});
foam.CLASS({package:"foam.mlang",name:"Expressions",flags:[],requires:["foam.mlang.Constant","foam.mlang.expr.Add","foam.mlang.expr.Divide","foam.mlang.expr.Dot","foam.mlang.expr.Ref","foam.mlang.expr.MaxFunc","foam.mlang.expr.MinFunc","foam.mlang.expr.Multiply","foam.mlang.expr.Subtract","foam.mlang.order.Desc","foam.mlang.order.ThenBy","foam.mlang.predicate.And","foam.mlang.predicate.Contains","foam.mlang.predicate.ContainsIC","foam.mlang.predicate.DotF","foam.mlang.predicate.Eq","foam.mlang.predicate.False","foam.mlang.predicate.Func","foam.mlang.predicate.Gt","foam.mlang.predicate.Gte","foam.mlang.predicate.Has","foam.mlang.predicate.In","foam.mlang.predicate.Keyword","foam.mlang.predicate.Lt","foam.mlang.predicate.Lte","foam.mlang.predicate.Neq","foam.mlang.predicate.Not","foam.mlang.predicate.Or","foam.mlang.predicate.RegExp","foam.mlang.predicate.IsClassOf","foam.mlang.IsValid","foam.mlang.predicate.IsInstanceOf","foam.mlang.predicate.StartsWith","foam.mlang.predicate.StartsWithIC","foam.mlang.predicate.EndsWith","foam.mlang.predicate.True","foam.mlang.predicate.MQLExpr","foam.mlang.sink.Count","foam.mlang.sink.Explain","foam.mlang.sink.GroupBy","foam.mlang.sink.Map","foam.mlang.sink.Max","foam.mlang.sink.Min","foam.mlang.sink.Projection","foam.mlang.sink.Plot","foam.mlang.sink.Sequence","foam.mlang.sink.Sum","foam.mlang.sink.Unique","foam.mlang.StringLength","foam.mlang.Absolute","foam.mlang.sink.Average","foam.mlang.Mux","foam.mlang.Partition"],constants:[{name:"FALSE",factory:function(){return foam.mlang.predicate.False.create()}},{name:"TRUE",factory:function(){return foam.mlang.predicate.True.create()}}],methods:[function _nary_(name,args){return this[name].create({args:Array.from(args)})},function _unary_(name,arg){foam.assert(arg!==undefined,"arg is required.");return this[name].create({arg1:arg})},function _binary_(name,arg1,arg2){foam.assert(arg1!==undefined,"arg1 is required.");foam.assert(arg2!==undefined,"arg2 is required.");return this[name].create({arg1:arg1,arg2:arg2})},function OR(){return this._nary_("Or",arguments)},function AND(){return this._nary_("And",arguments)},function CONTAINS(a,b){return this._binary_("Contains",a,b)},function CONTAINS_IC(a,b){return this._binary_("ContainsIC",a,b)},function EQ(a,b){return this._binary_("Eq",a,b)},function NEQ(a,b){return this._binary_("Neq",a,b)},function IN(a,b){return this._binary_("In",a,b)},function LT(a,b){return this._binary_("Lt",a,b)},function GT(a,b){return this._binary_("Gt",a,b)},function LTE(a,b){return this._binary_("Lte",a,b)},function GTE(a,b){return this._binary_("Gte",a,b)},function HAS(a){return this._unary_("Has",a)},function NOT(a){return this._unary_("Not",a)},function KEYWORD(a){return this._unary_("Keyword",a)},function STARTS_WITH(a,b){return this._binary_("StartsWith",a,b)},function STARTS_WITH_IC(a,b){return this._binary_("StartsWithIC",a,b)},function ENDS_WITH(a,b){return this._binary_("EndsWith",a,b)},function FUNC(fn){return this.Func.create({fn:fn})},function DOT(a,b){return this._binary_("Dot",a,b)},function REF(a){return this._unary_("Ref",a)},function DOT_F(a,b){return this._binary_("DotF",a,b)},function ADD(){return this._nary_("Add",arguments)},function SUB(){return this._nary_("Subtract",arguments)},function MUL(){return this._nary_("Multiply",arguments)},function DIV(){return this._nary_("Divide",arguments)},function MIN_FUNC(){return this._nary_("MinFunc",arguments)},function MAX_FUNC(){return this._nary_("MaxFunc",arguments)},function UNIQUE(expr,sink){return this.Unique.create({expr:expr,delegate:sink})},function GROUP_BY(expr,opt_sinkProto,opt_limit){return this.GroupBy.create({arg1:expr,arg2:opt_sinkProto||this.COUNT(),groupLimit:opt_limit||-1})},function PLOT(){return this._nary_("Plot",arguments)},function MAP(expr,sink){return this.Map.create({arg1:expr,delegate:sink})},function EXPLAIN(sink){return this.Explain.create({delegate:sink})},function COUNT(){return this.Count.create()},function MAX(arg1){return this.Max.create({arg1:arg1})},function MIN(arg1){return this.Min.create({arg1:arg1})},function SUM(arg1){return this.Sum.create({arg1:arg1})},function AVG(arg1){return this.Average.create({arg1:arg1})},function ABS(arg1){return this.Absolute.create({delegate:arg1})},function MUX(cond,a,b){return this.Mux.create({cond:cond,a:a,b:b})},function PARTITION_BY(arg1,delegate){return this.Partition.create({arg1:arg1,delegate:delegate})},function SEQ(){return this._nary_("Sequence",arguments)},function PROJECTION(exprs){return this.Projection.create({exprs:foam.Array.isInstance(exprs)?exprs:foam.Array.clone(arguments)})},function REG_EXP(arg1,regExp){return this.RegExp.create({arg1:arg1,regExp:regExp})},{name:"DESC",args:[{name:"a",type:"foam.mlang.order.Comparator"}],type:"foam.mlang.order.Comparator",code:function DESC(a){return this._unary_("Desc",a)},},function THEN_BY(a,b){return this.ThenBy.create({head:a,tail:b})},function INSTANCE_OF(cls){return this.IsInstanceOf.create({targetClass:cls})},function CLASS_OF(cls){return this.IsClassOf.create({targetClass:cls})},function MQL(mql){return this.MQLExpr.create({query:mql})},function STRING_LENGTH(a){return this._unary_("StringLength",a)},function IS_VALID(o){return this.IsValid.create({arg1:o})}]});
foam.CLASS({package:"foam.mlang",name:"ExpressionsSingleton",extends:"foam.mlang.Expressions",flags:[],axioms:[foam.pattern.Singleton.create()]});
foam.CLASS({package:"foam.mlang.predicate",name:"RegExp",extends:"foam.mlang.predicate.Unary",implements:["foam.core.Serializable"],properties:[{name:"arg1",gridColumns:6},{type:"Regex",javaInfoType:"foam.core.AbstractObjectPropertyInfo",name:"regExp",gridColumns:6}],methods:[{name:"f",code:function(o){var v1=this.arg1.f(o);return v1.toString().match(this.regExp)!==null},}]});
foam.CLASS({package:"foam.mlang.predicate",name:"MQLExpr",extends:"foam.mlang.predicate.AbstractPredicate",implements:["foam.core.Serializable"],axioms:[foam.pattern.Multiton.create({property:"query"})],properties:[{class:"Map",name:"specializations_",transient:true,factory:function(){return{}},},{class:"String",name:"query"}],methods:[{name:"f",code:function(o){return this.specialization(o.model_).f(o)},},{name:"specialization",args:[{name:"model",type:"ClassInfo"}],type:"Predicate",code:function(model){return this.specializations_[model.name]||(this.specializations_[model.name]=this.specialize(model))},},{name:"specialize",args:[{name:"model",type:"ClassInfo"}],type:"Predicate",code:function(model){var qp=foam.parse.QueryParser.create({of:model.id});var pred=qp.parseString(this.query);return pred?pred.partialEval():foam.mlang.predicate.False.create()},},{name:"toString",code:function toString(){return"("+this.query+")"},}]});
foam.CLASS({package:"foam.mlang.predicate",name:"FScript",extends:"foam.mlang.AbstractExpr",properties:[{class:"String",name:"query"},{class:"Object",name:"prop",}],methods:[{name:"f",code:function(o){var pred=foam.parse.FScriptParser.create({of:o.cls_,thisValue:this.prop}).parseString(this.query);return pred?pred.partialEval().f(o):false},}]});
foam.CLASS({package:"foam.mlang.predicate",name:"FScriptPredicate",extends:"foam.mlang.predicate.AbstractPredicate",properties:[{class:"String",name:"query"},{class:"Object",name:"prop",}],methods:[{name:"f",code:function(o){return foam.mlang.predicate.FScript.create({query:this.query,prop:this.prop}).f(o)},}]});
foam.CLASS({package:"foam.mlang.predicate",name:"NamedProperty",extends:"foam.mlang.AbstractExpr",implements:["foam.core.Serializable"],axioms:[foam.pattern.Multiton.create({property:"propName"}),{name:"javaExtras",buildJavaClass:function(cls){cls.extras.push(`
protected final static Map map__ = new ConcurrentHashMap();
public static NamedProperty create(String propName) {
NamedProperty p = (NamedProperty) map__.get(propName);
if ( p == null ) {
p = new NamedProperty();
p.setPropName(propName);
map__.put(propName, p);
}
return p;
}
`)}}],properties:[{class:"Map",name:"specializations_",factory:function(){return{}},},{class:"String",name:"propName"}],methods:[{name:"f",code:function(o){return this.specialization(o.model_).f(o)},},{name:"specialization",args:[{name:"model",type:"ClassInfo"}],type:"Expr",code:function(model){return this.specializations_[model.name]||(this.specializations_[model.name]=this.specialize(model))},},{name:"specialize",args:[{name:"model",type:"ClassInfo"}],type:"Expr",code:function(model){for(var i=0;i<model.properties.length;i++){var prop=model.properties[i];if(this.propName==prop.name||this.propName==prop.shortName||prop.aliases.includes(this.propName))return prop}return},},function toString(){return this.propName}]});
foam.CLASS({package:"foam.mlang.predicate",name:"OlderThan",extends:"foam.mlang.predicate.Unary",implements:["foam.core.Serializable"],properties:[{class:"Long",name:"timeMs"}],methods:[{name:"f",code:function(o){var v1=this.arg1.f(o);return v1&&Date.now()-v1.getTime()>this.timeMs},}]});
foam.CLASS({package:"foam.mlang",name:"CurrentTime",extends:"foam.mlang.AbstractExpr",axioms:[{class:"foam.pattern.Singleton"}],methods:[{name:"f",code:function(_){return new Date},},{name:"toString",code:function(){return"CurrentTime"},}]});
foam.CLASS({package:"foam.mlang",name:"StringLength",extends:"foam.mlang.AbstractExpr",properties:[{class:"foam.mlang.ExprProperty",name:"arg1"}],methods:[{name:"f",code:function(o){return this.arg1.f(o).length},}]});
foam.CLASS({package:"foam.mlang",name:"IdentityExpr",extends:"foam.mlang.AbstractExpr",axioms:[{class:"foam.pattern.Singleton"}],methods:[{name:"f",code:function(o){return o},}]});
foam.CLASS({package:"foam.mlang",name:"IsValid",extends:"foam.mlang.predicate.Unary",implements:["foam.core.Serializable"],properties:[{class:"foam.mlang.ExprProperty",name:"arg1"}],methods:[{name:"f",code:function(o){return this.arg1.f(o)==undefined||this.arg1.f(o).errors_?false:true},}]});
foam.CLASS({package:"foam.mlang.predicate",name:"isAuthorizedToRead",extends:"foam.mlang.predicate.AbstractPredicate",implements:["foam.core.Serializable"],properties:[{javaInfoType:"foam.core.AbstractObjectPropertyInfo",flags:["java"],name:"userContext"},{javaInfoType:"foam.core.AbstractObjectPropertyInfo",flags:["java"],name:"authorizer"}],methods:[{name:"f",code:function(){return true},}]});
foam.CLASS({package:"foam.mlang.predicate",name:"isAuthorizedToDelete",extends:"foam.mlang.predicate.AbstractPredicate",implements:["foam.core.Serializable"],properties:[{javaInfoType:"foam.core.AbstractObjectPropertyInfo",flags:["java"],name:"userContext"},{javaInfoType:"foam.core.AbstractObjectPropertyInfo",flags:["java"],name:"authorizer"}],methods:[{name:"f",code:function(){return true},}]});
foam.CLASS({package:"foam.mlang",name:"Formula",extends:"foam.mlang.AbstractExpr",abstract:true,properties:[{class:"foam.mlang.ExprArrayProperty",name:"args"},{class:"Boolean",name:"rounding"}],methods:[{name:"f",code:function(o){var result=null;for(var i=0;i<this.args.length;i++){var current=typeof this.args[i]==="number"?this.args[i]:this.args[i].f(o);if(typeof current==="number"){var oldResult=result;result=result===null?current:this.reduce(result,current);if(!isFinite(result)){var formula=this.cls_.name+"("+oldResult+", "+current+")";throw new Error("Failed to evaluate formula:"+formula+", result: "+result)}}}return this.rounding?Math.round(result):result}},{name:"reduce",type:"Double",abstract:true,args:[{name:"accumulator",type:"Double"},{name:"currentValue",type:"Double"}]},{name:"partialEval",type:"foam.mlang.Expr",},{name:"toString",type:"String",code:function(){return this.cls_.name+"("+this.args.map(a=>a.toString())+")"}}]});
foam.CLASS({package:"foam.mlang.expr",name:"Add",extends:"foam.mlang.Formula",implements:["foam.core.Serializable"],methods:[{name:"reduce",abstract:false,code:(accumulator,currentValue)=>accumulator+currentValue}]});
foam.CLASS({package:"foam.mlang.expr",name:"Subtract",extends:"foam.mlang.Formula",implements:["foam.core.Serializable"],methods:[{name:"reduce",abstract:false,code:(accumulator,currentValue)=>accumulator-currentValue}]});
foam.CLASS({package:"foam.mlang.expr",name:"Multiply",extends:"foam.mlang.Formula",implements:["foam.core.Serializable"],methods:[{name:"reduce",abstract:false,code:(accumulator,currentValue)=>accumulator*currentValue}]});
foam.CLASS({package:"foam.mlang.expr",name:"Divide",extends:"foam.mlang.Formula",implements:["foam.core.Serializable"],methods:[{name:"reduce",abstract:false,code:(accumulator,currentValue)=>accumulator/currentValue}]});
foam.CLASS({package:"foam.mlang.expr",name:"MinFunc",extends:"foam.mlang.Formula",implements:["foam.core.Serializable"],methods:[{name:"reduce",abstract:false,code:(accumulator,currentValue)=>Math.min(accumulator,currentValue)}]});
foam.CLASS({package:"foam.mlang.expr",name:"MaxFunc",extends:"foam.mlang.Formula",implements:["foam.core.Serializable"],methods:[{name:"reduce",abstract:false,code:(accumulator,currentValue)=>Math.max(accumulator,currentValue)}]});
foam.CLASS({package:"foam.mlang",name:"If",extends:"foam.mlang.AbstractExpr",properties:[{class:"foam.mlang.predicate.PredicateProperty",name:"predicate",},{class:"foam.mlang.ExprProperty",name:"trueExpr"},{class:"foam.mlang.ExprProperty",name:"falseExpr"}],methods:[{name:"f",},{name:"toString",type:"String",code:function(){return;"If(predicate:"+(this.predicate&&this.predicate.toString()||"NA")+", trueExpr:"+(this.trueExpr&&this.trueExpr.toString()||"NA")+", falseExpr:"+(this.falseExpr&&this.falseExpr.toString()||"NA")+")"}}]});
foam.CLASS({package:"foam.mlang",name:"DOTMQLTest",extends:"foam.nanos.test.Test",methods:[{name:"runTest",},{name:"isValid",type:"Boolean",args:[{name:"query",type:"String"},{name:"statement",type:"String"}],}]});
foam.CLASS({package:"foam.mlang.expr",name:"PropertyExpr",extends:"foam.mlang.AbstractExpr",implements:["foam.core.Serializable"],properties:[{class:"Class",name:"of",label:"Model",gridColumns:6,factory:function(){return this.property?this.property.forClass_:null},view:{class:"foam.u2.view.StrategizerChoiceView",desiredModelId:"foam.Class"}},{name:"property",gridColumns:6,view:function(_,X){return{class:"foam.u2.view.ChoiceView",choices$:X.data.of$.map(of=>{return of?of.getAxiomsByClass(foam.core.Property).map(axiom=>[axiom,axiom.label]):[]})}},javaInfoType:"foam.core.AbstractObjectPropertyInfo"}],methods:[{name:"f",code:function(obj){return this.property.f(obj)},},{name:"createStatement",},{name:"toString",code:function(){return foam.String.constantize(this.property.name)}}]});foam.ENUM({package:"foam.mlang.expr",name:"DateTypes",values:[{name:"HOURS",conversionFactorMs:36e5},{name:"DAYS",conversionFactorMs:864e5},{name:"WEEKS",conversionFactorMs:6048e5},{name:"MONTHS",conversionFactorMs:2629743833},{name:"YEARS",conversionFactorMs:31556926e3}],properties:[{class:"Long",name:"conversionFactorMs"}]});
foam.CLASS({package:"foam.mlang.expr",name:"DateGrouping",properties:[{class:"String",name:"name"},{class:"Int",name:"low",value:-2147483648},{class:"Int",name:"high",value:2147483647}]});
foam.CLASS({package:"foam.mlang.expr",name:"DateGroupingExpr",extends:"foam.mlang.AbstractExpr",implements:["foam.core.Serializable"],properties:[{class:"Enum",of:"foam.time.TimeUnit",name:"dateGroupingType",value:"MONTH"}],methods:[{name:"f",args:[{name:"obj",type:"Object"}],code:function(obj){if(obj.created){var dateCreated=new Date(obj.created);if(this.dateGroupingType==foam.time.TimeUnit.DAY){return dateCreated.toLocaleString([],{day:"numeric",month:"long",year:"numeric"})}else if(this.dateGroupingType==foam.time.TimeUnit.MONTH){return dateCreated.toLocaleString([],{month:"long",year:"numeric"})}else if(this.dateGroupingType==foam.time.TimeUnit.YEAR){return dateCreated.toLocaleString([],{year:"numeric"})}}return"Unknown Range"},}]});
foam.CLASS({package:"foam.mlang.expr",name:"DateTimeGroupingExpr",extends:"foam.mlang.AbstractExpr",implements:["foam.core.Serializable"],properties:[{class:"Enum",of:"foam.time.TimeUnit",name:"dateGroupingType",value:"DAY"},{class:"FObjectArray",of:"foam.mlang.expr.DateGrouping",name:"dateGroups",factory:function(){return[]},}],methods:[{name:"f",code:function(obj){var groups=[...this.dateGroups];groups.sort((a,b)=>a.low-b.low);var offset=(new Date).getTimezoneOffset()*6e4;var diff=Math.floor(((new Date).getTime()-offset)/this.dateGroupingType.conversionFactorMs)-Math.floor((obj.created.getTime()-offset)/this.dateGroupingType.conversionFactorMs);for(var i=0;i<groups.length;i++){var group=groups[i];if(diff>=group.low&&diff<group.high)return group.name}return"Unknown Range"},}]});
foam.CLASS({package:"foam.mlang.expr",name:"Ref",extends:"foam.mlang.AbstractExpr",implements:["foam.core.Serializable"],properties:[{class:"foam.mlang.ExprProperty",name:"arg1"}],methods:[{name:"f",code:function(o){return null},},function comparePropertyValues(o1,o2){return this.arg1.comparePropertyValues(o1,o2)}]});
foam.CLASS({package:"foam.mlang.expr",name:"TimeOfDay",extends:"foam.mlang.AbstractExpr",implements:["foam.core.Serializable"],properties:[{class:"Int",name:"hour"},{class:"Int",name:"minute"},{class:"Int",name:"second"},{class:"Reference",of:"foam.nanos.auth.Country",name:"country"},{class:"Reference",of:"foam.time.TimeZone",name:"timezone",required:true}],methods:[{name:"f",code:function(){var typeToIdx={year:0,month:1,day:2};var zonetime=new Intl.DateTimeFormat("default",{timeZone:this.timezone,year:"numeric",month:"2-digit",day:"2-digit"});var formatted=zonetime.formatToParts(new Date);var p={};for(var i=0;i<formatted.length;i++){var{type,value}=formatted[i];var offset=typeToIdx[type];if(!(offset===undefined)){p[type]=parseInt(value,10)}}var d=new Date(p.year,p.month,p.day,this.hour,this.minute,thie.second);return d},},{name:"toString",type:"String",code:function(){return"TimeOfDay(hour:"+this.hour+", minute:"+this.minute+", second:"+this.second+", country:"+this.country+", timezone:"+this.timezone+")"},}]});
foam.CLASS({package:"foam.mlang.predicate",name:"ContextUserPredicate",extends:"foam.mlang.predicate.AbstractPredicate",implements:["foam.core.Serializable"],properties:[{class:"foam.mlang.predicate.PredicateProperty",name:"arg1"}],methods:[{name:"f",}]});
foam.CLASS({package:"foam.mlang.predicate",name:"CapabilityAuthServicePredicate",extends:"foam.mlang.predicate.AbstractPredicate",properties:[{name:"capabilityDAO",class:"FObjectProperty",of:"foam.dao.DAO"},{name:"permission",class:"String"},{name:"entity",class:"Enum",of:"foam.nanos.crunch.AssociatedEntity"}],methods:[{name:"f",args:[{name:"obj",type:"Object"}],},{name:"fclone",type:"FObject",}]});
foam.CLASS({package:"foam.mlang.predicate",name:"AuthPermissionPredicate",extends:"foam.mlang.predicate.AbstractPredicate",properties:[{name:"permission",class:"String"}],methods:[{name:"f",}]});
foam.CLASS({package:"foam.mlang",name:"LabeledValue",properties:[{name:"id",expression:function(label){return label}},{class:"String",name:"label",required:true},{name:"value"}]});
foam.CLASS({package:"foam.dao.index",name:"Plan",properties:[{name:"cost",value:0}],methods:[function execute(promise,state,sink,skip,limit,order,predicate){},function toString(){return this.cls_.name+"(cost="+this.cost+")"}]});
foam.CLASS({package:"foam.dao.index",name:"NotFoundPlan",extends:"foam.dao.index.Plan",axioms:[foam.pattern.Singleton.create()],properties:[{name:"cost",value:0}],methods:[function toString(){return"no-match(cost=0)"}]});
foam.CLASS({package:"foam.dao.index",name:"NoPlan",extends:"foam.dao.index.Plan",axioms:[foam.pattern.Singleton.create()],properties:[{name:"cost",value:Number.MAX_VALUE}],methods:[function toString(){return"no-plan"}]});
foam.CLASS({package:"foam.dao.index",name:"CustomPlan",extends:"foam.dao.index.Plan",properties:[{class:"Function",name:"customExecute"},{class:"Function",name:"customToString"}],methods:[function execute(promise,state,sink,skip,limit,order,predicate){this.customExecute.call(this,promise,state,sink,skip,limit,order,predicate)},function toString(){return this.customToString.call(this)}]});
foam.CLASS({package:"foam.dao.index",name:"CountPlan",extends:"foam.dao.index.Plan",properties:[{class:"Int",name:"count"}],methods:[function execute(promise,sink){sink.value+=this.count},function toString(){return"short-circuit-count("+this.count+")"}]});
foam.CLASS({package:"foam.dao.index",name:"AltPlan",extends:"foam.dao.index.Plan",properties:[{name:"subPlans",factory:function(){return[]},postSet:function(o,nu){this.cost=1;for(var i=0;i<nu.length;++i){this.cost+=nu[i].cost}}},"prop"],methods:[function execute(promise,sink,skip,limit,order,predicate){var sp=this.subPlans;for(var i=0;i<sp.length;++i){sp[i].execute(promise,sink,skip,limit,order,predicate)}},function toString(){return!this.subPlans||this.subPlans.length<=1?"IN(key="+(this.prop&&this.prop.name)+", cost="+this.cost+", "+", size="+(this.subPlans?this.subPlans.length:0)+")":"lookup(key="+this.prop&&this.prop.name+", cost="+this.cost+", "+this.subPlans[0].toString()}]});
foam.CLASS({package:"foam.dao.index",name:"MergePlan",extends:"foam.dao.index.AltPlan",requires:["foam.dao.DedupSink","foam.dao.LimitedSink","foam.dao.OrderedSink","foam.dao.SkipSink"],properties:[{class:"Class",name:"of"},"predicates"],methods:[function execute(promise,sink,skip,limit,order,predicate){if(order)return this.executeOrdered(promise,sink,skip,limit,order,predicate);return this.executeFallback(promise,sink,skip,limit,order,predicate)},function executeOrdered(promise,sink,skip,limit,order,predicate){foam.assert(order&&order.compare,"Order.compare() must be supplied in MergePlan.executeOrdered()");foam.assert(!this.predicates||this.predicates.size==this.subPlans.size,"MergePlan.predicates, when specified, must match the number of subplans.");var NodeProto={next:null,data:null};var head=Object.create(NodeProto);var sp=this.subPlans;var predicates=this.predicates;var subLimit=limit?limit+(skip?skip:0):undefined;var promises=[];var dedupCompare=this.of?this.of.ID.compare.bind(this.of.ID):foam.util.compare;var compare=order.compare.bind(order);for(var i=0;i<sp.length;++i){var insertPlanSink;(function(){var insertAfter=head;insertPlanSink=foam.dao.QuickSink.create({putFn:function(o){function insert(){var nu=Object.create(NodeProto);nu.next=insertAfter.next;nu.data=o;insertAfter.next=nu}while(insertAfter.next&&compare(o,insertAfter.next.data)>0){insertAfter=insertAfter.next}if(!insertAfter.next){insert();return}else if(compare(o,insertAfter.next.data)===0){var dupeAfter=insertAfter;while(dupeAfter.next&&compare(o,dupeAfter.next.data)===0){if(dedupCompare(o,dupeAfter.next.data)===0){return}dupeAfter=dupeAfter.next}var nu=Object.create(NodeProto);nu.next=dupeAfter.next;nu.data=o;dupeAfter.next=nu;dupeAfter=null;return}else{insert()}}})})();var nuPromiseRef=[];sp[i].execute(nuPromiseRef,insertPlanSink,undefined,subLimit,order,predicates?predicates[i]:predicate);if(nuPromiseRef[0])promises.push(nuPromiseRef[0])}var resultSink=this.decorateSink_(sink,skip,limit);var sub=foam.core.FObject.create();var detached=false;sub.onDetach(function(){detached=true});function scanResults(){var node=head.next;while(node&&!detached){resultSink.put(node.data,sub);node=node.next}}if(promises.length){var thisPromise=Promise.all(promises).then(scanResults);promise[0]=promise[0]?promise[0].then(function(){return thisPromise}):thisPromise}else{scanResults()}},function executeFallback(promise,sink,skip,limit,order,predicate){var resultSink=this.DedupSink.create({delegate:this.decorateSink_(sink,skip,limit)});foam.assert(!this.predicates||this.predicates.size==this.subPlans.size,"MergePlan.predicates, when specified, must match the number of subplans.");var sp=this.subPlans;var predicates=this.predicates;var subLimit=limit?limit+(skip?skip:0):undefined;for(var i=0;i<sp.length;++i){sp[i].execute(promise,resultSink,undefined,subLimit,order,predicates?predicates[i]:predicate)}},function decorateSink_(sink,skip,limit){if(limit!=undefined){sink=this.LimitedSink.create({limit:limit,delegate:sink})}if(skip!=undefined){sink=this.SkipSink.create({skip:skip,delegate:sink})}return sink}]});
foam.CLASS({package:"foam.dao.index",name:"Index",requires:["foam.dao.index.TreeNode","foam.dao.index.AutoIndexNode","foam.dao.index.AltIndexNode","foam.dao.index.ValueIndexNode","foam.dao.index.TreeIndexNode","foam.dao.index.CITreeIndexNode","foam.dao.index.IndexNode","foam.dao.index.SetIndexNode","foam.dao.index.NullTreeNode","foam.dao.index.ProxyIndexNode"],properties:[{class:"Class",name:"nodeClass",factory:function(){return this.cls_.id+"Node"}}],methods:[function estimate(size,sink,skip,limit,order,predicate){return size*size},function toPrettyString(indent){},function createNode(args){args=args||{};args.index=this;return this.nodeClass.create(args,this)}]});
foam.CLASS({package:"foam.dao.index",name:"IndexNode",properties:[{class:"Simple",name:"index"}],methods:[function put(obj){},function remove(obj){},function plan(sink,skip,limit,order,predicate,root){},function get(key){},function size(){},function select(sink,skip,limit,order,predicate,cache){},function bulkLoad(dao){}]});
foam.CLASS({package:"foam.dao.index",name:"ProxyIndex",extends:"foam.dao.index.Index",properties:[{name:"delegate",required:true}],methods:[function estimate(size,sink,skip,limit,order,predicate){return this.delegate.estimate(size,sink,skip,limit,order,predicate)},function toPrettyString(indent){return this.delegate.toPrettyString(indent)},function toString(){return"["+this.cls_.name+": "+this.delegate.toString()+"]"}]});
foam.CLASS({package:"foam.dao.index",name:"ProxyIndexNode",extends:"foam.dao.index.IndexNode",properties:[{class:"Simple",name:"delegate"}],methods:[function init(){this.delegate=this.delegate||this.index.delegate.createNode()},function put(o){return this.delegate.put(o)},function remove(o){return this.delegate.remove(o)},function plan(sink,skip,limit,order,predicate,root){return this.delegate.plan(sink,skip,limit,order,predicate,root)},function get(key){return this.delegate.get(key)},function size(){return this.delegate.size()},function select(sink,skip,limit,order,predicate,cache){return this.delegate.select(sink,skip,limit,order,predicate,cache)},function bulkLoad(dao){return this.delegate.bulkLoad(dao)}]});
foam.CLASS({package:"foam.dao.index",name:"AltIndex",extends:"foam.dao.index.Index",requires:["foam.dao.AnonymousSink","foam.dao.index.NoPlan","foam.mlang.sink.NullSink"],constants:{GOOD_ENOUGH_PLAN:10},properties:[{name:"delegates",factory:function(){return[]}},{name:"delegateMap_",factory:function(){return{}}}],methods:[function estimate(size,sink,skip,limit,order,predicate){var cost=Number.MAX_VALUE;for(var i=0;i<this.delegates.length;i++){cost=Math.min(cost,this.delegates[i].estimate(size,sink,skip,limit,order,predicate))}return cost},function toPrettyString(indent){var ret="";for(var i=0;i<this.delegates.length;i++){ret+=this.delegates[i].toPrettyString(indent+1)}return ret},function toString(){return"Alt(["+this.delegates.join(",")+"])"}]});
foam.CLASS({package:"foam.dao.index",name:"AltIndexNode",extends:"foam.dao.index.IndexNode",properties:[{class:"Simple",name:"delegates"}],methods:[function init(){this.delegates=this.delegates||[this.index.delegates[0].createNode()]},function addIndex(index){var dfmap=this.index.delegateMap_;var indexKey=index.toString();if(!dfmap[indexKey]){this.index.delegates.push(index);dfmap[indexKey]=index}else{index=dfmap[indexKey]}var newSubInst=index.createNode();var wrapped=this.index.AnonymousSink.create({sink:newSubInst});this.delegates[0].plan(wrapped).execute([],wrapped);this.delegates.push(newSubInst)},function bulkLoad(a){for(var i=0;i<this.delegates.length;i++){this.delegates[i].bulkLoad(a)}},function get(key){return this.delegates[0].get(key)},function pickDelegate(order,cache){var delegates=this.delegates;if(!order)return delegates[0];var c=cache[this];if(!c){var nullSink=this.index.NullSink.create();var dfs=this.index.delegates;var bestEst=Number.MAX_VALUE;for(var i=0;i<dfs.length;i++){var est=dfs[i].estimate(1e3,nullSink,undefined,undefined,order);if(est<bestEst){c=dfs[i];bestEst=est}}cache[this]=c}for(var i=0;i<delegates.length;i++){if(delegates[i].index===c)return delegates[i]}var newSubInst=c.createNode();var wrapped=this.index.AnonymousSink.create({sink:newSubInst});this.delegates[0].plan(wrapped).execute([],wrapped);this.delegates.push(newSubInst);return newSubInst},function select(sink,skip,limit,order,predicate,cache){this.pickDelegate(order,cache).select(sink,skip,limit,order,predicate,cache)},function put(newValue){for(var i=0;i<this.delegates.length;i++){this.delegates[i].put(newValue)}},function remove(obj){for(var i=0;i<this.delegates.length;i++){this.delegates[i].remove(obj)}},function plan(sink,skip,limit,order,predicate,root){var bestPlan;for(var i=0;i<this.delegates.length;i++){var p=this.delegates[i].plan(sink,skip,limit,order,predicate,root);if(p.cost<=this.index.GOOD_ENOUGH_PLAN){bestPlan=p;break}if(!bestPlan||p.cost<bestPlan.cost){bestPlan=p}}if(!bestPlan){return this.index.NoPlan.create()}return bestPlan},function size(){return this.delegates[0].size()},function toString(){return"Alt(["+this.index.delegates.join(",")+this.size()+"])"}]});
foam.CLASS({package:"foam.dao.index",name:"ValueIndex",extends:"foam.dao.index.Index",methods:[function estimate(size,sink,skip,limit,order,predicate){return 1},function toPrettyString(indent){return""}]});
foam.CLASS({package:"foam.dao.index",name:"ValueIndexNode",extends:"foam.dao.index.IndexNode",implements:["foam.dao.index.Plan"],properties:[{class:"Simple",name:"value"},{class:"Simple",name:"cost"}],methods:[function execute(promise,sink,skip,limit,order,predicate){this.select(sink,skip,limit,order,predicate)},function toString(){return"ValueIndex_Plan(cost=1, value:"+this.value+")"},function put(s){this.value=s},function remove(){this.value=undefined},function get(){return this.value},function size(){return typeof this.value==="undefined"?0:1},function plan(){this.cost=1;return this},function select(sink,skip,limit,order,predicate,cache){if(predicate&&!predicate.f(this.value))return;if(skip&&skip[0]-- >0)return;if(limit&&limit[0]--<=0)return;sink.put(this.value)}]});
foam.CLASS({package:"foam.dao.index",name:"TreeNode",properties:[{class:"Simple",name:"key"},{class:"Simple",name:"value"},{class:"Simple",name:"size"},{class:"Simple",name:"level"},{class:"Simple",name:"left"},{class:"Simple",name:"right"}],methods:[function maybeClone(locked){return locked?this.clone():this},function clone(){var c=this.cls_.create();c.key=this.key;c.value=this.value;c.size=this.size;c.level=this.level;c.left=this.left;c.right=this.right;return c},function updateSize(){this.size=this.left.size+this.right.size+this.value.size()},function skew(locked){if(this.left.level===this.level){var l=this.left.maybeClone(locked);this.left=l.right;l.right=this;this.updateSize();l.updateSize();return l}return this},function split(locked){if(this.right.level&&this.right.right.level&&this.level===this.right.right.level){var r=this.right.maybeClone(locked);this.right=r.left;r.left=this;r.level++;this.updateSize();r.updateSize();return r}return this},function predecessor(){if(!this.left.level)return this;for(var s=this.left;s.right.level;s=s.right){}return s},function successor(){if(!this.right.level)return this;for(var s=this.right;s.left.level;s=s.left){}return s},function decreaseLevel(locked){var expectedLevel=Math.min(this.left.level?this.left.level:0,this.right.level?this.right.level:0)+1;if(expectedLevel<this.level){this.level=expectedLevel;if(this.right.level&&expectedLevel<this.right.level){this.right=this.right.maybeClone(locked);this.right.level=expectedLevel}}return this},function get(key,compare){var r=compare(this.key,key);if(r===0)return this.value;return r>0?this.left.get(key,compare):this.right.get(key,compare)},function getAll(key,compare,retArray){var r=compare(this.key,key);if(r===0)retArray.push(this.value);this.left.getAll(key,compare,retArray);this.right.getAll(key,compare,retArray)},function putKeyValue(key,value,compare,dedup,locked){var s=this.maybeClone(locked);var r=compare(s.key,key);if(r===0){dedup(value,s.key);s.size-=s.value.size();s.value.put(value);s.size+=s.value.size()}else{var side=r>0?"left":"right";if(s[side].level)s.size-=s[side].size;s[side]=s[side].putKeyValue(key,value,compare,dedup,locked);s.size+=s[side].size}return s.split(locked).skew(locked)},function removeKeyValue(key,value,compare,locked,nullNode){var s=this.maybeClone(locked);var side;var r=compare(s.key,key);if(r===0){s.size-=s.value.size();s.value.remove(value);if(s.value&&s.value.size()>0){s.size+=s.value.size();return s}if(!s.left.level&&!s.right.level){return nullNode}side=s.left.level?"left":"right";var l=side==="left"?s.predecessor():s.successor();s.key=l.key;s.value=l.value;s[side]=s[side].removeNode(l.key,compare,locked)}else{side=r>0?"left":"right";s.size-=s[side].size;s[side]=s[side].removeKeyValue(key,value,compare,locked,nullNode);s.size+=s[side].size}s=s.decreaseLevel(locked).skew(locked);if(s.right.level){s.right=s.right.maybeClone(locked).skew(locked);if(s.right.right.level){s.right.right=s.right.right.maybeClone(locked).skew(locked)}}s=s.split(locked);s.right=s.right.maybeClone(locked).split(locked);return s},function removeNode(key,compare,locked){var s=this.maybeClone(locked);var r=compare(s.key,key);if(r===0)return s.left.level?s.left:s.right;var side=r>0?"left":"right";s.size-=s[side].size;s[side]=s[side].removeNode(key,compare,locked);s.size+=s[side].size;return s},function select(sink,skip,limit,order,predicate,cache){if(limit&&limit[0]<=0)return;if(skip&&skip[0]>=this.size&&!predicate){skip[0]-=this.size;return}this.left.select(sink,skip,limit,order,predicate,cache);this.value.select(sink,skip,limit,order&&order.orderTail(),predicate,cache);this.right.select(sink,skip,limit,order,predicate,cache)},function selectReverse(sink,skip,limit,order,predicate,cache){if(limit&&limit[0]<=0)return;if(skip&&skip[0]>=this.size&&!predicate){skip[0]-=this.size;return}this.right.selectReverse(sink,skip,limit,order,predicate,cache);this.value.select(sink,skip,limit,order&&order.orderTail(),predicate,cache);this.left.selectReverse(sink,skip,limit,order,predicate,cache)},function gt(key,compare){var s=this;var r=compare(key,s.key);if(r<0){var l=s.left.gt(key,compare);var copy=s.clone();copy.size=s.size-s.left.size+l.size;copy.left=l;return copy}if(r>0)return s.right.gt(key,compare);return s.right},function gte(key,compare,nullNode){var s=this;var copy;var r=compare(key,s.key);if(r<0){var l=s.left.gte(key,compare,nullNode);copy=s.clone();copy.size=s.size-s.left.size+l.size;copy.left=l;return copy}if(r>0)return s.right.gte(key,compare,nullNode);copy=s.clone();copy.size=s.size-s.left.size;copy.left=nullNode;return copy},function lt(key,compare){var s=this;var r=compare(key,s.key);if(r>0){var rt=s.right.lt(key,compare);var copy=s.clone();copy.size=s.size-s.right.size+rt.size;copy.right=rt;return copy}if(r<0)return s.left.lt(key,compare);return s.left},function lte(key,compare,nullNode){var s=this;var copy;var r=compare(key,s.key);if(r>0){var rt=s.right.lte(key,compare,nullNode);copy=s.clone();copy.size=s.size-s.right.size+rt.size;copy.right=rt;return copy}if(r<0)return s.left.lte(key,compare,nullNode);copy=s.clone();copy.size=s.size-s.right.size;copy.right=nullNode;return copy}]});
foam.CLASS({package:"foam.dao.index",name:"NullTreeNode",properties:[{class:"Simple",name:"tail"},{class:"Simple",name:"treeNode"},{class:"Simple",name:"left"},{class:"Simple",name:"right"},{class:"Simple",name:"size"},{class:"Simple",name:"level"}],methods:[function init(){this.left=undefined;this.right=undefined;this.size=0;this.level=0},function clone(){return this},function maybeClone(){return this},function skew(locked){return this},function split(locked){return this},function decreaseLevel(){return this},function get(){return undefined},function updateSize(){},function putKeyValue(key,value){var subIndex=this.tail.createNode();subIndex.put(value);var n=this.treeNode.create();n.left=this;n.right=this;n.key=key;n.value=subIndex;n.size=1;n.level=1;return n},function removeKeyValue(){return this},function removeNode(){return this},function select(){},function selectReverse(){},function gt(){return this},function gte(){return this},function lt(){return this},function lte(){return this},function getAll(){return},function bulkLoad_(a,start,end,keyExtractor){if(end<start)return this;var tree=this;var m=start+Math.floor((end-start+1)/2);tree=tree.putKeyValue(keyExtractor(a[m]),a[m]);tree.left=tree.left.bulkLoad_(a,start,m-1,keyExtractor);tree.right=tree.right.bulkLoad_(a,m+1,end,keyExtractor);tree.size+=tree.left.size+tree.right.size;return tree}]});
foam.CLASS({package:"foam.dao.index",name:"PropertyToIndexRefinement",refines:"foam.core.Property",requires:["foam.dao.index.TreeIndex"],methods:[function toIndex(tail){return this.TreeIndex.create({prop:this,tail:tail})}]});
foam.CLASS({package:"foam.dao.index",name:"FObjectArrayToIndexRefinement",refines:"foam.core.FObjectArray",requires:["foam.dao.index.SetIndex"],methods:[function toIndex(tail){return this.SetIndex.create({prop:this,tail:tail})}]});
foam.CLASS({package:"foam.dao.index",name:"AxiomArrayToIndexRefinement",refines:"foam.core.AxiomArray",requires:["foam.dao.index.SetIndex"],methods:[function toIndex(tail){return this.SetIndex.create({prop:this,tail:tail})}]});
foam.CLASS({package:"foam.dao.index",name:"StringArrayToIndexRefinement",refines:"foam.core.StringArray",requires:["foam.dao.index.SetIndex"],methods:[function toIndex(tail){return this.SetIndex.create({prop:this,tail:tail})}]});
foam.CLASS({package:"foam.dao.index",name:"TreeIndex",extends:"foam.dao.index.Index",requires:["foam.core.Property","foam.dao.ArraySink","foam.mlang.sink.NullSink","foam.dao.index.MergePlan","foam.dao.index.CountPlan","foam.dao.index.CustomPlan","foam.dao.index.NotFoundPlan","foam.dao.index.NullTreeNode","foam.dao.index.TreeNode","foam.dao.index.ValueIndex","foam.mlang.order.Desc","foam.mlang.order.Comparator","foam.mlang.order.ThenBy","foam.mlang.predicate.And","foam.mlang.predicate.Eq","foam.mlang.predicate.False","foam.mlang.predicate.Gt","foam.mlang.predicate.Gte","foam.mlang.predicate.Lt","foam.mlang.predicate.Lte","foam.mlang.predicate.Or","foam.mlang.predicate.True","foam.mlang.predicate.In","foam.mlang.predicate.Contains","foam.mlang.predicate.ContainsIC","foam.mlang.sink.Count","foam.mlang.sink.Explain"],constants:{IS_EXPR_MATCH_FN:function isExprMatch(predicate,prop,model){var self=this.index||this;if(predicate&&model&&prop){if(model.isInstance(predicate)&&(predicate.arg1===prop||foam.util.equals(predicate.arg1,prop))){var arg2=predicate.arg2;predicate=undefined;return{arg2:arg2,predicate:predicate}}if(predicate.args&&self.And.isInstance(predicate)){for(var i=0;i<predicate.args.length;i++){var q=predicate.args[i];if(model.isInstance(q)&&(q.arg1===prop||foam.util.equals(q.arg1,prop))){predicate=predicate.clone();predicate.args[i]=self.True.create();predicate=predicate.partialEval();if(self.True.isInstance(predicate))predicate=undefined;return{arg2:q.arg2,predicate:predicate}}}}}return undefined}},properties:[{name:"prop",required:true},{name:"nullNode",factory:function(){var nn=this.NullTreeNode.create({tail:this.tail,treeNode:this.treeNode});return nn}},{name:"treeNode",factory:function(){return this.TreeNode}},{name:"tail",required:true}],methods:[function init(){this.dedup=this.dedup.bind(this,this.prop.name)},function dedup(propName,obj,value){obj[propName]=value},function compare(o1,o2){return foam.util.compare(o1,o2)},function isOrderSelectable(order){if(!order)return true;if(false){return 9965>this.tail.estimate(1e3,this.NullSink.create(),0,0,order.orderTail())}return false},function estimate(size,sink,skip,limit,order,predicate){if(size<=16)return Math.log(size)/Math.log(2);if(order&&!(predicate||skip||limit)){return this.isOrderSelectable(order)?size:size*Math.log(size)/Math.log(2)}var self=this;predicate=predicate?predicate.clone():null;var property=this.prop;var nodeCount=Math.floor(size*.25);var isExprMatch=this.IS_EXPR_MATCH_FN.bind(this,predicate,property);var tail=this.tail;var subEstimate=tail?function(){return Math.log(nodeCount)/Math.log(2)+tail.estimate(size/nodeCount,sink,skip,limit,order,predicate)}:function(){return Math.log(nodeCount)/Math.log(2)};var expr=isExprMatch(this.In);if(expr){var numCmp=expr.arg2?expr.arg2.f().length:0;return subEstimate()*numCmp}expr=isExprMatch(this.Eq);if(expr){return subEstimate()}expr=isExprMatch(this.ContainsIC);if(expr)ic=true;expr=expr||isExprMatch(this.Contains);if(expr){return subEstimate()*expr.arg2.f().length}var cost=size;if(isExprMatch(this.Gt)||isExprMatch(this.Gte)||isExprMatch(this.Lt)||isExprMatch(this.Lte)){cost/=2}if(!this.isOrderSelectable(order)){if(cost>0)cost*=Math.log(cost)/Math.log(2)}return cost},function toString(){return"["+this.cls_.name+": "+this.prop.name+" "+this.tail.toString()+"]"},function toPrettyString(indent){var ret="";var tail=this.tail.toPrettyString(indent+1);ret="  ".repeat(indent)+this.prop.name+"("+this.$UID+")\n";if(tail.trim().length>0)ret+=tail;return ret}]});
foam.CLASS({package:"foam.dao.index",name:"TreeIndexNode",extends:"foam.dao.index.IndexNode",properties:[{class:"Simple",name:"selectCount"},{class:"Simple",name:"root"}],methods:[function init(){this.root=this.root||this.index.nullNode;this.selectCount=this.selectCount||0},function bulkLoad(a){a=a.array||a;this.root=this.index.nullNode;if(this.index.ValueIndex.isInstance(this.tail)){var prop=this.index.prop;a.sort(prop.compare.bind(prop));this.root=this.root.bulkLoad_(a,0,a.length-1,prop.f)}else{for(var i=0;i<a.length;i++){this.put(a[i])}}},function put(newValue){this.root=this.root.putKeyValue(this.index.prop.f(newValue),newValue,this.index.compare,this.index.dedup,this.selectCount>0)},function remove(value){this.root=this.root.removeKeyValue(this.index.prop.f(value),value,this.index.compare,this.selectCount>0,this.index.nullNode)},function get(key){return this.root.get(key,this.index.compare)},function select(sink,skip,limit,order,predicate,cache){if(order&&order.orderDirection()<0){this.root.selectReverse(sink,skip,limit,order,predicate,cache)}else{this.root.select(sink,skip,limit,order,predicate,cache)}},function size(){return this.root.size},function plan(sink,skip,limit,order,predicate,root){var index=this;var m=this.index;if(m.False.isInstance(predicate))return m.NotFoundPlan.create();if(!predicate&&m.Count.isInstance(sink)){var count=this.size();return m.CountPlan.create({count:count})}var prop=m.prop;if(foam.mlang.sink.GroupBy.isInstance(sink)&&sink.arg1===prop){}var result,subPlan,cost;var isExprMatch=m.IS_EXPR_MATCH_FN.bind(this,predicate,prop);var expr=isExprMatch(m.In);if(expr){predicate=expr.predicate;var keys=expr.arg2.f()||[];if(Math.log(this.size())/Math.log(2)*keys.length<this.size()){var subPlans=[];cost=1;for(var i=0;i<keys.length;++i){result=this.get(keys[i]);if(result){subPlan=result.plan(sink,skip,limit,order,predicate,root);cost+=subPlan.cost;subPlans.push(subPlan)}}if(subPlans.length===0)return m.NotFoundPlan.create();return m.MergePlan.create({subPlans:subPlans,prop:prop})}}expr=isExprMatch(m.Eq);if(expr){predicate=expr.predicate;var key=expr.arg2.f();result=this.get(key,this.index.compare);if(!result)return m.NotFoundPlan.create();subPlan=result.plan(sink,skip,limit,order,predicate,root);return subPlan}var ic=false;expr=isExprMatch(m.ContainsIC);if(expr)ic=true;expr=expr||isExprMatch(m.Contains);if(expr){predicate=expr.predicate;var key=ic?expr.arg2.f().toLowerCase():expr.arg2.f();var compareSubstring=function compareSubstring(nodeKey,masterKey){if(!nodeKey||!nodeKey.indexOf||nodeKey.length<masterKey.length)return-1;if(ic)nodeKey=nodeKey.toLowerCase();return nodeKey.indexOf(masterKey)>-1?0:1};var indexes=[];if(!key||key.length===0){this.root.getAll("",function(){return 0},indexes)}else{this.root.getAll(key,compareSubstring,indexes)}var subPlans=[];for(var i=0;i<indexes.length;i++){subPlans.push(indexes[i].plan(sink,skip,limit,order,predicate,root))}return m.MergePlan.create({subPlans:subPlans,prop:prop})}var subTree=this.root;expr=isExprMatch(m.Gt);if(expr)subTree=subTree.gt(expr.arg2.f(),this.index.compare);expr=isExprMatch(m.Gte);if(expr)subTree=subTree.gte(expr.arg2.f(),this.index.compare,this.index.nullNode);expr=isExprMatch(m.Lt);if(expr)subTree=subTree.lt(expr.arg2.f(),this.index.compare);expr=isExprMatch(m.Lte);if(expr)subTree=subTree.lte(expr.arg2.f(),this.index.compare,this.index.nullNode);cost=subTree.size;var sortRequired=!this.index.isOrderSelectable(order);var reverseSort=false;var subOrder;var orderDirections;if(order&&!sortRequired){if(order.orderDirection()<0)reverseSort=true}if(!sortRequired){if(skip)cost-=skip;if(limit)cost=Math.min(cost,limit)}else{if(cost!==0)cost*=Math.log(cost)/Math.log(2)}return m.CustomPlan.create({cost:cost,customExecute:function(promise,sink,skip,limit,order,predicate){if(sortRequired){var arrSink=m.ArraySink.create();index.selectCount++;subTree.select(arrSink,null,null,null,predicate,{});index.selectCount--;var a=arrSink.array;a.sort(order.compare.bind(order));skip=skip||0;limit=Number.isFinite(limit)?limit:a.length;limit+=skip;limit=Math.min(a.length,limit);var sub=foam.core.FObject.create();var detached=false;sub.onDetach(function(){detached=true});for(var i=skip;i<limit;i++){sink.put(a[i],sub);if(detached)break}}else{index.selectCount++;reverseSort?subTree.selectReverse(sink,skip!=null?[skip]:null,limit!=null?[limit]:null,order,predicate,{}):subTree.select(sink,skip!=null?[skip]:null,limit!=null?[limit]:null,order,predicate,{});index.selectCount--}},customToString:function(){return"scan(key="+prop.name+", cost="+this.cost+", sorting="+(sortRequired?order.toString():"none")+", reverseScan="+reverseSort+(predicate&&predicate.toSQL?", predicate: "+predicate.toSQL():"")+")"}})},function toString(){return"TreeIndex("+(this.index||this).prop.name+", "+(this.index||this).tail+")"}]});
foam.CLASS({package:"foam.dao.index",name:"CITreeIndex",extends:"foam.dao.index.TreeIndex"});
foam.CLASS({package:"foam.dao.index",name:"CITreeIndexNode",extends:"foam.dao.index.TreeIndexNode",methods:[function put(newValue){this.root=this.root.putKeyValue(this.index.prop.f(newValue).toLowerCase(),newValue,this.index.compare,this.index.dedup,this.selectCount>0)},function remove(value){this.root=this.root.removeKeyValue(this.index.prop.f(value).toLowerCase(),value,this.index.compare,this.selectCount>0,this.index.nullNode)},function bulkLoad(a){a=a.array||a;this.root=this.index.nullNode;for(var i=0;i<a.length;i++){this.put(a[i])}}]});
foam.CLASS({package:"foam.dao.index",name:"SetIndex",extends:"foam.dao.index.TreeIndex"});
foam.CLASS({package:"foam.dao.index",name:"SetIndexNode",extends:"foam.dao.index.TreeIndexNode",methods:[function dedup(){},function bulkLoad(a){a=a.array||a;this.root=this.index.nullNode;for(var i=0;i<a.length;i++){this.put(a[i])}},function put(newValue){var a=this.index.prop.f(newValue);if(a.length){for(var i=0;i<a.length;i++){this.root=this.root.putKeyValue(a[i],newValue,this.index.compare,this.index.dedup)}}else{this.root=this.root.putKeyValue("",newValue,this.index.compare,this.index.dedup)}},function remove(value){var a=this.index.prop.f(value);if(a.length){for(var i=0;i<a.length;i++){this.root=this.root.removeKeyValue(a[i],value,this.index.compare,this.index.nullNode)}}else{this.root=this.root.removeKeyValue("",value,this.index.compare,this.index.nullNode)}}]});
foam.CLASS({package:"foam.dao.index",name:"AutoIndex",extends:"foam.dao.index.ProxyIndex",requires:["foam.core.Property","foam.dao.index.NoPlan","foam.dao.index.CustomPlan","foam.mlang.predicate.And","foam.mlang.predicate.Or","foam.dao.index.AltIndex","foam.dao.index.ValueIndex","foam.mlang.predicate.True","foam.mlang.predicate.False"],constants:{GOOD_ENOUGH_PLAN:20},properties:[{name:"idIndex",required:true},{name:"delegate",factory:function(){return this.AltIndex.create({delegates:[this.idIndex]})}}],methods:[function estimate(size,sink,skip,limit,order,predicate){return this.delegate.estimate(size,sink,skip,limit,order,predicate)},function toPrettyString(indent){var ret="";ret="  ".repeat(indent)+"Auto("+this.$UID+")\n";ret+=this.delegate.toPrettyString(indent+1);return ret}]});
foam.CLASS({package:"foam.dao.index",name:"AutoIndexNode",extends:"foam.dao.index.ProxyIndexNode",methods:[function addPropertyIndex(prop,root){this.addIndex(prop.toIndex(this.index.cls_.create({idIndex:this.index.idIndex})),root)},function addIndex(index,root){this.delegate.addIndex(index,root)},function plan(sink,skip,limit,order,predicate,root){var existingPlan=this.delegate.plan(sink,skip,limit,order,predicate,root);var thisSize=this.size();if(existingPlan.cost<thisSize||thisSize<this.index.GOOD_ENOUGH_PLAN||!order&&(!predicate||this.index.True.isInstance(predicate)||this.index.False.isInstance(predicate))){return existingPlan}existingPlan.cost+=10;var ARBITRARY_INDEX_CREATE_FACTOR=1.5;var ARBITRARY_INDEX_CREATE_CONSTANT=20;var self=this;var newIndex;var bestEstimate=this.delegate.index.estimate(this.delegate.size(),sink,skip,limit,order,predicate);if(bestEstimate<this.index.GOOD_ENOUGH_PLAN){return existingPlan}var existingEstimate=bestEstimate;var idIndex=this.index.idIndex;if(predicate){var candidate=predicate.toIndex(this.index.cls_.create({idIndex:idIndex}),1);if(candidate){var candidateEst=candidate.estimate(this.delegate.size(),sink,skip,limit,order,predicate)*ARBITRARY_INDEX_CREATE_FACTOR+ARBITRARY_INDEX_CREATE_CONSTANT;if(bestEstimate>candidateEst){newIndex=candidate;bestEstimate=candidateEst}}}if(order){var candidate=order.toIndex(this.index.cls_.create({idIndex:idIndex}),1);if(candidate){var candidateEst=candidate.estimate(this.delegate.size(),sink,skip,limit,order,predicate)*ARBITRARY_INDEX_CREATE_FACTOR+ARBITRARY_INDEX_CREATE_CONSTANT;if(bestEstimate>candidateEst){newIndex=candidate;bestEstimate=candidateEst}}}if(newIndex){var existingPlanCost=existingPlan.cost;var estimateRatio=bestEstimate/existingEstimate;return this.index.CustomPlan.create({cost:existingPlanCost*estimateRatio,customExecute:function autoIndexAdd(apromise,asink,askip,alimit,aorder,apredicate){console.log(self.$UID,"BUILDING INDEX",existingPlanCost,estimateRatio,this.cost,predicate&&predicate.toString());self.addIndex(newIndex,root);self.delegate.plan(sink,skip,limit,order,predicate,root).execute(apromise,asink,askip,alimit,aorder,apredicate)},customToString:function(){return"AutoIndexAdd cost="+this.cost+", "+newIndex.cls_.name}})}else{return existingPlan}},function toString(){return"AutoIndex("+(this.index||this).delegate.toString()+")"}]});
foam.CLASS({package:"foam.dao.index",name:"PersistedIndexTest",extends:"foam.nanos.test.Test",methods:[{name:"runTest",}]});
foam.CLASS({package:"foam.dao",name:"MDAO",label:"Indexed DAO",extends:"foam.dao.AbstractDAO",requires:["foam.dao.ArraySink","foam.dao.ExternalException","foam.dao.InternalException","foam.dao.InvalidArgumentException","foam.dao.index.AltIndex","foam.dao.index.AutoIndex","foam.dao.index.SetIndex","foam.dao.index.TreeIndex","foam.dao.index.ValueIndex","foam.mlang.predicate.Eq","foam.mlang.predicate.True","foam.mlang.predicate.Or","foam.mlang.sink.Explain","foam.dao.index.MergePlan"],properties:[{class:"Class",name:"of",required:true,postSet:function(){foam.assert(this.of.ID,"MDAO.of must be assigned a FOAM Class "+"with an 'id' Property or 'ids' array specified. Missing id in "+"class: "+(this.of&&this.of.id))}},{class:"Boolean",name:"autoIndex"},{name:"idIndex",transient:true},{name:"index",transient:true}],methods:[function init(){this.addPropertyIndex();this.idIndex=this.index;if(this.autoIndex){this.addIndex(this.AutoIndex.create({idIndex:this.idIndex.index}))}},function addPropertyIndex(){var props=Array.from(arguments);props.push(this.of.ID);return this.addUniqueIndex_.apply(this,props)},function addUniqueIndex_(){var index=this.ValueIndex.create();for(var i=arguments.length-1;i>=0;i--){var prop=arguments[i];index=prop.toIndex(index)}return this.addIndex(index)},function addIndex(index){if(!this.index){this.index=index.createNode();return this}if(!this.AltIndex.isInstance(this.index.index)){this.index=this.AltIndex.create({delegates:[this.index.index]}).createNode({delegates:[this.index]})}this.index.addIndex(index,this.index);return this},function bulkLoad(dao){var self=this;var sink=self.ArraySink.create();return dao.select(sink).then(function(){var a=sink.array;self.index.bulkLoad(a);for(var i=0;i<a.length;++i){var obj=a[i]}})},function put_(x,obj){var oldValue=this.findSync_(obj.id);if(oldValue){this.index.remove(oldValue)}this.index.put(obj);this.pub("on","put",obj);return Promise.resolve(obj)},function find_(x,objOrKey){if(objOrKey===undefined){return Promise.reject(this.InvalidArgumentException.create({message:'"key" cannot be undefined/null'}))}return Promise.resolve(this.findSync_(this.of.isInstance(objOrKey)?objOrKey.id:objOrKey))},function findSync_(key){var index=this.idIndex;index=index.get(key);if(index&&index.get())return index.get();return null},function remove_(x,obj){if(!obj||obj.id===undefined){return Promise.reject(this.ExternalException.create({id:"no_id"}))}var id=obj.id;var self=this;var found=this.findSync_(id);if(found){self.index.remove(found);self.pub("on","remove",found)}return Promise.resolve(obj)},function removeAll_(x,skip,limit,order,predicate){if(!predicate)predicate=this.True.create();var self=this;return self.where(predicate).select(self.ArraySink.create()).then(function(sink){var a=sink.array;for(var i=0;i<a.length;i++){self.index.remove(a[i]);self.pub("on","remove",a[i])}return Promise.resolve()})},function select_(x,sink,skip,limit,order,predicate){sink=this.prepareSink_(sink);var plan;if(this.Explain.isInstance(sink)){plan=this.index.plan(sink.arg1,skip,limit,order,predicate,this.index);sink.plan="cost: "+plan.cost+", "+plan.toString();sink&&sink.eof&&sink.eof();return Promise.resolve(sink)}predicate=predicate&&predicate.toDisjunctiveNormalForm();if(!predicate||!this.Or.isInstance(predicate)){plan=this.index.plan(sink,skip,limit,order,predicate,this.index)}else{plan=this.planForOr(sink,skip,limit,order,predicate)}var promise=[Promise.resolve()];plan.execute(promise,sink,skip,limit,order,predicate);return promise[0].then(function(){sink&&sink.eof&&sink.eof();return Promise.resolve(sink)},function(err){return Promise.reject(err)})},function planForOr(sink,skip,limit,order,predicate){var subLimit=limit?limit+(skip?skip:0):undefined;var args=predicate.args;var plans=[];for(var i=0;i<args.length;i++){plans.push(this.index.plan(sink,undefined,subLimit,order,args[i],this.index))}return this.MergePlan.create({of:this.of,subPlans:plans,predicates:args})},function toString(){return"MDAO("+this.cls_.name+","+this.index+")"},function now(){return this.index},function when(then){var newMDAO=this.cls_.create({of:this.of});newMDAO.index=then;return newMDAO}]});
foam.CLASS({package:"foam.dao",name:"ArrayDAO",extends:"foam.dao.AbstractDAO",abstract:true,requires:["foam.dao.ArraySink","foam.mlang.predicate.True"],properties:[{class:"Class",name:"of",factory:function(){if(this.array.length===0)return this.__context__.lookup("foam.core.FObject");return null}},{name:"array",factory:function(){return[]}}],methods:[function put_(x,obj){for(var i=0;i<this.array.length;i++){if(obj.ID.compare(obj,this.array[i])===0){this.array[i]=obj;break}}if(i==this.array.length)this.array.push(obj);this.on.put.pub(obj);return Promise.resolve(obj)},function remove_(x,obj){for(var i=0;i<this.array.length;i++){if(obj.ID.compare(obj,this.array[i])===0){this.array.splice(i,1);break}}this.on.remove.pub(obj);return Promise.resolve(obj)},function select_(x,sink,skip,limit,order,predicate){var resultSink=sink||this.ArraySink.create({of:this.of});sink=this.decorateSink_(resultSink,skip,limit,order,predicate);var detached=false;var sub=foam.core.FObject.create();sub.onDetach(function(){detached=true});var self=this;return new Promise(function(resolve,reject){for(var i=0;i<self.array.length;i++){if(detached)break;sink.put(self.array[i],sub)}sink.eof();resolve(resultSink)})},function removeAll_(x,skip,limit,order,predicate){predicate=predicate||this.True.create();skip=skip||0;limit=foam.Number.isInstance(limit)?limit:Number.MAX_VALUE;for(var i=0;i<this.array.length&&limit>0;i++){if(predicate.f(this.array[i])){if(skip>0){skip--;continue}var obj=this.array.splice(i,1)[0];i--;limit--;this.on.remove.pub(obj)}}return Promise.resolve()},function find_(x,key){var id=this.of.isInstance(key)?key.id:key;for(var i=0;i<this.array.length;i++){if(foam.util.equals(id,this.array[i].id)){return Promise.resolve(this.array[i])}}return Promise.resolve(null)}]});
foam.CLASS({package:"foam.dao",name:"CopyOnWriteDAO",extends:"foam.dao.ProxyDAO",requires:["foam.dao.ArraySink","foam.dao.DedupSink"],properties:[{class:"StringArray",name:"idsCopied",getter:`,
return Array.from(this.idCache);
`,},{class:"foam.dao.DAOProperty",name:"copyDAO"},{class:"Object",name:"idCache",hidden:true,transient:true,factory:function(){return new Set(this.instance_.idsCopied)},},{class:"Boolean",name:"enableRetroRemove",}],methods:[{name:"put_",code:async function put_(x,obj){if(!this.idCache.has(obj.id)){this.idCache.add(obj.id);let sourceObj=await this.delegate.find_(x,obj);if(sourceObj!=null){this.copyDAO.put_(x,sourceObj)}}return await this.copyDAO.put_(x,obj)},},{name:"find_",code:function(x,obj){const id=this.adaptFindId_(obj);if(this.idCache.has(id))return this.copyDAO.find_(x,obj);return this.delegate.find_(x,obj)},},{name:"remove_",code:async function(x,obj){const id=this.adaptFindId_(obj);obj=typeof obj==="string"?{id:obj}:obj;if(this.idCache.has(id)){return await this.copyDAO.remove_(x,obj)}const originalObj=await this.delegate.find_(x,obj);if(!this.enableRetroRemove&&!originalObj)return;this.idCache.add(id);return await this.copyDAO.remove_(x,obj)},},{name:"select_",code:async function select_(x,sink,skip,limit,order,predicate){sink=sink||this.ArraySink.create();var ddSink=this.DedupSink.create({delegate:sink});await this.copyDAO.select_(x,ddSink,skip,limit,order,predicate);for(const k of this.idCache){ddSink.results[k]=true}await this.delegate.select_(x,ddSink,skip,limit,order,predicate);return sink},},{name:"removeAll_",code:function(x,...selectArgs){this.select_(x,this.RemoveSink.create({x:x,dao:this}),...selectArgs)},},{name:"adaptFindId_",type:"String",args:[{name:"obj",type:"Object"}],code:function adaptFindId_(obj){return typeof obj==="string"?obj:obj.id},},{name:"applyToDAO",async:true,code:async function(targetDAO){for(const id of idsCopied){const obj=this.copyDAO.find(id);if(obj){targetDAO.put(obj);continue}const srcObj=this.delegate.find(id);if(srcObj)targetDAO.remove(srcObj)}}}]});
foam.CLASS({package:"foam.dao",name:"CopyOnWriteDAOJsTest",extends:"foam.nanos.test.Test",properties:[{name:"code",value:(fn=>`await (${fn.toString().split("\n").join("")})();`)(async()=>{const ArrayDAO=foam.dao.ArrayDAO;const COWDAO=foam.dao.CopyOnWriteDAO;const MDAO=foam.dao.MDAO;const IdentifiedStringHolder=foam.test.IdentifiedStringHolder;const sourceDAO=MDAO.create({of:"foam.test.IdentifiedStringHolder"});await sourceDAO.put(IdentifiedStringHolder.create({id:"a",value:"original"}));const copyDAO=ArrayDAO.create();const cowDAO=COWDAO.create({copyDAO:copyDAO,delegate:sourceDAO});let results=(await cowDAO.select()).array;test(results.length===1,"COWDAO initial size should match delegate");test(results[0].value==="original","COWDAO should contain delegate objects");await cowDAO.put(IdentifiedStringHolder.create({id:"b",value:"new"}));results=(await cowDAO.select()).array;test(results.length===2,"COWDAO size should increase when putting new objects");await cowDAO.put(IdentifiedStringHolder.create({id:"a",value:"updated"}));results=(await cowDAO.select()).array;test(results.length===2,"COWDAO size should not increase when updating objects");const data=results.map(v=>v.id+"."+v.value);test(data.includes("a.updated")&&data.includes("b.new"),"COWDAO should contain correct data");cowDAO.remove(IdentifiedStringHolder.create({id:"a"}));results=(await cowDAO.select()).array;test(results.length===1,"COWDAO should track deletions against source DAO");const cowDAONoRetro=COWDAO.create({copyDAO:ArrayDAO.create(),delegate:sourceDAO,enableRetroRemove:false});await cowDAONoRetro.remove(IdentifiedStringHolder.create({id:"c"}));await sourceDAO.put(IdentifiedStringHolder.create({id:"c",value:"future"}));results=(await cowDAONoRetro.select()).array;test(results.length===2,"Expected behaviour when enableRetroRemove=false");const cowDAOAllowRetro=COWDAO.create({copyDAO:ArrayDAO.create(),delegate:sourceDAO,enableRetroRemove:true});await cowDAOAllowRetro.remove(IdentifiedStringHolder.create({id:"d"}));await sourceDAO.put(IdentifiedStringHolder.create({id:"d",value:"future"}));results=(await cowDAOAllowRetro.select()).array;test(results.length===2,"Expected behaviour when enableRetroRemove=true")})}]});
foam.CLASS({package:"foam.dao",name:"CopyOnWriteDAOJavaTest",extends:"foam.nanos.test.Test",properties:[{name:"code",value:`
import foam.dao.ArraySink;
import foam.dao.MDAO;
import foam.dao.CopyOnWriteDAO;
import foam.test.IdentifiedStringHolder;
sourceDAO = new MDAO(IdentifiedStringHolder.getOwnClassInfo());
sourceDAO.put(new IdentifiedStringHolder.Builder(x).setId("a").setValue("original").build());
copyDAO = new MDAO(IdentifiedStringHolder.getOwnClassInfo());
cowDAO = new CopyOnWriteDAO.Builder(x).setCopyDAO(copyDAO).setDelegate(sourceDAO).build();
results = ((ArraySink) cowDAO.select()).getArray();
test(results.size() == 1, "COWDAO initial size should match delegate");
test(results.get(0).getValue() == "original", "COWDAO should contain delegate objects");
cowDAO.put(new IdentifiedStringHolder.Builder(x).setId("b").setValue("new").build());
results = ((ArraySink) cowDAO.select()).getArray();
test(results.size() == 2, "COWDAO size should increase when putting new objects");
cowDAO.put(new IdentifiedStringHolder.Builder(x).setId("a").setValue("updated").build());
results = ((ArraySink) cowDAO.select()).getArray();
test(results.size() == 2, "COWDAO size should not increase when updating objects");
cowDAO.remove(new IdentifiedStringHolder.Builder(x).setId("a").build());
results = ((ArraySink) cowDAO.select()).getArray();
test(results.size() == 1, "COWDAO should track deletions against source DAO");
`}]});
foam.CLASS({package:"foam.dao",name:"TimestampDAO",extends:"foam.dao.ProxyDAO",properties:[{class:"String",name:"property",value:"id"}],methods:[function put_(x,obj){if(!obj.hasOwnProperty(this.property))obj[this.property]=this.nextTimestamp();return this.delegate.put_(x,obj)},function nextTimestamp(){return Date.now()}]});
foam.CLASS({package:"foam.dao",name:"CopyFromDAO",extends:"foam.dao.ProxyDAO",requires:["foam.dao.ArraySink"],classes:[{name:"AdapterSink",extends:"foam.dao.ProxySink",properties:[{class:"Class",name:"of"}],methods:[{name:"adapt",type:"FObject",args:[{name:"ctx",type:"X"},{name:"obj",type:"FObject"}],},{name:"put",},{name:"remove",}]}],properties:[{name:"delegate"},{class:"Class",name:"to",}],methods:[{name:"adaptToDelegate",type:"FObject",args:[{name:"ctx",type:"X"},{name:"obj",type:"FObject"}],},{name:"adaptFromDelegate",type:"FObject",args:[{name:"ctx",type:"X"},{name:"obj",type:"FObject"}],},{name:"adaptOrder",type:"foam.mlang.order.Comparator",args:[{name:"order",type:"foam.mlang.order.Comparator"}],},{name:"adaptPredicate",type:"foam.mlang.predicate.Predicate",args:[{name:"predicate",type:"foam.mlang.predicate.Predicate"}],},{name:"put_",},{name:"remove_",},{name:"find_",},{name:"select_",},{name:"removeAll_",}]});
foam.CLASS({package:"foam.dao",name:"GUIDDAO",extends:"foam.dao.ProxyDAO",properties:[{class:"String",name:"property",value:"id"},{javaInfoType:"foam.core.AbstractObjectPropertyInfo",name:"axiom",}],methods:[{name:"put_",code:function put_(x,obj){if(!obj.hasOwnProperty(this.property)){obj[this.property]=foam.uuid.randomGUID()}return this.delegate.put_(x,obj)},}],axioms:[{buildJavaClass:function(cls){cls.extras.push(`
public GUIDDAO(foam.core.X x, DAO delegate) {
setX(x);
setDelegate(delegate);
}
public GUIDDAO(DAO delegate) {
setDelegate(delegate);
}
`)}}]});
foam.CLASS({package:"foam.dao",name:"KeyValueDAO",extends:"foam.dao.ProxyDAO",methods:[{name:"put_",},{name:"remove_",code:function(obj){return Promise.resolve(obj)},},{name:"select_",code:function(sink){return Promise.resolve(sink)},},{name:"removeAll_",code:function(){return Promise.resolve()},}]});
foam.CLASS({package:"foam.dao",name:"ReadOnlyDAO",extends:"foam.dao.ProxyDAO",methods:[{name:"put_",code:function put_(x,obj){return Promise.reject("Cannot put into ReadOnlyDAO")}},{name:"remove_",code:function remove_(x,obj){return Promise.reject("Cannot remove from ReadOnlyDAO")}},{name:"removeAll_",code:function removeAll(){return Promise.reject("Cannot removeAll from ReadOnlyDAO")}},{name:"cmd_",code:function cmd_(){return Promise.reject("Cannot cmd from ReadOnlyDAO")}}]});
foam.CLASS({package:"foam.dao",name:"StoreAndForwardDAO",extends:"foam.dao.ProxyDAO",requires:["foam.dao.InternalException"],classes:[{name:"DAOOperation",properties:[{class:"String",name:"methodName"},{name:"args"},{name:"promise_",factory:function(){var self=this;var resolve;var reject;var promise=new Promise(function(res,rej){resolve=res;reject=rej});promise.resolveFunction_=resolve;promise.rejectFunction_=reject;return promise}},{class:"Function",name:"resolve_",factory:function(){return this.promise_.resolveFunction_}},{class:"Function",name:"reject_",factory:function(){return this.promise_.rejectFunction_}}],methods:[function getPromise(){return this.promise_}],listeners:[function resolve(){return this.resolve_.apply(this,arguments)},function reject(){return this.reject_.apply(this,arguments)}]}],properties:[{name:"delegate",postSet:function(old,nu){if(this.isForwarding_)this.__context__.warn("StoreAndForwardDAO: Delegate while flushing queue!");this.forward_()}},{class:"Function",name:"shouldRetry",value:function(error){return this.InternalException.isInstance(error)}},{class:"FObjectArray",of:"FObject",name:"q_"},{class:"Boolean",name:"isForwarding_"}],methods:[function put_(){return this.store_(foam.dao.DOP.PUT_.label,arguments)},function remove_(){return this.store_(foam.dao.DOP.REMOVE_.label,arguments)},function find_(){return this.store_(foam.dao.DOP.FIND_.label,arguments)},function select_(){return this.store_(foam.dao.DOP.SELECT_.label,arguments)},function removeAll_(){return this.store_(foam.dao.DOP.REMOVE_ALL_.label,arguments)},function store_(methodName,args){var op=this.DAOOperation.create({methodName:methodName,args:args});this.q_.push(op);if(!this.isForwarding_)this.forward_();return op.getPromise()},function forward_(){if(!this.delegate||this.q_.length===0){this.isForwarding_=false;return}this.isForwarding_=true;var op=this.q_[0];this.delegate[op.methodName].apply(this.delegate,op.args).then(this.onComplete.bind(this,op)).catch(this.onError.bind(this,op))}],listeners:[{name:"onQ",isMerged:"true",mergeDelay:2e3,code:function(){this.forward_()}},{name:"onComplete",code:function(op,result){this.q_.shift();op.resolve(result);this.forward_()}},{name:"onError",code:function(op,error){if(this.shouldRetry(error)){this.isForwarding_=false;this.onQ();return}this.q_.shift();op.reject(error);this.forward_()}}]});foam.INTERFACE({package:"foam.dao",name:"Journal",methods:[{name:"put",type:"FObject",args:[{name:"x",type:"Context"},{name:"prefix",type:"String"},{name:"dao",type:"DAO"},{name:"obj",type:"foam.core.FObject"}]},{name:"remove",type:"FObject",args:[{name:"x",type:"Context"},{name:"prefix",type:"String"},{name:"dao",type:"DAO"},{name:"obj",type:"foam.core.FObject"}]},{name:"replay",args:[{name:"x",type:"Context"},{name:"dao",type:"foam.dao.DAO"}]}]});
foam.CLASS({package:"foam.dao",name:"AbstractJournal",abstract:true,implements:["foam.dao.Journal"]});
foam.CLASS({package:"foam.dao",name:"ProxyJournal",extends:"foam.dao.AbstractJournal",properties:[{class:"Proxy",of:"foam.dao.Journal",name:"delegate",forwards:["put","remove","replay"]}]});if(foam.isServer){
foam.CLASS({package:"foam.dao",name:"NodeFileJournal",extends:"foam.dao.AbstractJournal",flags:["node"],properties:[{class:"Class",name:"of",value:"foam.core.FObject"},{name:"fd",required:true},{name:"offset",factory:function(){var stat=this.fs.fstatSync(this.fd);return stat.size}},{name:"fs",factory:function(){return require("fs")}},{name:"writePromise",value:Promise.resolve()}],methods:[function put_(x,old,nu){return this.write_(Buffer.from("put(foam.json.parse("+foam.json.Storage.stringify(nu,this.of)+"));\n"))},function put(x,prefix,dao,obj){var old=dao.find_(x,obj.id);this.put_(x,old,obj)},function remove(x,prefix,dao,obj){return this.write_(Buffer.from("remove(foam.json.parse("+foam.json.Storage.stringify(obj,this.of)+"));\n"))},function write_(data){var self=this;var offset=self.offset;self.offset+=data.length;return self.writePromise=self.writePromise.then(function(){return new Promise(function(resolve,reject){self.fs.write(self.fd,data,0,data.length,offset,function(err,written,buffer){if(err)reject(err);if(written!=data.length)reject(new Error("foam.dao.NodeFileJournal: Incomplete write"));resolve()})})})},function replay(x,dao){var self=this;return new Promise(function(resolve,reject){self.fs.readFile(self.fd,"utf8",function(err,data_){if(err){reject(err);return}var context={put:function(o){return dao.put(o)},remove:function(o){return dao.remove(o)},foam:{json:{parse:function(obj){return foam.json.parse(obj,self.of,dao.__context__)}}}};with(context)eval(data_);resolve(dao)})})}]})}
foam.CLASS({package:"foam.dao",name:"CompositeJournal",extends:"foam.dao.AbstractJournal",flags:["java"],properties:[{class:"FObjectArray",of:"foam.dao.Journal",name:"delegates"}],methods:[{name:"put",type:"FObject",args:[{name:"x",type:"Context"},{name:"prefix",type:"String"},{name:"dao",type:"DAO"},{name:"obj",type:"foam.core.FObject"}],},{name:"remove",type:"FObject",args:[{name:"x",type:"Context"},{name:"prefix",type:"String"},{name:"dao",type:"DAO"},{name:"obj",type:"foam.core.FObject"}],},{name:"replay",}]});
foam.CLASS({package:"foam.dao",name:"AbstractFileJournal",abstract:true,flags:["java"],properties:[{class:"Object",name:"line",},{class:"Object",name:"outputter",},{class:"Object",name:"parser",},{class:"Object",name:"timeStamper",},{class:"FObjectProperty",of:"foam.nanos.logger.Logger",name:"logger",visibility:"HIDDEN",transient:true,javaCloneProperty:"//noop",},{class:"String",name:"filename",required:true},{class:"Boolean",name:"multiLineOutput",value:false},{name:"outputClassNames",class:"Boolean",value:true},{class:"Boolean",name:"createFile",value:true},{class:"Object",name:"reader",},{class:"Object",name:"writer",}],methods:[{name:"put",type:"FObject",args:[{name:"x",type:"Context"},{name:"prefix",type:"String"},{name:"dao",type:"DAO"},{name:"obj",type:"foam.core.FObject"}],},{name:"writePut_",args:[{name:"x",type:"Context"},{name:"record",type:"String"},{name:"c",type:"String"},{name:"prefix",type:"String"}],},{name:"remove",type:"FObject",args:[{name:"x",type:"Context"},{name:"prefix",type:"String"},{name:"dao",type:"DAO"},{name:"obj",type:"foam.core.FObject"}],},{name:"writeRemove_",args:[{name:"x",type:"Context"},{name:"record",type:"String"},{name:"prefix",type:"String"}],},{name:"write_",args:[{class:"String",name:"data"}],},{name:"writeComment_",args:[{name:"x",type:"Context"},{name:"obj",type:"foam.core.FObject"}],},{name:"getEntry",type:"String",args:[{name:"reader",type:"BufferedReader"}],},{name:"getParsingErrorMessage",type:"String",args:[{class:"String",name:"line"}],},{name:"mergeFObject",type:"foam.core.FObject",args:[{name:"oldFObject",type:"FObject"},{name:"diffFObject",type:"FObject"}],},{name:"mergeProperty",args:[{name:"oldFObject",type:"FObject"},{name:"diffFObject",type:"FObject"},{name:"prop",}],}]});
foam.CLASS({package:"foam.dao",name:"FileJournal",extends:"foam.dao.AbstractFileJournal",flags:["java"],implements:["foam.dao.Journal"],properties:[{class:"foam.dao.DAOProperty",name:"dao"}],methods:[{name:"replay",args:[{name:"x",type:"Context"},{name:"dao",type:"foam.dao.DAO"}],}]});
foam.CLASS({package:"foam.dao",name:"JDAO",extends:"foam.dao.PromisedDAO",properties:["delegate","journal",{name:"promise",factory:function(){var self=this;return this.journal.replay(null,this.delegate).then(function(dao){sink=foam.dao.JournalSink.create({journal:self.journal,dao:self.delegate});dao.listen(sink);return dao})}},{name:"synced",getter:function(){return Promise.all([this.promise,this.journal.writePromise])}}]});
foam.CLASS({package:"foam.dao.java",name:"JDAO",extends:"foam.dao.ProxyDAO",flags:["java"],properties:[{name:"filename",class:"String"},{name:"cluster",class:"Boolean",value:false},{class:"FObjectProperty",of:"foam.dao.Journal",name:"journal"},{class:"Boolean",name:"syncReplay",value:true},{name:"delegate",class:"foam.dao.DAOProperty",}],methods:[{name:"put_",},{name:"remove_",},{name:"removeAll_",}]});
foam.CLASS({package:"foam.dao",name:"ReadOnlyFileJournal",extends:"foam.dao.FileJournal",methods:[{name:"put",},{name:"remove",}]});
foam.CLASS({package:"foam.dao",name:"RoutingJournal",extends:"foam.dao.FileJournal",properties:[{class:"Boolean",name:"replayed",}],methods:[{name:"waitForReplay",synchronized:true,},{name:"writePut_",args:[{name:"x",type:"Context"},{name:"record",type:"String"},{name:"c",type:"String"}],},{name:"writeRemove_",args:[{name:"x",type:"Context"},{name:"record",type:"String"}],},{name:"replay",}]});
foam.CLASS({package:"foam.dao",name:"RoutingJournalTest",extends:"foam.nanos.test.Test",flags:["java"],constants:[{type:"String",name:"USER_DAO_PUT",value:`userDAO.p({"class":"foam.nanos.auth.User","id":1000,"firstName":"Kirk","lastName":"Eaton"`},{type:"String",name:"GROUP_DAO_PUT",value:`groupDAO.p({"class":"foam.nanos.auth.Group","id":"admin","enabled":true`}],methods:[{name:"runTest",},{name:"VerifyUserDAO",args:[{name:"userDAO",type:"foam.dao.DAO"}],},{name:"VerifyGroupDAO",args:[{name:"groupDAO",type:"foam.dao.DAO"}],}]});
foam.CLASS({package:"foam.dao",name:"RoutingJDAO",extends:"foam.dao.PromisedDAO",requires:["foam.dao.java.JDAO"],properties:[{class:"String",name:"service",},{class:"FObjectProperty",of:"foam.dao.DAO",name:"delegate"},{class:"FObjectProperty",of:"foam.dao.RoutingJournal",name:"journal",}],methods:[{name:"find_",flags:null,},{name:"put_",flags:null,},{name:"remove_",flags:null,}]});foam.ENUM({package:"foam.dao",name:"JournalType",values:[{name:"NO_JOURNAL",label:"No journal"},{name:"SINGLE_JOURNAL",label:"Single"},{name:"SHARED_JOURNAL",label:"Shared journal"}]});
foam.CLASS({package:"foam.dao",name:"Relationship",implements:[{path:"foam.mlang.Expressions",java:false}],flags:[],requires:["foam.dao.ManyToManyRelationshipAxiom","foam.dao.ManyToManyRelationshipDAO","foam.dao.OneToManyRelationshipAxiom","foam.dao.RelationshipDAO","foam.u2.stack.StackBlock"],properties:["flags",{name:"id",hidden:true,transient:true,getter:function(){return this.package?this.package+"."+this.name:this.name}},{name:"package",factory:function(){var i=this.sourceModel.lastIndexOf(".");return i==-1?"":this.sourceModel.substring(0,i)}},{name:"name",class:"String",transient:true,hidden:true,factory:function(){var s=this.sourceModel;var t=this.targetModel;return s.substring(s.lastIndexOf(".")+1)+t.substring(t.lastIndexOf(".")+1)+foam.String.capitalize(this.forwardName)+"Relationship"}},"forwardName",{name:"inverseName",class:"String"},{name:"cardinality",assertValue:function(value){foam.assert(value==="1:*"||value==="*:*","Supported cardinalities are 1:* and *:*")},value:"1:*"},{class:"String",name:"sourceModel"},{class:"String",name:"targetModel"},{class:"String",name:"junctionName",factory:function(){var source=this.sourceModel.substring(this.sourceModel.lastIndexOf(".")+1);var target=this.targetModel.substring(this.targetModel.lastIndexOf(".")+1);return source+target+"Junction"}},{class:"String",name:"junctionModel",expression:function(junctionName){return(this.package?this.package+".":"")+junctionName}},{class:"String",name:"sourceDAOKey",expression:function(sourceModel){var sourceName=sourceModel.substring(sourceModel.lastIndexOf(".")+1);return foam.String.daoize(sourceName)}},{class:"String",name:"unauthorizedSourceDAOKey"},{class:"String",name:"targetDAOKey",expression:function(targetModel){var targetName=targetModel.substring(targetModel.lastIndexOf(".")+1);return foam.String.daoize(targetName)}},{class:"String",name:"unauthorizedTargetDAOKey"},{class:"String",name:"junctionDAOKey",expression:function(junctionModel){var junctionName=junctionModel.substring(junctionModel.lastIndexOf(".")+1);return foam.String.daoize(junctionName)}},{name:"adaptTarget",factory:function(){var inverseName=this.inverseName;return function(source,target){target[inverseName]=source.id;return target}}},{class:"Boolean",name:"oneWay"},{class:"Map",name:"sourceProperty"},{class:"Map",name:"sourceMethod"},{class:"Map",name:"targetProperty"},{class:"Map",name:"targetMethod"},{class:"Boolean",name:"sourceInitialized",value:false,transient:true},{class:"Boolean",name:"targetInitialized",value:false,transient:true},{class:"Boolean",name:"junctionInitialized",value:false,transient:true},"order",{class:"Boolean",name:"enabled",expression:function(flags){var enabledFlags=Object.keys(globalThis.foam.flags).filter(f=>globalThis.foam.flags[f]);return foam.util.flagFilter(enabledFlags)(this)}},{class:"String",name:"extends",value:"FObject",},{class:"StringArray",name:"ids",factory:function(){return["sourceId","targetId"]}},{class:"String",name:"junctionModelPlural",factory:function(junctionModel){var name=this.junctionModel.substring(this.junctionModel.lastIndexOf(".")+1);return foam.String.labelize(foam.String.pluralize(name))}}],methods:[function initSource(x){if(this.sourceInitialized)return;this.sourceInitialized=true;if(!this.enabled)return;var context=x||this.__context__;var source=context.lookup(this.sourceModel);source.installAxiom(this);var prop;if(this.cardinality==="1:*"){prop=foam.dao.OneToManyRelationshipAxiom.create({propertyName:this.forwardName,target:this.targetModel,targetPropertyName:this.inverseName,targetDAOKey:this.targetDAOKey,unauthorizedTargetDAOKey:this.unauthorizedTargetDAOKey,propertyOverrides:this.sourceProperty,methodOverrides:this.sourceMethod})}else if(this.cardinality==="*:*"){this.initJunction(x);prop=foam.dao.ManyToManyRelationshipAxiom.create({propertyName:this.forwardName,junction:this.junctionModel,junctionDAOKey:this.junctionDAOKey,targetDAOKey:this.targetDAOKey,unauthorizedTargetDAOKey:this.unauthorizedTargetDAOKey,targetProperty:"targetId",sourceProperty:"sourceId",propertyOverrides:this.sourceProperty,methodOverrides:this.sourceMethod})}else{foam.assert(false,"Unknown relationship cardinality.")}source.installAxiom(prop)},function initTarget(x){if(this.oneWay)return;if(this.targetInitialized)return;this.targetInitialized=true;if(!this.enabled)return;var context=x||this.__context__;var target=context.lookup(this.targetModel);target.installAxiom(this);var prop;if(this.cardinality==="1:*"){prop=foam.core.Reference.create({name:this.inverseName,of:this.sourceModel,targetDAOKey:this.sourceDAOKey,unauthorizedTargetDAOKey:this.unauthorizedSourceDAOKey}).copyFrom(this.targetProperty)}else if(this.cardinality==="*:*"){this.initJunction(x);prop=foam.dao.ManyToManyRelationshipAxiom.create({propertyName:this.inverseName,junction:this.junctionModel,junctionDAOKey:this.junctionDAOKey,targetDAOKey:this.sourceDAOKey,unauthorizedTargetDAOKey:this.unauthorizedSourceDAOKey,targetProperty:"sourceId",sourceProperty:"targetId",propertyOverrides:this.targetProperty,methodOverrides:this.targetMethod})}else{foam.assert(false,"Unknown relationship cardinality.")}target.installAxiom(prop)},function initJunction(x){if(this.junctionInitialized)return;this.junctionInitialized=true;if(!this.enabled)return;if(this.cardinality!=="*:*")return;if(foam.isRegistered(this.junctionModel))return;var name=this.junctionModel.substring(this.junctionModel.lastIndexOf(".")+1);
foam.CLASS({package:this.package,name:name,extends:this.extends,ids:this.ids,plural:this.junctionModelPlural,properties:[{class:"Reference",name:"sourceId",shortName:"s",of:this.sourceModel},{class:"Reference",name:"targetId",shortName:"t",of:this.targetModel}]})}]});foam.LIB({name:"foam",methods:[function RELATIONSHIP(m,opt_ctx){foam.__RELATIONSHIPS__=foam.__RELATIONSHIPS__||[];foam.__RELATIONSHIPS__.push(m);m.order=foam.__count++;var r=foam.dao.Relationship.create(m,opt_ctx);foam.register(r);foam.package.registerClass(r);r.initJunction();if(foam.isDefined(r.sourceModel)){r.initSource()}else{foam.pubsub.sub("defineClass",r.sourceModel,function(s){s&&s.detach();r.initSource()})}if(foam.isDefined(r.targetModel)){r.initTarget()}else{foam.pubsub.sub("defineClass",r.targetModel,function(s){s&&s.detach();r.initTarget()})}}]});foam.INTERFACE({package:"foam.dao",name:"ManyToManyRelationship",methods:[{name:"add",async:true,args:[{name:"target",type:"FObject"}]},{name:"remove",async:true,args:[{name:"target",type:"FObject"}]},{name:"getDAO",type:"foam.dao.DAO"},{name:"getJunctionDAO",type:"foam.dao.DAO"},{name:"getTargetDAO",type:"foam.dao.DAO"}]});
foam.CLASS({package:"foam.dao",name:"ManyToManyRelationshipImpl",implements:["foam.dao.ManyToManyRelationship"],requires:["foam.u2.stack.StackBlock"],properties:[{class:"Class",name:"junction",hidden:true},{class:"Object",name:"sourceId",hidden:true},{class:"String",name:"targetDAOKey",hidden:true},{class:"String",name:"unauthorizedTargetDAOKey",hidden:true},{class:"String",name:"junctionDAOKey",hidden:true},{class:"Object",name:"targetProperty",hidden:true},{class:"Object",name:"sourceProperty",hidden:true},{class:"foam.dao.DAOProperty",name:"dao",label:"",factory:function(){var targetDAO=this.__context__[this.targetDAOKey];foam.assert(targetDAO,"Missing DAO for targetDAOKey",this.targetDAOKey);return foam.dao.ManyToManyRelationshipDAO.create({relationship:this,delegate:targetDAO},this)},},{class:"foam.dao.DAOProperty",name:"junctionDAO",hidden:true,factory:function(){return this.__context__[this.junctionDAOKey]},},{class:"foam.dao.DAOProperty",name:"targetDAO",hidden:true,factory:function(){var targetDAO=this.__context__[this.targetDAOKey];foam.assert(targetDAO,"Missing DAO for targetDAOKey",this.targetDAOKey);return targetDAO},}],methods:[{name:"add",args:[{name:"target",type:"FObject"}],code:function add(target){return this.junctionDAO.put(this.createJunction(target.id))}},{name:"remove",code:function remove(target){return this.junctionDAO.remove(this.createJunction(target.id))}},{name:"createJunction",args:[{name:"targetId",type:"Any"}],type:"foam.core.FObject",code:function createJunction(targetId){foam.assert(!foam.Undefined.isInstance(this.sourceId)&&!foam.Undefined.isInstance(targetId),"Cannot create an association with an object that isn't stored in a DAO yet.");var junction=this.junction.create(null,this);this.targetProperty.set(junction,targetId);this.sourceProperty.set(junction,this.sourceId);return junction},},{name:"getJunctionDAO",code:function(){return this.junctionDAO}},{name:"getTargetDAO",code:function(){return this.targetDAO}},{name:"getDAO",code:function getDAO(){return this.dao}}],actions:[{name:"addItem",label:"Add",code:function(x){var self=this;var dao=x[self.targetDAOKey];var controller=foam.comics.DAOController.create({createEnabled:false,editEnabled:false,selectEnabled:true,exportEnabled:false,relationship:this,data:dao,createLabel:"Add",title:`Add ${dao.of.model_.plural}`,subtitle:`Select ${dao.of.model_.plural} from the table and click "Add" to add them.`},x);controller.sub("select",function(s,_,selectedObjects){Object.values(selectedObjects).forEach(obj=>{self.add(obj)})});x.stack.push(this.StackBlock.create({view:{class:"foam.comics.DAOControllerView",data:controller},parent:x}))}},{name:"removeItem",label:"Remove",code:function(x){var self=this;var dao=self.dao;var controller=foam.comics.DAOController.create({createEnabled:false,editEnabled:false,selectEnabled:true,relationship:this,data:dao,createLabel:"Remove",title:`Remove ${dao.of.model_.plural}`,subtitle:`Select ${dao.of.model_.plural} from the table and click "Remove" to remove them.`},x);controller.sub("select",function(s,_,selectedObjects){Object.values(selectedObjects).forEach(obj=>{self.remove(obj)})});x.stack.push(this.StackBlock.create({view:{class:"foam.comics.DAOControllerView",data:controller}}))}}]});
foam.CLASS({package:"foam.dao",name:"OneToManyRelationshipAxiom",flags:[],requires:["foam.dao.OneToManyRelationshipMethod","foam.dao.OneToManyRelationshipProperty"],properties:[{name:"name",expression:function(propertyName){return propertyName+"Axiom"}},"propertyName",{name:"methodName",expression:function(propertyName){return"get"+foam.String.capitalize(propertyName)}},["transient",true],["tableCellFormatter",null],["cloneProperty",function(){}],["javaCloneProperty","//noop"],["javaDiffProperty","//noop"],["generateJava",false],["toJSON",function(){}],{class:"String",name:"targetPropertyName",},{class:"String",name:"target"},{class:"String",name:"targetDAOKey"},{class:"String",name:"unauthorizedTargetDAOKey"},{class:"Map",name:"propertyOverrides"},{class:"Map",name:"methodOverrides"}],methods:[function installInClass(cls){cls.installAxiom(this.OneToManyRelationshipMethod.create({name:this.methodName,target:this.target,targetPropertyName:this.targetPropertyName,targetDAOKey:this.targetDAOKey,unauthorizedTargetDAOKey:this.unauthorizedTargetDAOKey}).copyFrom(this.methodOverrides));cls.installAxiom(this.OneToManyRelationshipProperty.create({name:this.propertyName,methodName:this.methodName}).copyFrom(this.propertyOverrides))}]});
foam.CLASS({package:"foam.dao",name:"OneToManyRelationshipProperty",extends:"foam.dao.DAOProperty",flags:[],properties:[{name:"visibility",value:function(id){return!!id?foam.u2.DisplayMode.RW:foam.u2.DisplayMode.HIDDEN}},{name:"flags",value:["swift","js"]},{name:"methodName"},{name:"getter",expression:function(methodName){return function(){return this[methodName](this.__context__)}}},{name:"swiftGetter",flags:["swift"],expression:function(methodName){return`return ${methodName}(__context__) as? (foam_dao_DAO & foam_core_FObject)`}},["copyValueFrom",function(){return false}],["cloneProperty",function(){}]]});
foam.CLASS({package:"foam.dao",name:"OneToManyRelationshipMethod",extends:"foam.core.Method",flags:[],properties:[{class:"String",name:"target"},{class:"String",name:"targetPropertyName"},{class:"String",name:"targetDAOKey"},{class:"String",name:"unauthorizedTargetDAOKey"},{name:"args",factory:function(){return[{name:"x",type:"Context"}]}},{name:"type",value:"foam.dao.DAO"},{name:"code",expression:function(target,targetDAOKey,targetPropertyName){return function(x){return foam.dao.RelationshipDAO.create({sourceId:this.id,targetProperty:x.lookup(target).getAxiomByName(targetPropertyName),targetDAOKey:targetDAOKey,unauthorizedTargetDAOKey:this.unauthorizedTargetDAOKey},x)}}},{name:"swiftCode",flags:["swift"],expression:function(target,targetPropertyName,targetDAOKey,unauthorizedTargetDAOKey){return`
return x?.create(foam_dao_RelationshipDAO.self, args: [
"sourceId": self.id,
"targetProperty": ${foam.swift.toSwiftName(target)}.${foam.String.constantize(targetPropertyName)}(),
"targetDAOKey": "${targetDAOKey}",
"unauthorizedTargetDAOKey": "${unauthorizedTargetDAOKey}"
])!;
`}},{name:"javaCode",flags:["java"],expression:function(target,targetPropertyName,targetDAOKey,unauthorizedTargetDAOKey){return`
return new foam.dao.RelationshipDAO.Builder(x)
.setSourceId(getId())
.setTargetProperty(${target}.${foam.String.constantize(targetPropertyName)})
.setTargetDAOKey("${targetDAOKey}")
.setUnauthorizedTargetDAOKey("${unauthorizedTargetDAOKey}")
.build();
`}}]});
foam.CLASS({package:"foam.dao",name:"ManyToManyRelationshipAxiom",flags:[],requires:["foam.dao.ManyToManyRelationshipProperty","foam.dao.ManyToManyRelationshipMethod"],properties:[{name:"name",expression:function(propertyName){return propertyName+"Axiom"}},"propertyName",{name:"methodName",expression:function(propertyName){return"get"+foam.String.capitalize(propertyName)}},["of","foam.dao.ManyToManyRelationship"],["transient",true],["javaInfoType","foam.core.AbstractFObjectRelationshipPropertyInfo"],["tableCellFormatter",null],["cloneProperty",function(){}],["javaCloneProperty","//noop"],["javaDiffProperty","//noop"],["generateJava",false],["view",{class:"foam.u2.DetailView",showActions:true}],{class:"String",name:"junction"},{class:"String",name:"sourceProperty"},{class:"String",name:"junctionDAOKey"},{class:"String",name:"targetDAOKey"},{class:"String",name:"unauthorizedTargetDAOKey"},{class:"String",name:"targetProperty"},{class:"Map",name:"propertyOverrides"},{class:"Map",name:"methodOverrides"}],methods:[function installInClass(cls){cls.installAxiom(this.ManyToManyRelationshipMethod.create({sourceProperty:this.sourceProperty,targetProperty:this.targetProperty,targetDAOKey:this.targetDAOKey,unauthorizedTargetDAOKey:this.unauthorizedTargetDAOKey,junctionDAOKey:this.junctionDAOKey,junction:this.junction,name:this.methodName}).copyFrom(this.methodOverrides));cls.installAxiom(this.ManyToManyRelationshipProperty.create({name:this.propertyName,methodName:this.methodName}).copyFrom(this.propertyOverrides))}]});
foam.CLASS({package:"foam.dao",name:"ManyToManyRelationshipMethod",extends:"foam.core.Method",flags:[],properties:[{class:"String",name:"sourceProperty"},{class:"String",name:"targetProperty"},{class:"String",name:"targetDAOKey"},{class:"String",name:"unauthorizedTargetDAOKey"},{class:"String",name:"junctionDAOKey"},{class:"String",name:"junction"},{name:"args",factory:function(){return[{name:"x",type:"Context"}]}},{name:"type",value:"foam.dao.ManyToManyRelationship"},{name:"code",factory:function(){var self=this;return function(x){return foam.dao.ManyToManyRelationshipImpl.create({sourceId:this.id,sourceProperty:x.lookup(self.junction).getAxiomByName(self.sourceProperty),targetProperty:x.lookup(self.junction).getAxiomByName(self.targetProperty),targetDAOKey:self.targetDAOKey,unauthorizedTargetDAOKey:self.unauthorizedTargetDAOKey,junctionDAOKey:self.junctionDAOKey,junction:x.lookup(self.junction)},x)}}},{name:"swiftCode",flags:["swift"],expression:function(junction,sourceProperty,targetProperty,targetDAOKey,junctionDAOKey,unauthorizedTargetDAOKey){return`
return x!.create(foam_dao_ManyToManyRelationshipImpl.self, args: [
"sourceId": self.id,
"sourceProperty": ${foam.swift.toSwiftName(junction)}.${foam.String.constantize(sourceProperty)}(),
"targetProperty": ${foam.swift.toSwiftName(junction)}.${foam.String.constantize(targetProperty)}(),
"targetDAOKey": "${targetDAOKey}",
"unauthorizedTargetDAOKey": "${unauthorizedTargetDAOKey}",
"junctionDAOKey": "${junctionDAOKey}",
"junction": ${foam.swift.toSwiftName(junction)}.classInfo()
])!;
`}},{name:"javaCode",flags:["java"],expression:function(junction,sourceProperty,targetProperty,targetDAOKey,unauthorizedTargetDAOKey,junctionDAOKey){return`
return new foam.dao.ManyToManyRelationshipImpl.Builder(x)
.setSourceId(getId())
.setSourceProperty(${junction}.${foam.String.constantize(sourceProperty)})
.setTargetProperty(${junction}.${foam.String.constantize(targetProperty)})
.setTargetDAOKey("${targetDAOKey}")
.setUnauthorizedTargetDAOKey("${unauthorizedTargetDAOKey}")
.setJunctionDAOKey("${junctionDAOKey}")
.setJunction(${junction}.getOwnClassInfo())
.build();
`}}]});
foam.CLASS({package:"foam.dao",name:"ManyToManyRelationshipProperty",extends:"FObjectProperty",flags:[],properties:[{name:"flags",value:["swift","js"]},{name:"of",value:"foam.dao.ManyToManyRelationship"},{name:"transient",value:true},{name:"methodName"},{name:"getter",expression:function(methodName){return function(){return this[methodName](this.__context__)}}},{name:"setter",value:function(){}},{name:"swiftGetter",flags:["swift"],expression:function(methodName){return`return ${methodName}(__context__)`}},{name:"swiftSetter",flags:["swift"],value:"// NOOP"},{name:"createVisibility",value:"HIDDEN"},{name:"view",value:{class:"foam.u2.view.FObjectPropertyView",readView:{class:"foam.u2.view.ReadManyToManyRelationshipPropertyView"}}},["copyValueFrom",function(){return false}],["cloneProperty",function(){}]]});
foam.CLASS({package:"foam.dao",name:"RelationshipDAO",extends:"foam.dao.FilteredDAO",requires:["foam.mlang.predicate.Eq"],properties:[{class:"Object",name:"sourceId"},{class:"String",name:"targetDAOKey"},{class:"String",name:"unauthorizedTargetDAOKey"},{class:"Object",name:"targetProperty",},{name:"predicate",factory:function(){return this.Eq.create({arg1:this.targetProperty,arg2:this.sourceId})},},{name:"delegate",factory:function(){var key=this.targetDAOKey;var delegate=this.__context__[key];foam.assert(delegate,"Missing relationship DAO:",key);return delegate},}],methods:[{name:"put_",type:"FObject",code:function put_(x,obj){return this.SUPER(x,this.adaptTarget(obj))},},{name:"adaptTarget",type:"FObject",args:[{name:"target",type:"FObject"}],code:function(target){this.targetProperty.set(target,this.sourceId);return target},},function clone(){return this}]});
foam.CLASS({package:"foam.dao",name:"ManyToManyRelationshipDAO",extends:"foam.dao.ProxyDAO",implements:[{path:"foam.mlang.Expressions",flags:["js"],java:false}],properties:[{class:"FObjectProperty",of:"foam.dao.ManyToManyRelationshipImpl",name:"relationship"},{class:"String",name:"targetDAOKey"},{class:"String",name:"unauthorizedTargetDAOKey"}],methods:[{name:"find_",code:function find_(x,id){var self=this;var junction=this.relationship.createJunction(id);return this.relationship.junctionDAO.find(junction.id).then(function(a){return a&&self.delegate.find_(x,id)})}},{name:"select_",code:function select_(x,sink,skip,limit,order,predicate){var self=this;return this.relationship.junctionDAO.where(self.EQ(this.relationship.sourceProperty,this.relationship.sourceId)).select(self.MAP(this.relationship.targetProperty)).then(function(map){return self.delegate.select_(x,sink,skip,limit,order,self.AND(predicate||self.TRUE,self.IN(self.of.ID,map.delegate.array)))})},}]});
foam.CLASS({package:"foam.dao.grid",name:"ManyToManyGridRecord",properties:[{name:"id",getter:function(){return this.target.id}},{class:"FObjectProperty",name:"target",required:true},{class:"Array",of:"Boolean",name:"data"}]});
foam.CLASS({package:"foam.dao.grid",name:"ManyToManyGridDAO",extends:"foam.dao.ReadOnlyDAO",implements:["foam.mlang.Expressions"],requires:["foam.dao.ArraySink"],imports:["relationship"],properties:[{name:"delegate",factory:function(){return this.__context__[this.relationship.targetDAOKey]}},{class:"Class",name:"junctionCls",factory:function(){return this.__context__.lookup(this.relationship.junctionModel)}},{class:"foam.dao.DAOProperty",name:"sourceDAO",factory:function(){return this.__context__[this.relationship.sourceDAOKey]}},{class:"foam.dao.DAOProperty",name:"junctionDAO",factory:function(){return this.__context__[this.relationship.junctionDAOKey]}},{class:"String",name:"gridClsId",factory:function(){return this.relationship.junctionModel+"Grid"}},{class:"Class",name:"of",value:"foam.dao.grid.ManyToManyGridRecord"}],methods:[function find_(x,o){return this.delegate.find_(x,o).then(this.addSourcesToTarget.bind(this,x))},function select_(x,sink,skip,limit,order,predicate){sink=sink||this.ArraySink.create();return this.delegate.select_(x,this.ArraySink.create(),skip,limit,order,predicate).then(this.addSourcesToTargets.bind(this,x,sink)).then(function(){sink&&sink.eof&&sink.eof();return sink})}],listeners:[function addSourcesToTarget(x,target){var Cls=this.of;return this.sourceDAO.select().then(this.getDataForTarget.bind(this,target)).then(function(data){return Cls.create({target:target,data:data},x)})},function addSourcesToTargets(x,sink,localSink){var put=sink.put.bind(sink);var array=localSink.array;var promises=new Array(array.length);for(var i=0;i<array.length;i++){promises.push(this.addSourcesToTarget(x,array[i]).then(put))}return Promise.all(promises)},function getDataForTarget(target,sink){var sources=sink.array;return Promise.all(sources.map(this.getDatumForTarget.bind(this,target)))},function getDatumForTarget(target,source){return this.junctionDAO.where(this.AND(this.EQ(this.junctionCls.SOURCE_ID,source.id),this.EQ(this.junctionCls.TARGET_ID,target.id))).select().then(function(arraySink){return!!arraySink.array[0]})}]});
foam.CLASS({package:"foam.dao",name:"LazyCacheDAO",extends:"foam.dao.ProxyDAO",implements:["foam.mlang.Expressions"],requires:["foam.dao.ArraySink","foam.dao.DAOSink"],classes:[{name:"AnySink",properties:[{class:"Boolean",name:"hasAny"}],methods:[function put(){this.hasAny=true},function eof(){}]}],properties:[{name:"cache",required:true},{name:"cacheSync_",expression:function(delegate,cache){var s=this.cacheSyncSub_=delegate.on.remove.sub(function(sub_,on_,remove_,obj){cache.remove(obj)});return s}},{name:"cacheSyncSub_",postSet:function(old,nu){if(old&&old.detach)old.detach()}},{class:"Boolean",name:"refreshOnCacheHit",value:false},{class:"Boolean",name:"cacheOnSelect",value:false},{class:"Int",name:"staleTimeout",value:500},{name:"finds_",hidden:true,transient:true,factory:function(){return{}}},{name:"selects_",hidden:true,transient:true,factory:function(){return{}}},{class:"Function",name:"selectKey",value:function(sink,skip,limit,order,predicate){return predicate&&predicate.toString()||""+","+limit+","+skip+","+(order&&order.toString())||""}}],methods:[function remove_(x,obj){var self=this;return self.cache.remove_(x,obj).then(function(){return self.delegate.remove_(x,obj)})},function put_(x,obj){var self=this;return self.delegate.put_(x,obj).then(function(o){return self.cache.put_(x,o)})},function find_(x,id){var self=this;var _=self.cacheSync_;if(self.finds_[id]){return self.finds_[id]}else{return self.cache.find_(x,id).then(function(val){if(val){if(self.refreshOnCacheHit){self.delegate.find_(x,id).then(function(val){val&&self.cache.put_(x,val)})}return val}if(!self.finds_[id]){self.finds_[id]=self.delegate.find_(x,id);var errorHandler=function(err){delete self.finds_[id];throw err};return self.finds_[id].then(function(val){if(!val){delete self.finds_[id];return null}return self.cache.put_(x,val).then(function(val){delete self.finds_[id];return val},errorHandler)},errorHandler)}else{return self.finds_[id]}})}},function select_(x,sink,skip,limit,order,predicate){if(!this.cacheOnSelect){return this.SUPER(x,sink,skip,limit,order,predicate)}sink=sink||this.ArraySink.create();var key=this.selectKey(sink,skip,limit,order,predicate);var self=this;var _=self.cacheSync_;var entry=self.selects_[key];if(!entry||Date.now()-entry.time>self.staleTimeout){self.selects_[key]=entry={time:Date.now(),promise:self.delegate.select_(x,self.DAOSink.create({dao:self.cache}),skip,limit,order,predicate).then(function(cache){self.onCacheUpdate();return cache})}}function readFromCache(){return self.cache.select_(x,sink,skip,limit,order,predicate)}return self.cache.select_(x,this.AnySink.create(),skip,1,order,predicate).then(function(hasAny){if(hasAny.hasAny){return readFromCache()}else{return entry.promise.then(readFromCache)}})}],listeners:[{name:"onCacheUpdate",isMerged:true,code:function(){this.pub("on","reset")}}]});
foam.CLASS({package:"foam.dao",name:"SessionClientDAO",extends:"foam.dao.ProxyDAO",flags:["web"],imports:["sessionID as jsSessionID"],requires:["foam.box.SessionClientBox","foam.box.HTTPBox","foam.box.HTTPAuthorizationType","foam.dao.ClientDAO"],properties:[{name:"serviceName",class:"String"},{name:"sessionId",class:"String",factory:function(){return this.jsSessionID||localStorage.defaultSession}}],methods:[{name:"init",code:function(){this.SUPER();var x=this.__subContext__.createSubContext({sessionID:this.sessionId});var box=this.HTTPBox.create({authorizationType:this.HTTPAuthorizationType.BEARER,url:"service/"+this.serviceName},x);this.delegate=this.ClientDAO.create({name:this.serviceName,of:this.__subContext__[this.serviceName].of,delegate:box},x)}}]});
foam.CLASS({package:"foam.dao",name:"TTLCachingDAO",extends:"foam.dao.ProxyDAO",requires:["foam.dao.DAOSink","foam.dao.PromisedDAO","foam.dao.PurgeRecordCmd","foam.dao.QuickSink"],imports:["merged"],properties:[{name:"cache",factory:function(){return{}}},{class:"Long",name:"purgeTime",units:"ms",value:25e3},{name:"purgeCache",transient:true,expression:function(purgeTime){return this.merged(()=>{this.cache={}},purgeTime)}}],methods:[function find_(x,key){var id=this.of.isInstance(key)?key.id:key;var cachedValue=this.cache[id];var self=this;if(foam.Undefined.isInstance(cachedValue)){return new Promise(function(resolve,reject){self.delegate.find_(x,key).then(function(o){self.cache[id]=o||null;self.purgeCache();resolve(o)})})}return Promise.resolve(cachedValue?cachedValue.clone(x):null)},function put_(x,o){var self=this;return self.delegate.put(o).then(function(srcObj){self.cache[o.id]=srcObj;return srcObj})},function select_(x,sink,skip,limit,order,predicate){var self=this;return new Promise(function(resolve,reject){self.delegate.select_(x,sink,skip,limit,order,predicate).then(function(s){if(foam.dao.ArraySink.isInstance(s)){var a=s.array;for(var i=0;i<a.length;i++){var o=a[i];self.cache[o.id]=o}self.purgeCache()}resolve(s)})})},function remove_(x,o){var self=this;return self.delegate.remove_(x,o).then(function(){delete self.cache[o.id];return o})},function removeAll_(x,skip,limit,order,predicate){var self=this;return self.delegate.removeAll_(x,skip,limit,order,predicate).then(function(){self.cache={}})},function cmd_(x,obj){if(foam.dao.DAO.PURGE_CMD===obj){this.cache={}}else if(this.PurgeRecordCmd.isInstance(obj)){delete this.cache[obj.id]}this.SUPER(x,obj)}]});
foam.CLASS({package:"foam.dao",name:"TTLSelectCachingDAO",extends:"foam.dao.ProxyDAO",requires:["foam.dao.DAOSink","foam.dao.PromisedDAO","foam.dao.QuickSink"],imports:["merged"],properties:[{name:"cache",factory:function(){return{}}},{class:"Long",name:"purgeTime",units:"ms",value:25e3},{class:"Long",name:"maxCacheSize",value:100},{name:"purgeCache",transient:true,expression:function(purgeTime){return this.merged(()=>{this.cache={}},purgeTime)}}],methods:[function put_(x,o){this.cache={};return this.delegate.put_(x,o)},function select_(x,sink,skip,limit,order,predicate){if(foam.dao.AnonymousSink.isInstance(sink))return this.SUPER(x,sink,skip,limit,order,predicate);var self=this;var key=[sink,skip,limit,order,predicate].toString();if(this.cache[key]){return Promise.resolve(this.cache[key])}return new Promise(function(resolve,reject){self.delegate.select_(x,sink,skip,limit,order,predicate).then(function(s){self.cache[key]=s;self.purgeCache();resolve(s)})})},function remove_(x,o){this.cache={};return this.delegate.remove_(x,o)},function removeAll_(x,skip,limit,order,predicate){this.cache={};this.delegate.removeAll_(x,skip,limit,order,predicate)},function cmd_(x,obj){if(foam.dao.DAO.PURGE_CMD===obj){this.cache={}}this.SUPER(x,obj)}]});
foam.CLASS({package:"foam.dao",name:"CachingDAO",extends:"foam.dao.ProxyDAO",requires:["foam.dao.DAOSink","foam.dao.PromisedDAO","foam.dao.PurgeRecordCmd","foam.dao.QuickSink"],imports:["loginSuccess?","setInterval"],implements:["foam.mlang.Expressions"],properties:[{class:"foam.dao.DAOProperty",name:"src"},{name:"cache"},{class:"Proxy",of:"foam.dao.DAO",name:"delegate",hidden:true,topics:["on"],forwards:["find_","select_"],expression:function(src){var cache=this.cache;return this.PromisedDAO.create({promise:async function(){var a=await src.select();await cache.removeAll();a.array.forEach(o=>cache.put(o));return cache}()})}},{class:"Int",name:"pollingInterval",units:"ms"},{class:"FObjectProperty",of:"foam.core.Property",name:"pollingProperty"}],methods:[function init(){this.SUPER();if(this.loginSuccess$){this.loginSuccess$.sub(this.onSrcReset)}var proxy=this.src$proxy;proxy.listen(this.QuickSink.create({putFn:this.onSrcPut,removeFn:this.onSrcRemove,resetFn:this.onSrcReset}));if(this.pollingInterval>0){this.setInterval(this.poll,this.pollingInterval)}},function put_(x,o){var self=this;return self.src.put(o).then(function(srcObj){return self.delegate.put_(x,srcObj)})},function remove_(x,o){var self=this;return self.src.remove(o).then(function(){return self.delegate.remove_(x,o)})},function removeAll_(x,skip,limit,order,predicate){var self=this;return self.src.removeAll_(x,skip,limit,order,predicate).then(function(){return self.delegate.removeAll_(x,skip,limit,order,predicate)})},function cmd_(x,obj){if(foam.dao.DAO.PURGE_CMD===obj){this.onSrcReset()}else if(this.PurgeRecordCmd.isInstance(obj)){delete this.cache[obj.id]}this.SUPER(x,obj)}],listeners:[function onSrcPut(obj){this.delegate.put(obj)},function onSrcRemove(obj){this.delegate.remove(obj)},function onSrcReset(){this.clearPrivate_("delegate");this.cache.removeAll()},function poll(){var self=this;if(!this.loginSuccess)return;self.delegate.orderBy(this.DESC(self.pollingProperty)).limit(1).select().then(function(data){if(data.array.length===1){self.src.where(self.GT(self.pollingProperty,self.pollingProperty.f(data.array[0]))).select(self.QuickSink.create({putFn:self.onSrcPut}))}})}]});
foam.CLASS({package:"foam.dao",name:"DeDupDAO",extends:"foam.dao.ProxyDAO",methods:[function put_(x,obj){this.dedup(obj);return this.delegate.put_(x,obj)},function dedup(obj){var inst=obj.instance_;for(var key in inst){var val=inst[key];if(typeof val==="string"){inst[key]=foam.String.intern(val)}}}]});
foam.CLASS({package:"foam.dao",name:"LRUDAOManager",implements:["foam.mlang.Expressions"],requires:["foam.dao.MDAO"],classes:[{name:"LRUCacheItem",properties:[{name:"id"},{class:"Int",name:"timestamp"}]}],properties:[{class:"Int",name:"maxSize",value:100},{name:"trackingDAO",factory:function(){return this.MDAO.create({of:this.LRUCacheItem})}},{class:"foam.dao.DAOProperty",name:"dao"},{class:"Int",name:"lastTimeUsed_",factory:function(){return Date.now()}}],methods:[function init(){this.SUPER();var proxy=this.dao$proxy;proxy.sub("on","put",this.onPut);proxy.sub("on","remove",this.onRemove);proxy.sub("on","reset",this.onReset)},function getTimestamp(){return this.lastTimeUsed_++},function cleanup(){var self=this;self.trackingDAO.orderBy(this.DESC(self.LRUCacheItem.TIMESTAMP)).skip(self.maxSize).select({put:function(obj){self.dao.remove(obj)}})}],listeners:[function onPut(s,on,put,obj){var self=this;this.trackingDAO.put(this.LRUCacheItem.create({id:obj.id,timestamp:self.getTimestamp()})).then(function(){self.cleanup()})},function onRemove(s,on,remove,obj){this.trackingDAO.remove(obj)},function onReset(s,on,reset,obj){this.trackingDAO.removeAll(obj)}]});
foam.CLASS({package:"foam.dao",name:"QueryCachingDAO",extends:"foam.dao.ProxyDAO",properties:[{name:"cache",factory:function(){return{}}}],methods:[function put_(x,o){this.cache={};return this.delegate.put_(x,o)},function select_(x,sink,skip,limit,order,predicate){if(limit===undefined||!(foam.dao.ArraySink.isInstance(sink)||foam.mlang.sink.Projection.isInstance(sink))){return this.SUPER(x,sink,skip,limit,order,predicate)}let self=this;let key=[sink,order,predicate].toString();return new Promise(function(resolve,reject){let requestStartIdx=skip||0;let requestEndIdx=requestStartIdx+limit;self.fillCache_(key,requestStartIdx,requestEndIdx,x,sink,order,predicate).then(function(){for(let idx=requestStartIdx;idx<requestEndIdx;idx++){sink.put(self.cache[key][idx])}resolve(sink)})})},function remove_(x,o){this.cache={};return this.delegate.remove_(x,o)},function removeAll_(x,skip,limit,order,predicate){this.cache={};this.delegate.removeAll_(x,skip,limit,order,predicate)},function cmd_(x,obj){if(foam.dao.DAO.PURGE_CMD===obj){this.cache={}}this.SUPER(x,obj)},function fillCache_(key,requestStartIdx,requestEndIdx,x,sink,order,predicate){let startIdx=-1;let endIdx=-1;let hasMissingData=false;if(this.cache[key]){for(let idx=requestStartIdx;idx<requestEndIdx;idx++){if(!this.cache[key][idx]){if(!hasMissingData){hasMissingData=true;startIdx=idx;break}}}if(hasMissingData){for(let idx=requestEndIdx-1;idx>=startIdx;idx--){if(!this.cache[key][idx]){endIdx=idx+1;break}}}}else{hasMissingData=true;startIdx=requestStartIdx;endIdx=requestEndIdx;this.cache[key]=[]}if(hasMissingData){let self=this;return this.delegate.select_(x,sink,startIdx,endIdx-startIdx,order,predicate).then(function(result){for(let idx=0;idx<result.array.length;idx++){self.cache[key][startIdx+idx]=result.array[idx]}})}return Promise.resolve()}]});
foam.CLASS({package:"foam.dao",name:"SequenceNumberDAO",extends:"foam.dao.ProxyDAO",implements:[{path:"foam.mlang.Expressions",flags:["js"]}],requires:[{flags:["swift"],path:"foam.mlang.sink.Max"}],properties:[{class:"String",name:"property",value:"id"},{class:"Long",name:"startingValue"},{class:"Long",name:"value_",swiftExpressionArgs:["delegate","property_","startingValue"],swiftExpression:`
let max = self.Max_create(["arg1": property_])
_ = try? delegate.select(max)
let v = max.value is Int ? (max.value as! Int) + 1 : 1
return v >= startingValue ? v : startingValue
`,},{flags:["js"],name:"calcDelegateMax_",hidden:true,expression:function(delegate,property,startingValue){var self=this;return self.delegate.select(self.MAX(self.property_)).then(function(max){var v=foam.Number.isInstance(max.value)?max.value+1:1;self.value_=v>startingValue?v:startingValue})}},{name:"property_",hidden:true,swiftExpressionArgs:["property","of"],swiftExpression:`
return of.axiom(byName: property) as! PropertyInfo
`,expression:function(property,of){var a=this.of.getAxiomByName(property);if(!a){throw this.InternalException.create({message:"SequenceNumberDAO specified with invalid property "+property+" for class "+this.of})}return a},javaInfoType:"foam.core.AbstractObjectPropertyInfo",}],methods:[{name:"put_",code:function put_(x,obj){var self=this;return this.calcDelegateMax_.then(function(){if(!obj.hasOwnProperty(self.property_.name)){obj[self.property_.name]=self.value_;self.value_++}else if(obj[self.property_name]>=self.value_){self.value_=obj[self.property_name]+1}return self.delegate.put_(x,obj)})},}],axioms:[{buildJavaClass:function(cls){cls.extras.push(`
public SequenceNumberDAO(foam.dao.DAO delegate) {
this(1, delegate);
}
public SequenceNumberDAO(long value, foam.dao.DAO delegate) {
System.err.println("Direct constructor use is deprecated. Use Builder instead. SequenceNumberDAO");
setStartingValue(value);
setDelegate(delegate);
}
`)}}]});
foam.CLASS({package:"foam.dao",name:"SequenceNumberDAOTest",extends:"foam.nanos.test.Test",methods:[{name:"runTest",}]});
foam.CLASS({package:"foam.dao",name:"ContextualizingDAO",extends:"foam.dao.ProxyDAO",methods:[{name:"find_",code:function(x,id){var self=this;return self.delegate.find_(x,id).then(function(obj){return self.maybeContextualize_(x,obj)})},},{name:"put_",code:function(x,o){var self=this;return self.delegate.put_(x,o).then(function(o){return self.maybeContextualize_(x,o)})},},{name:"maybeContextualize_",type:"FObject",args:[{name:"x",type:"Context"},{name:"obj",type:"FObject"}],code:function(x,obj){return obj&&obj.clone(this)},}]});
foam.CLASS({package:"foam.dao",name:"VersionNoDAO",extends:"foam.dao.ProxyDAO",implements:["foam.mlang.Expressions"],requires:["foam.dao.InternalException","foam.version.VersionTrait"],properties:[{name:"of",required:true},{name:"delegate",required:true,final:true},{class:"Int",name:"version",value:1},{class:"Boolean",name:"ready_"}],methods:[function init(){this.validate();this.SUPER();this.delegate.orderBy(this.DESC(this.VersionTrait.VERSION_)).limit(1).select().then(function(sink){var propName=this.VersionTrait.VERSION_.name;if(sink.array[0]&&sink.array[0][propName])this.version=sink.array[0][propName]+1;this.ready_=true}.bind(this))},function validate(){this.SUPER();if(!this.VersionTrait.isSubClass(this.of)){throw new Error(`VersionNoDAO.of must have trait
foam.version.VersionTrait`)}},function put_(x,obj){if(!this.ready_)return Promise.reject(this.InternalException.create());obj[this.VersionTrait.VERSION_.name]=this.version;this.version++;return this.delegate.put_(x,obj)},function remove_(x,obj){if(!this.ready_)return Promise.reject(this.InternalException.create());var deleted=obj.clone(x);deleted[this.VersionTrait.DELETED_.name]=true;deleted[this.VersionTrait.VERSION_.name]=this.version;this.version++;return this.delegate.put_(x,deleted)},function removeAll_(x,skip,limit,order,predicate){if(!this.ready_)return Promise.reject(this.InternalException.create());return this.select_(x,null,skip,limit,order,predicate).then(function(sink){var array=sink.array;var promises=[];for(var i=0;i<array.length;i++){promises.push(this.remove_(x,array[i]))}return Promise.all(promises)}.bind(this))}]});
foam.CLASS({package:"foam.dao.sync",name:"SyncRecord",properties:["id"]});foam.SCRIPT({package:"foam.dao.sync",name:"VersionedSyncRecordScript",requires:["foam.version.VersionedClassFactorySingleton","foam.dao.sync.SyncRecord"],code:function(){foam.lookup("foam.version.VersionedClassFactorySingleton").create().get(foam.lookup("foam.dao.sync.SyncRecord"))}});
foam.CLASS({package:"foam.dao",name:"SyncDAO",extends:"foam.dao.ProxyDAO",requires:["foam.dao.ArraySink","foam.dao.sync.VersionedSyncRecord","foam.version.VersionTrait"],implements:["foam.mlang.Expressions"],imports:["setInterval"],classes:[{name:"AdapterSink",extends:"foam.dao.ProxySink",properties:[{class:"Class",name:"of"}],methods:[function put(o,sub){this.delegate.put(this.of.create(o,this.__subContext__),sub)}]}],properties:[{class:"foam.dao.DAOProperty",name:"remoteDAO",transient:true,required:true},{name:"delegate",},{class:"foam.dao.DAOProperty",name:"syncRecordDAO",transient:true,required:true},{name:"of",required:true,transient:true},{class:"Boolean",name:"polling",postSet:function(old,nu){this.sync_=nu?this.pollingSync_:this.syncToRemote_}},{class:"Int",name:"pollingFrequency",value:1e3},{name:"synced",factory:function(){return Promise.resolve()}},{name:"syncRecordWriteSync_",factory:function(){return Promise.resolve()}},{class:"Function",name:"sync_",factory:function(){return this.polling?this.pollingSync_:this.syncToRemote_}}],methods:[function init(){this.SUPER();this.validate();if(!this.polling)this.remoteDAO$proxy.sub("on",this.onRemoteUpdate);var self=this;self.synced=self.delegate.select().then(function(sink){var minVersionNo=0;var array=sink.array;for(var i=0;i<array.length;i++){var version=self.VersionTrait.VERSION_.f(array[i]);self.syncRecordDAO.put(self.VersionedSyncRecord.create({id:array[i].id,version_:version}));minVersionNo=Math.max(minVersionNo,version)}return self.syncFromRemote_(minVersionNo)});if(!self.polling)return;self.synced.then(function(){self.setInterval(function(){self.sync()},self.pollingFrequency)})},function validate(){this.SUPER();if(!this.VersionTrait.isSubClass(this.of)){throw new Error(`SyncDAO.of must have trait foam.version.VersionTrait`)}},function sync(){return this.synced=this.synced.then(function(){return this.sync_()}.bind(this))},function put_(x,obj){var self=this;var ret;return self.withSyncRecordTx_(function(){return self.delegate.put_(x,obj).then(function(o){ret=o;return self.syncRecordDAO.put_(x,self.VersionedSyncRecord.create({id:o.id,version_:-1}))})}).then(self.onLocalUpdate).then(function(){return ret})},function remove_(x,obj){var self=this;var ret;return self.withSyncRecordTx_(function(){return self.delegate.remove_(x,obj).then(function(o){ret=o;self.syncRecordDAO.put_(x,self.VersionedSyncRecord.create({id:obj.id,deleted_:true,version_:-1}))})}).then(self.onLocalUpdate).then(function(){return ret})},function removeAll_(x,skip,limit,order,predicate){return this.delegate.select_(x,null,skip,limit,order,predicate).then(function(a){a=a.array;var promises=[];for(var i=0;i<a.length;i++){promises.push(this.remove_(x,a[i]))}return Promise.all(promises)}.bind(this))},{name:"putFromRemote_",code:function(obj){var self=this;var ret;return self.withSyncRecordTx_(function(){return self.delegate.put(obj).then(function(o){ret=o;return self.syncRecordDAO.put(self.VersionedSyncRecord.create({id:o.id,version_:self.VersionTrait.VERSION_.f(o)}))})}).then(function(){return ret})}},{name:"removeFromRemote_",code:function(obj){var self=this;var ret;return self.withSyncRecordTx_(function(){return self.delegate.remove(obj).then(function(o){ret=o;return self.syncRecordDAO.put(self.VersionedSyncRecord.create({id:obj.id,version_:self.VersionTrait.VERSION_.f(obj),deleted_:true}))})}).then(function(){return ret})}},{name:"resetFromRemote_",code:function(obj){var self=this;var ret;return self.withSyncRecordTx_(function(){return self.syncRecordDAO.where(self.GT(self.VersionedSyncRecord.VERSION_,-1)).removeAll().then(self.syncRecordDAO.select.bind(self.syncRecordDAO)).then(function(sink){var idsToKeep=sink.array.map(function(syncRecord){return syncRecord.id});return self.delegate.where(self.NOT(self.IN(self.of.ID,idsToKeep))).removeAll()})}).then(self.sync.bind(self))}},{name:"pollingSync_",code:function(){var self=this;var VERSION_=self.VersionedSyncRecord.VERSION_;return self.syncRecordDAO.orderBy(self.DESC(VERSION_)).limit(1).select().then(function(sink){var minVersionNo=sink.array[0]&&VERSION_.f(sink.array[0])||0;return self.syncToRemote_().then(self.syncFromRemote_.bind(self,minVersionNo))})}},{name:"syncToRemote_",code:function(){var self=this;return this.syncRecordDAO.where(self.EQ(self.VersionedSyncRecord.VERSION_,-1)).select().then(function(records){records=records.array;var promises=[];for(var i=0;i<records.length;i++){var record=records[i];var id=record.id;var deleted=self.VersionedSyncRecord.DELETED_.f(record);if(deleted){var obj=self.of.create(undefined,self);obj.id=id;var promise=self.remoteDAO.remove(obj);if(self.polling){promises.push(promise.then(function(){var propName=self.VersionTrait.VERSION_.name;obj[propName]=Math.max(obj[propName],0);return self.removeFromRemote_(obj)}))}else{promises.push(promise)}}else{promises.push(self.delegate.find(id).then(function(obj){if(!obj)return null;var ret=self.remoteDAO.put(obj);if(self.polling){ret=ret.then(function(o){return self.putFromRemote_(o)})}return ret}))}}return Promise.all(promises)})}},{name:"syncFromRemote_",code:function(minVersionNo){var self=this;return self.remoteDAO.where(self.GT(self.VersionTrait.VERSION_,minVersionNo)).orderBy(self.VersionTrait.VERSION_).select().then(function(sink){var array=sink.array;var promises=[];for(var i=0;i<array.length;i++){if(self.VersionTrait.DELETED_.f(array[i])){promises.push(self.removeFromRemote_(array[i]))}else{promises.push(self.putFromRemote_(array[i]))}}return Promise.all(promises)})}},{name:"withSyncRecordTx_",code:function(f){return this.syncRecordWriteSync_=this.syncRecordWriteSync_.then(f)}}],listeners:[{name:"onRemoteUpdate",code:function(s,on,event,obj){if(event=="put"){if(this.VersionTrait.DELETED_.f(obj))this.removeFromRemote_(obj);else this.putFromRemote_(obj)}else if(event==="remove"){throw new Error(`SyncDAO recieved remove() event;
expected put(deleted)-as-remove()`)}else if(event==="reset"){this.resetFromRemote_()}}},{name:"onLocalUpdate",isMerged:true,mergeDelay:100,code:function(){this.sync()}}]});
foam.CLASS({package:"foam.dao",name:"FUIDDAO",extends:"foam.dao.ProxyDAO",constants:[{name:"SALT_CMD",type:"String",value:"SALT_CMD"}],implements:["foam.nanos.boot.NSpecAware"],imports:["DAO fuidKeyDAO"],properties:[{class:"String",name:"property",value:"id"},{class:"String",name:"salt",},{name:"propertyInfo",hidden:true,javaInfoType:"foam.core.AbstractObjectPropertyInfo",},{class:"Object",name:"uIDGenerator",hidden:true},{name:"nSpec",class:"FObjectProperty",type:"foam.nanos.boot.NSpec",hidden:true},{name:"minLength",class:"Int"}],methods:[{name:"init_",},{name:"put_",},{name:"cmd_",args:"Context x, Object obj",}]});
foam.CLASS({package:"foam.nanos.u2.navigation",name:"SignUp",implements:["foam.mlang.Expressions"],imports:["appConfig","auth","ctrl","stack","translationService","theme","subject"],requires:["foam.log.LogLevel","foam.nanos.auth.User","foam.u2.dialog.NotificationMessage","foam.u2.stack.StackBlock"],messages:[{name:"TITLE",message:"Create an account"},{name:"FOOTER_TXT",message:"Already have an account?"},{name:"FOOTER_LINK",message:"Sign in"},{name:"ERROR_MSG",message:"There was a problem creating your account"},{name:"EMAIL_ERR",message:"Valid email required"},{name:"EMAIL_AVAILABILITY_ERR",message:"This email is already in use. Please sign in or use a different email"},{name:"USERNAME_EMPTY_ERR",message:"Username required"},{name:"USERNAME_AVAILABILITY_ERR",message:"This username is taken. Please try another."},{name:"PASSWORD_ERR",message:"Password should be at least 10 characters"},{name:"WEAK_PASSWORD_ERR",message:"Password is weak"},{name:"SUCCESS_MSG",message:"Account successfully created"},{name:"SUCCESS_MSG_TITLE",message:"Success"}],properties:[{name:"dao_",hidden:true,transient:true},{class:"Boolean",name:"isLoading_",hidden:true},{class:"String",name:"token_",hidden:true},{class:"Boolean",name:"disableEmail_",hidden:true},{class:"Boolean",name:"emailAvailable",value:true,hidden:true},{class:"EMail",name:"email",placeholder:"example@example.com",view:function(_,X){return{class:"foam.u2.view.UserPropertyAvailabilityView",icon:"images/checkmark-small-green.svg",onKey:true,isAvailable$:X.data.emailAvailable$,inputValidation:/\S+@\S+\.\S+/,restrictedCharacters:/^[^\s]$/,displayMode:X.data.disableEmail_?foam.u2.DisplayMode.DISABLED:foam.u2.DisplayMode.RW}},validateObj:function(email,emailAvailable){if(email.length===0||!/\S+@\S+\.\S+/.test(email))return this.EMAIL_ERR;if(!emailAvailable)return this.EMAIL_AVAILABILITY_ERR},required:true},{class:"Boolean",name:"usernameAvailable",value:true,hidden:true},{class:"String",name:"userName",label:"Username",placeholder:"example123",view:function(_,X){return{class:"foam.u2.view.UserPropertyAvailabilityView",icon:"images/checkmark-small-green.svg",onKey:true,isAvailable$:X.data.usernameAvailable$,inputValidation:/^[^\s\/]+$/,restrictedCharacters:/^[^\s\/]$/}},validateObj:function(userName,usernameAvailable){if(userName.length===0)return this.USERNAME_EMPTY_ERR;if(!usernameAvailable)return this.USERNAME_AVAILABILITY_ERR},required:true},{class:"Boolean",name:"passwordAvailable",value:true,hidden:true},{class:"Password",name:"desiredPassword",label:"Password",view:function(_,X){return{class:"foam.u2.view.PasswordView",isAvailable$:X.data.passwordAvailable$,passwordIcon:true}},validateObj:function(desiredPassword,passwordAvailable){if(!desiredPassword||desiredPassword.length<10)return this.PASSWORD_ERR;if(!passwordAvailable)return this.WEAK_PASSWORD_ERR},required:true},{class:"Boolean",name:"showAction",visibility:"HIDDEN",value:true,}],methods:[{name:"footerLink",code:function(topBarShow_,param){window.history.replaceState(null,null,window.location.origin);this.stack.push(this.StackBlock.create({view:{class:"foam.u2.view.LoginView",mode_:"SignIn",topBarShow_:topBarShow_,param:param},parent:this}))}},{name:"subfooterLink",code:function(){return}},{name:"nextStep",code:async function(x){await this.finalRedirectionCall(x)}},{name:"finalRedirectionCall",code:async function(x){if(this.subject.user.emailVerified){window.history.replaceState(null,null,window.location.origin);location.reload()}else{this.stack.push(this.StackBlock.create({view:{class:"foam.nanos.auth.ResendVerificationEmail"}}))}}},{name:"defaultUserLanguage",code:function(){let l=foam.locale.split("-");let code=l[0];let variant=l[1];let language=foam.nanos.auth.Language.create({code:code});if(variant)language.variant=variant;return language}}],actions:[{name:"login",label:"Get started",buttonStyle:"PRIMARY",isEnabled:function(errors_,isLoading_){return!errors_&&!isLoading_},isAvailable:function(showAction){return showAction},code:function(x,updateUser){this.isLoading_=true;this.dao_.put(this.User.create({userName:this.userName,email:this.email,desiredPassword:this.desiredPassword,signUpToken:this.token_,language:this.defaultUserLanguage()})).then(async user=>{this.subject.realUser=user;this.subject.user=user;await this.nextStep(x);this.ctrl.add(this.NotificationMessage.create({message:this.SUCCESS_MSG_TITLE,description:this.SUCCESS_MSG,type:this.LogLevel.INFO,transient:true}))}).catch(err=>{this.ctrl.add(this.NotificationMessage.create({err:err.data,message:this.ERROR_MSG,type:this.LogLevel.ERROR}))}).finally(()=>{this.isLoading_=false})}}]});
foam.CLASS({package:"foam.nanos.u2.navigation",name:"SignIn",imports:["auth","ctrl","currentMenu","loginSuccess","menuDAO","memento_","pushMenu","stack","translationService","subject"],requires:["foam.log.LogLevel","foam.u2.dialog.NotificationMessage","foam.u2.stack.StackBlock","foam.nanos.auth.DuplicateEmailException"],messages:[{name:"TITLE",message:"Welcome!"},{name:"FOOTER_TXT",message:"Not a user yet?"},{name:"FOOTER_LINK",message:"Create an account"},{name:"SUB_FOOTER_LINK",message:"Forgot password?"},{name:"ERROR_MSG",message:"There was an issue logging in"},{name:"ERROR_MSG2",message:"Please enter email or username"},{name:"ERROR_MSG3",message:"Please enter password"}],properties:[{name:"dao_",hidden:true,transient:true},{class:"String",name:"username",visibility:function(usernameRequired){return usernameRequired?foam.u2.DisplayMode.RW:foam.u2.DisplayMode.HIDDEN},postSet:function(_,n){this.identifier=n;return n}},{class:"Boolean",name:"usernameRequired",hidden:true},{class:"String",name:"identifier",required:true,label:"Email or Username",view:{class:"foam.u2.TextField",focused:true},visibility:function(disableIdentifier_,usernameRequired){return disableIdentifier_||usernameRequired?foam.u2.DisplayMode.HIDDEN:foam.u2.DisplayMode.RW},validationTextVisible:false},{class:"Password",name:"password",view:{class:"foam.u2.view.PasswordView",passwordIcon:true}},{class:"Boolean",name:"disableIdentifier_",hidden:true},{class:"String",name:"token_",hidden:true},{class:"Boolean",name:"showAction",visibility:"HIDDEN",value:true,}],methods:[{name:"footerLink",code:function(topBarShow_,param){window.history.replaceState(null,null,window.location.origin);this.stack.push(this.StackBlock.create({view:{class:"foam.u2.view.LoginView",mode_:"SignUp",topBarShow_:topBarShow_,param:param},parent:this}))}},{name:"subfooterLink",code:function(){this.stack.push(this.StackBlock.create({view:{class:"foam.nanos.auth.ChangePasswordView",modelOf:"foam.nanos.auth.RetrievePassword"}}))}},{name:"nextStep",code:async function(X){if(this.subject.realUser.twoFactorEnabled){this.loginSuccess=false;window.history.replaceState({},document.title,"/");this.stack.push(this.StackBlock.create({view:{class:"foam.nanos.auth.twofactor.TwoFactorSignInView"}}))}else{if(!this.subject.realUser.emailVerified){await this.auth.logout();this.stack.push(this.StackBlock.create({view:{class:"foam.nanos.auth.ResendVerificationEmail"}}))}else{this.loginSuccess=!!this.subject;if(this.loginSuccess)await this.ctrl.reloadClient()}}}}],actions:[{name:"login",label:"Sign in",buttonStyle:"PRIMARY",isAvailable:function(showAction){return showAction},code:async function(X){this.identifier=this.identifier.trim();if(this.identifier.length>0){if(!this.password){this.ctrl.add(this.NotificationMessage.create({message:this.ERROR_MSG3,type:this.LogLevel.ERROR}));return}try{var logedInUser=await this.auth.login(X,this.identifier,this.password);if(!logedInUser)return;if(this.token_){logedInUser.signUpToken=this.token_;try{var updatedUser=await this.dao_.put(logedInUser);this.subject.user=updatedUser;this.subject.realUser=updatedUser;await this.nextStep()}catch(err){this.ctrl.add(this.NotificationMessage.create({err:err.data,message:this.ERROR_MSG,type:this.LogLevel.ERROR}))}}else{this.subject.user=logedInUser;this.subject.realUser=logedInUser;await this.nextStep()}}catch(err){if(this.DuplicateEmailException.isInstance(err.data.exception)){this.usernameRequired=true}this.ctrl.add(this.NotificationMessage.create({err:err.data,message:this.ERROR_MSG,type:this.LogLevel.ERROR}))}}else{this.ctrl.add(this.NotificationMessage.create({message:this.ERROR_MSG2,type:this.LogLevel.ERROR}))}}}]});
foam.CLASS({package:"foam.dao",name:"EasyDAO",extends:"foam.dao.ProxyDAO",implements:["foam.mlang.Expressions"],requires:["foam.box.Context","foam.box.HTTPBox","foam.box.RetryBox","foam.box.SessionClientBox","foam.box.SocketBox","foam.box.TimeoutBox","foam.box.WebSocketBox","foam.dao.CachingDAO","foam.dao.ClientDAO","foam.dao.CompoundDAODecorator","foam.dao.ContextualizingDAO","foam.dao.DeDupDAO","foam.dao.InterceptedDAO","foam.dao.DAO","foam.dao.GUIDDAO","foam.dao.IDBDAO",{path:"foam.dao.JDAO",flags:["js"]},{name:"JDAOJava",path:"foam.dao.java.JDAO",flags:["java"]},"foam.dao.MDAO","foam.dao.OrderedDAO","foam.dao.PromisedDAO","foam.dao.QueryCachingDAO","foam.dao.TTLCachingDAO","foam.dao.TTLSelectCachingDAO","foam.dao.RequestResponseClientDAO","foam.dao.SequenceNumberDAO","foam.dao.SyncDAO","foam.dao.TimingDAO","foam.dao.JournalType","foam.nanos.auth.ServiceProviderAware","foam.nanos.auth.ServiceProviderAwareDAO","foam.nanos.crunch.box.CrunchClientBox","foam.nanos.logger.Logger","foam.nanos.logger.LoggingDAO","foam.nanos.theme.SubdomainAwareDAO"],imports:["document","log"],constants:[{name:"aliases",flags:["js"],value:{ARRAY:"foam.dao.ArrayDAO",CLIENT:"foam.dao.RequestResponseClientDAO",IDB:"foam.dao.IDBDAO",LOCAL:"foam.dao.LocalStorageDAO",MDAO:"foam.dao.MDAO"}}],properties:[{class:"String",name:"name",factory:function(){return this.of&&this.of.id},},{name:"nSpec",class:"FObjectProperty",type:"foam.nanos.boot.NSpec",},{name:"lastDao",class:"foam.dao.DAOProperty"},{name:"delegate",},{class:"Object",type:"foam.dao.DAO",name:"innerDAO"},{class:"Object",type:"foam.dao.DAO",name:"decorator"},{class:"Boolean",name:"pipelinePm"},{class:"Boolean",name:"seqNo"},{class:"Long",name:"seqStartingValue",value:1},{class:"Boolean",name:"guid",label:"GUID"},{class:"Boolean",name:"fuid",label:"FUID"},{class:"String",name:"seqPropertyName",value:"id"},{name:"seqProperty",generateJava:false,class:"Property"},{class:"Boolean",name:"cache",generateJava:false},{class:"Int",name:"pollingInterval",units:"ms",generateJava:false},{class:"FObjectProperty",of:"foam.core.Property",name:"pollingProperty",generateJava:false},{class:"Long",name:"ttlPurgeTime",units:"ms",generateJava:false},{class:"Long",name:"ttlSelectPurgeTime",units:"ms",generateJava:false},{class:"Boolean",name:"queryCache",generateJava:false},{class:"Boolean",name:"authorize",value:true},{class:"Object",type:"foam.nanos.auth.Authorizer",name:"authorizer",},{class:"String",name:"permissionPrefix",factory:function(){return this.of.name.toLowerCase()},},{class:"Boolean",name:"readOnly"},{class:"Boolean",name:"writeOnly"},{class:"Boolean",name:"nullify"},{class:"Boolean",name:"permissioned",},{class:"Boolean",name:"validated"},{class:"FObjectProperty",of:"foam.core.Validator",name:"validator"},{class:"Boolean",name:"dedup",generateJava:false},{class:"foam.core.Enum",of:"foam.dao.JournalType",name:"journalType",value:"NO_JOURNAL"},{class:"String",name:"journalName"},{class:"FObjectProperty",of:"foam.dao.Journal",generateJava:false,name:"journal"},{class:"Boolean",name:"logging"},{class:"Boolean",name:"timing"},{class:"Boolean",name:"pm"},{class:"Boolean",name:"history",},{class:"String",name:"historyDAOKey",javaValue:`"historyDAO"`},{class:"Boolean",name:"contextualize"},{class:"Boolean",name:"ruler",value:true},{class:"String",name:"rulerDaoKey"},{name:"daoType",generateJava:false,value:"foam.dao.IDBDAO"},{class:"foam.dao.DAOProperty",name:"mdao"},{class:"Boolean",generateJava:false,name:"autoIndex",},{class:"Boolean",name:"syncWithServer",generateJava:false},{class:"Boolean",generateJava:false,name:"remoteListenerSupport"},{class:"Boolean",generateJava:false,name:"syncPolling",value:true},{class:"Boolean",generateJava:false,name:"isServer"},{name:"syncProperty",generateJava:false},{name:"retryBoxMaxAttempts",class:"Boolean",generateJava:false},{name:"crunchBoxEnabled",generateJava:false,value:true},{name:"serverBox",generateJava:false,factory:function(){var box=this.TimeoutBox.create({delegate:this.remoteListenerSupport?this.WebSocketBox.create({uri:this.serviceName}):this.HTTPBox.create({url:this.serviceName})});if(this.retryBoxMaxAttempts!=0){box=this.RetryBox.create({maxAttempts:this.retryBoxMaxAttempts,delegate:box})}if(this.crunchBoxEnabled){box=this.CrunchClientBox.create({delegate:box})}return this.SessionClientBox.create({delegate:box})}},{name:"cluster",class:"Boolean",},{name:"SAF",class:"Boolean",value:false},{name:"serviceName",class:"String",generateJava:false},{class:"FObjectArray",of:"foam.core.FObject",generateJava:false,name:"decorators"},{class:"FObjectArray",of:"foam.mlang.order.Comparator",name:"order"},{class:"FObjectArray",of:"foam.core.PropertyInfo",name:"index"},{name:"testData",generateJava:false},{name:"enableInterfaceDecorators",class:"Boolean",value:true},{name:"serviceProviderAware",class:"Boolean",},{name:"subdomainAware",class:"Boolean"},{name:"serviceProviderAwarePropertyInfos",class:"Map"},{name:"lifecycleAware",class:"Boolean",},{name:"createdAware",class:"Boolean",},{name:"createdByAware",class:"Boolean",},{name:"lastModifiedAware",class:"Boolean",},{name:"lastModifiedByAware",class:"Boolean",},{name:"capable",class:"Boolean",},{name:"allowActionRequiredPuts",class:"Boolean",},{name:"fixedSize",class:"FObjectProperty",of:"foam.dao.FixedSizeDAO"},{name:"approvableAware",class:"Boolean",},{name:"approvableAwareEnabled",class:"Boolean",},{name:"deletedAware",class:"Boolean",},{name:"approvableAwareServiceName",class:"String",},{name:"approvableAwareRelationshipName",class:"String",}],methods:[{name:"init_",},{name:"getJournalDelegate",args:[{type:"Context",name:"x"},{type:"foam.dao.DAO",name:"delegate"}],type:"foam.dao.DAO",},{name:"getOuterDAO",type:"foam.dao.DAO",args:[{type:"foam.dao.DAO",name:"innerDAO"}],},function init(){this.SUPER.apply(this,arguments);var daoType=typeof this.daoType==="string"?this.ALIASES[this.daoType]||this.daoType:this.daoType;var params={of:this.of};if(daoType=="foam.dao.RequestResponseClientDAO"){foam.assert(this.hasOwnProperty("serverBox")||this.serviceName,'EasyDAO "client" type requires a serveBox or serviceName');if(this.remoteListenerSupport){daoType="foam.dao.ClientDAO"}params.delegate=this.serverBox}var daoModel=typeof daoType==="string"?this.__context__.lookup(daoType)||global[daoType]:daoType;if(!daoModel){this.__context__.warn("EasyDAO: Unknown DAO Type.  Add '"+daoType+"' to requires: list.")}if(this.name&&daoModel.getAxiomByName("name"))params.name=this.name;if(daoModel.getAxiomByName("autoIndex"))params.autoIndex=this.autoIndex;var dao=daoModel.create(params,this.__subContext__);delete params["name"];if(this.MDAO.isInstance(dao)){this.mdao=dao;if(this.dedup)dao=this.DeDupDAO.create({delegate:dao})}else{if(this.cache){if(this.ttlPurgeTime<=0&&this.ttlSelectPurgeTime<=0){this.mdao=this.MDAO.create({of:params.of});var cache=this.mdao;if(this.dedup)cache=this.DeDupDAO.create({delegate:cache});if(Array.isArray(this.order)&&this.order.length>0)cache=this.OrderedDAO.create({delegate:cache,comparator:foam.compare.toCompare(this.order)});dao=this.CachingDAO.create({cache:cache,src:dao,of:this.model,pollingInterval:this.pollingInterval,pollingProperty:this.pollingProperty})}if(this.ttlPurgeTime>0){dao=this.TTLCachingDAO.create({delegate:dao,purgeTime:this.ttlPurgeTime})}if(this.ttlSelectPurgeTime>0){dao=this.TTLSelectCachingDAO.create({delegate:dao,purgeTime:this.ttlSelectPurgeTime})}}}if(this.queryCache){dao=this.QueryCachingDAO.create({delegate:dao})}if(this.journal){dao=this.JDAO.create({delegate:dao,journal:this.journal})}if(this.seqNo&&this.guid)throw"EasyDAO 'seqNo' and 'guid' features are mutually exclusive.";if(this.seqNo){var args={__proto__:params,delegate:dao,of:this.of};if(this.seqProperty)args.property=this.seqProperty;args.startingValue=this.seqStartingValue;dao=this.SequenceNumberDAO.create(args)}if(this.guid){var args={__proto__:params,delegate:dao,of:this.of};if(this.seqProperty)args.property=this.seqProperty;dao=this.GUIDDAO.create(args)}var cls=this.of;if(this.syncWithServer&&this.isServer)throw"isServer and syncWithServer are mutually exclusive.";if(this.syncWithServer||this.isServer){if(!this.syncProperty){this.syncProperty=cls.SYNC_PROPERTY;if(!this.syncProperty){throw"EasyDAO sync with class "+cls.id+" invalid. Sync requires a sync property be set, or be of a class including a property 'sync_property'."}}}if(this.syncWithServer){foam.assert(this.serverBox,"syncWithServer requires serverBox");dao=this.SyncDAO.create({remoteDAO:this.RequestResponseClientDAO.create({name:this.name,delegate:this.serverBox},boxContext),syncProperty:this.syncProperty,delegate:dao,pollingFrequency:1e3});dao.syncRecordDAO=foam.dao.EasyDAO.create({of:dao.SyncRecord,cache:true,daoType:this.daoType,name:this.name+"_SyncRecords"})}if(this.contextualize){dao=this.ContextualizingDAO.create({delegate:dao})}if(this.decorators.length){decoratorsArray=[];for(let i=0;i<this.decorators.length;i++){if(foam.dao.ProxyDAO.isInstance(this.decorators[i])){d=this.decorators[i];d.delegate=dao;dao=d}else{decoratorsArray.push(this.decorators[i])}}var decorated=this.InterceptedDAO.create({decorator:this.CompoundDAODecorator.create({decorators:decoratorsArray}),delegate:dao});dao=decorated}if(this.order){dao=dao.orderBy(this.order)}if(this.timing){dao=this.TimingDAO.create({name:this.name+"DAO",delegate:dao})}if(this.logging){dao=this.LoggingDAO.create({nSpec:this.nSpec,delegate:dao})}var self=this;if(decorated)decorated.dao=dao;if(this.testData){var delegate=dao;dao=this.PromisedDAO.create({promise:new Promise(function(resolve,reject){delegate.select(self.COUNT()).then(function(c){if(c.value){resolve(delegate);return}self.log("Loading test data");Promise.all(foam.json.parse(self.testData,self.of,self).map(function(o){return delegate.put(o)})).then(function(){self.log("Loaded",self.testData.length,"records.");resolve(delegate)},reject)})})})}this.delegate=dao},{name:"addPropertyIndex",type:"foam.dao.EasyDAO",args:"foam.core.PropertyInfo... props",code:function addPropertyIndex(){this.mdao&&this.mdao.addPropertyIndex.apply(this.mdao,arguments);return this},},{name:"addDecorator",type:"Boolean",args:[{name:"decorator",},{name:"location",},{name:"before",class:"Boolean"}],},{name:"getDecorators",type:"String",},{name:"cmd_",args:[{name:"x",type:"Context"},{name:"obj",type:"Object"}],type:"Object",code:function cmd_(x,obj){return this.delegate.cmd_(x,obj)},},{name:"append",args:"StringBuilder sb",}]});
foam.CLASS({package:"foam.dao",name:"NoSelectAllDAO",extends:"foam.dao.ProxyDAO",requires:["foam.dao.ArraySink","foam.mlang.predicate.True","foam.mlang.predicate.False"],methods:[function select_(x,sink,skip,limit,order,predicate){const simplePredicate=predicate?.partialEval();if(simplePredicate&&(!this.True.isInstance(simplePredicate)&&!this.False.isInstance(simplePredicate))||foam.Number.isInstance(limit)&&Number.isFinite(limit)&&limit!=0||foam.Number.isInstance(skip)&&Number.isFinite(skip)&&skip!=0){return this.delegate.select_(x,sink,skip,limit,order,simplePredicate)}else{sink&&sink.eof();return Promise.resolve(sink||this.ArraySink.create())}}]});
foam.CLASS({package:"foam.dao",name:"NullDAO",extends:"foam.dao.AbstractDAO",axioms:[{buildJavaClass:function(cls){cls.extras.push(`
public NullDAO(foam.core.X x, foam.core.ClassInfo of) {
setX(x);
setOf(of);
}
`)}}],methods:[{name:"put_",code:function put_(x,obj){this.pub("on","put",obj);return Promise.resolve(obj)},},{name:"remove_",code:function remove_(x,obj){this.pub("on","remove",obj);return Promise.resolve()},},{name:"find_",code:function find_(x,id){return Promise.resolve(null)},},{name:"select_",code:function select_(x,sink,skip,limit,order,predicate){sink=sink||foam.dao.ArraySink.create();sink.eof();return Promise.resolve(sink)},},{name:"removeAll_",code:function removeAll_(x,skip,limit,order,predicate){return Promise.resolve()},}]});
foam.CLASS({package:"foam.dao",name:"TimingDAO",extends:"foam.dao.ProxyDAO",properties:["name",{name:"id",value:0},["activeOps",{put:0,remove:0,find:0,select:0}],{class:"Function",name:"now",factory:function(){if(globalThis.window&&globalThis.window.performance){return function(){return globalThis.performance.now()}}else if(globalThis.process&&globalThis.process.hrtime){return function(){var hr=globalThis.process.hrtime();return hr[0]*1e3+hr[1]/1e6}}else{return function(){return Date.now()}}}}],methods:[function start(op){var str=this.name+"-"+op;var key=this.activeOps[op]++?str+"-"+this.id++:str;console.time(key);return[key,str,this.now(),op]},function end(act){this.activeOps[act[3]]--;this.id--;console.timeEnd(act[0]);console.log("Timing: ",act[1]," ",(this.now()-act[2]).toFixed(3)," ms")},function put_(x,obj){var act=this.start("put");var self=this;return this.SUPER(x,obj).then(function(o){self.end(act);return o})},function remove_(x,obj){var act=this.start("remove");var self=this;return this.SUPER(x,obj).then(function(){self.end(act)})},function find_(x,key){var act=this.start("find");var self=this;return this.SUPER(x,key).then(function(o){self.end(act);return o})},function select(){var act=this.start("select");var self=this;return this.SUPER.apply(this,arguments).then(function(s){self.end(act);return s})}]});
foam.CLASS({package:"foam.dao",name:"LoggingDAO",extends:"foam.dao.ProxyDAO",requires:["foam.dao.ArraySink"],properties:[{name:"name"},{name:"logger",expression:function(name){return console.log.bind(console,name)}},{class:"Boolean",name:"logReads",value:false}],methods:[function put_(x,obj){this.logger("put",obj);return this.SUPER(x,obj)},function remove_(x,obj){this.logger("remove",obj);return this.SUPER(x,obj)},function select_(x,sink,skip,limit,order,predicate){this.logger("select","skip",skip,"limit",limit,"order",order&&order.toString(),"predicate",predicate&&predicate.toString());sink=sink||this.ArraySink.create();if(this.logReads){var put=sink.put.bind(sink);var newSink={__proto__:sink};newSink.put=function(o){this.logger("read",foam.json.objectify(o));return put.apply(null,arguments)}.bind(this);return this.SUPER(x,newSink,skip,limit,order,predicate).then(function(){return sink})}return this.SUPER(x,sink,skip,limit,order,predicate)},function removeAll_(x,sink,skip,limit,order,predicate){this.logger("removeAll",skip,limit,order,predicate);return this.SUPER(x,sink,skip,limit,order,predicate)},function find_(x,id){this.logger("find",id);return this.SUPER(x,id)}]});
foam.CLASS({package:"foam.dao",name:"IDBInternalException",extends:"foam.dao.InternalException",properties:["id","error",{name:"message",expression:function(id,error){return"IndexedDB Error for "+id+(error?": "+error.toString():"")}}]});
foam.CLASS({package:"foam.dao",name:"IDBDAO",extends:"foam.dao.AbstractDAO",requires:["foam.dao.ArraySink","foam.dao.IDBInternalException","foam.mlang.predicate.True","foam.mlang.predicate.Eq"],imports:["async"],properties:[{name:"of",required:true},{name:"name",label:"Store Name",factory:function(){return this.of.id}},{name:"indicies",factory:function(){return[]}},{name:"version",value:1},{name:"withDB",factory:function(){var self=this;return new Promise(function(resolve,reject){var indexedDB=globalThis.indexedDB||globalThis.webkitIndexedDB||globalThis.mozIndexedDB;var request=indexedDB.open("FOAM:"+self.name,self.version);request.onupgradeneeded=function(e){var db=e.target.result;if(db.objectStoreNames.contains(self.name)){db.deleteObjectStore(self.name)}var store=e.target.result.createObjectStore(self.name);for(var i=0;i<self.indicies.length;i++){store.createIndex(self.indicies[i][0],self.indicies[i][0],{unique:self.indicies[i][1]})}};request.onsuccess=function(e){resolve(e.target.result)};request.onerror=function(e){reject(self.IDBInternalException.create({id:"open",error:e}))}})}}],methods:[function deserialize(json){return foam.json.parse(json,this.of,this.__subContext__)},function serialize(obj){return foam.json.Storage.objectify(obj)},function serializeId(id){return this.of.ID.toJSON(id)},function withStore(mode,fn){return this.withStore_(mode,fn);if(mode!=="readwrite")return this.withStore_(mode,fn);var self=this;if(!this.q_){var q=[fn];this.q_=q;this.async(function(){self.withStore_(mode,function(store){if(self.q_==q)self.q_=undefined;for(var i=0;i<q.length;i++)q[i](store)})})()}else{this.q_.push(fn);if(this.q_.length==1e4)this.q_=undefined}},function withStore_(mode,fn){var self=this;self.withDB.then(function(db){var tx=db.transaction([self.name],mode);var os=tx.objectStore(self.name);fn.call(self,os)})},function put_(x,value){var self=this;return new Promise(function(resolve,reject){self.withStore("readwrite",function(store){var request=store.put(self.serialize(value),self.serializeId(value.id));request.transaction.addEventListener("complete",function(e){self.pub("on","put",value);resolve(value)});request.transaction.addEventListener("error",function(e){reject(self.IDBInternalException.create({id:value.id,error:e}))})})})},function find_(x,obj){var self=this;var key=this.serializeId(obj.id!==undefined?obj.id:obj);return new Promise(function(resolve,reject){self.withStore("readwrite",function(store){var request=store.get(key);request.transaction.addEventListener("complete",function(){if(!request.result){resolve(null);return}var result=self.deserialize(request.result);resolve(result)});request.onerror=function(e){reject(self.IDBInternalException.create({id:key,error:e}))}})})},function remove_(x,obj){var self=this;var key=this.serializeId(obj.id!==undefined?obj.id:obj);return new Promise(function(resolve,reject){self.withStore("readwrite",function(store){var getRequest=store.get(key);getRequest.onsuccess=function(e){if(!getRequest.result){resolve();return}var data=self.deserialize(getRequest.result);var delRequest=store.delete(key);delRequest.transaction.addEventListener("complete",function(e){self.pub("on","remove",data);resolve()});delRequest.onerror=function(e){reject(self.IDBInternalException.create({id:key,error:e}))}};getRequest.onerror=function(e){reject(self.IDBInternalException.create({id:key,error:e}))}})})},function removeAll_(x,skip,limit,order,predicate){var query=predicate||this.True.create();var self=this;if(!predicate&&!self.hasListeners("on","remove")){return new Promise(function(resolve,reject){self.withStore("readwrite",function(store){var req=store.clear();req.onsuccess=function(){resolve()};req.onerror=function(e){reject(self.IDBInternalException.create({id:"remove_all",error:e}))}})})}return new Promise(function(resolve,reject){self.withStore("readwrite",function(store){var request=store.openCursor();request.onsuccess=function(e){var cursor=e.target.result;if(cursor){var value=self.deserialize(cursor.value);if(query.f(value)){var deleteReq=cursor.delete();deleteReq.addEventListener("success",function(){self.pub("on","remove",value)});deleteReq.onerror=function(e){}}cursor.continue()}};request.transaction.addEventListener("complete",function(){resolve()});request.onerror=function(e){reject(self.IDBInternalException.create({id:"remove_all",error:e}))}})})},function select_(x,sink,skip,limit,order,predicate){var resultSink=sink||this.ArraySink.create();sink=this.decorateSink_(resultSink,skip,limit,order,predicate);var sub=foam.core.FObject.create();var detached=false;sub.onDetach(function(){detached=true});var self=this;return new Promise(function(resolve,reject){self.withStore("readwrite",function(store){var useIndex=predicate&&this.Eq.isInstance(predicate)&&store.indexNames.contains(predicate.arg1.name);var request=useIndex?store.index(predicate.arg1.name).openCursor(IDBKeyRange.only(predicate.arg2.f())):store.openCursor();request.onsuccess=function(e){var cursor=e.target.result;if(e.target.error){reject(e.target.error);return}if(!cursor||detached){sink.eof&&sink.eof();resolve(resultSink);return}var value=self.deserialize(cursor.value);sink.put(value,sub);cursor.continue()};request.onerror=function(e){reject(self.IDBInternalException.create({id:"select",error:e}))}})})},function addIndex(prop){this.indicies.push([prop.name,false]);return this}]});foam.ENUM({package:"foam.dao",name:"IDBMutationType",values:[{name:"PUT",label:"put"},{name:"REMOVE",label:"remove"}]});
foam.CLASS({package:"foam.dao",name:"IDBMutation",properties:[{class:"Enum",of:"foam.dao.IDBMutationType",name:"type"},{name:"data"},{class:"Function",name:"resolve"},{class:"Function",name:"reject"}]});
foam.CLASS({package:"foam.dao",name:"BatchMutationIDBDAO",extends:"foam.dao.IDBDAO",requires:["foam.dao.IDBMutation","foam.dao.IDBMutationType"],properties:[{class:"Int",name:"batchSize",value:1e3},{class:"Int",name:"numBatches",value:1},{class:"FObjectArray",of:"foam.dao.IDBMutation",name:"mutations_"},{class:"Int",name:"numActiveTransactions_"}],methods:[function put_(x,o){var self=this;return new Promise(function(resolve,reject){self.mutations_.push(self.IDBMutation.create({type:self.IDBMutationType.PUT,data:o,resolve:function(result){self.pub("on","put",result);resolve(result)},reject:reject}));self.onBatchedOperation()})},function remove_(x,o){var self=this;return new Promise(function(resolve,reject){self.mutations_.push(self.IDBMutation.create({type:self.IDBMutationType.REMOVE,data:o,resolve:function(didRemove){if(didRemove)self.pub("on","remove",o);resolve(o)},reject:reject}));self.onBatchedOperation()})},function beginBatchTransaction(){if(this.mutations_.length===0)return Promise.resolve();var mutations=this.mutations_.slice(0,this.batchSize);this.mutations_=this.mutations_.slice(this.batchSize);this.numActiveTransactions_++;var deletes=[];for(var i=0;i<mutations.length;i++){if(mutations[i].type===this.IDBMutationType.REMOVE)deletes.push(mutations[i])}if(deletes.length===0)return this.onGatheredDeletes(mutations,[]).then(this.onTransactionComplete).catch(this.onTransactionError);var promises=new Array(deletes.length);for(var i=0;i<deletes.length;i++){promises[i]=this.find(deletes[i])}return Promise.all(promises).then(this.onGatheredDeletes.bind(this,mutations)).then(this.onTransactionComplete).catch(this.onTransactionError)}],listeners:[{name:"onBatchedOperation",isMerged:true,mergeDelay:150,code:function(){foam.assert(this.mutations_.length>0,"BatchedMutationIDBDAO: Attempt to batch no operations");var promises=[];for(var i=this.numActiveTransactions_;i<this.numBatches;i++){this.beginBatchTransaction()}return Promise.all(promises)}},function onGatheredDeletes(mutations,deletesFound){var self=this;return new Promise(function(resolve,reject){self.withStore("readwrite",function(store){var deletesI=0;for(var i=0;i<mutations.length;i++){var mutation=mutations[i];var obj=mutation.data;var request;if(mutation.type===self.IDBMutationType.PUT){request=store.put(self.serialize(obj),self.serializeId(obj.id))}else{if(deletesFound[deletesI]===null){deletesI++;continue}request=store.delete(this.serializeId(obj.id!==undefined?obj.id:obj));deletesI++}}request.transaction.addEventListener("complete",function(){var deletesI=0;for(var i=0;i<mutations.length;i++){var mutation=mutations[i];if(mutation.type===self.IDBMutationType.PUT){self.pub("on","put",mutation.data)}else{if(deletesFound[deletesI]!==null)self.pub("on","remove",mutation.data);deletesI++}mutation.resolve(mutation.data)}resolve()});request.transaction.addEventListener("error",function(error){for(var i=0;i<mutations.length;i++){mutations[i].reject(error)}reject(error)})})})},function onTransactionComplete(){this.numActiveTransactions_--},function onTransactionError(){this.numActiveTransactions_--}]});
foam.CLASS({package:"foam.dao",name:"RestDAO",extends:"foam.dao.AbstractDAO",requires:["foam.core.Serializable","foam.dao.ArraySink","foam.json.Outputter","foam.net.HTTPRequest"],properties:[{class:"String",name:"baseURL",final:true,required:true},{class:"FObjectProperty",of:"foam.json.Outputter",name:"outputter",factory:function(){return this.Outputter.create({pretty:false,formatDatesAsNumbers:true,outputDefaultValues:false,strict:true,propertyPredicate:function(o,p){return!p.networkTransient}})}}],methods:[function put_(x,o){return this.createRequest_({method:"PUT",url:this.baseURL,payload:this.outputter.stringify(o)}).send().then(this.onResponse.bind(this,"put")).then(this.onPutResponse)},function remove_(x,o){return this.createRequest_({method:"DELETE",url:this.baseURL+"/"+encodeURIComponent(this.outputter.stringify(o.id))}).send().then(this.onResponse.bind(this,"remove")).then(this.onRemoveResponse)},function find_(x,key){var id=this.of.isInstance(key)?key.id:key;return this.createRequest_({method:"GET",url:this.baseURL+"/"+encodeURIComponent(this.outputter.stringify(id))}).send().then(this.onResponse.bind(this,"find")).then(this.onFindResponse)},function select_(x,sink,skip,limit,order,predicate){var payload={};var networkSink=this.Serializable.isInstance(sink)&&sink;if(networkSink)payload.sink=networkSink;if(typeof skip!=="undefined")payload.skip=skip;if(typeof limit!=="undefined")payload.limit=limit;if(typeof order!=="undefined")payload.order=order;if(typeof predicate!=="undefined")payload.predicate=predicate;return this.createRequest_({method:"POST",url:this.baseURL+":select",payload:this.outputter.stringify(payload)}).send().then(this.onResponse.bind(this,"select")).then(this.onSelectResponse.bind(this,sink||this.ArraySink.create()))},function removeAll_(x,skip,limit,order,predicate){var payload={};if(typeof skip!=="undefined")payload.skip=skip;if(typeof limit!=="undefined")payload.limit=limit;if(typeof order!=="undefined")payload.order=order;if(typeof predicate!=="undefined")payload.predicate=predicate;return this.createRequest_({method:"POST",url:this.baseURL+":removeAll",payload:this.outputter.stringify(payload)}).send().then(this.onResponse.bind(this,"removeAll")).then(this.onRemoveAllResponse)},function createRequest_(o){this.validate();return this.HTTPRequest.create(Object.assign({responseType:"json"},o))}],listeners:[function onResponse(name,response){if(response.status!==200){throw new Error("Unexpected "+name+" response code from REST DAO endpoint: "+response.status)}return response.payload},function onPutResponse(payload){var o=foam.json.parse(payload);this.pub("on","put",o);return o},function onRemoveResponse(payload){var o=foam.json.parse(payload);if(o!==null)this.pub("on","remove",o);return o},function onFindResponse(payload){return foam.json.parse(payload)},function onSelectResponse(localSink,payload){var wasSerializable=this.Serializable.isInstance(localSink);var remoteSink=foam.json.parse(payload);if(wasSerializable)return remoteSink;var array=remoteSink.array;if(!array)throw new Error("Expected ArraySink from REST endpoint when proxying local sink");if(localSink.put){var sub=foam.core.FObject.create();var detached=false;sub.onDetach(function(){detached=true});for(var i=0;i<array.length;i++){localSink.put(array[i],sub);if(detached)break}}if(localSink.eof)localSink.eof();return localSink},function onRemoveAllResponse(payload){return undefined}]});
foam.CLASS({package:"foam.dao",name:"EnabledAwareDAO",extends:"foam.dao.FilteredDAO",implements:["foam.mlang.Expressions"],properties:[{class:"FObjectProperty",of:"foam.mlang.predicate.Predicate",name:"predicate",factory:function(){return this.EQ(this.of.ENABLED,true)},}]});
foam.CLASS({package:"foam.dao",name:"EnabledAwareDAOTest",extends:"foam.nanos.test.Test",methods:[{name:"runTest",},{name:"setUp",args:[{type:"Context",name:"x"}],},{name:"EnabledAwareDAOTest_find_disabled_returns_null",},{name:"EnabledAwareDAOTest_select_do_not_include_disabled",}],});
foam.CLASS({package:"foam.dao",name:"ValidationDAODecorator",extends:"foam.dao.AbstractDAODecorator",methods:[function write(X,dao,obj,existing){if(obj.errors_){return Promise.reject(foam.dao.ValidationException.create({errors:obj.errors_}))}return Promise.resolve(obj)}]});
foam.CLASS({package:"foam.dao",name:"ValidationException",extends:"foam.dao.ExternalException",properties:["errors",{name:"message",expression:function(errors){return errors.join(", ")}}]});
foam.CLASS({package:"foam.dao",name:"ResetDAODecorator",extends:"foam.dao.ProxyDAO",properties:[{class:"String",name:"daoKey"}],methods:[{name:"put_",code:function(x,obj){return this.delegate.put_(x,obj).then(obj=>{if(this.daoKey){var dao=this.__subContext__[this.daoKey];dao.cmd(foam.dao.DAO.PURGE_CMD);dao.cmd(foam.dao.DAO.RESET_CMD)}return obj})}}]});
foam.CLASS({package:"foam.dao",name:"SQLException",extends:"foam.core.Exception"});
foam.CLASS({package:"foam.dao",name:"AbstractPredicateSQLValueRefinement",refines:"foam.mlang.predicate.AbstractPredicate",requires:["foam.dao.SQLException"],methods:[function sqlValue(argName){var arg=this[argName];var v=arg&&arg.toSQL?arg.toSQL():arg&&arg.toString?arg.toString():arg;if(v===undefined||v===null)throw this.SQLException.create({message:this.cls_.name+"."+argName+": "+v});return v}]});
foam.CLASS({package:"foam.dao",name:"ConstantToSQLRefinement",refines:"foam.mlang.Constant",methods:[function toSQL(){if(isNaN(this.value)){var v=this.value.toString().toLowerCase();if(v==="true"||v==="yes")return 1;if(v==="false"||v==="no")return 0;return this.value.toString()}if(this.value===true)return 1;if(this.value===false)return 0;return this.value}]});
foam.CLASS({package:"foam.dao",name:"TrueToSQLRefinement",refines:"foam.mlang.predicate.True",methods:[function toSQL(){return"( 1 = 1 )"}]});
foam.CLASS({package:"foam.dao",name:"FalseToSQLRefinement",refines:"foam.mlang.predicate.False",methods:[function toSQL(){return"( 1 <> 1 )"}]});
foam.CLASS({package:"foam.dao",name:"UnaryToSQLRefinement",refines:"foam.mlang.predicate.Unary",methods:[function toSQL(){throw this.SQLException.create({message:this.cls_.name+".toSQL() not implemented"})}]});
foam.CLASS({package:"foam.dao",name:"BinaryToSQLRefinement",refines:"foam.mlang.predicate.Binary",methods:[function toSQL(){throw this.SQLException.create({message:this.cls_.name+".toSQL() not implemented"})}]});
foam.CLASS({package:"foam.dao",name:"HasToSQLRefinement",refines:"foam.mlang.predicate.Has",methods:[function toSQL(){return this.sqlValue("arg1")+" IS NOT NULL"}]});
foam.CLASS({package:"foam.dao",name:"NotToSQLRefinement",refines:"foam.mlang.predicate.Not",methods:[function toSQL(){return"NOT ("+this.arg1.toSQL()+")"}]});
foam.CLASS({package:"foam.dao",name:"EqToSQLRefinement",refines:"foam.mlang.predicate.Eq",methods:[function toSQL(){return this.arg2===null?this.sqlValue("arg1")+" IS NULL":this.sqlValue("arg1")+" = "+this.sqlValue("arg2")}]});
foam.CLASS({package:"foam.dao",name:"NeqToSQLRefinement",refines:"foam.mlang.predicate.Neq",methods:[function toSQL(){return this.arg2===null?this.sqlValue("arg1")+" IS NOT NULL":this.sqlValue("arg1")+" <> "+this.sqlValue("arg2")}]});
foam.CLASS({package:"foam.dao",name:"GtToSQLRefinement",refines:"foam.mlang.predicate.Gt",methods:[function toSQL(){return this.sqlValue("arg1")+" > "+this.sqlValue("arg2")}]});
foam.CLASS({package:"foam.dao",name:"GteToSQLRefinement",refines:"foam.mlang.predicate.Gte",methods:[function toSQL(){return this.sqlValue("arg1")+" >= "+this.sqlValue("arg2")}]});
foam.CLASS({package:"foam.dao",name:"LtToSQLRefinement",refines:"foam.mlang.predicate.Lt",methods:[function toSQL(){return this.sqlValue("arg1")+" < "+this.sqlValue("arg2")}]});
foam.CLASS({package:"foam.dao",name:"LteToSQLRefinement",refines:"foam.mlang.predicate.Lte",methods:[function toSQL(){return this.sqlValue("arg1")+" <= "+this.sqlValue("arg2")}]});
foam.CLASS({package:"foam.dao",name:"AndToSQLRefinement",refines:"foam.mlang.predicate.And",methods:[function toSQL(){var s="";for(var i=0;i<this.args.length;i++){var a=this.args[i];s+=a.toSQL();if(i<this.args.length-1)s+=" AND "}return s}]});
foam.CLASS({package:"foam.dao",name:"OrToSQLRefinement",refines:"foam.mlang.predicate.Or",methods:[function toSQL(){var s=" ( ";for(var i=0;i<this.args.length;i++){var a=this.args[i];s+=a.toSQL();if(i<this.args.length-1)s+=" OR "}s+=" ) ";return s}]});
foam.CLASS({package:"foam.dao",name:"InToSQLRefinement",refines:"foam.mlang.predicate.In",methods:[function toSQL(){var s=this.sqlValue("arg1");s+=" IN ( '";if(Array.isArray(this.arg2)){s+=this.arg2.join("', '")}else{s+=this.sqlValue("arg2")}s+="')";return s}]});
foam.CLASS({package:"foam.dao",name:"DateToSQLRefinement",refines:"foam.core.Date",methods:[function toSQL(){var v1=this.value||0;return new Date(v1).toISOString()}]});
foam.CLASS({package:"foam.dao",name:"NoDisjunctionDAO",extends:"foam.dao.ProxyDAO",implements:["foam.mlang.Expressions"],requires:["foam.dao.DAOSink","foam.dao.MDAO","foam.mlang.Constant","foam.mlang.predicate.Eq","foam.mlang.predicate.Or"],methods:[function select_(x,sink,skip,limit,order,predicate){if(!predicate)return this.SUPER(x,sink,skip,limit,order,predicate);var newPredicate=this.inToOr_(predicate).toDisjunctiveNormalForm().partialEval();if(this.FALSE.equals(newPredicate)){sink.eof&&sink.eof();return Promise.resolve(sink)}if(this.TRUE.equals(newPredicate))newPredicate=undefined;if(!this.Or.isInstance(newPredicate))return this.SUPER(x,sink,skip,limit,order,newPredicate);var predicates=newPredicate.args;var dao=this.MDAO.create({of:this.of});var sharedSink=this.DAOSink.create({dao:dao});var promises=[];for(var i=0;i<predicates.length;i++){promises.push(this.SUPER(x,sharedSink,skip,limit,order,predicates[i]))}return Promise.all(promises).then(function(){return dao.select_(x,sink,skip,limit,order,predicate)})},{name:"inToOr_",code:foam.mmethod({"foam.mlang.predicate.In":function(predicate){foam.assert(this.Constant.isInstance(predicate.arg2),"NoDisjunctionDAO expects constant IN.arg2");var orArgs=[];var arg2=predicate.arg2.value;for(var i=0;i<arg2.length;i++){orArgs.push(this.Eq.create({arg1:predicate.arg1.clone(),arg2:arg2[i]},predicate))}return this.Or.create({args:orArgs},predicate)},"foam.mlang.predicate.Binary":function(predicate){return predicate.cls_.create({arg1:this.inToOr_(predicate.arg1),arg2:this.inToOr_(predicate.arg2)},predicate)},"foam.mlang.predicate.Nary":function(predicate){var oldArgs=predicate.args;var newArgs=new Array(oldArgs.length);for(var i=0;i<oldArgs.length;i++){newArgs[i]=this.inToOr_(oldArgs[i])}return predicate.cls_.create({args:newArgs})},"foam.mlang.predicate.AbstractPredicate":function(predicate){return predicate.clone()},"foam.mlang.AbstractExpr":function(expr){return expr.clone()},"foam.core.Property":function(property){return property}},function(predicate){throw new Error("Unrecognized predicate: "+(predicate&&predicate.cls_&&predicate.cls_.id))})}]});
foam.CLASS({package:"foam.dao",name:"NoNeqDAO",extends:"foam.dao.ProxyDAO",requires:["foam.mlang.predicate.Gt","foam.mlang.predicate.Lt","foam.mlang.predicate.Neq","foam.mlang.predicate.Or"],methods:[function select_(x,sink,skip,limit,order,predicate){if(!predicate)return this.SUPER(x,sink,skip,limit,order,predicate);return this.SUPER(x,sink,skip,limit,order,this.transformNeq_(predicate))},{name:"transformNeq_",code:foam.mmethod({"foam.mlang.predicate.Neq":function(predicate){return this.Or.create({args:[this.Lt.create({arg1:predicate.arg1,arg2:predicate.arg2}),this.Gt.create({arg1:predicate.arg1,arg2:predicate.arg2})]},predicate)},"foam.mlang.predicate.Binary":function(predicate){return predicate.cls_.create({arg1:this.transformNeq_(predicate.arg1),arg2:this.transformNeq_(predicate.arg2)},predicate)},"foam.mlang.predicate.Nary":function(predicate){var oldArgs=predicate.args;var newArgs=new Array(oldArgs.length);for(var i=0;i<oldArgs.length;i++){newArgs[i]=this.transformNeq_(oldArgs[i])}return predicate.cls_.create({args:newArgs})},"foam.mlang.predicate.AbstractPredicate":function(predicate){return predicate.clone()},"foam.mlang.AbstractExpr":function(expr){return expr.clone()},"foam.core.Property":function(property){return property}},function(predicate){throw new Error("Unrecognized predicate: "+(predicate&&predicate.cls_&&predicate.cls_.id))})}]});
foam.CLASS({package:"foam.dao",name:"FixedSizeDAO",extends:"foam.dao.ProxyDAO",properties:[{class:"FObjectProperty",of:"foam.mlang.order.Comparator",name:"comparator"},{class:"FObjectProperty",of:"foam.mlang.predicate.Predicate",name:"predicate"},{class:"Int",name:"size"},{class:"Long",name:"purgePercent",value:10}],methods:[{name:"put_",},{name:"cmd_",}]});
foam.CLASS({package:"foam.dao",name:"PutOnlyDAO",extends:"foam.dao.ProxyDAO",methods:[{name:"find_",code:function find_(x,obj){return Promise.reject("Cannot find from PutOnlyDAO")}},{name:"select_",code:function select_(x,obj){return Promise.reject("Cannot select from PutOnlyDAO")}},{name:"remove_",code:function remove_(){return Promise.reject("Cannot remove from PutOnlyDAO")}},{name:"cmd_",code:function cmd_(){return Promise.reject("Cannot cmd from PutOnlyDAO")}},{name:"removeAll",code:function removeAll_(){return Promise.reject("Cannot removeAll from PutOnlyDAO")}}]});
foam.CLASS({package:"foam.glang",name:"AbstractDateGlang",extends:"foam.mlang.AbstractExpr",abstract:true,requires:["foam.mlang.IdentityExpr"],implements:["foam.core.Serializable","foam.mlang.order.Comparator"],properties:[{class:"foam.mlang.ExprProperty",name:"delegate",factory:function(){return this.IdentityExpr.create()}}],methods:[{name:"createStatement",},{name:"prepareStatement",},{name:"compare",code:function(o1,o2){return foam.Date.compare(this.f(o1),this.f(o2))},}]});
foam.CLASS({package:"foam.glang",name:"EndOfTimeSpan",extends:"foam.glang.AbstractDateGlang",properties:[{class:"Long",name:"timeSpanMs"}],methods:[{name:"f",code:function(obj){var ts=new Date(this.delegate.f(obj));var ms=this.timeSpanMs;return new Date(Math.floor(ts.getTime()/ms)*ms+ms-1)},}]});
foam.CLASS({package:"foam.glang",name:"StartOfHour",extends:"foam.glang.AbstractDateGlang",flags:[],methods:[{name:"f",code:function(obj){var ts=new Date(this.delegate.f(obj));ts.setMinutes(0,0);return ts}}]});
foam.CLASS({package:"foam.glang",name:"EndOfHour",extends:"foam.glang.AbstractDateGlang",methods:[{name:"f",code:function(obj){var ts=new Date(this.delegate.f(obj));ts.setMinutes(59,59);ts.setMilliseconds(999);return ts},}]});
foam.CLASS({package:"foam.glang",name:"StartOfDay",extends:"foam.glang.AbstractDateGlang",flags:[],methods:[{name:"f",code:function(obj){var ts=new Date(this.delegate.f(obj));ts.setHours(0,0,0,0);return ts}}]});
foam.CLASS({package:"foam.glang",name:"EndOfDay",extends:"foam.glang.AbstractDateGlang",methods:[{name:"f",code:function(obj){var ts=new Date(this.delegate.f(obj));ts.setHours(23,59,59);ts.setMilliseconds(999);return ts},}]});
foam.CLASS({package:"foam.glang",name:"StartOfWeek",extends:"foam.glang.AbstractDateGlang",flags:[],properties:[{class:"Int",name:"startOfWeek",min:0,max:6,value:0}],methods:[{name:"f",code:function(obj){var ts=new Date(this.delegate.f(obj));ts.setDate(ts.getDate()-(ts.getDay()-this.startOfWeek+7)%7);ts.setHours(0,0,0,0);return ts}}]});
foam.CLASS({package:"foam.glang",name:"EndOfWeek",extends:"foam.glang.AbstractDateGlang",properties:[{class:"Int",name:"startOfWeek",min:0,max:6,value:0}],methods:[{name:"f",code:function(obj){var ts=new Date(this.delegate.f(obj));var date=ts.getDate();var endOfWeek=(this.startOfWeek+6)%7;var day=ts.getDay();var daysToEndOfWeek=(endOfWeek-day+7)%7;ts.setDate(date+daysToEndOfWeek);ts.setHours(23,59,59);ts.setMilliseconds(999);return ts},}]});
foam.CLASS({package:"foam.glang",name:"StartOfMonth",extends:"foam.glang.AbstractDateGlang",flags:[],methods:[{name:"f",code:function(obj){var ts=new Date(this.delegate.f(obj));ts.setMonth(ts.getMonth());ts.setDate(1);ts.setHours(0,0,0,0);return ts}}]});
foam.CLASS({package:"foam.glang",name:"EndOfMonth",extends:"foam.glang.AbstractDateGlang",methods:[{name:"f",code:function(obj){var ts=new Date(this.delegate.f(obj));ts.setMonth(ts.getMonth()+1);ts.setDate(0);ts.setHours(23,59,59);ts.setMilliseconds(999);return ts},}]});
foam.CLASS({package:"foam.glang",name:"StartOfQuarter",extends:"foam.glang.AbstractDateGlang",flags:[],methods:[{name:"f",code:function(obj){var ts=new Date(this.delegate.f(obj));ts.setMonth(Math.floor(ts.getMonth()/3)*3);ts.setDate(0);ts.setHours(0,0,0,0);return ts}}]});
foam.CLASS({package:"foam.glang",name:"EndOfQuarter",extends:"foam.glang.AbstractDateGlang",methods:[{name:"f",code:function(obj){var ts=new Date(this.delegate.f(obj));ts.setMonth(ts.getMonth()+3-ts.getMonth()%3);ts.setDate(0);ts.setHours(23,59,59);ts.setMilliseconds(999);return ts},}]});
foam.CLASS({package:"foam.glang",name:"StartOfYear",extends:"foam.glang.AbstractDateGlang",flags:[],methods:[{name:"f",code:function(obj){var ts=new Date(this.delegate.f(obj));ts.setMonth(0);ts.setDate(1);ts.setHours(0,0,0,0);return ts}}]});
foam.CLASS({package:"foam.glang",name:"EndOfYear",extends:"foam.glang.AbstractDateGlang",methods:[{name:"f",code:function(obj){var ts=new Date(this.delegate.f(obj));ts.setMonth(11);ts.setDate(31);ts.setHours(23,59,59);ts.setMilliseconds(999);return ts},}]});
foam.CLASS({package:"foam.parse",name:"PropertySearchableRefinements",refines:"foam.core.Property",properties:[{name:"searchable",expression:function(transient){return!transient}}]});
foam.CLASS({package:"foam.parse",name:"QueryParser",axioms:[foam.pattern.Multiton.create({property:"of"})],requires:["foam.mlang.Constant","foam.mlang.predicate.And","foam.mlang.predicate.ContainsIC","foam.mlang.predicate.DotF","foam.mlang.predicate.Eq","foam.mlang.predicate.Gt","foam.mlang.predicate.Gte","foam.mlang.predicate.Has","foam.mlang.predicate.In","foam.mlang.predicate.InIC","foam.mlang.predicate.Lt","foam.mlang.predicate.Lte","foam.mlang.predicate.MQLExpr","foam.mlang.predicate.Not","foam.mlang.predicate.Or","foam.mlang.predicate.True","foam.parse.Alternate","foam.parse.ImperativeGrammar","foam.parse.LiteralIC","foam.parse.Parsers","foam.parse.StringPStream"],properties:[{class:"Class",name:"of"},{class:"String",name:"me"},{name:"baseGrammar_",value:function(alt,anyChar,eof,join,literal,literalIC,not,notChars,optional,range,repeat,repeat0,seq,seq1,str,sym,until){return{START:seq1(0,sym("query"),repeat0(" "),eof()),query:sym("or"),or:repeat(sym("and"),alt(literalIC(" OR "),literal(" | ")),1),and:repeat(sym("expr"),alt(literalIC(" AND "),literal(" ")),1),expr:alt(sym("paren"),sym("negate"),sym("has"),sym("is"),sym("dot"),sym("equals"),sym("before"),sym("after"),sym("id")),paren:seq1(1,"(",sym("query"),")"),negate:alt(seq(literal("-"),sym("expr")),seq(literalIC("NOT "),sym("expr"))),id:sym("number"),has:seq(literalIC("has:"),sym("fieldname")),is:seq(literalIC("is:"),sym("fieldname")),dot:seq(sym("fieldname"),sym("subQuery")),subQuery:alt(sym("compoundSubQuery"),sym("simpleSubQuery")),compoundSubQuery:seq1(1,"(",sym("compoundSubQueryBody"),")"),compoundSubQueryBody:repeat(alt(seq("(",sym("compoundSubQueryBody"),")"),join(seq('"',join(repeat(alt(literal('\\"','"'),notChars('"')))),'"')),notChars(")"))),simpleSubQuery:seq1(1,".",repeat(not(alt(" ",eof()),anyChar()))),equals:seq(sym("fieldname"),alt(":","="),sym("valueList")),before:seq(sym("fieldname"),alt("<=","<",literalIC("-before:")),sym("value")),after:seq(sym("fieldname"),alt(">=",">",literalIC("-after:")),sym("value")),value:alt(sym("me"),sym("date"),sym("string"),sym("number")),compoundValue:alt(sym("negateValue"),sym("orValue"),sym("andValue")),negateValue:seq("(",alt("-",literalIC("not ")),sym("value"),")"),orValue:seq("(",repeat(sym("value"),alt("|",literalIC(" or ")," | "),1),")"),andValue:seq("(",repeat(sym("value"),alt(literalIC(" and ")," "),1),")"),valueList:alt(sym("compoundValue"),repeat(sym("value"),",",1)),me:seq(literalIC("me"),not(sym("char"))),date:alt(sym("range date"),sym("literal date"),sym("relative date")),"range date":seq(alt(sym("literal date"),sym("number")),"..",alt(sym("literal date"),sym("number"))),"literal date":alt(seq(sym("number"),"-",sym("number"),"-",sym("number"),"T",sym("number"),":",sym("number")),seq(sym("number"),"-",sym("number"),"-",sym("number"),"T",sym("number")),seq(sym("number"),"-",sym("number"),"-",sym("number")),seq(sym("number"),"-",sym("number")),seq(sym("number"),"/",sym("number"),"/",sym("number"))),"relative date":seq(literalIC("today"),optional(seq("-",sym("number")))),string:alt(sym("word"),sym("quoted string")),"quoted string":seq1(1,'"',repeat(alt(literal('\\"','"'),notChars('"'))),'"'),word:repeat(sym("char"),null,1),char:alt(range("a","z"),range("A","Z"),range("0","9"),"-","^","_","@","%","."),number:repeat(range("0","9"),null,1)}}},{name:"grammar_",factory:function(){var cls=this.of;var fields=[];var properties=cls.getAxiomsByClass(foam.core.Property);for(var i=0;i<properties.length;i++){var prop=properties[i];if(!prop.searchable)continue;fields.push(this.LiteralIC.create({s:prop.name,value:prop}));if(prop.shortName){fields.push(this.LiteralIC.create({s:prop.shortName,value:prop}))}if(prop.aliases){for(var j=0;j<prop.aliases.length;j++){fields.push(this.LiteralIC.create({s:prop.aliases[j],value:prop}))}}}fields.sort(function(a,b){var d=b.length-a.length;if(d!==0)return d;if(a.lower===b.lower)return 0;return a.lower<b.lower?1:-1});var base=foam.Function.withArgs(this.baseGrammar_,this.Parsers.create(),this);var grammar={__proto__:base,fieldname:this.Alternate.create({args:fields})};var maybeConvertYearToDateRange=function(prop,num){var isDateField=foam.core.Date.isInstance(prop)||foam.core.Date.isInstance(prop);var isDateRange=Array.isArray(num)&&num[0]instanceof Date;if(isDateField&&!isDateRange){var start=new Date(0);var end=new Date(0);start.setUTCFullYear(+num);end.setUTCFullYear(+num+1);return[start,end]}return num};var compactToString=function(v){return v.join("")};var self=this;var actions={id:function(v){return self.Eq.create({arg1:cls.ID,arg2:v})},or:function(v){return self.Or.create({args:v})},and:function(v){return self.And.create({args:v})},negate:function(v){return self.Not.create({arg1:v[1]})},number:function(v){return parseInt(compactToString(v))},me:function(){return self.me||""},has:function(v){return self.Has.create({arg1:v[1]})},is:function(v){return self.Eq.create({arg1:v[1],arg2:true})},dot:function(v){return self.DotF.create({arg1:self.Constant.create({value:v[1]}),arg2:v[0]})},simpleSubQuery:function(v){return self.MQLExpr.create({query:v.join("")})},compoundSubQuery:function(v){return self.MQLExpr.create({query:v})},compoundSubQueryBody:function(v){return v.map(s=>foam.String.isInstance(s)?s:s.join("")).join("")},before:function(v){v[2]=maybeConvertYearToDateRange(v[0],v[2]);if(Array.isArray(v[2])&&v[2][0]instanceof Date){v[2]=v[1]==="<="?v[2][1]:v[2][0]}return(v[1]==="<="?self.Lte:self.Lt).create({arg1:v[0],arg2:v[2]})},after:function(v){v[2]=maybeConvertYearToDateRange(v[0],v[2]);if(Array.isArray(v[2])&&v[2][0]instanceof Date){v[2]=v[1]===">="?v[2][0]:v[2][1]}return(v[1]===">="?self.Gte:self.Gt).create({arg1:v[0],arg2:v[2]})},equals:function(v){var prop=v[0];var values=v[2];var isNum=foam.core.Int.isInstance(prop)||foam.core.Reference.isInstance(prop)&&foam.core.Int.isInstance(prop.of.ID);var isFloat=foam.core.Float.isInstance(prop);var isDateField=foam.core.Date.isInstance(prop)||foam.core.DateTime.isInstance(prop);var isDateRange=Array.isArray(values[0])&&values[0][0]instanceof Date;if(isDateField||isDateRange){if(!isDateRange){var start=new Date(0);var end=new Date(0);start.setUTCFullYear(values[0]);end.setUTCFullYear(+values[0]+1);values=[[start,end]]}return self.And.create({args:[self.Gte.create({arg1:prop,arg2:values[0][0]}),self.Lt.create({arg1:prop,arg2:values[0][1]})]})}var expr;if(isNum){for(var i=0;i<values.length;i++){values[i]=isFloat?parseFloat(values[i]):parseInt(values[i])}expr=self.In.create({arg1:prop,arg2:values})}else if(foam.core.Enum.isInstance(prop)){var newValues=[];var e=prop.of;for(var i=0;i<values.length;i++){var value=values[i];for(var j=0;j<e.VALUES.length;j++){var eValue=e.VALUES[j];if(foam.String.startsWithIC(eValue.name,value)||foam.String.startsWithIC(eValue.label,value))newValues.push(eValue)}}expr=self.In.create({arg1:prop,arg2:newValues})}else{expr=v[1]==="="?self.Eq.create({arg1:prop,arg2:values[0]}):self.Or.create({args:values.map(function(v){return self.ContainsIC.create({arg1:prop,arg2:v})})})}if(values.negated)return self.Not.create({arg1:expr});if(values.and){return self.And.create({args:values.map(function(x){expr.class_.create({arg1:expr.arg1,arg2:[x]})})})}return expr},negateValue:function(v){v.negated=true;return v},orValue:function(v){v=v[1];v.or=true;return v},andValue:function(v){v=v[1];v.and=true;return v},"literal date":function(v){var start;var end;start=new Date(2e3,0,1);end=new Date(2e3,0,1);var ops=["FullYear","Month","Date","Hours","Minutes","Seconds"];var defaults=[0,1,1,0,0,0];for(var i=0;i<ops.length;i++){var x=i*2>v.length?defaults[i]:v[i*2];var val=x-(i===1?1:0);start["setUTC"+ops[i]](val);end["setUTC"+ops[i]](val)}start.setUTCMilliseconds(0);end.setUTCMilliseconds(0);var last=Math.floor(v.length/2);var op="UTC"+ops[last];end["set"+op](end["get"+op]()+1);return[start,end]},"relative date":function(v){var d=new Date;var year=d.getFullYear();var month=d.getMonth();var date=d.getDate();if(v[1])date-=v[1][1];return actions["literal date"]([year,"-",month+1,"-",date])},"range date":function(v){var start=Array.isArray(v[0])?v[0][0]:typeof v[0]==="number"?new Date(v[0],0,1):v[0];var end=Array.isArray(v[2])?v[2][1]:typeof v[2]==="number"?new Date(+v[2]+1,0,1):v[2];return[start,end]},"quoted string":compactToString,word:compactToString};var g=this.ImperativeGrammar.create({symbols:grammar});g.addActions(actions);return g}}],methods:[function parseString(str,opt_name){var query=this.grammar_.parseString(str,opt_name);query=query&&query.partialEval?query.partialEval():query;return query}]});
foam.CLASS({package:"foam.parse",name:"PropertyAliasesRefinement",refines:"foam.core.Property",properties:[{class:"StringArray",name:"aliases"}]});
foam.CLASS({package:"foam.parse",name:"Test",properties:[{class:"Int",name:"id"},{class:"String",name:"firstName"},{class:"String",name:"lastName"},{class:"FObjectProperty",of:"foam.nanos.auth.Address",name:"address"}]});
foam.CLASS({package:"foam.parse",name:"Address",properties:["city","province"]});
foam.CLASS({package:"foam.parse",name:"FScriptParser",static:[function test__(){var fs=foam.parse.FScriptParser.create({of:foam.parse.Test});var data=foam.parse.Test.create({id:42,firstName:"Kevin",lastName:"Greer",address:{city:"Toronto",regionId:"ON"}});function test(s){try{var p=fs.parseString(s).partialEval();console.log(s,"->",p.toString(),"=",p.f(data))}catch(x){console.log("ERROR: ",x)}}function testFormula(s,val){try{var p=fs.parseString(s);console.log(s,"==",val,"=",p.f(data)==val)}catch(x){console.log("ERROR: ",x)}}test('address.city=="Toronto"');test("address.city==address.regionId");test("address.city == address.regionId");test("address.city!=address.regionId");test("id==42");test('"Kevin"=="Kevin"');test('firstName=="Kevin"');test("firstName.len==2+3");test("firstName.len==2*3");test('firstName=="Kevin"&&lastName=="Greer"');test('firstName=="Kevin"||id==42');test("address instanceof foam.nanos.auth.Address");test("instanceof foam.parse.Test");testFormula("2+8",10)},function test2__(){var fs=foam.parse.FScriptParser.create({of:foam.util.Timer});function test(s){try{var p=fs.parseString(s);console.log(p.cls_.name,p.partialEval().toString())}catch(x){console.log("ERROR: ",x)}}test('address.city=="Toronto"');test("address.city==address.province");test("id==42");test('"Kevin"=="Kevin"');test('firstName=="Kevin"');test('firstName=="Kevin"&&lastName=="Greer"');test('firstName=="Kevin"||id==42')}],mixins:["foam.mlang.Expressions"],requires:["foam.mlang.predicate.NamedProperty","foam.parse.Alternate","foam.parse.ImperativeGrammar","foam.parse.Literal","foam.parse.Parsers","foam.parse.StringPStream"],axioms:[foam.pattern.Multiton.create({property:"thisValue"})],properties:["thisValue",{class:"Class",name:"of"},{name:"baseGrammar_",value:function(alt,anyChar,eof,join,literal,literalIC,not,notChars,optional,range,repeat,repeat0,seq,seq1,str,sym,until){var self=this;return{START:sym("expr"),expr:alt(sym("or"),sym("formula")),or:repeat(sym("and"),seq1(optional(" "),literal("||"),optional(" ")),1),and:repeat(sym("simpleexpr"),seq1(optional(" "),literal("&&"),optional(" ")),1),simpleexpr:alt(sym("paren"),sym("negate"),sym("instance_of"),sym("unary"),sym("comparison")),paren:seq1(1,"(",sym("expr"),")"),negate:seq(literal("!"),sym("expr")),comparison:seq(sym("value"),optional(" "),alt(literal("==",this.EQ),literal("!=",this.NEQ),literal("<=",this.LTE),literal(">=",this.GTE),literal("<",this.LT),literal(">",this.GT),literal("~",this.REG_EXP)),optional(" "),sym("value")),unary:seq(sym("value"),repeat0(" "),alt(literal("exists",this.HAS),literal("!exists",function(arg){return self.NOT(self.HAS(arg))}),literal("isValid",this.IS_VALID))),value:alt(sym("regex"),sym("string"),sym("date"),literal("true",true),literal("false",false),literal("null",null),sym("formula"),sym("number"),sym("fieldLen"),sym("field"),sym("enum")),formula:repeat(sym("minus"),literal("+"),1),minus:repeat(sym("form_expr"),literal("-"),1),form_expr:seq(alt(sym("number"),sym("field"),sym("fieldLen")),optional(repeat(seq(alt(literal("*",this.MUL),literal("/",this.DIV)),alt(sym("number"),sym("fieldLen"),sym("field")))))),date:alt(seq(sym("number"),"-",sym("number"),"-",sym("number"),"T",sym("number"),":",sym("number")),seq(sym("number"),"-",sym("number"),"-",sym("number"),"T",sym("number")),seq(sym("number"),"-",sym("number"),"-",sym("number")),seq(sym("number"),"-",sym("number"))),regex:seq1(1,"/",str(repeat(alt("\\/",notChars("/")))),"/"),fieldLen:seq(sym("field"),".len"),field:seq(sym("fieldname"),optional(seq1(1,literal("."),repeat(not(literal("len"),sym("word")),".",1)))),enum:str(seq(sym("word"),repeat(str(seq(literal("."),sym("word")))))),string:str(seq1(1,'"',repeat(alt(literal('\\"','"'),notChars('"'))),'"')),word:str(repeat(sym("char"),null,1)),char:alt(range("a","z"),range("A","Z"),range("0","9"),"-","^","_","@","%"),class_info:seq(sym("word"),repeat(seq(".",sym("word")))),instance_of:seq(optional(sym("field")),optional(" "),literal("instanceof")," ",sym("class_info")),number:seq(optional(literal("-")),repeat(range("0","9"),null,1))}}},{name:"grammar_",factory:function(){const self=this;const cls=this.of;const fields=[];const properties=cls.getAxiomsByClass(foam.core.Property);const constants=cls.getAxiomsByClass(foam.core.Constant);if(this.thisValue!==undefined){fields.push(this.Literal.create({s:"thisValue",value:this.thisValue}))}for(var i=0;i<properties.length;i++){var prop=properties[i];fields.push(this.Literal.create({s:prop.name,value:prop}))}for(var i=0;i<constants.length;i++){var con=constants[i];fields.push(this.Literal.create({s:con.name,value:con.value}))}fields.sort(function(a,b){var c=foam.util.compare(b.s.length,a.s.length);if(c)return c;return foam.util.compare(a.s,b.s)});var base=foam.Function.withArgs(this.baseGrammar_,this.Parsers.create(),this);var grammar={__proto__:base,fieldname:this.Alternate.create({args:fields})};var compactToString=function(v){return v.join("")};var actions={negate:function(v){return self.Not.create({arg1:v[1]})},number:function(v){return v[0]==null?parseInt(v[1].join("")):-parseInt(v[1].join(""))},comparison:function(v){var lhs=v[0];var op=v[2];var rhs=v[4];return op.call(self,lhs,rhs)},unary:function(v){var lhs=v[0];var op=v[2];if(foam.mlang.predicate.Not.isInstance(op)){}return op.call(self,lhs)},or:function(v){return self.OR.apply(self,v)},and:function(v){return self.AND.apply(self,v)},field:function(v){var expr=v[0];if(v[1]){var parts=v[1];for(var i=0;i<parts.length;i++){expr=self.DOT(expr,self.NamedProperty.create({propName:parts[i]}))}}return expr},fieldLen:function(v){return foam.mlang.StringLength.create({arg1:v[0]})},formula:function(v){return self.ADD.apply(self,v)},minus:function(v){return self.SUB.apply(self,v)},form_expr:function(v){if(foam.mlang.expr.Dot.isInstance(v[0])||foam.core.Property.isInstance(v[0])&&!foam.core.Int.isInstance(v[0]))return foam.parse.ParserWithAction.NO_PARSE;if(v.length==1||v[1]===null||v[1].length==0)return v[0];var formulas=v[1];var firstArg=v[0];var temp=formulas[0];var cnst=temp[1];var formula=temp[0];formula=formula.call(self,firstArg,cnst);for(var i=1;i<formulas.length;i++){var tempArr=formulas[i];var tempForm=tempArr[0];var constant=tempArr[1];tempForm=tempForm.call(self,formula,constant);formula=tempForm}return formula},regex:function(v){return new RegExp(v)},date:function(v){var args=[];for(var i=0;i<v.length;i++){if(i==0||i%2===0){args.push(i==2?v[i]-1:v[i])}}return new Date(...args)},word:function(v){if(v=="len"){return null}return v},enum:function(v){var enumArr=v.replaceAll(",","").split(".");var val=enumArr[enumArr.length-1];var enumCls=v.replaceAll(",","").split("."+val)[0];var en=this.__context__.maybeLookup(enumCls);return en==undefined?null:en[val]},instance_of:function(v){return foam.mlang.predicate.IsInstanceOf.create({targetClass:v[4],propExpr:v[0]})},class_info:function(v){return this.__context__.maybeLookup(v[0]+v[1].join().replaceAll(",",""))}};var g=this.ImperativeGrammar.create({symbols:grammar});g.addActions(actions);return g}}],methods:[function parseString(str,opt_name){var query=this.grammar_.parseString(str,opt_name);query=query&&query.partialEval?query.partialEval():query;return query}]});
foam.CLASS({package:"foam.parse",name:"FScriptParserTest",extends:"foam.nanos.test.Test",methods:[{name:"runTest",}]});
foam.CLASS({package:"foam.parse",name:"QueryParserUserTest",extends:"foam.nanos.test.Test",methods:[{name:"runTest",},{name:"isValid",type:"Boolean",args:[{name:"query",type:"String"},{name:"statement",type:"String"}],}]});
foam.CLASS({package:"foam.physics",name:"Physical",constants:{INFINITE_MASS:1e4},properties:[{class:"Float",name:"friction"},{class:"Float",name:"gravity",value:1},{class:"Float",name:"vx",value:0},{class:"Float",name:"vy",value:0},{class:"Float",name:"velocity",getter:function(){return this.distance(this.vx,this.vy)},setter:function(v){this.setVelocityAndAngle(v,this.angleOfVelocity)}},{class:"Float",name:"angleOfVelocity",getter:function(){return Math.atan2(this.vy,this.vx)},setter:function(a){this.setVelocityAndAngle(this.velocity,a)}},{class:"Float",name:"mass",value:1}],methods:[function distance(dx,dy){return Math.sqrt(dx*dx+dy*dy)},function applyMomentum(m,a){this.vx+=m*Math.cos(a)/this.mass;this.vy+=m*Math.sin(a)/this.mass},function momentumAtAngle(a){if(this.mass===this.INFINITE_MASS)return 0;var v=this.velocityAtAngle(a);return v*this.mass},function velocityAtAngle(a){if(this.mass===this.INFINITE_MASS)return 0;return Math.cos(a-this.angleOfVelocity)*this.velocity},function setVelocityAndAngle(v,a){this.vx=v*Math.cos(a);this.vy=v*Math.sin(a);return this},function distanceTo(other){return this.distance(this.x-other.x,this.y-other.y)}]});
foam.CLASS({package:"foam.physics",name:"Collider",topics:["onTick"],properties:[{class:"Boolean",name:"bounceOnWalls"},{name:"bounds",hidden:true},{name:"children",factory:function(){return[]},hidden:true},{class:"Boolean",name:"stopped_",value:true,hidden:true},{class:"Boolean",name:"colliding_",hidden:true},{name:"removedChildren_",factory:function(){return[]},hidden:true}],methods:[function updateChild(c){if(this.bounceOnWalls&&this.bounds){if(c.left_<this.bounds.x){c.vx=Math.abs(c.vx);c.x++}if(c.top_<this.bounds.y){c.vy=Math.abs(c.vy);c.y++}if(c.right_>this.bounds.width){c.vx=-Math.abs(c.vx);c.x--}if(c.bottom_>this.bounds.height){c.vy=-Math.abs(c.vy);c.y--}}},function updateChildren(){var cs=this.children;for(var i=0;i<cs.length;i++){this.updateChild(cs[i])}},function detectCollisions(){this.detectCollisions_(0,this.children.length-1,"x",false)},function detectCollisions__(start,end){var cs=this.children;for(var i=start;i<end;i++){var c1=cs[i];for(var j=i+1;j<=end;j++){var c2=cs[j];if(c1.intersects&&c1.intersects(c2))this.collide(c1,c2)}}},function choosePivot(start,end,axis){var cs=this.children;axis=axis+"_";var p=0,n=end-start+1;for(var i=start;i<=end;i++)p+=cs[i][axis]/n;return p},function swap(a,i1,i2){var tmp=a[i1];a[i1]=a[i2];a[i2]=tmp},function detectCollisions_(start,end,axis,oneD){if(start>=end)return;var cs=this.children;var pivot=this.choosePivot(start,end,axis);var nextAxis=oneD?axis:axis==="x"?"y":"x";var p=start;for(var i=start;i<=end;i++){var c=cs[i];if(c[axis=="x"?"left_":"top_"]<=pivot){this.swap(cs,p,i);p++}}if(p===end+1){if(oneD){this.detectCollisions__(start,end)}else{this.detectCollisions_(start,end,nextAxis,true)}}else{this.detectCollisions_(start,p-1,nextAxis,oneD);p--;for(var i=p;i>=start;i--){var c=cs[i];if(c[axis=="x"?"right_":"bottom_"]>=pivot){this.swap(cs,p,i);p--}}if(p===start-1){if(oneD){this.detectCollisions__(start,end)}else{this.detectCollisions_(start,end,nextAxis,true)}}else{this.detectCollisions_(p+1,end,nextAxis,oneD)}}},function angleOfImpact(c1,c2){return Math.atan2(c2.y_-c1.y_,c2.x_-c1.x_)},function collide(c1,c2){c1.collideWith&&c1.collideWith(c2);c2.collideWith&&c2.collideWith(c1);if(!c1.mass||!c2.mass)return;var a=this.angleOfImpact(c1,c2);var m1=c1.momentumAtAngle(a);var m2=-c2.momentumAtAngle(a);var m=(m1+m2)*2;if(m>=0){m=Math.max(1,m);var tMass=c1.mass+c2.mass;c1.applyMomentum(-m*c2.mass/tMass,a);c2.applyMomentum(m*c1.mass/tMass,a)}},function add(){for(var i=0;i<arguments.length;i++){this.children.push(arguments[i])}return this},function findChildAt(x,y){var c2={x:x,y:y,r:1};var cs=this.children;for(var i=cs.length-1;i>=0;i--){var c1=cs[i];if(c1.intersects(c2))return c1}},function selectChildrenAt(x,y){var c2={x:x,y:y,r:1};var children=[];var cs=this.children;for(var i=0;i<cs.length;i++){var c1=cs[i];if(c1.intersects(c2))children.push(c1)}return children},function remove(){if(this.colliding_){this.removedChildren_.push.apply(this.removedChildren_,arguments)}else{for(var i=0;i<arguments.length;i++){foam.Array.remove(this.children,arguments[i])}}return this},function detach(){this.stopped_=true;this.children=[]}],actions:[{name:"start",isEnabled:function(stopped_){return stopped_},code:function start(){this.stopped_=false;this.tick()}},{name:"stop",isEnabled:function(stopped_){return!stopped_},code:function start(){this.stopped_=true}}],listeners:[{name:"tick",isFramed:true,code:function tick(){if(this.stopped_)return;this.colliding_=true;this.onTick.pub();this.detectCollisions();this.colliding_=false;this.remove.apply(this,this.removedChildren_);this.removedChildren_.length=0;this.updateChildren();this.tick()}}]});
foam.CLASS({package:"foam.physics",name:"PhysicsEngine",extends:"foam.physics.Collider",properties:[{class:"Boolean",name:"gravity",value:false},{class:"Float",name:"gravityStrength",value:1}],methods:[function updateChild(c){this.SUPER(c);var gravity=c.gravity,friction=c.friction;if(gravity&&this.gravity){c.vy+=gravity*this.gravityStrength}if(friction){c.vx=Math.abs(c.vx)<.001?0:c.vx*friction;c.vy=Math.abs(c.vy)<.001?0:c.vy*friction}if(Math.abs(c.vx)>.001)c.x+=c.vx;if(Math.abs(c.vy)>.001)c.y+=c.vy}]});foam.INTERFACE({package:"foam.blob",name:"Blob",proxy:true,methods:[{name:"read",async:true,type:"Long",args:[{name:"out",},{name:"offset",type:"Long"},{name:"length",type:"Long"}]},{name:"getSize",type:"Long"}]});foam.INTERFACE({package:"foam.blob",name:"BlobService",methods:[{name:"put",async:true,type:"foam.blob.Blob",args:[{name:"blob",type:"foam.blob.Blob"}]},{name:"put_",async:"true",type:"foam.blob.Blob",args:[{name:"x",type:"Context"},{name:"blob",type:"foam.blob.Blob"}]},{name:"find",async:true,type:"foam.blob.Blob",args:[{name:"id",type:"Any"}]},{name:"find_",async:true,type:"foam.blob.Blob",args:[{name:"x",type:"Context"},{name:"id",type:"Any"}]},{name:"urlFor",type:"String",args:[{name:"blob",type:"foam.blob.Blob"}]},{name:"urlFor_",type:"String",args:[{name:"x",type:"Context"},{name:"blob",type:"foam.blob.Blob"}]}]});
foam.CLASS({package:"foam.blob",name:"AbstractBlob",abstract:true,implements:["foam.blob.Blob"],methods:[{name:"slice",type:"foam.blob.Blob",args:[{name:"offset",type:"Long"},{name:"length",type:"Long"}],code:function slice(offset,length){return foam.blob.SubBlob.create({parent:this,offset:offset,size:length})},}]});
foam.CLASS({package:"foam.blob",name:"AbstractBlobService",abstract:true,implements:["foam.blob.BlobService"],requires:["foam.blob.ProxyBlobService"],methods:[{name:"inX",type:"foam.blob.BlobService",args:[{name:"x",type:"Context"}],code:function(x){return this.ProxyBlobService.create({delegate:this},x)},},{name:"put",code:function put(blob){return this.put_(this.__context__,blob)},},{name:"find",code:function find(id){return this.find_(this.__context__,id)},},{name:"urlFor",code:function urlFor(blob){return this.urlFor_(this.__context__,blob)},}]});
foam.CLASS({package:"foam.blob",name:"ProxyBlobService",extends:"foam.blob.AbstractBlobService",properties:[{class:"Proxy",of:"foam.blob.BlobService",name:"delegate",forwards:["put_","find_","urlFor_"]}]});
foam.CLASS({package:"foam.blob",name:"SubBlob",extends:"foam.blob.AbstractBlob",properties:[{class:"Blob",name:"parent"},{class:"Long",name:"offset"},{class:"Long",name:"size",assertValue:function(value){foam.assert(this.offset+value<=this.parent.size,"Cannot create sub blob beyond end of parent.")}}],methods:[{name:"read",code:function read(buffer,offset){if(buffer.length>this.size-offset){buffer=buffer.slice(0,this.size-offset)}return this.parent.read(buffer,offset+this.offset)},},{name:"slice",code:function slice(offset,length){return foam.blob.SubBlob.create({parent:this.parent,offset:this.offset+offset,size:length})},}]});
foam.CLASS({package:"foam.blob",name:"BlobBlob",extends:"foam.blob.AbstractBlob",flags:["web"],properties:[{name:"blob",cloneProperty:function(value,map){map[this.name]=value}},{name:"size",factory:function(){return this.blob.size}}],methods:[function read(out,offset,length){var reader=new FileReader;var b=this.blob.slice(offset,offset+length);return new Promise(function(resolve,reject){reader.onload=function(e){out(reader.result);resolve()};reader.onerror=function(e){reject(e)};reader.readAsArrayBuffer(b)})}]});
foam.CLASS({package:"foam.blob",name:"IdentifiedBlob",extends:"foam.blob.ProxyBlob",imports:["BlobStore blobStore?","blobService"],properties:[{class:"String",name:"id"},{name:"delegate",transient:true,factory:function(){return this.blobService.find(this.id)},cloneProperty:function(){},diffProperty:function(){},javaCloneProperty:"// noop",javaDiffProperty:"// noop",javaCompare:"return 0;",javaComparePropertyToObject:"return 0;",javaComparePropertyToValue:"return 0;"}],methods:[function read(buffer,offset){return this.delegate.then(function(d){return d.read(buffer,offset)})},{name:"compareTo",type:"int",args:[{name:"o",type:"Object"}],code:function(other){if(other===null)return 1;return this.id.localeCompare(other.id)}}]});
foam.CLASS({package:"foam.core",name:"Blob",extends:"foam.core.FObjectProperty",flags:[],properties:[["type","foam.blob.Blob"],["of","foam.blob.Blob"],["tableCellView",function(){}],["view",{class:"foam.u2.view.BlobView"}]]});
foam.CLASS({package:"foam.blob",name:"ClientBlob",extends:"foam.blob.AbstractBlob",properties:[{class:"Stub",of:"foam.blob.Blob",name:"delegate",methods:["read"]},{class:"Long",name:"size"}],methods:[function getSize(){return this.size}]});
foam.CLASS({package:"foam.blob",name:"RestBlobService",extends:"foam.blob.AbstractBlobService",flags:[],requires:["foam.net.HTTPRequest","foam.blob.BlobBlob","foam.blob.IdentifiedBlob"],imports:["sessionID"],properties:[{class:"String",name:"serviceName"},{class:"String",name:"address",factory:function(){return window.location.origin+"/"+this.serviceName}}],methods:[function put_(x,blob){if(this.IdentifiedBlob.isInstance(blob)){return Promise.resolve(blob)}var url=this.address;var sessionId=this.sessionID||localStorage["defaultSession"];if(sessionId){url+="?sessionId="+sessionId}var req=this.HTTPRequest.create();req.fromUrl(url);req.method="PUT";req.payload=blob;var self=this;return req.send().then(function(resp){return resp.payload}).then(function(payload){return foam.json.Parser.create({creationContext:self.__context__}).parseString(payload)})},function urlFor_(x,blob){if(!foam.blob.IdentifiedBlob.isInstance(blob)){return null}var url=this.address+"/"+blob.id;var sessionId=localStorage["defaultSession"];if(sessionId){url+="?sessionId="+sessionId}return url},function find_(x,id){var url=this.address+"/"+id;var sessionId=localStorage["defaultSession"];if(sessionId){url+="?sessionId="+sessionId}var req=this.HTTPRequest.create();req.fromUrl(url);req.method="GET";req.responseType="blob";var self=this;return req.send().then(function(resp){return resp.payload}).then(function(blob){return self.BlobBlob.create({blob:blob})})}]});
foam.CLASS({package:"foam.blob",name:"BlobServiceDecorator",extends:"foam.dao.AbstractDAODecorator",flags:[],imports:["blobService"],properties:[{class:"Class",name:"of"}],methods:[function write(X,dao,obj,existing){var i=0;var props=obj.cls_.getAxiomsByClass(foam.core.Blob);var self=this;return Promise.resolve().then(function a(){var prop=props[i++];if(!prop)return obj;var blob=prop.f(obj);if(!blob)return a();return self.blobService.put(blob).then(function(b){prop.set(obj,b);return a()})})}]});
foam.CLASS({package:"foam.blob",name:"TestBlobService",extends:"foam.blob.AbstractBlobService",flags:[],requires:["foam.blob.IdentifiedBlob","foam.blob.BlobBlob"],properties:[{class:"Map",name:"blobs"},{class:"Int",name:"nextId",value:1}],methods:[function put_(x,file){var id=this.nextId++;this.blobs[id]=file;return Promise.resolve(this.IdentifiedBlob.create({id:id}))},function find_(x,id){return Promise.resolve(this.blobs[id]?this.BlobBlob.create({blob:this.blobs[id]}):null)},function urlFor_(x,blob){if(this.IdentifiedBlob.isInstance(blob)){return URL.createObjectURL(this.blobs[blob.id])}if(this.BlobBlob.isInstance(blob)){return URL.createObjectURL(blob.blob)}return null}]});
foam.CLASS({package:"foam.blob",name:"BlobStore",extends:"foam.blob.AbstractBlobService",requires:["foam.blob.IdentifiedBlob"],constants:[{name:"BUFFER_SIZE",value:4096,type:"Integer"}],properties:[{class:"String",name:"root",generateJava:false,},{class:"String",name:"tmp",transient:true,expression:function(root){return root+"/tmp"},},{class:"String",name:"directory",transient:true,expression:function(root){return root+"/largefiles"},},{class:"Boolean",name:"isSet",value:false,hidden:true,transient:true}],methods:[{name:"setup",type:"Void",args:[{name:"x",type:"Context"}],code:function setup(){if(globalThis.require){if(this.isSet)return;var parsed=require("path").parse(this.root);if(!require("fs").statSync(parsed.dir).isDirectory()){throw new Error(parsed.dir+" is not a directory.")}this.ensureDir(this.root);this.ensureDir(this.tmp);this.ensureDir(this.directory);this.isSet=true}},},{name:"ensureDir",type:"Void",synchronized:true,args:[{name:"x",type:"Context"},{name:"path",type:"String"}],code:function ensureDir(path){var stat;try{stat=require("fs").statSync(path);if(stat&&stat.isDirectory())return}catch(e){if(e.code==="ENOENT")return require("fs").mkdirSync(path);throw e}},},{name:"allocateTmp",args:[{name:"x",type:"Context"},{name:"name",type:"Long"}],code:function allocateTmp(){var fd;var path;var name=1;var self=this;return new Promise(function aaa(resolve,reject){path=self.tmp+require("path").sep+name++;fd=require("fs").open(path,"wx",function onOpen(err,fd){if(err&&err.code!=="EEXIST"){reject(err);return}if(err)aaa(resolve,reject);else resolve({path:path,fd:fd})})})},},{name:"put_",code:function put_(x,obj){if(this.IdentifiedBlob.isInstance(obj)){return obj}this.setup();var hash=require("crypto").createHash("sha256");var bufsize=8192;var buffer=Buffer.alloc(bufsize);var size=obj.size;var remaining=size;var offset=0;var self=this;var chunks=Math.ceil(size/bufsize);function chunkOffset(i){return i*bufsize}var tmp;function writeChunk(chunk){return obj.read(buffer,chunkOffset(chunk)).then(function(buf){hash.update(buf);return new Promise(function(resolve,reject){require("fs").write(tmp.fd,buf,0,buf.length,function cb(err,written,buffer){if(err){reject(err);return}if(written!==buf.length){console.warn("Didn't write entire chunk, does this ever happen?");require("fs").write(tmp.fd,buf.slice(written),cb);return}resolve()})})})}var chunk=0;return this.allocateTmp().then(function(tmpfile){tmp=tmpfile}).then(function a(){if(chunk<chunks)return writeChunk(chunk++).then(a)}).then(function(){return new Promise(function(resolve,reject){require("fs").close(tmp.fd,function(){var digest=hash.digest("hex");require("fs").rename(tmp.path,self.directory+require("path").sep+digest,function(err){if(err){reject(err);return}resolve(self.IdentifiedBlob.create({id:digest}))})})})})},},function filename(blob){if(!foam.blob.IdentifiedBlob.isInstance(blob))return null;var path=this.directory+require("path").sep+blob.id;try{require("fs").statSync(path)}catch(e){return null}return path},{name:"find_",code:function find_(x,id){this.setup();if(id.indexOf(require("path").sep)!=-1){return Promise.reject(new Error("Invalid file name"))}var self=this;return new Promise(function(resolve,reject){require("fs").open(self.directory+require("path").sep+id,"r",function(err,fd){if(err){if(err.code=="ENOENT"){resolve(null);return}reject(err);return}resolve(foam.blob.FdBlob.create({fd:fd}))})})},},{name:"urlFor_",code:function(){throw new Error("Unsupported operation.")},}]});
foam.CLASS({package:"foam.encodings",name:"UTF8",properties:[{name:"charcode"},{class:"Int",name:"remaining",value:0},{class:"String",name:"string"}],methods:[function reset(){this.string="";this.remaining=0;this.charcode=null},function put(byte){if(byte instanceof ArrayBuffer){var data=new Uint8Array(byte);this.put(data);return}if(byte instanceof Uint8Array){for(var i=0;i<byte.length;i++){this.put(byte[i])}return}if(this.charcode==null){this.charcode=byte;if(!(this.charcode&128)){this.remaining=0;this.charcode=(byte&127)<<6*this.remaining}else if((this.charcode&224)==192){this.remaining=1;this.charcode=(byte&31)<<6*this.remaining}else if((this.charcode&240)==224){this.remaining=2;this.charcode=(byte&15)<<6*this.remaining}else if((this.charcode&248)==240){this.remaining=3;this.charcode=(byte&7)<<6*this.remaining}else if((this.charcode&252)==248){this.remaining=4;this.charcode=(byte&3)<<6*this.remaining}else if((this.charcode&254)==252){this.remaining=5;this.charcode=(byte&1)<<6*this.remaining}else throw"Bad charcode value"}else if(this.remaining>0){this.remaining--;this.charcode|=(byte&63)<<6*this.remaining}if(this.remaining==0){this.string+=String.fromCodePoint(this.charcode);this.charcode=undefined}}]});
foam.CLASS({package:"foam.net",name:"CIDR",constants:[{name:"NOTATION_MIN_LENGTH",type:"Integer",value:10},{name:"NOTATION_MAX_LENGTH",type:"Integer",value:18}],properties:[{name:"notation",class:"String",placeholder:"10.0.0.0/24",required:true,validateObj:function(notation){if(!notation||notation.length<this.NOTATION_MIN_LENGTH||notation.length>this.NOTATION_MAX_LENGTH){return"invalid notation"}var m=notation.match(/\d+/g);if(!m||m.length!=5){return"invalid notation"}},postSet:function(o,n){if(n&&n.length>=this.NOTATION_MIN_LENGTH&&n.length<=this.NOTATION_MAX_LENGTH){this.calculateAddresses(n)}},},{name:"startAddress",class:"String",visibility:"RO"},{name:"endAddress",class:"String",visibility:"RO"},{name:"high",class:"Long",visibility:"HIDDEN"},{name:"low",class:"Long",visibility:"HIDDEN"}],methods:[{name:"calculateAddresses",args:[{name:"notation",type:"String"}],code:function(notation){function u(n){return n>>>0}function ip(n){return[n>>>24&255,n>>>16&255,n>>>8&255,n>>>0&255].join(".")}var m=notation.match(/\d+/g);if(!m||m.length<5){console.warn("invalid notation",notation);return}var addr32=m.slice(0,4).reduce(function(a,o){return u(+a<<8)+ +o});let mask=u(~0<<32-+m[4]);this.low=u(addr32&mask);this.high=u(addr32|~mask);this.startAddress=ip(this.low);this.endAddress=ip(this.high)},},{name:"inRange",args:[{name:"x",type:"Context"},{name:"ip",type:"String"}],type:"Boolean",}]});
foam.CLASS({package:"foam.net",name:"Host",properties:[{name:"id",class:"String",label:"Name",value:"localhost",required:true},{name:"address",class:"String",value:"127.0.0.1",required:true}]});
foam.CLASS({package:"foam.net",name:"Port",properties:[{name:"id",class:"String"},{name:"number",class:"Int"},{name:"relativeTo",class:"String"}],});
foam.CLASS({package:"foam.net",name:"NotConnectedException",implements:["foam.core.Exception"],extends:"foam.core.FOAMException"});
foam.CLASS({package:"foam.net",name:"ConnectionFailedException",extends:"foam.core.FOAMException"});
foam.CLASS({package:"foam.net.web",name:"WebSocket",requires:["foam.net.NotConnectedException","foam.net.ConnectionFailedException"],topics:["message","connected","disconnected"],properties:[{name:"uri"},{name:"socket",transient:true}],methods:[function send(msg){if(this.socket.readyState!==this.socket.OPEN){throw this.NotConnectedException.create()}this.socket.send(msg)},function connect(){var socket=this.socket=new WebSocket(this.uri);var self=this;return new Promise(function(resolve,reject){function onConnect(){socket.removeEventListener("open",onConnect);resolve(self)}function onConnectError(e){socket.removeEventListener("error",onConnectError);reject(self.ConnectionFailedException.create())}socket.addEventListener("open",onConnect);socket.addEventListener("error",onConnectError);socket.addEventListener("open",function(){self.connected.pub()});socket.addEventListener("message",self.onMessage);socket.addEventListener("close",function(){self.disconnected.pub()})})},function disconnect(){this.socket&&this.socket.close()}],listeners:[{name:"onMessage",code:function(msg){this.message.pub(msg.data)}}]});
foam.CLASS({package:"foam.net.web",name:"WebSocketService",requires:["foam.box.Message","foam.json.Parser","foam.net.web.WebSocket","foam.box.RawWebSocketBox"],imports:["creationContext"],properties:[{name:"delegate"},{class:"FObjectProperty",of:"foam.json.Parser",name:"parser",factory:function(){return this.Parser.create({strict:true,creationContext:this.creationContext})}}],methods:[function addSocket(socket){var X=this.creationContext.createSubContext({returnBox:this.RawWebSocketBox.create({socket:socket})});var sub1=socket.message.sub(function onMessage(s,_,msgStr){try{var msg=this.parser.parseString(msgStr,X);if(!this.Message.isInstance(msg)){console.warn("Got non-message",msg.cls_.id);console.warn("  payload was: ",msgStr);return}this.delegate.send(msg)}catch(e){console.error("WSS Error:",e)}}.bind(this));socket.disconnected.sub(function(s){s.detach();sub1.detach()})}]});
foam.CLASS({package:"foam.net.web",name:"HTTPResponse",topics:["data","end","err"],properties:[{class:"Int",name:"status"},{class:"String",name:"responseType"},{class:"Map",name:"headers"},{name:"payload",factory:function(){if(this.streaming)return null;switch(this.responseType){case"text":return this.resp.text();case"blob":return this.resp.blob();case"arraybuffer":return this.resp.arraybuffer();case"json":return this.resp.json()}throw new Error("Unsupported response type: "+this.responseType)}},{class:"Boolean",name:"streaming"},{class:"Boolean",name:"success",expression:function(status){return status>=200&&status<=299}},{name:"resp",postSet:function(_,r){if(r.headers.entries){this.copyHeaders_(r)}else{this.copyHeadersEdge_(r)}this.status=r.status}}],methods:[function start(){var reader=this.resp.body.getReader();this.streaming=true;var onError=foam.Function.bind(function(e){this.err.pub();this.end.pub()},this);var onData=foam.Function.bind(function(e){if(e.value)this.data.pub(e.value);if(e.done||!this.streaming){this.end.pub();return this}return reader.read().then(onData,onError)},this);return reader.read().then(onData,onError)},function stop(){this.streaming=false},function copyHeaders_(r){var iterator=r.headers.entries();var next=iterator.next();while(!next.done){this.headers[next.value[0]]=next.value[1];next=iterator.next()}},function copyHeadersEdge_(r){var headers=this.headers;r.headers.forEach(function(value,key){headers[key]=value})}]});
foam.CLASS({package:"foam.net.web",name:"HTTPRequest",requires:["foam.net.web.HTTPResponse","foam.blob.Blob","foam.blob.BlobBlob"],topics:["data"],properties:[{class:"String",name:"hostname"},{class:"Int",name:"port"},{class:"String",name:"protocol",preSet:function(old,nu){return nu.replace(":","")}},{class:"String",name:"path",preSet:function(old,nu){if(!nu.startsWith("/"))return"/"+nu;return nu}},{class:"String",name:"url"},{class:"String",name:"method",value:"GET"},{class:"Map",name:"headers"},{name:"payload"},{class:"String",name:"responseType",value:"text"},{class:"String",name:"contentType",factory:function(){return this.responseType}},{class:"String",name:"mode",value:"cors"},{class:"Boolean",name:"cache"}],methods:[function fromUrl(url){var u=new URL(url);this.protocol=u.protocol.substring(0,u.protocol.length-1);this.hostname=u.hostname;if(u.port)this.port=u.port;this.path=u.pathname+u.search;return this},function send(){if(this.url){this.fromUrl(this.url)}this.addContentHeaders();if(this.cache){this.headers["Cache-Control"]="public"}else{this.headers["Pragma"]="no-cache";this.headers["Cache-Control"]="no-cache, no-store"}var self=this;var headers=new Headers;for(var key in this.headers){headers.set(key,this.headers[key])}var options={method:this.method,headers:headers,mode:this.mode,redirect:"follow",credentials:"same-origin"};if(this.payload){if(this.BlobBlob.isInstance(this.payload)){options.body=this.payload.blob}else if(this.Blob.isInstance(this.payload)){foam.assert(false,"TODO: Implemented sending of foam.blob.Blob over HTTPRequest.")}else{options.body=this.payload}}var request=new Request((this.protocol?this.protocol+"://":"")+this.hostname+(this.port?":"+this.port:"")+this.path,options);return fetch(request).then(function(resp){var resp=this.HTTPResponse.create({resp:resp,responseType:this.responseType});if(resp.success)return resp;return Promise.reject(resp)}.bind(this))},function addContentHeaders(){if(!this.headers["Content-Type"]){switch(this.contentType){case"text":this.headers["Content-Type"]="text/plain";break;case"json":this.headers["Content-Type"]="application/json";break;case"url":this.headers["Content-Type"]="application/x-www-form-urlencoded";break}}if(!this.headers["Accept"]){switch(this.contentType){case"json":this.headers["Accept"]="application/json";break}}}]});foam.SCRIPT({package:"foam.net.web",name:"HTTPRequestScript",requires:["foam.net.web.HTTPRequest"],flags:["web"],code:function(){foam.register(foam.lookup("foam.net.web.HTTPRequest"),"foam.net.web.BaseHTTPRequest")}});
foam.CLASS({package:"foam.net.web",name:"EventSource",requires:["foam.parse.Grammar","foam.net.web.HTTPRequest","foam.encodings.UTF8"],imports:["setTimeout","clearTimeout"],topics:[{name:"message"}],properties:[{name:"grammar",factory:function(){var self=this;return this.Grammar.create({symbols:function(repeat,alt,sym,notChars,seq){return{START:sym("line"),line:alt(sym("event"),sym("data")),event:seq("event: ",sym("event name")),"event name":repeat(notChars("\r\n")),data:seq("data: ",sym("data payload")),"data payload":repeat(notChars("\r\n"))}}}).addActions({"event name":function(v){self.eventName=v.join("")},"data payload":function(p){self.eventData=p.join("")}})}},{class:"String",name:"uri"},{class:"Boolean",name:"running",value:false},{name:"resp"},{name:"decoder",factory:function(){return this.UTF8.create()}},{name:"retryTimer"},{class:"Int",name:"delay",preSet:function(_,a){if(a>3e4)return 3e4;return a},value:1},"eventData","eventName"],methods:[function start(){var req=this.HTTPRequest.create({method:"GET",url:this.uri,headers:{accept:"text/event-stream"}});this.running=true;this.keepAlive();req.send().then(function(resp){if(!resp.success){this.onError();return}this.clearProperty("decoder");resp.data.sub(this.onData);resp.end.sub(this.onError);this.resp=resp;resp.start()}.bind(this),this.onError)},function keepAlive(){if(this.retryTimer){this.clearTimeout(this.retryTimer)}this.retryTimer=this.setTimeout(foam.Function.bind(function(){this.retryTimer=0;this.onError()},this),3e4)},function close(){this.running=false;this.resp.stop()},function dispatchEvent(){this.message.pub(this.eventName,this.eventData);this.eventName=null;this.eventData=null},function processLine(line){if(line.length==0){this.dispatchEvent();return}this.grammar.parseString(line)}],listeners:[function onData(s,_,data){this.delay=1;this.keepAlive();this.decoder.put(data);var string=this.decoder.string;while(string.indexOf("\n")!=-1){var line=string.substring(0,string.indexOf("\n"));this.processLine(line);string=string.substring(string.indexOf("\n")+1)}this.decoder.string=string},function onError(){this.delay*=2;this.setTimeout(this.onEnd,this.delay)},function onEnd(){if(this.running){this.start()}}]});
foam.CLASS({package:"foam.net.web",name:"XMLHTTPRequest",extends:"foam.net.web.HTTPRequest",requires:["foam.net.web.XMLHTTPResponse as HTTPResponse"],methods:[function send(){if(this.url){this.fromUrl(this.url)}var xhr=new XMLHttpRequest;xhr.open(this.method,this.protocol+"://"+this.hostname+(this.port?":"+this.port:"")+this.path);xhr.responseType=this.responseType;for(var key in this.headers){xhr.setRequestHeader(key,this.headers[key])}var self=this;return new Promise(function(resolve,reject){xhr.addEventListener("readystatechange",function foo(){if(this.readyState===this.LOADING||this.readyState===this.DONE){this.removeEventListener("readystatechange",foo);var resp=self.HTTPResponse.create({xhr:this});if(resp.success){resolve(resp)}else{reject(resp)}}});xhr.send(self.payload)})}]});
foam.CLASS({package:"foam.net.web",name:"XMLHTTPResponse",extends:"foam.net.web.HTTPResponse",constants:{STREAMING_LIMIT:10*1024*1024},properties:[{name:"xhr",postSet:function(_,xhr){this.status=xhr.status;var headers=xhr.getAllResponseHeaders().split("\r\n");for(var i=0;i<headers.length;i++){var sep=headers[i].indexOf(":");var key=headers[i].substring(0,sep);var value=headers[i].substring(sep+1);this.headers[key.trim()]=value.trim()}this.responseType=xhr.responseType}},{name:"payload",factory:function(){if(this.streaming){return null}var self=this;var xhr=this.xhr;if(xhr.readyState===xhr.DONE)return Promise.resolve(xhr.response);else return new Promise(function(resolve,reject){xhr.addEventListener("readystatechange",function(){if(this.readyState===this.DONE)resolve(this.response)})})}},{class:"Int",name:"pos",value:0}],methods:[function start(){this.streaming=true;this.xhr.addEventListener("loadend",function(){this.done.pub()}.bind(this));this.xhr.addEventListener("progress",function(){var substr=this.xhr.responseText.substring(this.pos);this.pos=this.xhr.responseText.length;this.data.pub(substr);if(this.pos>this.STREAMING_LIMIT){this.xhr.abort()}}.bind(this))}]});
foam.CLASS({package:"foam.net.web",name:"SafariEventSource",extends:"foam.net.web.EventSource",requires:["foam.net.web.XMLHTTPRequest as HTTPRequest"],properties:[{class:"String",name:"buffer"}],listeners:[function onData(s,_,data){this.delay=1;this.keepAlive();this.buffer+=data;var string=this.buffer;while(string.indexOf("\n")!=-1){var line=string.substring(0,string.indexOf("\n"));this.processLine(line);string=string.substring(string.indexOf("\n")+1)}this.buffer=string}]});
foam.CLASS({package:"foam.messageport",name:"MessagePortService",requires:["foam.box.NamedBox","foam.box.RawMessagePortBox","foam.box.RegisterSelfMessage","foam.json.Parser"],imports:["creationContext"],topics:["connect"],properties:[{name:"source",postSet:function(){this.source.addEventListener("connect",this.onConnect);this.source.addEventListener("message",this.onConnect)}},{name:"delegate",required:true},{class:"FObjectProperty",of:"foam.json.Parser",name:"parser",factory:function(){return this.Parser.create({strict:true,creationContext:this.creationContext})}}],methods:[function addPort(p){p.onmessage=this.onMessage.bind(this,p)}],listeners:[function onConnect(e){for(var i=0;i<e.ports.length;i++){this.addPort(e.ports[i])}},function onMessage(port,e){var msg=this.parser.parseString(e.data);if(this.RegisterSelfMessage.isInstance(msg.object)){var named=this.NamedBox.create({name:msg.object.name});named.delegate=this.RawMessagePortBox.create({port:port});this.connect.pub(named);return}this.delegate&&this.delegate.send(msg)}]});
foam.CLASS({package:"com.firebase",name:"ExpectedObjectNotFound",extends:"foam.dao.InternalException"});
foam.CLASS({package:"com.firebase",name:"FirebaseDAO",extends:"foam.dao.AbstractDAO",requires:["foam.dao.ArraySink","foam.net.web.HTTPRequest","com.firebase.FirebaseEventSource","foam.mlang.predicate.Gt","foam.mlang.Constant"],properties:["of","apppath","secret","eventSource_",{name:"timestampProperty"},{name:"basepath",expression:function(apppath,of){return apppath+of.id.replace(/\./g,"/")}},{class:"Boolean",name:"enableStreaming",value:true},"startEventsAt_"],methods:[function put_(x,obj){var req=this.HTTPRequest.create();if(obj.id){req.method="PUT";req.url=this.basepath+"/"+encodeURIComponent(obj.id)+".json"}else{throw new Error("Server generated IDs not supported.")}if(this.secret){req.url+="?auth="+encodeURIComponent(this.secret)}req.payload=JSON.stringify({data:foam.json.stringify(obj),lastUpdate:{".sv":"timestamp"}});req.headers["content-type"]="application/json";req.headers["accept"]="application/json";return req.send().then(function(resp){return resp.payload}).then(function(payload){payload=JSON.parse(payload);var o2=foam.json.parseString(payload.data,this);if(this.timestampProperty){this.timestampProperty.set(o2,payload.lastUpdate)}return o2}.bind(this),function(resp){return Promise.reject(foam.dao.InternalException.create())})},function remove_(x,obj){var req=this.HTTPRequest.create();req.method="DELETE";req.url=this.basepath+"/"+encodeURIComponent(obj.id)+".json";if(this.secret){req.url+="?auth="+encodeURIComponent(this.secret)}return req.send().then(function(){return Promise.resolve()},function(){return Promise.reject(foam.dao.InternalException.create())})},function find_(x,id){var req=this.HTTPRequest.create();req.method="GET";req.url=this.basepath+"/"+encodeURIComponent(id)+".json";if(this.secret){req.url+="?auth="+encodeURIComponent(this.secret)}return req.send().then(function(resp){return resp.payload}).then(function(data){if(data=="null"){return Promise.resolve(null)}try{data=JSON.parse(data);var obj=foam.json.parseString(data.data,this);if(this.timestampProperty){this.timestampProperty.set(obj,data.lastUpdate)}return obj}catch(e){return Promise.reject(foam.dao.InternalException.create())}}.bind(this))},function startEvents(){if(this.eventSource_||!this.enableStreaming){return}var params=[];if(this.secret)params.push(["auth",this.secret]);if(this.startEventsAt_){params.push(["orderBy",'"lastUpdate"']);params.push(["startAt",this.startEventsAt_])}var uri=this.basepath+".json";if(params.length){uri+="?"+params.map(function(p){return p.map(encodeURIComponent).join("=")}).join("&")}this.eventSource_=this.FirebaseEventSource.create({uri:uri});this.eventSource_.put.sub(this.onPut);this.eventSource_.patch.sub(this.onPatch);this.eventSource_.start()},function stopEvents(){if(this.eventSource_){this.eventSource_.close();this.eventSource_.message.put.unsub(this.onPut);this.eventSource_.message.patch.unsub(this.onPatch);this.clearProperty("eventSource_")}},function select_(x,sink,skip,limit,order,predicate){var req=this.HTTPRequest.create();req.method="GET";var params=[];if(this.secret)params.push(["auth",this.secret]);if(predicate&&this.timestampProperty&&this.Gt.isInstance(predicate)&&this.Constant.isInstance(predicate.arg2)&&predicate.arg1===this.timestampProperty){if(!this.startEventsAt_){this.startEventsAt_=predicate.arg2.f()+1;this.startEvents()}params.push(["orderBy",'"lastUpdate"']);params.push(["startAt",predicate.arg2.f()+1])}var url=this.basepath+".json";if(params.length){url+="?"+params.map(function(p){return p.map(encodeURIComponent).join("=")}).join("&")}req.url=url;var resultSink=sink||this.ArraySink.create();sink=this.decorateSink_(resultSink,skip,limit,order,predicate);return req.send().then(function(resp){if(!resp.success){return Promise.reject(foam.dao.InternalException.create())}return resp.payload}).then(function(payload){var data=JSON.parse(payload);var detached=false;var sub=foam.core.FObject.create();sub.onDetach(function(){detached=true});for(var key in data){if(detached)break;var obj=foam.json.parseString(data[key].data,this);if(this.timestampProperty){this.timestampProperty.set(obj,data[key].lastUpdate)}sink.put(obj,sub)}sink.eof();return resultSink}.bind(this),function(resp){var e=foam.dao.InternalException.create();return Promise.reject(e)})}],listeners:[function onPut(s,_,data){var path=data.path;if(path=="/"){if(data.data==null){this.on.reset.pub();return}for(var key in data.data){var obj=foam.json.parseString(data.data[key].data,this);if(this.timestampProperty){this.timestampProperty.set(obj,data.data[key].lastUpdate)}this.on.put.pub(obj)}return}else if(path.lastIndexOf("/")===0){if(data.data==null){var obj=this.of.create();obj.id=path.substring(1);this.on.remove.pub(obj);return}var obj=foam.json.parseString(data.data.data,this);if(this.timestampProperty){this.timestampProperty.set(obj,data.data.lastUpdate)}this.on.put.pub(obj)}else if(path.indexOf("/data")===path.length-5){debugger;var id=path.substring(1);id=id.substring(0,id.indexOf("/"));this.find(id).then(function(obj){if(!obj)throw com.firebase.ExpectedObjectNotFound.create();this.on.put.pub(obj)}.bind(this))}else if(path.indexOf("/lastUpdate")===path.length-11){debugger;var id=path.substring(1);id=id.substring(0,id.indexOf("/"));this.find(id).then(function(obj){if(!obj)throw com.firebase.ExpectedObjectNotFound.create();this.on.put.pub(obj)}.bind(this))}},function onPatch(s,_,__,data){debugger}]});
foam.CLASS({package:"com.firebase",name:"SafariFirebaseDAO",extends:"com.firebase.FirebaseDAO",requires:["foam.net.web.XMLHTTPRequest as HTTPRequest","foam.net.web.SafariEventSource as EventSource"],properties:[["enableStreaming",false]]});
foam.CLASS({package:"com.firebase",name:"FirebaseEventSource",requires:["foam.net.web.EventSource"],topics:["put","patch","keep-alive","cancel","auth_revoked"],properties:[{name:"uri",required:true},{name:"eventSource",postSet:function(old,nu){nu.message.sub(this.onMessage)},factory:function(){return this.EventSource.create({uri:this.uri})}},{class:"String",name:"buffer"}],methods:[function start(){this.eventSource.start()}],listeners:[function onMessage(s,msg,name,data){switch(name){case"put":this.onPut(name,data);break;case"patch":this.onPatch(name,data);break;case"keep-alive":this.onKeepAlive(name,data);break;case"cancel":this.onCancel(name,data);break;case"auth_revoked":this.onAuthRevoked(name,data);break;default:this.onUnknown(name,data)}},function onPut(name,data){this.put.pub(JSON.parse(data));return},function onPatch(){debugger},function onKeepAlive(){},function onCancel(){},function onUnknown(name,data){this.__context__.warn("Unknown firebase event",name,data)}]});
foam.CLASS({package:"com.firebase",name:"CloudMessaging",requires:["foam.net.node.HTTPRequest"],properties:[{name:"serverKey"}],methods:[function send(id,payload,collapseKey){return this.HTTPRequest.create({url:"https://fcm.googleapis.com/fcm/send",method:"POST",headers:{"content-type":"application/json",Authorization:"key="+this.serverKey},responseType:"json",payload:JSON.stringify({to:id,data:payload})}).send().then(function(resp){if(!resp.success){return resp.payload.then(function(p){return Promise.reject(p)})}})}]});
foam.CLASS({package:"foam.core",name:"StubMethod",extends:"Method",properties:["replyPolicyName","boxPropName",{name:"code",factory:function(){var type=this.type;var isContextOriented=this.args.length>=1&&this.args[0].type=="Context";var replyPolicyName=this.replyPolicyName;var boxPropName=this.boxPropName;var name=this.name;return function(){var replyBox=this.RPCReturnBox.create();var ret=replyBox.promise;var replyBox=this.OneTimeBox.create({delegate:replyBox});var exportBox=this.registry.register(null,null,replyBox);replyBox.onDetach(exportBox);var cls=this.__context__.maybeLookup(type);if(cls&&!cls.name.startsWith("Promised")){var promiseType=`${cls.package}.Promised${cls.name}`;cls=this.__context__.maybeLookup(promiseType)}ret=cls?cls.create({delegate:ret}):ret;var args=Array.from(arguments);if(isContextOriented)args[0]=null;var msg=this.Message.create({object:this.RPCMessage.create({name:name,args:args})});msg.attributes.replyBox=exportBox;this[boxPropName].send(msg);return ret}}}],methods:[{name:"buildJavaClass",flags:["java"],code:function buildJavaClass(cls){if(!this.javaSupport)return;var name=this.name;var args=this.args;var boxPropName=foam.String.capitalize(this.boxPropName);var code=`foam.box.Message message = getX().create(foam.box.Message.class);
foam.box.RPCMessage rpc = getX().create(foam.box.RPCMessage.class);
rpc.setName("${name}");
Object[] args = { ${args.map(a=>a.name).join(",")} };
rpc.setArgs(args);
message.setObject(rpc);
foam.box.RPCReturnBox replyBox = getX().create(foam.box.RPCReturnBox.class);
message.getAttributes().put("replyBox", replyBox);
get${boxPropName}().send(message);
try {
replyBox.getSemaphore().acquire();
} catch (Throwable t) {
throw new RuntimeException(t);
}
Object result = replyBox.getMessage().getObject();
`;if(this.javaType&&this.javaType!=="void"){code+=`if ( result instanceof foam.box.RPCReturnMessage )
return (${this.javaType})((foam.box.RPCReturnMessage)result).getData();
`}code+=`if ( result instanceof java.lang.Throwable )
throw new RuntimeException((java.lang.Throwable)result);
if ( result instanceof foam.box.RPCErrorMessage ) {
foam.box.RPCErrorMessage error = (foam.box.RPCErrorMessage) result;
if ( error.getData() != null ) {
throw new RuntimeException(error.getData().toString());
}
throw new RuntimeException(error.getMessage());
}
`;if(this.javaType&&this.javaType!=="void"){code+=`throw new RuntimeException("Invalid response type: " + result.getClass());`}this.javaCode=code;this.SUPER(cls)}}]});
foam.CLASS({package:"foam.core",name:"StubAction",extends:"Action",requires:["foam.core.StubMethod"],properties:["replyPolicyName","boxPropName",{name:"stubMethod",factory:function(){return this.StubMethod.create({name:this.name,replyPolicyName:this.replyPolicyName,boxPropName:this.boxPropName})}},{name:"code",factory:function(){return function(ctx,action){action.stubMethod.code.call(this)}}}],methods:[function installInProto(proto){proto[this.name]=this.stubMethod.code}]});
foam.CLASS({package:"foam.core",name:"Stub",extends:"Property",requires:["foam.box.Message","foam.box.RPCMessage","foam.box.RPCReturnBox","foam.box.ReplyBox","foam.core.StubMethod","foam.core.StubNotification"],properties:["of",{name:"replyPolicyName",expression:function(name){return name+"ReplyPolicy"}},{class:"StringArray",name:"methods",factory:function(){return null}},{name:"methods_",expression:function(of,name,methods,replyPolicyName){var cls=this.__context__.lookup(of);return(methods?methods.map(function(m){var axiom=cls.getAxiomByName(m);foam.assert(axiom,"Stub Error: Cannot find method name",m,"for class",of);return axiom}):cls.getAxiomsByClass(foam.core.Method).filter(function(m){return cls.hasOwnAxiom(m.name)})).map(function(m){foam.assert(m.async||m.type=="Void","Cannot stub non-void non-async method",m.name,"on class",cls.id);return foam.core.StubMethod.create({name:m.name,replyPolicyName:replyPolicyName,boxPropName:name,type:m.type,javaType:m.javaType,swiftType:m.swiftType,args:m.args})})}},{class:"StringArray",name:"notifications",factory:function(){return null}},{name:"notifications_",expression:function(of,name,notifications){var cls=this.__context__.lookup(of);return notifications&&notifications.map(function(m){var axiom=cls.getAxiomByName(m);foam.assert(axiom,"Stub Error: Cannot find method name",m,"for class",of);return axiom}).map(function(m){return foam.core.StubNotification.create({name:m.name,boxPropName:name,args:m.args})})}},{class:"StringArray",name:"actions",factory:function(){return null}},{name:"actions_",expression:function(of,name,actions,replyPolicyName){var cls=this.__context__.lookup(of);return(actions?actions.map(function(a){return cls.getAxiomByName(a)}):cls.getAxiomsByClass(foam.core.Action).filter(function(m){return cls.hasOwnAxiom(m.name)})).map(function(m){return foam.core.StubAction.create({name:m.name,isEnabled:m.isEnabled,replyPolicyName:replyPolicyName,boxPropName:name})})}},["type","foam.box.Box"],{name:"javaInfoType",value:"foam.core.AbstractFObjectPropertyInfo",flags:["java"]}],methods:[function installInClass(cls){var model=this.__context__.lookup(this.of);var propName=this.name;cls.installAxiom(foam.core.Object.create({name:this.replyPolicyName,type:"foam.box.BoxService",hidden:true}));cls.installAxioms(this.methods_);cls.installAxioms(this.notifications_);cls.installAxioms(this.actions_);cls.installAxioms(["foam.box.RPCReturnBox","foam.box.ReplyBox","foam.box.RPCMessage","foam.box.OneTimeBox","foam.box.Message"].map(function(s){var path=s.split(".");return foam.core.Requires.create({path:s,name:path[path.length-1]})}));cls.installAxiom(foam.core.Import.create({key:"registry",name:"registry",type:"foam.box.BoxRegistry"}))}]});
foam.CLASS({package:"foam.core",name:"StubClass",axioms:[foam.pattern.Multiton.create({property:"of"})],requires:["foam.core.Model"],properties:[{class:"Class",name:"of",required:true},{class:"String",name:"package",factory:function(){return this.of.package}},{class:"String",name:"name",factory:function(){return`${this.of.name}Stub`}},{class:"String",name:"id",factory:function(){return`${this.package}.${this.name}`}},{class:"FObjectProperty",of:"Model",name:"stubModel",factory:function(){return this.Model.create({package:this.package,name:this.name,implements:[this.of.id],properties:[{class:"Stub",of:this.of.id,name:"delegate"}]})}},{name:"stubCls",factory:function(){return this.buildClass_()}}],methods:[function init(){this.validate();this.SUPER()},function buildClass_(){this.stubModel.validate();var cls=this.stubModel.buildClass();cls.validate();this.__subContext__.register(cls);foam.package.registerClass(cls);return this.stubModel.buildClass()}]});
foam.CLASS({package:"foam.core",name:"StubNotification",extends:"Method",properties:["boxPropName",{name:"code",factory:function(){var boxPropName=this.boxPropName;var name=this.name;return function(){var msg=this.Message.create({object:this.RPCMessage.create({name:name,args:Array.from(arguments)})});this[boxPropName].send(msg);return}}}],methods:[{name:"buildJavaClass",flags:["java"],code:function buildJavaClass(cls){if(!this.javaSupport)return;var name=this.name;var args=this.args;var boxPropName=foam.String.capitalize(this.boxPropName);var code=`foam.box.Message message = getX().create(foam.box.Message.class);
foam.box.RPCMessage rpc = getX().create(foam.box.RPCMessage.class);
rpc.setName("${name}");
Object[] args = { ${args.map(a=>a.name).join(",")} };
rpc.setArgs(args);
message.setObject(rpc);
get${boxPropName}().send(message);
`;if(this.javaType&&this.javaType!=="void"){code+=`return null;`}this.javaCode=code;this.SUPER(cls)}}]});
foam.CLASS({package:"foam.core",name:"StubFactory",requires:["foam.core.StubClass"],methods:[function get(cls){return this.StubClass.create({of:cls}).stubCls}]});
foam.CLASS({package:"foam.core",name:"StubFactorySingleton",extends:"foam.core.StubFactory",axioms:[foam.pattern.Singleton.create()]});foam.INTERFACE({package:"foam.box",name:"Box",methods:[{name:"send",async:true,type:"Void",args:[{name:"msg",type:"foam.box.Message"}],}]});
foam.CLASS({package:"foam.box",name:"AnonymousBox",implements:["foam.box.Box"],flags:["js"],properties:[{class:"Function",name:"f"}],methods:[function send(m){this.f(m)}]});
foam.CLASS({package:"foam.box",name:"RemoteException",extends:"foam.core.FOAMException",properties:[{class:"FObjectProperty",of:"foam.core.Exception",name:"exception"}]});foam.INTERFACE({package:"foam.box",name:"Skeleton",implements:["foam.box.Box"],methods:[{name:"setDelegateObject",args:[{name:"obj",type:"Object"}]}]});
foam.CLASS({package:"foam.box",name:"PromisedBox",implements:["foam.box.Box"],properties:[{class:"Promised",of:"foam.box.Box",transient:true,name:"delegate"}]});
foam.CLASS({package:"foam.box",name:"ProxyBox",implements:["foam.box.Box"],properties:[{class:"Proxy",of:"foam.box.Box",name:"delegate"}]});
foam.CLASS({package:"foam.box",name:"Message",properties:[{class:"Map",name:"attributes",},{class:"Object",name:"object"},{class:"Map",transient:true,name:"localAttributes",}],methods:[{name:"replyWithException",type:"Void",args:[{name:"t",}],}]});
foam.CLASS({package:"foam.box",name:"SubBoxMessage",extends:"foam.box.Message",properties:[{class:"String",name:"name"}]});
foam.CLASS({package:"foam.box",name:"HelloMessage"});
foam.CLASS({package:"foam.box",name:"TimeoutException",implements:["foam.core.Exception"]});
foam.CLASS({package:"foam.box",name:"TimeoutBox",extends:"foam.box.ProxyBox",requires:["foam.box.TimeoutException","foam.box.Message"],properties:[{class:"Int",name:"timeout",value:6e4,preSet:function(old,nu){if(nu<5e3){console.warn("Setting timeout to low value",nu);return 5e3}return nu}}],methods:[function send(msg){var replyBox=msg.attributes.replyBox;var localReplyBox=replyBox.localBox;if(!replyBox){this.delegate.send(msg);return}var tooLate=false;var timer=setTimeout(function(){tooLate=true;localReplyBox.send(this.Message.create({object:this.TimeoutException.create()}))}.bind(this),this.timeout);var self=this;replyBox.localBox=foam.box.AnonymousBox.create({f:function(msg){if(!tooLate){clearTimeout(timer);localReplyBox.send(msg);return}self.timeout*=2}});this.delegate.send(msg)}]});
foam.CLASS({package:"foam.box",name:"BackoffBox",extends:"foam.box.ProxyBox",imports:["setTimeout"],properties:[{class:"Int",name:"delay",preSet:function(_,a){return a<this.maxDelay?a:this.maxDelay},value:1},{class:"Int",name:"maxDelay",value:2e4}],methods:[function send(m){var self=this;this.setTimeout(function(){self.delegate.send(m)},this.delay);this.delay*=2}]});
foam.CLASS({package:"foam.box",name:"RetryReplyBox",extends:"foam.box.ProxyBox",requires:["foam.core.Exception"],properties:[{name:"attempt",value:0},{name:"maxAttempts"},{name:"message"},{name:"destination"}],methods:[{name:"send",code:function send(msg){if(this.Exception.isInstance(msg.object)&&(this.maxAttempts==-1||this.attempt<this.maxAttempts)){this.attempt++;this.destination.send(this.message);return}this.delegate&&this.delegate.send(msg)}}]});
foam.CLASS({package:"foam.box",name:"RetryBox",extends:"foam.box.ProxyBox",requires:["foam.box.BackoffBox","foam.box.RetryReplyBox"],properties:["attempts",{name:"maxAttempts",value:3}],methods:[function send(msg){var replyBox=msg.attributes.replyBox;if(replyBox){var clone=msg.cls_.create(msg);replyBox.localBox=this.RetryReplyBox.create({delegate:replyBox.localBox,maxAttempts:this.maxAttempts,message:clone,destination:this.BackoffBox.create({delegate:this.delegate})});clone.attributes={};for(var key in msg.attributes){clone.attributes[key]=msg.attributes[key]}}this.delegate.send(msg)}]});
foam.CLASS({package:"foam.box",name:"SubBox",extends:"foam.box.ProxyBox",requires:["foam.box.SubBoxMessage"],properties:[{class:"String",name:"name"}],methods:[{name:"send",code:function(msg){msg.object=this.SubBoxMessage.create({name:this.name,object:msg.object});this.delegate.send(msg)},}]});
foam.CLASS({package:"foam.box",name:"NameAlreadyRegisteredException",extends:"foam.core.FOAMException",properties:[{class:"String",name:"name"}]});
foam.CLASS({package:"foam.box",name:"NoSuchNameException",extends:"foam.core.FOAMException",properties:[{class:"String",name:"name"},{class:"String",name:"message",transient:true,expression:function(name){return"Could not find registration for "+name},swiftExpressionArgs:["name"],swiftExpression:'return "Could not find registration for " + name'}]});foam.INTERFACE({package:"foam.box",name:"BoxRegistry",methods:[{name:"doLookup",async:true,type:"foam.box.Box",args:[{name:"name",type:"String"}]},{name:"register",async:true,type:"foam.box.Box",args:[{name:"name",type:"String"},{name:"service",type:"foam.box.BoxService"},{name:"box",type:"foam.box.Box"}]},{name:"unregister",async:true,type:"Void",args:[{name:"name",type:"String"}]}]});
foam.CLASS({package:"foam.box",name:"LocalBoxRegistry",implements:["foam.box.BoxRegistry"],requires:["foam.box.NoSuchNameException","foam.box.ExportBox","foam.box.SubBox"],imports:[{name:"me",key:"me",type:"foam.box.Box"}],properties:[{class:"Map",name:"registry_",hidden:true,}],methods:[{name:"doLookup",code:function doLookup(name){if(this.registry_[name])return this.registry_[name];throw this.NoSuchNameException.create({name:name})},},{name:"register",code:function(name,service,localBox){name=name||foam.next$UID();var box=this.ExportBox.create({localBox:localBox,messengerBox:this.SubBox.create({name:name,delegate:this.me})});this.registry_[name]=box;box.onDetach(function(){if(this.registry_[name]===box)this.unregister(name)}.bind(this));return box},},{name:"unregister",code:function(name){delete this.registry_[name]},}]});
foam.CLASS({package:"foam.box",name:"BoxRegistryBox",extends:"foam.box.LocalBoxRegistry",implements:["foam.box.Box"],requires:["foam.box.SubBoxMessage","foam.box.Message","foam.box.HelloMessage","foam.box.SkeletonBox"],properties:[{class:"FObjectProperty",of:"foam.box.Box",name:"registrySkeleton",factory:function(){return this.SkeletonBox.create({data:this})},}],methods:[{name:"init",code:function(){this.SUPER()}},{name:"send",code:function(msg){if(this.SubBoxMessage.isInstance(msg.object)){var name=msg.object.name;if(this.registry_[name]){msg.object=msg.object.object;this.registry_[name].send(msg)}else{if(msg.attributes.replyBox){msg.attributes.replyBox.send(this.Message.create({object:this.NoSuchNameException.create({name:name})}))}}}else if(this.HelloMessage.isInstance(msg.object)){}else{this.registrySkeleton.send(msg)}},}]});
foam.CLASS({package:"foam.box",name:"ClientBoxRegistry",implements:["foam.box.BoxRegistry"],properties:[{class:"Stub",of:"foam.box.BoxRegistry",name:"delegate"}]});
foam.CLASS({package:"foam.box",name:"PromisedBoxRegistry",properties:[{class:"Promised",of:"foam.box.BoxRegistry",name:"delegate"}]});foam.INTERFACE({package:"foam.box",name:"RegistrySelector",methods:[function select(name,service,box){}]});
foam.CLASS({package:"foam.box",name:"SelectorRegistry",extends:"foam.box.BoxRegistryBox",requires:["foam.box.Box"],exports:["as registry"],classes:[{name:"Registration",properties:[{class:"String",name:"name",},{class:"FObjectProperty",of:"foam.box.BoxRegistry",name:"delegateRegistry",},{class:"String",name:"delegateRegisteredName",},{class:"FObjectProperty",of:"foam.box.Box",name:"delegateRegisteredBox",}]}],properties:[{class:"FObjectProperty",of:"foam.box.RegistrySelector",name:"selector",required:true},{class:"Array",name:"selectorRegistrations_",}],methods:[function register(name,service,box){name=name||foam.next$UID();var delegate=this.selector.select(name,service,box);var delegateRegisteredName=foam.uuid.randomGUID();var delegateRegisteredBox=delegate.register(delegateRegisteredName,null,box);this.SUPER(name,service,delegateRegisteredBox);this.selectorRegistrations_.push(this.Registration.create({name:name,delegateRegistry:delegate,delegateRegisteredName:delegateRegisteredName,delegateRegisteredBox:delegateRegisteredBox}));return delegateRegisteredBox},function unregister(nameOrBox){var delegateRegisteredBox;var inputIsBox=this.Box.isInstance(nameOrBox);if(inputIsBox){delegateRegisteredBox=nameOrBox}else{delegateRegisteredBox=this.registry_[nameOrBox].localBox;this.SUPER(nameOrBox)}var registrations=this.selectorRegistrations_;var delegateRegistry=null;var delegateRegisteredName="";for(var i=0;i<registrations.length;i++){if(registrations[i].delegateRegisteredBox!==delegateRegisteredBox)continue;delegateRegistry=registrations[i].delegateRegistry;delegateRegisteredName=registrations[i].delegateRegisteredName;if(inputIsBox)delete this.registry_[registrations[i].name];break}foam.assert(delegateRegistry,"SelectorRegistry: Expected to find delegate registry");delegateRegistry.unregister(delegateRegisteredName)}]});
foam.CLASS({package:"foam.box",name:"BroadcastRegistry",extends:"foam.box.BoxRegistryBox",requires:["foam.box.Box","foam.box.RoundRobinBox"],exports:["as registry"],classes:[{name:"Registration",properties:[{class:"String",name:"name",},{class:"Array",of:"String",name:"delegateNames",},{class:"FObjectProperty",of:"foam.box.Box",name:"registeredBox",}]}],properties:[{class:"Array",of:"foam.box.BoxRegistryBox",name:"delegates",},{class:"FObjectProperty",of:"foam.box.MultiDelegateBox",name:"dispatchBoxPrototype",factory:function(){return this.RoundRobinBox.create()}},{class:"Array",name:"registrations_",}],methods:[function register(name,service,box){var delegates=this.delegates;var dispatchDelegates=new Array(delegates.length);var dispatchDelegateNames=new Array(delegates.length);for(var i=0;i<delegates.length;i++){var delegateName=dispatchDelegateNames[i]=foam.uuid.randomGUID();dispatchDelegates[i]=delegates[i].register(delegateName,null,box)}var dispatchBox=this.dispatchBoxPrototype.clone(this);dispatchBox.delegates=dispatchDelegates;var ret=this.SUPER(name,service,dispatchBox);this.registrations_.push(this.Registration.create({name:name,delegateNames:dispatchDelegateNames,registeredBox:ret}));return ret},function unregister(nameOrBox){var registeredBox;var inputIsBox=this.Box.isInstance(nameOrBox);if(inputIsBox){registeredBox=nameOrBox}else{registeredBox=this.registry_[nameOrBox].exportBox;this.SUPER(nameOrBox)}var registration;var registrations=this.registrations_;for(var i=0;i<registrations.length;i++){if(registrations[i].registeredBox!==registeredBox)continue;if(inputIsBox)delete this.registry_[registrations[i].name];registration=registrations[i];break}foam.assert(registration,"BroadcastRegistry expects to find registration");var delegates=this.delegates;for(var i=0;i<delegates.length;i++){delegates[i].unregister(registration.delegateNames[i])}}]});
foam.CLASS({package:"foam.box",name:"LookupBox",extends:"foam.box.ProxyBox",requires:["foam.box.ClientBoxRegistry","foam.box.AnonymousBox"],properties:[{class:"String",name:"name"},{name:"parentBox"},{class:"FObjectProperty",of:"foam.box.BoxRegistry",name:"registry",transient:true,factory:function(){return this.ClientBoxRegistry.create({delegate:this.parentBox})},},{name:"delegate",transient:true,factory:function(){return this.registry.doLookup(this.name)},}],methods:[function send(msg){var self=this;var replyBox=msg.attributes.replyBox.localBox;msg.attributes.replyBox.localBox=this.AnonymousBox.create({f:function(m){if(foam.core.Exception.isInstance(m.object)){self.delegate=undefined}replyBox&&replyBox.send(m)}});this.delegate.send(msg)}]});
foam.CLASS({package:"foam.box",name:"NamedBox",extends:"foam.box.ProxyBox",requires:["foam.box.LookupBox"],axioms:[foam.pattern.Multiton.create({property:"name"})],properties:[{class:"String",name:"name"},{name:"delegate",transient:true,factory:function(){return this.LookupBox.create({name:this.getBaseName(),parentBox:this.getParentBox()})},}],methods:[{name:"getParentBox",type:"foam.box.Box",code:function(){return this.cls_.create({name:this.name.substring(0,this.name.lastIndexOf("/"))},this)},},{name:"getBaseName",type:"String",code:function(){return this.name.substring(this.name.lastIndexOf("/")+1)},}]});
foam.CLASS({package:"foam.box",name:"ReplyBox",extends:"foam.box.ProxyBox",imports:[{name:"registry",key:"registry",type:"foam.box.BoxRegistry"}],properties:[{class:"String",name:"id",factory:function(){return foam.next$UID()},}],methods:[{name:"send",code:function send(msg){this.registry.unregister(this.id);this.delegate.send(msg)},}]});
foam.CLASS({package:"foam.box",name:"FunctionBox",implements:["foam.box.Box"],properties:[{class:"Function",swiftRequiresEscaping:true,name:"fn"}],methods:[{name:"send",code:function send(m){this.fn(m.object)},}]});
foam.CLASS({package:"foam.box",name:"RPCReturnMessage",extends:"foam.box.Message",properties:[{class:"Object",name:"data"}]});
foam.CLASS({package:"foam.box",name:"RPCErrorMessage",implements:["foam.core.Exception"],properties:[{class:"Object",name:"data"},{class:"String",name:"message",transient:true,getter:function(){return this.data&&this.data.message}}]});
foam.CLASS({package:"foam.box",name:"SubscribeMessage",properties:[{name:"topic"},{name:"destination"}]});
foam.CLASS({package:"foam.box",name:"RPCReturnBox",implements:["foam.box.Box"],requires:["foam.box.RPCReturnMessage","foam.box.RPCErrorMessage"],properties:[{name:"promise",factory:function(){return new Promise(function(resolve,reject){this.resolve_=resolve;this.reject_=reject}.bind(this))},},{name:"resolve_"},{name:"reject_"},{class:"Object",name:"semaphore",},{class:"Object",name:"message",type:"foam.box.Message"}],methods:[{name:"send",code:function send(msg){if(this.RPCReturnMessage.isInstance(msg.object)){this.resolve_(msg.object.data);return}if(foam.core.Exception.isInstance(msg.object)){this.reject_(msg.object);return}if(msg.object instanceof Error){this.reject_(msg.object);return}this.__context__.warn("Invalid message to RPCReturnBox.")},}]});
foam.CLASS({package:"foam.box",name:"RPCMessage",extends:"foam.box.Message",properties:[{class:"String",name:"name"},{class:"Array",name:"args"}]});
foam.CLASS({package:"foam.box.socket",name:"SocketClientBox",implements:["foam.box.Box"],properties:[{class:"String",name:"host"},{class:"Int",name:"port"},{class:"String",name:"serviceName"}],methods:[{name:"send",}]});
foam.CLASS({package:"foam.box.socket",name:"SocketClientReplyBox",extends:"foam.box.ReplyBox",properties:[{class:"String",name:"replyBoxId"},{name:"created",class:"DateTime",}],methods:[{name:"send",}]});
foam.CLASS({package:"foam.box.socket",name:"SocketConnectionBoxManager",implements:["foam.nanos.NanoService"],properties:[{class:"Int",name:"soTimeout",value:6e4},{class:"Int",name:"connectTimeout",value:6e4},{class:"Map",name:"boxes",},{name:"logger",class:"FObjectProperty",of:"foam.nanos.logger.Logger",visibility:"HIDDEN",transient:true,javaCloneProperty:"//noop",}],methods:[{name:"add",args:[{name:"box",type:"SocketConnectionBox"}],},{name:"remove",args:[{name:"box",type:"SocketConnectionBox"}],},{name:"makeKey",type:"String",args:[{name:"host",type:"String"},{name:"port",type:"int"}],},{name:"get",synchronized:true,type:"foam.box.Box",args:[{name:"x",type:"X"},{name:"host",type:"String"},{name:"port",type:"int"}],},{name:"getReplyBox",type:"foam.box.Box",synchronized:true,args:[{name:"x",type:"X"},{name:"key",type:"String"}],},{name:"removeReplyBox",args:[{name:"box",type:"SocketConnectionReplyBox"}],},{name:"start",}]});
foam.CLASS({package:"foam.box.socket",name:"SocketServer",implements:["foam.nanos.NanoService"],properties:[{class:"Int",name:"port",},{class:"String",name:"threadPoolName",value:"threadPool"},{class:"Int",name:"soTimeout",value:6e4},{name:"logger",class:"FObjectProperty",of:"foam.nanos.logger.Logger",visibility:"HIDDEN",transient:true,javaCloneProperty:"//noop",}],methods:[{name:"start",}]});
foam.CLASS({package:"foam.box.socket",name:"SslContextFactory",properties:[{class:"String",name:"storeType",value:"PKCS12"},{class:"String",name:"protocol",value:"SSL"},{class:"String",name:"keyStorePath"},{class:"String",name:"keyStorePass"},{class:"String",name:"trustStorePath"},{class:"String",name:"trustStorePass"},{class:"FObjectProperty",name:"logger",of:"foam.nanos.logger.Logger",visibility:"HIDDEN",transient:true,javaCloneProperty:"//noop",},{class:"Boolean",name:"enableSSL",value:false}],methods:[{name:"getKeyManagers",args:[{name:"storePath",type:"String"},{name:"storePass",type:"String"}],},{name:"getTrustManagers",args:[{name:"storePath",type:"String"},{name:"storePass",type:"String"}],},{name:"getKeystore",args:[{name:"storePath",type:"String"},{name:"storePass",type:"String"}],},{name:"getSSLContext",},{name:"getSSLContextByAlias",args:[{name:"keyAlias",type:"String"}],}]});
foam.CLASS({package:"foam.dao",name:"BaseClientDAO",extends:"foam.dao.AbstractDAO",properties:[{class:"Stub",of:"foam.dao.DAO",name:"delegate",methods:["put_","remove_","removeAll_","select_","listen_","find_","cmd_"]}]});
foam.CLASS({package:"foam.dao",name:"BaseNotificationClientDAO",extends:"foam.dao.AbstractDAO",properties:[{class:"Stub",of:"foam.dao.DAO",name:"delegate",methods:[],notifications:["put_","remove_","removeAll_","cmd_","select_","listen_","find_"]}]});
foam.CLASS({package:"foam.dao",name:"MergeBox",extends:"foam.box.ProxyBox",properties:[{class:"Int",name:"delay",value:100},{name:"msg",transient:true},{class:"Array",name:"queue",transient:true}],methods:[function send(m){if(!this.timeout){}}],listeners:[function doSend(){var queue=this.queue;this.queue=undefined;this.timeout=undefined}]});
foam.CLASS({package:"foam.dao",name:"ResetSink",extends:"foam.dao.ProxySink",methods:[{name:"put",code:function(obj,sub){this.reset(sub)},},{name:"remove",code:function(obj,sub){this.reset(sub)},}]});
foam.CLASS({package:"foam.dao",name:"MergedResetSink",extends:"foam.dao.ResetSink",methods:[{name:"reset",code:function(sub){this.doReset(sub)},}],listeners:[{name:"doReset",isMerged:true,mergeDelay:200,code:function(sub){this.delegate.reset(sub)},}]});
foam.CLASS({package:"foam.dao",name:"ClientDAO",extends:"foam.dao.BaseClientDAO",requires:["foam.box.SkeletonBox","foam.core.Serializable","foam.dao.ArraySink","foam.dao.ClientSink"],methods:[{name:"put_",code:function put_(x,obj){return this.SUPER(null,obj)},},{name:"remove_",code:function remove_(x,obj){return this.SUPER(null,obj)},},{name:"find_",code:function find_(x,key){return this.SUPER(null,key)},},{name:"select_",code:function select_(x,sink,skip,limit,order,predicate){if(predicate===foam.mlang.predicate.True.create())predicate=null;if(!skip)skip=0;if(foam.Undefined.isInstance(limit))limit=Number.MAX_SAFE_INTEGER;if(!this.Serializable.isInstance(sink)){var self=this;return this.SUPER(null,foam.dao.ArraySink.create(),skip,limit,order,predicate).then(function(result){var items=result.array;if(!sink)return result;var sub=foam.core.FObject.create();var detached=false;sub.onDetach(function(){detached=true});for(var i=0;i<items.length;i++){if(detached)break;sink.put(items[i],sub)}sink.eof();return sink})}return this.SUPER(null,sink,skip,limit,order,predicate)},},{name:"removeAll_",code:function removeAll_(x,skip,limit,order,predicate){if(predicate===foam.mlang.predicate.True.create())predicate=null;if(!skip)skip=0;if(foam.Undefined.isInstance(limit))limit=Number.MAX_SAFE_INTEGER;return this.SUPER(null,skip,limit,order,predicate)},},{name:"cmd_",code:function cmd_(x,obj){return this.SUPER(null,obj)},},{name:"listen_",code:function listen_(x,sink,predicate){this.SUPER(null,sink,predicate);return foam.core.FObject.create()},}]});
foam.CLASS({package:"foam.dao",name:"NotificationClientDAO",extends:"foam.dao.BaseNotificationClientDAO",requires:["foam.box.SkeletonBox","foam.core.Serializable","foam.dao.ArraySink","foam.dao.ClientSink"],methods:[{name:"put_",code:function put_(x,obj){return this.SUPER(null,obj)},},{name:"remove_",code:function remove_(x,obj){return this.SUPER(null,obj)},},{name:"find_",code:function find_(x,key){return null},},{name:"select_",code:function select_(x,sink,skip,limit,order,predicate){sink&&sink.eof;return sink},},{name:"removeAll_",code:function removeAll_(x,skip,limit,order,predicate){if(predicate===foam.mlang.predicate.True.create())predicate=null;if(!skip)skip=0;if(foam.Undefined.isInstance(limit))limit=Number.MAX_SAFE_INTEGER;return this.SUPER(null,skip,limit,order,predicate)},},{name:"cmd_",code:function cmd_(x,obj){return this.SUPER(null,obj)},}]});
foam.CLASS({package:"foam.dao",name:"PollingClientDAO",extends:"foam.dao.ClientDAO",requires:["foam.dao.ArraySink"],methods:[function put_(x,obj){var self=this;return this.SUPER(x,obj).then(function(o){self.on.put.pub(o);return o})},function remove_(x,obj){var self=this;return this.SUPER(x,obj).then(function(o){self.on.remove.pub(obj);return o})},function removeAll_(x,skip,limit,order,predicate){this.SUPER(x,skip,limit,order,predicate);this.on.reset.pub()}]});
foam.CLASS({package:"foam.dao",name:"PurgeRecordCmd",properties:[{class:"Object",name:"id"}]});
foam.CLASS({package:"foam.dao",name:"StreamingClientDAO",extends:"foam.dao.BaseClientDAO",requires:["foam.dao.ArraySink","foam.dao.BoxDAOListener"],imports:["registry"],classes:[{name:"StreamingReplyBox",implements:["foam.box.Box"],imports:["registry"],properties:[{name:"id",factory:function(){return foam.next$UID()}},{class:"FObjectProperty",of:"foam.dao.Sink",name:"sink"},{class:"Boolean",name:"detachOnEOF"},{name:"promise",factory:function(){var self=this;return new Promise(function(resolve,reject){self.resolve_=resolve;self.reject_=reject})}},{name:"sinkSub",factory:function(){var sub=foam.core.FObject.create();sub.onDetach(this.unregisterSelf);return sub}},"resolve_","reject_"],methods:[function send(msg){switch(msg.object.name){case"put":this.sink.put(msg.object.obj,this.sinkSub);break;case"remove":this.sink.remove(msg.object.obj,this.sinkSub);break;case"eof":this.sink.eof();this.resolve_(this.sink);if(this.detachOnEOF)this.sinkSub.detach();break;case"reset":this.sink.reset();break}}],listeners:[function registerSelf(){return this.exportBox_=this.registry.register(this.id,null,this)},function unregisterSelf(){this.registry.unregister(this.id)}]}],methods:[function put_(x,obj){return this.SUPER(null,obj)},function remove_(x,obj){return this.SUPER(null,obj)},function find_(x,key){return this.SUPER(null,key)},function select_(x,sink,skip,limit,order,predicate){var replyBox=this.StreamingReplyBox.create({sink:sink||this.ArraySink.create(),detachOnEOF:true});var promise=replyBox.promise;var registeredReplyBox=replyBox.registerSelf();this.SUPER(null,this.BoxDAOListener.create({box:registeredReplyBox}),skip,limit,order,predicate).catch(function(error){replyBox.reject_(error)});return promise},function listen_(x,sink,predicate){var replyBox=this.StreamingReplyBox.create({sink:sink||this.ArraySink.create()});this.SUPER(null,this.BoxDAOListener.create({box:replyBox.registerSelf()}),predicate);return replyBox.sinkSub}]});
foam.CLASS({package:"foam.dao",name:"RequestResponseClientDAO",extends:"foam.dao.BaseClientDAO",requires:["foam.core.Serializable"],methods:[function put_(x,obj){var self=this;return this.SUPER(null,obj).then(function(obj){self.on.put.pub(obj);return obj})},function remove_(x,obj){var self=this;return this.SUPER(null,obj).then(function(o){self.on.remove.pub(obj);return o})},function find_(x,key){return this.SUPER(null,key)},function select_(x,sink,skip,limit,order,predicate){if(predicate===foam.mlang.predicate.True.create())predicate=null;if(!skip)skip=0;if(!limit)limit=Number.MAX_SAFE_INTEGER;if(!this.Serializable.isInstance(sink)){var self=this;return this.SUPER(null,foam.dao.ArraySink.create(),skip,limit,order,predicate).then(function(result){var items=result.array;if(!sink)return result;var sub=foam.core.FObject.create();var detached=false;sub.onDetach(function(){detached=true});for(var i=0;i<items.length;i++){if(detached)break;sink.put(items[i],sub)}sink.eof();return sink})}return this.SUPER(null,sink,skip,limit,order,predicate)},function removeAll_(x,skip,limit,order,predicate){var self=this;if(predicate===foam.mlang.predicate.True.create())predicate=null;if(!skip)skip=0;if(foam.Undefined.isInstance(limit))limit=Number.MAX_SAFE_INTEGER;return this.SUPER(null,skip,limit,order,predicate).then(function(){self.on.reset.pub();return})},function listen_(x,sink,predicate){return this.__context__.lookup("foam.dao.AbstractDAO").prototype.listen_.call(this,x,sink,predicate)},{name:"cmd_",code:function cmd_(x,obj){if(foam.dao.DAO.RESET_CMD===obj){this.on.reset.pub();return true}if(foam.dao.DAO.PURGE_CMD!==obj){return this.SUPER(x,obj)}return obj}}]});
foam.CLASS({package:"foam.box",name:"InvalidMessageException",swiftImplements:["Error"],extends:"foam.core.FOAMException",properties:["messageType"]});
foam.CLASS({package:"foam.box",name:"EventMessage",properties:[{class:"Array",name:"args"}]});
foam.CLASS({package:"foam.box",name:"EventDispatchBox",implements:["foam.box.Box"],requires:["foam.box.EventMessage","foam.box.InvalidMessageException"],properties:[{name:"target"}],methods:[function send(msg){if(!this.EventMessage.isInstance(msg.object)){throw this.InvalidMessageException.create({messageType:message.cls_.id})}this.target.pub.apply(this.target,msg.object.args)}]});
foam.CLASS({package:"foam.box",name:"SkeletonBox",implements:["foam.box.Box"],flags:["js","swift"],requires:["foam.box.InvalidMessageException","foam.box.Message","foam.box.RPCErrorMessage","foam.box.RPCMessage","foam.box.RPCReturnMessage"],properties:[{name:"data"}],methods:[{name:"call",args:[{name:"message",type:"foam.box.Message"}],code:function(message){var p;try{var method=this.data.cls_.getAxiomByName(message.object.name);var args=message.object.args.slice();if(method&&method.args&&method.args[0]&&method.args[0].name=="x"){var x=this.__context__.createSubContext({message:message});args[0]=x}p=this.data[message.object.name].apply(this.data,args)}catch(e){message.attributes.replyBox&&message.attributes.replyBox.send(this.Message.create({object:this.RPCErrorMessage.create({data:e.message})}));return}var replyBox=message.attributes.replyBox;var self=this;if(p instanceof Promise){p.then(function(data){replyBox.send(self.Message.create({object:self.RPCReturnMessage.create({data:data})}))},function(error){message.attributes.replyBox&&message.attributes.replyBox.send(self.Message.create({object:self.RPCErrorMessage.create({data:error&&error.toString()})}))})}else{replyBox&&replyBox.send(this.Message.create({object:this.RPCReturnMessage.create({data:p})}))}},},{name:"send",code:function(message){if(this.RPCMessage.isInstance(message.object)){this.call(message);return}throw this.InvalidMessageException.create({messageType:message.cls_&&message.cls_.id})},}]});
foam.CLASS({package:"foam.box",name:"NullBox",implements:["foam.box.Box"],methods:[{name:"send",code:function(){},}]});
foam.CLASS({package:"foam.box",name:"SocketBox",extends:"foam.box.ProxyBox",requires:["foam.box.SocketConnectBox"],axioms:[foam.pattern.Multiton.create({property:"address"})],properties:[{class:"String",name:"name"},{class:"String",name:"address"},{name:"delegate",transient:true,factory:function(){return foam.box.SocketConnectBox.create({address:this.address},this)},}]});
foam.CLASS({package:"foam.box",name:"SocketBox2",imports:["socketService"],axioms:[foam.pattern.Multiton.create({property:"address"})],properties:[{class:"String",name:"address"},{name:"promise",transient:true,factory:function(){}}],methods:[function send(m){}],listeners:[function onConnect(){this.socketService.addSocket(this);this.send(this.RegisterSelfMessage.create({name:this.me.name}));this.connect.pub()},function onError(){}]});
foam.CLASS({package:"foam.box",name:"SocketConnectBox",extends:"foam.box.PromisedBox",requires:[{flags:["js"],path:"foam.box.RawSocketBox"}],properties:[{class:"String",name:"address"},{name:"delegate",factory:function(){return foam.lookup("foam.net.node.Socket").create(null,this).connectTo(this.address).then(function(s){return this.RawSocketBox.create({socket:s})}.bind(this))},}]});
foam.CLASS({package:"foam.box",name:"RawSocketBox",implements:["foam.box.Box"],requires:["foam.box.ReplyBox"],imports:["me","registry"],properties:[{class:"Object",name:"socket",}],classes:[{name:"JSONOutputter",extends:"foam.json.Outputter",requires:["foam.box.ReturnBox"],imports:["me"],methods:[function output(o){if(o===this.me){return this.SUPER(this.ReturnBox.create())}return this.SUPER(o)}]}],methods:[{name:"send",code:function send(msg){var replyBox=msg.attributes.replyBox;if(replyBox){msg.attributes.replyBox=this.__context__.registry.register(null,null,msg.attributes.replyBox)}try{this.socket.write(msg);if(replyBox){msg.attributes.replyBox=replyBox}}catch(error){replyBox&&replyBox.send(foam.box.Message.create({object:error}))}}}]});
foam.CLASS({package:"foam.box",name:"SendFailedError",extends:"foam.box.Message",properties:[{name:"original"},{name:"error"}]});
foam.CLASS({package:"foam.box",name:"RegisterSelfMessage",extends:"foam.box.Message",properties:[{class:"String",name:"name"}]});
foam.CLASS({package:"foam.box",name:"RawWebSocketBox",implements:["foam.box.Box"],requires:["foam.box.ReplyBox"],imports:[{name:"me",key:"me",type:"foam.box.Box"},{key:"registry",name:"registry",type:"foam.box.BoxRegistry"}],properties:[{class:"Object",name:"socket",}],classes:[foam.core.InnerClass.create({generateJava:false,model:{name:"JSONOutputter",extends:"foam.json.Outputter",requires:["foam.box.ReturnBox"],imports:["me"],methods:[function output(o){if(o===this.me){return this.SUPER(this.ReturnBox.create())}return this.SUPER(o)}]}})],methods:[{name:"send",code:function send(msg){var replyBox=msg.attributes.replyBox;var payload=this.JSONOutputter.create().copyFrom(foam.json.Network).stringify(msg);try{this.socket.send(payload)}catch(e){replyBox&&replyBox.send(foam.box.Message.create({object:e}))}},}],});
foam.CLASS({package:"foam.box",name:"ReturnBox",implements:["foam.box.Box"],methods:[{name:"send",code:function(message){this.__context__.returnBox.send(message)},}]});
foam.CLASS({package:"foam.box",name:"RawMessagePortBox",implements:["foam.box.Box"],requires:["foam.json.Outputter","foam.box.ReplyBox"],properties:[{name:"port"},{class:"FObjectProperty",of:"foam.json.Outputter",name:"outputter",factory:function(){return this.Outputter.create().copyFrom(foam.json.Network)}}],methods:[function send(message){var replyBox=message.attributes.replyBox;if(replyBox){message.attributes.replyBox=this.__context__.registry.register(null,null,message.attributes.replyBox);replyBox=this.ReplyBox.create({id:message.attributes.replyBox.name})}var payload=this.outputter.stringify(message);if(replyBox){message.attributes.replyBox=replyBox}this.port.postMessage(payload)}]});
foam.CLASS({package:"foam.box",name:"WebSocketBox",requires:["foam.net.web.WebSocket","foam.box.Message","foam.box.RawWebSocketBox"],imports:["webSocketService","me","window"],axioms:[foam.pattern.Multiton.create({property:"uri"})],properties:[{name:"uri"},{name:"delegate",factory:function(){var ws=this.WebSocket.create({uri:this.prepareURL(this.uri)});return ws.connect().then(function(ws){ws.disconnected.sub(function(sub){sub.detach();this.delegate=undefined}.bind(this));this.webSocketService.addSocket(ws);return this.RawWebSocketBox.create({socket:ws})}.bind(this),function(e){this.delegate=undefined}.bind(this))}}],methods:[function prepareURL(url){if(this.window&&url.indexOf(":")==-1){var protocol="ws://";if(this.window.location.protocol==="https:"){protocol="wss://"}return protocol+this.window.location.hostname+(this.window.location.port?":"+(parseInt(this.window.location.port)+1):"")+"/"+url}return url},{name:"send",code:function send(msg){this.delegate.then(function(d){d.send(msg)},function(e){if(msg.attributes.replyBox)msg.attributes.replyBox.send(foam.box.Message.create({object:e}))})}}]});
foam.CLASS({package:"foam.box",name:"ClassWhitelistContext",exports:["lookup"],properties:[{class:"StringArray",name:"whitelist"},{name:"whitelist_",expression:function(whitelist){var w={};for(var i=0;i<whitelist.length;i++){w[whitelist[i]]=true}return w},swiftExpressionArgs:["whitelist"],swiftExpression:`
var w = Set<String>()
for i in whitelist {
w.insert(i)
}
return w
`}],methods:[{class:"ContextMethod",name:"lookup",args:[{type:"Context",name:"X"},{type:"String",name:"id"}],code:function(X,id){if(!this.whitelist_[id]){throw new Error('Class "'+id+'" is not whitelisted.')}return this.__context__.lookup.call(X,id)},}]});
foam.CLASS({package:"foam.box",name:"LoggedLookupContext",exports:["lookup"],properties:[{class:"Map",name:"record"}],methods:[{class:"ContextMethod",name:"lookup",args:[{type:"Context",name:"X"},{type:"String",name:"id"}],code:function(X,id,opt_suppress){this.record[id]=id;return this.__context__.lookup.call(X,id,opt_suppress)},}]});
foam.CLASS({package:"foam.box",name:"Context",swiftName:"BoxContext",requires:["foam.box.BoxRegistryBox","foam.box.NamedBox","foam.box.ClassWhitelistContext","foam.box.LoggedLookupContext",{path:"foam.net.WebSocketService",flags:["js"]}],exports:["creationContext","me","messagePortService","registry","root","socketService","webSocketService"],properties:[{name:"messagePortService",hidden:true,factory:function(){var model=this.__context__.maybeLookup("foam.messageport.MessagePortService");if(model){return model.create({delegate:this.registry},this)}}},{name:"socketService",hidden:true,factory:function(){var model=this.__context__.maybeLookup("foam.net.node.SocketService");if(model){return model.create({port:Math.floor(1e4+Math.random()*1e4),delegate:this.registry},this)}},},{name:"webSocketService",hidden:true,factory:function(){return this.WebSocketService.create({delegate:this.registry})}},{class:"FObjectProperty",of:"foam.box.Box",name:"registry",hidden:true,factory:function(){return this.BoxRegistryBox.create()},},{class:"FObjectProperty",of:"foam.box.Box",name:"root",hidden:true,postSet:function(_,root){foam.box.NamedBox.create({name:""}).delegate=root},},{class:"String",name:"myname",hidden:true,factory:function(){return foam.isServer?"/proc/"+require("process").pid+"/"+foam.uuid.randomGUID():"/com/foamdev/anonymous/"+foam.uuid.randomGUID()}},{name:"me",hidden:true,transient:true,factory:function(){var me=this.NamedBox.create({name:this.myname});me.delegate=this.registry;return me},},{class:"Boolean",name:"unsafe",value:true},{class:"StringArray",name:"classWhitelist"},{name:"creationContext",hidden:true,factory:function(){if(this.unsafe){console.warn("**** Boxes are running in UNSAFE mode.  Turn this off before you go to production!");return this.LoggedLookupContext.create(null,this).__subContext__}return this.ClassWhitelistContext.create({whitelist:this.classWhitelist},this).__subContext__},}]});
foam.CLASS({package:"foam.box",name:"BoxService",properties:[{class:"Class",name:"server"},{class:"Class",name:"client"},{class:"FObjectProperty",of:"foam.box.BoxService",name:"next"}],methods:[{name:"serverBox",args:[{name:"box",type:"foam.box.Box"}],type:"foam.box.Box",code:function serverBox(box){box=this.next?this.next.serverBox(box):box;return this.server?this.server.create({delegate:box}):box},},{name:"clientBox",args:[{name:"box",type:"foam.box.Box"}],type:"foam.box.Box",code:function(box){box=this.client?this.client.create({delegate:box}):box;return this.next?this.next.clientBox(box):box},}]});
foam.CLASS({package:"foam.box",name:"HTTPReplyBox",implements:["foam.box.Box"],imports:[],methods:[{name:"send",code:function(m){throw"unimplemented"},}]});
foam.CLASS({package:"foam.box",name:"AuthenticatedBox",extends:"foam.box.ProxyBox",imports:["idToken"],methods:[function send(m){m.attributes.idToken=this.idToken;this.SUPER(m)}]});foam.ENUM({package:"foam.box",name:"HTTPAuthorizationType",values:[{name:"NONE",label:"None",ordinal:0},{name:"BASIC",label:"Basic",ordinal:1},{name:"BEARER",label:"Bearer",ordinal:2},{name:"OAUTH",label:"OAuth",ordinal:3}]});
foam.CLASS({package:"foam.box",name:"HTTPException",implements:["foam.core.Exception"],properties:["response"]});
foam.CLASS({package:"foam.box",name:"HTTPBox",implements:["foam.box.Box"],requires:[{path:"foam.json.Parser",flags:["js"]},{path:"foam.net.web.HTTPRequest",flags:["js"]},{path:"foam.json.Outputter",flags:["js"]},{path:"foam.swift.parse.json.FObjectParser",flags:["swift"]},{name:"SwiftOutputter",path:"foam.swift.parse.json.output.Outputter",flags:["swift"]},"foam.box.HTTPReplyBox","foam.box.HTTPException","foam.box.Message"],imports:["creationContext",{name:"me",key:"me",type:"foam.box.Box"},"sessionID as jsSessionID","window"],constants:[{name:"SESSION_KEY",value:"sessionId",type:"String"}],properties:[{class:"String",name:"sessionID"},{class:"String",name:"url"},{class:"String",name:"method",value:"POST"},{name:"origin",class:"String",factory:function(){return this.window&&this.window.location.origin},},{class:"Enum",of:"foam.box.HTTPAuthorizationType",name:"authorizationType",value:foam.box.HTTPAuthorizationType.NONE},{class:"FObjectProperty",of:"foam.json.Parser",name:"parser",generateJava:false,factory:function(){return this.Parser.create({strict:true,creationContext:this.url.indexOf(":")==-1?this.__context__:this.creationContext})},},{class:"FObjectProperty",of:"foam.json.Outputter",name:"outputter",generateJava:false,factory:function(){return this.Outputter.create().copyFrom(foam.json.Network)}},{class:"Int",name:"connectTimeout",value:0},{class:"Int",name:"readTimeout",value:0}],methods:[function prepareURL(url){if(this.window&&url.indexOf(":")==-1){return this.window.location.origin+"/"+url}return url},{name:"send",code:function(msg){msg.attributes[this.SESSION_KEY]=this.jsSessionID;var replyBox=msg.attributes.replyBox;msg.attributes.replyBox=this.getReplyBox();var payload=this.outputter.stringify(msg);msg.attributes.replyBox=replyBox;var headers={"Content-Type":"application/json; charset=utf-8",Origin:this.origin};if(this.authorizationType===foam.box.HTTPAuthorizationType.BEARER){headers["Authorization"]="BEARER "+this.jsSessionID}var req=this.HTTPRequest.create({url:this.prepareURL(this.url),method:this.method,payload:payload,headers:headers}).send();req.then(resp=>{return resp.payload}).then(p=>{return this.parser.aparse(p)}).then(rmsg=>{rmsg&&replyBox&&replyBox.send(rmsg)},function(r){replyBox&&replyBox.send(foam.box.Message.create({object:foam.box.HTTPException.create({response:r})}))})},},{name:"getReplyBox",type:"foam.box.Box",code:function(){return this.HTTPReplyBox.create()},},{name:"getConnection",},{name:"getResponseMessage",args:[{name:"conn",type:"java.net.HttpURLConnection"}],}]});
foam.CLASS({package:"foam.box",name:"MessagePortBox",extends:"foam.box.ProxyBox",requires:["foam.box.RawMessagePortBox","foam.box.RegisterSelfMessage","foam.box.Message","foam.json.Outputter"],imports:["me","messagePortService"],properties:[{name:"target"},{name:"delegate",factory:function(){var channel=new MessageChannel;this.messagePortService.addPort(channel.port1);this.target.postMessage(channel.port2,[channel.port2]);channel.port1.postMessage(this.outputter.stringify(this.Message.create({object:this.RegisterSelfMessage.create({name:this.me.name})})));return this.RawMessagePortBox.create({port:channel.port1})}},{class:"FObjectProperty",of:"foam.json.Outputter",name:"outputter",factory:function(){return this.Outputter.create().copyFrom(foam.json.Network)}}]});
foam.CLASS({package:"foam.box",name:"ForwardedMessage",properties:[{class:"FObjectProperty",of:"foam.box.Box",name:"destination"},{class:"FObjectProperty",name:"payload"}]});
foam.CLASS({package:"foam.box",name:"ForwardBox",extends:"foam.box.ProxyBox",requires:["foam.box.ForwardedMessage"],properties:[{name:"destination"}],methods:[function send(m){m.object=this.ForwardedMessage.create({destination:this.destination,payload:m.object});this.SUPER(m)}]});
foam.CLASS({package:"foam.box",name:"ForwardingBox",implements:["foam.box.Box"],requires:["foam.box.ForwardedMessage"],methods:[function send(m){if(!this.ForwardedMessage.isInstance(m.object))throw foam.box.InvalidMessageException.create();var wrapper=m.object;m.object=wrapper.payload;wrapper.destination.describe();wrapper.destination.send(m)}]});
foam.CLASS({package:"foam.box",name:"SessionReplyBox",extends:"foam.box.ProxyBox",requires:["foam.box.RPCErrorMessage"],imports:["auth","ctrl","group","loginSuccess","requestLogin","sessionTimer","subject","window"],messages:[{name:"REFRESH_MSG",message:"Your session has expired. The page will now be refreshed so that you can log in again."}],properties:[{class:"FObjectProperty",name:"msg",type:"foam.box.Message"},{class:"FObjectProperty",name:"clientBox",type:"foam.box.Box"}],methods:[{name:"send",code:async function send(msg){var self=this;if(this.RPCErrorMessage.isInstance(msg.object)&&msg.object.data.id==="foam.nanos.auth.AuthenticationException"){var promptlogin=await this.auth.check(null,"auth.promptlogin");var authResult=await this.auth.check(null,"*");if(this.loginSuccess&&(!promptlogin||authResult)){if(this.ctrl)this.ctrl.remove();this.loginSuccess=false;alert(this.REFRESH_MSG);(this.window||window).location.reload();return}this.requestLogin().then(function(){self.clientBox.send(self.msg)})}else{if(this.group&&this.group.id!==""&&this.group.softSessionLimit!==0){this.sessionTimer.startTimer(this.group.softSessionLimit)}this.delegate.send(msg)}},}]});
foam.CLASS({package:"foam.box",name:"SessionClientBox",extends:"foam.box.ProxyBox",requires:["foam.box.SessionReplyBox"],imports:["sessionID as jsSessionID"],constants:[{name:"SESSION_KEY",value:"sessionId",type:"String"}],properties:[{class:"String",name:"sessionID",factory:function(){return this.jsSessionID}}],methods:[{name:"send",code:function send(msg){msg.attributes[this.SESSION_KEY]=this.sessionID;msg.attributes.replyBox.localBox=this.SessionReplyBox.create({msg:msg,clientBox:this,delegate:msg.attributes.replyBox.localBox});this.delegate.send(msg)},}]});
foam.CLASS({package:"foam.box",name:"AuthServiceClientBox",extends:"foam.box.ProxyBox",imports:["sessionID"],constants:[{name:"SESSION_KEY",value:"sessionId"}],methods:[{name:"send",code:function send(msg){msg.attributes[this.SESSION_KEY]=this.sessionID;this.delegate.send(msg)}}]});
foam.CLASS({package:"foam.box",name:"OneTimeBox",extends:"foam.box.ProxyBox",methods:[{name:"send",code:function(msg){this.detach();this.SUPER(msg)}}]});
foam.CLASS({package:"foam.box",name:"ExportBox",implements:["foam.box.Box"],properties:[{class:"FObjectProperty",of:"foam.box.Box",networkTransient:true,name:"localBox",},{class:"FObjectProperty",of:"foam.box.Box",name:"messengerBox"}],methods:[{name:"outputJSON",code:function(outputter){outputter.output(this.messengerBox)}},{name:"send",code:function(msg){this.localBox.send(msg)},}]});
foam.CLASS({package:"foam.nanos.menu",name:"MenuToolBar",extends:"foam.u2.View",implements:["foam.mlang.Expressions"],imports:["menuDAO","pushMenu"],requires:["foam.nanos.menu.Menu"],css:`
^ {
width: auto;
}
^title {
margin: 24px;
font-size: 2.4rem;
font-weight: 900;
}
^options {
display: flex;
flex-direction: row;
justify-content: center;
align-items: center;
padding: 0 26px 32px 26px;
}
^option {
display: flex;
flex-direction: column;
align-items: center;
width: 96px;
height: 118px;
padding-bottom: 5px;
padding-top: 15px;
border-radius: 3px;
box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.16);
border: solid 1px #edf0f5;
}
^option:hover {
border: solid 1px #604aff;
cursor: pointer;
}
^option-title {
text-align: center;
font-size: 1.2rem;
font-weight: 600;
line-height: 1.5;
}
^option-icon-container {
display: flex;
justify-content: center;
align-items: center;
height: 62px;
width: 62px;
margin-bottom: 8px;
}
^option-icon {
width: 50px;
height: 50px;
}
`,properties:[{class:"String",name:"classification"},{class:"String",name:"parent"},{class:"String",name:"title"},{class:"foam.dao.DAOProperty",name:"dao",factory:function(){return this.menuDAO.where(this.AND(this.STARTS_WITH(this.Menu.ID,this.classification),this.EQ(this.Menu.PARENT,this.parent),this.NEQ(this.Menu.ID,`${this.classification}.toolbar`)))}},{class:"Int",name:"availableMenuCount",expression:async function(dao){let count=await dao.select(this.Count.create());return count.value}}],methods:[async function render(){var self=this;if(await this.availableMenuCount===1){this.dao.select().then(res=>{self.pushMenu(res.array[0].id)});return}this.addClass(this.myClass()).start().addClass(this.myClass("title")).attr("name",this.myClass("title")).translate(this.classification+".title",this.title).end().start().addClass(this.myClass("options")).select(this.dao$proxy,function(menu){return this.E().style({padding:"0 8px 0"}).start().addClass(self.myClass("option")).on("click",function(){self.pushMenu(menu.id)}).start().addClass(self.myClass("option-icon-container")).start("img").addClass(self.myClass("option-icon")).attrs({src:menu.icon,name:menu.id+"Icon"}).end().end().start().addClass(self.myClass("option-title")).attr("name",menu.id+"Label").translate(menu.id+".label",menu.label).end().end()}).end()}]});
foam.CLASS({package:"foam.box",name:"LogBox",extends:"foam.box.ProxyBox",requires:["foam.log.LogLevel"],imports:["debug","log","info","warn","error"],swiftImports:["os"],properties:[{class:"String",name:"name",factory:function(){return`LogBox${this.$UID}`},},{class:"FObjectProperty",of:"foam.log.LogLevel",name:"logLevel",factory:function(){return this.LogLevel.INFO},}],methods:[{name:"send",code:function(message){var output=message.object;this[this.logLevel.consoleMethodName].apply(this,[this.name,output instanceof Error?output.toString():foam.json.Pretty.stringify(message)]);this.delegate&&this.delegate.send(message)},}]});
foam.CLASS({package:"foam.box",name:"MultiDelegateBox",implements:["foam.box.Box"],properties:[{class:"FObjectArray",of:"foam.box.Box",name:"delegates"}],methods:[function send(message){throw new Error("Call to abstract MultiDelegateBox.send(message)")}]});
foam.CLASS({package:"foam.box",name:"BroadcastBox",extends:"foam.box.MultiDelegateBox",methods:[function send(message){var ds=this.delegates;for(var i=0;i<ds.length;i++){ds[i].send(message)}}]});
foam.CLASS({package:"foam.box",name:"RoundRobinBox",extends:"foam.box.MultiDelegateBox",properties:[{name:"currentBoxId_",value:0,preSet:function(_,val){return val%this.delegates.length}}],methods:[function send(message){this.delegates[this.currentBoxId_++].send(message)}]});foam.LIB({name:"foam.async",methods:[function sequence(s){return function(){if(!s.length)return Promise.resolve();var p=Promise.resolve();for(var i=0;i<s.length;++i){p=p.then(s[i])}return p}},function repeat(times,fn){return function(){var p=Promise.resolve();var n=0;for(var i=0;i<times;++i){p=p.then(function(){return fn(n++)})}return p}},function repeatParallel(times,fn){return function(){var promises=[];for(var i=0;i<times;++i){promises[i]=fn(i)}return Promise.all(promises)}},function log(){var args=arguments;return function(){console.log.apply(console,args);return Promise.resolve()}},function sleep(time){return function(){return new Promise(function(resolve,reject){setTimeout(function(){resolve()},time)})}}]});
foam.CLASS({package:"foam.core",name:"NullAgent",implements:["foam.core.ContextAgent"],methods:[async function execute(){}]});
foam.CLASS({package:"foam.dao",name:"ClientSink",implements:["foam.dao.Sink"],properties:[{class:"Stub",of:"foam.dao.Sink",name:"delegate",notifications:["put","remove","eof","reset"]}]});
foam.CLASS({package:"foam.u2",name:"ViewFactory",extends:"foam.core.Property",methods:[function installInProto(proto){this.SUPER(proto);var name=this.name;proto[name+"$f"]=function(args,ctx){console.warn("Deprecated use of ViewFactory; use ViewSpec instead!");ctx=ctx||this;var raw=this[name];if(typeof raw==="function"){return raw.call(this,args,ctx)}if(typeof raw==="string"){return ctx.lookup(raw).create(args,ctx)}return raw.create(args,ctx)}}]});
foam.CLASS({package:"foam.u2",name:"DAOList",extends:"foam.u2.Element",topics:["rowClick"],exports:["selection","hoverSelection","data as dao"],imports:["editRecord?","selection? as importSelection"],properties:[{class:"foam.dao.DAOProperty",name:"data"},{class:"foam.u2.ViewSpec",name:"rowView"},{class:"foam.u2.ViewFactory",name:"rowFactory"},"selection","hoverSelection"],methods:[function render(){var view=this;this.addClass(this.myClass()).select(this.data$proxy,function(obj){return(this.rowView?foam.u2.ViewSpec.createView(this.rowView,{data:obj},this,this.__subSubContext__):this.rowFactory$f({data:obj})).on("mouseover",function(){view.hoverSelection=obj}).on("click",function(){view.selection=obj;if(view.importSelection$)view.importSelection=obj;if(view.editRecord$)view.editRecord(obj);view.rowClick.pub(obj)}).addClass(this.slot(function(selection){if(obj===selection)return view.myClass("selected");return""},view.selection$))})}]});
foam.CLASS({package:"foam.u2.view",name:"RelationshipDAOToERefinement",refines:"foam.dao.RelationshipDAO",flags:["web"],requires:["foam.u2.CitationView","foam.u2.DAOList"],methods:[function toE(args,ctx){args=args||{};args.data=this;args.rowView=this.CitationView;return this.DAOList.create(args,ctx)}]});
foam.CLASS({package:"foam.u2",name:"GroupingDAOList",extends:"foam.u2.Element",implements:["foam.mlang.Expressions"],topics:["rowClick"],exports:["selection","hoverSelection","data as dao","as summaryView"],imports:["editRecord?","selection? as importSelection"],css:`
^ {
padding: 32px 24px;
}
^group-title {
color: /*%BLACK%*/ #1e1f21;
margin-bottom: 24px;
}
^row + ^row{
margin-top: 16px;
}
^row + ^group-title {
margin-top: 24px;
}
`,properties:[{class:"foam.dao.DAOProperty",name:"data"},{class:"foam.u2.ViewSpec",name:"rowView"},{class:"FObjectProperty",name:"groupExpr",},{class:"FObjectProperty",name:"order",},"selection","hoverSelection"],methods:[function render(){this.addClass();this.update();this.data$proxy.on.sub(this.update)}],listeners:[{name:"update",isMerged:true,mergeDelay:100,code:function(){var curGroup;var dao=this.order?this.data.orderBy(this.order):this.data;this.removeAllChildren();dao.select(obj=>{var group=this.groupExpr.f(obj);if(group!==curGroup){this.start().addClasses(["h300",this.myClass("group-title")]).translate(group).end()}curGroup=group;this.start(this.rowView,{data:obj}).addClass(this.myClass("row")).end()})}}]});
foam.CLASS({package:"foam.u2",name:"TableCellPropertyRefinement",refines:"foam.core.Property",properties:[{name:"columnLabel",factory:function(){return this.label}},{name:"tableCellView",value:function(obj){return obj[this.name]}}]});
foam.CLASS({package:"foam.u2",name:"TableCellActionRefinement",refines:"foam.core.Action",properties:[{name:"tableCellView",value:function(obj,e){return this.toE(null,e.__subContext__.createSubContext({data:obj}))}}]});
foam.CLASS({package:"foam.u2",name:"TableBody",extends:"foam.u2.Element",requires:["foam.mlang.predicate.And","foam.mlang.predicate.Eq","foam.mlang.predicate.Not","foam.mlang.predicate.Or","foam.u2.CheckBox","foam.u2.TableCellRefinement"],imports:["selectionQuery","tableView"],properties:[["nodeName","tbody"],["columns_"],"selectionFeedback_",{name:"rows_",factory:function(){return{}}}],methods:[function render(){var self=this;this.on("click",async function(event){var obj=await self.eToObj(event);if(obj)self.tableView.selection=obj}).on("dblclick",async function(event){var obj=await self.eToObj(event);if(obj)1})},async function eToObj(event){var me=await this.el();var e=event.target;while(e.nodeName!=="TR"&&e!==me)e=e.parentNode;if(e===me)return;return this.rows_[e.id]},function addObj(obj){var e=this.start("tr").enableClass(this.tableView.myClass("selected"),this.tableView.selection$.map(function(sel){return sel===obj}));if(this.selectionQuery$){var cb;e.start("td").start(this.CheckBox).call(function(){cb=this}).end().end();this.selectionQuery$.sub(foam.Function.bind(this.selectionUpdate,this,cb,obj));this.selectionUpdate(cb,obj);cb.data$.sub(foam.Function.bind(this.selectionClick,this,obj))}for(var j=0;j<this.columns_.length;j++){var prop=this.columns_[j];e=e.start("td").add(prop.tableCellView(obj,e)).end()}e.end();this.rows_[e.id]=obj}],listeners:[{name:"selectionUpdate",code:function(checkbox,obj){var selected=this.selectionQuery.f(obj);if(selected!==checkbox.data){this.selectionFeedback_=true;checkbox.data=selected;this.selectionFeedback_=false}}},{name:"selectionClick",code:function(obj,_,__,___,slot){if(this.selectionFeedback_)return;var q=this.Eq.create({arg1:obj.ID,arg2:obj.id});if(slot.get()){this.selectionQuery=this.Or.create({args:[q,this.selectionQuery]}).partialEval()}else{this.selectionQuery=this.And.create({args:[this.Not.create({arg1:q}),this.selectionQuery]}).partialEval()}}}]});
foam.CLASS({package:"foam.u2",name:"TableBodySink",extends:"foam.dao.AbstractSink",requires:["foam.u2.TableBody"],properties:["columns_",{name:"body",factory:function(){return this.TableBody.create({columns_:this.columns_})}}],methods:[function put(obj){this.body.addObj(obj)}]});
foam.CLASS({package:"foam.u2",name:"TableHeader",extends:"foam.u2.Element",requires:["foam.mlang.order.Desc","foam.u2.Entity"],imports:["selectionQuery","tableView"],properties:[{name:"columns_",required:true},"sortOrder"],methods:[function render(){var self=this;this.nodeName="thead";var e=this.start("tr");if(this.selectionQuery$){e.tag("td")}for(var i=0;i<this.columns_.length;i++){var sorting$=this.sortOrder$.map(function(prop,order){if(!order)return"";var desc=this.Desc.isInstance(order);var baseOrder=desc?order.arg1:order;return prop.name===baseOrder.name?this.Entity.create({name:desc?"darr":"uarr"}):""}.bind(this,this.columns_[i]));e.start("td").enableClass(this.myClass("sorting"),sorting$).start("span").addClass(this.myClass("sort-direction")).add(sorting$).end().add(this.columns_[i].columnLabel).on("click",this.tableView.sortBy.bind(this.tableView,this.columns_[i])).end()}e.end()}]});
foam.CLASS({package:"foam.u2",name:"TableView",extends:"foam.u2.Element",requires:["foam.mlang.order.Desc","foam.u2.TableBodySink","foam.u2.TableHeader"],exports:["as tableView"],css:`
^sorting {
font-weight: bold;
}
^sort-direction {
display: none;
margin-right: 8px;
}
^sorting ^sort-direction {
display: initial;
}
`,properties:[{class:"Class",name:"of",factory:function(){return this.data.of}},["nodeName","table"],{name:"columns_",expression:function(columns,of){var cls=this.of;return columns.map(function(p){return typeof p==="string"?cls.getAxiomByName(p):p})}},{name:"properties",setter:function(_,ps){console.warn("Deprecated use of TableView.properties. Use 'columns' instead.");this.columns=ps}},{name:"columns",expression:function(of){if(!this.of)return[];var tableColumns=this.of.getAxiomByName("tableColumns");if(tableColumns)return tableColumns.columns;return this.of.getAxiomsByClass(foam.core.Property).filter(function(p){return!p.hidden}).map(foam.core.Property.NAME.f)}},{name:"config"},{class:"foam.dao.DAOProperty",name:"data"},{name:"header",expression:function(columns_){return this.TableHeader.create({columns_:columns_,sortOrder$:this.sortOrder$})}},{name:"body",factory:function(){return this.E("tbody")}},{name:"sortOrder"},{name:"selection"}],methods:[function init(){this.SUPER();console.log("Deprecated use of foam.u2.TableView. Use foam.u2.view.TableView instead.")},function render(){if(this.config){for(var i=0;i<this.columns_.length;i++){var col=this.columns_[i];var cfg=this.config[col.name];if(cfg)this.columns_[i]=col.clone().copyFrom(cfg)}}this.onDAOUpdate();this.data$proxy.sub("on",this.onDAOUpdate);return this.addClass(this.myClass()).add(this.header$,this.body$)},function sortBy(prop){var sortName=this.sortOrder?this.Desc.isInstance(this.sortOrder)?this.sortOrder.arg1.name:this.sortOrder.name:"";if(sortName===prop.name){this.sortOrder=this.Desc.isInstance(this.sortOrder)?prop:this.Desc.create({arg1:prop})}else{this.sortOrder=prop}this.onDAOUpdate()}],listeners:[{name:"onDAOUpdate",isFramed:true,code:function(){var dao=this.data;if(this.sortOrder)dao=dao.orderBy(this.sortOrder);dao.select(this.TableBodySink.create({columns_:this.columns_})).then(a=>{this.body=a.body})}}]});
foam.CLASS({package:"foam.u2",name:"TableSelection",extends:"foam.u2.Element",requires:["foam.dao.ArraySink","foam.mlang.predicate.False","foam.mlang.predicate.In","foam.mlang.predicate.Or","foam.mlang.predicate.Not","foam.mlang.sink.Count","foam.mlang.sink.Map","foam.u2.TableView"],imports:["unfilteredDAO"],exports:["bulkActions","selectionQuery"],css:`
^link {
color: #00c;
margin: 0 8px;
text-decoration: none;
}
`,properties:[{name:"data",postSet:function(old,nu){if(this.daoSub_){this.daoSub_.detach();this.daoSub_=null}if(nu)this.daoSub_=nu.on.sub(this.updateCounts);this.updateCounts()}},"daoSub_",{class:"Class",name:"of",expression:function(data){return data.of}},{name:"selectionQuery",factory:function(){return this.False.create()}},"filteredCount_","totalCount_",{class:"String",name:"selectionText_",expression:function(filteredCount_,totalCount_){if(!totalCount_)return"";var s=totalCount_+" selected";if(totalCount_!==filteredCount_){s+=" ("+(filteredCount_||"0")+" shown)"}return s}},"selectAllState",{class:"FObjectArray",of:"Action",name:"bulkActions"},{class:"foam.u2.ViewSpec",name:"view",value:{class:"foam.u2.TableView"}}],methods:[function render(){var self=this;this.start().start("div").add("Select").start("a").attrs({href:"javascript:"}).on("click",this.selectAll).addClass(this.myClass("link")).add("All").end().start("a").attrs({href:"javascript:"}).on("click",this.selectNone).addClass(this.myClass("link")).add("None").end().end().start("span").add(this.selectionText_$).end().start().addClass(this.myClass("actions")).add(this.bulkActions).end().end().start(this.view,{of:this.of,data$:this.data$}).end();this.selectionQuery$.sub(this.updateCounts)}],listeners:[{name:"selectNone",isFramed:true,code:function(){this.selectionQuery=this.False.create()}},{name:"selectAll",isFramed:true,code:function(){var self=this;this.data.select(this.Map.create({arg1:this.of.ID,delegate:this.ArraySink.create()})).then(function(array){var q=self.In.create({arg1:self.of.ID,arg2:array.delegate.a});self.selectionQuery=self.Or.create({args:[self.selectionQuery,q]}).partialEval()})}},{name:"updateCounts",isFramed:true,code:function(){var self=this;this.unfilteredDAO.where(this.selectionQuery).select(this.Count.create()).then(function(c){self.totalCount_=c.value});this.data.where(this.selectionQuery).select(this.Count.create()).then(function(c){self.filteredCount_=c.value})}}]});
foam.CLASS({package:"foam.u2",name:"Scroller",extends:"foam.u2.Element",requires:["foam.graphics.Canvas","foam.graphics.ScrollCView","foam.mlang.sink.Count","foam.u2.TableView","foam.u2.ViewSpec"],imports:["window"],css:`
^ {
display: flex;
flex-grow: 1;
overflow: hidden;
}
^container {
flex-grow: 1;
overflow-x: auto;
overflow-y: hidden;
}
^ canvas {
align-self: flex-start;
flex-grow: 0;
flex-shrink: 0;
}
`,properties:[{name:"of",expression:function(data){return data.of}},{class:"foam.dao.DAOProperty",name:"data",required:true},{class:"Int",name:"rowHeight",value:36},{class:"foam.u2.ViewSpec",name:"tableView",value:{class:"foam.u2.TableView"}},{class:"foam.u2.ViewSpec",name:"scrollView",value:{class:"foam.graphics.ScrollCView"}},{name:"table"},{name:"scrollBar"},"scrollValue_","scrollHeight_","scrollExtent_","pointer"],methods:[function render(){var self=this;this.data$proxy.sub("on",this.onDAOUpdate);this.onDAOUpdate();this.scrollBar=this.createChild_(this.scrollView,{value$:this.scrollValue_$,extent$:this.scrollExtent_$,height$:this.scrollHeight_$});this.addClass().start().addClass(this.myClass("container")).call(function(){self.table=this}).start(this.tableView,{of:this.of,data$:this.slot(function(dao,extent,value){return dao.limit(extent).skip(value)},this.data$,this.scrollExtent_$,this.scrollValue_$)}).end().end().start(this.Canvas).attrs({height:this.scrollHeight_$}).call(function(){this.cview=self.scrollBar}).end().on("wheel",function(e){var negative=e.deltaY<0;var rows=Math.ceil(Math.abs(e.deltaY)/self.rowHeight);self.scrollValue_+=negative?-rows:rows});this.onload.sub(function(){self.onResize();self.window.addEventListener("resize",self.onResize)});this.onDetach(function(){self.window.removeEventListener("resize",self.onResize)})}],listeners:[{name:"onResize",isFramed:true,code:async function(){var el=await this.el();var height=el.getBoundingClientRect().height;this.scrollHeight_=height;this.scrollExtent_=Math.floor(height/this.rowHeight)}},{name:"onDAOUpdate",isFramed:true,code:function(){var self=this;this.data.select(this.Count.create()).then(function(c){self.scrollBar.size=c.value})}}]});foam.ENUM({package:"foam.u2",name:"ButtonSize",properties:["iconSize"],values:[{name:"LARGE",label:"Large",iconSize:"2.25em"},{name:"MEDIUM",label:"Medium",iconSize:"1.71em"},{name:"SMALL",label:"Small",iconSize:"1.15em"}]});foam.ENUM({package:"foam.u2",name:"ButtonStyle",values:[{name:"UNSTYLED"},{name:"PRIMARY"},{name:"SECONDARY"},{name:"TERTIARY"},{name:"LINK"}]});
foam.CLASS({package:"foam.u2",name:"ActionView",extends:"foam.u2.tag.Button",requires:["foam.u2.ButtonSize","foam.u2.ButtonStyle","foam.u2.dialog.ConfirmationModal"],imports:["ctrl"],enums:[{name:"ButtonState",values:[{name:"NO_CONFIRM"},{name:"CONFIRM"},{name:"DEBOUNCE"},{name:"ARMED"}]}],messages:[{name:"CONFIRM",message:"Confirm"},{name:"CONFIRM_MSG",message:"Are you sure you want to "}],properties:[{name:"name",factory:function(){return this.action.name||""}},{name:"icon",factory:function(action){return this.action.icon}},{name:"themeIcon",factory:function(action){return this.action.themeIcon}},{class:"String",name:"iconFontFamily",factory:function(action){return this.action.iconFontFamily}},{name:"iconFontClass",factory:function(action){return this.action.iconFontClass}},{name:"iconFontName",factory:function(action){return this.action.iconFontName}},{name:"labelPlaceholder",expression:function(label){return this.action.label}},{name:"buttonState",factory:function(){return this.ButtonState.NO_CONFIRM}},{name:"data",postSet:function(){this.buttonState=undefined}},"action",{name:"label",factory:function(action){return this.action.label}},{name:"ariaLabel",factory:function(){return this.action.ariaLabel}},{class:"Enum",of:"foam.u2.ButtonStyle",name:"buttonStyle",factory:function(action){return this.action.buttonStyle||"SECONDARY"}},{class:"Boolean",name:"isDestructive",factory:function(){return false}},{name:"mementoName",factory:function(action){return this.action.mementoName}}],methods:[function render(){this.tooltip=this.action.toolTip;this.SUPER();if(this.action){if(this.action.confirmationRequired){var cRSlot$=this.action.createConfirmationRequired$(this.__context__,this.data);this.onDetach(cRSlot$.sub(()=>this.setConfirm(cRSlot$.get())));this.setConfirm(cRSlot$.get())}this.enableClass(this.myClass("unavailable"),this.action.createIsAvailable$(this.__context__,this.data),true);this.attrs({disabled:this.action.createIsEnabled$(this.__context__,this.data).map(e=>e?false:"disabled")})}},function initCls(){this.addClass();this.addClass(this.myClass(this.action.name))}],listeners:[function click(e){try{if(this.action&&this.action.confirmationView&&this.buttonState==this.ButtonState.NO_CONFIRM){this.ctrl.add(this.ConfirmationModal.create({primaryAction:this.action,data:this.data,title:this.action.confirmationView().title||this.action.label+" "+this.data.toSummary()+"?"}).add(this.action.confirmationView().body||this.CONFIRM_MSG+" "+this.action.label.toLowerCase()+" "+this.data.toSummary()+"?"))}else if(this.buttonState==this.ButtonState.NO_CONFIRM){this.action&&this.action.maybeCall(this.__subContext__,this.data)}else if(this.buttonState==this.ButtonState.CONFIRM){this.buttonState=this.ButtonState.DEBOUNCE;this.removeAllChildren();this.start().addClass("h600").add(this.CONFIRM).end();this.debounce()}else if(this.buttonState==this.ButtonState.ARMED){this.buttonState=this.ButtonState.CONFIRM;this.removeAllChildren();this.addContent();this.action&&this.action.maybeCall(this.__subContext__,this.data)}}catch(x){console.warn("Unexpected Exception in Action: ",x)}if(e){e.preventDefault();e.stopPropagation()}},{name:"debounce",isMerged:true,mergeDelay:200,code:function(){if(this.buttonState!=this.ButtonState.DEBOUNCE)return;this.buttonState=this.ButtonState.ARMED;this.deactivateConfirm()}},{name:"deactivateConfirm",isMerged:true,mergeDelay:6e3,code:function(){if(this.buttonState!=this.ButtonState.ARMED)return;this.removeAllChildren();this.addContent();this.buttonState=this.ButtonState.CONFIRM}},{name:"setConfirm",code:function(confirm){let newState=confirm?this.ButtonState.CONFIRM:this.ButtonState.NO_CONFIRM;let stateChange=this.buttonState!=newState;this.buttonState=newState;this.isDestructive=confirm;if(stateChange){this.removeAllChildren();this.addContent()}}}]});
foam.CLASS({package:"foam.u2.view",name:"MenuView",extends:"foam.u2.tag.Button",imports:["menu","dropdown? as parentMenuDropdown"],properties:[{name:"label",expression:function(menu){return menu.label||""}},{name:"icon",expression:function(menu){return menu.icon||""}},{name:"themeIcon",expression:function(menu){return menu.themeIcon||""}}],listeners:[function click(evt){this.SUPER(evt);this.menu.launch_(this.__subContext__,this);if(this.parentMenuDropdown)this.parentMenuDropdown.close();return}]});
foam.CLASS({package:"foam.u2",name:"DetailPropertyView",extends:"foam.u2.Element",css:`
.foam-u2-PropertyView-label {
color: #444;
display: block;
float: left;
font-size: 1.5rem;
padding: 4px 32px 4px 6px;
text-align: left;
vertical-align: top;
white-space: nowrap;
}
.foam-u2-PropertyView-view {
padding: 2px 8px 2px 6px;
}
.foam-u2-PropertyView-units  {
color: #444;
font-size: 1.2rem;
padding: 4px;
text-align: right;
}
`,properties:["prop",["nodeName","tr"],{name:"label",factory:function(){return this.prop.label}}],methods:[function render(){var prop=this.prop;this.show(prop.createVisibilityFor(this.__context__.data$,this.controllerMode$).map(m=>m!=foam.u2.DisplayMode.HIDDEN));this.add(this.shown$.map(shown=>{return this.E().callIf(shown,()=>{this.addClass().addClass("foam-u2-PropertyView").addClass("foam-u2-PropertyView-prop-"+prop.name).start("td").addClass("foam-u2-PropertyView-label").add(this.label).end().start("td").addClass("foam-u2-PropertyView-view").callIf(!this.label,function(){this.style({width:"100%"})}).add(prop,prop.units&&this.E("span").addClass("foam-u2-PropertyView-units").add(" ",prop.units)).end()})}))}]});
foam.CLASS({package:"foam.u2",name:"DetailView",extends:"foam.u2.View",requires:["foam.core.Property","foam.u2.DetailPropertyView","foam.u2.Tab","foam.u2.Tabs"],exports:["currentData as data","currentData as objData","controllerMode","currentMemento_ as memento"],imports:["memento"],axioms:[foam.pattern.Faceted.create()],properties:[{name:"data",attribute:true,preSet:function(_,data){var of=data&&data.cls_;if(of!==this.of){this.of=of}else{this.currentData=data}return data},factory:function(){return this.of&&this.of.create(null,this)}},"currentData",{class:"Class",name:"of"},{class:"Boolean",name:"showActions",value:true},{name:"properties",preSet:function(_,ps){foam.assert(ps,"Properties required.");for(var i=0;i<ps.length;i++){if(!foam.core.Property.isInstance(ps[i])){var p=this.of.getAxiomByName(ps[i]);if(!foam.core.Property.isInstance(p)){foam.assert(false,`Non-Property in 'properties' list:`,ps)}else{ps[i]=p}}}return ps},expression:function(of){if(!of)return[];return this.of.getAxiomsByClass(foam.core.Property).filter(function(p){return!(p.hidden||p.visibility===foam.u2.DisplayMode.HIDDEN)})}},{name:"config"},{name:"actions",expression:function(of){if(!of)return[];return this.of.getAxiomsByClass(foam.core.Action)}},{name:"title",attribute:true,expression:function(of){return this.of?this.of.model_.label:""}},["nodeName","DIV"],"currentMemento_"],css:`
/* Temporary fix until we refactor DetailView to not use a table. */
^ {
display: block;
margin: auto;
width: 100%;
background-color: /*%WHITE%*/ #ffffff;
}
^toolbar {
display: flex;
padding: 6px 12px;
flex-wrap: wrap;
}
^ table {
width: 100%;
table-layout: fixed;
}
^ table tr td:nth-of-type(2) {
width: 70%;
}
^title {
padding: 6px;
font-weight: 500;
}
/*
* Styles for table contents
*/
^ table .foam-u2-stack-StackView {
padding-left: 0 !important;
}
^ table .foam-u2-tag-TextArea {
max-width: 100%;
}
^ table .foam-u2-Multiview-container[style*="float"] .foam-u2-tag-TextArea {
width: 100%;
}
`,methods:[function render(){var self=this;var hasTabs=false;if(this.title){self.start().addClass(self.myClass("title")).add(self.title$).end()}this.add(this.slot(function(of,properties,actions){if(!of)return"";self.currentData=self.data;var tabs=foam.u2.Tabs.create({},self);return self.actionBorder(this.addClass(this.myClass()).E("table").forEach(properties,function(p){var config=self.config&&self.config[p.name];var expr=foam.mlang.Expressions.create();if(config){p=p.clone();for(var key in config){if(config.hasOwnProperty(key)){p[key]=config[key]}}}if(p.cls_==foam.dao.OneToManyRelationshipProperty||p.cls_==foam.dao.ManyToManyRelationshipProperty){hasTabs=true;var label=p.label;let tab=self.Tab.create({label:label});var dao=p.cls_==foam.dao.ManyToManyRelationshipProperty?p.get(self.data).getDAO():p.get(self.data);dao.select(expr.COUNT()).then(function(c){tab.label=label+" ("+c.value+")"});p=p.clone();p.label="";tab.start("table").tag(self.DetailPropertyView,{prop:p});tabs.add(tab)}else{this.tag(self.DetailPropertyView,{prop:p})}}).callIf(hasTabs,function(){this.start("tr").start("td").setAttribute("colspan","2").add(tabs).end().end()}))}))},function actionBorder(e){if(!this.showActions||!this.actions.length)return e;return this.E().add(e).start("div").addClass(this.myClass("toolbar")).add(this.actions).end()}]});
foam.CLASS({package:"foam.u2",name:"ContextSensitiveDetailView",extends:"foam.u2.DetailView",methods:[function render(){if(!this.data)this.data=this.__context__.data;this.SUPER()}]});
foam.CLASS({package:"foam.u2.tag",name:"Image",extends:"foam.u2.View",imports:["theme"],requires:["foam.net.HTTPRequest","foam.u2.HTMLView"],css:`
^ .foam-u2-HTMLView {
padding: 0;
}
`,constants:{CACHE:{}},properties:[{class:"GlyphProperty",name:"glyph"},{name:"displayWidth",attribute:true},{name:"displayHeight",attribute:true},["alpha",1],{class:"String",name:"role"},{class:"Boolean",name:"embedSVG"}],methods:[function requestWithCache(data){if(!this.CACHE[data]){this.CACHE[data]=new Promise(resolve=>{this.HTTPRequest.create({method:"GET",path:data}).send().then(resp=>{resp.resp.text().then(t=>resolve(t))})})}return this.CACHE[data]},function render(){this.addClass(this.myClass()).add(this.slot(function(data,glyph,displayWidth,displayHeight,alpha){if(glyph){var indicator=glyph.clone(this).expandSVG();return this.E().start(this.HTMLView,{data:indicator}).attrs({role:this.role}).end()}else if(this.embedSVG&&data?.endsWith("svg")){var e=this.E();this.requestWithCache(data).then(data=>{e.start(this.HTMLView,{data:data}).attrs({role:this.role}).end()});return e}else{return this.E().start("img").attrs({src:data,role:this.role}).style({height:displayHeight,width:displayWidth,opacity:alpha}).end()}}))}]});foam.SCRIPT({package:"foam.u2.tag",name:"ImageScript",requires:["foam.u2.U2ContextScript","foam.u2.tag.Image"],flags:["web"],code:function(){foam.__context__.registerElement(foam.u2.tag.Image)}});
foam.CLASS({package:"foam.u2.tag",name:"Input",extends:"foam.u2.View",css:`
/* Still show outline when focused as read-only to help accessibility *
^:read-only:focus { outline: 1px solid rgb(238, 238, 238); }
`,properties:[["nodeName","input"],{name:"data",preSet:function(o,d){var f=!d||typeof d==="string"||typeof d==="number"||typeof d==="boolean"||foam.Date.isInstance(d);if(!f){this.__context__.warn("Set Input data to non-primitive:"+d);return o}return d}},{class:"Boolean",name:"onKey",attribute:true},{class:"Boolean",name:"autofocus",attribute:true,},{class:"Int",name:"size"},{class:"Int",name:"maxLength",attribute:true},"type","placeholder","ariaLabel",["autocomplete",true],{name:"choices",factory:function(){return[]},adapt:function(old,nu){if(typeof nu==="object"&&!Array.isArray(nu)){var out=[];for(var key in nu){if(nu.hasOwnProperty(key))out.push([key,nu[key]])}if(this.dynamicSize){this.size=Math.min(out.length,this.maxSize)}return out}nu=foam.Array.clone(nu);for(var i=0;i<nu.length;i++){if(!Array.isArray(nu[i])){nu[i]=[nu[i],nu[i]]}}if(this.dynamicSize)this.size=Math.min(nu.length,this.maxSize);return nu}}],methods:[function render(){this.SUPER();var self=this;if(this.size)this.setAttribute("size",this.size);if(this.type)this.setAttribute("type",this.type$);if(this.placeholder)this.setAttribute("placeholder",this.placeholder);if(this.ariaLabel)this.setAttribute("aria-label",this.ariaLabel);if(this.maxLength>0)this.setAttribute("maxlength",this.maxLength);if(!this.autocomplete)this.setAttribute("autocomplete","off");if(this.choices&&this.choices.length){this.setAttribute("list",this.id+"-datalist").start("datalist").call(function(){this.id=self.id+"-datalist"}).forEach(this.choices,function(c){var key=c[0];var label=c[1];this.start("option").attrs({value:key}).add(label).end()}).end()}this.initCls();this.link()},function initCls(){this.addClass()},function link(){this.attrSlot(null,this.onKey?"input":null).linkFrom(this.data$)},function fromProperty(p){this.SUPER(p);if(!this.hasOwnProperty("onKey")){this.onKey=p.hasOwnProperty("onKey")?p.onKey:p.validateObj}if(!this.hasOwnProperty("maxLength")&&p.maxLength)this.maxLength=p.maxLength;this.ariaLabel=p.label||p.name},function updateMode_(mode){this.setAttribute("readonly",mode===foam.u2.DisplayMode.RO);this.setAttribute("disabled",mode===foam.u2.DisplayMode.DISABLED);this.show(mode!==foam.u2.DisplayMode.HIDDEN)}]});
foam.CLASS({package:"foam.u2.tag",name:"TextArea",extends:"foam.u2.View",axioms:[{class:"foam.u2.TextInputCSS"},{class:"foam.u2.CSS",code:`
/* Override a few of the styles in foam.u2.TextInputCSS */
^ {
height: auto;
padding-top: %INPUTVERTICALPADDING%;
padding-bottom: %INPUTVERTICALPADDING%;
}
`}],properties:[["nodeName","textarea"],{class:"Int",name:"rows",value:4},{class:"Int",name:"cols",value:60},{class:"Boolean",name:"onKey",attribute:true,},"placeholder",{class:"String",name:"wrap",value:"soft"},{class:"Boolean",name:"escapeTextArea",value:true}],methods:[function render(){this.SUPER();this.addClass();if(this.escapeTextArea){this.style({"white-space":"pre"})}this.attrs({rows:this.rows,cols:this.cols,placeholder:this.placeholder$,wrap:this.wrap});this.attrSlot("value",this.onKey?"input":"change").linkFrom(this.data$)},function load(){this.SUPER();this.attrs({value:this.data+""})},function updateMode_(mode){this.setAttribute("readonly",mode===foam.u2.DisplayMode.RO);this.setAttribute("disabled",mode===foam.u2.DisplayMode.DISABLED)},function fromProperty(p){this.SUPER(p);if(!this.hasOwnProperty("onKey")){this.onKey=p.hasOwnProperty("onKey")?p.onKey:p.validateObj}if(!this.hasOwnProperty("maxLength")&&p.maxLength)this.maxLength=p.maxLength;this.ariaLabel=p.label||p.name}]});
foam.CLASS({package:"foam.u2.tag",name:"Button",extends:"foam.u2.View",requires:["foam.net.HTTPRequest","foam.u2.ButtonSize","foam.u2.ButtonStyle","foam.u2.HTMLView","foam.u2.tag.CircleIndicator"],imports:["theme?"],css:`
^ {
font: inherit;
align-items: center;
border: 1px solid transparent;
border-radius: 4px;
box-sizing: border-box;
display: inline-flex;
gap: 8px;
justify-content: center;
margin: 0;
outline: none;
text-align: center;
}
^iconAfter {
flex-direction: row-reverse;
}
^ + ^ {
margin-left: 8px;
}
^:hover:not(:disabled) {
cursor: pointer;
}
^unavailable {
display: none;
}
^ img {
vertical-align: middle;
}
^ svg {
width: 100%;
max-height: 100%;
vertical-align: middle;
}
^.material-icons {
cursor: pointer;
}
/* Unstyled */
^unstyled {
background: none;
border: none;
color: inherit;
}
/* Primary */
^primary, ^primary svg {
background-color: /*%PRIMARY3%*/ #406dea;
box-shadow: 0px 1px 2px rgba(0, 0, 0, 0.06), 0px 1px 3px rgba(0, 0, 0, 0.1);
color: /*%WHITE%*/ white;
fill: /*%WHITE%*/ white;
}
^primary:hover:not(:disabled) {
background-color: /*%PRIMARY2%*/ #144794;
}
^primary:focus {
background-color: /*%PRIMARY2%*/ #144794;
border-color: /*%PRIMARY1%*/ #202341;
}
^primary:disabled {
background-color: /*%PRIMARY4%*/ #C6D2FF;
}
/* Primary destructive */
^primary-destructive,^primary-destructive svg {
background-color: /*%DESTRUCTIVE3%*/ #d9170e;
color: /*%WHITE%*/ white;
fill: /*%WHITE%*/ white;
}
^primary-destructive:hover:not(:disabled) {
background-color: /*%DESTRUCTIVE2%*/ #a61414;
}
^primary-destructive:focus {
background-color: /*%DESTRUCTIVE2%*/ #a61414;
border: 1px solid /*%DESTRUCTIVE1%*/ #631414;
box-shadow: inset 0px 2px 4px rgba(0, 0, 0, 0.06);
}
^primary-destructive:disabled {
background-color: /*%DESTRUCTIVE5%*/ #E5D2D0;
}
/* Secondary */
^secondary{
background-color: /*%WHITE%*/ white;
border: 1px solid /*%GREY3%*/ #B2B6BD;
color: /*%GREY1%*/ #494F59;
}
^secondary svg { fill: /*%GREY1%*/ #494F59; }
^secondary:hover:not(:disabled) {
background-color: /*%GREY5%*/ #B2B6BD;
}
^secondary:focus {
background-color: /*%GREY5%*/ #B2B6BD;
border: 1px solid /*%PRIMARY3%*/ #406DEA;
}
^secondary:disabled{
background-color: /*%GREY5%*/ #F5F7FA;
border-color: /*%GREY4%*/ #DADDE2;
color: /*%GREY4%*/ #DADDE2;
}
^secondary:disabled svg { fill: /*%GREY4%*/ #DADDE2; }
/* Secondary destructive */
^secondary-destructive{
background-color: /*%WHITE%*/ #ffffff;
border: 1px solid /*%GREY3%*/ #B2B6BD;
color: /*%DESTRUCTIVE2%*/ #a61414;
}
^secondary-destructive svg { fill: /*%DESTRUCTIVE2%*/ #a61414; }
^secondary-destructive:hover {
background-color: /*%GREY5%*/ #B2B6BD;
}
^secondary-destructive:focus {
background-color: /*%GREY5%*/ #B2B6BD;
border-color: /*%DESTRUCTIVE2%*/ #a61414;
}
^secondary-destructive:disabled {
background-color: /*%GREY5%*/ #F5F7FA;
border-color: /*%GREY4%*/ #DADDE2;
color: /*%DESTRUCTIVE5%*/ #E5D2D0;
}
^secondary-destructive:disabled svg { fill: /*%DESTRUCTIVE5%*/ #E5D2D0; }
/* Tertiary */
^tertiary{
background: none;
border: 1px solid transparent;
color: /*%GREY1%*/ #5E6061;
}
^tertiary svg { fill: /*%GREY1%*/ #5E6061; }
^tertiary:hover:not(:disabled) {
background-color: /*%GREY5%*/ #F5F7FA;
}
^tertiary:focus,^tertiary:focus svg {
background-color: /*%GREY5%*/ #F5F7FA;
color: /*%PRIMARY3%*/ #494F59;
fill: /*%PRIMARY3%*/ #494F59;
}
^tertiary:disabled,^tertiary:disabled svg {
color: /*%GREY4%*/ #DADDE2;
fill: /*%GREY4%*/ #DADDE2;
}
/* Tertiary destructive */
^tertiary-destructive{
background-color: transparent;
border-color: transparent;
color: /*%DESTRUCTIVE3%*/ #D9170E;
}
^tertiary-destructive svg { fill: /*%DESTRUCTIVE3%*/ #D9170E; }
^tertiary-destructive:hover:not(:disabled) {
background-color: /*%GREY5%*/ #F5F7FA;
}
^tertiary-destructive:focus,^tertiary-destructive:focus svg {
background-color: /*%GREY5%*/ #F5F7FA;
color: /*%DESTRUCTIVE3%*/ #494F59;
fill: /*%DESTRUCTIVE3%*/ #494F59;
}
^tertiary-destructive:disabled,^tertiary-destructive:diabled svg {
color: /*%GREY4%*/ #DADDE2;
fill: /*%GREY4%*/ #DADDE2;
}
/* Link */
^link,^link svg {
background: none;
color: /*%GREY1%*/ #5E6061;
fill: /*%GREY1%*/ #5E6061;
}
^link:hover:not(:disabled),^link:hover svg {
text-decoration: underline;
color: /*%GREY2%*/ #6B778C;
fill: /*%GREY2%*/ #6B778C;
}
^link:focus,^link:focus svg {
color: /*%PRIMARY3%*/ #406DEA;
fill: /*%PRIMARY3%*/ #406DEA;
}
/* Sizes */
^small {
padding: 6px 10px;
}
^medium {
padding: 8px 12px;
max-height: 34px;
}
^large {
min-width: 100px;
padding: 12px 12px;
}
^iconOnly{
padding: 8px;
max-height: inherit;
}
^link^small,
^link^medium,
^link^large {
padding-left: 0;
padding-right: 0;
}
^link > .foam-u2-HTMLView{
height: 1em;
}
^svgIcon {
max-height: 100%;
max-width: 100%;
object-fit: contain;
}
^svgIcon svg {
height: 100%;
}
/* SVGs outside themeGlyphs may have their own heights and widths,
these ensure those are respected rather than imposing new dimensions */
^imgSVGIcon {
display: flex;
align-items: center;
justify-content: center;
}
^imgSVGIcon svg {
height: initial;
}
^small svg,
^small img {
width: 1.15em;
height: 1.15em;
}
^medium svg,
^medium img {
width: 1.71em;
height: 1.71em;
}
^large svg,
^large img {
width: 2.25em;
height: 2.25em;
}
^link svg, link img {
width: 1em;
height: 1em;
}
`,properties:["name",{class:"GlyphProperty",name:"themeIcon"},{class:"URL",name:"icon"},{class:"Boolean",name:"isIconAfter"},{class:"String",name:"iconFontFamily"},{class:"String",name:"iconFontClass"},{class:"String",name:"iconFontName"},["nodeName","button"],{name:"label"},{class:"String",name:"ariaLabel"},{class:"Enum",of:"foam.u2.ButtonStyle",name:"buttonStyle",value:"SECONDARY"},{class:"Boolean",name:"isDestructive",factory:function(){return false}},{class:"Enum",of:"foam.u2.ButtonSize",name:"size",value:"MEDIUM"},{class:"String",name:"styleClass_",expression:function(isDestructive,buttonStyle){var s=buttonStyle.name.toLowerCase();return isDestructive?s+"-destructive":s}}],methods:[function render(){this.SUPER();this.initCls();this.on("click",this.click);this.addContent();this.attrs({name:this.name||"","aria-label":this.ariaLabel});this.addClass(this.slot(function(styleClass_){return this.myClass(styleClass_)}));this.addClass(this.myClass(this.size.label.toLowerCase()));this.enableClass(this.myClass("iconOnly"),!(this.contents||this.label));this.enableClass(this.myClass("iconAfter"),this.isIconAfter$);this.enableClass("destructive",this.isDestructive$)},function initCls(){this.addClass()},async function addContent(){var self=this;if(this.themeIcon&&this.theme){this.start({class:"foam.u2.tag.Image",glyph:this.themeIcon,role:"presentation"}).addClass(this.myClass("SVGIcon")).end()}else if(this.icon){this.start({class:"foam.u2.tag.Image",data:this.icon,role:"presentation",embedSVG:true}).addClasses([this.myClass("SVGIcon"),this.myClass("imgSVGIcon")]).end()}else if(this.iconFontName){this.nodeName="i";this.addClass(this.action.name);this.addClass(this.iconFontClass);this.attr(role,"presentation");this.style({"font-family":this.iconFontFamily});this.add(this.iconFontName)}if(this.label){if(foam.String.isInstance(this.label)){if(this.buttonStyle=="LINK"||this.buttonStyle=="UNSTYLED"){this.start().addClass("p").add(this.label$).end()}else{this.start().addClass("h600").add(this.label$).end()}}else{this.add(this.label$)}}}],listeners:[function click(e){e.preventDefault();e.stopPropagation()}]});
foam.CLASS({package:"foam.u2.util",name:"NumberShortener",static:[function shortenNumber(number,precision,currency){var brackets=["K","M","B","T"];var num=String(number);var shortened="";if(!this.requiresShortening_(num,currency)){return currency?currency.format(number):num}var flatValue=currency?num.substring(0,num.length-currency.precision):num;brackets.forEach((bracket,index)=>{var numZeroes=(index+1)*3;var lowerBound=Math.pow(10,numZeroes);var upperBound=lowerBound*1e3;if(flatValue>=lowerBound&&flatValue<upperBound){var maxPrecision=precision<=numZeroes?precision:numZeroes;var value=precision?(flatValue/lowerBound).toFixed(maxPrecision):Math.floor(flatValue/lowerBound);shortened=currency?`${currency.id}${currency.symbol} ${value}${bracket}`:`${value}${bracket}`}});return shortened},function requiresShortening_(number,currency){var decimal=number;if(currency){if(decimal.length<currency.precision)return false;decimal=number.substring(0,number.length-currency.precision)}return decimal/1e3>=1}]});
foam.CLASS({package:"foam.u2",name:"TextField",extends:"foam.u2.tag.Input",axioms:[{class:"foam.u2.TextInputCSS"}],css:`
input[type="search"] {
-webkit-appearance: textfield;
}
^:read-only:not(:disabled) {
border: none;
background: rgba(0,0,0,0);
}
`,properties:[{class:"Int",name:"displayWidth"}],methods:[function fromProperty(prop){this.SUPER(prop);if(!this.placeholder&&prop.placeholder){this.placeholder=prop.placeholder}if(!this.displayWidth){this.displayWidth=prop.displayWidth}if(!this.size){this.size=this.displayWidth}}]});
foam.CLASS({package:"foam.u2",name:"SearchField",extends:"foam.u2.TextField",css:`
^icon{
background-image: url("images/ic-search.svg");
background-repeat: no-repeat;
background-position: left 0.5em top 50%, 0 0;
padding: 0 16px 0 32px;
}
`,messages:[{name:"LABEL_SEARCH",message:"Search..."}],properties:[["type","search"],{name:"placeholder",factory:x=>{return x.sourceCls_.LABEL_SEARCH}}],methods:[function initCls(){this.addClass();this.addClass(this.myClass("icon"))}]});
foam.CLASS({package:"foam.u2",name:"TextInputCSS",extends:"foam.u2.CSS",properties:[{name:"code",value:`
^ {
min-width: 64px;
height: /*%INPUTHEIGHT%*/ 34px;
font-size: 1.4rem;
padding-left: /*%INPUTHORIZONTALPADDING%*/ 8px;
padding-right: /*%INPUTHORIZONTALPADDING%*/ 8px;
border: 1px solid;
border-radius: 3px;
color: /*%BLACK%*/ #1e1f21;
background-color:/*%WHITE%*/ #ffffff;
border-color: /*%GREY3%*/ #cbcfd4;
width: 100%;
}
^:hover {
border-color: /*%GREY2%*/ #9ba1a6;
}
^:hover::placeholder,
^:hover:-ms-input-placeholder,
^:hover::-ms-input-placeholder {
color: /*%GREY2%*/ #9ba1a6;
}
^:focus {
outline: none;
border-color: /*%PRIMARY3%*/ #406dea;
}
^:disabled {
color: /*%GREY1%*/ #5e6061;
background-color: /*%GREY5%*/ #f5f7fa;
border-color: /*%GREY3%*/ #cbcfd4;
}
^.error {
color: /*%DESTRUCTIVE3%*/ #d9170e;
background-color: /*%DESTRUCTIVE5%*/ #fbedec;
border-color: /*%DESTRUCTIVE3%*/ #d9170e;
}
`}]});
foam.CLASS({package:"foam.u2",name:"IntView",extends:"foam.u2.TextField",properties:[["type","number"],{class:"Int",name:"data"},"min","max"],methods:[function render(){this.SUPER();if(this.min!=undefined)this.setAttribute("min",this.min);if(this.max!=undefined)this.setAttribute("max",this.max)},function link(){this.attrSlot(null,this.onKey?"input":null).linkFrom(this.data$)},function fromProperty(p){this.SUPER(p);this.min=p.min;this.max=p.max}]});
foam.CLASS({package:"foam.u2",name:"FloatView",extends:"foam.u2.TextField",mixins:["foam.util.DeFeedback"],properties:[["type","text"],{class:"Float",name:"data"},{class:"Boolean",name:"trimZeros",value:true},"precision","min","max",{class:"Float",name:"step",value:.01},"preventFeedback","isMerged"],methods:[function render(){this.SUPER();this.addClass();if(!foam.Undefined.isInstance(this.min))this.setAttribute("min",this.min);if(!foam.Undefined.isInstance(this.max))this.setAttribute("max",this.max);if(!foam.Undefined.isInstance(this.step))this.setAttribute("step",this.step)},function link(){if(foam.Undefined.isInstance(this.precision)){this.attrSlot(null,this.onKey?"input":null).relateFrom(this.data$,this.textToData.bind(this),this.dataToText.bind(this));return}var data=this.data$;var view=this.attrSlot(null,this.onKey?"input":null);var self=this;if(!foam.Undefined.isInstance(this.data))view.set(this.dataToText(this.data));this.on("blur",function(){var value=self.dataToText(data.get());self.feedback_=true;view.set("0");view.set(value);self.feedback_=false});view.sub(self.isMerged?self.mergedViewListener:self.viewListener);data.sub(function(){view.set(self.dataToText(data.get()))})},function fromProperty(p){this.SUPER(p);if(!foam.Undefined.isInstance(p.precision))this.precision=p.precision;if(!foam.Undefined.isInstance(p.min))this.min=p.min;if(!foam.Undefined.isInstance(p.max))this.max=p.max},function formatNumber(val){val=(val||0).toFixed(this.precision);return this.trimZeros?Number(val).toString():val},function dataToText(val){return foam.Undefined.isInstance(this.precision)?""+val:this.formatNumber(val)},function textToData(text){return parseFloat(text)||0},function viewListenerFn(){var data=this.data$;var view=this.attrSlot(null,this.onKey?"input":null);this.deFeedback(()=>{const el=this.el_();let pos=el.selectionStart;let selectNewText=el.selectionEnd==el.value.length;data.set(this.textToData(foam.Number.clamp(this.min,view.get(),this.max)));el.selectionStart=Math.min(pos,el.value.length);if(!selectNewText)el.selectionEnd=el.selectionStart})}],listeners:[{name:"viewListener",code:function(){this.viewListenerFn()}},{name:"mergedViewListener",isMerged:true,mergeDelay:500,code:function(){this.viewListenerFn()}}]});
foam.CLASS({package:"foam.u2",name:"CurrencyView",extends:"foam.u2.FloatView",css:"^:read-only { border: none; background: rgba(0,0,0,0); }",properties:[["precision",2],["trimZeros",false],["isMerged",true]],methods:[function dataToText(val){return this.SUPER(val/100)},function textToData(text){return Math.round(this.SUPER(text)*100)},function formatNumber(val){return val.toFixed(2)},function link(){this.SUPER();this.on("focus",()=>{var view=this.attrSlot(null,this.onKey?"input":null);if(!this.data){view.set("")}})}]});
foam.CLASS({package:"foam.u2",name:"MDCurrencyView",code:function(){var m=foam.json.objectify(foam.u2.CurrencyView.model_);m.name="MDCurrencyView";m.extends="foam.u2.property.MDFloatView"}});
foam.CLASS({package:"foam.u2",name:"CheckBox",extends:"foam.u2.property.AbstractCheckBox",css:`
^ {
-webkit-appearance: none;
appearance: none;
border-radius: 2px;
border: solid 2px /*%GREY2%*/ #5a5a5a;
height: 1.275em;
margin: 7px 0;
padding: 0px;
transition: background-color 140ms, border-color 140ms;
width: 1.275em;
}
^:disabled {
border-color:  /*%GREY4%*/ #DADDE2;
background-color: /*%GREY5%*/ #F5F7FA;
}
^:checked {
background-color: /*%PRIMARY3%*/ #406DEA;
border-color: /*%PRIMARY3%*/ #406DEA;
fill: white;
}
^:checked:disabled {
border-color:  /*%PRIMARY4%*/ #DADDE2;
background-color: /*%PRIMARY4%*/ #DADDE2;
fill: white;
}
^:checked:after{
position:relative;
top:1;
content: url("/images/checkmark-white.svg");
}
^ input:focus + label::before {
content: ''
box-shadow: 0 0 0 3px /*%PRIMARY2%*/ #ffbf47;
}
^:hover {
cursor: pointer
}
^label, input[type="checkbox"]{
vertical-align: middle;
}
`,methods:[function render(){this.SUPER();var self=this;this.setAttribute("type","checkbox").addClass(this.myClass()).on("click",this.onClick);if(this.showLabel){this.start("label").addClass(this.myClass("label")).addClass(this.myClass("noselect")).on("click",this.onClick).callIfElse(this.labelFormatter,this.labelFormatter,function(){this.add(self.label$)}).end()}}],listeners:[function onClick(){if(this.getAttribute("disabled"))return;this.data=!this.data}]});
foam.CLASS({package:"foam.u2",name:"CitationView",extends:"foam.u2.View",axioms:[foam.pattern.Faceted.create()],css:`
^row {
font-size: 1.2rem;
}
^rw {
background: /*%WHITE%*/ white;
padding: 8px 16px;
color: /*%BALCK%*/ #424242;
}
^rw:hover {
background: /*%GREY5%*/ #f4f4f9;
cursor: pointer;
}
`,properties:[{class:"Class",name:"of"},{class:"String",name:"summary"}],reactions:[["","propertyChange.data","updateSummary"],["data","propertyChange","updateSummary"]],listeners:[{name:"updateSummary",isFramed:true,code:async function(){let newSummary;if(this.data){var summary=this.getSummary(this.data);newSummary=summary instanceof Promise?await summary:summary}else{newSummary=undefined}this.summary=newSummary}}],methods:[function render(){this.SUPER();this.updateSummary();this.addClass(this.myClass("row")).enableClass(this.myClass("rw"),this.mode$.map(m=>m===foam.u2.DisplayMode.RW)).add(this.summary$)},function getSummary(data){return data.toSummary?.()}]});
foam.CLASS({package:"foam.u2",name:"PopupView",extends:"foam.u2.Element",css:`
^ {
background: #999;
box-shadow: 3px 3px 6px 0 gray;
color: white;
font-size: 1.8rem;
opacity: 0.9;
position: absolute;
box-sizing: border-box;
z-index: 999;
}
`,properties:["x","y","width","height","maxWidth","maxHeight","padding","bg"],methods:[async function render(){var parent=this.parentNode;var parentE=await parent.el();if(!this.padding)this.padding=20;if(!this.y)this.y=(parentE.clientHeight-this.height)/2;if(!this.x)this.x=(parentE.clientWidth-this.width)/2;if(this.width)this.style({width:this.width+"px"});if(this.height)this.style({height:this.height+"px"});if(this.maxWidth)this.style({maxWidth:this.maxWidth+"px"});if(this.maxHeight)this.style({maxHeight:this.maxHeight+"px"});this.bg=this.E("div").style({position:"fixed",width:"100%",height:"100%",opacity:0,top:0,zIndex:998}).on("click",this.close).write();this.addClass(this.myClass()).style({padding:this.padding+"px",left:this.x+"px",top:this.y+"px"});parent.style({position:"relative"})}],listeners:[function close(){this.remove();this.bg.remove()}]});
foam.CLASS({package:"foam.u2",name:"DateView",extends:"foam.u2.tag.Input",axioms:[{class:"foam.u2.TextInputCSS"}],css:`
^:read-only:not(:disabled) { border: none; background: rgba(0,0,0,0); margin-left: -8px; }
^ { width: fit-content; }
`,messages:[{name:"DATE_FORMAT",message:"yyyy-mm-dd"}],methods:[function render(){this.setAttribute("type","date");this.setAttribute("max","9999-12-31");this.setAttribute("placeholder",this.DATE_FORMAT);this.SUPER();this.on("scroll",e=>{e.preventDefault();e.stopPropagation()})},function link(){if(this.linked)return;this.linked=true;var self=this;var focused=false;var slot=this.attrSlot();function updateSlot(){var date=self.data;if(focused)return;if(foam.Number.isInstance(date))date=new Date(date);if(!date){slot.set("")}else{slot.set(date?date.toISOString().substring(0,10):"")}}function updateData(){var value=slot.get();var date;if(value){date=Date.parse(value);if(isNaN(date))date=undefined}self.data=date}if(this.onKey){var focused=false;this.on("focus",()=>{focused=true});this.on("blur",()=>{focused=false});this.on("change",updateData)}else{this.on("blur",updateData)}updateSlot();this.onDetach(this.data$.sub(updateSlot))}]});
foam.CLASS({package:"foam.u2",name:"DateTimeView",extends:"foam.u2.tag.Input",axioms:[{class:"foam.u2.TextInputCSS"}],css:`
^ {
width: fit-content;
}
`,methods:[function render(){this.SUPER();this.setAttribute("type","datetime-local");this.setAttribute("placeholder","yyyy/mm/dd hh:mm")},function link(){this.data$.relateTo(this.attrSlot(null,this.onKey?"input":null),function(date){return date?date.toISOString().substring(0,16):date},function(value){return new Date(value)})}]});
foam.CLASS({package:"foam.u2",name:"RangeView",extends:"foam.u2.tag.Input",css:"^ { width: 300px; vertical-align: middle }",properties:[["type","range"],["step",0],["minValue",0],["maxValue",100],["onKey",true]],methods:[function render(){this.SUPER();if(this.step)this.attrs({step:this.step});this.attrs({min:this.minValue,max:this.maxValue$})},function updateMode_(mode){if(mode===foam.u2.DisplayMode.RO||mode===foam.u2.DisplayMode.DISABLED)this.setAttribute("disabled",true);this.show(mode!==foam.u2.DisplayMode.HIDDEN)}]});
foam.CLASS({package:"foam.u2",name:"ReadWriteView",extends:"foam.u2.View",requires:["foam.u2.TextField","foam.u2.tag.Input"],methods:[function render(){this.addClass();this.initReadView()},function isLoaded(){return this.data},function listenForLoad(){this.data$.sub(this.onDataLoad)},function toReadE(){return this.E("span").add(this.data$)},function toWriteE(){this.data$.sub(this.onDataLoad);return this.TextField.create({data$:this.data$})}],listeners:[function onDataLoad(s){s.detach();this.initReadView()},function initReadView(){this.removeAllChildren().add(this.toReadE().on("click",this.initWriteView))},function initWriteView(){this.removeAllChildren().add(this.toWriteE().on("blur",this.initReadView).focus())}]});
foam.CLASS({package:"foam.u2",name:"IFrameHTMLView",extends:"foam.u2.View",css:`
iframe {
border: 1px solid /*%GREY4%*/;
padding: 8px;
max-width: 100%;
box-sizing: border-box;
}
`,methods:[function render(){this.SUPER();this.addClass();this.start("iframe").attrs({srcdoc:this.data}).on("load",evt=>this.resizeIFrame(evt.target)).end()},function resizeIFrame(el){el.contentDocument.body.style.padding=0;el.contentDocument.body.style.margin=0;el.style.height=Math.max(el.contentDocument.documentElement.scrollHeight,el.contentDocument.body.firstElementChild.scrollHeight);el.style.width="100%"}]});
foam.CLASS({package:"foam.u2.tag",name:"Select",extends:"foam.u2.View",axioms:[{class:"foam.u2.TextInputCSS"}],css:`
^:disabled {
appearance: none;
-moz-appearance: none;
-webkit-appearance: none;
}
^ {
appearance: none;
-moz-appearance: none;
-webkit-appearance: none;
background: #ffffff url('/images/dropdown-icon.svg') no-repeat;
background-position: right 0.25em top 50%, 0 0;
box-shadow: none;
cursor: pointer;
max-width: 100%;
overflow: hidden;
padding-right: 2.1em;
text-overflow: ellipsis;
width: 100%;
}
^ option {
padding: 4px;
width: 100%;
}
^.expanded{
background: none;
padding: 0;
}
`,properties:[["nodeName","select"],{name:"choices",factory:function(){return[]}},{name:"placeholder",factory:function(){return undefined}},"size",{name:"header",},{name:"disabledData",factory:function(){return[]}}],methods:[function render(){this.SUPER();var self=this;this.addClass(this.myClass()).attrs({size:this.size$}).enableClass("expanded",this.size!=0).attrSlot().linkFrom(this.data$);if(this.size)this.style({height:"auto"});this.setChildren(this.slot(function(choices,placeholder,header,data){var cs=[];if(header){cs.push(self.E("optgroup").attrs({label:header}))}if(placeholder){cs.push(self.E("option").attrs({value:-1,selected:self.data===-1}).addClass("truncate-ellipsis").add(placeholder))}for(var i=0;i<choices.length;i++){var c=choices[i];let value=c[1];var isSelected=data==i;let e=self.E("option").attrs({value:i,selected:isSelected,disabled:!isSelected&&self.disabledData$.map(function(a){return a.some(o=>foam.util.equals(o,value))})}).translate(value+".name",value);if(value.toString().indexOf("  ")!==-1){e.el().then(el=>el.innerHTML=value.replace(/ /g,"&nbsp;"))}cs.push(e)}return cs}))},function updateMode_(mode){var disabled=mode===foam.u2.DisplayMode.DISABLED||mode===foam.u2.DisplayMode.RO;this.setAttribute("disabled",disabled)}]});
foam.CLASS({package:"foam.u2",name:"UnstyledTabs",extends:"foam.u2.Element",mixins:["foam.u2.memento.Memorable"],requires:["foam.u2.Tab"],properties:[{name:"selected",postSet:function(o,n){if(o)o.selected=false;n.selected=true;this.selectedLabel=n.label}},"tabRow",{name:"updateMemento",class:"Boolean"},{name:"selectedLabel",memorable:true}],methods:[function init(){this.selectedLabel$.sub(this.maybeResetMemento);this.addClass(this.myClass()).start("div",null,this.tabRow$).addClass(this.myClass("tabRow")).end().start("div",null,this.content$).addClass(this.myClass("content")).end()},function add(tab){if(this.Tab.isInstance(tab)){if(!this.selected&&!this.selectedLabel)this.selected=tab;if(tab.selected||this.selectedLabel==tab.label)this.selected=tab;this.tabRow.start("span").addClass(this.myClass("tab")).enableClass("selected",tab.selected$).on("click",function(){this.selected=tab}.bind(this)).add(tab.label$).end();tab.shown$=tab.selected$}this.SUPER(tab)}],listeners:[function maybeResetMemento(){if(!this.selectedLabel)return;this.memento_&&this.memento_.removeMementoTail()}]});
foam.CLASS({package:"foam.u2",name:"Tab",extends:"foam.u2.Element",properties:[{class:"String",name:"label"},{class:"Boolean",name:"selected"}]});
foam.CLASS({package:"foam.u2",name:"UnderlinedTabs",extends:"foam.u2.UnstyledTabs",css:`
^tabRow {
border-bottom: 1px solid #e7eaec;
background-color: white;
overflow-x: auto;
white-space: nowrap;
}
^tab {
border-top: 3px solid transparent;
border-bottom: 3px solid transparent;
display: inline-block;
height: 48px;
box-sizing: border-box;
padding: 13px 16px;
}
^tab:hover {
cursor: pointer;
}
^tab.selected {
border-bottom: 3px solid /*%PRIMARY3%*/ #406dea;
}
`});
foam.CLASS({package:"foam.u2",name:"Tabs",extends:"foam.u2.UnstyledTabs",css:`
^tabRow {
background-color: /*%WHITE%*/ white;
border-radius: 4px 4px 0 0;
border-bottom: 1px solid /*%GREY4%*/ #DADDE2;
display: flex;
gap: 12px 24px;
padding: 12px;
overflow-x: auto;
white-space: nowrap;
}
^tab {
align-items: center;
background: none;
border-radius: 4px;
color: /*%GREY1%*/ #494F59;
display: flex;
justify-content: center;
padding: 7px 12px;
}
^tab:hover {
background: /*%PRIMARY5%*/ #C6D2FF;
cursor: pointer;
}
^tab.selected {
background: /*%PRIMARY5%*/ #C6D2FF;
color: /*%PRIMARY1%*/ #202341;
font-weight: 600;
}
`});
foam.CLASS({package:"foam.u2",name:"TimeView",extends:"foam.u2.tag.Input",axioms:[{class:"foam.u2.TextInputCSS"}],css:`
^ {
width: fit-content;
}
`,methods:[function render(){this.SUPER();this.setAttribute("type","time")}]});
foam.CLASS({package:"foam.u2.history",name:"HistoryItemView",extends:"foam.u2.View",methods:[function outputRecord(parentView,record){}]});
foam.CLASS({package:"foam.u2.history",name:"HistoryView",extends:"foam.u2.View",requires:["foam.dao.history.HistoryRecord","foam.u2.history.HistoryItemView"],implements:["foam.mlang.Expressions"],css:`
^ {
height: 370px;
background: /*%WHITE%*/ #ffffff;
position: relative;
vertical-align: top;
border-radius: 2px;
overflow: auto;
font-size: 1.2rem;
padding-left: 20px;
padding-right: 20px;
z-index: 0;
}
^ h2 {
height: 20px;
opacity: 0.6;
font-size: 2.0rem;
font-weight: 300;
font-style: normal;
font-stretch: normal;
line-height: 1;
letter-spacing: 0.3px;
text-align: left;
color: /*%BLACK%*/ #1e1f21;
}
^ .timelineRecord {
position: relative;
}
^ .timeline {
width: 2px;
height: 100%;
background: rgba(164, 179, 184, 0.3);
position: absolute;
left: 23px;
top: 5px;
z-index: -1;
margin-bottom: 20px;
content: '';
}
^ > div:last-of-type .timeline {
display: none;
}
`,properties:["data","historyItemView",{class:"String",name:"title",value:"History"}],methods:[function render(){var view=this;this.addClass(this.myClass()).start("h2").add(this.title).end().select(view.data.orderBy(this.DESC(this.HistoryRecord.TIMESTAMP)),function(record){return this.E().start("div").addClass("timelineRecord").start("div").addClass("timeline").end().call(function(){view.historyItemView.outputRecord(this,record)}).end()})}]});foam.INTERFACE({package:"foam.u2.svg.map2d",name:"PlacementPlan",properties:[{name:"shape",class:"Array",}],methods:[{name:"getPlacement",type:"Array",args:[{name:"obj",type:"FObject"}],}]});foam.INTERFACE({package:"foam.u2.svg.map2d",name:"GridPlacementPlan",properties:[{name:"shape",class:"Array",}],methods:[{name:"getGridPlacement",type:"Array",args:[{name:"obj",type:"FObject"}],}]});foam.INTERFACE({package:"foam.u2.svg.map2d",name:"GridPlacementStrategy",properties:[{name:"data",class:"foam.dao.DAOProperty"}],methods:[{name:"getPlan",type:"foam.u2.svg.map2d.GridPlacementPlan"}]});
foam.CLASS({package:"foam.u2.svg.map2d",name:"PredeterminedGridPlacementPlan",implements:["foam.u2.svg.map2d.GridPlacementPlan"],properties:[{name:"coords",class:"Map"},{name:"shape",class:"Array"}],methods:[{name:"getPlacement",code:function getPlacement(id){return this.coords[id]||null}},function addAssociation_(id,coords,cellSize=[1,1]){this.coords[id]=coords;for(let i=0;i<coords.length;i++){this.shape[i]=Math.max(coords[i]+cellSize[i],this.shape[i])}}]});
foam.CLASS({package:"foam.u2.svg.map2d",name:"IdPropertyPlacementPlanDecorator",implements:["foam.u2.svg.map2d.GridPlacementPlan"],properties:[{name:"delegate",class:"FObjectProperty",of:"FObject"},{name:"targetProperty",class:"String"},{name:"shape",getter:function(){return this.delegate.shape}}],methods:[function getPlacement(obj){return this.delegate.getPlacement(obj[this.targetProperty])}]});
foam.CLASS({package:"foam.graph.map2d",name:"RelationshipGridPlacementStrategy",requires:["foam.u2.svg.map2d.PredeterminedGridPlacementPlan"],properties:[{name:"rootObject",class:"FObjectProperty"},{name:"graph",class:"FObjectProperty",of:"foam.graph.Graph"},{name:"shape",factory:function(){return[0,20]}},{name:"embeddedSecondaryRelationshipStrategy",class:"FObjectProperty",of:"foam.graph.map2d.ScaleNodeSecondaryRelationshipStrategy",}],methods:[{name:"getPlan",code:function getPlan(){var columns=[];var intermediatePlan={};var alreadyAdded={};let addCol=index=>{var col={position:index};if(index>=columns.length){columns.push(col);return col}columns.splice(index,0,col);for(let i=index+1;i<columns.length;i++){col.position++}return col};let addingQueue=[];let add;add=(obj,row,col,pushCols)=>{var entry=null;if(alreadyAdded[obj.id]){entry=intermediatePlan[obj.id];if(entry.row.position<row){entry.row.position=row}}else{alreadyAdded[obj.id]=true;entry={row:{position:row},col:pushCols?addCol(col):columns[col],obj:obj};intermediatePlan[entry.obj.id]=entry}childNodes=this.graph.getDirectChildren(obj.id,true);childNodes.forEach((o,i)=>{addingQueue.push({parent:entry,obj:o,index:i})});return Promise.resolve()};let maybeAddMore;maybeAddMore=()=>{if(addingQueue.length<1)return;let next=addingQueue.shift();var row=next.parent.row.position+1;var col=next.parent.col.position+next.index;return add(next.obj,row,col,next.index!=0).then(maybeAddMore)};if(this.embeddedSecondaryRelationshipStrategy){this.embeddedSecondaryRelationshipStrategy.nodeQueue=addingQueue;this.embeddedSecondaryRelationshipStrategy.addFunction=add;maybeAddMore=this.embeddedSecondaryRelationshipStrategy.getAddNodeFunction()}return add(this.graph.roots[0],0,0,true).then(maybeAddMore).then(()=>{var plan=this.PredeterminedGridPlacementPlan.create({shape:[0,0]});Object.values(intermediatePlan).forEach(entry=>{var baseCellSize=this.embeddedSecondaryRelationshipStrategy?this.embeddedSecondaryRelationshipStrategy.getBaseCellSize(entry.obj):[1,1];plan.addAssociation_(entry.obj.id,[entry.col.position,entry.row.position],baseCellSize)});return plan})}}]});
foam.CLASS({package:"foam.graph.map2d",name:"ScaleNodeSecondaryRelationshipStrategy",properties:[{name:"nodeQueue"},{name:"addFunction"},{name:"xScalePerSecondary",factory:function(){return 0}},{name:"yScalePerSecondary",factory:function(){return 0}}],methods:[{name:"getAddNodeFunction",code:function getAddNodeFunction(){var maybeAddMore=()=>{if(this.nodeQueue.length<1)return;let next=this.nodeQueue.shift();var row=next.parent.row.position+1;var col=next.parent.col.position+next.index;if(next.parent.obj.secondaryForwardLinks){var rowAdj=next.parent.obj.secondaryForwardLinks.length*this.yScalePerSecondary;var colAdj=next.parent.obj.secondaryForwardLinks.length*this.xScalePerSecondary;row+=rowAdj;col+=colAdj}return this.addFunction(next.obj,row,col,next.index!=0).then(maybeAddMore)};return maybeAddMore}},{name:"getBaseCellSize",code:function getBaseCellSize(obj){if(obj.secondaryForwardLinks===undefined){console.warn("obj.secondaryForwardLinks.length is undefined");console.warn("obj",obj);return[1,1]}var xScale=1+obj.secondaryForwardLinks.length*this.xScalePerSecondary;var yScale=1+obj.secondaryForwardLinks.length*this.yScalePerSecondary;return[1*xScale,1*yScale]}}]});
foam.CLASS({package:"foam.graph",name:"Graph",properties:[{name:"data",class:"Map"},{name:"roots",class:"Array"}],methods:[function getDirectChildren(parentId,order){var parentNode=this.data[parentId];var childNodes=parentNode.forwardLinks.map(link=>this.data[link.id]);if(order){let i=0;let idsBehind={};let swappedFrom={};while(i<childNodes.length){let node=childNodes[i];let needToSwap=false;for(let j=0;j<node.forwardLinks.length;j++){let link=node.forwardLinks[j];if(link.id==parentNode.data.id)continue;if(!idsBehind[link.id]){needToSwap=link;break}}if(needToSwap){if(swappedFrom[node.data.id]){swappedFrom={};idsBehind[node.data.id]=true;console.warn("circular relation detected",swappedFrom,node,needToSwap,idsBehind);i++}swappedFrom[node.data.id]=true;for(let ii=i+1;ii<childNodes.length;ii++){if(childNodes[ii].data.id==needToSwap){let tmp=childNodes[ii];childNodes[ii]=childNodes[i];childNodes[i]=tmp;break}}continue}swappedFrom={};idsBehind[childNodes[i].data.id]=true;i++}}return childNodes}]});
foam.CLASS({package:"foam.graph",name:"GraphNode",properties:[{name:"id",class:"String",expression:function(data){return data.id}},{name:"forwardLinks",class:"Array",adapt:function(_,n){var ids=new Set;var newArray=[];for(const v of n){if(!ids.has(v.id)){ids.add(v.id);newArray.push(v)}}return newArray}},{name:"inverseLinks",class:"Array",},{name:"data"}]});
foam.CLASS({package:"foam.graph",name:"GraphBuilder",implements:["foam.mlang.Expressions"],requires:["foam.graph.Graph","foam.graph.GraphNode"],properties:[{name:"data",class:"Map"},{name:"roots",class:"Array"}],methods:[function fromCompositeRelationship(rootObject,compositeRelationship,noRootAdd){if(!foam.dao.CompositeRelationship.isInstance(compositeRelationship)){throw new Error("No CompositeRelationship object detected")}var relationshipPromises=compositeRelationship.getPrimaryForwardNames().map(forwardName=>this.fromRelationship(rootObject,forwardName,noRootAdd,compositeRelationship));return Promise.all(relationshipPromises)},function fromRelationship(rootObject,relationshipKey,noRootAdd,compositeRelationship){if(!this.data[rootObject.id]){this.data[rootObject.id]=this.GraphNode.create({data:rootObject,id:rootObject.id});if(!noRootAdd)this.roots.push(this.data[rootObject.id])}var isRoot;this.roots.forEach(root=>{if(root.id===rootObject.id)isRoot=true});if(compositeRelationship&&compositeRelationship.getSecondaryForwardNames().length>0&&isRoot){var secondaryRelationshipKey=compositeRelationship.getSecondaryForwardNames()[0];var secondaryRelationshipDAO=rootObject[secondaryRelationshipKey].dao||rootObject[secondaryRelationshipKey];secondaryRelationshipDAO.select().then(secondaries=>{this.data[rootObject.id].secondaryForwardLinks=secondaries.array?secondaries.array:[secondaries]})}var parent=this.data[rootObject.id];var relationshipDAO=rootObject[relationshipKey].dao||rootObject[relationshipKey];return relationshipDAO.select().then(r=>Promise.all(r.array.map(o=>{parent.forwardLinks=[...parent.forwardLinks,{id:o.id}];if(compositeRelationship&&compositeRelationship.getSecondaryForwardNames().length>0){var secondaryRelationshipKey=compositeRelationship.getSecondaryForwardNames()[0];var secondaryRelationshipDAO=o[secondaryRelationshipKey].dao||o[secondaryRelationshipKey];secondaryRelationshipDAO.select().then(secondaries=>{this.data[o.id].secondaryForwardLinks=secondaries.array?secondaries.array:[secondaries]})}var fromPromise=compositeRelationship?this.fromCompositeRelationship(o,compositeRelationship,true):this.fromRelationship(o,relationshipKey,true);return fromPromise.then(()=>{this.data[o.id].inverseLinks=[...this.data[o.id].inverseLinks,{id:rootObject.id}]})})))},async function fromJunction(rootObject,objectDaoKey,junctionDaoKey,weightPropertyName,noRootAdd){if(!this.data[rootObject.id]){this.data[rootObject.id]=this.GraphNode.create({data:rootObject,id:rootObject.id});if(!noRootAdd)this.roots.push(this.data[rootObject.id])}var isRoot;this.roots.forEach(root=>{if(root.id===rootObject.id)isRoot=true});var junctionDAO=this.__subContext__[junctionDaoKey];var objectDAO=this.__subContext__[objectDaoKey];var currentJunctions=await junctionDAO.where(this.EQ(junctionDAO.of["SOURCE_ID"],rootObject.id)).select();var targetObjectsPromises=currentJunctions.array.map(junc=>{this.data[junc.sourceId].forwardLinks=[...this.data[junc.sourceId].forwardLinks,{id:junc.targetId,weight:junc[weightPropertyName]}];return objectDAO.find(junc.targetId)});var targetObjectsResolved=await Promise.all(targetObjectsPromises);var childJunctionPromises=targetObjectsResolved.map(res=>{return this.fromJunction(res,"capabilityDAO","prerequisiteCapabilityJunctionDAO","priority",true)});await Promise.all(childJunctionPromises);currentJunctions.array.forEach(junc=>{this.data[junc.targetId].inverseLinks=[...this.data[junc.targetId].inverseLinks,{id:rootObject.id,weight:junc[weightPropertyName]}]})},function build(){let graph=this.Graph.create({data:this.data});graph.roots=this.roots;return graph}]});foam.ENUM({package:"foam.graph",name:"TraversalOrder",values:["POST_ORDER","PRE_ORDER"]});foam.ENUM({package:"foam.graph",name:"WeightPriorityStrategy",values:["NONE","MIN","MAX"]});
foam.CLASS({package:"foam.graph",name:"GraphTraverser",topics:["process"],requires:["foam.graph.TraversalOrder"],properties:[{class:"Enum",of:"foam.graph.TraversalOrder",name:"order",value:"PRE_ORDER"},{class:"Enum",of:"foam.graph.WeightPriorityStrategy",name:"weightPriorityStrategy",value:"NONE"},{class:"FObjectProperty",of:"foam.graph.Graph",name:"graph"},{class:"Boolean",name:"allowDuplicatePairs",},"memo_",{class:"Map",name:"nodeToDescendants"},{class:"StringArray",name:"currentPath"}],methods:[function step(x){for(const fn of x.sequence)fn({...x})},function updateNodeToDescendants(currentNodeId){this.currentPath.forEach(ancestorId=>{this.nodeToDescendants[`${ancestorId}:${currentNodeId}`]=true})},function addToCurrentPath(currentNodeId){this.currentPath.push(currentNodeId)},function removeFromCurrentPath(currentNodeId){this.currentPath.filter(nodeId=>nodeId!==currentNodeId)}],actions:[function traverse(){this.memo_={};const RECUR=x=>{const forwardLinks=x.current.forwardLinks;if(this.weightPriorityStrategy==this.weightPriorityStrategy.MIN){forwardLinks.sort((l1,l2)=>l1.weight-l2.weight)}if(this.weightPriorityStrategy==this.weightPriorityStrategy.MAX){forwardLinks.sort((l1,l2)=>l2.weight-l1.weight)}const childNodes=forwardLinks.map(link=>this.graph.data[link.id]);for(const current of childNodes){this.updateNodeToDescendants(current.id);this.addToCurrentPath(current.id);this.step({...x,parent:x.current,current:current});this.removeFromCurrentPath(current.id)}};const VISIT=x=>{const memoKey=JSON.stringify([x.parent?.id,x.current?.id]);if(this.memo_[memoKey]&&!this.allowDuplicatePairs)return;this.memo_[memoKey]=true;this.process.pub(x)};const sequence=this.order===this.TraversalOrder.PRE_ORDER?[RECUR,VISIT]:[VISIT,RECUR];for(const current of this.graph.roots){this.addToCurrentPath(current.id);this.step({current:current,sequence:sequence});this.removeFromCurrentPath(current.id)}}]});
foam.CLASS({package:"foam.u2.svg",name:"Position",issues:["applyAsTransform does not preserve existing transforms","bindAsAttributes not yet implemented"],properties:[{class:"Int",name:"x"},{class:"Int",name:"y"}],methods:[function bind(element){if(element.nodeName==="g")return this.bindAsTransform(element);if(element.nodeName==="rect")return this.bindAsAttributes(element);console.warn(`Cannot find foam.u2.svg.position to a "${element.nodeName}" tag; `+"use a g, rect, or implement the missing functionality.")},function bindAsTransform(element){element.attrs({transform:this.slot(function(x,y){return`translate(${x}, ${y})`})})},function bindAsAttributes(element){throw new Error("not yet implemented")}]});
foam.CLASS({package:"foam.u2.svg",name:"RelativePosition",extends:"foam.u2.svg.Position",requires:["foam.u2.svg.Position"],properties:[{class:"FObjectProperty",of:"foam.u2.svg.Position",name:"reference"},{class:"FObjectProperty",of:"foam.u2.svg.Position",name:"amount",factory:function(){return this.Position.create({x:0,y:0})}},{name:"x",expression:function(reference$x,amount$x){return reference$x+amount$x}},{name:"y",expression:function(reference$y,amount$y){return reference$y+amount$y}}]});
foam.CLASS({package:"foam.u2.svg.arrow",name:"ArrowLine",extends:"foam.u2.Element",properties:[{name:"nodeName",value:"G"},{class:"FObjectProperty",of:"foam.u2.svg.Position",name:"startPos"},{class:"FObjectProperty",of:"foam.u2.svg.Position",name:"endPos"}]});
foam.CLASS({package:"foam.u2.svg.arrow",name:"VHVArrowLine",extends:"foam.u2.svg.arrow.ArrowLine",methods:[function render(){console.log("amaline",this);this.SUPER();var dy=Math.abs(this.endPos[1]-this.startPos[1]);var dx=Math.abs(this.endPos[0]-this.startPos[0]);var lines=[[this.startPos[0],this.startPos[1],this.startPos[0],this.startPos[1]+.5*dy],[this.endPos[0],this.endPos[1]-.5*dy,this.endPos[0],this.endPos[1]],[this.startPos[0],this.startPos[1]+.5*dy,this.endPos[0],this.endPos[1]-.5*dy]];this.forEach(lines,function(line){this.start("line").attrs({x1:line[0],y1:line[1],x2:line[2],y2:line[3],stroke:"black"}).end()})}]});
foam.CLASS({package:"foam.u2.svg.arrow",name:"SegmentedArrowLine",extends:"foam.u2.svg.arrow.ArrowLine",properties:[{name:"anchors",class:"Array"},{name:"lines",expression:function(startPos,anchors,endPos){anchors=[...anchors,endPos];var lines=[];let lastNode=startPos;for(let anchor of anchors){lines.push([lastNode,anchor]);lastNode=anchor}return lines}},{name:"hoverState",class:"Boolean"},{name:"toggleState",class:"Boolean"},{name:"stroke",expression:function(hoverState,toggleState){return hoverState&&toggleState?"cyan":toggleState?"blue":hoverState?"green":"black"}},"testing"],methods:[function render(){this.SUPER();this.on("mouseover",()=>{this.hoverState=true}).on("mouseleave",()=>{this.hoverState=false}).on("click",()=>{this.toggleState=!this.toggleState}).forEach(this.lines,function(line){this.start("line").attrs({x1:line[0].x$,y1:line[0].y$,x2:line[1].x$,y2:line[1].y$,stroke:this.stroke$,"stroke-width":3}).end()})}]});
foam.CLASS({package:"foam.u2.svg.arrow",name:"StraightArrowLine",extends:"foam.u2.svg.arrow.ArrowLine",methods:[function render(){console.log("i be rendererd");this.SUPER();this.start("line").attrs({x1:this.startPos.x$,y1:this.startPos.y$,x2:this.endPos.x$,y2:this.endPos.y$,stroke:"black"}).end()}]});
foam.CLASS({package:"foam.u2.svg.arrow",name:"ArrowHead",extends:"foam.u2.Element",properties:[{name:"nodeName",value:"G"},{class:"FObjectProperty",of:"foam.u2.svg.Position",name:"pos"},{name:"angle",class:"Float"},{name:"size",class:"Float"}]});
foam.CLASS({package:"foam.u2.svg.arrow",name:"SimpleArrowHead",extends:"foam.u2.svg.arrow.ArrowHead",methods:[function render(){this.SUPER();var a1=this.angle+Math.PI+Math.PI/4;var a2=this.angle+Math.PI-Math.PI/4;this.start("line").attrs({x1:this.pos.x$,y1:this.pos.y$,x2:this.pos.x$.map(x=>x+Math.sin(a1)*this.size),y2:this.pos.y$.map(y=>y+Math.cos(a1)*this.size),stroke:"black"}).end().start("line").attrs({x1:this.pos.x$,y1:this.pos.y$,x2:this.pos.x$.map(x=>x+Math.sin(a2)*this.size),y2:this.pos.y$.map(y=>y+Math.cos(a2)*this.size),stroke:"black"}).end()}]});
foam.CLASS({package:"foam.u2.svg.interactive",name:"Draggable",extends:"foam.u2.Element",imports:["svg"],properties:[["nodeName","g"],{class:"FObjectProperty",of:"foam.u2.svg.Position",name:"pos"},"dragState_"],methods:[function render(){this.addEventListener("mousedown",this.onMouseDown);this.addEventListener("mousemove",this.onMouseMove);this.addEventListener("mouseup",this.onMouseUp);this.addEventListener("mouseleave",this.onMouseUp);this.pos.bind(this)},async function transformMouseEvent(evt){const svg=await this.svg.el();const ctm=svg.getScreenCTM();return{x:(evt.clientX-ctm.e)/ctm.a,y:(evt.clientY-ctm.f)/ctm.d}}],listeners:[async function onMouseDown(evt){this.dragState={dragOrigin:await this.transformMouseEvent(evt),selfOrigin:{x:this.pos.x,y:this.pos.y}}},async function onMouseMove(evt){if(!this.dragState)return;const current=await this.transformMouseEvent(evt);console.log(this.dragState,current);const diffX=current.x-this.dragState.dragOrigin.x;const diffY=current.y-this.dragState.dragOrigin.y;this.pos.x=this.dragState.selfOrigin.x+diffX;this.pos.y=this.dragState.selfOrigin.y+diffY},function onMouseUp(evt){this.dragState=undefined}]});
foam.CLASS({package:"foam.u2.svg.graph",name:"ZoomedOutFObjectGraphNodeView",extends:"foam.u2.View",css:`
^ {
overflow: auto;
}
^view {
zoom: 0.7;
overflow: auto;
}
`,properties:[{name:"nodeName",value:"foreignObject"},{name:"size",class:"Array",factory:()=>[100,100]},{name:"position",class:"Array",factory:()=>[0,0]}],methods:[function render(){var dims={x:0,y:0,width:"100%",height:"100%"};this.addClass(this.myClass()).attrs(dims).start("div").attrs({xmlns:"http://www.w3.org/1999/xhtml"}).addClass(this.myClass("view")).add(this.data).end()}]});
foam.CLASS({package:"foam.u2.svg.graph",name:"ArrowDisplaceCellsPlacementPlan",implements:["foam.u2.svg.map2d.PlacementPlan"],properties:[{name:"gridGap",class:"Int",value:20},{name:"cellSize",class:"Array",factory:()=>[100,100]},{name:"displacementFactor",class:"Int",value:12},{name:"colDisplacement_",class:"Map"},{name:"rowDisplacement_",class:"Map"},{name:"gridPlacementPlan",class:"FObjectProperty",of:"foam.u2.svg.map2d.GridPlacementPlan"},{name:"width",getter:function(){let v=(this.cellSize[0]+this.gridGap)*this.gridPlacementPlan.shape[0];for(let k in this.colDisplacement_){v+=this.colDisplacement_[k]*this.displacementFactor}return v}},{name:"height",getter:function(){let v=(this.cellSize[1]+this.gridGap)*this.gridPlacementPlan.shape[1];for(let k in this.rowDisplacement_){v+=this.rowDisplacement_[k]*this.displacementFactor}return v}}],methods:[{name:"getPlacement",code:function getPlacement(id){var cellPosition=this.gridPlacementPlan.getPlacement(id);if(!cellPosition)return null;var x=(this.cellSize[0]+this.gridGap)*cellPosition[0];var y=(this.cellSize[1]+this.gridGap)*cellPosition[1];for(let i=0;i<=cellPosition[0];i++){if(!this.colDisplacement_.hasOwnProperty(i))continue;x+=this.colDisplacement_[i]*this.displacementFactor}for(let i=0;i<=cellPosition[1];i++){if(!this.rowDisplacement_.hasOwnProperty(i))continue;y+=this.rowDisplacement_[i]*this.displacementFactor}return[x,y]}},function getRowLanePosition(row,lane){return this.getLaneDisplacement_(this.rowDisplacement_,row,lane)},function getColLanePosition(col,lane){return this.getLaneDisplacement_(this.colDisplacement_,col,lane)},function getLaneDisplacement_(map,index,lane){var v=(this.cellSize[1]+this.gridGap)*index;for(let i=0;i<index;i++){if(!map.hasOwnProperty(i))continue;v+=map[i]*this.displacementFactor}v+=lane*this.displacementFactor;return v},function makeRoomInRow(row,lanes){this.rowDisplacement_[row]=lanes},function makeRoomInCol(col,lanes){this.colDisplacement_[col]=lanes}]});
foam.CLASS({package:"foam.u2.svg.graph",name:"DAGView",extends:"foam.u2.Element",requires:["foam.u2.svg.Position","foam.u2.svg.RelativePosition","foam.u2.svg.arrow.VHVArrowLine","foam.u2.svg.arrow.SimpleArrowHead","foam.u2.svg.arrow.StraightArrowLine","foam.u2.svg.arrow.SegmentedArrowLine","foam.u2.svg.graph.ArrowDisplaceCellsPlacementPlan","foam.u2.svg.interactive.Draggable"],exports:["graph","svg"],classes:[{name:"ArrowPlan",properties:[{name:"enterCellLane",class:"Int"},{name:"exitCellLane",class:"Int"},{name:"topRowLane",class:"Int"},{name:"columnLane",class:"Int"},{name:"bottomRowLane",class:"Int"}]}],properties:[{name:"graph",class:"FObjectProperty",of:"foam.graph.Graph"},{name:"selectedNodeId",class:"String",},{name:"nodeView",class:"foam.u2.ViewSpec",},{class:"Class",name:"nodeViewClass_",expression:function(nodeView){if(typeof nodeView?.create==="function")return nodeView;const cls=nodeView.class;if(typeof cls?.create==="function")return cls;return foam.lookup(cls)}},{name:"cellSize",class:"Array",factory:()=>[100,100]},{name:"gridGap",class:"Int",value:20},{name:"gridPlacement",class:"FObjectProperty",of:"foam.u2.svg.map2d.GridPlacementPlan"},{name:"placement_",class:"FObjectProperty",of:"foam.u2.svg.map2d.PlacementPlan",factory:function(){return this.ArrowDisplaceCellsPlacementPlan.create({gridPlacementPlan$:this.gridPlacement$,gridGap$:this.gridGap$,cellSize:this.cellSize})}},{class:"FObjectProperty",name:"embeddedSecondaryRelationshipStrategy",of:"foam.graph.map2d.ScaleNodeSecondaryRelationshipStrategy"},{class:"Boolean",name:"isArrowheadShown",value:true},{name:"zoom",class:"Float"},{name:"rowLanes_",factory:()=>({})},{name:"colLanes_",factory:()=>({})},{name:"cellLanes_",factory:()=>({})},{name:"arrows_",class:"Array"},{name:"alreadyRendered_",class:"Map"},{class:"Map",name:"nodeDraggables_"},{name:"svg"}],methods:[function render(){this.rowLanes_={};this.colLanes_={};this.cellLanes_={};this.arrows_=[];this.alreadyRendered_={};this.graph.roots.forEach(node=>{this.generateArrows(node)});for(let row in this.rowLanes_){this.placement_.makeRoomInRow(row,Object.keys(this.rowLanes_[row]).length)}for(let col in this.colLanes_){this.placement_.makeRoomInCol(col,Object.keys(this.colLanes_[col]).length)}var g=this.start("svg");this.svg=g;g.attrs({xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 "+(""+this.placement_.width)+" "+(""+this.placement_.height),width:this.placement_.width*this.zoom,height:this.placement_.height*this.zoom});this.graph.roots.forEach(node=>{this.renderBoxes(g,node)});this.graph.roots.forEach(node=>{this.renderArrows(g,node)})},function renderBoxes(g,node,parent){var self=this;var coords=this.placement_.getPlacement(node);if(coords==null){throw new Error(`DAGView can't get a placement for this node; is it in the graph?`);return}g.callIf(!self.alreadyRendered_[node.id],function(){self.alreadyRendered_[node.id]=true;var args={of:node.data.cls_,data:node.data,position:coords,size:self.cellSize};if(self.selectedNodeId&&self.nodeViewClass_.hasOwnAxiom("isSelected")){args.isSelected$=self.slot(function(selectedNodeId){return selectedNodeId===node.data.id})}if(self.gridGap&&self.nodeViewClass_.hasOwnAxiom("gridGap")){args.gridGap=self.gridGap}this.start(self.Draggable,{pos:self.Position.create({x:coords[0],y:coords[1]})}).call(function(){self.nodeDraggables_[node.id]=this}).attrs({width:self.cellSize[0],height:self.cellSize[1]}).tag(self.nodeView,args).end()});this.graph.getDirectChildren(node.id).forEach(childNode=>{this.renderBoxes(g,childNode,node)})},function renderArrows(g,node,parent){const self=this;if(parent){let arrows=this.arrows_[parent.id][node.id];let enterCell,exitCell;(()=>{let parentGridCoords=this.gridPlacement.getPlacement(parent);let nodeGridCoords=this.gridPlacement.getPlacement(node);enterCell=nodeGridCoords;exitCell=[parentGridCoords[0],parentGridCoords[1]+1]})();for(let arrow of arrows){let anchors=[];let enterCellLane=this.cellSize[1]*this.cellLaneRatio_(arrow.enterCellLane);let exitCellLane=this.cellSize[1]*this.cellLaneRatio_(arrow.exitCellLane);const parentDraggable=this.nodeDraggables_[parent.id];const nodeDraggable=this.nodeDraggables_[node.id];if(arrow.hasOwnProperty("topRowLane")){anchors.push(self.Position.create({x$:parentDraggable.pos.x$.map(x=>x+exitCellLane),y:this.placement_.getRowLanePosition(exitCell[1],arrow.topRowLane)}))}if(arrow.hasOwnProperty("columnLane")){anchors.push(self.Position.create({x:this.placement_.getColLanePosition(enterCell[0],arrow.columnLane),y:this.placement_.getRowLanePosition(exitCell[1],arrow.topRowLane)}));anchors.push(self.Position.create({x:this.placement_.getColLanePosition(enterCell[0],arrow.columnLane),y:this.placement_.getRowLanePosition(enterCell[1],arrow.bottomRowLane)}))}var lane=arrow.hasOwnProperty("bottomRowLane")?arrow.bottomRowLane:arrow.topRowLane;anchors.push(self.Position.create({x$:nodeDraggable.pos.x$.map(x=>x+enterCellLane),y:this.placement_.getRowLanePosition(enterCell[1],lane)}));g.tag(this.SegmentedArrowLine,{startPos:self.RelativePosition.create({reference:self.nodeDraggables_[parent.id].pos,amount:self.Position.create({x:exitCellLane,y:this.cellSize[1]})}),endPos:self.RelativePosition.create({reference:self.nodeDraggables_[node.id].pos,amount:self.Position.create({x:enterCellLane,y:0})}),anchors:anchors,testing:{node:node,parent:parent,arrow:arrow}});if(this.isArrowheadShown){g.tag(this.SimpleArrowHead,{pos:self.Position.create({x$:nodeDraggable.pos.x$.map(x=>x+enterCellLane),y$:nodeDraggable.pos.y$}),angle:0,size:5})}}}this.graph.getDirectChildren(node.id).forEach(childNode=>{this.renderArrows(g,childNode,node)})},function generateArrows(node,parent){if(parent){if(!this.arrows_[parent.id])this.arrows_[parent.id]={};if(!this.arrows_[parent.id][node.id])this.arrows_[parent.id][node.id]=[];let parentCoords=this.gridPlacement.getPlacement(parent);let nodeCoords=this.gridPlacement.getPlacement(node);var yAdj=1;if(this.embeddedSecondaryRelationshipStrategy){yAdj=this.embeddedSecondaryRelationshipStrategy.getBaseCellSize(parent)[1]}let hasDX=parentCoords[0]-nodeCoords[0]!=0;let hasDY=parentCoords[1]-nodeCoords[1]!=-yAdj;let enterCell=nodeCoords;let exitCell=[parentCoords[0],parentCoords[1]+yAdj];let arrow=this.ArrowPlan.create({enterCellLane:this.getCellLane(enterCell,Math.random()),enterCellLane:this.getCellLane(enterCell,parent.id),exitCellLane:this.getCellLane(exitCell,parent.id)});if(hasDX||hasDY){let row=exitCell[1];arrow.topRowLane=this.getLane(this.rowLanes_,row,node.id,parent.id)}if(hasDY){let row=enterCell[1];arrow.bottomRowLane=this.getLane(this.rowLanes_,row,node.id,parent.id);let col=enterCell[0];arrow.columnLane=this.getLane(this.colLanes_,col,node.id,parent.id)}this.arrows_[parent.id][node.id].push(arrow)}this.graph.getDirectChildren(node.id).forEach(childNode=>{this.generateArrows(childNode,node)})},function getCellLane(cell,id){return this.getLane(this.cellLanes_,this.hash_(...cell),id)},function getLane(laneMap,index,toNode,fromNode){var lanes=laneMap[index]||{};for(let k in lanes){if(lanes[k]==toNode)return k;if(fromNode&&lanes[k]==fromNode)return k;if(fromNode&&lanes[k].includes(":")){var parts=lanes[k].split(":");if(parts[0]==toNode){lanes[k]=toNode;return k}if(parts[1]==fromNode){lanes[k]=fromNode;return k}}}var lane=Object.keys(lanes).length;laneMap[index]={...lanes,[lane]:fromNode?`${toNode}:${fromNode}`:toNode};return lane},function hash_(x,y){return(x+y)*(x+y+1)/2+x},function cellLaneRatio_(lane){let f0=v=>Math.pow(2,Math.floor(Math.log2(v+1)));let f1=v=>(v-f0(v)+2)*2-1;return f1(lane)/(2*f0(lane))}]});
foam.CLASS({package:"foam.u2.svg",name:"TreeGraph",extends:"foam.u2.Element",requires:["foam.u2.svg.arrow.VHVArrowLine","foam.u2.svg.arrow.SimpleArrowHead"],css:`
^p {
/*
note: "pixels" are relative to SVG viewport
*/
font-size: 1rem;
text-align: center;
}
`,properties:[{name:"graph",class:"FObjectProperty",of:"foam.graph.Graph"},{name:"nodePlacementPlan",class:"FObjectProperty",of:"FObject"},{name:"nodeView",class:"foam.u2.ViewSpec"},{name:"size",class:"Int",value:100},{name:"gap",class:"Int",value:20},{name:"alreadyRendered_",class:"Map"}],methods:[function render(){var size=this.size;var gap=this.gap;var self=this;var g=this.start("svg");this.graph.roots.forEach(node=>{console.log("rendering root",node);this.renderBoxes(g,node)});var shape=this.nodePlacementPlan.shape;g.attrs({xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 "+(""+(shape[0]*(size+gap)+gap))+" "+(""+(shape[1]*(size+gap)+gap))}).end()},function renderBoxes(g,node,parent){var self=this;var size=this.size;var gap=this.gap;var coords=this.nodePlacementPlan.getPlacement(node);if(coords==null)return;if(!Array.isArray(coords)){console.warn("unexpected return time from placement",typeof coords,coords)}g.callIf(!self.alreadyRendered_[node.id],function(){self.alreadyRendered_[node.id]=true;this.tag(self.nodeView,{data:node.data,position:coords.map(v=>gap+v*(size+gap)),size:Array(coords.length).fill(self.size)})}).callIf(parent,function(){var pcoords=self.nodePlacementPlan.getPlacement(parent);this.tag(self.VHVArrowLine,{startPos:[pcoords[0]*(size+gap)+gap+.5*size,pcoords[1]*(size+gap)+gap+size],endPos:[coords[0]*(size+gap)+gap+.5*size,coords[1]*(size+gap)+gap]}).tag(self.SimpleArrowHead,{originPos:[coords[0]*(size+gap)+gap+.5*size,coords[1]*(size+gap)+gap],angle:0,size:5})});this.graph.getDirectChildren(node.id).forEach(childNode=>{this.renderBoxes(g,childNode,node)})}]});
foam.CLASS({package:"foam.u2.svg",name:"TestView",extends:"foam.u2.Element",methods:[function render(){this.start("svg").attrs({xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 30 20"}).start("rect").attrs({x:"0",y:"0",width:"30",height:"20",fill:"#fafafa"}).end().start("rect").attrs({x:"0",y:"0",width:"30",height:"20",fill:"#fafafa"}).end().start("rect").attrs({x:"4",y:"5",width:"8",height:"10",fill:"#007bff"}).end().start("rect").attrs({x:"18",y:"5",width:"8",height:"10",fill:"#888"}).end().end()}]});
foam.CLASS({package:"foam.u2.view",name:"EnumLegendView",extends:"foam.u2.View",requires:["foam.u2.crunch.Style"],css:`
^container {
border-style: solid;
border-width: thin;
}
^eachValue {
display: inline-flex;
padding: 12px;
text-align: justify;
}
`,properties:[{class:"Class",name:"of"},{class:"Array",name:"enumValueToHide"}],methods:[function render(){this.SUPER();var style=this.Style.create();style.addBinds(this);this.start().addClass(this.myClass("container")).start("h3").add("Status Legend").end().add(this.of.VALUES.filter(statusEnum=>!this.enumValueToHide.includes(statusEnum.name)).map(statusEnum=>{return this.E().start().addClass(this.myClass("eachValue")).start().add(foam.u2.view.ReadOnlyEnumView.create({data:statusEnum})).end().start().add(statusEnum.documentation).end().end()})).end()}]});
foam.CLASS({package:"foam.u2.view",name:"RadioButton",extends:"foam.u2.Element",imports:["theme?"],css:`
^innerCircle.selected{
r: 5px;
}
^innerCircle{
transition: 0.1s ease;
transform-origin: center center;
transform-box: stroke-box;
r: 0px;
}
`,properties:[["nodeName","svg"],{name:"selectedColor",expression:function(isSelected,isDisabled){if(isDisabled){return this.theme?this.theme.grey4:"#E7EAEC"}if(isSelected){return this.theme?this.theme.primary3:"#406DEA"}return this.theme?this.theme.grey2:"#9BA1A6"}},{name:"isDisabled",class:"Boolean"},{name:"isSelected",class:"Boolean"}],methods:[function render(){this.addClass("radio").attrs({width:20,height:20}).start("circle").attrs({cx:10,cy:10,r:8,stroke:this.selectedColor$,"stroke-width":2,"transform-origin":"0 0",fill:"none"}).end().start("circle").addClass(this.myClass("innerCircle")).enableClass("selected",this.isSelected$).attrs({cx:10,cy:10,r:0,fill:this.selectedColor$}).end()}]});
foam.CLASS({package:"foam.u2.view",name:"RichTextView",extends:"foam.u2.View",requires:["foam.nanos.menu.LinkMenu","foam.u2.ToggleActionView","foam.u2.view.RichTextValidator"],imports:["document","window"],css:`
^{
display: flex;
flex-direction: column;
}
^editor:empty:before{
content: attr(placeholder);
pointer-events: none;
display: block;
color: /*%GREY3%*/ #B2B6BD;
}
^ > * + * {
margin-top: 4px;
}
^editor {
border: 1px solid /*%GREY4%*/ #6B778C;
border-radius: 4px;
height: unset;
overflow: auto;
padding: 10px;
position: relative;
width: 100%;
}
^dragged{
background: /*%PRIMARY5%*/ #E5F1FC;
border: 2px dashed /*%PRIMARY3%*/ #406DEA;
}
^dragged::after{
content: "Drop Here";
font-weight: bold;
left: 50%;
position: absolute;
top: 50%;
transform: translate(-50%, -50%);
z-index: 100;
}
^ButtonToolbar {
display: flex;
gap: 8px;
}
^ButtonToolbar > button + button {
margin-left: 0 !important;
}
^seperator{
background: /*%GREY2%*/ #6B778C;
width: 1px;
height: 2em;
align-self: center;
}
^tool.foam-u2-ActionView {
padding: 6px 10px;
max-height: unset;
}
`,messages:[{name:"PLACEHOLDER_MSG",message:"Enter text/drop HTML"}],properties:[{name:"data",postSet:function(_,n){if(!n)this.clearInput()}},{class:"String",name:"height",value:"400"},{class:"String",name:"width",value:"100%"},{name:"placeholder",description:"Placeholder text to appear when no text is entered.",factory:function(){return this.PLACEHOLDER_MSG}},"richText","currentSel_","bold_","italic_","underline_","link_",["allowSelections",false],["isDragged_",false],{class:"Proxy",of:"foam.u2.DefaultValidator",name:"validator",factory:function(){return this.RichTextValidator.create()}}],methods:[function render(){this.SUPER();this.onDetach(this.document.addEventListener("selectionchange",()=>{if(!this.allowSelection)return;this.currentSel_=this.window.getSelection().getRangeAt(0)}));this.addClass(this.myClass()).startContext({data:this}).start().addClass(this.myClass("ButtonToolbar")).tag(this.ToggleActionView,{action:this.BOLD,data:this},this.bold_$).tag(this.ToggleActionView,{action:this.ITALIC,data:this},this.italic_$).tag(this.ToggleActionView,{action:this.UNDERLINE,data:this},this.underline_$).start(this.LINK,{themeIcon:"link",size:"SMALL"},this.link_$).addClass(this.myClass("tool")).end().start().addClass(this.myClass("seperator")).end().start(this.LEFT_JUSTIFY,{themeIcon:"leftAlign",size:"SMALL"}).addClass(this.myClass("tool")).end().start(this.CENTER_JUSTIFY,{themeIcon:"centerAlign",size:"SMALL"}).addClass(this.myClass("tool")).end().start(this.RIGHT_JUSTIFY,{themeIcon:"rightAlign",size:"SMALL"}).addClass(this.myClass("tool")).end().start().addClass(this.myClass("seperator")).end().start(this.NUMBERED_LIST,{themeIcon:"numberedList",size:"SMALL"}).addClass(this.myClass("tool")).end().start(this.BULLET_LIST,{themeIcon:"bulletedList",size:"SMALL"}).addClass(this.myClass("tool")).end().start().addClass(this.myClass("seperator")).end().start(this.DECREASE_INDENTATION,{themeIcon:"decreaseIndentation",size:"SMALL"}).addClass(this.myClass("tool")).end().start(this.INCREASE_INDENTATION,{themeIcon:"increaseIndentation",size:"SMALL"}).addClass(this.myClass("tool")).end().start(this.BLOCK_QUOTE,{themeIcon:"blockQuote",size:"SMALL"}).addClass(this.myClass("tool")).end().end().endContext().start("",{},this.richText$).addClass(this.myClass("editor")).attr("contentEditable",true).attr("placeholder",this.placeholder).enableClass(this.myClass("dragged"),this.isDragged_$).on("input",this.parseInnerHTML).on("focus",()=>{this.allowSelection=true}).on("blur",()=>{this.allowSelection=false}).on("paste",this.onPaste).on("dragover",e=>{this.isDragged_=true;e.preventDefault()}).on("dragenter",e=>{this.isDragged_=true;e.preventDefault()}).on("dragleave",e=>{this.isDragged_=false;e.preventDefault()}).on("drop",this.onDrop).end();this.bold_.actionState$.mapFrom(this.currentSel_$,()=>{return this.document.queryCommandState("bold")});this.italic_.actionState$.mapFrom(this.currentSel_$,()=>{return this.document.queryCommandState("italic")});this.underline_.actionState$.mapFrom(this.currentSel_$,()=>{return this.document.queryCommandState("underline")})},function sanitizeDroppedHtml(html){return this.validator.sanitizeText(html.replace(/&lt;/g,"<").replace(/&gt;/g,">"))},function getSelectionText(){var selection=this.window.getSelection();if(selection.rangeCount){return selection.getRangeAt(0).toLocaleString()}return""},function clearInput(){if(this.richText&&this.richText.el_())this.richText.el_().innerHTML=""},function insertElement(e,sel){var selection=this.window.getSelection();if(sel||selection.rangeCount){var range=sel||selection.getRangeAt(0);range.deleteContents();range.insertNode(e);range.collapse()}else{var range=this.document.createRange();range.selectNodeContents(this.richText.el_());range.insertNode(e);range.collapse()}selection.removeAllRanges();selection.addRange(range);this.parseInnerHTML(null,true)}],listeners:[{name:"onDrop",code:function(e){e.preventDefault();this.isDragged_=false;length=e.dataTransfer.items.length;if(length){var txt=e.dataTransfer.getData("text/html");if(!txt)txt=e.dataTransfer.getData("text/plain");var div=this.sanitizeDroppedHtml(txt);this.insertElement(div)}}},{name:"onPaste",code:function(e){e.preventDefault();if(e&&e.inputType&&e.inputType=="insertFromPaste"){if(e?.dataTransfer?.getData("text/html")||e?.dataTransfer?.getData("text/plain")){var txt=e?.dataTransfer?.getData("text/html")||e?.dataTransfer?.getData("text/plain");this.insertElement(this.sanitizeDroppedHtml(txt))}}else if(e&&e.type&&e.type=="paste"){var txt=e.clipboardData.getData("text");this.insertElement(this.sanitizeDroppedHtml(txt))}return false}},{name:"parseInnerHTML",isFramed:true,code:function(_,opt_skipValidate){var el=this.richText.el_();if(opt_skipValidate){this.data=el.innerHTML.replace(/&lt;/g,"<").replace(/&gt;/g,">");return}var sanitized=this.sanitizeDroppedHtml(el.innerHTML);var div=document.createElement("div");div.style.dispaly="none";div.appendChild(sanitized);this.document.body.appendChild(div);this.data=div.innerHTML.replace(/&lt;/g,"<").replace(/&gt;/g,">");this.document.body.removeChild(div)}}],actions:[{name:"bold",label:"B",toolTip:"Bold",code:function(){this.richText.focus();this.document.execCommand("bold")}},{name:"italic",label:"I",toolTip:"Italic",code:function(){this.richText.focus();this.document.execCommand("italic")}},{name:"underline",label:"U",toolTip:"Underline",code:function(){this.richText.focus();this.document.execCommand("underline")}},{name:"link",label:"",buttonStyle:"TERTIARY",toolTip:"Insert link",code:function(){var rect=this.link_.el_().getBoundingClientRect();this.RichLink.create({richTextView:this,label:this.getSelectionText()}).open(rect.x,rect.y)}},{name:"leftJustify",label:"",buttonStyle:"TERTIARY",toolTip:"Align Left",code:function(){this.richText.focus();this.document.execCommand("justifyLeft")}},{name:"centerJustify",label:"",buttonStyle:"TERTIARY",toolTip:"Align Center",code:function(){this.richText.focus();this.document.execCommand("justifyCenter")}},{name:"rightJustify",label:"",buttonStyle:"TERTIARY",toolTip:"Align Right",code:function(){this.richText.focus();this.document.execCommand("justifyRight")}},{name:"numberedList",label:"",buttonStyle:"TERTIARY",toolTip:"Numbered List",code:function(){this.richText.focus();this.document.execCommand("insertOrderedList")}},{name:"bulletList",label:"",buttonStyle:"TERTIARY",toolTip:"Bulleted List",code:function(){this.richText.focus();this.document.execCommand("insertUnorderedList")}},{name:"decreaseIndentation",label:"",buttonStyle:"TERTIARY",toolTip:"Indent Less",code:function(){this.richText.focus();this.document.execCommand("outdent")}},{name:"increaseIndentation",label:"",buttonStyle:"TERTIARY",toolTip:"Indent More",code:function(){this.richText.focus();this.document.execCommand("indent")}},{name:"blockQuote",label:"",buttonStyle:"TERTIARY",toolTip:"Quote",code:function(){this.richText.focus();this.document.execCommand("formatBlock",true,"<blockquote>")}}],classes:[{name:"RichLink",extends:"foam.u2.Element",requires:["foam.u2.md.OverlayDropdown"],css:`
^ {
display: flex;
flex-direction: column;
}
^ > * + * {
margin-top: 8px;
}
^insert {
align-self: flex-end;
}
`,properties:[{class:"FObjectProperty",of:"foam.u2.Element",name:"overlay_",factory:function(){return this.OverlayDropdown.create({closeOnLeave:false})}},{name:"richTextView"},{class:"String",name:"label",placeholder:"Link text"},{class:"String",name:"link",placeholder:"Type or paste link.",preSet:function(_,value){value=value.trim();if(value.toLowerCase().includes("javascript:")||value.toLowerCase().includes("url")||value.toLowerCase().includes("eval"))value="";return value}},["overlayInitialized_",false]],methods:[function initializeOverlay(){this.overlayInitialized_=true;this.overlay_.parentEl=this.richTextView;this.overlay_.start().addClass(this.myClass()).startContext({data:this}).add(this.LABEL).add(this.LINK).start().addClass(this.myClass("insert")).add(this.INSERT).end().endContext().end();ctrl.add(this.overlay_)},function open(x,y){if(!this.overlayInitialized_)this.initializeOverlay();this.overlay_.open(x,y)}],actions:[{name:"insert",label:"Add Link",buttonStyle:"PRIMARY",toolTip:"Insert this link into the document.",code:function(){var el=this.document.createElement("a");el.href=this.link||"";el.target="_blank";el.title=this.label||this.link||"";el.appendChild(this.document.createTextNode(this.label||this.link||""));this.richTextView.insertElement(el,this.richTextView.currentSel_);this.richTextView.document.body.focus();this.overlay_.close()}}]}]});
foam.CLASS({package:"foam.u2.view",name:"RichTextValidator",extends:"foam.u2.DefaultValidator",axioms:[foam.pattern.Singleton.create()],imports:["document"],requires:["foam.u2.Element"],methods:[function sanitizeText(text){var allowedElements=[{name:"B",attributes:[]},{name:"I",attributes:[]},{name:"U",attributes:[]},{name:"P",attributes:["style"]},{name:"SECTION",attributes:[]},{name:"BR",attributes:[]},{name:"BLOCKQUOTE",attributes:[]},{name:"OL",attributes:[]},{name:"UL",attributes:[]},{name:"LI",attributes:[]},{name:"DIV",attributes:["style"]},{name:"A",attributes:["href"]},{name:"SPAN",attributes:["style"]},{name:"#text",attributes:[]}];function copyNodes(parent,node){for(var i=0;i<allowedElements.length;i++){if(allowedElements[i].name===node.nodeName){if(allowedElements[i].clone){newNode=allowedElements[i].clone(node)}else if(node.nodeType===Node.ELEMENT_NODE){newNode=this.document.createElement(node.nodeName);for(var j=0;j<allowedElements[i].attributes.length;j++){var currAttr=allowedElements[i].attributes[j];if(node.hasAttribute(currAttr)){var attr=node.getAttribute(currAttr);attr=attr.trim();if(!(attr.toLowerCase().includes("javascript:")||attr.toLowerCase().includes("url(")||attr.toLowerCase().includes("eval("))){newNode.setAttribute(currAttr,node.getAttribute(currAttr))}}}}else if(node.nodeType===Node.TEXT_NODE){newNode=document.createTextNode(node.nodeValue)}else{newNode=document.createTextNode("")}break}}if(i===allowedElements.length){newNode=document.createElement("div")}if(newNode&&parent.appendChild){parent.appendChild(newNode)}for(j=0;j<node.childNodes?.length;j++){if(node.childNodes[j].nodeType===Node.TEXT_NODE){var n=this.document.createTextNode(node.childNodes[j].nodeValue);newNode.appendChild(n);continue}copyNodes(newNode,node.childNodes[j])}}var frame=this.document.createElement("iframe");frame.sandbox="allow-same-origin";frame.style.display="none";this.document.body.appendChild(frame);frame.contentDocument.body.innerHTML=text;var sanitizedContent=new DocumentFragment;for(var i=0;i<frame.contentDocument.body.childNodes.length;i++){copyNodes(sanitizedContent,frame.contentDocument.body.childNodes[i])}this.document.body.removeChild(frame);return sanitizedContent}]});
foam.CLASS({package:"foam.u2",name:"ToggleActionView",extends:"foam.u2.ActionView",css:`
^active, ^active svg {
background-color: /*%GREY5%*/ #F5F7FA;
color: /*%PRIMARY3%*/ #494F59;
fill: /*%PRIMARY3%*/ #494F59;
border-color: /*%PRIMARY3%*/ #406DEA;
}
`,properties:[{class:"Boolean",name:"actionState"},{name:"buttonStyle",value:foam.u2.ButtonStyle.TERTIARY}],methods:[function initCls(){this.SUPER();this.enableClass(this.myClass("active"),this.actionState$)}],listeners:[function click(){this.SUPER();this.actionState=!this.actionState}]});
foam.CLASS({package:"foam.u2.view",name:"LoginView",extends:"foam.u2.View",imports:["appConfig","loginVariables","memento","stack","theme","displayWidth?","loginSuccess"],requires:["foam.u2.Element","foam.u2.borders.SplitScreenGridBorder","foam.nanos.u2.navigation.SignIn","foam.nanos.u2.navigation.SignUp"],css:`
^.foam-u2-ActionView {
width: 100%;
}
/* ON RIGHT SIDE ALL **** */
^ .centerVertical {
padding-top: 3vh;
max-width: 30vw;
margin: 0 auto;
}
/* SET ABOVE MODEL */
^ .topBar-logo-Back {
height: 6vh;
background: /*%LOGOBACKGROUNDCOLOUR%*/ #202341;
}
/* SET ON LOGO IMG */
^ .logoCenterVertical {
margin: 0 auto;
text-align: center;
display: block;
}
^ .top-bar-img {
padding-left: 1vh;
height: 4vh;
padding-top: 1vh;
}
/* TITLE TXT ON MODEL */
^ .title-top {
font-size: 2.5em;
padding-top: 2vh;
font-weight: bold;
}
/* ON MODEL */
^content-form {
align-self: center;
width: 75%;
padding: 2vw;
box-sizing: border-box;
}
/* ON ALL FOOTER TEXT */
^ .bold-text-with-pad {
font-weight: bold;
margin-right: 0.2em;
}
^center-footer {
text-align: center;
}
^center-footer > ^signupLink {
margin-bottom: 2rem;
}
/* TOP-TOP BAR NAV to go with backLink_ */
^ .top-bar-nav {
background: /*%LOGOBACKGROUNDCOLOUR%*/ #202341;
width: 100%;
height: 4vh;
border-bottom: solid 1px #e2e2e3
}
/* ON TXT IN TOP-TOP NAV */
^ .topBar-txt-link {
cursor: pointer;
font-size: 2.5vh;
font-weight: normal;
font-style: normal;
font-stretch: normal;
letter-spacing: normal;
color: #8e9090;
margin-left: 2vw;
margin-top: 1vw;
}
/* DISCLAIMER */
/* ON NO IMG SPLIT & IMG SPLIT */
^ .disclaimer-login {
width: 35vw;
font-size: 0.75em;
color: #8e9090;
margin-left: 12vw;
line-height: 1.5;
background: transparent;
}
/* ON LEFT SIDE IMG */
^ .cover-img-block1 {
/* align img with disclaimer */
display: flex;
flex-direction: column;
flex-wrap: nowrap;
align-items: center;
}
^image-one {
width: 28vw;
}
^wideImage { width: 50vw; }
^fullWidth { width: 100%; }
`,properties:[{class:"Boolean",name:"topBarShow_",factory:function(){return!!this.backLink_},hidden:true},{name:"model",factory:()=>{return{}},view:{class:"foam.u2.detail.VerticalDetailView"}},{name:"param",factory:function(){return{}}},{class:"String",name:"mode_",hidden:true},{class:"String",name:"imgPath",expression:function(loginVariables){return loginVariables.imgPath||""}},{class:"String",name:"backLinkTxt_",factory:function(){let temp=this.backLink_.includes("www.")?this.backLink_.substring(this.backLink_.indexOf("www.")+4):this.backLink_;return temp.includes("://")?temp.substring(temp.indexOf("://")+3):temp}},{class:"String",name:"backLink_",factory:function(){return this.model.backLink_||this.appConfig.externalUrl||undefined},hidden:true},{class:"Boolean",name:"shouldResize"}],messages:[{name:"GO_BACK",message:"Go to "},{name:"MODE1",message:"SignUp"}],methods:[function init(){this.param.dao_=!!this.param.dao_?this.param.dao_:this.loginVariables.dao_;if(this.mode_===this.MODE1){this.model=this.SignUp.create(this.param,this)}else{this.model=this.SignIn.create(this.param,this)}},function render(){this.SUPER();var self=this;this.document.addEventListener("keyup",this.onKeyPressed);this.onDetach(()=>{this.document.removeEventListener("keyup",this.onKeyPressed)});let logo=this.theme.largeLogo?this.theme.largeLogo:this.theme.logo;var right=this.E().start().hide(this.imgPath$).addClass("topBar-logo-Back").start("img").attr("src",logo).addClass("top-bar-img").end().end().start().addClass("title-top").add(this.model.TITLE).end().addClass(self.myClass("content-form")).callIf(self.displayWidth,function(){this.onDetach(self.displayWidth$.sub(self.resize))}).enableClass(self.myClass("fullWidth"),self.shouldResize$).startContext({data:this}).tag(this.MODEL).endContext().br().br().start().addClass(this.myClass("center-footer")).start().addClass(this.myClass("signupLink")).start("span").addClass("bold-text-with-pad").add(this.model.FOOTER_TXT).end().start("span").addClass("link").add(this.model.FOOTER_LINK).on("click",()=>{this.model.footerLink(this.topBarShow_,this.param)}).end().end().start().start("span").addClass("bold-text-with-pad").add(this.model.SUB_FOOTER_TXT).end().start("span").addClass("link").add(this.model.SUB_FOOTER_LINK).on("click",()=>{this.model.subfooterLink()}).end().end().end();if(this.imgPath){var split=this.SplitScreenGridBorder.create();split.rightPanel.add(right)}else{right.addClass("centerVertical").start().addClass("disclaimer-login").add(this.model.DISCLAIMER).end()}this.addClass().start().addClass("top-bar-nav").show(this.topBarShow_).start().start().addClass("topBar-txt-link").start("span").addClass("horizontal-flip").addClass("inline-block").add("➔").end().start("span").add(this.GO_BACK).add(this.backLinkTxt_).on("click",()=>{window.location=this.backLink_}).end().end().end().end().callIfElse(!!this.imgPath&&!!split,()=>{split.leftPanel.addClass("cover-img-block1").start("img").addClass(self.myClass("image-one")).attr("src",this.imgPath$).enableClass(self.myClass("wideImage"),self.shouldResize$).end().start("p").addClass("disclaimer-login").addClass("disclaimer-login-img").add(this.model.DISCLAIMER).end();this.add(split)},function(){this.add(right)})}],listeners:[{name:"resize",isFramed:true,code:function(){if(this.displayWidth=="MD"||this.displayWidth=="SM"||this.displayWidth=="XS"||this.displayWidth=="XXS"){this.shouldResize=true}else{this.shouldResize=false}}},function onKeyPressed(e){e.preventDefault();var key=e.key||e.keyCode;if(key==="Enter"||key===13){this.model.login()}}]});
foam.CLASS({package:"foam.u2.view",name:"DocumentUploadView",extends:"foam.u2.View",requires:["foam.nanos.fs.fileDropZone.FileDropZone","foam.nanos.fs.fileDropZone.FilePreview"],css:`
^{
display: inline-grid;
grid-template-columns: repeat(12, 1fr);
gap: 24px 24px;
justify-items: start;
}
^left-container{
grid-column: 1 / 5;
width: 100%;
}
^right-container{
grid-column: 5 / 12;
}
`,methods:[function render(){let selectSlot=foam.core.SimpleSlot.create({value:0});this.SUPER();this.addClass(this.myClass()).start().addClass(this.myClass("left-container")).add(this.FileDropZone.create({files$:this.data$,selected$:selectSlot})).end().start().addClass(this.myClass("right-container")).add(this.FilePreview.create({data$:this.data$,selected$:selectSlot})).end()}]});
foam.CLASS({package:"foam.u2.view",name:"ValueView",extends:"foam.u2.View",properties:[["nodeName","SPAN"],{name:"prop"}],methods:[function fromProperty(prop){this.SUPER(prop);this.prop=prop},function render(){this.SUPER();var self=this;var prop=this.prop;if(prop&&prop.unitPropValueToString){var unitPropSlot=self.__subContext__.objData?.slot(prop.unitPropName);this.add(unitPropSlot?unitPropSlot.map(unitProp=>this.slot(function(data){return prop.unitPropValueToString.call(self.__subContext__.objData,self.__subContext__,data,unitProp)})):this.slot(function(data){return prop.unitPropValueToString.call(self.__subContext__.objData,self.__subContext__,data,self.__subContext__.objData[prop.unitPropName])}))}else{this.add(this.data$)}}]});
foam.CLASS({package:"foam.u2.view",name:"LiteralValueView",extends:"foam.u2.View",properties:[{name:"view",class:"foam.u2.ViewSpec",value:{class:"foam.u2.view.ValueView"}},{name:"value",class:"Object"}],methods:[function render(){this.tag(this.view,{data$:this.value$})}]});
foam.CLASS({package:"foam.u2.view",name:"PreView",extends:"foam.u2.view.ValueView",properties:[["nodeName","pre"]]});
foam.CLASS({package:"foam.u2.view",name:"TableCellFormatterReadView",extends:"foam.u2.View",imports:["data as parentObj"],properties:["prop"],methods:[function render(){var self=this;this.SUPER();this.add(this.slot(function(data,prop){if(!prop)return;return this.E().call(function(){prop.tableCellFormatter.format(this,data,self.parentObj,prop)})}))},function fromProperty(prop){this.prop=prop;this.SUPER(prop)}]});
foam.CLASS({package:"foam.u2.view",name:"MultiBoxInputView",extends:"foam.u2.View",requires:["foam.core.ArraySlot","foam.u2.TextField"],css:`
^ {
width: 80%;
display: flex;
flex-direction: row;
align-items: center;
justify-content: flex-start;
}
^ input {
border-width: 1px;
border-radius: 5px;
width: 48px;
height: 48px;
text-align: center;
margin: 8px 14px 8px 0;
font-size: 2.2rem;
}
^ .wrong-code {
border-color: #f91c1c;
background-color: #fff6f6;
}
`,properties:[{class:"String",name:"data"},{class:"Boolean",name:"incorrectCode"},{class:"Int",name:"currentIndex",value:0,preSet:function(old,nu){if(nu>this.numOfParts-1)return this.numOfParts-1;if(nu<1)return 0;return nu}},{class:"Int",name:"numOfParts",value:6},{class:"FObjectArray",of:"foam.u2.Element",name:"elements"}],methods:[function render(){this.SUPER();var self=this;for(let i=0;i<this.numOfParts;i++){var isFirstElement=i===0;let v=this.TextField.create({onKey:true});v.setAttribute("maxlength",1);v.setAttribute("autofocus",isFirstElement);v.addClass("input").enableClass("wrong-code",this.incorrectCode$);v.on("focus",()=>{self.currentIndex=i});v.on("keydown",e=>{switch(e.keyCode){case 37:this.currentIndex--;break;case 39:this.currentIndex++;break;case 8:if(this.elements[this.currentIndex].data===" "||!this.elements[this.currentIndex].data){this.currentIndex--};break}this.elements[this.currentIndex].focus()});this.tag(v).addClass(this.myClass());this.onDetach(v.data$.sub(this.onDataUpdate));this.elements.push(v)}this.onDetach(this.data$.follow(this.ArraySlot.create({slots:this.elements.map(elm=>elm.data$)}).map(arr=>arr.reduce((str,c)=>str+(c||" "),""))))}],listeners:[{name:"onDataUpdate",code:function(detachable,eventName,propertyName,propertySlot){if(propertySlot.get()){this.currentIndex++;this.elements[this.currentIndex].focus()}}}]});
foam.CLASS({package:"foam.u2",name:"FragmentedTextField",extends:"foam.u2.View",requires:["foam.core.ArraySlot"],css:`
^ {
display: flex;
position: relative;
}
^symbol {
display: flex;
align-items: center;
margin-left: -1px;
margin-right: -1px;
line-height: 100%;
/* TODO: get from theme when available */
padding-left: 8px;
padding-right: 8px;
}
^ > *:not(:first-child):not(:last-child) {
border-radius: 0 !important;
}
^ > *:first-child {
border-top-right-radius: 0 !important;
border-bottom-right-radius: 0 !important;
}
^ > *:last-child {
border-top-left-radius: 0 !important;
border-bottom-left-radius: 0 !important;
}
^fragment {
text-align: center;
}
`,constants:[{type:"Array",name:"BACKSPACE_OR_DELETE",value:[8,46]}],properties:[{name:"delegates",class:"Array"},{class:"Int",name:"currentIndex",value:0,preSet:function(old,nu){if(nu>this.numOfParts-1)return this.numOfParts-1;if(nu<1)return 0;return nu}},{class:"Int",name:"numOfParts",value:0}],methods:[function render(){return this.addClass(this.myClass()).createInnerFields()},function createInnerFields(){var slots=[];for(let i=0;i<this.delegates.length;i++){let e=this.delegates[i];if(typeof e==="string"){this.start().addClass(this.myClass("symbol")).add(e).end();continue}else if(e.cls_===foam.u2.FragmentedTextFieldFragment){e=e.view}var u2Elem=this.start(e).style({width:this.delegates[i].maxLength*10}).addClass(this.myClass("fragment"));u2Elem.on("focus",()=>{this.currentIndex=i});u2Elem.on("keydown",evt=>{if(this.BACKSPACE_OR_DELETE.includes(evt.keyCode)){evt.preventDefault();evt.stopPropagation();this.onDelete()}});slots.push(u2Elem.data$)}this.data$=this.ArraySlot.create({slots:slots}).map(arr=>{return""+arr.join("")});this.data$.sub(this.onDataUpdate);this.numOfParts=this.delegates.length;return this},function processData(data,index,arr){var currentElement=this.childNodes[index];if(!data||!currentElement)return arr;var maxLength=this.delegates[index].maxLength;arr.push(data.substring(0,maxLength));return this.processData(data.substring(maxLength),index+2,arr)},async function onDelete(){var el=await this.childNodes[this.currentIndex].el();var start=el.selectionStart==el.selectionEnd&&el.selectionStart>0?el.selectionStart-1:el.selectionStart;this.childNodes[this.currentIndex].data=el.value.substr(0,start)+el.value.substr(el.selectionEnd);el.selectionStart=el.selectionEnd=start;if(el.value&&el.selectionStart>0)return;var prevIndex=this.currentIndex>0?this.currentIndex-1:0;while(this.childNodes[prevIndex]&&!foam.u2.TextField.isInstance(this.childNodes[prevIndex])){prevIndex--}if(this.currentIndex!=prevIndex){var prev=this.childNodes[prevIndex];var prevE=await prev.el();prevE.setSelectionRange(prev.data.length+1,prev.data.length+1);prev.focus()}}],listeners:[{name:"onDataUpdate",code:function(){var arr=this.processData(this.childNodes[this.currentIndex].data,this.currentIndex,[]);for(var i=0;i<arr.length;i++){var nextIndex=this.currentIndex+1;while(this.childNodes[nextIndex]&&!foam.u2.TextField.isInstance(this.childNodes[nextIndex])){nextIndex++}this.childNodes[this.currentIndex].data=arr[i];if(next=this.childNodes[nextIndex]){if(this.delegates[this.currentIndex].maxLength>arr[i].length)break;if(!(next&&next.data)){this.currentIndex=nextIndex;next.focus()}else break}}this.childNodes[this.currentIndex].focus()}}]});
foam.CLASS({package:"foam.u2",name:"FragmentedTextFieldFragment",properties:[{name:"view",expression:function(data){return{class:"foam.u2.TextField",onKey:true,data:data}}},{class:"String",name:"data"},{class:"Int",name:"maxLength"}]});foam.INTERFACE({package:"foam.u2",name:"TextFormatter",properties:[{name:"formatter",class:"Object"}],methods:[{name:"getPlaceholder",args:"String formattedData",},{name:"getMaxLength",},{name:"getUnformatted",args:"String formattedData",},{name:"onDelete",args:"String data, Int start, Int end",},{name:"formatData",args:"String data, String old, Int startingPos, Int endPos, Boolean isDelete",},{name:"reset",},{name:"buildJavaGetFormatted",args:"String cls, String prop",},{name:"buildJavaRemoveFormatting",}]});
foam.CLASS({package:"foam.u2",name:"SuffixFormatter",implements:["foam.u2.TextFormatter"],properties:[{class:"String",name:"placeholderText",value:"name"},{class:"Int",name:"maxLength",value:10}],methods:[function getPlaceholder(formattedData){if(!formattedData)return this.placeholderText+this.formatter;return formattedData},function getUnformatted(formattedData){return formattedData.endsWith(this.formatter)?formattedData.substring(0,formattedData.length-this.formatter.length):formattedData},function getMaxLength(){return this.maxLength+this.formatter.length},function formatData(data,old,startingPos,endPos,isDelete){if(!isDelete&&old&&!data.endsWith(this.formatter)){var oldVal=old;while(old&&data&&data.length>startingPos&&data.slice(-1)===old.slice(-1)){data=data.slice(0,-1);old=old.slice(0,-1)}if(data.startsWith(this.getUnformatted(oldVal)))return[oldVal,old.length]}else{data=this.getUnformatted(data)}var suf=data.slice(startingPos);var pre=data.slice(0,startingPos).replace(/\W/g,"").slice(0,this.maxLength-suf.length);if(!(pre||suf))return["",0];return[pre+suf+this.formatter,pre.length]},function onDelete(data,start,end){if(data.endsWith(this.formatter)){if(end>data.length-this.formatter.length)end=data.length;if(start>data.length-this.formatter.length)start=data.length-this.formatter.length}return[start,end]},function buildJavaGetFormatted(cls,prop){return`
if ( ! ((${cls}) o).${prop}IsSet_ ) return "";
String ret = ((${cls}) o).${prop}_;
ret = ret.trim().replaceAll("[^\\\\\w]", "");
if ( foam.util.SafetyUtil.isEmpty(ret) ) return "";
return ret + "${this.formatter}";
`},function buildJavaRemoveFormatting(){if(!this.formatter)return"";return`
if ( ! foam.util.SafetyUtil.isEmpty(val) && val.endsWith("${this.formatter}") )
val = val.substring(0, val.length() - ${this.formatter.length});
`}]});
foam.CLASS({package:"foam.u2",name:"NumericCodeFormatter",implements:["foam.u2.TextFormatter"],properties:["includeTrailingDelimiter"],methods:[function getPlaceholder(formattedData,placeholder){if(!placeholder)placeholder=this.formatter.join("").replace(/\d+/g,function(match){return"#".repeat(match)});if(!formattedData)return placeholder;return(formattedData||"")+placeholder.substring(formattedData&&formattedData.length||0)},function getMaxLength(){return this.getPlaceholder().length},function onDelete(input,start,end){this.includeTrailingDelimiter=false;if(isNaN(input[start])){while(start>0&&isNaN(input[start-1]))start--}else{if(input.substring(end).replace(/\D/g,"")=="")this.includeTrailingDelimiter=true}return[start,end]},function reset(){this.includeTrailingDelimiter=true},function formatData(data,old,startingPos,endPos,isDelete){var unformattedData=data.replace(/\D/g,"");if(endPos<data.length)this.includeTrailingDelimiter=false;var digitsBeforeSelectionStart=pos=data.substring(0,startingPos).replace(/\D/g,"").length;var temp="";var index=0;for(const format of this.formatter){if(typeof format==="number"||!isNaN(format)){temp+=unformattedData.substring(index,index+=format);if(index>unformattedData.length||index==unformattedData.length&&!this.includeTrailingDelimiter)break}else if(typeof format==="string"){temp+=format;if(index<=digitsBeforeSelectionStart)pos+=format.length;if(isDelete&&startingPos==0&&index==0)startingPos+=format.length}}return[temp,isDelete?startingPos:pos]},function getUnformatted(formattedData){return formattedData.replace(/\D/g,"")},function buildJavaGetFormatted(cls,prop){var str=`
if ( ! ((${cls}) o).${prop}IsSet_ ) return "";
StringBuilder ret = new StringBuilder(((${cls}) o).${prop}_);
`;var index=0;this.formatter.forEach(c=>{if(!isNaN(c))index+=c;else{str+=`
if ( ret.length() < ${index} ) return ret.toString();
ret.insert(${index}, "${c}");
`;index++}});return str+=`return ret.length() > ${index} ? ret.toString().substring(0, ${index}) : ret.toString();`},function buildJavaRemoveFormatting(){return`val.replaceAll("[^\\\\\d]", "");`}]});
foam.CLASS({package:"foam.u2",name:"FormattedTextField",extends:"foam.u2.View",requires:["foam.u2.TextField"],css:`
^ {
display: flex;
flex-direction: column;
height: /*%INPUTHEIGHT%*/ 34px;
justify-content: center;
position: relative;
width: 100%;
}
^placeholder.foam-u2-TextField {
bottom: 0;
font-size: 1.4rem;
inline-size: fit-content;
left: 0;
letter-spacing: normal;
opacity: 0.7;
pointer-events: none;
position: absolute;
right: 0;
top: 0;
width: fit-content;
}
^real-input.foam-u2-TextField {
z-index: 1;
background-color: transparent;
bottom: 0;
left: 0;
position: absolute;
right: 0;
top: 0;
width: fit-content;
}
`,constants:[{type:"Array",name:"BACKSPACE_OR_DELETE",value:[8,46]}],properties:[{class:"FObjectProperty",of:"foam.u2.TextFormatter",name:"formatter",},"formattedData",{name:"placeholder",factory:function(){return this.formatter.getPlaceholder()}},{name:"dynamicPlaceholder",expression:function(placeholder,formattedData,mode){return mode===foam.u2.DisplayMode.RW?this.formatter.getPlaceholder(formattedData,placeholder):""},},{class:"Boolean",name:"returnFormatted",},"isDelete","formatted"],methods:[function render(){this.resetState();this.formattedData$.sub(detachable=>{this.formatData(detachable.src.oldValue)});this.formattedData=this.data||"";return this.addClass(this.myClass()).start(this.TextField,{onKey:true,data$:this.formattedData$,mode$:this.mode$}).addClass(this.myClass("real-input")).end().start(this.TextField,{autocomplete:false,data$:this.dynamicPlaceholder$,mode$:this.mode$}).addClass(this.myClass("placeholder")).end().on("paste",evt=>{if(!evt.clipboardData.types.includes("text/plain")||!evt.clipboardData.getData("text").trim()){evt.preventDefault();evt.stopPropagation()}}).on("keydown",evt=>{if(this.BACKSPACE_OR_DELETE.includes(evt.keyCode))this.setStateOnDelete(evt)})},function setStateOnDelete(evt){this.isDelete=true;var start=evt.target.selectionStart;var end=evt.target.selectionEnd;if(start==end)start--;var range=this.formatter.onDelete(this.formattedData,start,end);evt.target.setSelectionRange(range[0],range[1])},async function resetState(){this.isDelete=false;this.formatted=false;this.formatter.reset&&this.formatter.reset();if(this.hasOwnProperty("formattedData"))this.data=this.returnFormatted?this.formattedData:this.formatter.getUnformatted(this.formattedData)}],listeners:[{name:"formatData",code:async function(old){if(this.formatted){this.resetState();return}var el=await this.el();var startingPos=el.children[0].selectionStart;var endPos=el.children[0].selectionEnd;var formatted=this.formatter.formatData(this.formattedData,old,startingPos,endPos,this.isDelete);if(formatted[0]!=this.formattedData){this.formatted=true;this.formattedData=formatted[0];el.children[0].setSelectionRange(formatted[1],formatted[1])}this.resetState()}}]});
foam.CLASS({package:"foam.u2.view",name:"UserPropertyAvailabilityView",extends:"foam.u2.View",implements:["foam.mlang.Expressions"],imports:["userPropertyAvailabilityService"],requires:["foam.u2.TextField"],css:`
^ {
position: relative;
}
^icon {
height: 14px;
width: 14px;
position: absolute;
right: 0;
margin-right: 11px;
margin-top: 11px;
}
`,properties:[{class:"String",name:"icon"},{class:"Boolean",name:"onKey"},{class:"String",name:"fromPropertyName"},{class:"Boolean",name:"isAvailable",},{class:"Boolean",name:"showIcon",value:false},{type:"Regex",name:"inputValidation",},{type:"Regex",name:"restrictedCharacters",},{class:"Enum",of:"foam.u2.DisplayMode",name:"displayMode",value:foam.u2.DisplayMode.RW}],methods:[function render(){this.start().addClass(this.myClass()).start({class:"foam.u2.tag.Image",data:this.icon}).addClass(this.myClass("icon")).attr("name",this.fromPropertyName+"Icon").show(this.showIcon$).end().start(this.TextField,{type:this.type,data$:this.data$,placeholder:this.placeholder,onKey:this.onKey,mode:this.displayMode}).addClass(this.myClass("input")).attr("name",this.fromPropertyName+"Input").on("blur",this.checkAvailability).on("keyup",e=>{if(this.restrictedCharacters&&!this.restrictedCharacters.test(e.key)){e.preventDefault()}this.checkAvailability()}).end().end()},function fromProperty(prop){this.SUPER(prop);if(!this.placeholder&&prop.placeholder){this.placeholder=prop.placeholder}if(!this.type&&prop.type){this.type=prop.type}this.fromPropertyName=prop.name}],listeners:[function checkAvailability(){if(this.inputValidation&&!this.inputValidation.test(this.data)){this.showIcon=false;return}this.userPropertyAvailabilityService.checkAvailability(this,this.fromPropertyName,this.data).then(isAvailable=>{this.isAvailable=isAvailable;this.showIcon=isAvailable})}]});
foam.CLASS({package:"foam.u2.view",name:"FObjectView",extends:"foam.u2.Controller",imports:["setTimeout","strategizer?"],requires:["foam.core.Latch"],messages:[{name:"PLACEHOLDER_TEXT",message:"select..."}],properties:[{class:"foam.core.FObjectProperty",of:"foam.core.Latch",name:"choicesLoaded",factory:function(){return this.Latch.create()}},{class:"String",name:"objectClass",label:"",visibility:function(allowCustom,classIsFinal,choices,data,placeholder){if(!allowCustom&&choices.length<=1&&!this.hasOwnProperty("placeholder"))return foam.u2.DisplayMode.HIDDEN;if(classIsFinal&&this.dataWasProvided_)return foam.u2.DisplayMode.HIDDEN;return foam.u2.DisplayMode.RW},view:function(args,X){return{class:X.data.allowCustom?"foam.u2.TextField":"foam.u2.view.ChoiceView",displayWidth:60,placeholder:X.data.placeholder,header:X.data.header,choices$:X.data.choices$}}},{name:"config"},{class:"FObjectProperty",name:"data",label:"",preSet:function(o,n){return n||o},view:"foam.u2.detail.SectionedDetailView"},{class:"foam.u2.ViewSpec",name:"dataView",},{class:"Class",name:"of",factory:function(){return this.data.cls_}},{class:"Boolean",name:"skipBaseClass",value:false},{class:"Boolean",name:"allowCustom"},{class:"Function",name:"copyOldData",value:function(o){return o}},{class:"Boolean",name:"classIsFinal",},{class:"Boolean",name:"dataWasProvided_",},{class:"String",name:"placeholder",expression:function(){return this.PLACEHOLDER_TEXT},},{class:"String",name:"header",},{class:"Array",name:"choices",},{name:"predicate",},{class:"foam.u2.ViewSpec",name:"detailView",value:{class:"foam.u2.detail.VerticalDetailView"}}],methods:[function fromProperty(prop){this.of=prop.of},function updateChoices(){if(this.of==null||this.of.id=="foam.core.FObject"){this.choices=[];this.choicesLoaded.resolve();return}if(this.strategizer!=null){this.strategizer.query(null,this.of.id,null,this.predicate).then(strategyReferences=>{if(!Array.isArray(strategyReferences)||strategyReferences.length===0){this.choices=this.skipBaseClass?[]:[[this.of.id,this.of.model_.label]];this.choicesLoaded.resolve();return}var choices=strategyReferences.reduce((arr,sr)=>{if(!sr.strategy){console.warn("Invalid strategy reference: "+sr.id);return arr}return arr.concat([[sr.strategy.id,sr.strategy.model_.label]])},[]).filter(x=>x);choices.sort((a,b)=>a[1]>b[1]?1:-1);this.choices=choices;this.choicesLoaded.resolve()}).catch(err=>console.warn(err))}else{this.choices=this.choicesFallback(this.of)}},async function render(){this.SUPER();function dataToClass(d){return d?d.cls_.id:""}var classToData=c=>{if(!c)return undefined;var m=c&&this.__context__.maybeLookup(c);return m.create(this.data?this.copyOldData(this.data):null,this)};this.dataWasProvided_=!!this.data;if(!this.data&&this.objectClass)this.data=classToData(this.objectClass);if(!this.choices.length){this.onDetach(this.of$.sub(this.updateChoices));this.updateChoices();await this.choicesLoaded;if(this.state==this.UNLOADED)return;if(this.state==this.OUTPUT){await new Promise(resolve=>this.onload.sub(resolve))}}this.onDetach(this.data$.relateTo(this.objectClass$,dataToClass,classToData));if(this.data){this.objectClass=dataToClass(this.data)}if(!this.data&&!this.objectClass&&this.choices.length&&!this.hasOwnProperty("placeholder"))this.objectClass=this.choices[0][0];this.start(this.OBJECT_CLASS,{data$:this.objectClass$}).show(this.OBJECT_CLASS.createVisibilityFor(foam.core.SimpleSlot.create({value:this}),this.controllerMode$).map(function(m){return m!=foam.u2.DisplayMode.HIDDEN})).end().start().show(this.objectClass$).tag(this.detailView,{data$:this.data$,config$:this.config$}).end()},function choicesFallback(of){if(!of)return[];var modelIdToDeps=Object.values(foam.USED).concat(Object.values(foam.UNUSED)).reduce((map,m)=>{var deps=m.implements?m.implements.map(imp=>{return foam.String.isInstance(imp)?imp:imp.path}):[];if(m.extends)deps.push(m.extends);var id=m.id||m.package+"."+m.name;map[id]=deps;return map},{});var choices={};choices[of.id]=true;while(true){var prev=Object.keys(choices).length;for(var[id,deps]of Object.entries(modelIdToDeps)){if(deps.filter(d=>choices[d]).length)choices[id]=true}if(prev==Object.keys(choices).length)break}return Object.keys(choices).map(id=>foam.lookup(id).model_).filter(m=>!foam.core.InterfaceModel.isInstance(m)).filter(m=>!m.abstract).map(m=>[m.id,m.label])}]});
foam.CLASS({package:"foam.u2.view",name:"CollapseableDetailView",extends:"foam.u2.View",requires:["foam.u2.layout.Cols"],css:`
^.expanded ^view {
margin: 8px 0;
}
^citation-view {
width: 100%;
display: flex;
align-items: center;
}
`,properties:[{class:"Boolean",name:"isCollapsed",value:true},{class:"foam.u2.ViewSpec",name:"view",value:{class:"foam.u2.DetailView"}},{class:"foam.u2.ViewSpec",name:"citationView",expression:function(data){return{class:"foam.u2.CitationView",of:data&&data.cls_}}}],actions:[{name:"showAction",label:"",icon:"images/expand-more.svg",isAvailable:function(isCollapsed){return isCollapsed},code:function(){this.isCollapsed=false}},{name:"hideAction",label:"",icon:"images/expand-less.svg",isAvailable:function(isCollapsed){return!isCollapsed},code:function(){this.isCollapsed=true}}],methods:[function render(){var self=this;self.SUPER();this.addClass();this.enableClass("expanded",this.isCollapsed$,true);self.startContext({data:self}).start(self.Cols).add(self.slot(function(citationView){return citationView?self.E().tag(citationView,{data$:self.data$}).addClass(this.myClass("citation-view")):null})).tag(self.SHOW_ACTION,{buttonStyle:"UNSTYLED"}).tag(self.HIDE_ACTION,{buttonStyle:"UNSTYLED"}).end().endContext().add(self.slot(function(view,isCollapsed){if(isCollapsed)return null;return self.E().start(view,{data$:self.data$}).addClass(self.myClass("view")).end()}))}]});
foam.CLASS({package:"foam.u2.view",name:"ReferenceCitationView",extends:"foam.u2.CitationView"});
foam.CLASS({package:"foam.u2.view",name:"ReadReferenceView",extends:"foam.u2.View",requires:["foam.comics.v2.DAOControllerConfig","foam.u2.detail.SectionedDetailView","foam.u2.view.ReferenceCitationView"],axioms:[foam.pattern.Faceted.create()],properties:["obj",{name:"of",expression:function(obj){return obj.cls_}},"prop",{class:"String",name:"linkTo",},{class:"Boolean",name:"enableLink",value:true},{name:"menuKeys",}],imports:["ctrl","menuDAO","pushMenu","stack"],methods:[{name:"render",code:function(){var self=this;this.SUPER();this.add(this.obj$.map(obj=>{if(!obj)return"";if(this.enableLink){return this.E().start("a").attrs({href:"#"}).on("click",evt=>{evt.preventDefault();if(self.linkTo==="daoSummary"){const pred=foam.mlang.predicate.False.create();self.stack.push({class:"foam.comics.v2.DAOSummaryView",data:self.obj,of:self.obj.cls_,backLabel:"Back",config:self.DAOControllerConfig.create({daoKey:self.prop.targetDAOKey,createPredicate:pred,editPredicate:pred,deletePredicate:pred,editEnabled:false})},self)}else{self.pushMenu(self.linkTo)}}).tag(self.ReferenceCitationView,{data:obj}).end()}else{return this.E().start().tag(self.ReferenceCitationView,{data:obj}).end()}}))}},function fromProperty(prop){this.SUPER(prop);this.prop=prop;this.enableLink=this.prop.enableLink&&this.enableLink;this.menuKeys=this.prop.menuKeys||this.menuKeys;this.configLink().then(()=>{const dao=this.ctrl.__subContext__[prop.targetDAOKey];if(dao){dao.find(this.data).then(o=>this.obj=o)}})},async function configLink(){if(!this.enableLink){this.enableLink=false;this.linkTo="";return}try{if(this.menuKeys){const permissions=await Promise.all([...this.menuKeys].map(menuId=>{return this.menuDAO.find(menuId)}));const firstMenu=permissions.find(p=>p);if(firstMenu){this.enableLink=true;if(firstMenu.handler&&firstMenu.handler.config&&firstMenu.handler.config.daoKey===this.prop.targetDAOKey){this.linkTo="daoSummary"}else{this.linkTo=firstMenu.id}}else{this.enableLink=false;this.linkTo=""}}else{if(this.__subContext__[this.prop.targetDAOKey]){this.enableLink=true;this.linkTo="daoSummary"}else{this.enableLink=false;this.linkTo=""}}}catch(e){console.error(e);this.enableLink=true;this.linkTo="daoSummary"}}]});
foam.CLASS({package:"foam.u2.view",name:"ReadManyToManyRelationshipPropertyView",extends:"foam.u2.View",exports:["click","click as dblclick"],imports:["stack","memento"],requires:["foam.u2.view.ScrollTableView","foam.u2.view.EmbeddedTableView","foam.comics.v2.DAOControllerConfig"],property:["config"],methods:[function render(){this.SUPER();this.config=this.DAOControllerConfig.create({dao:this.data.dao});this.tag(this.EmbeddedTableView,{data:this.data.dao,config:this.config})},function click(obj,id){if(!this.stack)return;this.stack.push({class:"foam.comics.v2.DAOSummaryView",data:obj,config:this.config,idOfRecord:id,backLabel:"Back"},this.__subContext__.createSubContext({memento:null}))}]});
foam.CLASS({package:"foam.u2.view",name:"ReferenceArrayView",extends:"foam.u2.view.ArrayView",imports:["foam.mlang.sink.Count"],properties:[{class:"String",name:"daoKey"},{class:"foam.dao.DAOProperty",name:"dao",expression:function(daoKey){return this.__context__[daoKey]}},{name:"valueView",expression:function(dao){return{class:"foam.u2.view.ReferenceView",dao:dao,defaultValue:"",disabledData$:this.disabledData_$}}}],methods:[function init(){this.SUPER();if(!this.allowDuplicates){this.dao.select(this.Count.create()).then(c=>this.arrayLength_=c.value)}}]});
foam.CLASS({package:"foam.u2.view",name:"DraftDetailView",extends:"foam.u2.View",topics:["cancelUpdate","dataUpdate"],imports:["onCancel?","onSave?"],css:`
^actionBar {
align-items: center;
display: flex;
justify-content: flex-end;
gap: 8px;
width: 100%;
}
^actionBar > * {
justify-self: flex-end;
}
^ {
display: flex;
gap: 8px;
flex-direction: column;
}
`,properties:[{class:"foam.u2.ViewSpec",name:"view",value:{class:"foam.u2.DetailView"}},{class:"FObjectProperty",name:"workingData"}],actions:[{name:"save",isEnabled:function(workingData$errors_){return!workingData$errors_},isAvailable:function(controllerMode){return controllerMode!=foam.u2.ControllerMode.VIEW},code:function(){this.data=this.workingData;this.onSave&&this.onSave(this.data)}},{name:"cancel",code:function(){this.onCancel&&this.onCancel(this.data)}}],reactions:[["","propertyChange.data","updateWorkingData"]],listeners:[{name:"updateWorkingData",isFramed:true,code:function(){this.workingData=this.data&&this.data.clone()}}],methods:[function render(){this.SUPER();this.updateWorkingData();this.addClass(this.myClass()).tag(this.view,{data$:this.workingData$}).startContext({data:this}).start().addClass(this.myClass("actionBar")).tag(this.SAVE,{buttonStyle:"PRIMARY"}).tag(this.CANCEL,{buttonStyle:"TERTIARY"}).end().endContext()}]});
foam.CLASS({package:"foam.u2.view",name:"TitledArrayView",extends:"foam.u2.view.FObjectArrayView",imports:["theme"],css:`
^ .foam-u2-DetailView {
border: 1px solid #ddd;
margin-bottom: 8px;
}
^header-row {
align-items: center;
}
`,properties:[{name:"title",}],methods:[function render(){var self=this;this.onDetach(this.data$.sub(()=>{if(!this.feedback_)this.data2_=this.data}));this.data2_=this.data;this.addClass();this.add(this.slot(function(data2_,valueView){var data=data2_;return self.E().start(self.Rows).forEach(data||[],function(e,i){var row=self.Row.create({index:i,value:e});this.startContext({data:row}).addClass(self.myClass("value-view-container")).start(self.Cols).addClass(self.myClass("header-row")).start().addClass("h500").add((self.title||foam.String.labelize(e.cls_.name))+" #"+(i+1)).end().tag(self.Row.REMOVE,{buttonStyle:"TERTIARY",themeIcon:"trash",icon:"data:image/svg+xml;utf8,%0A%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24'%3E%3Cpath d='M0 0h24v24H0z' fill='none'/%3E%3Cpath fill='%23d9170e' d='M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm5 11H7v-2h10v2z'/%3E%3C/svg%3E"}).end().start(valueView,{data$:row.value$}).addClass(self.myClass("value-view")).end().start().style({margin:"10px 0px",width:"100%",border:"1px solid","border-color":this.theme?this.theme.grey4:"grey"}).end().endContext();row.onDetach(row.sub(self.updateDataWithoutFeedback))})})).startContext({data:this}).tag(this.ADD_ROW,{size:"SMALL",buttonStyle:"SECONDARY",themeIcon:"plus",icon:"data:image/svg+xml;utf8,%0A%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24'%3E%3Cpath d='M0 0h24v24H0z' fill='none'/%3E%3Cpath fill='%2317d90e' d='M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm5 11h-4v4h-2v-4H7v-2h4V7h2v4h4v2z'/%3E%3C/svg%3E"}).endContext()}]});
foam.CLASS({package:"foam.u2.view",name:"FObjectArrayView",extends:"foam.u2.view.ArrayView",css:`
^ .foam-u2-DetailView {
border: 1px solid #ddd;
margin-bottom: 8px;
}
`,properties:[{class:"Class",name:"of"},{name:"defaultNewItem",expression:function(of){return foam.core.InterfaceModel.isInstance(of.model_)?null:of.create(null,this.__subContext__)}},{name:"valueView",expression:function(of){return{class:"foam.u2.DetailView"}}}],methods:[function fromProperty(p){this.SUPER(p);if(!this.of&&p.of)this.of=p.of}]});
foam.CLASS({package:"foam.u2.view",name:"ChoiceView",extends:"foam.u2.View",implements:["foam.mlang.Expressions"],imports:["warn"],properties:[{class:"String",name:"name",factory:function(){return"select"}},{class:"String",name:"label",},{name:"choice",postSet:function(o,n){if(o===n||this.feedback_)return;this.feedback_=true;try{if(!n&&this.placeholder){this.data=this.defaultValue;this.text=this.placeholder;this.index=-1}else{this.data=n&&n[0];this.text=n&&n[1];this.index=this.findIndexOfChoice(n)}}finally{this.feedback_=false}}},{name:"choices",factory:function(){return[]},adapt:function(old,nu){if(typeof nu==="object"&&!Array.isArray(nu)){var out=[];for(var key in nu){if(nu.hasOwnProperty(key))out.push([key,nu[key]])}if(this.dynamicSize){this.size=Math.min(out.length,this.maxSize)}return out}nu=foam.Array.shallowClone(nu);for(var i=0;i<nu.length;i++){if(!Array.isArray(nu[i])){nu[i]=[nu[i],nu[i]]}}if(this.dynamicSize)this.size=Math.min(nu.length,this.maxSize);return nu}},{class:"Int",name:"index",transient:true,value:-1,preSet:function(old,nu){if(this.choices.length===0&&this.dao)return nu;if(nu<0&&this.placeholder)return nu;if(nu<0||this.choices.length===0)return 0;if(nu>=this.choices.length)return this.choices.length-1;return nu},postSet:function(o,n){if(o!==n)this.choice=n===-1?null:this.choices[n]}},{class:"String",name:"placeholder",factory:function(){return undefined},},{class:"Function",name:"objToChoice",},{class:"foam.dao.DAOProperty",name:"dao"},{name:"text",postSet:function(o,n){if(o!==n)this.choice=this.findChoiceByText(n)}},{name:"data",postSet:function(o,n){if(o!==n&&!foam.Null.isInstance(n))this.choice=this.findChoiceByData(n)||[n,n.label||n]}},{name:"disabledData",factory:function(){return[]}},{class:"foam.u2.ViewSpec",name:"selectSpec",value:{class:"foam.u2.tag.Select"}},{class:"Boolean",name:"alwaysFloatLabel"},{class:"String",name:"header",},{name:"view_"},"feedback_","defaultValue",{class:"Int",name:"size",},{class:"Boolean",name:"dynamicSize",},{class:"Int",name:"maxSize",value:Number.MAX_SAFE_INTEGER},"prop_",{class:"Int",name:"seq_"}],methods:[function init(){this.onDetach(this.choices$.sub(this.onChoicesUpdate))},function render(){this.SUPER();var self=this;if(!this.choice&&this.choices.length==1)this.data=this.choices[0][0];if(this.data==null&&!this.index){this.index=0}this.onDAOUpdate();this.add(this.slot(function(mode){if(mode!==foam.u2.DisplayMode.RO){return self.E().start(self.selectSpec,{data$:self.index$,label$:self.label$,alwaysFloatLabel:self.alwaysFloatLabel,choices$:self.choices$,placeholder$:self.placeholder$,mode$:self.mode$,size$:self.size$,header$:self.header$,disabledData$:self.disabledData$}).attrs({name:self.name}).enableClass("selection-made",self.index$.map(index=>index!==-1)).end()}return self.E().translate(self.text+".name",self.text)}));this.dao$proxy.on.sub(this.onDAOUpdate)},function findIndexOfChoice(choice){if(!choice)return-1;var choices=this.choices;var data=choice[0];for(var i=0;i<choices.length;i++){if(foam.util.equals(choices[i][0],data))return i}var text=choice[1];for(var i=0;i<choices.length;i++){if(choices[i][1]===text)return i}return-1},function findChoiceByData(data){var choices=this.choices;for(var i=0;i<choices.length;i++){if(foam.util.equals(choices[i][0],data))return choices[i]}},function findChoiceByText(text){var choices=this.choices;for(var i=0;i<choices.length;i++){if(choices[i][1]===text)return choices[i]}},function fromProperty(p){this.SUPER(p);this.prop_=p;this.defaultValue=p.value;this.label=p.label||this.label||p.name}],listeners:[{name:"onChoicesUpdate",isFramed:true,code:function(){var d=this.data;if(this.choices.length){var choice=this.findChoiceByData(d);this.choice=choice===null?this.findChoiceByData(this.defaultValue):choice}}},{name:"onDAOUpdate",isFramed:true,code:function(){var self=this;var seq=++this.seq_;var dao=this.dao;if(!foam.dao.DAO.isInstance(this.dao))return;var of=this.dao.of;if(of._CHOICE_TEXT_){dao.select(this.PROJECTION(of.ID,of._CHOICE_TEXT_)).then(s=>{if(seq!==self.seq_)return;this.choices=s.projection});return}this.warn("Inefficient ChoiceView. Consider creating transient _choiceText_ property on "+of.id+" DAO, prop: "+this.prop_);var p=this.mode===foam.u2.DisplayMode.RW?dao.select().then(s=>s.array):dao.find(this.data).then(o=>o?[o]:[]);p.then(a=>{var choices=a.map(this.objToChoice);var choiceLabels=a.map(o=>{return this.objToChoice(o)[1]});Promise.all(choiceLabels).then(resolvedChoiceLabels=>{if(seq!==self.seq_)return;for(let i=0;i<choices.length;i++){choices[i][1]=resolvedChoiceLabels[i]}this.choices=choices;if(!this.data&&this.index===-1)this.index=this.placeholder&&this.choices.length!=1?-1:0})})}}],reactions:[["","propertyChange.mode","onDAOUpdate"]]});
foam.CLASS({package:"foam.u2.view",name:"UnstyledChooseNView",extends:"foam.u2.View",requires:["foam.core.SimpleSlot"],properties:[foam.u2.view.ChoiceView.DYNAMIC_SIZE,foam.u2.view.ChoiceView.MAX_SIZE,foam.u2.view.ChoiceView.CHOICES,{name:"maxSelections",class:"Int",value:Number.MAX_SAFE_INTEGER},{name:"booleanView",class:"foam.u2.ViewSpec",value:{class:"foam.u2.CheckBox"}},{name:"data",class:"Map",value:{},factory:function(){return{}},adapt:function(_,nu){var set=nu;if(Array.isArray(nu)){set={};nu.forEach(k=>{set[k]=true})}return set}}],methods:[function render(){var self=this;this.addClass(this.myClass()).add(this.slot(function(choices){return this.E().forEach(choices,function(choice){var valueSlot=self.SimpleSlot.create({value:false});this.tag(self.booleanView,{label:choice[1],data$:valueSlot});this.onDetach(valueSlot.sub(()=>{isOn=valueSlot.get();console.log("choice",choice[0],isOn);if(isOn){if(Object.keys(self.data).length>=self.maxSelections){valueSlot.set(false);return}self.data$set(choice[0],true)}else{self.data$remove(choice[0]);delete self.data[choice[0]]}}))})}))}]});
foam.CLASS({package:"foam.u2.view",name:"ChooseNView",extends:"foam.u2.view.UnstyledChooseNView",css:`
^ .foam-u2-CheckBox {
display: block;
}
`});
foam.CLASS({package:"foam.u2.view",name:"ChoiceWithOtherView",extends:"foam.u2.View",requires:["foam.u2.layout.Rows"],properties:[{class:"foam.u2.ViewSpec",name:"choiceView",required:true},{name:"otherKey",required:true},{name:"noSelectionValue",value:""},{name:"otherLabel",value:"Please specify"},{name:"otherDefault",value:""},{class:"foam.u2.ViewSpec",name:"otherView",value:{class:"foam.u2.TextField",onKey:true}},"data","choiceView_","choiceData_","otherData_",{class:"Boolean",name:"showOther_",expression:function(choiceData_,otherKey,mode,otherData_){if(mode===foam.u2.DisplayMode.RO){return false}return foam.util.equals(choiceData_,otherKey)}},"preventFeedback_"],css:`
.other-choice-label {
margin-top: 20px;
}
`,reactions:[["","propertyChange.choiceData_","toData"],["","propertyChange.otherData_","toData"],["","propertyChange.data","fromData"],["","propertyChange.choiceView_","fromData"],["choiceView_","propertyChange.choices","fromData"]],listeners:[{name:"toData",code:function(){if(this.preventFeedback_)return;this.preventFeedback_=true;this.data=this.showOther_?this.otherData_?.trim():this.choiceData_;this.preventFeedback_=false}},{name:"fromData",code:function(){if(!this.choiceView_||this.preventFeedback_)return;this.preventFeedback_=true;this.choiceView_.data=this.data;if(this.choiceView_.choice==null){if(this.mode===foam.u2.DisplayMode.RO){if(foam.util.equals(this.data,this.otherKey)){this.choiceData_=this.otherKey;this.otherData_=this.data}}else{if(!foam.util.equals(this.data,this.noSelectionValue)){this.choiceData_=this.otherKey;this.otherData_=this.data}}}else{this.otherData_=this.otherDefault}this.preventFeedback_=false}}],methods:[function render(){var self=this;self.SUPER();self.add(self.slot(function(choiceView,otherView){return self.Rows.create().tag(choiceView,{data$:self.choiceData_$},self.choiceView_$).start("m3").show(self.showOther_$).start().addClass("other-choice-label").add(self.otherLabel$).end().end().start().show(self.showOther_$).tag(otherView,{data$:self.otherData_$}).end()}))}]});
foam.CLASS({package:"foam.u2.view",name:"RichChoiceViewI18NComparator",imports:["translationService?"],methods:[function compare(o1,o2){var k1=this.key(o1);var k2=this.key(o2);return foam.util.compare(k1,k2)},function key(o){var k=o.toSummary?o.toSummary():o.id;if(this.translationService){k=this.translationService.getTranslation(foam.locale,k,k)}return k}]});
foam.CLASS({package:"foam.u2.view",name:"RichChoiceViewSection",properties:[{class:"foam.dao.DAOProperty",name:"dao",},{class:"foam.dao.DAOProperty",name:"filteredDAO",expression:function(dao){return dao}},{class:"Array",name:"searchBy",},{class:"Boolean",name:"hideIfEmpty",},{class:"Boolean",name:"disabled",},{class:"String",name:"heading",}]});
foam.CLASS({package:"foam.u2.view",name:"RichChoiceView",extends:"foam.u2.View",requires:["foam.u2.CitationView","foam.u2.view.RichChoiceViewI18NComparator"],implements:["foam.mlang.Expressions"],imports:["window"],exports:["of"],messages:[{name:"CHOOSE_FROM",message:"Choose from"},{name:"CLEAR_SELECTION",message:"Clear"}],css:`
^chevron::before {
color: #8D9090;
content: '▾';
padding-left: 4px;
}
^ {
display: flex;
position: relative;
}
^setAbove {
z-index: 1;
}
^container {
position: absolute;
bottom: -4px;
left: 0;
transform: translateY(100%);
background: /*%WHITE%*/ #ffffff;
border: 1px solid /*%GREY3%*/ #cbcfd4;
max-height: 378px;
overflow-y: auto;
box-sizing: border-box;
width: 100%;
min-width: fit-content;
border-radius: 3px;
box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.08), 0 2px 8px 0 rgba(0, 0, 0, 0.16);
z-index: 1000;
}
^heading {
border-bottom: 1px solid #f4f4f9;
font-size: 1.2rem;
font-weight: 900;
line-height: 24px;
font-size: 1.4rem;
color: #333;
padding: 6px 16px;
}
^selection-view {
display: inline-flex;
align-items: center;
justify-content: space-between;
width: 100%;
height: /*%INPUTHEIGHT%*/ 34px;
padding-left: /*%INPUTHORIZONTALPADDING%*/ 8px;
padding-right: /*%INPUTHORIZONTALPADDING%*/ 8px;
border: 1px solid /*%GREY3%*/ #cbcfd4;
color: /*%BLACK%*/ #1e1f21;
background-color: /*%WHITE%*/ white;
min-width: 94px;
width: 100%;
border-radius: 4px;
-webkit-appearance: none;
cursor: pointer;
font-size: 1.4rem;
}
^selection-view:hover,
^selection-view:hover ^clear-btn {
border-color: /*%GREY2%*/ #9ba1a6;
}
^:focus {
outline: none;
}
^:focus ^selection-view,
^:focus ^selection-view ^clear-btn {
border-color: /*%PRIMARY3%*/ #406dea;
}
^custom-selection-view {
flex-grow: 1;
overflow: hidden;
}
^ .search .property-filter_ {
width: 100%;
}
^ .search input {
border-bottom: none;
width: 100%;
border: none;
padding-left: /*%INPUTHORIZONTALPADDING%*/ 8px;
padding-right: /*%INPUTHORIZONTALPADDING%*/ 8px;
height: /*%INPUTHEIGHT%*/ 34px;
}
^ .search img {
top: 8px;
width: 15px;
margin-left: 8px;
}
^ .search {
border-bottom: 1px solid #f4f4f9;
display: flex;
padding: 8px 16px;
}
^ .disabled {
filter: grayscale(100%) opacity(60%);
}
^ .disabled:hover {
cursor: default;
}
^clear-btn {
display: flex;
align-items: center;
border-left: 1px;
padding-left: /*%INPUTHORIZONTALPADDING%*/ 8px;
padding-right: /*%INPUTHORIZONTALPADDING%*/ 8px;
height: /*%INPUTHEIGHT%*/ 34px;
border-left: 1px solid;
border-color: /*%GREY3%*/ #cbcfd4;
margin-left: 12px;
padding-left: 16px;
}
^clear-btn:hover {
color: /*%DESTRUCTIVE3%*/ #d9170e;
cursor: pointer;
}
`,properties:[{class:"String",name:"name",factory:function(){return"select"}},{class:"foam.u2.ViewSpec",name:"rowView",factory:function(){return this.CitationView}},{name:"data",},{class:"Boolean",name:"clearOnReopen",value:true},{class:"Boolean",name:"isOpen_",postSet:function(_,nv){if(nv&&!this.hasBeenOpenedYet_)this.hasBeenOpenedYet_=true;if(!nv&&this.clearOnReopen){this.clearProperty("filter_");this.sections.forEach(section=>{section.clearProperty("filteredDAO")})}}},{class:"Boolean",name:"hasBeenOpenedYet_",},{class:"foam.u2.ViewSpec",name:"selectionView",factory:function(){return this.DefaultSelectionView}},{class:"FObjectArray",of:"foam.u2.view.RichChoiceViewSection",name:"sections",},{class:"Class",name:"of",expression:function(sections){return sections[0].dao.of}},{class:"FObjectProperty",name:"fullObject_",},{class:"Boolean",name:"search",},{class:"String",name:"filter_",postSet:function(oldValue,newValue){this.sections.forEach(section=>{if(newValue){if(section.searchBy.length>0){var arrOfExpressions=section.searchBy.map(prop=>this.CONTAINS_IC(prop,newValue));var pred=this.Or.create({args:arrOfExpressions})}else{var pred=this.KEYWORD(newValue)}section.filteredDAO=section.dao.where(pred)}else{section.filteredDAO=section.dao}})}},{class:"String",name:"searchPlaceholder",value:"Search..."},{class:"String",name:"choosePlaceholder",expression:function(of){var plural=of.model_.plural.toLowerCase();return this.CHOOSE_FROM+" "+plural+"..."}},{type:"Action",name:"action",},{class:"FObjectProperty",name:"actionData",},{class:"Boolean",name:"allowClearingSelection",},{name:"comparator",factory:function(){return this.RichChoiceViewI18NComparator.create()}}],methods:[function render(){var self=this;if(!Array.isArray(this.sections)||this.sections.length===0){throw new Error(`You must provide an array of sections. See documentation on the 'sections' property in RichTextView.js.`)}this.onDetach(this.data$.sub(this.onDataUpdate));this.onDataUpdate();var containerU2Element;const fn=async function(evt){if(containerU2Element===undefined)return;var selfDOMElement=await self.el();var containerDOMElement=await containerU2Element.el();if(selfDOMElement==null||containerDOMElement==null){self.window.removeEventListener("click",fn);return}var selfRect=selfDOMElement.getClientRects()[0];var containerRect=containerDOMElement.getClientRects()[0];if(containerRect===undefined)return;if(!(evt.clientX>=selfRect.x&&evt.clientX<=selfRect.x+selfRect.width&&evt.clientY>=selfRect.y&&evt.clientY<=containerRect.y+containerRect.height)){self.isOpen_=false}};this.window.addEventListener("click",fn);this.onDetach(()=>this.window.removeEventListener("click",fn));this.add(this.slot(function(mode,fullObject_){if(mode!==foam.u2.DisplayMode.RO){return self.E().attrs({name:this.name,tabindex:0}).addClass(this.myClass()).start().addClass(this.myClass("selection-view")).enableClass("disabled",this.mode$.map(mode=>mode===foam.u2.DisplayMode.DISABLED)).on("click",function(){if(self.mode===foam.u2.DisplayMode.RW){self.isOpen_=!self.isOpen_}}).start().addClass(this.myClass("custom-selection-view")).add(this.slot(data=>{return this.E().tag(self.selectionView,{data:data,fullObject$:this.fullObject_$,defaultSelectionPrompt$:this.choosePlaceholder$})})).end().start().addClass(this.myClass("chevron")).end().add(this.slot(function(allowClearingSelection){if(!allowClearingSelection)return null;return this.E().addClass(self.myClass("clear-btn")).on("click",self.clearSelection).add(self.CLEAR_SELECTION)})).end().add(this.slot(function(hasBeenOpenedYet_){if(!hasBeenOpenedYet_)return this.E();return this.E().addClass(self.myClass("container")).call(function(){containerU2Element=this}).show(self.isOpen_$).add(self.search$.map(searchEnabled=>{if(!searchEnabled)return null;return this.E().start().start("img").attrs({src:"images/ic-search.svg"}).end().startContext({data:self}).addClass("search").add(self.FILTER_.clone().copyFrom({view:{class:"foam.u2.view.TextField",placeholder:this.searchPlaceholder,onKey:true}})).endContext().end()})).add(self.slot(function(sections){var promiseArray=[];sections.forEach(function(section){promiseArray.push(section.dao.select(self.COUNT()))});return Promise.all(promiseArray).then(resp=>{var index=0;return this.E().forEach(sections,function(section){this.addClass(self.myClass("setAbove")).start().hide(!!section.hideIfEmpty&&resp[index].value<=0||!section.heading).addClass(self.myClass("heading")).translate(section.heading,section.heading).end().start().select(section.filteredDAO$proxy,obj=>{return this.E().start(self.rowView,{data:obj}).enableClass("disabled",section.disabled).callIf(!section.disabled,function(){this.on("click",()=>{self.onSelect(obj)})}).end()},false,self.comparator).end();index++})})})).add(this.slot(self.addAction))}))}else{return self.E().addClass(this.myClass()).start().addClass(this.myClass("custom-selection-view")).tag(self.selectionView,{fullObject:fullObject_,defaultSelectionPrompt$:self.choosePlaceholder$}).end()}}))},function onSelect(obj){this.fullObject_=obj;this.data=obj.id;this.isOpen_=false},function addAction(action,actionData){var self=this;if(action&&actionData){return this.E().start(self.DefaultActionView,{action:action,data:actionData}).addClass(self.myClass("action")).end()}if(action){return this.E().start(self.DefaultActionView,{action:action}).addClass(self.myClass("action")).end()}},function updateMode_(mode){if(mode!==foam.u2.DisplayMode.RW){this.isOpen_=false}},function fromProperty(property){this.SUPER(property);this.prop=property}],listeners:[{name:"onDataUpdate",code:function(){if(!this.data){this.clearSelection();return}this.sections.forEach(section=>{section.dao.find(this.data).then(result=>{if(result)this.fullObject_=result})})}},function clearSelection(evt){evt&&evt.stopImmediatePropagation();this.fullObject_=undefined;this.data=this.prop?this.prop.value:undefined}],classes:[{name:"DefaultSelectionView",extends:"foam.u2.Element",imports:["of"],properties:[{name:"data",},{class:"String",name:"defaultSelectionPrompt"},{name:"fullObject",}],methods:[function render(){this.style({overflow:"hidden","white-space":"nowrap","text-overflow":"ellipsis"});if(this.fullObject){var summary=this.fullObject.toSummary();return this.translate(summary,summary)}return this.add(this.defaultSelectionPrompt)}]},{name:"DefaultActionView",extends:"foam.u2.ActionView",inheritCSS:false,css:`
^ {
border: 0;
border-top: 1px solid #f4f4f9;
color: /*%PRIMARY3%*/ #406dea;
display: flex;
font-size: 1.2rem;
justify-content: flex-start;
text-align: left;
width: 100%;
}
^:hover {
color: /*%PRIMARY2%*/ #144794;
cursor: pointer;
}
^ img + span {
margin-left: 6px;
}
`}]});
foam.CLASS({package:"foam.u2.view",name:"RichChoiceWithCreateView",extends:"foam.u2.view.RichChoiceView",mixins:["foam.util.DeFeedback"],requires:["foam.u2.view.DraftDetailView"],css:`
^createWrapper {
padding: 8px 16px;
background: /*%GREY5%*/ #F5F7FA;
display: flex;
gap: 8px;
flex-direction: column;
}
`,imports:["auth"],exports:["cancel as onCancel","saveToDAO as onSave"],properties:[{class:"foam.u2.ViewSpec",name:"createView",value:{class:"foam.u2.detail.VerticalDetailView",hideActions:true,showTitle:false}},["showCreate",false],{name:"workingData",factory:function(){return this.of.create(this.baseArgs,this)}},{class:"Map",name:"baseArgs"},{name:"propertyWhitelist",},{class:"foam.dao.DAOProperty",name:"dao",factory:function(){return this.sections[0]?.dao}},{class:"String",name:"addPlaceholder"}],methods:[function addAction(showCreate,createView){if(!createView)return this.E();if(showCreate)return this.E().addClass(this.myClass("createWrapper")).start(this.DraftDetailView,{view:{...createView,propertyWhitelist$:this.propertyWhitelist$},data$:this.workingData$}).addClass(this.myClass("createView")).end();return this.E().tag(this.DefaultActionView,{action:this.ADD_ROW,data:this,label:this.addPlaceholder||(this.of?`Add ${this.of.model_.label.toLowerCase()}`:undefined)})}],listeners:[function saveToDAO(){if(this.feedback_)return;this.feedback_=true;this.dao.put(this.workingData).then(obj=>{if(!obj)console.log(obj);this.onSelect(obj);this.workingData=undefined;this.showCreate=false;this.feedback_=false},e=>{this.feedback_=false;ctrl.notify("Something went wrong",e.message,"ERROR",true)})},function cancel(){this.feedback_=true;this.workingData=undefined;this.showCreate=false;this.feedback_=false}],actions:[{name:"addRow",isAvailable:function(of){return this.auth.check(this,`${of.name}.create`)},code:function(){this.showCreate=true}}]});
foam.CLASS({package:"foam.u2.view",name:"DAOListWithCreateView",extends:"foam.u2.view.FObjectArrayView",requires:["foam.u2.view.CollapseableDetailView","foam.u2.view.DraftDetailView","foam.u2.stack.StackBlock","foam.comics.v2.DAOControllerConfig","foam.comics.v2.DAOBrowseControllerView"],implements:["foam.mlang.Expressions"],imports:["auth","stack"],exports:["dao","onCancel","onSave","updateData"],css:`
^createWrapper {
padding: 8px 16px;
background: /*%GREY5%*/ #F5F7FA;
display: flex;
gap: 8px;
flex-direction: column;
}
^actionBar {
display: flex;
align-items: center;
justify-content: center;
}
^actionBar > .foam-u2-ActionView + .foam-u2-ActionView {
margin-left: 0px;
}
`,classes:[{name:"Row",imports:["data","dao","enableRemoving","mode","updateData"],properties:[{class:"Int",name:"index",visibility:"RO"},{name:"value",postSet:function(_,n){if(this.data[this.index]===n)return;this.dao.remove(n)}}],methods:[function toSummary(){return this.value.toSummary()}],actions:[{name:"remove",confirmationView:function(){return true},isAvailable:function(enableRemoving,mode){return enableRemoving&&mode===foam.u2.DisplayMode.RW},code:function(){if(this.dao.targetProperty){this.value[this.dao.targetProperty.name]=null;this.__subContext__[this.dao.targetDAOKey].put(this.value)}else{this.dao.remove(this.value);this.updateData()}}}]}],properties:[["showCreate",false],{class:"foam.dao.DAOProperty",name:"dao"},{name:"valueView",value:{class:"foam.u2.CitationView"}},{class:"foam.u2.ViewSpec",name:"addView",factory:function(){return{class:"foam.u2.detail.VerticalDetailView",hideActions:true,showTitle:false,of:this.of}},},"workingData",{name:"propertyWhitelist",},"DAOCount"],methods:[function init(){this.data=undefined;this.SUPER();this.dao$.sub(this.updateData);this.dao$.sub(this.updateCount);this.updateCount();this.updateData()},function fromProperty(p){this.SUPER(p);if(!this.dao&&p.data)this.dao=p.data;if(this.dao.of)this.of=this.dao.of},function addAction(showCreate,addView){if(showCreate)return this.E().addClass(this.myClass("createWrapper")).start(this.DraftDetailView,{view:{...addView,propertyWhitelist$:this.propertyWhitelist$},data$:this.workingData$}).addClass(this.myClass("createView")).end();return this.SUPER().addClass(this.myClass("actionBar")).start(this.VIEW_MORE,{buttonStyle:"TERTIARY"}).addClass(this.myClass("addButton")).end()}],listeners:[function updateCount(){this.dao.select(this.Count.create()).then(s=>this.DAOCount=s.value)},function updateData(){if(!this.dao)return;var self=this;this.dao.limit(10).select().then(r=>{self.data=r.array;self.updateCount()})},function onSave(obj){this.dao.put(obj).then(o=>{console.log("put",o);this.showCreate=false;this.updateData()})},function onCancel(){this.showCreate=false}],actions:[{name:"addRow",isAvailable:function(enableAdding,mode,of){return enableAdding&&mode===foam.u2.DisplayMode.RW},code:function(){var newItem=this.defaultNewItem;if(this.FObject.isInstance(newItem)){this.workingData=newItem.clone()}if(this.dao.targetProperty)this.workingData[this.dao.targetProperty.name]=this.dao.sourceId;this.showCreate=true}},{name:"viewMore",isAvailable:function(DAOCount){return DAOCount>=10},code:function(){this.stack.push(this.StackBlock.create({view:{class:this.DAOBrowseControllerView,data$:this.dao$,config:this.DAOControllerConfig.create({dao:this.dao})},parent:this.__subContext__.createSubContext({controllerMode:"CREATE"})}))}}]});
foam.CLASS({package:"foam.u2.view",name:"RichChoiceSummaryIdRowView",extends:"foam.u2.CitationView",methods:[function render(){var summary=this.data.toSummary()+" ("+this.data.id+")";return this.start().addClass(this.myClass("row")).translate(summary||"richChoiceSummary."+this.data.cls_.id+"."+this.data.id,summary).end()}]});
foam.CLASS({package:"foam.u2.view",name:"OverlayActionListView",extends:"foam.u2.tag.Button",requires:["foam.core.ConstantSlot","foam.core.ExpressionSlot","foam.u2.md.OverlayDropdown","foam.u2.HTMLView","foam.u2.LoadingSpinner"],imports:["ctrl","document","dropdown","theme"],exports:["overlay_ as dropdown"],properties:[{class:"FObjectArray",of:"foam.core.FObject",name:"data"},{name:"obj"},{class:"Boolean",name:"disabled_"},{class:"FObjectProperty",of:"foam.u2.Element",name:"overlay_",factory:function(){return this.OverlayDropdown.create()}},{class:"Boolean",name:"overlayInitialized_"},"dao",{class:"Boolean",name:"showDropdownIcon",value:true},{name:"dropdownIcon",value:"/images/dropdown-icon.svg"},"firstEl_","lastEl_",["isMouseClick_",true]],css:`
^disabled button {
color: /*%GREY4%*/ grey;
}
^button-container button {
border: 1px solid transparent;
background-color: /*%WHITE%*/ #FFFFFF;
justify-content: space-between;
text-align: left;
white-space: nowrap;
width: fill-available;
width: -webkit-fill-available;
}
^button-container button > img{
height: 100%;
}
^button-container button:hover:not(:disabled) {
background-color: /*%PRIMARY5%*/ #E5F1FC;
}
^button-container button:focus {
border-color: /*%PRIMARY4%*/ #C6D2FF;
background-color: /*%PRIMARY5%*/ #E5F1FC;
}
^button-container button:focus:not(:focus-visible){
border-color: transparent;
}
/* destructive */
^button-container .destructive{
color: /*%DESTRUCTIVE2%*/ #a61414;
}
^button-container .destructive svg { fill: /*%DESTRUCTIVE2%*/ #a61414; }
^button-container .destructive:hover:not(:disabled) {
background-color: /*%DESTRUCTIVE5%*/ #E5D2D0;
}
^button-container .destructive:focus {
border-color: /*%DESTRUCTIVE2%*/ #a61414;
background-color: /*%DESTRUCTIVE5%*/ #E5D2D0;
}
^button-container .destructive:disabled {
color: /*%DESTRUCTIVE5%*/ #E5D2D0;
}
^button-container .destructive:disabled svg { fill: /*%DESTRUCTIVE5%*/ #E5D2D0; }
^iconOnly{
padding: 0px;
}
^dropdown svg {
font-size: 0.6rem;
}
^iconContainer {
margin-left: auto;
}
`,methods:[async function render(){this.SUPER();this.shown=false;for(let action of this.data){if(!foam.core.Action.isInstance(action)||await this.isAvailable(action)){this.shown=true;break}}},function addContent(){this.SUPER();var self=this;if(this.showDropdownIcon){this.add(this.shown$.map(function(shown){var e=self.E().addClass(self.myClass("iconContainer"));if(shown){e.callIfElse(self.theme,function(){this.start(self.HTMLView,{data:self.theme.glyphs.dropdown.expandSVG()}).addClasses([self.myClass("SVGIcon"),self.myClass("dropdown")]).end()},function(){this.start("img").attr("src",this.dropdownIcon$).end()})}return e}))}},async function initializeOverlay(x,y){var self=this;this.overlayInitialized_=true;var spinner=this.E().style({padding:"1em"}).tag(self.LoadingSpinner,{size:24});this.overlay_.add(spinner);this.ctrl.add(this.overlay_);this.overlay_.open(x,y);if(this.obj&&this.dao){this.obj=await this.dao.inX(this.__context__).find(this.obj.id)}this.onDetach(this.disabled_$.follow(this.ExpressionSlot.create({args:this.data.map(action=>{if(!foam.core.Action.isInstance(action))return foam.core.SimpleSlot.create({value:true},this);return action.createIsAvailable$(this.__context__,this.obj)}),code:(...rest)=>!rest.reduce((l,r)=>l||r,false)})));this.onDetach(()=>{this.overlay_&&this.overlay_.remove()});self.obj?.sub(function(){self.overlay_.close()});const enabled=await Promise.all(this.data.map(action=>{if(!foam.core.Action.isInstance(action))return true;return this.isEnabled.bind(this)}));const availabilities=await Promise.all(this.data.map(action=>{if(!foam.core.Action.isInstance(action))return true;return this.isAvailable.bind(this)}));var el=this.E().startContext({data:self.obj,dropdown:self.overlay_}).forEach(self.data,function(action,index){if(availabilities[index]){this.start().addClass(self.myClass("button-container")).tag(action,{buttonStyle:"UNSTYLED"}).attrs({tabindex:-1}).callIf(!enabled[index],function(){this.addClass(self.myClass("disabled")).attrs({disabled:true})}).end()}}).endContext();spinner.remove();this.overlay_.add(el);this.overlay_.open(x,y);this.overlay_.on("keydown",this.onKeyDown);var actionElArray_=this.overlay_.dropdownE_.childNodes;this.firstEl_=actionElArray_[0].childNodes[0];this.lastEl_=actionElArray_[actionElArray_.length-1].childNodes[0];this.firstEl_&&!this.isMouseClick&&this.firstEl_.focus()},async function isEnabled(action){const slot=action.createIsEnabled$(this.__context__,this.obj);if(slot.get())return true;return slot.args[1].promise||false},async function isAvailable(action){const slot=action.createIsAvailable$(this.__context__,this.obj);if(slot.get())return true;return slot.promise||false}],listeners:[function click(evt){this.SUPER(evt);this.overlay_.parentEl=this;this.isMouseClick=!!evt.detail;var x=evt.clientX||this.getBoundingClientRect().x;var y=evt.clientY||this.getBoundingClientRect().y;if(this.disabled_)return;if(!this.overlayInitialized_){this.initializeOverlay(x,y)}else{this.overlay_.open(x,y)}this.firstEl_&&!this.isMouseClick&&this.firstEl_.focus()},function onKeyDown(e){var isTabPressed=e.key==="Tab"||e.keyCode===9;if(!isTabPressed){return}if(e.shiftKey){if(this.document.activeElement===this.firstEl_.el_()){this.lastEl_.focus();e.preventDefault()}}else{if(this.document.activeElement===this.lastEl_.el_()){this.firstEl_.focus();e.preventDefault()}}}]});
foam.CLASS({package:"foam.u2.view",name:"TabChoiceView",extends:"foam.u2.view.ChoiceView",mixins:["foam.u2.memento.Memorable"],css:`
^ {
display: flex;
}
^item {
display: flex;
}
^ input[type="radio"] {
display: none;
}
^ [type=radio]:checked ~ label {
border-bottom: solid 3px /*%PRIMARY3%*/ #406dea;
font-weight: bold;
color: /*%PRIMARY3%*/ #406dea;
}
^ label {
cursor: pointer;
padding: 16px 32px;
}
`,properties:[{name:"choice",factory:function(){return this.choices[0]}},{name:"cannedQuery",shortName:"query",memorable:true,factory:function(){return this.choice[1]}}],methods:[function render(){this.addClass();if(!this.data&&!this.index){this.index=0}if(this.dao)this.onDAOUpdate();this.choices$.sub(this.onChoicesUpdate);this.onChoicesUpdate()}],listeners:[function onChoicesUpdate(){var self=this;var id;this.removeAllChildren();this.add(this.choices.map(function(c){if(this.cannedQuery==c[1])this.data=c[0];return this.E("div").addClass(this.myClass("item")).start("input").attrs({type:"radio",name:this.id,checked:self.slot(function(data){return data===c[0]})}).setID(id=self.NEXT_ID()).on("change",function(){self.data=c[0];self.cannedQuery=c[1]}).end().start("label").addClass("p").attrs({for:id}).start("span").translate(c[1],c[1]).end().end()}.bind(this)))}]});
foam.CLASS({package:"foam.u2.view",name:"IconChoiceView",extends:"foam.u2.view.ChoiceView",css:`
^ {
display: flex;
}
^item {
display: flex;
}
^ input[type="radio"] {
display: none;
}
^ label {
cursor: pointer;
line-height: 48px;
margin-left: 16px;
}
^disabled-icon {
opacity: 0.2;
}
`,methods:[function render(){this.addClass(this.myClass());if(!this.data&&!this.index){this.index=0}if(this.dao)this.onDAOUpdate();this.choices$.sub(this.onChoicesUpdate);this.onChoicesUpdate()}],listeners:[function onChoicesUpdate(){var self=this;var id;this.removeAllChildren();this.add(this.choices.map(function(c){return this.E("div").addClass(this.myClass("item")).start("input").attrs({type:"radio",name:this.id,checked:self.slot(function(data){return data===c[0]})}).setID(id=self.NEXT_ID()).on("change",function(evt){self.data=c[0]}).end().start("label").attrs({for:id}).start("span").tag({class:"foam.u2.tag.Image",data:c[1]}).enableClass(this.myClass("disabled-icon"),self.slot(function(data){return data===c[0]})).end().end()}.bind(this)))}]});
foam.CLASS({package:"foam.u2.view",name:"IconTextFieldView",extends:"foam.u2.View",requires:["foam.u2.TextField"],css:`
^ {
position: relative;
}
^icon {
height: 14px;
width: 14px;
position: absolute;
margin-left: 10px;
margin-top: 11px;
}
^input {
padding-left: 32px !important;
}
`,properties:[{class:"String",name:"icon"},{class:"Boolean",name:"onKey"},{class:"String",name:"fromPropertyName"},{name:"focused",setter:function(f){this.focused_=f}},"focused_"],methods:[function render(){this.start().addClass(this.myClass()).start({class:"foam.u2.tag.Image",data:this.icon}).addClass(this.myClass("icon")).attr("name",this.fromPropertyName+"Icon").end().start(this.TextField,{type:this.type,data$:this.data$,placeholder:this.placeholder,onKey:this.onKey,focused:this.focused_}).addClass(this.myClass("input")).attr("name",this.fromPropertyName+"Input").end().end()},function fromProperty(prop){this.SUPER(prop);if(!this.placeholder&&prop.placeholder){this.placeholder=prop.placeholder}if(!this.type&&prop.type){this.type=prop.type}this.fromPropertyName=prop.name}]});
foam.CLASS({package:"foam.u2.view",name:"RadioEnumView",extends:"foam.u2.view.RadioView",properties:[{class:"Class",name:"of",required:true},{name:"choices",expression:function(of){return of?of.VALUES.map(v=>[v,v.label]):[]}}],methods:[function fromProperty(p){this.SUPER(p);if(!this.of)this.of=p.of}]});
foam.CLASS({package:"foam.u2.view",name:"RadioView",extends:"foam.u2.view.ChoiceView",requires:["foam.u2.DisplayMode","foam.u2.view.RadioButton"],css:`
/*hide default input*/
^ input[type='radio']{
padding: 0px !important;
-webkit-appearance: none;
appearance: none;
border: none;
vertical-align: middle;
}
^ input[type='radio']+ label{
position: relative;
display: flex;
cursor: pointer;
align-items: center;
}
^ .choice {
font-size: 1.6rem;
white-space: nowrap;
}
^horizontal-radio {
align-content: center;
align-items: center;
display: flex;
flex-wrap: wrap;
gap: 12px;
}
^ span{
vertical-align: middle;
}
^radio-outer{
margin-right: 0.4em;
border-radius: 50%;
}
/* Focus */
^ input[type='radio']:focus + label > ^radio-outer > .radio{
filter: drop-shadow( 0px 0px 1px rgba(0, 0, 0, .5));
}
`,properties:[{class:"Boolean",name:"isHorizontal"},{class:"Boolean",name:"isDisabled"},{class:"Int",name:"columns",value:3}],methods:[function render(){this.SUPER();this.addClass(this.myClass()).enableClass(this.myClass("horizontal-radio"),this.isHorizontal);if(!this.data&&!this.index){this.index=0}if(this.dao)this.onDAOUpdate();this.choices$.sub(this.onChoicesUpdate);this.onChoicesUpdate()},function updateMode_(mode){this.isDisabled=mode===this.DisplayMode.RO||mode===this.DisplayMode.DISABLED}],listeners:[function onChoicesUpdate(){var self=this;var id;var index=0;this.removeAllChildren();this.add(this.choices.map(c=>{var isChecked=self.slot(function(data){return data==c[0]});return this.E("div").addClass("choice").callIf(this.columns!=-1,function(){this.style({"flex-basis":100/self.columns+"%"})}).start("input").attrs({type:"radio",name:self.getAttribute("name")+self.$UID,value:c[1],checked:isChecked,disabled:self.isDisabled$}).setID(id=self.NEXT_ID()).on("change",function(evt){self.data=c[0]}).end().start("label").attrs({for:id}).start().addClass(this.myClass("radio-outer")).add(this.RadioButton.create({isSelected$:isChecked,isDisabled$:self.isDisabled$})).end().start("span").add(c[1]).end().end()}))}]});
foam.CLASS({package:"foam.u2.view",name:"TextField",extends:"foam.u2.Element",requires:["foam.u2.tag.Input"],properties:["data",{class:"Boolean",name:"onKey",attribute:true},{class:"foam.u2.ViewSpec",name:"view",value:{class:"foam.u2.tag.Input"}},"label","alwaysFloatLabel","type","placeholder","autocompleter","autocompleteList_","elm_"],methods:[function render(){this.start(this.view,{data$:this.data$,label$:this.label$,alwaysFloatLabel:this.alwaysFloatLabel,type:this.type,onKey:this.onKey},this.elm_$).attrs({placeholder:this.placeholder$}).end();if(this.autocompleter){this.onDetach(this.onload.sub(this.loaded));this.onDetach(this.removeList)}},function createList(objects){this.autocompleteList_=foam.u2.Element.create({nodeName:"datalist"});this.document.body.insertAdjacentHTML("beforeend",this.autocompleteList_.outerHTML);this.autocompleteList_.load();objects.forEach(obj=>{this.autocompleteList_.start("option").attrs({value:obj.label}).end()});this.elm_&&this.elm_.attrs({list:this.autocompleteList_.id})}],listeners:[function loaded(){this.autocompleter.dao.on.sub(this.updateAutocompleteList);this.updateAutocompleteList()},function removeList(){if(this.autocompleteList_)this.autocompleteList_.remove()},{name:"updateAutocompleteList",isFramed:true,code:function(){this.autocompleter.dao.select().then(sink=>{this.removeList();this.createList(sink.array)})}}]});
foam.CLASS({package:"foam.u2.view",name:"TreeViewRow",extends:"foam.u2.Element",requires:["foam.mlang.ExpressionsSingleton","foam.u2.tag.Image"],exports:["data"],imports:["dblclick?","onObjDrop","returnExpandedCSS?","selection","startExpanded","translationService?"],css:`
^ {
white-space: nowrap;
inset: none;
cursor: pointer;
}
^button:hover {
background-color: /*%GREY5%*/ #e7eaec;
color:  /*%PRIMARY1%*/ #406dea;
}
^label-container {
display: flex;
align-items: center;
}
^heading {
min-height: 40px;
display: flex;
align-items: center;
padding: 0 8px;
}
^button.foam-u2-ActionView{
padding: 8px;
width: 100%;
}
^select-level {
display: flex;
justify-content: space-between;
overflow: hidden;
padding-right: 8px;
text-align: left;
width: 100%;
}
^select-level > * {
white-space: nowrap;
overflow: hidden;
text-overflow: ellipsis;
}
^selected > ^heading > ^button {
background-color: /*%PRIMARY5%*/ #e5f1fc !important;
color:  /*%PRIMARY1%*/ #406dea;
}
^toggle-icon {
align-self: center;
transition: 0.2s linear;
}
^toggle-icon svg{
width: 0.75em;
height: 0.75em;
fill: inherit;
}
`,properties:[{name:"data"},{name:"relationship"},{class:"Boolean",name:"expanded",value:false},{class:"Function",name:"formatter"},{class:"Boolean",name:"draggable",},{class:"Boolean",name:"hasChildren"},{class:"Boolean",name:"doesThisIncludeSearch",value:false},"query",{class:"Boolean",name:"showThisRootOnSearch"},{class:"Array",name:"subMenus"},"showRootOnSearch",{class:"Boolean",name:"updateThisRoot",value:false},{class:"Function",name:"onClickAddOn"},{class:"Int",name:"level"},{class:"Boolean",name:"selected_",expression:function(selection,data$id){if(selection&&foam.util.equals(selection.id,this.data.id)){return true}return false}}],methods:[function render(){this.SUPER();var self=this;var controlledSearchSlot=foam.core.SimpleSlot.create();if(this.query){this.query.sub(function(){self.updateThisRoot=true;self.showThisRootOnSearch=false;controlledSearchSlot.set(self.query.get());self.updateThisRoot=false})}if(self.showRootOnSearch)self.showRootOnSearch.set(self.showRootOnSearch.get()||self.doesThisIncludeSearch);this.data[self.relationship.forwardName].select().then(function(val){self.hasChildren=val.array.length>0;self.subMenus=val.array});var labelString=this.data.label;if(this.translationService){labelString=self.translationService.getTranslation(foam.locale,self.data.label,self.data.label)}var mainLabel=this.E().addClass(self.myClass("select-level")).start().addClass(this.slot(function(selected_){return selected_?"p-semiBold":"p"})).addClass(self.myClass("label")).call(this.formatter,[self.data]).end().start().addClass(self.myClass("toggle-icon")).show(this.hasChildren$).style({transform:self.expanded$.map(function(c){return c?"rotate(90deg)":"rotate(0deg)"})}).on("click",this.toggleExpanded).tag(this.Image,{glyph:"next"}).end();this.addClass(this.myClass()).show(this.slot(function(hasChildren,showThisRootOnSearch,updateThisRoot){if(!self.query)return true;var isThisItemRelatedToSearch=false;if(!updateThisRoot){self.doesThisIncludeSearch=self.query.get()?self.data.label.toLowerCase().includes(self.query.get().toLowerCase()):true;if(self.query.get()&&!self.doesThisIncludeSearch&&self.data.keywords){for(var i=0;i<self.data.keywords.length;i++){if(self.data.keywords[i].toLowerCase().includes(self.query.get().toLowerCase())){self.doesThisIncludeSearch=true;break}}}isThisItemRelatedToSearch=self.query.get()?self.doesThisIncludeSearch&&(!hasChildren||self.data.parent!=="")||hasChildren&&showThisRootOnSearch:true;if(self.showRootOnSearch)self.showRootOnSearch.set(self.showRootOnSearch.get()||isThisItemRelatedToSearch)}else{isThisItemRelatedToSearch=true}if(!self.query.get()){self.expanded=false}else if(self.query.get()&&isThisItemRelatedToSearch){self.expanded=true}return isThisItemRelatedToSearch})).enableClass(this.myClass("selected"),this.selected_$).on("dblclick",function(){self.dblclick&&self.dblclick(self.data)}).callIf(this.draggable,function(){this.attrs({draggable:"true"}).on("dragstart",this.onDragStart).on("dragenter",this.onDragOver).on("dragover",this.onDragOver).on("drop",this.onDrop)}).start().addClass(self.myClass("heading")).style({"padding-left":(self.level-1)*16+8+"px"}).startContext({data:self}).start(self.ON_CLICK_FUNCTIONS,{buttonStyle:"UNSTYLED",label:mainLabel,ariaLabel:labelString,size:"SMALL",themeIcon:self.level===1?self.data.themeIcon:"",icon:self.level===1?self.data.icon:""}).addClass(this.myClass("button")).style({fill:this.slot(function(selected,id){if(selected&&foam.util.equals(selected.id,id)){return self.returnExpandedCSS("/*%PRIMARY3%*/ #604aff")}return self.returnExpandedCSS("/*%GREY2%*/ #9ba1a6")},this.selection$,this.data$.dot("id"))}).end().endContext().end().start().show(this.expanded$).add(this.slot(function(subMenus){return this.E().forEach(subMenus,function(obj){this.add(self.cls_.create({data:obj,formatter:self.formatter,relationship:self.relationship,expanded:true,showRootOnSearch:self.showThisRootOnSearch$,query:controlledSearchSlot,onClickAddOn:self.onClickAddOn,level:self.level+1},self)).addClass("child-menu")})})).end()}],listeners:[function onDragStart(e){e.dataTransfer.setData("application/x-foam-obj-id",this.data.id);e.stopPropagation()},function onDragOver(e){if(!e.dataTransfer.types.some(function(m){return m==="application/x-foam-obj-id"}))return;var id=e.dataTransfer.getData("application/x-foam-obj-id");if(foam.util.equals(id,this.data.id))return;e.preventDefault();e.stopPropagation()},function onDrop(e){if(!e.dataTransfer.types.some(function(m){return m==="application/x-foam-obj-id"}))return;var id=e.dataTransfer.getData("application/x-foam-obj-id");if(foam.util.equals(id,this.data.id))return;e.preventDefault();e.stopPropagation();var self=this;var dao=this.__context__[this.relationship.targetDAOKey];dao.find(id).then(function(obj){if(!obj)return null;dao.remove(obj).then(function(){self.data[self.relationship.forwardName].dao.put(obj).then(function(obj){self.onObjDrop(obj,id)})})})},function selected(e){this.selection=this.data;e.preventDefault();e.stopPropagation()}],actions:[{name:"onClickFunctions",label:"",code:function(){if(this.onClickAddOn)this.onClickAddOn(this.data);this.toggleExpanded()}},{name:"toggleExpanded",label:"",code:function(){this.expanded=!this.expanded;this.selection=this.data}}]});
foam.CLASS({package:"foam.u2.view",name:"TreeView",extends:"foam.u2.Element",requires:["foam.mlang.ExpressionsSingleton","foam.u2.view.TreeViewRow"],imports:["theme"],exports:["onObjDrop","selection","startExpanded"],css:`
^ {
padding-top: 10px;
overflow-y: auto;
overflow-x: hidden;
}
`,properties:[{class:"foam.dao.DAOProperty",name:"data"},{name:"relationship"},{name:"selection"},{class:"Function",name:"formatter"},{class:"Boolean",name:"startExpanded",value:false},"query",{class:"Function",name:"onClickAddOn"},["defaultRoot",""]],methods:[function render(){this.startExpanded=this.startExpanded;var M=this.ExpressionsSingleton.create();var of=this.__context__.lookup(this.relationship.sourceModel);var dao=this.data$proxy.where(M.EQ(of.getAxiomByName(this.relationship.inverseName),this.defaultRoot));var self=this;var isFirstSet=false;this.addClass().select(dao,function(obj){if(!isFirstSet&&!self.selection){self.selection=obj;isFirstSet=true}return self.TreeViewRow.create({data:obj,relationship:self.relationship,expanded:self.startExpanded,formatter:self.formatter,query:self.query,onClickAddOn:self.onClickAddOn,level:1},this)})},function onObjDrop(obj,target){}]});
foam.CLASS({package:"foam.u2.view",name:"FileUploadTextField",extends:"foam.u2.View",properties:[{name:"data",hidden:true,postSet:function(_,n){this.isSet=!!n}},{class:"Boolean",name:"isSet",visibility:"RO"},{name:"fileInput_"}],methods:[function render(){this.SUPER();this.startContext({data:this}).addClass(this.myClass()).start("input",null,this.fileInput_$).hide().attrs({type:"file"}).on("change",this.onFileUpload).end().add(this.UPLOAD).start("span").style({"margin-left":"8px"}).add(this.IS_SET).end().endContext()}],actions:[{name:"upload",isAvailable:function(fileInput_){return!!fileInput_},code:function(){this.fileInput_.el().then(el=>el.click())}}],listeners:[{name:"onFileUpload",code:async function(){if(!this.fileInput_)return;var el=await this.fileInput_.el();if(el.value=="")return;if(el.files.length==0)return;var file=el.files[0];var reader=new FileReader;reader.onload=e=>{var csv=e.target.result;this.data=csv};reader.readAsBinaryString(file);el.value=""}}]});
foam.CLASS({package:"foam.u2.view",name:"AltView",extends:"foam.u2.View",mixins:["foam.u2.memento.Memorable"],requires:["foam.u2.view.RadioView"],css:`
^ { margin: auto; width: 100%; }
`,properties:[{name:"of",factory:function(){return this.data.of}},{name:"views",factory:function(){return[]}},{name:"selectedView",view:function(_,X){return X.data.RadioView.create({choices:X.data.views,isHorizontal:true,columns:8},X)},factory:function(){return this.views[0][0]},adapt:function(_,nu){if(typeof nu==="string"){for(var i=0;i<this.views.length;i++){if(this.views[i][1]===nu){return this.views[i][0]}}}else if(typeof nu==="number"){return this.views[nu][0]}return nu}},{class:"foam.dao.DAOProperty",name:"data"},{class:"String",name:"selectedViewLabel",memorable:true}],methods:[function render(){this.SUPER();var self=this;if(this.selectedViewLabel){var viewSelectedWithMemento=this.views.find(v=>foam.Array.isInstance(v)&&v[1]==this.selectedViewLabel);if(viewSelectedWithMemento){this.selectedView=viewSelectedWithMemento[1]}else{this.selectedViewLabel=""}}this.addClass();this.startContext({data:this});this.start().add(this.SELECTED_VIEW).end().endContext().start("div").add(this.selectedView$.map(function(v){return self.E().tag(v,{data:self.data$proxy})})).end();this.onDetach(this.selectedView$.sub(function(){self.setMementoWithSelectedView()}))}],actions:[function setMementoWithSelectedView(){if(!this.memento_)return;var view=this.views.find(v=>v[0]==this.selectedView);this.selectedViewLabel=view?view[1]:""}]});
foam.CLASS({package:"foam.u2.view",name:"ResponsiveAltView",extends:"foam.u2.View",imports:["displayWidth"],requires:["foam.u2.layout.DisplayWidth"],properties:["prop",{name:"views",factory:function(){return[]}},{name:"selectedView",view:function(_,X){return X.data.RadioView.create({choices:X.data.views,isHorizontal:true,columns:8},X)},factory:function(){return this.views[0][0]},adapt:function(_,nu){if(foam.String.isInstance(nu)){for(var i=0;i<this.views.length;i++){if(this.views[i][1]===nu){return this.views[i][0]}}}else if(foam.Number.isInstance(nu)){return this.views[nu][0]}return nu}},{class:"Map",name:"viewMap"}],methods:[function render(){this.SUPER();var self=this;this.views$.sub(this.createViewMap);this.createViewMap();this.displayWidth$.sub(this.maybeUpdateView);this.maybeUpdateView();this.addClass().add(this.selectedView$.map(function(v){return self.E().start(v,{data:self.data}).call(function(){self.prop&&this.fromProperty&&this.fromProperty(self.prop)}).end()}))},function fromProperty(prop){this.prop=prop}],listeners:[{name:"createViewMap",isFramed:true,code:function(){this.clearProperty("viewMap");this.views.forEach(v=>{if(!v[1])return;v[1].forEach(dw=>{if(!this.viewMap[dw])this.viewMap[dw]=[];this.viewMap[dw].push(v[0])})})}},{name:"maybeUpdateView",isFramed:true,code:function(){var self=this;if(this.viewMap[this.displayWidth.name]){this.selectedView=this.viewMap[this.displayWidth.name][0];return}var newView;this.DisplayWidth.VALUES.sort(this.DisplayWidth.ORDINAL.compare).forEach(dw=>{if(newView&&dw.minWidth>self.displayWidth.minWidth)return;if(this.viewMap[dw.name])newView=this.viewMap[dw.name][0]});this.selectedView=newView}}]});
foam.CLASS({package:"foam.u2.view",name:"ObjAltView",extends:"foam.u2.View",mixins:["foam.u2.memento.Memorable"],requires:["foam.u2.view.RadioView"],css:`
^ { margin: auto; }
^ .foam-u2-view-RadioView.foam-u2-view-RadioView-horizontal-radio .choice {
}
`,properties:[{name:"of",factory:function(){return this.data.of}},{name:"views",factory:function(){return[]}},{name:"selectedView",view:function(_,X){return X.data.RadioView.create({choices:X.data.views,isHorizontal:true,columns:8},X.createSubContext({controllerMode:foam.u2.ControllerMode.EDIT}))},postSet:function(_,n){var view=this.views.find(v=>v[0]===n);if(view){this.selectedViewLabel=view[1]}else{this.selectedViewLabel=null}}},{name:"selectedViewLabel",memorable:true},{name:"data"},"currentMemento_"],methods:[function render(){this.SUPER();var self=this;if(this.selectedViewLabel){var view=this.views.find(v=>v[1]===this.selectedViewLabel);if(view){this.selectedView=view[0]}else{this.selectedView=this.views[0][0]}}else{this.selectedView=this.views[0][0]}this.addClass();this.startContext({data:this});this.start().add(this.SELECTED_VIEW).end().endContext().start("div").add(this.selectedView$.map(function(v){return self.E().tag(v,{data$:self.data$})})).end()}]});
foam.CLASS({package:"foam.u2.view",name:"ModeAltView",extends:"foam.u2.View",requires:["foam.u2.DisplayMode"],exports:["contextData as data"],properties:[["nodeName","span"],{class:"foam.u2.ViewSpec",name:"readView"},{class:"foam.u2.ViewSpec",name:"writeView"},"prop","args",{name:"contextData",factory:function(){return this.__context__.data}}],methods:[function initArgs(args){this.SUPER.apply(this,arguments);if(args){this.args=foam.Object.shallowClone(args);delete this.args["class"];delete this.args["readView"];delete this.args["writeView"]}else{this.args={}}},function render(){var self=this;var callFromProperty=function(){self.prop&&this.fromProperty&&this.fromProperty(self.prop)};this.SUPER();this.addClass().add(this.slot(function(mode){switch(mode){case self.DisplayMode.RW:case self.DisplayMode.DISABLED:return self.createChild_(self.writeView,{...this.args,focused$:self.focused$,data$:self.data$,mode:mode}).call(callFromProperty);case self.DisplayMode.RO:return self.createChild_(self.readView,{...this.args,data$:self.data$,mode:mode}).call(callFromProperty);case self.DisplayMode.HIDDEN:break;default:console.warn("Unrecognized mode: "+mode)}}))},function fromProperty(prop){this.prop=prop;this.SUPER(prop)}]});
foam.CLASS({package:"foam.u2.view",name:"StringView",extends:"foam.u2.view.ModeAltView",requires:["foam.u2.TextField","foam.u2.view.ValueView"],properties:[{name:"readView",value:{class:"foam.u2.view.ValueView"}},{name:"writeView",value:{class:"foam.u2.TextField"}}]});
foam.CLASS({package:"foam.u2.view",name:"DateView",extends:"foam.u2.view.ModeAltView",requires:["foam.u2.DateView","foam.u2.view.date.DateTimePicker","foam.u2.view.ValueView"],constants:[{name:"READ_DELEGATE",factory:function(){var e=document.createElement("input");e.setAttribute("type","date");return e.type==="text"?"foam.u2.view.date.RODateView":"foam.u2.DateView"}},{name:"WRITE_DELEGATE",factory:function(){var e=document.createElement("input");e.setAttribute("type","date");return e.type==="text"?"foam.u2.view.date.DateTimePicker":"foam.u2.DateView"}}],properties:[{name:"readView",factory:function(){return{class:this.READ_DELEGATE}}},{name:"writeView",factory:function(){return{class:this.WRITE_DELEGATE}}}]});
foam.CLASS({package:"foam.u2.view",name:"DateTimeView",extends:"foam.u2.view.ModeAltView",requires:["foam.u2.DateTimeView","foam.u2.view.ValueView"],properties:[{name:"readView",value:{class:"foam.u2.view.ValueView"}},{name:"writeView",value:{class:"foam.u2.DateTimeView"}}]});
foam.CLASS({package:"foam.u2.view",name:"TimeView",extends:"foam.u2.view.ModeAltView",requires:["foam.u2.TimeView","foam.u2.view.ValueView"],properties:[{name:"readView",value:{class:"foam.u2.view.ValueView"}},{name:"writeView",value:{class:"foam.u2.TimeView"}}]});
foam.CLASS({package:"foam.u2.view",name:"FloatView",extends:"foam.u2.view.ModeAltView",requires:["foam.u2.FloatView","foam.u2.view.ValueView"],properties:[{name:"readView",value:{class:"foam.u2.view.ValueView"}},{name:"writeView",value:{class:"foam.u2.FloatView"}}]});
foam.CLASS({package:"foam.u2.view",name:"IntView",extends:"foam.u2.view.ModeAltView",requires:["foam.u2.IntView","foam.u2.view.ValueView"],properties:[{name:"readView",value:{class:"foam.u2.view.ValueView"}},{name:"writeView",value:{class:"foam.u2.IntView"}}]});
foam.CLASS({package:"foam.u2.view",name:"CurrencyView",extends:"foam.u2.view.ModeAltView",requires:["foam.u2.CurrencyView","foam.u2.view.ValueView"],properties:[{name:"readView",value:{class:"foam.u2.view.ValueView"}},{name:"writeView",value:{class:"foam.u2.CurrencyView"}}]});
foam.CLASS({package:"foam.u2.view",name:"CurrencyInputView",extends:"foam.u2.View",implements:["foam.mlang.Expressions"],requires:["foam.u2.util.NumberShortener"],imports:["ctrl","currencyDAO","data as parentObj"],exports:["as data"],css:`
^ {
display: flex;
}
^container-selection {
display: flex;
justify-content: center;
align-items: center;
text-align: center;
box-sizing: border-box;
width: 64px;
height: 30px;
border: 1px solid /*%GREY3%*/ #cbcfd4;
border-right: none;
border-radius: 3px 0 0 3px;
}
^container-selection p {
margin: 0;
}
^container-input {
box-sizing: border-box;
flex: 1;
height: 30px;
font-size: 1.4rem;
border: 1px solid /*%GREY3%*/ #cbcfd4;
border-left: none;
border-radius: 0 3px 3px 0;
width: 100%;
}
`,properties:[{name:"contingentProperty",},{class:"Reference",of:"foam.core.Unit",name:"currencyId",},{class:"FObjectProperty",of:"foam.core.Currency",name:"currency",},{name:"shortenToPrecision",},{class:"String",name:"valueString",factory:function(){return this.data||0},preSet:function(_,n){var sanitized=this.sanitizeString(n);this.data=sanitized;return this.currency?this.currency.format(sanitized,true):sanitized},view:{class:"foam.u2.tag.Input",onKey:true}},{class:"Long",name:"data",}],methods:[function init(){this.SUPER();if(this.contingentProperty&&this.parentObj){this.currencyId$=this.parentObj$.dot(this.contingentProperty)}this.onDetach(this.currencyId$.sub(this.currencyIdUpdate));this.currencyIdUpdate()},function render(){this.SUPER();var self=this;this.addClass().add(this.slot(function(mode,currency){if(mode===foam.u2.DisplayMode.RW){return this.E().style({display:"flex"}).start().addClass(self.myClass("container-selection")).start("p").addClass(self.myClass("label-currency")).add(currency?`${currency.id} ${currency.symbol}`:"--").end().end().startContext({data:self}).start(self.VALUE_STRING).addClass(self.myClass("container-input")).end().endContext()}return self.E().start("div").addClass(self.myClass("label-currency")).add(self.getDisplayValue()).end()}))},function getDisplayValue(){if(this.currency){return Number.isInteger(this.shortenToPrecision)?this.NumberShortener.shortenNumber(this.data,this.shortenToPrecision,this.currency):this.currency.format(this.data)}return Number.isInteger(this.shortenToPrecision)?this.NumberShortener.shortenNumber(this.data,this.shortenToPrecision):this.data},function sanitizeString(s){return s.replace(/[\D\s\._\-]+/g,"")}],listeners:[{name:"currencyIdUpdate",code:function(){if(!this.currencyId){this.currency=null;return}this.currencyDAO.find(this.currencyId).then(currency=>{this.currency=currency;this.valueString=currency.format(this.sanitizeString(this.valueString),true)})}}]});
foam.CLASS({package:"foam.u2.view",name:"FObjectPropertyView",extends:"foam.u2.view.ModeAltView",requires:["foam.u2.CitationView","foam.u2.detail.VerticalDetailView"],properties:[{name:"readView",value:{class:"foam.u2.detail.VerticalDetailView"}},{name:"writeView",factory:function(){return{class:"foam.u2.view.FObjectView",of:this.prop.of}}}]});
foam.CLASS({package:"foam.u2.view",name:"CodeView",extends:"foam.u2.view.ModeAltView",requires:["foam.u2.view.PreView","io.c9.ace.Editor"],properties:[{name:"readView",value:{class:"foam.u2.view.PreView"}},{name:"writeView",value:{class:"io.c9.ace.Editor"}}]});
foam.CLASS({package:"foam.u2.view",name:"ReferencePropertyView",extends:"foam.u2.view.ModeAltView",requires:["foam.u2.view.ReferenceView","foam.u2.view.ReadReferenceView"],properties:[["readView",{class:"foam.u2.view.ReadReferenceView"}],["writeView",{class:"foam.u2.view.ReferenceView"}]]});
foam.CLASS({package:"foam.u2.view",name:"EnumView",extends:"foam.u2.view.ModeAltView",requires:["foam.u2.CitationView","foam.u2.EnumView"],properties:[{name:"readView",value:{class:"foam.u2.view.ReadOnlyEnumView"}},{name:"writeView",value:{class:"foam.u2.EnumView"}}]});
foam.CLASS({package:"foam.u2.view",name:"ColorView",extends:"foam.u2.view.ModeAltView",requires:["foam.u2.TextField","foam.u2.view.ColorPicker","foam.u2.view.DualView","foam.u2.view.ReadColorView"],properties:[{name:"readView",value:{class:"foam.u2.view.ReadColorView"}},{name:"writeView",value:{class:"foam.u2.view.DualView",viewa:"foam.u2.TextField",viewb:{class:"foam.u2.view.ColorPicker",onKey:true}}}]});
foam.CLASS({package:"foam.u2.view",name:"ReadColorView",extends:"foam.u2.View",css:`
^ {
align-items: center;
border-radius: 3px;
display: flex;
height: /*%INPUTHEIGHT%*/ 34px;
justify-content: center;
padding: 0 32px;
}
^black {
color: /*%BLACK%*/ #1e1f21;
}
^white {
color: #fff;
}
`,methods:[function render(){this.SUPER();this.addClass(this.myClass()).style({"background-color":this.data$}).start().addClass(this.myClass("black")).add(this.data$).end().nbsp().nbsp().start().addClass(this.myClass("white")).add(this.data$).end()}]});
foam.CLASS({package:"foam.u2.view",name:"SimpleAltView",extends:"foam.u2.Element",requires:["foam.u2.view.ChoiceView"],properties:[{name:"choices"},{name:"selected"}],methods:[function render(){var view=this;this.add(this.slot(function(choices){if(!view.selected)view.selected=choices[0][0];return this.ChoiceView.create({choices:choices,data$:this.selected$})})).add(this.slot(function(selected){return foam.u2.ViewSpec.createView(selected,null,this,this.__subSubContext__)}))}]});
foam.CLASS({package:"foam.u2.view",name:"DualView",extends:"foam.u2.MultiView",css:`
^viewa, ^viewb { padding: 2px 0; }
^viewa { margin-right: 8px; }
`,properties:[{class:"foam.u2.ViewSpec",name:"viewa"},{class:"foam.u2.ViewSpec",name:"viewb"},{class:"Array",name:"views",factory:function(){return[this.viewa,this.viewb]}}]});
foam.CLASS({package:"foam.u2.view",name:"ColorEditView",extends:"foam.u2.MultiView",css:`
^container:first-child {
flex-grow: 1;
}
`,properties:[{name:"views",factory:()=>[{class:"foam.u2.TextField"},{class:"foam.u2.view.ColorPicker"}]}]});
foam.CLASS({package:"foam.u2.view",name:"ColorPicker",extends:"foam.u2.tag.Input",css:`
^ {
height: /*%INPUTHEIGHT%*/ 34px;
padding: 0;
}
`,properties:[{name:"type",value:"color"}],methods:[function link(){var self=this;this.addClass();this.attrSlot(null,this.onKey?"input":null).relateFrom(this.data$,function(value){if(typeof value!=="string")return value;var v=value.toLowerCase();if(foam.Color.COLOR_TO_NAME[v])return foam.Color.COLOR_TO_NAME[v];return value},function(value){if(typeof value!=="string")return value;var v=value.toLowerCase();if(foam.Color.NAME_TO_COLOR[v])return foam.Color.NAME_TO_COLOR[v];return value})}]});
foam.CLASS({package:"foam.u2.view",name:"PasswordView",extends:"foam.u2.View",requires:["foam.u2.TextField"],imports:["theme?"],css:`
^ {
position: relative;
width: 100%;
}
^input-image {
--fieldSize: /*%INPUTHEIGHT%*/ 34px;
position: absolute;
width: 16px;
height: calc( var(--fieldSize) / 1.2);
top: calc( var(--fieldSize) / 15);
right: 1vh;
opacity: 0.3;
}
.full-width-input-password:focus + ^input-image {
opacity: 1;
}
`,constants:[{type:"String",name:"VISIBILITY",value:"/images/visibility.svg"},{type:"String",name:"VISIBILITY_OFF",value:"/images/visibility-off.svg"}],properties:[{name:"visibilityIcon",factory:function(){return this.VISIBILITY_OFF}},{class:"Boolean",name:"passwordInvisible",value:true},{class:"Boolean",name:"passwordIcon"},{class:"String",name:"type",value:"password"},"inputElement",{class:"Boolean",name:"isAvailable",value:true}],methods:[function render(){this.SUPER();var typingTimer;var doneTypingInterval=400;this.addClass().start(this.TextField,{type$:this.type$,data$:this.data$,onKey:true}).addClass("full-width-input-password").on("keyup",()=>{clearTimeout(typingTimer);typingTimer=setTimeout(this.checkAvailability,doneTypingInterval)}).on("keydown",()=>{clearTimeout(typingTimer);this.isAvailable=true}).end().start("img").show(this.passwordIcon$).addClass(this.myClass("input-image")).attr("src",this.visibilityIcon$).on("mousedown",e=>e.preventDefault()).on("click",()=>this.visible()).end()},function visibleIcon(visibilityIcon,type){this.visibilityIcon=visibilityIcon;this.type=type;this.passwordInvisible=!this.passwordInvisible;this.enableClass("property-password",this.passwordInvisible)}],listeners:[function visible(){if(this.passwordInvisible){this.visibleIcon(this.VISIBILITY,"text")}else{this.visibleIcon(this.VISIBILITY_OFF,"password")}},function checkAvailability(){this.theme?.passwordPolicy.validate(this.data).then(pw=>{this.isAvailable=!pw})}]});
foam.CLASS({package:"foam.u2.view",name:"ChipView",extends:"foam.u2.View",imports:["removeChip"],css:`
^ {
height: 30px;
border-radius: 100px;
background-color: #a4b3b8;
margin: auto;
position: relative;
float: left;
margin: 5px;
}
^ .label {
font-size: 1.2rem;
line-height: 1.33;
letter-spacing: 0.2px;
text-align: left;
color: #ffffff;
padding: 8px 15px 6px 10px;
display: table-cell;
}
^ .foam-u2-ActionView-removeSelf {
width: 10px;
height: 10px;
object-fit: contain;
margin: 0;
margin-top: -11;
float: right;
cursor: pointer;
display: inline-block;
outline: 0;
border: none;
background: transparent;
padding-right: 15x;
}
^ .foam-u2-ActionView-removeSelf img {
width: 15px;
height: 15px;
}
^ .foam-u2-ActionView-removeSelf:hover {
background: transparent;
background-color: transparent;
}
`,methods:[function render(){this.SUPER();this.addClass(this.myClass()).start().start("p").addClass("label").add(this.data).startContext({data:this}).add(this.REMOVE_SELF).endContext().end().end()}],actions:[{name:"removeSelf",icon:"images/ic-cancelwhite.svg",code:function(){this.removeChip(this.data)}}]});foam.INTERFACE({package:"foam.u2.view",name:"Formatter",methods:[{name:"format",args:["e","value","obj","axiom"]}]});
foam.CLASS({package:"foam.u2.view",name:"FnFormatter",implements:["foam.u2.view.Formatter"],properties:[{class:"Function",name:"f"}],methods:[function format(e,value,obj,axiom){this.f.call(e,value,obj,axiom)}]});
foam.CLASS({package:"foam.u2.view",name:"TableCellFormatter",extends:"FObjectProperty",requires:["foam.core.FObjectProperty","foam.u2.view.FnFormatter"],properties:[{name:"of",value:"foam.u2.view.Formatter"},{name:"adapt",value:function(o,f,prop){if(foam.String.isInstance(f)){return foam.lookup(f).create()}if(foam.Function.isInstance(f)){return prop.FnFormatter.create({f:f})}return prop.FObjectProperty.ADAPT.value.call(this,o,f,prop)}},{name:"value",adapt:function(_,v){return this.adapt.call(this,_,v,this)}}]});
foam.CLASS({package:"foam.u2.view",name:"TableCellPropertyRefinement",refines:"foam.core.Property",properties:[{name:"tableHeaderFormatter",value:function(axiom){this.add(axiom.label||foam.String.labelize(axiom.name))}},{class:"foam.u2.view.TableCellFormatter",name:"tableCellFormatter",factory:function(){return foam.u2.view.FnFormatter.create({class:"foam.u2.view.FnFormatter",f:function(value,obj,axiom){this.add(value)}})}},{class:"Int",name:"tableWidth"},{class:"String",name:"columnLabel",expression:function(label){return label}}]});
foam.CLASS({package:"foam.u2.view",name:"TableHeaderActionRefinement",refines:"foam.core.Action",properties:[{class:"String",name:"columnLabel",expression:function(label){return label}}]});
foam.CLASS({package:"foam.u2.view",name:"ActionTableCellFormatterRefinement",refines:"foam.core.Action",properties:[{tags:["web"],generateJava:false,class:"foam.u2.view.TableCellFormatter",name:"tableCellFormatter",value:function(_,obj,axiom){this.startContext({data:obj}).tag(axiom,{size:"SMALL",buttonStyle:"SECONDARY"}).endContext()}},{tags:["web"],generateJava:false,name:"tableHeaderFormatter",value:function(axiom){this.add(axiom.label)}},{type:"Int",name:"tableWidth",value:130}]});
foam.CLASS({package:"foam.u2.view",name:"EnumTableCellFormatterRefinement",refines:"foam.core.Enum",requires:["foam.u2.view.ReadOnlyEnumView"],properties:[{class:"foam.u2.view.TableCellFormatter",name:"tableCellFormatter",value:function(value){if(value){this.tag(foam.u2.view.ReadOnlyEnumView,{data:value})}else{this.start().add("-").end()}}},{class:"Int",name:"tableWidth",value:130}]});
foam.CLASS({package:"foam.u2.view",name:"ImageTableCellFormatterRefinement",refines:"foam.core.Image",requires:["foam.u2.view.ImageView","foam.u2.crunch.Style"],css:`
.foam-u2-view-ImageTableCellFormatter {
height: -webkit-fill-available;
height: -moz-available;
padding: 2px;
}
`,properties:[{class:"foam.u2.view.TableCellFormatter",name:"tableCellFormatter",value:function(value){if(value){this.start({class:"foam.u2.view.ImageView",data:value}).addClass("foam-u2-view-ImageTableCellFormatter").end()}else{this.start().add("-").end()}}}]});
foam.CLASS({package:"foam.u2.view",name:"FObjectPropertyTableCellFormatterRefinement",refines:"foam.core.FObjectProperty",properties:[{class:"foam.u2.view.TableCellFormatter",name:"tableCellFormatter",value:function(obj){this.callIf(obj,function(){this.start().add(obj.toSummary()).end()})}}]});
foam.CLASS({package:"foam.u2.view",name:"UnitValueTableCellFormatterRefinement",refines:"foam.core.UnitValue",properties:[{class:"foam.u2.view.TableCellFormatter",name:"tableCellFormatter",value:function(value,obj,axiom){var unitProp=obj.cls_.getAxiomByName(axiom.unitPropName);if(!unitProp){console.warn(obj.cls_.name," does not have the property: ",axiom.unitPropName);this.add(value);return}var self=this;this.add(foam.core.ExpressionSlot.create({args:[obj.slot(unitProp.name),obj.slot(axiom.name)],code:(unitId,propValue)=>{return foam.core.PromiseSlot.create({promise:obj.__context__.currencyDAO.find(unitId).then(unit=>{var formatted=unit?unit.format(propValue):propValue;self.tooltip=formatted;return formatted})})}}))}}]});
foam.CLASS({package:"foam.u2.view",name:"ReferenceToSummaryCellFormatter",implements:["foam.u2.view.Formatter"],methods:[function format(e,value,obj,axiom){try{obj[axiom.name+"$find"].then(o=>e.add(o.toSummary()),r=>e.add(value))}catch(x){}}]});
foam.CLASS({package:"foam.u2.view",name:"YesNoTableCellFormatter",implements:["foam.u2.view.Formatter"],methods:[function format(e,value,obj,axiom){e.start().call(function(){if(value){e.style({color:"green"})}}).add(value?" Y":"-").end()}]});
foam.CLASS({package:"foam.u2.view",name:"BooleanTableCellFormatterRefinement",refines:"foam.core.Boolean",properties:[{class:"foam.u2.view.TableCellFormatter",name:"tableCellFormatter",value:function(value){this.tag({class:"foam.u2.CheckBox",data:value})}}]});
foam.CLASS({package:"foam.u2.view",name:"StringArrayTableCellFormatterRefinement",refines:"foam.core.StringArray",properties:[{class:"foam.u2.view.TableCellFormatter",name:"tableCellFormatter",value:function(value){this.add(value.join(", "))}}]});
foam.CLASS({package:"foam.u2.view",name:"FObjectArrayTableCellFormatterRefinement",refines:"foam.core.FObjectArray",properties:[{class:"foam.u2.view.TableCellFormatter",name:"tableCellFormatter",value:function(value){this.callIf(value,function(){this.add(value.map(o=>o.toSummary()).join(", "))})}}]});
foam.CLASS({package:"foam.u2.view",name:"DateTableCellFormatterRefinement",refines:"foam.core.Date",properties:[{class:"foam.u2.view.TableCellFormatter",name:"tableCellFormatter",value:function(date){if(date){var formattedDate=date.toLocaleDateString(foam.locale);this.add(formattedDate);this.tooltip=formattedDate}}},{class:"Int",name:"tableWidth",value:130}]});
foam.CLASS({package:"foam.u2.view",name:"DateTimeTableCellFormatterRefinement",refines:"foam.core.DateTime",properties:[{class:"foam.u2.view.TableCellFormatter",name:"tableCellFormatter",value:function(date){if(date){var formattedDate=date.toLocaleString(foam.locale);this.add(formattedDate);this.tooltip=formattedDate}}},{class:"Int",name:"tableWidth",value:130}]});
foam.CLASS({package:"foam.u2.view",name:"DurationTableCellFormatterRefinement",refines:"foam.core.Duration",imports:["returnExpandedCSS"],properties:[{class:"foam.u2.view.TableCellFormatter",name:"tableCellFormatter",value:function(value){let formatted=foam.core.Duration.duration(value);let negative=value<0;this.add(formatted||"0ms").style({color:negative?this.__subContext__.returnExpandedCSS("/*%DESTRUCTIVE2%*/ #a61414"):"inherit"})}}]});
foam.CLASS({package:"foam.u2.view",name:"FormattedStringTableCellFormatterRefinement",refines:"foam.core.FormattedString",properties:[{class:"foam.u2.view.TableCellFormatter",name:"tableCellFormatter",value:function(val,_,prop){var format=prop.formatter.join("").replace(/\d+/g,function(match){return"x".repeat(match)});this.add(foam.String.applyFormat(val,format))}}]});
foam.CLASS({package:"foam.u2.view",name:"UnstyledTableView",extends:"foam.u2.Element",implements:["foam.mlang.Expressions"],requires:["foam.core.SimpleSlot","foam.dao.ProxyDAO","foam.nanos.column.ColumnConfigToPropertyConverter","foam.nanos.column.CommonColumnHandler","foam.nanos.column.TableColumnOutputter","foam.u2.CheckBox","foam.u2.md.OverlayDropdown","foam.u2.tag.Image","foam.u2.table.TableHeaderComponent","foam.u2.table.UnstyledTableRow","foam.u2.view.EditColumnsView","foam.u2.view.OverlayActionListView"],exports:["columns","currentMemento_ as memento","hoverSelection","props","selection","subStack as stack"],imports:["auth?","click?","dblclick?","editRecord?","filteredTableColumns?","memento","selection? as importSelection","stack?"],constants:[{type:"Int",name:"MIN_COLUMN_WIDTH_FALLBACK",value:100},{type:"Int",name:"EDIT_COLUMNS_BUTTON_CONTAINER_WIDTH",value:60},{type:"Char",name:"DESCENDING_ORDER_CHAR",value:"-"},{type:"Char",name:"ASCENDING_ORDER_CHAR",value:"+"}],properties:[{class:"Class",name:"of"},{class:"foam.dao.DAOProperty",name:"data",postSet:function(_,data){if(!this.of&&data)this.of=data.of}},{class:"foam.dao.DAOProperty",name:"refDAO",factory:function(){return this.data}},{name:"order"},{name:"columns_",factory:function(){return[]}},{name:"allColumns"},{name:"selectedColumnNames",expression:function(columns,of,memento,memento$head){var ls=memento&&memento.head.length!=0?memento.head.split(",").map(c=>this.returnMementoColumnNameDisregardSorting(c)):JSON.parse(localStorage.getItem(of.id));return ls||columns}},{name:"columns",expression:function(of,allColumns,isColumnChanged){if(!of)return[];var tc=of.getAxiomByName("tableColumns");return tc?tc.columns:allColumns}},{class:"FObjectArray",of:"foam.core.Action",name:"contextMenuActions",},{class:"Boolean",name:"editColumnsEnabled",value:true,},{class:"Boolean",name:"disableUserSelection",value:false,},{name:"restingIcon",value:"/images/resting-arrow.svg"},{name:"ascIcon",value:"/images/up-arrow.svg"},{name:"descIcon",value:"/images/down-arrow.svg"},{name:"selection",expression:function(importSelection){return importSelection||null}},"hoverSelection","dropdownOrigin","overlayOrigin",{type:"Boolean",name:"showHeader",value:true,},{class:"Boolean",name:"multiSelectEnabled",},{class:"Map",name:"selectedObjects",},{name:"idsOfObjectsTheUserHasInteractedWith_",factory:function(){return{}}},{name:"checkboxes_",factory:function(){return{}}},{class:"Boolean",name:"togglingCheckBoxes_",},{class:"Boolean",name:"allCheckBoxesEnabled_",},{class:"Int",name:"tableWidth_",expression:function(props){return this.columns_.reduce((acc,col)=>{return acc+(this.columnHandler.returnPropertyForColumn(this.props,this.of,col,"tableWidth")||this.MIN_COLUMN_WIDTH_FALLBACK)},this.EDIT_COLUMNS_BUTTON_CONTAINER_WIDTH)+"px"}},{name:"isColumnChanged",class:"Boolean",value:false,},{name:"outputter",factory:function(){return this.TableColumnOutputter.create()}},{name:"props",expression:function(of,columns_){return this.returnPropertiesForColumns(this,columns_)}},{name:"updateValues",class:"Boolean",value:false,},{name:"columnHandler",class:"FObjectProperty",of:"foam.nanos.column.CommonColumnHandler",factory:function(){return foam.nanos.column.CommonColumnHandler.create()}},{name:"columnConfigToPropertyConverter",factory:function(){if(!this.__context__.columnConfigToPropertyConverter)return foam.nanos.column.ColumnConfigToPropertyConverter.create();return this.__context__.columnConfigToPropertyConverter}},{name:"subStack",factory:function(){return foam.nanos.approval.NoBackStack.create({delegate:this.stack})}},"currentMemento_",{class:"Boolean",name:"selectColumnsExpanded"}],methods:[function sortBy(column){var isNewOrderDesc=this.order===column;this.order=isNewOrderDesc?this.DESC(column):column;if(!this.memento||this.memento.head.length==0)return;var columns=this.memento.head.split(",");var mementoColumn=columns.find(c=>this.returnMementoColumnNameDisregardSorting(c)===column.name);var orderChar=isNewOrderDesc?this.DESCENDING_ORDER_CHAR:this.ASCENDING_ORDER_CHAR;if(!mementoColumn){columns.push(column.name+orderChar)}else{var index=columns.indexOf(mementoColumn);columns[index]=column.name+orderChar}this.memento.head=columns.join(",")},function updateColumns(){localStorage.removeItem(this.of.id);localStorage.setItem(this.of.id,JSON.stringify(this.selectedColumnNames.map(c=>foam.String.isInstance(c)?c:c.name)));if(!this.memento)return;var newMementoColumns=[];for(var s of this.selectedColumnNames){var columns=[];if(this.memento.head.length!=0)columns=this.memento.head.split(",");var col=columns.find(c=>this.returnMementoColumnNameDisregardSorting(c)===s);if(!col){newMementoColumns.push(s)}else{newMementoColumns.push(col)}}this.memento.head=newMementoColumns.join(",");this.isColumnChanged=!this.isColumnChanged},async function render(){var view=this;const asyncRes=await this.filterUnpermitted(view.of.getAxiomsByClass(foam.core.Property));this.allColumns=!view.of?[]:[].concat(asyncRes.map(a=>a.name),view.of.getAxiomsByClass(foam.core.Action).map(a=>a.name).filter(a=>view.of.getAxiomByName("tableColumns")?view.of.getAxiomByName("tableColumns").columns.includes(a):false));this.columns$.sub(this.updateColumns_);this.of$.sub(this.updateColumns_);this.editColumnsEnabled$.sub(this.updateColumns_);this.selectedColumnNames$.sub(this.updateColumns_);this.allColumns$.sub(this.updateColumns_);this.updateColumns_();if(this.memento){if(this.memento.head.length!=0){var columns=this.memento.head.split(",");for(var c of columns){if(this.shouldColumnBeSorted(c)&&!c.includes(".")){var prop=view.props.find(p=>p.fullPropertyName===c.substr(0,c.length-1));if(prop){if(c[c.length-1]===this.DESCENDING_ORDER_CHAR)this.order=this.DESC(prop.property);else this.order=prop.property}}}}else{this.memento.head=this.columns_.map(c=>{return this.columnHandler.propertyNamesForColumnArray(c)}).join(",")}if(!this.memento.tail){this.memento.tail=foam.nanos.controller.Memento.create({value:"",parent:this.memento});this.currentMemento_=this.memento.tail}}if(view.editColumnsEnabled)var editColumnView=foam.u2.view.EditColumnsView.create({data:view},this);if(this.filteredTableColumns$){this.onDetach(this.filteredTableColumns$.follow(this.columns_$.map(cols=>this.columnHandler.mapArrayColumnsToArrayOfColumnNames(this.filterColumnsThatAllColumnsDoesNotIncludeForArrayOfColumns(this,cols)))))}this.addClass(this.myClass()).addClass(this.myClass(this.of.id.replace(/\./g,"-"))).start().addClass(this.myClass("thead")).style({"min-width":this.tableWidth_$}).show(this.showHeader$).add(this.slot(function(columns_){view.props=this.returnPropertiesForColumns(view,columns_);view.updateValues=!view.updateValues;return this.E().addClass(view.myClass("tr")).callIf(view.multiSelectEnabled,function(){var slot=view.SimpleSlot.create();this.start().addClass(view.myClass("th")).tag(view.CheckBox,{},slot).style({width:"42px"}).end();view.onDetach(slot.value.dot("data").sub(function(_,__,___,newValueSlot){var checked=newValueSlot.get();view.allCheckBoxesEnabled_=checked;if(checked){view.selectedObjects={};view.refDAO.select(function(obj){view.selectedObjects[obj.id]=obj})}else{view.selectedObjects={}}view.togglingCheckBoxes_=true;Object.keys(view.checkboxes_).forEach(function(key){view.checkboxes_[key].data=checked});view.togglingCheckBoxes_=false}))}).forEach(columns_,function([col,overrides]){this.tag(view.TableHeaderComponent,{data:view,col:col,overrides:overrides,resizeable:false})}).call(function(){this.start().addClass(view.myClass("th")).style({flex:`0 0 ${view.EDIT_COLUMNS_BUTTON_CONTAINER_WIDTH}px`,"text-align":"unset!important;"}).callIf(view.editColumnsEnabled,function(){this.addClass(view.myClass("th-editColumns")).on("click",function(e){if(!view.selectColumnsExpanded)view.selectColumnsExpanded=!view.selectColumnsExpanded}).tag(view.Image,{data:"/images/Icon_More_Resting.svg"}).addClass(view.myClass("vertDots")).addClass(view.myClass("noselect"))}).tag("div",null,view.dropdownOrigin$).end()})})).end().callIf(view.editColumnsEnabled,function(){this.start(this.EditColumnsView,{data:view,selectColumnsExpanded$:this.selectColumnsExpanded$,parentId:this.id}).end()}).add(this.rowsFrom(this.data$proxy))},{name:"rowsFrom",code:function(dao,top){var view=this;view.props=this.returnPropertiesForColumns(view,view.columns_);var slot=this.slot(function(data,data$delegate,order,updateValues){var proxy=view.ProxyDAO.create({delegate:dao});if(this.order)proxy=proxy.orderBy(this.order);var canObjBeBuildFromProjection=true;for(var p of view.props){if(p.property.tableCellFormatter&&!p.property.cls_.hasOwnProperty("tableCellFormatter")){canObjBeBuildFromProjection=false;break}if(!foam.lookup(p.property.cls_.id)){canObjBeBuildFromProjection=false;break}}var propertyNamesToQuery=view.columnHandler.returnPropNamesToQuery(view.props);var valPromises=view.returnRecords(view.of,proxy,propertyNamesToQuery,canObjBeBuildFromProjection);var nestedPropertyNamesAndItsIndexes=view.columnHandler.buildPropNameAndIndexArray(propertyNamesToQuery);var tbodyElement=this.E();tbodyElement.style({position:top?"absolute":"",width:"100%",top:top?top+"px":""}).addClass(view.myClass("tbody"));valPromises.then(function(values){for(var i=0;i<values.projection.length;i++){tbodyElement.startContext({props:view.props,propertyNamesToQuery:propertyNamesToQuery,nestedPropsAndIndexes:nestedPropertyNamesAndItsIndexes,canBuildObjfromProj:canObjBeBuildFromProjection}).tag(view.UnstyledTableRow,{data:view,obj:values.array[i],projection:values.projection[i],actionDAO:view.refDAO}).endContext()}});return tbodyElement});return slot}},function returnRecords(of,dao,propertyNamesToQuery,useProjection){var expr=foam.nanos.column.ExpressionForArrayOfNestedPropertiesBuilder.create().buildProjectionForPropertyNamesArray(of,propertyNamesToQuery,useProjection);return dao.select(expr)},function doesAllColumnsContainsColumnName(obj,col){return obj.allColumns.contains(obj.columnHandler.checkIfArrayAndReturnFirstLevelColumnName(col))},function filterColumnsThatAllColumnsDoesNotIncludeForArrayOfColumns(obj,columns){return columns.filter(c=>obj.allColumns.includes(obj.columnHandler.checkIfArrayAndReturnFirstLevelColumnName(c)))},function returnPropertiesForColumns(obj,columns_){var propertyNamesToQuery=columns_.length===0?columns_:["id"].concat(obj.filterColumnsThatAllColumnsDoesNotIncludeForArrayOfColumns(obj,columns_).filter(c=>!foam.core.Action.isInstance(obj.of.getAxiomByName(obj.columnHandler.propertyNamesForColumnArray(c)))).map(c=>obj.columnHandler.propertyNamesForColumnArray(c)));return obj.columnConfigToPropertyConverter.returnPropertyColumnMappings(obj.of,propertyNamesToQuery)},function shouldColumnBeSorted(c){return c[c.length-1]===this.DESCENDING_ORDER_CHAR||c[c.length-1]===this.ASCENDING_ORDER_CHAR},function returnMementoColumnNameDisregardSorting(c){return c&&this.shouldColumnBeSorted(c)?c.substr(0,c.length-1):c},function returnMementoColumnNameDisregardSorting(c){return c&&this.shouldColumnBeSorted(c)?c.substr(0,c.length-1):c},async function filterUnpermitted(arr){if(this.auth){var permissionedProperties=[];var unpermissionedProperties=[];for(prop of arr){if(prop.hidden)continue;prop.readPermissionRequired?permissionedProperties.push(prop):unpermissionedProperties.push(prop)}var grantedProperties=await this.filterPropertiesByReadPermission(permissionedProperties,this.of.name.toLowerCase());var unorderedProperties=unpermissionedProperties.concat(grantedProperties);var orderedProperties=arr.filter(p=>unorderedProperties.includes(p));const columnPermissionedProperties=await Promise.all(orderedProperties.map(async p=>!p.columnPermissionRequired||await this.auth.check(ctrl.__subContext__,`${this.of.name.toLowerCase()}.column.${p.name}`)));return orderedProperties.filter((_v,index)=>columnPermissionedProperties[index])}return arr},async function filterPropertiesByReadPermission(properties,of){if(!properties||!of)return[];var perms=await Promise.all(properties.map(async p=>await this.auth.check(ctrl.__subContext__,of+".rw."+p)||await this.auth.check(ctrl.__subContext__,of+".ro."+p)));return properties.filter((_v,index)=>perms[index])},{name:"getActionsForRow",code:function(obj){var actions={};var actionsMerger=action=>{actions[action.name]=action};obj.cls_.getAxiomsByClass(foam.core.Action).forEach(actionsMerger);this.contextMenuActions.forEach(actionsMerger);return actions}}],listeners:[{name:"shouldEscapeEvts",code:function(evt){if(evt.target.nodeName==="DROPDOWN-OVERLAY"||evt.target.classList.contains(this.myClass("vertDots"))||evt.target.nodeName==="INPUT"){return true}}},{name:"updateColumns_",isFramed:true,code:function(){if(!this.of)return[];var auth=this.auth;var self=this;var cols=this.editColumnsEnabled?this.selectedColumnNames:this.columns||this.allColumns;Promise.all(this.filterColumnsThatAllColumnsDoesNotIncludeForArrayOfColumns(this,cols).map(c=>foam.Array.isInstance(c)?c:[c,null]).map(c=>{return c})).then(columns=>this.columns_=columns.filter(c=>c))}}]});
foam.CLASS({package:"foam.u2.view",name:"LazyScrollManager",extends:"foam.u2.View",mixins:["foam.u2.memento.Memorable"],requires:["foam.dao.FnSink","foam.core.Latch","foam.dao.ProxyDAO","foam.mlang.sink.Count"],implements:["foam.mlang.Expressions"],constants:[{type:"Float",name:"MIN_PAGE_PROGRESS",value:.5},{type:"Integer",name:"NUM_PAGES_TO_RENDER",value:3}],properties:[{class:"foam.dao.DAOProperty",name:"data"},{class:"Int",name:"daoCount"},{type:"Int",name:"pageSize",max:1e3,value:30,},{class:"Int",name:"numPages_",expression:function(daoCount,pageSize){return Math.ceil(daoCount/pageSize)}},{class:"Int",name:"currentTopPage_",factory:function(){return 0},preSet:function(o,n){return foam.Number.clamp(0,n,this.numPages_-this.NUM_PAGES_TO_RENDER)}},{class:"Map",name:"renderedPages_"},{class:"Map",name:"loadingPages_",},{class:"Int",name:"topRow",memorable:true,postSet:function(o,n){if(this.scrollToIndex||o==n)return;var n1=(n-this.currentTopPage_*this.pageSize)/this.pageSize;if(n<o&&n1<=1&&n1<1-this.MIN_PAGE_PROGRESS){this.currentTopPage_--}}},{class:"Int",name:"bottomRow",postSet:function(o,n){if(this.scrollToIndex||o==n)return;var n1=(n-this.currentTopPage_*this.pageSize)/this.pageSize;if(n>o&&n1>=this.NUM_PAGES_TO_RENDER-1&&n1%1>this.MIN_PAGE_PROGRESS){this.currentTopPage_++}}},{class:"Float",name:"displayedRowCount_",expression:function(topRow,bottomRow){return bottomRow-topRow}},{class:"Int",name:"scrollToIndex",postSet:function(){this.safeScroll()}},"currGroup_","rowObserver",{name:"rootElement",},{class:"foam.u2.ViewSpec",name:"rowView"},{class:"foam.u2.ViewSpec",name:"groupHeaderView"},{class:"FObjectProperty",name:"groupBy",},{class:"FObjectProperty",name:"order",},{name:"ctx",},{class:"Function",name:"prepDAO",},{name:"appendTo",factory:function(){return this.parentNode},},{class:"Int",name:"offsetTop",value:0,},{class:"FObjectProperty",of:"foam.core.Latch",name:"dataLatch",factory:function(){return this.Latch.create()}},["isInit",true]],reactions:[["","propertyChange.currentTopPage_","updateRenderedPages_"]],methods:[function init(){this.onDetach(this.data$proxy.listen(this.FnSink.create({fn:this.updateCount})));this.updateCount()},function render(){var self=this;var resize=new ResizeObserver(this.checkPageSize_);let options={root:this.rootElement?.el_()??null,rootMargin:`-${this.offsetTop}px 0px 0px`,threshold:[.25,.5,.75]};this.dataLatch.then(()=>{this.rootElement?.el().then(el=>{resize.observe(el)})});this.rowObserver=new IntersectionObserver(handleIntersect,options);function handleIntersect(entries,observer){self.onRowIntersect(entries,self)}this.onDetach(this.rootElement$.sub(this.updateRenderedPages_));this.onDetach(this.order$.sub(this.refresh));this.onDetach(this.groupBy$.sub(this.refresh))},function scrollView(scroll){if(this.rootElement.el_())this.rootElement.el_().scrollTop=scroll-this.offsetTop;this.scrollToIndex=undefined},function safeScroll(){if(!this.scrollToIndex)return;var page=Math.floor(this.scrollToIndex/this.pageSize);if(this.renderedPages_[page]){var el=document.querySelector(`[data-idx='${this.scrollToIndex}']`);if(!el)return;this.scrollView(el.offsetTop)}else{if(page==0&&this.currentTopPage_!=0){this.currentTopPage_=0;return}else if(page==this.numPages_-1&&this.currentTopPage_!=this.numPages_-this.NUM_PAGES_TO_RENDER){this.currentTopPage_=this.numPages_-this.NUM_PAGES_TO_RENDER;return}else if(page!=this.currentTopPage_+1){this.currentTopPage_=page-1;return}}},function clearPage(page,opt_skipObserver){!opt_skipObserver&&this.renderedPages_[page].childNodes?.forEach(e=>{if(e.el_())this.rowObserver.unobserve(e.el_())});this.renderedPages_[page].remove();delete this.renderedPages_[page]},function getPage(dao,page){var self=this;var proxy=this.ProxyDAO.create({delegate:dao});var sortParams=[];if(this.groupBy)sortParams.push(this.groupBy);if(this.order)sortParams.push(this.order);if(sortParams.length)proxy=proxy.orderBy(sortParams);this.loadingPages_[page]=true;promise=this.prepDAO(proxy,this.ctx);var e=this.E().attr("data-page",page);promise.then(values=>{if(foam.mlang.sink.Projection.isInstance(values)){for(var i=0;i<values.projection.length;i++){if(values.array[i]===undefined)continue;var index=page*this.pageSize+i+1;if(this.groupBy){var group=self.groupBy.f(values.array[i]);if(!foam.util.equals(group,self.currGroup_)||index==1){e.tag(self.groupHeaderView,{obj:values.array[i],projection:values.projection[i]})}self.currGroup_=group}var rowEl=this.E().tag(self.rowView,{obj:values.array[i],projection:values.projection[i]}).attr("data-idx",index);e.add(rowEl);rowEl.el().then(a=>{self.rowObserver.observe(a)})}}else if(foam.dao.DAO.isInstance(values)){}var isSet=false;if(self.renderedPages_[page]){console.warn("Trying to overwrite a loaded page without clearning....Clearing page");this.clearPage(page)}Object.keys(self.renderedPages_).forEach(j=>{if(j>page&&self.renderedPages_[j]&&!isSet){this.appendTo.insertBefore(e,self.renderedPages_[j]);isSet=true}});if(!isSet){this.appendTo.add(e);isSet=true}self.renderedPages_[page]=e;self.loadingPages_[page]=false;if(this.scrollToIndex&&Object.keys(this.renderedPages_).length==Math.min(this.NUM_PAGES_TO_RENDER,this.numPages_))self.safeScroll();this.dataLatch.resolve();if(this.displayedRowCount_<0)this.bottomRow=this.daoCount})}],listeners:[{name:"checkPageSize_",isFramed:true,code:function(){if(this.displayedRowCount_>this.pageSize){this.pageSize=this.displayedRowCount_;this.refresh()}}},{name:"refresh",isFramed:true,code:function(){this.currGroup_=undefined;this.rowObserver?.disconnect();Object.keys(this.renderedPages_).forEach(i=>{this.clearPage(i,true)});if(!this.isInit){this.currentTopPage_=0;this.topRow=0;this.bottomRow=0}this.isInit=false;this.updateRenderedPages_();if(this.topRow>1){this.scrollToIndex=this.topRow}}},{name:"updateCount",isFramed:true,code:function(){var limit=this.data&&this.data.limit_||undefined;return this.data$proxy.select(this.Count.create()).then(s=>{this.daoCount=limit&&limit<s.value?limit:s.value;this.refresh()})}},{name:"updateRenderedPages_",isMerged:true,mergeDelay:100,code:function(){Object.keys(this.renderedPages_).forEach(i=>{if(i>=this.currentTopPage_&&i<this.currentTopPage_+this.NUM_PAGES_TO_RENDER)return;this.clearPage(i)});for(var i=0;i<Math.min(this.numPages_,this.NUM_PAGES_TO_RENDER);i++){var page=this.currentTopPage_+i;if(this.renderedPages_[page]||this.loadingPages_[page])continue;var skip=page*this.pageSize;var dao=this.data.limit(this.pageSize).skip(skip);this.getPage(dao,page)}}},{name:"onRowIntersect",isFramed:true,code:function(entries,self){entries.forEach(entry=>{if(entry.intersectionRatio==0)return;var index=Number(entry.target.dataset.idx);if(entry.boundingClientRect.top<=entry.rootBounds.top){if(entry.boundingClientRect.top+entry.boundingClientRect.height/2<=entry.rootBounds.top)index+=1;self.topRow=index}else if(entry.boundingClientRect.bottom>=entry.rootBounds.bottom){if(entry.boundingClientRect.top+entry.boundingClientRect.height/2>=entry.rootBounds.bottom)index-=1;if(index>0)self.bottomRow=index}});if(!self.bottomRow&&self.displayedRowCount_<0)self.bottomRow=self.pageSize>entries.length?entries.length:self.pageSize}}],actions:[{name:"nextPage",toolTip:"Next Page",isEnabled:function(bottomRow,daoCount){return bottomRow!=daoCount},code:function(){var n=foam.Number.clamp(1,this.topRow+this.displayedRowCount_+1,this.daoCount);this.scrollToIndex=n}},{name:"lastPage",toolTip:"Last Page",isEnabled:function(bottomRow,daoCount){return bottomRow!=daoCount},code:function(){this.scrollToIndex=this.daoCount}},{name:"prevPage",toolTip:"Previous Page",isEnabled:function(topRow){return topRow>1},code:function(){var n=foam.Number.clamp(1,this.topRow-this.displayedRowCount_,this.daoCount);this.scrollToIndex=n}},{name:"firstPage",toolTip:"First Page",isEnabled:function(topRow){return topRow>1},code:function(){this.scrollToIndex=1}}]});
foam.CLASS({package:"foam.u2.view",name:"TableView",extends:"foam.u2.view.UnstyledTableView",css:`
^ {
overflow-x: unset;
height: 100%;
}
^tbody {
display: flow-root;
}
^tr {
background: /*%WHITE%*/ white;
display: flex;
height: 48px;
justify-content: space-between;
}
^tbody > ^tr:hover {
background: /*%GREY5%*/ #f5f7fa;
border-radius: 4px;
cursor: pointer;
}
^thead {
overflow: hidden;
position: sticky;
top: 0;
overflow-x: auto;
}
^thead > ^tr {
border-bottom: 2px solid /*%GREY4%*/ #DADDE2;
box-sizing: border-box;
border-radius: 4px 4px 0 0;
}
^td,
^th {
align-self: center;
box-sizing: border-box;
color: /*%BLACK%*/ #1e1f21;
display: block;
font-size: 1.4rem;
line-height: 1.5;
overflow: hidden;
padding-left: 16px;
text-align: left;
text-overflow: ellipsis;
white-space: nowrap;
min-width: 40px; /* So when the table's width decreases, columns aren't hidden completely */
}
^th:not(:last-child) > img {
margin-left: 8px;
}
^th:hover {
cursor: pointer;
}
/**
* OTHER
*/
^selected {
background: /*%PRIMARY5%*/ #e5f1fc;
}
^noselect {
-webkit-touch-callout: none;
-webkit-user-select: none;
-khtml-user-select: none;
-moz-user-select: none;
-ms-user-select: none;
user-select: none;
}
^ .disabled {
color: #aaa;
}
^td .foam-u2-ActionView {
padding: 4px 12px;
}
`});
foam.CLASS({package:"foam.u2.view",name:"EditColumnsView",extends:"foam.u2.View",requires:["foam.u2.DetailView","foam.u2.view.ColumnConfigPropView","foam.u2.view.SubColumnSelectConfig"],imports:["window"],css:`
^drop-down-bg {
font-size:        12px;
position:         fixed;
width:            100%;
height:           100%;
top:              0;
left:             0;
z-index:          100;
}
^ .foam-u2-ActionView-closeButton {
width: 24px;
height: 35px;
margin: 0;
cursor: pointer;
display: inline-block;
float: right;
outline: 0;
border: none;
background: transparent;
box-shadow: none;
padding-top: 15px;
margin-right: 15px;
}
^ .foam-u2-ActionView-closeButton:hover {
outline: none;
border: none;
background: transparent;
}
^container {
align-items: flex-start;
background-color: /*%WHITE%*/ #f9f9f9;
border-radius: 5px;
border: 1px solid /*%GREY4%*/ #e7eaec;
box-shadow: 0px 10px 15px rgba(0, 0, 0, 0.1), 0px 4px 6px rgba(0, 0, 0, 0.05);
display: flex;
flex-direction: column;
max-width: clamp(300px, 20vw, 600px);
padding: 16px 8px;
position: fixed;
right: 60px;
top: 120px;
}
`,properties:[{name:"selectColumnsExpanded",class:"Boolean"},"parentId","columnConfigPropView","height"],methods:[function closeDropDown(e){e.stopPropagation();this.columnConfigPropView.onClose();this.selectColumnsExpanded=!this.selectColumnsExpanded},function render(){this.SUPER();var self=this;this.window.addEventListener("resize",this.resize);this.resize();this.start().addClass(this.myClass()).show(this.selectColumnsExpanded$).addClass(this.myClass("drop-down-bg")).start({class:"foam.u2.view.ColumnConfigPropView",data:self.data},{},this.columnConfigPropView$).addClass(this.myClass("container")).style({"max-height":this.height$}).end().on("click",this.closeDropDown.bind(this)).end()}],listeners:[function resize(){this.height=this.window.innerHeight-200>0?this.window.innerHeight-200+"px":this.window.innerHeight+"px"}],actions:[{name:"closeButton",label:"",icon:"images/ic-cancelwhite.svg",code:function(X){this.columnConfigPropView.onClose();this.selectColumnsExpanded=!this.selectColumnsExpanded}}]});
foam.CLASS({package:"foam.u2.view",name:"ColumnConfigPropView",extends:"foam.u2.Controller",requires:["foam.u2.view.ColumnViewHeader","foam.u2.view.ColumnViewBody","foam.u2.view.RootColumnConfigPropView"],css:`
^ {
max-width: 200px;
overflow: auto;
}
^searchWrapper {
padding: 0px 8px;
display: flex;
flex-direction: column;
align-items: flex-end;
width: 100%;
}
^searchBar{
width: 100%
}
^ input[type='search']{
width: 100%;
}
^resetButton {
float: right;
background: none;
color: /*%PRIMARY3%*/ #406DEA;
}
^resetButton:hover:not(:disabled) {
text-decoration: underline;
color: /*%PRIMARY3%*/ #406DEA;
}
^resetButton:focus {
color: /*%PRIMARY3%*/ #406DEA;
}
^resetButton:disabled {
color: /*%GREY2%*/ #6B778C;
}
^colContainer {
overflow-x: hidden;
height: 100%;
flex: 1;
width: -webkit-fill-available;
width: -moz-fill-available;
}
`,properties:["data",{name:"columns",expression:function(data){return this.getColumns()}},{name:"views",expression:function(columns){var arr=[];for(var i=0;i<columns.length;i++){arr.push(this.RootColumnConfigPropView.create({index:i,prop:columns[i],onDragAndDropParentFunction:this.onTopLevelPropertiesDragAndDrop.bind(this),onSelectionChangedParentFunction:this.onTopPropertiesSelectionChange.bind(this),onGroupByChangedParentFunction:this.onTopPropertiesGroupByChange.bind(this),onDragAndDrop:this.onDragAndDrop.bind(this),onSelectionChanged:this.onSelectionChanged.bind(this),onGroupChanged:this.onGroupChanged.bind(this)}))}return arr}},{name:"updateSort",class:"Boolean"},{class:"String",name:"menuSearch",view:{class:"foam.u2.SearchField",onKey:true,autocomplete:false},value:"",postSet:function(){this.onMenuSearchUpdate()}},{name:"columnHandler",class:"FObjectProperty",of:"foam.nanos.column.CommonColumnHandler",factory:function(){return foam.nanos.column.CommonColumnHandler.create()}},{name:"groupByColumns",value:[]}],methods:[function render(){this.SUPER();var self=this;this.on("click",this.stopPropagation).start().start(this.MENU_SEARCH).addClass(this.myClass("searchBar")).end().addClass(this.myClass("searchWrapper")).start(self.RESET_COLUMNS,{buttonStyle:"LINK"}).addClass(this.myClass("resetButton")).end().end().add(this.slot(function(views){var i=0;return this.E().addClass(self.myClass("colContainer")).forEach(views,function(view){view.prop.index=i;this.start().add(view).end();i++})}));this.data.selectedColumnNames$.sub(this.rebuildSelectedColumns)},function stopPropagation(e){e.stopPropagation()},function onClose(){if(this.menuSearch)this.menuSearch="";this.columns.forEach(c=>c.onClose())},function onTopLevelPropertiesDragAndDrop(targetIndex,draggableIndex){this.onDragAndDrop(this.views,targetIndex,draggableIndex)},function onTopPropertiesSelectionChange(isColumnSelected,index,isColumnSelectionHaventChanged){if(!isColumnSelectionHaventChanged)this.onSelectionChanged(isColumnSelected,index,this.views);this.data.selectedColumnNames=this.rebuildSelectedColumns();this.data.updateColumns()},function onTopPropertiesGroupByChange(isColumnSelected,index,isColumnSelectionHaventChanged,isChild){if(!isColumnSelectionHaventChanged)this.onGroupChanged(isColumnSelected,index,this.views,isChild);this.data.updateColumns()},function onDragAndDrop(views,targetIndex,draggableIndex){this.resetProperties(views,targetIndex,draggableIndex);this.data.selectedColumnNames=this.rebuildSelectedColumns();this.data.updateColumns()},function resetProperties(views,targetIndex,draggableIndex){var thisProps=views.map(v=>v.prop);thisProps=[...thisProps];var replaceIndex;replaceIndex=targetIndex;if(draggableIndex<targetIndex){for(var i=draggableIndex;i<targetIndex;i++){thisProps[i+1].index=i;views[i].prop=thisProps[i+1]}}else{for(var i=targetIndex+1;i<=draggableIndex;i++){thisProps[i-1].index=i;views[i].prop=thisProps[i-1]}}thisProps[draggableIndex].index=replaceIndex;views[replaceIndex].prop=thisProps[draggableIndex]},function rebuildSelectedColumns(){var arr=[];if(!this.views)return;for(var i=0;i<this.views.length;i++){if(this.views[i].prop.isPropertySelected){var propSelectedTraversed=this.views[i].prop.returnSelectedProps();for(var j=0;j<propSelectedTraversed.length;j++){if(foam.Array.isInstance(propSelectedTraversed[j]))arr.push(propSelectedTraversed[j].filter(Boolean).join("."));else if(propSelectedTraversed[j])arr.push(propSelectedTraversed[j])}}}return arr},function onSelectionChanged(isColumnSelected,index,views){if(isColumnSelected){this.onSelect(index,views)}else if(!isColumnSelected){this.onUnSelect(index,views)}},function onGroupChanged(isColumnSelected,index,views,isChild){if(isColumnSelected){this.onSelectGroup(index,views,isChild)}else if(!isColumnSelected){this.onUnSelectGroup(index,views,isChild)}},function onSelect(draggableIndex,views){var startUnselectedIndex=views.find(v=>!v.prop.isPropertySelected);if(!startUnselectedIndex)return;startUnselectedIndex=startUnselectedIndex.index;if(draggableIndex>startUnselectedIndex)return this.resetProperties(views,startUnselectedIndex,draggableIndex)},function onSelectGroup(draggableIndex,views,isChild){var el=views[draggableIndex].prop;if(this.groupByColumns.length>0){this.groupByColumns.forEach(element=>{if(!isChild)element.isPropertyGrouped=false;if(!element.isPropertySelected)this.onUnSelect(element.index,views)});if(!isChild)this.groupByColumns=[]}var currEl=views.find(v=>v.prop.rootProperty==el.rootProperty);var tc=currEl.prop.rootProperty[0];if(!isChild){axiom=this.data.of.getAxiomByName(tc);this.data.groupBy=axiom}this.groupByColumns.push(currEl.prop);this.resetProperties(views,0,currEl.index)},function onUnSelect(draggableIndex,views){if(views[draggableIndex].prop.isPropertyGrouped)return;var startUnselectedIndex=views.find(v=>!v.prop.isPropertyGrouped&&!v.prop.isPropertySelected&&v.index!==draggableIndex);if(!startUnselectedIndex){return this.resetProperties(views,views.length-1,draggableIndex)}startUnselectedIndex=startUnselectedIndex.index;if(startUnselectedIndex-draggableIndex===1){var currentProp=this.columnHandler.checkIfArrayAndReturnRootPropertyHeader(views[draggableIndex].prop.rootProperty);var comparedToProp=this.columnHandler.checkIfArrayAndReturnRootPropertyHeader(views[startUnselectedIndex].prop.rootProperty);if(currentProp.toLowerCase().localeCompare(comparedToProp.toLowerCase())<1){return this.resetProperties(views,startUnselectedIndex-1,draggableIndex)}}while(startUnselectedIndex<views.length){var currentProp=this.columnHandler.checkIfArrayAndReturnRootPropertyHeader(views[draggableIndex].prop.rootProperty);var comparedToProp=this.columnHandler.checkIfArrayAndReturnRootPropertyHeader(views[startUnselectedIndex].prop.rootProperty);if(currentProp.toLowerCase().localeCompare(comparedToProp.toLowerCase())<0){break}startUnselectedIndex++}return this.resetProperties(views,startUnselectedIndex-1,draggableIndex)},function onUnSelectGroup(draggableIndex,views,isChild){this.data.groupBy=undefined;this.groupByColumns=[];if(!views[draggableIndex].prop.isPropertySelected)this.onUnSelect(draggableIndex,views)},function getColumns(){var data=this.data;var arr=[];var notSelectedColumns=[];data.selectedColumnNames=data.selectedColumnNames.map(c=>{return this.columnHandler.propertyNamesForColumnArray(c)});var tableColumns=this.data.columns;tableColumns=tableColumns.filter(c=>data.allColumns.includes(this.columnHandler.propertyNamesForColumnArray(c))).map(c=>this.columnHandler.propertyNamesForColumnArray(c));var topLevelProps=[];var columnThatShouldBeDeleted=[];for(var i=0;i<data.selectedColumnNames.length;i++){var rootProperty;if(foam.String.isInstance(data.selectedColumnNames[i])){var axiom;if(data.selectedColumnNames[i].includes("."))axiom=data.of.getAxiomByName(data.selectedColumnNames[i].split(".")[0]);else{axiom=tableColumns.find(c=>c.name===data.selectedColumnNames[i]);if(!axiom)axiom=data.of.getAxiomByName(data.selectedColumnNames[i])}if(!axiom||foam.dao.DAOProperty.isInstance(axiom)){continue}rootProperty=[axiom.name,this.columnHandler.returnAxiomHeader(axiom)]}else{rootProperty=data.selectedColumnNames[i]}var rootPropertyName=this.columnHandler.propertyNamesForColumnArray(rootProperty);if(!topLevelProps.includes(rootPropertyName)){arr.push(foam.u2.view.SubColumnSelectConfig.create({index:i,rootProperty:rootProperty,level:0,of:data.of,selectedColumns$:data.selectedColumnNames$},this));topLevelProps.push(rootPropertyName)}}for(var colToDelete of columnThatShouldBeDeleted){data.selectedColumnNames.splice(data.selectedColumnNames.indexOf(colToDelete),1)}var notSelectedColumns=data.allColumns.filter(c=>{return!topLevelProps.includes(c)});tableColumns=tableColumns.filter(c=>!topLevelProps.includes(c));for(var i=0;i<tableColumns.length;i++){var indexOfTableColumn=notSelectedColumns.indexOf(tableColumns[i]);if(indexOfTableColumn===-1){notSelectedColumns.push(tableColumns[i])}else{notSelectedColumns.splice(indexOfTableColumn,1,tableColumns[i])}}var nonSelectedViewModels=[];for(i=0;i<notSelectedColumns.length;i++){var rootProperty;if(this.columnHandler.canColumnBeTreatedAsAnAxiom(notSelectedColumns[i])){rootProperty=notSelectedColumns[i]}else{var axiom=tableColumns.find(c=>c.name===notSelectedColumns[i]);axiom=axiom||data.of.getAxiomByName(notSelectedColumns[i]);if(foam.dao.DAOProperty.isInstance(axiom)){continue}rootProperty=[axiom.name,this.columnHandler.returnAxiomHeader(axiom)]}nonSelectedViewModels.push(foam.u2.view.SubColumnSelectConfig.create({index:data.selectedColumnNames.length+i,rootProperty:rootProperty,level:0,of:data.of,selectedColumns$:data.selectedColumnNames$},this))}nonSelectedViewModels.sort((a,b)=>{var aName=this.columnHandler.checkIfArrayAndReturnRootPropertyHeader(a.rootProperty);var bName=this.columnHandler.checkIfArrayAndReturnRootPropertyHeader(b.rootProperty);return aName.toLowerCase().localeCompare(bName.toLowerCase())});arr=arr.concat(nonSelectedViewModels);return arr}],listeners:[{name:"onMenuSearchUpdate",isMerged:true,mergeDelay:500,code:function(){var query=this.menuSearch.trim().toLowerCase();for(var i=0;i<this.columns.length;i++){this.columns[i].updateOnSearch(query)}}}],actions:[{name:"resetColumns",label:"Reset Columns",code:function(){localStorage.removeItem(this.data.of.id);this.data.selectedColumnNames=undefined;this.data.resetColWidths();this.data.updateColumns();this.columns=this.getColumns();if(this.groupByColumns){this.groupByColumns.forEach(element=>element.isPropertyGrouped=false);this.groupByColumns=[];this.data.groupBy=undefined}}}]});
foam.CLASS({package:"foam.u2.view",name:"RootColumnConfigPropView",extends:"foam.u2.Controller",imports:["theme"],properties:[{class:"foam.u2.ViewSpec",name:"head",value:{class:"foam.u2.view.ColumnViewHeader"}},{class:"foam.u2.ViewSpec",name:"body",value:{class:"foam.u2.view.ColumnViewBody"}},{name:"prop"},"index",{name:"onDragAndDropParentFunction",},{name:"onSelectionChangedParentFunction",},{name:"onGroupByChangedParentFunction",},{name:"onDragAndDrop",},{name:"onSelectionChanged",},{name:"onGroupChanged",}],constants:[{name:"ON_DRAG_OVER_BG_COLOR",type:"String",value:"#e5f1fc"}],methods:[function render(){var self=this;this.SUPER();this.add(self.slot(function(prop){return self.E().attrs({draggable:prop.isPropertySelected$?"true":"false"}).callIf(prop.isPropertySelected$,function(){this.on("dragstart",self.onDragStart.bind(self)).on("dragenter",self.onDragOver.bind(self)).on("dragover",self.onDragOver.bind(self)).on("dragleave",self.onDragLeave.bind(self)).on("drop",self.onDrop.bind(self))}).style({cursor:prop.isPropertySelected$?"pointer":"default"}).show(self.prop.showOnSearch$).start().add(foam.u2.ViewSpec.createView(self.head,{data$:self.prop$,onSelectionChangedParentFunction:self.onSelectionChangedParentFunction,onGroupByChangedParentFunction:self.onGroupByChangedParentFunction},self,self.__subSubContext__)).end().start().add(foam.u2.ViewSpec.createView(self.body,{data$:self.prop$,onSelectionChangedParentFunction:this.onSelectionChangedParentFunction,onGroupByChangedParentFunction:this.onGroupByChangedParentFunction,onDragAndDrop:this.onDragAndDrop,onSelectionChanged:this.onSelectionChanged,onGroupChanged:this.onGroupChanged},self,self.__subSubContext__)).end()}))}],listeners:[function onDragStart(e){e.dataTransfer.setData("draggableId",this.index);e.stopPropagation()},function onDragOver(e){e.preventDefault();e.stopPropagation();e.currentTarget.style.setProperty("background-color",this.theme?this.theme.primary5:this.ON_DRAG_OVER_BG_COLOR)},function onDragLeave(e){e.preventDefault();e.stopPropagation();e.currentTarget.style.setProperty("background-color",this.theme?this.theme.white:"#ffffff")},function onDrop(e){e.preventDefault();e.stopPropagation();e.currentTarget.style.setProperty("background-color",this.theme?this.theme.white:"#ffffff");this.onDragAndDropParentFunction(this.index,parseInt(e.dataTransfer.getData("draggableId")))}]});
foam.CLASS({package:"foam.u2.view",name:"ColumnViewHeader",extends:"foam.u2.View",imports:["theme"],requires:["foam.u2.CheckBox","foam.u2.tag.Image"],css:`
^selected {
background: #cfdbff;
}
^some-padding {
text-align: left;
font-size: 1.4rem;
line-height: 24px;
padding: 4px 16px;
display: flex;
align-items: center;
justify-content: space-between;
}
^some-padding:hover {
background-color: /*%PRIMARY5%*/ #E5F1FC;
border-radius: 4px;
}
^label {
display: flex;
align-items: center;
justify-content: start;
width: 100%;
}
^selection-buttons + ^selection-buttons {
padding: 8px;
}
^labelText {
flex: 1;
overflow: hidden;
padding-left: 8px;
text-overflow: ellipsis;
white-space: nowrap;
}
`,properties:["onSelectionChangedParentFunction","onGroupByChangedParentFunction",{name:"columnHandler",class:"FObjectProperty",of:"foam.nanos.column.CommonColumnHandler",factory:function(){return foam.nanos.column.CommonColumnHandler.create()}}],methods:[function render(){var self=this;this.SUPER();this.on("click",this.toggleExpanded).start().addClass(this.myClass("some-padding")).style({"padding-left":self.data.level*16+8+"px","padding-right":"8px"}).start().addClass(this.myClass("label")).start().addClass(this.myClass("selection-buttons")).add(this.CheckBox.create({data$:this.data.isPropertySelected$})).on("click",this.toggleSelection).end().start().addClass(this.myClass("selection-buttons")).call(function(){if(self.data.level>1)return;if(self.theme){this.add(self.slot(function(data$isPropertyGrouped){var image;if(self.data.isPropertyGrouped){image=self.theme.glyphs.folderFill.getDataUrl({fill:self.theme.primary3})}else{image=self.theme.glyphs.folderOutline.getDataUrl({fill:self.theme.grey2})}return this.E().start(self.Image,{data:image,displayHeight:"1.5em",displayWidth:"1.5em"}).end()}))}else{this.start().add(self.CheckBox.create({data$:self.data.isPropertyGrouped$})).end()}}).on("click",this.toggleGroup).end().start().addClass(self.myClass("labelText")).add(this.columnHandler.checkIfArrayAndReturnRootPropertyHeader(this.data.rootProperty)).end().end().start().show(this.data.hasSubProperties).style({"vertical-align":"middle","font-weight":"bold",visibility:"visible","font-size":"16px",float:"right",transform:this.data.expanded$.map(function(c){return c?"rotate(180deg)":"rotate(90deg)"})}).on("click",this.toggleExpanded).add("⌃").end().end()}],listeners:[function toggleSelection(e){e.stopPropagation();if(!this.data.hasSubProperties||foam.core.Reference.isInstance(this.data.prop)||foam.core.FObjectProperty.isInstance(this.data.prop)){if(!this.data.isPropertySelected)this.data.expanded=false;this.onSelectionChangedParentFunction(this.data.isPropertySelected,this.data.index)}},function toggleGroup(e){e.stopPropagation();if(this.theme){this.data.isPropertyGrouped=!this.data.isPropertyGrouped}if(!this.data.hasSubProperties||foam.core.Reference.isInstance(this.data.prop)||foam.core.FObjectProperty.isInstance(this.data.prop)){if(!this.data.isPropertyGrouped)this.data.expanded=false;this.onGroupByChangedParentFunction(this.data.isPropertyGrouped,this.data.index)}},function toggleExpanded(e){e.stopPropagation();if(this.data.hasSubProperties)this.data.expanded=!this.data.expanded}]});
foam.CLASS({package:"foam.u2.view",name:"ColumnViewBody",extends:"foam.u2.View",requires:["foam.u2.view.RootColumnConfigPropView"],properties:[{name:"views",expression:function(data$subColumnSelectConfig){var arr=[];for(var i=0;i<this.data.subColumnSelectConfig.length;i++){arr.push(this.RootColumnConfigPropView.create({index:i,prop:this.data.subColumnSelectConfig[i],onDragAndDrop:this.onDragAndDrop,onSelectionChanged:this.onSelectionChanged,onGroupChanged:this.onGroupChanged,onSelectionChangedParentFunction:this.onChildrenSelectionChanged.bind(this),onGroupByChangedParentFunction:this.onChildrenGroupByChanged.bind(this),onDragAndDropParentFunction:this.onChildrenDragAndDrop.bind(this)}))}return arr}},"onSelectionChangedParentFunction","onGroupByChangedParentFunction",{name:"onDragAndDrop",},{name:"onSelectionChanged",},{name:"onGroupChanged",}],methods:[function render(){this.SUPER();var self=this;this.start().show(self.data.expanded$).forEach(this.views$,function(v){return this.show(self.data.expanded$).add(v)}).end()},function updateSubColumnsOrder(selectionChanged){this.data.subColumnSelectConfig.sort((a,b)=>a.index>b.index?1:-1);this.onSelectionChangedParentFunction(this.data.isPropertySelected,this.data.index,selectionChanged);this.onGroupByChangedParentFunction(this.data.isPropertyGrouped,this.data.index,selectionChanged,true)},function onChildrenDragAndDrop(targetIndex,draggableIndex){this.onDragAndDrop(this.views,targetIndex,draggableIndex);this.updateSubColumnsOrder(true)},function onChildrenSelectionChanged(isColumnSelected,index,isColumnSelectionHaventChanged){if(!isColumnSelectionHaventChanged||foam.core.Reference.isInstance(this.data.prop)||foam.core.FObjectProperty.isInstance(this.data.prop)){this.onSelectionChanged(isColumnSelected,index,this.views);var hasPropertySelectionChanged=this.data.isPropertySelected;if(this.data.isPropertySelected!==isColumnSelected){var anySelected=this.data.subColumnSelectConfig.find(s=>s.isPropertySelected);if(foam.core.Reference.isInstance(this.data.prop)||foam.core.FObjectProperty.isInstance(this.data.prop)){this.data.isPropertySelected=typeof anySelected!=="undefined";if(!this.data.isPropertySelected)this.data.expanded=false}}this.updateSubColumnsOrder(hasPropertySelectionChanged===this.data.isPropertySelected)}else{this.updateSubColumnsOrder(true)}},function onChildrenGroupByChanged(isColumnSelected,index,isColumnSelectionHaventChanged){if(!isColumnSelectionHaventChanged||foam.core.Reference.isInstance(this.data.prop)||foam.core.FObjectProperty.isInstance(this.data.prop)){this.onGroupChanged(isColumnSelected,index,this.views);var hasPropertySelectionChanged=this.data.isPropertyGrouped;if(this.data.isPropertyGrouped!==isColumnSelected){var anySelected=this.data.subColumnSelectConfig.find(s=>s.isPropertyGrouped);if(foam.core.Reference.isInstance(this.data.prop)||foam.core.FObjectProperty.isInstance(this.data.prop)){this.data.isPropertyGrouped=typeof anySelected!=="undefined";if(!this.data.isPropertyGrouped)this.data.expanded=false}}this.updateSubColumnsOrder(hasPropertySelectionChanged===this.data.isPropertyGrouped)}else{this.updateSubColumnsOrder(true)}}]});
foam.CLASS({package:"foam.u2.view",name:"SubColumnSelectConfig",extends:"foam.u2.View",properties:["index","of",{name:"hasSubProperties",class:"Boolean",expression:function(subProperties){if(subProperties.length===0)return false;return true}},{name:"selectedColumns",},{name:"prop",expression:function(rootProperty){return this.of.getAxiomByName(this.columnHandler.checkIfArrayAndReturnPropertyNameForRootProperty(rootProperty))||{}}},{name:"subProperties",expression:function(prop){if(!this.of||!this.of.getAxiomByName)return[];if(prop&&prop.cls_&&(foam.core.FObjectProperty.isInstance(prop)||foam.core.Reference.isInstance(prop)))return prop.of.getAxiomsByClass(foam.core.Property).map(p=>{if(!foam.dao.DAOProperty.isInstance(p))return[p.name,this.columnHandler.returnAxiomHeader(p)]}).filter(e=>e!=undefined);return[]}},{name:"subColumnSelectConfig",expression:function(subProperties,level,expanded){return this.returnSubColumnSelectConfig(subProperties,level,expanded)}},{name:"rootProperty"},{name:"isPropertySelected",class:"Boolean",factory:function(){var thisPropName=this.columnHandler.checkIfArrayAndReturnPropertyNameForRootProperty(this.rootProperty);return typeof this.selectedColumns.find(s=>{var propName=foam.String.isInstance(s)?s.split("."):s.name;return foam.Array.isInstance(propName)?this.level<propName.length&&propName[this.level]===thisPropName:thisPropName===propName})!=="undefined"}},{name:"isPropertyGrouped",class:"Boolean"},{name:"level",class:"Int"},{name:"parentExpanded",class:"Boolean",value:false,postSet:function(_,n){if(!n)this.expanded=false}},{name:"expanded",class:"Boolean"},{name:"showOnSearch",class:"Boolean",value:true},{name:"columnHandler",class:"FObjectProperty",of:"foam.nanos.column.CommonColumnHandler",factory:function(){return foam.nanos.column.CommonColumnHandler.create()}}],methods:[function onClose(){this.subColumnSelectConfig.forEach(c=>c.onClose());this.expanded=false},function returnSelectedProps(){if(this.hasSubProperties){var arr=[];for(var i=0;i<this.subColumnSelectConfig.length;i++){if(this.subColumnSelectConfig[i].isPropertySelected){var childProps=this.subColumnSelectConfig[i].returnSelectedProps();if(!childProps.length){arr.push(this.rootProperty[0])}else{for(var j=0;j<childProps.length;j++){arr.push([this.rootProperty[0],childProps[j]].filter(Boolean).join("."))}}}}if(arr&&arr.length>0)return arr}if(this.level===0){if(foam.Array.isInstance(this.rootProperty))return[this.rootProperty[0]];return[this.rootProperty]}return[this.rootProperty[0]]},function updateOnSearch(query){this.showOnSearch=false;this.expanded=false;if(query.length==0){this.showOnSearch=true;this.expanded=false;return this.showOnSearch}this.showOnSearch=foam.Array.isInstance(this.rootProperty)?this.rootProperty[1].toLowerCase().includes(query):this.rootProperty.name.toLowerCase().includes(query);if(this.hasSubProperties&&this.level<2){this.expanded=false;if(this.subColumnSelectConfig.length==0)this.subColumnSelectConfig=this.returnSubColumnSelectConfig(this.subProperties,this.level,this.expanded,true);for(var i=0;i<this.subColumnSelectConfig.length;i++){if(this.subColumnSelectConfig[i].updateOnSearch(query)){this.expanded=true;this.showOnSearch=true}}}return this.showOnSearch},function returnSubColumnSelectConfig(subProperties,level,expanded,ignoreExpanded){var arr=[];if(!this.of||!this.of.getAxiomByName||subProperties.length===0||!ignoreExpanded&&!expanded)return arr;var l=level+1;var r=this.of.getAxiomByName(this.rootProperty[0]);if(!r)return arr;var selectedSubProperties=[];var otherSubProperties=[];var thisRootPropName=this.columnHandler.checkIfArrayAndReturnPropertyNameForRootProperty(this.rootProperty);var selectedColumn=this.selectedColumns.filter(c=>{var thisSelectedColumn=foam.String.isInstance(c)?c:c.name;return!foam.String.isInstance(c)&&this.level===0&&thisSelectedColumn===thisRootPropName||foam.String.isInstance(c)&&c.split(".").length>=this.level&&c.split(".")[this.level]===this.rootProperty[0]});if(selectedColumn.find(c=>foam.String.isInstance(c)&&c.split(".").length==this.level+1)){selectedSubProperties.push(["","To Summary"])}else{otherSubProperties.push(["","To Summary"])}for(var i=0;i<subProperties.length;i++){if(selectedColumn.find(c=>foam.String.isInstance(c)&&c.split(".").length>this.level+1&&c.split(".")[this.level+1]===subProperties[i][0])){selectedSubProperties.push(subProperties[i])}else{otherSubProperties.push(subProperties[i])}}otherSubProperties.sort((a,b)=>{return a[1].toLowerCase().localeCompare(b[1].toLowerCase())});for(var i=0;i<selectedSubProperties.length;i++){arr.push(this.cls_.create({index:i,rootProperty:selectedSubProperties[i],selectedColumns$:this.selectedColumns$,level:l,parentExpanded$:this.expanded$,of:r.of,isPropertySelected:true,isPropertyGrouped:false}))}for(var i=0;i<otherSubProperties.length;i++){arr.push(this.cls_.create({index:selectedSubProperties.length+i,rootProperty:otherSubProperties[i],selectedColumns$:this.selectedColumns$,level:l,parentExpanded$:this.expanded$,of:r.of,isPropertySelected:false,isPropertyGrouped:false},this))}return arr}]});
foam.CLASS({package:"foam.u2.view",name:"ScrollTableView",extends:"foam.u2.Element",imports:["getElementById","memento?","stack"],exports:["as summaryView","dblclick as click","dblclick","currentMemento_ as memento"],requires:["foam.core.Lock","foam.dao.FnSink","foam.mlang.sink.Count","foam.u2.layout.Cols","foam.u2.layout.Rows","foam.u2.ReadWriteView","foam.u2.stack.StackBlock","foam.u2.view.TableView","foam.comics.v2.DAOControllerConfig","foam.nanos.controller.Memento"],css:`
^{
border-radius: 4px;
position: relative;
}
^full-height{
height: 100%;
}
^table-wrapper {
flex: 1;
max-height: 100%;
overflow: auto;
scroll-behavior: smooth;
overscroll-behavior: contain;
}
^table {
position: relative;
}
^table  .foam-u2-view-TableView-thead {
z-index: 1;
overflow: visible;
}
^scrolled .foam-u2-view-TableView-thead {
box-shadow: 0 1.5px 4px /*%GREY4%*/ #DADDE2;
}
^nav{
align-items: center;
background: /*%WHITE%*/ white;
border-radius: 0 0 4px 4px;
border-top: 1px solid /*%GREY4%*/ #DADDE2;
box-sizing: border-box;
gap: 8px;
justify-content: flex-end;
max-height: 56px;
padding: 16px 24px;
width: 100%;
}
^buttons svg{
width: 1em;
height: 1em;
}
^counters > *:focus {
border: 0px;
border-radius: 0px;
padding: 0px;
height: auto;
border-bottom: 2px solid /*%PRIMARY3%*/ #406DEA;
}
^counters:hover {
cursor: pointer;
}
`,constants:[{type:"Float",name:"MIN_TOP_PAGE_PROGRESS",value:.5},{type:"Integer",name:"NUM_PAGES_TO_RENDER",value:3},{type:"Integer",name:"TABLE_HEAD_HEIGHT",value:48}],properties:[{class:"foam.dao.DAOProperty",name:"data"},"columns",{class:"FObjectArray",of:"foam.core.Action",name:"contextMenuActions"},{class:"Int",name:"daoCount"},"selection","disableUserSelection",{class:"Boolean",name:"editColumnsEnabled",value:true},{class:"Int",name:"rowHeight",value:48},{name:"table_",},{type:"Int",name:"scrollHeight",expression:function(daoCount,rowHeight){return rowHeight*daoCount+this.TABLE_HEAD_HEIGHT}},{type:"Int",name:"pageSize",value:30,},{class:"Boolean",name:"multiSelectEnabled",},{class:"Map",name:"selectedObjects",},{class:"Int",name:"scrollPos_"},{class:"Int",name:"numPages_",expression:function(daoCount,pageSize){return Math.ceil(daoCount/pageSize)}},{class:"Int",name:"currentTopPage_",expression:function(numPages_,scrollPos_,scrollHeight){var scrollPercent=scrollPos_/scrollHeight;var topPage=Math.floor(scrollPercent*numPages_);var topPageProgress=scrollPercent*numPages_%1;if(topPageProgress<this.MIN_TOP_PAGE_PROGRESS)topPage=topPage-1;return Math.min(Math.max(0,numPages_-this.NUM_PAGES_TO_RENDER),Math.max(0,topPage))}},{class:"Map",name:"renderedPages_"},{class:"Map",name:"renderedPageSlots_"},{class:"FObjectProperty",of:"foam.comics.v2.DAOControllerConfig",name:"config",factory:function(){return this.DAOControllerConfig.create({dao:this.data})}},{name:"dblClickListenerAction",factory:function(){return function(obj,id,title){if(!this.stack||this.isDetached())return;this.stack.push(this.StackBlock.create({view:{class:"foam.comics.v2.DAOSummaryView",data:obj,config:this.config,idOfRecord:id},parent:this.__subContext__.createSubContext({memento:this.table_.memento?.tail})}))}}},"currentMemento_",{class:"Boolean",name:"isInit"},"tableWrapper_",{class:"Boolean",name:"showPagination",value:true},{class:"Int",name:"topRow_",preSet:function(o,n){this.scrollTable(this.scrollPos_+Math.round((n-o)*this.rowHeight))},expression:function(scrollPos_,rowHeight,daoCount,displayedRowCount_){var possibleMax=daoCount>displayedRowCount_?daoCount-displayedRowCount_+1:daoCount;return foam.Number.clamp(daoCount?1:0,Math.round(scrollPos_/rowHeight)+1,possibleMax)}},{class:"Int",name:"lastDisplayedEl_",preSet:function(o,n){this.scrollTable(this.scrollPos_+(n-o)*this.rowHeight)},expression:function(displayedRowCount_,topRow_,daoCount){var possibleMin=daoCount>displayedRowCount_?displayedRowCount_:daoCount;return foam.Number.clamp(possibleMin,topRow_+displayedRowCount_-1,daoCount)}},{class:"Float",name:"displayedRowCount_",},{name:"lock",class:"FObjectProperty",of:"foam.core.Lock",factory:function(){return this.Lock.create()}}],reactions:[["","propertyChange.currentTopPage_","updateRenderedPages_"]],methods:[function init(){this.onDetach(this.data$proxy.listen(this.FnSink.create({fn:this.updateCount})));this.onDetach(this.table_$.sub(this.refresh));this.onDetach(this.table_$.dot("data").sub(this.refresh));this.onDetach(this.table_$.dot("updateValues").sub(this.refresh));this.onDetach(this.table_$.dot("order").sub(this.refresh));this.updateCount()},function render(){var self=this;if(this.memento){var m=this.memento;for(var i=0;i<2;i++){if(!m){m=foam.nanos.controller.Memento.create({value:"",parent:this.memento});this.memento.tail=m}else{if(!m.tail)m.tail=foam.nanos.controller.Memento.create({value:"",parent:m});m=m.tail}}this.currentMemento_=this.memento.tail}this.table_=foam.u2.ViewSpec.createView(this.TableView,{data:foam.dao.NullDAO.create({of:this.data.of}),refDAO:this.data,columns:this.columns,contextMenuActions:this.contextMenuActions,selection$:this.selection$,editColumnsEnabled:this.editColumnsEnabled,disableUserSelection:this.disableUserSelection,multiSelectEnabled:this.multiSelectEnabled,selectedObjects$:this.selectedObjects$},this,this.__subSubContext__.createSubContext({memento:this.currentMemento_&&this.currentMemento_.tail}));if(!this.table_.memento||!this.table_.memento.tail||this.table_.memento.tail.head.length==0){var buttonStyle={label:"",buttonStyle:"TERTIARY",size:"SMALL"};this.start(this.Rows).addClass(this.myClass()).enableClass(this.myClass("full-height"),this.showPagination$).start("div",{},this.tableWrapper_$).call(()=>{this.updateRowCount()}).addClass(this.myClass("table-wrapper")).on("scroll",this.onScroll).start().add(this.table_).enableClass(this.myClass("scrolled"),this.scrollPos_$).addClass(this.myClass("table")).style({height:this.scrollHeight$.map(h=>h+"px")}).end().end().add(this.slot(showPagination=>{return showPagination?this.E().start(self.Cols).addClass(self.myClass("nav")).style({"justify-content":"flex-end"}).startContext({data:self}).start(self.Cols).style({gap:"4px","box-sizing":"border-box"}).start(this.ReadWriteView,{data$:self.topRow_$}).addClass(this.myClass("counters")).end().add("-").start(this.ReadWriteView,{data$:self.lastDisplayedEl_$}).addClass(this.myClass("counters")).end().start().addClass(self.myClass("separator")).add("of").end().add(self.daoCount$).end().start(self.FIRST_PAGE,{...buttonStyle,themeIcon:"first"}).addClass(self.myClass("buttons")).end().start(self.PREV_PAGE,{...buttonStyle,themeIcon:"back"}).addClass(self.myClass("buttons")).end().start(self.NEXT_PAGE,{...buttonStyle,themeIcon:"next"}).addClass(self.myClass("buttons")).end().start(self.LAST_PAGE,{...buttonStyle,themeIcon:"last"}).addClass(self.myClass("buttons")).end().endContext().end():this.E()})).end();var resize=new ResizeObserver(self.updateRowCount);this.tableWrapper_.sub("onload",()=>{resize.observe(self.tableWrapper_.el_())});this.onDetach(resize.disconnect())}else if(this.table_.memento.tail.head.length!=0){if(this.table_.memento.tail.head=="create"){this.stack.push(this.StackBlock.create({view:{class:"foam.comics.v2.DAOCreateView",data:(this.config.factory||this.data.of).create({mode:"create"},this),config$:this.config$,of:this.data.of},parent:this.__subContext__.createSubContext({memento:this.table_.memento})}))}else if(this.table_.memento.tail.tail&&this.table_.memento.tail.tail.head){var id=this.table_.memento.tail.tail.head;if(!foam.core.MultiPartID.isInstance(this.data.of.ID)){id=this.data.of.ID.fromString(id)}else{id=this.data.of.ID.of.create();mementoHead="{"+this.table_.memento.tail.tail.head.replaceAll("=",":")+"}";var idFromJSON=foam.json.parseString(mementoHead);for(var key in idFromJSON){var axiom=this.data.of.getAxiomByName(key);if(axiom)axiom.set(id,idFromJSON[key])}}this.config.dao.inX(ctrl.__subContext__).find(id).then(v=>{if(!v)return;if(self.state!=self.LOADED)return;this.stack.push(this.StackBlock.create({view:{class:"foam.comics.v2.DAOSummaryView",data:null,config:this.config,idOfRecord:id},parent:this.__subContext__.createSubContext({memento:this.table_.memento.tail})}))})}}},function scrollTable(scroll){if(this.childNodes&&this.childNodes.length>0)this.getElementById(this.tableWrapper_.id).scrollTop=scroll}],listeners:[{name:"reconnectPages",code:function(){Object.keys(this.renderedPageSlots_).forEach(page=>{this.renderedPages_[page]=this.table_.slotE_(this.renderedPageSlots_[page])})}},{name:"refresh",isFramed:true,code:async function(){this.reconnectPages();Object.keys(this.renderedPages_).forEach(i=>{this.renderedPages_[i].remove();this.renderedPageSlots_[i].detach();delete this.renderedPageSlots_[i];delete this.renderedPages_[i]});this.updateRenderedPages_();var el=await this.el();if(!this.isInit&&this.currentMemento_&&this.currentMemento_.head.length!=0){var scroll=this.currentMemento_.head*this.rowHeight;scroll=scroll>=this.rowHeight&&scroll<this.scrollHeight?scroll:0;this.scrollTable(scroll);this.isInit=true}else{el.scrollTop=0}}},{name:"updateCount",isFramed:true,code:function(){var limit=this.data&&this.data.limit_||undefined;return this.lock.then(()=>{return new Promise(resolve=>{this.data$proxy.select(this.COUNT()).then(s=>{this.daoCount=limit&&limit<s.value?limit:s.value;this.refresh();resolve()})})})}},{name:"updateRenderedPages_",isFramed:true,code:function(){if(!this.table_)return;Object.keys(this.renderedPages_).forEach(i=>{if(i>=this.currentTopPage_&&i<this.currentTopPage_+this.NUM_PAGES_TO_RENDER)return;this.renderedPages_[i].remove();this.renderedPageSlots_[i].detach();delete this.renderedPageSlots_[i];delete this.renderedPages_[i]});for(var i=0;i<Math.min(this.numPages_,this.NUM_PAGES_TO_RENDER);i++){var page=this.currentTopPage_+i;if(this.renderedPages_[page])continue;var dao=this.data$proxy.limit(this.pageSize).skip(page*this.pageSize);this.renderedPageSlots_[page]=this.table_.rowsFrom(dao,this.TABLE_HEAD_HEIGHT+page*this.pageSize*this.rowHeight);var tbody=this.table_.slotE_(this.renderedPageSlots_[page]);this.table_.add(tbody);this.renderedPages_[page]=tbody}}},{name:"onScroll",isFramed:true,code:function(e){this.scrollPos_=e.target.scrollTop;if(this.currentMemento_){this.currentMemento_.head=this.scrollPos_>=this.rowHeight&&this.scrollPos_<this.scrollHeight?Math.floor(this.scrollPos_/this.rowHeight):0}}},function dblclick(obj,id,title){this.dblClickListenerAction(obj,id,title)},{name:"updateRowCount",isframed:true,code:function(){this.tableWrapper_.el().then(e=>{var displayHeight=e.getBoundingClientRect().height;this.displayedRowCount_=Math.round((displayHeight-this.TABLE_HEAD_HEIGHT)/this.rowHeight)})}}],actions:[{name:"nextPage",toolTip:"Next Page",isEnabled:function(lastDisplayedEl_,daoCount){return lastDisplayedEl_!=daoCount},code:function(){if(this.displayedRowCount_){var scroll=this.scrollPos_+this.displayedRowCount_*this.rowHeight;this.scrollTable(scroll)}}},{name:"lastPage",toolTip:"Last Page",isEnabled:function(lastDisplayedEl_,daoCount){return lastDisplayedEl_!=daoCount},code:function(){if(this.displayedRowCount_){this.scrollTable(this.scrollHeight)}}},{name:"prevPage",toolTip:"Previous Page",isEnabled:function(topRow_){return topRow_>1},code:function(){if(this.displayedRowCount_){var scroll=this.scrollPos_-this.displayedRowCount_*this.rowHeight;this.scrollTable(scroll)}}},{name:"firstPage",toolTip:"First Page",isEnabled:function(topRow_){return topRow_>1},code:function(){this.scrollTable(0)}}]});
foam.CLASS({package:"foam.u2.view",name:"EmbeddedTableView",extends:"foam.u2.View",mixins:["foam.u2.memento.Memorable"],requires:["foam.comics.v2.DAOBrowseControllerView","foam.comics.v2.DAOControllerConfig","foam.u2.borders.CardBorder","foam.u2.stack.StackBlock","foam.u2.view.ScrollTableView","foam.u2.table.TableView"],imports:["stack"],exports:["click","config"],css:`
^button{
max-height: 56px;
width: 100%;
}
^wrapper{
box-shadow: 0px 1px 2px rgba(0, 0, 0, 0.06), 0px 1px 3px rgba(0, 0, 0, 0.1);
padding: 0px;
}
`,messages:[{name:"VIEW_MORE",message:"View More"}],properties:[{class:"Int",name:"rowsToDisplay",value:2},{class:"foam.dao.DAOProperty",name:"data"},{class:"String",name:"route",memorable:true},{class:"FObjectProperty",of:"foam.comics.v2.DAOControllerConfig",name:"config",factory:function(){return this.DAOControllerConfig.create({dao:this.data})}},{name:"click",expression:function(config$click){var self=this;var importedClick;if(config$click&&typeof config$click==="function"){importedClick=config$click}else{importedClick=function(obj,id){if(!this.stack)return;this.stack.push(foam.u2.stack.StackBlock.create({view:{class:"foam.comics.v2.DAOSummaryView",data:obj,config:this.config||this.__subContext__.config,idOfRecord:id},parent:this.__subContext__.createSubContext({memento_:self.memento_})},this))}}return function(obj,id){self.route=self.data.of.name+"view";importedClick.call(this,obj,id)}}}],methods:[async function render(){this.config.editPredicate=foam.mlang.predicate.False.create();this.config.createPredicate=foam.mlang.predicate.False.create();this.config.deletePredicate=foam.mlang.predicate.False.create();if(this.route==this.data.of.name){this.openFullTable()}else if(this.route==this.data.of.name+"view"&&this.memento_.tailStr){this.click.call(this,null,null)}else{if(!this.memento_.tailStr)this.route="";var daoCount=await this.data.select(this.Count.create()).then(s=>{return s.value});this.start(this.CardBorder).addClass(this.myClass("wrapper")).startContext({memento_:this.Memento.create({memento_:null})}).start(this.TableView,{data:this.data.limit(this.rowsToDisplay),editColumnsEnabled:false,multiSelectEnabled:false,showPagination:false}).addClass(this.myClass()).end().endContext().startContext({data:this}).start(this.OPEN_TABLE,{label:`${this.VIEW_MORE} (${daoCount})`,buttonStyle:"TERTIARY",themeIcon:"plus"}).addClass(this.myClass("button")).end().endContext().end()}},function openFullTable(){this.route=this.data.of.name;this.stack.push(this.StackBlock.create({view:{class:this.DAOBrowseControllerView,data$:this.data$,config$:this.config$},parent:this.__subContext__.createSubContext({controllerMode:"CREATE"})}))}],actions:[{name:"openTable",code:function(){this.openFullTable()}}]});
foam.CLASS({package:"foam.u2.view",name:"BlobView",extends:"foam.u2.Element",requires:["foam.blob.BlobBlob"],imports:["blobService"],properties:[["nodeName","span"],"data",{class:"String",name:"filename"},{class:"String",name:"type"},{class:"DateTime",name:"timestamp"}],methods:[function render(){var view=this;this.start("input").attrs({type:"file"}).on("change",this.onChange).end().add(this.slot(function(data){var url=data&&view.blobService.urlFor(data);return!url?this.E("span"):this.E("a").attrs({href:url}).add("Download")},this.data$))}],listeners:[function onChange(e){var file=e.target.files[0];this.data=this.BlobBlob.create({blob:file});this.filename=file.name;this.timestamp=new Date(file.lastModified);this.type=file.type}]});
foam.CLASS({package:"foam.u2.view",name:"FileView",extends:"foam.u2.Element",requires:["foam.blob.BlobBlob","foam.nanos.fs.File"],properties:[["nodeName","span"],"data"],methods:[function render(){this.start("input").attrs({type:"file"}).on("change",this.onChange).end().add(this.slot(function(data){return!data?this.E("span"):this.E("a").attrs({href:data.data&&data.data.blob?URL.createObjectURL(data.data.blob):data.address,target:"_blank",download:true}).add("Download")},this.data$))}],listeners:[function onChange(e){var file=e.target.files[0];this.data=this.File.create({filename:file.name,filesize:file.size,mimeType:file.mimeType,data:this.BlobBlob.create({blob:file})})}]});
foam.CLASS({package:"foam.u2.view",name:"ImageBlobView",extends:"foam.u2.View",requires:["foam.blob.BlobBlob"],imports:["blobService"],properties:["data"],methods:[function render(){var view=this;this.start("img").attrs({src:this.data$.map(function(data){return view.BlobBlob.isInstance(data)?URL.createObjectURL(data.blob):view.blobService.urlFor(data)||""})}).end().add(this.slot(function(mode){if(mode==foam.u2.DisplayMode.RW){return this.E("input").attrs({type:"file"}).on("change",this.onChange)}return this.E("span")},this.mode$))}],listeners:[function onChange(e){var file=e.target.files[0];this.data=this.BlobBlob.create({blob:file})}]});
foam.CLASS({package:"foam.u2.view",name:"StringArrayView",extends:"foam.u2.view.ArrayView",properties:[{name:"valueView",value:{class:"foam.u2.TextField"}}]});
foam.CLASS({package:"foam.u2.view",name:"ImageView",extends:"foam.u2.Element",properties:["data",["nodeName","img"]],methods:[function render(){this.SUPER();this.attrs({src:this.data$})}]});
foam.CLASS({package:"foam.u2.view",name:"ExprView",extends:"foam.u2.View",requires:["foam.u2.view.ChoiceView"],imports:["of"],properties:[{name:"choices",expression:function(of){return of.getAxiomsByClass(foam.core.Property).map(function(prop){return[prop,prop.label]})}}],methods:[function render(){this.tag(this.ChoiceView,{choices$:this.of$.map(function(of){return of.getAxiomsByClass(foam.core.Property).map(function(prop){return[prop,prop.label]})}),data$:this.data$})}]});
foam.CLASS({package:"foam.u2.view",name:"MultiChoiceView",extends:"foam.u2.View",flags:["web"],implements:["foam.mlang.Expressions"],requires:["foam.u2.view.CardSelectView"],css:`
^helpTextRow {
font-size: 14pt;
padding: 8pt 0;
}
^flexer {
flex-wrap: wrap;
align-items: stretch;
text-align: center;
justify-content:flex-start;
}
^flexer > * {
padding: 4px;
}
`,messages:[{name:"OPTIONS_MSG",message:"options"},{name:"CHOOSE_1_OF_FOLLOWING_OPTIONS",message:"Choose one of the following options"},{name:"CHOOSE_AT_LEAST_1_OPTION",message:"Choose at least one option"},{name:"CHOOSE_AT_LEAST",message:"Choose at least"},{name:"CHOOSE_EXACTLY",message:"Choose exactly"},{name:"CHOOSE",message:"Choose"}],properties:[{class:"Function",name:"onSelect"},{name:"choices",factory:function(){return[]},adapt:function(old,nu){if(foam.Object.isInstance(nu)){var out=[];for(var key in nu){if(nu.hasOwnProperty(key))out.push([key,nu[key]])}return out}nu=foam.Array.shallowClone(nu);for(var i=0;i<nu.length;i++){if(!Array.isArray(nu[i])){nu[i]=[nu[i],nu[i]]}}return nu}},{class:"foam.dao.DAOProperty",name:"dao",},{class:"Boolean",name:"useDao"},{class:"Boolean",name:"showMinMaxHelper",value:true},{class:"Boolean",name:"isValidNumberOfChoices",expression:function(minSelected,maxSelected,data){return data.length>=minSelected&&data.length<=maxSelected}},{class:"Int",name:"minSelected",expression:function(choices){return choices.length>0?1:0}},{class:"Int",name:"maxSelected",value:2},{class:"Boolean",name:"isVertical",value:false},{class:"Boolean",name:"isDaoFetched",value:false},{name:"objToChoice",class:"Function",value:function(obj){return[obj.id,obj.toSummary()]}},{name:"helpText_",expression:function(minSelected,maxSelected){return maxSelected>0?minSelected==maxSelected?minSelected==1?this.CHOOSE_1_OF_FOLLOWING_OPTIONS:`${this.CHOOSE_EXACTLY} ${minSelected} ${this.OPTIONS_MSG}`:`${this.CHOOSE} ${minSelected} - ${maxSelected} ${this.OPTIONS_MSG}`:minSelected==1?this.CHOOSE_AT_LEAST_1_OPTION:`${this.CHOOSE_AT_LEAST} ${minSelected} ${this.OPTIONS_MSG}`}},{name:"data",value:[]},{class:"foam.u2.ViewSpec",name:"choiceView",value:{class:"foam.u2.view.CardSelectView"}},{name:"numberColumns",value:3}],methods:[function outputSelectedChoicesInDAO(){if(!this.isValidNumberOfChoices||!this.dao){console.warn("Please select a valid number of choices");return foam.dao.NullDAO}var of=this.dao.of;return this.dao.where(this.IN(of.ID,this.data))},function isChoiceSelected(data,choice){for(var i=0;i<data.length;i++){if(foam.util.equals(data[i],choice))return true}return false},function getIndexOfChoice(data,choice){for(var i=0;i<data.length;i++){if(foam.util.equals(data[i],choice))return i}return-1},function getSelectedSlot(choice){var slot=foam.core.SimpleSlot.create();slot.sub(()=>{var arr=[...this.data];arr=arr.filter(o=>!foam.util.equals(o,choice));if(slot.get()){arr.push(choice)}this.data=arr});this.data$.sub(()=>slot.set(this.isChoiceSelected(this.data,choice)));slot.set(this.isChoiceSelected(this.data,choice));return slot},function render(){var self=this;this.onDAOUpdate();this.start().add(this.slot(function(showMinMaxHelper,helpText_){return self.E().callIf(showMinMaxHelper,function(){this.start(foam.u2.layout.Rows).start().addClass(self.myClass("helpTextRow")).add(self.helpText_).end().end()})})).end().start(this.isVertical?foam.u2.layout.Rows:foam.u2.layout.Cols).addClass(this.myClass("flexer")).add(this.isDaoFetched$.map(isDaoFetched=>{var toRender=this.choices.map((choice,index)=>{var valueSimpSlot=this.mustSlot(choice[0]);var labelSimpSlot=this.mustSlot(choice[1]);var isFinal=choice[2];var isSelectedSlot=self.slot(function(choices,data){try{var isSelected=self.isChoiceSelected(data,choices[index][0]);return!!isSelected}catch(err){console.error("isSelectedSlot",err);return false}});var isDisabledSlot=self.slot(function(choices,data,maxSelected){try{if(isFinal){return true}var isSelected=self.isChoiceSelected(data,choices[index][0]);return!!(!isSelected&&data.length>=maxSelected)}catch(err){console.error("isDisabledSlot",err);return false}});var cls=choice[0]&&choice[0].cls_&&choice[0].cls_.id;var selfE=self.E();return selfE.style({width:self.isVertical?"100%":`${100/self.numberColumns}%`}).start(self.choiceView,{data$:valueSimpSlot,label$:labelSimpSlot,isSelected$:isSelectedSlot,isDisabled$:isDisabledSlot,of:cls}).call(function(){selfE.onDetach(this.clicked.sub(()=>{var array;var indexDataToAdd=self.getIndexOfChoice(self.data,valueSimpSlot.get());if(indexDataToAdd===-1){if(self.data.length>=self.maxSelected){return}array=[...self.data,valueSimpSlot.get()]}else{array=[...self.data];array.splice(indexDataToAdd,1)}self.data=array}))}).end()});return toRender})).end()},function mustSlot(v){return foam.core.Slot.isInstance(v)?v:foam.core.SimpleSlot.create({value:v})}],listeners:[{name:"onDAOUpdate",isFramed:true,code:function(){if(!this.useDao&&!this.dao||!foam.dao.DAO.isInstance(this.dao))return;var of=this.dao.of;if(of._CHOICE_TEXT_){this.dao.select(this.PROJECTION(of.ID,of._CHOICE_TEXT_)).then(s=>{this.choices=s.projection;this.isDaoFetched=true});return}console.warn("Inefficient ChoiceView. Consider creating transient _choiceText_ property on "+of.id+" DAO, prop: "+this.prop_);var p=this.mode===foam.u2.DisplayMode.RW?this.dao.select().then(s=>s.array):this.dao.find(this.data).then(o=>o?[o]:[]);p.then(a=>{var choices=a.map(this.objToChoice);var choiceLabels=a.map(o=>this.objToChoice(o)[1]);Promise.all(choiceLabels).then(resolvedChoiceLabels=>{for(let i=0;i<choices.length;i++){choices[i][1]=resolvedChoiceLabels[i]}this.choices=choices;this.isDaoFetched=true})})}}]});
foam.CLASS({package:"foam.u2.view",name:"CardSelectionView",extends:"foam.u2.View",flags:["web"],implements:["foam.mlang.Expressions"],requires:["foam.u2.view.CardSelectView"],css:`
^flexer {
flex-wrap: wrap;
}
^innerFlexer {
display: inline-flex;
padding: 4px;
box-sizing: border-box;
}
`,properties:[{name:"choices",factory:function(){return[]}},["isVertical",true],{class:"Int",name:"numCols",value:2,},{class:"foam.u2.ViewSpec",name:"choiceView",value:{class:"foam.u2.view.CardSelectView"}}],methods:[function render(){var self=this;this.start(this.isVertical?foam.u2.layout.Rows:foam.u2.layout.Cols).addClass(this.myClass("flexer")).add(self.slot(function(choices){var toRender=choices.sort().map((choice,index)=>{var isSelectedSlot=self.slot(function(choices,data){return self.choiceIsSelected(data,choices[index])});var cardSelectViewConfig={isSelected$:isSelectedSlot};var valueSimpSlot;if(choice instanceof Array){valueSimpSlot=self.mustSlot(choice[0]);cardSelectViewConfig.label=choice[1]}else{valueSimpSlot=self.mustSlot(choice);cardSelectViewConfig.of=choice.cls_.id}cardSelectViewConfig.data$=valueSimpSlot;return self.E().addClass(self.myClass("innerFlexer")).style({width:self.isVertical?"100%":`${100/self.numCols}%`}).start(this.choiceView,cardSelectViewConfig).call(function(){self.E().onDetach(this.clicked.sub(()=>{self.data=!self.choiceIsSelected(self.data,valueSimpSlot.get())?valueSimpSlot.get():null}),this.selectionDisabled.sub(()=>{if(self.isDisabled&&self.choiceIsSelected(self.data,valueSimpSlot.get())){self.clearProperty("data")}}))}).end()});return toRender})).end()},function choiceIsSelected(data,choice){return foam.util.equals(data,choice instanceof Array?choice[0]:choice)},function mustSlot(v){return foam.core.Slot.isInstance(v)?v:foam.core.SimpleSlot.create({value:v})}]});
foam.CLASS({package:"foam.u2.view",name:"CardSelectView",extends:"foam.u2.View",requires:["foam.u2.borders.CardBorder"],axioms:[foam.pattern.Faceted.create()],topics:["clicked","selectionDisabled"],css:`
^innerFlexer {
min-width: -webkit-fill-available;
}
^base {
box-sizing: content-box;
background-color: /*%WHITE%*/ #ffffff;
border-radius: 5px;
position: relative;
padding: 16px;
transition: all 0.2s linear;
display: flex;
align-items: center;
justify-content: center;
}
^ .foam-u2-borders-CardBorder {
min-height: auto;
}
.foam-u2-borders-CardBorder^large-card {
min-height: 2.5vh;
}
^ .foam-u2-borders-CardBorder^selected {
border-color: /*%PRIMARY3%*/ #406dea;
}
^ .foam-u2-borders-CardBorder^disabled {
background-color: /*%GREY5%*/ #f5f7fa;
color: /*%GREY2%*/ #9ba1a6;
}
^ .foam-u2-borders-CardBorder^selected-disabled {
border-color: /*%PRIMARY5%*/ #b2c4f6;
background-color: /*%GREY5%*/ #f5f7fa;
color: /*%GREY2%*/ #9ba1a6;
}
.foam-u2-view-MultiChoiceView-flexer .foam-u2-layout-Cols {
column-gap: 17px;
flex-flow: nowrap;
}
`,properties:[{class:"String",name:"label",factory:function(){return String(this.value)}},{class:"Boolean",name:"isSelected"},{class:"Boolean",name:"isDisabled",postSet:function(_,n){if(n)this.selectionDisabled.pub()}},"largeCard","of"],methods:[function render(){this.addClass(this.myClass()).addClass(this.myClass("innerFlexer")).start(this.CardBorder).addClass(this.myClass("base")).enableClass(this.myClass("large-card"),this.largeCard$).enableClass(this.myClass("selected"),this.isSelected$).enableClass(this.myClass("disabled"),this.isDisabled$).enableClass(this.myClass("selected-disabled"),this.slot((isSelected,isDisabled)=>{return isSelected&&isDisabled})).on("click",this.onClick).add(this.label).end()}],listeners:[function onClick(){this.clicked.pub()}]});
foam.CLASS({package:"foam.u2.view",name:"CardSelectWithRadioView",extends:"foam.u2.view.CardSelectView",requires:["foam.u2.view.RadioButton"],css:`
^radio-choice-flexbox {
display: flex;
}
^ .radio {
margin-right: 1em;
}
`,methods:[function render(){this.addClass(this.myClass()).addClass(this.myClass("innerFlexer")).start(this.CardBorder).addClass(this.myClass("base")).enableClass(this.myClass("large-card"),this.largeCard$).enableClass(this.myClass("selected"),this.isSelected$).enableClass(this.myClass("disabled"),this.isDisabled$).enableClass(this.myClass("selected-disabled"),this.slot((isSelected,isDisabled)=>{return isSelected&&isDisabled})).start().addClass(this.myClass("radio-choice-flexbox")).add(this.RadioButton.create({isSelected$:this.isSelected$,isDisabled$:this.isDisabled$},this)).call(this.addContent,[this]).end().end().on("click",this.onClick)},function addContent(self){this.add(self.label)}]});
foam.CLASS({package:"foam.nanos.approval",name:"NoBackStack",properties:["delegate"],methods:[function push(v,parent,opt_id){this.delegate.push(v,parent,opt_id)},function back(){}]});
foam.CLASS({package:"foam.u2.view",name:"ReadOnlyEnumView",extends:"foam.u2.View",requires:["foam.u2.tag.CircleIndicator"],imports:["returnExpandedCSS","theme"],css:`
^pill{
align-items: center;
border-radius: 11.2px;
border: 1px solid;
display: inline-flex;
justify-content: space-around;
font-size: 1rem;
font-weight: 500;
letter-spacing: normal;
line-height: 2.1em;
min-width: 88px;
padding: 0 12px;
text-align: center;
width: -webkit-max-content;
width: -moz-max-content;
}
^icon{
margin-right: 4px;
}
`,properties:[{class:"Boolean",name:"showGlyph"}],methods:[function render(){var data=this.data;this.SUPER();var color=this.returnExpandedCSS(this.data.color);var background=this.returnExpandedCSS(this.data.background);var isPill=this.isFancy(this.data.VALUES);this.enableClass(this.myClass("pill"),isPill).addClass(this.myClass()).style({"background-color":background,color:color,"border-color":background.includes("#FFFFFF")||!background?color:background}).callIf(this.showGlyph&&data.glyph,()=>{var icon={size:14,backgroundColor:color,icon:data.glyph.clone(this).getDataUrl({fill:background||color})};this.start(this.CircleIndicator,icon).addClass(this.myClass("icon")).end()}).callIfElse(isPill,()=>{this.start().add(data.label).end()},()=>{this.start().addClass("p").add(data.label).end()})},{name:"isFancy",code:foam.Function.memoize1(function(values){for(value of values){if(value.color||value.background){return true}}})}]});
foam.CLASS({package:"foam.u2.view",name:"ViewReferenceFObjectView",extends:"foam.u2.View",imports:["stack"],requires:["foam.u2.ControllerMode","foam.u2.detail.SectionedDetailView"],messages:[{name:"BACK_LABEL",message:"Back"}],properties:[{class:"FObjectProperty",of:"foam.core.FObject",name:"data"},{class:"Class",name:"of"}],methods:[function render(){var x=this.__subContext__.createSubContext({controllerMode:this.ControllerMode.VIEW});this.addClass().startContext({data:this}).tag(this.BACK,{buttonStyle:foam.u2.ButtonStyle.LINK,themeIcon:"back",label:this.BACK_LABEL}).endContext().tag(this.SectionedDetailView.create({data:this.data,of:this.of},x))}],actions:[{name:"back",code:function(){this.stack.back()}}]});
foam.CLASS({package:"foam.u2",name:"EnumView",extends:"foam.u2.view.ChoiceView",imports:["auth"],properties:[{class:"Class",name:"of",required:true},{class:"Boolean",name:"permissioned",},{name:"permissionResults",expression:async function(of,permissioned){var results=[];if(of&&permissioned){var model=of.name.toLowerCase();for(var i=0;i<of.VALUES.length;i++){var readPermission=model+".read."+of.VALUES[i].label.toLowerCase();var permResult=await this.auth.check(null,readPermission);results.push([of.VALUES[i].label,permResult])}}return results}},{name:"choices",expression:function(of){return of?of.VALUES.map(function(v){return[v,v.label]}):[]}}],methods:[function render(){this.SUPER();if(this.permissioned){this.permissionedChoices()}},function fromProperty(p){this.SUPER(p);if(!this.of)this.of=p.of},function permissionedChoices(){this.permissionResults.then(array=>{var values=[];if(this.of){var hash={};for(var i=0;i<array.length;i+=1){hash[array[i]]=i}this.of.VALUES.map(v=>{var value=[v.label,true];if(hash.hasOwnProperty(value)){values.push([v,v.label])}})}return values}).then(array=>{this.choices=array})}]});
foam.CLASS({package:"foam.u2",name:"ClassView",extends:"foam.u2.TextField",properties:[{class:"Class",name:"data"}],methods:[function link(){this.attrSlot(null,null).relateFrom(this.data$,this.textToData.bind(this),this.dataToText.bind(this))},function dataToText(c){return c?c.id:""},function textToData(text){return text.trim()}]});
foam.CLASS({package:"foam.u2.view",name:"ReferenceView",extends:"foam.u2.view.ChoiceView",properties:[{name:"placeholder",factory:function(){return"--"}},{name:"objToChoice",value:function(obj){return[obj.id,obj.toSummary()]}}],methods:[function fromProperty(prop){this.SUPER(prop);if(!this.dao){var dao=this.__context__[prop.targetDAOKey]||this.__context__.data[prop.name+"$dao"];this.dao=dao}}]});
foam.CLASS({package:"foam.u2.view",name:"FullReferenceView",extends:"foam.u2.view.ReferenceView",properties:[{class:"foam.u2.ViewSpec",name:"detailView",value:{class:"foam.u2.DetailView"}}],methods:[function render(){var self=this;this.SUPER();this.add(this.slot(function(dao,data,detailView){return dao.find(data).then(d=>{if(!d)return null;return self.E().startContext({controllerMode:foam.u2.ControllerMode.VIEW}).tag(detailView,{data:d}).endContext()})}))}]});
foam.CLASS({package:"foam.u2.view",name:"StrategizerChoiceView",extends:"foam.u2.view.ChoiceView",imports:["strategizer"],properties:[{class:"String",name:"desiredModelId",required:true},{class:"String",name:"target"}],methods:[function init(){this.SUPER();this.onDetach(this.desiredModelId$.sub(this.updateChoices));this.onDetach(this.target$.sub(this.updateChoices));this.updateChoices()}],listeners:[{name:"updateChoices",code:function(){var self=this;self.strategizer.query(null,self.desiredModelId,self.target).then(strategyReferences=>{self.choices=strategyReferences.reduce((arr,sr)=>{if(!sr.strategy){console.warn("Invalid strategy reference: "+sr.id);return arr}return arr.concat([[sr.strategy,sr.strategy.name]])},[[null,"Select..."]]).filter(x=>x)})}}]});
foam.CLASS({package:"foam.u2.tag",name:"Card",extends:"foam.u2.Element",});
foam.CLASS({package:"foam.u2",name:"ActionReference",properties:[{class:"FObjectProperty",of:"foam.core.Action",name:"action"},{class:"FObjectProperty",of:"foam.core.FObject",name:"data"}]});
foam.CLASS({package:"foam.u2.dialog",name:"Popup",extends:"foam.u2.Element",imports:["setTimeout"],exports:["close as closeDialog","as popup"],css:`
^ {
align-items: center;
bottom: 0;
display: flex;
height: 100%;
justify-content: space-around;
left: 0;
position: fixed;
right: 0;
top: 0;
width: 100%;
z-index: 1000;
}
^X {
position: absolute;
top: min(10%, 16px);
right: min(10%, 16px);
z-index: 1000;
cursor: pointer;
transition: all ease-in 0.1s;
padding: 0;
}
^X:hover{
transform: scale(1.1)
}
^background {
background-color: #000;
bottom: 0;
left: 0;
opacity: 0.4;
position: absolute;
right: 0;
top: 0;
}
^inner {
height: auto;
width: auto;
display: flex;
justify-content: center;
z-index: 3;
position: relative;
border-radius: 3px;
box-shadow: 0 24px 24px 0 rgba(0, 0, 0, 0.12), 0 0 24px 0 rgba(0, 0, 0, 0.15);
overflow: auto;
/* The following line fixes a stacking problem in certain browsers. */
will-change: opacity;
}
^fullscreen ^inner {
height: 100%;
width: 100%;
border-radius: 0;
}
`,properties:[["backgroundColor","#fff"],{class:"Boolean",name:"closeable",value:true},"onClose",{class:"Boolean",name:"isStyled",value:true,},{class:"Boolean",name:"fullscreen"},{class:"Boolean",name:"showActions",value:true}],methods:[function init(){this.SUPER();var content;this.addClass().enableClass(this.myClass("fullscreen"),this.fullscreen$).start().addClass(this.myClass("background")).on("click",this.closeable?this.closeModal.bind(this):null).end().start().call(function(){content=this}).enableClass(this.myClass("inner"),this.isStyled$).style({"background-color":this.isStyled?this.backgroundColor:""}).startContext({data:this}).start(this.CLOSE_MODAL,{buttonStyle:"TERTIARY"}).show(this.closeable$.and(this.showActions$)).addClass(this.myClass("X")).end().endContext().end();this.content=content},function open(){this.document.body.insertAdjacentHTML("beforeend",this.outerHTML);this.load()}],listeners:[function close(){this.closeModal()}],actions:[{name:"closeModal",icon:"images/ic-cancelblack.svg",label:"",keyboardShortcuts:[27],code:function(){if(this.onClose)this.onClose();this.setTimeout(()=>this.remove(),32)}}]});
foam.CLASS({package:"foam.u2.dialog",name:"ApplicationPopup",extends:"foam.u2.dialog.Popup",implements:["foam.mlang.Expressions"],imports:["theme"],exports:["as actionProvider"],requires:["foam.u2.ActionReference","foam.u2.tag.Image"],css:`
^header-action {
z-index: 1000;
cursor: pointer;
transition: all ease-in 0.1s;
}
^inner {
flex-direction: column;
overflow: hidden;
}
^header {
display: flex;
justify-content: space-between;
flex-basis: 64px;
border-bottom: 1px solid /*%GREY4%*/ #777777;
padding: 12px;
}
^header-left {
display: flex;
align-items: center;
justify-content: center;
position: absolute;
left: 12px;
}
^header-right {
display: flex;
align-items: center;
justify-content: center;
position: absolute;
right: 12px;
}
^header-center {
display: flex;
text-align: center;
align-items: center;
justify-content: center;
flex: 1;
}
^body {
flex-grow: 1;
max-height: 90vh;
overflow: auto;
display: flex;
justify-content: center;
align-items: center;
flex-direction: column;
}
^fullscreen ^body {
max-height: 100vh;
}
^logo img, ^logo svg {
display: flex;
max-height: 40px;
/* remove and override any image styling to preserve aspect ratio */
width: unset;
}
^header-button-placeholder {
min-width: 56px;
}
^footer {
padding: 1em;
text-align: center;
border-top: 1px solid /*%GREY4%*/ #DADDE2;
flex-shrink: 0;
}
`,properties:[{class:"FObjectArray",of:"foam.u2.ActionReference",name:"customActions"},{name:"closeAction"},{class:"Reference",targetDAOKey:"menuDAO",of:"foam.nanos.menu.Menu",name:"helpMenu"},"help_",{class:"String",name:"footerString"}],methods:[function init(){var content;const self=this;this.helpMenu$find.then(menu=>{self.help_=menu});this.addClass().enableClass(this.myClass("fullscreen"),this.fullscreen$).start().addClass(this.myClass("background")).on("click",this.closeable?this.closeModal.bind(this):null).end().start().enableClass(this.myClass("inner"),this.isStyled$).style({"background-color":this.isStyled?this.backgroundColor:""}).start().show(this.showActions$).addClass(this.myClass("header")).start().addClass(this.myClass("header-left")).add(this.slot(function(customActions){if(!customActions||customActions.length===0){return this.E().enableClass(this.myClass("header-button-placeholder"),self.closeable$)}let slots=[];customActions.forEach(a=>{slots.push(a.action.createIsAvailable$(self.__subContext__,a.data))});let s=foam.core.ArraySlot.create({slots:slots},self);let anyAvailable=this.slot(function(slots){for(let slot of slots){if(slot)return true}return false},s);return this.E().enableClass(this.myClass("header-button-placeholder"),anyAvailable).forEach(customActions,function(ar){this.start(ar.action,{label:"",buttonStyle:"TERTIARY",data$:ar.data$}).addClass(self.myClass("header-action")).end()})})).end().start().addClass(this.myClass("header-center")).start(this.Image,{data$:this.slot(function(theme$topNavLogo){return theme$topNavLogo}),embedSVG:true}).addClass(this.myClass("logo")).end().end().start().addClass(this.myClass("header-right")).add(this.slot(function(help_){return help_?this.E().tag(help_,{label:"",buttonStyle:"TERTIARY"}):null})).add(this.slot(function(closeAction){return closeAction?this.E().start(closeAction.action,{label:"",buttonStyle:"TERTIARY",data$:closeAction.data$}).show(self.closeable$.and(self.showActions$)).addClass(self.myClass("header-action")).end():this.E().startContext({data:self}).start(self.CLOSE_MODAL,{buttonStyle:"TERTIARY"}).show(self.closeable$.and(self.showActions$)).addClass(self.myClass("header-action")).end().endContext()})).end().end().start().addClass(this.myClass("body")).call(function(){content=this}).end().start().addClasses([this.myClass("footer"),"p-legal-light"]).add(this.footerString$).end().end();this.content=content},function addAction(actionRef){this.customActions$push(actionRef)},function removeAction(actionRef){this.customActions$remove(this.EQ(this.DOT(this.ActionReference.ACTION,foam.core.Action.NAME),actionRef.action.name))}]});foam.ENUM({package:"foam.u2.dialog",name:"ModalStyles",values:[{name:"DEFAULT",color:"/*%WHITE%*/ #FFFFFF"},{name:"DESTRUCTIVE",color:"/*%DESTRUCTIVE3%*/ #D9170E"},{name:"WARN",color:"/*%WARNING3%*/ #EEDC00"}]});
foam.CLASS({package:"foam.u2.dialog",name:"StyledModal",extends:"foam.u2.dialog.Popup",imports:["returnExpandedCSS","theme?"],requires:["foam.u2.dialog.ModalStyles","foam.u2.layout.Rows"],css:`
^top{
position: absolute;
top: 2vh;
}
^colorBar{
border: 1px solid;
border-bottom: 0px;
border-radius: 3px 3px 0 0;
box-sizing: border-box;
height: 8px;
width: 100%;
z-index: 4;
}
^inner {
background-color: /*%WHITE%*/ white;
border: 1px solid /*%GREY4%*/ #DADDE2;
border-radius: 0 0 3px 3px;
border-top: none;
box-shadow: 0 24px 24px 0 rgba(0, 0, 0, 0.12), 0 0 24px 0 rgba(0, 0, 0, 0.15);      
display: flex;
flex-direction: column;
overflow: hidden;
padding: 24px;
padding-bottom: 0px; 
}
^modal-body{
height: 100%;
overflow: auto;
position: relative;
}
^title{
margin-right: min(10%, 16px);
padding-bottom: 16px;
}
^actionBar {
display: flex;
justify-content: flex-end;
padding: 16px 0px;
}
`,properties:[{class:"Int",name:"maxHeight",value:65},{class:"Int",name:"maxWidth",value:45},{class:"Enum",of:"foam.u2.dialog.ModalStyles",name:"modalStyle",value:"DEFAULT",},{name:"title",class:"String"},{class:"FObjectArray",of:"foam.core.Action",name:"actionArray",},{class:"Boolean",name:"isTop",value:false,}],methods:[function init(){var bgColor=this.returnExpandedCSS(this.modalStyle.color);this.addClass(this.myClass()).on("keydown",this.onKeyDown).start().addClass(this.myClass("background")).on("click",this.closeable?this.close:null).end().start(this.Rows).style({"max-height":this.maxHeight+"vh","max-width":this.maxWidth+"vw"}).enableClass(this.myClass("top"),this.isTop$).start().enableClass(this.myClass("colorBar"),this.isStyled$).style({"background-color":bgColor,"border-color":this.modalStyle!="DEFAULT"?bgColor:this.returnExpandedCSS("/*%GREY4%*/ #DADDE2")}).end().start().enableClass(this.myClass("inner"),this.isStyled$).startContext({data:this}).start(this.CLOSE_MODAL,{buttonStyle:"TERTIARY"}).show(this.closeable$).addClass(this.myClass("X")).end().endContext().start().addClasses(["h400",this.myClass("title")]).add(this.title).end().start().addClass(this.myClass("modal-body")).add(this.addBody()).end().start().addClass(this.myClass("actionBar")).add(this.addActions()).end().end().end()},function addBody(){return this.E().tag("",null,this.content$)},function addActions(){var actions=this.E().startContext({data$:this.data$});for(action of this.actionArray){actions.tag(action)}return actions.endContext()}]});
foam.CLASS({package:"foam.u2.dialog",name:"ConfirmationModal",extends:"foam.u2.dialog.StyledModal",imports:["theme?"],messages:[{name:"CANCEL_LABEL",message:"Cancel"}],properties:[{class:"FObjectProperty",of:"foam.core.Action",name:"primaryAction",},{class:"FObjectProperty",of:"foam.core.Action",name:"secondaryAction",},["showCancel",true],"data"],methods:[function addActions(){var actions=this.E().startContext({data:this});actions.tag(this.CONFIRM,{label:this.primaryAction.label,isDestructive:this.modalStyle=="DESTRUCTIVE"});if(this.showCancel){actions.tag(this.CANCEL,{label:this.secondaryAction?this.secondaryAction.label:this.CANCEL_LABEL})}return actions.endContext()}],actions:[{name:"confirm",buttonStyle:"PRIMARY",code:function(X){this.primaryAction&&this.primaryAction.maybeCall(X,this.data);X.closeDialog()}},{name:"cancel",buttonStyle:"TERTIARY",code:function(X){this.secondaryAction&&this.secondaryAction.maybeCall(X,this.data);X.closeDialog()}}]});
foam.CLASS({package:"foam.u2",name:"Dialog",extends:"foam.u2.Element",requires:["Action"],imports:["overlay"],properties:["title","body",{type:"Array",name:"buttons",factory:function(){return[[function(){this.overlay.close()}.bind(this),"OK"]]},adapt:function(old,nu){if(nu){for(var i=0;i<nu.length;i++){if(!this.Action.isInstance(nu[i])){nu[i]=this.Action.create({name:nu[i][1],label:nu[i][1],code:nu[i][0]})}}}return nu}},{class:"Boolean",name:"padding",documetation:"Controls the padding inside the dialog.",attribute:true,value:true}],methods:[function render(){this.SUPER();this.addClass();if(this.title){this.start().addClass(this.myClass("header")).enableClass(this.myClass("padding"),this.padding$).add(this.title).end()}this.start().addClass(this.myClass("body")).enableClass(this.myClass("padding"),this.padding$).add(this.body).end();this.start().addClass(this.myClass("buttons")).add(this.buttons).end()}],css:`
^ {
background-color: #fff;
display: block;
margin: 10px;
overflow: hidden;
}
^header {
font-size: 2.0rem;
font-weight: 500;
}
^padding {
margin: 24px;
}
^buttons {
display: flex;
flex-direction: row-reverse;
}
`});
foam.CLASS({package:"foam.u2.dialog",name:"NotificationMessage",extends:"foam.u2.View",requires:["foam.log.LogLevel","foam.u2.tag.CircleIndicator"],imports:["translationService","theme"],css:`
^ {
display: flex;
justify-content: center;
position: fixed;
/* TODO: reduce max width when notification messages are updated */
max-width: max(30vw, 480px);
min-width: max(16vw, 300px);
right: 32px;
top: 24px;
z-index: 15000;
}
^inner {
align-items: center;
animation-name: fade;
animation-duration: 10s;
background: /*%WHITE%*/ white;
border: 1px solid /*%GREY4%*/ #DADDE2;
border-radius: 3px;
box-shadow: 0px 10px 15px rgba(0, 0, 0, 0.1), 0px 4px 6px rgba(0, 0, 0, 0.05);
box-sizing: border-box;
display: flex;
justify-content: space-between;
margin: auto;
min-height: 64px;
padding: 12px 16px;
width: -webkit-fill-available;
}
@keyframes fade {
0% { opacity: 0; transform: translateX(300px);}
10% { opacity: 1; transform: translateX(0px);}
80% { opacity: 1; }
100% { opacity: 0; }
}
^outer-content{
align-items: center;
display: flex;
margin-right: 1em;
width: -webkit-fill-available;
}
^status-icon {
align-items: center;
height: 32px;
justify-content: center;
margin-right: 1em; 
max-width: max(10%, 32px);
width: 32px;
}
^content {
max-width: 90%;
vertical-align: middle;
white-space: nowrap;
word-wrap: break-word;
}
^title{
overflow: hidden;
text-overflow: ellipsis;
width: -webkit-fill-available;
}
^description {
color: /*%GREY2%*/ #6B778C;
overflow: hidden;
text-overflow: ellipsis;
width: -webkit-fill-available;
}
^close-icon {
position: absolute;
right: 0.5em;
top: 0.5em;
}
^close-icon > *{
width: 20px;
height: 20px;
padding: 0;
}
`,properties:[{class:"String",name:"type"},"err","message","description","icon"],methods:[function render(){var self=this;var indicator;if(this.err){var ex=this.err.exception||this.err;if(ex.id){this.message=ex.id.split(".").pop();if(this.message.endsWith("Exception")){this.message=this.message.replace("Exception","")}this.message=foam.String.capitalize(foam.String.labelize(this.message).toLowerCase());this.message=this.translationService.getTranslation(foam.locale,ex.id,this.message)}if(ex.getTranslation){this.description=ex.getTranslation()}else{this.description=this.translationService.getTranslation(foam.locale,ex.id+"."+ex.message,ex.message)}if(this.message==this.description){this.description=null}}if(!this.icon){if(this.type==this.LogLevel.ERROR){console.error("notification: "+this.message);indicator={size:32,backgroundColor:this.theme.destructive3,borderColor:this.theme.destructive3,icon:this.theme.glyphs.exclamation.getDataUrl({fill:this.theme.white})}}else if(this.type==this.LogLevel.WARN){console.warn("notification: "+this.message);indicator={size:32,icon:"images/baseline-warning-yellow.svg"}}else{console.info("notification: "+this.message);indicator={size:32,backgroundColor:this.theme.approval3,borderColor:this.theme.approval3,icon:this.theme.glyphs.checkmark.getDataUrl({fill:this.theme.white})}}}else{indicator={size:32,icon$:this.icon$}}this.addClass(this.myClass()).start().addClass(this.myClass("inner")).start().addClass(this.myClass("outer-content")).start().addClass(this.myClass("status-icon")).tag(this.CircleIndicator,indicator).end().start().addClass(this.myClass("content")).start().addClasses(["h600",this.myClass("title")]).callIfElse(foam.String.isInstance(this.message),function(){this.add(self.message);console.log(self.message)},function(){this.tag(self.message);console.log(self.message)}).end().start().addClasses(["p",this.myClass("description")]).callIfElse(foam.String.isInstance(this.description),function(){this.add(self.description);console.log(self.description)},function(){this.tag(self.description);console.log(self.description)}).end().end().end().startContext({data:this}).start().addClass(this.myClass("close-icon")).tag(self.REMOVE_NOTIFICATION,{buttonStyle:"TERTIARY",label:""}).end().endContext().end();setTimeout(()=>{this.remove()},9900)}],actions:[{name:"removeNotification",themeIcon:"close",icon:"images/ic-cancelblack.svg",code:function(){this.remove()}}]});foam.ENUM({package:"foam.u2.dialog",name:"InlineNotificationStyles",values:[{name:"DEFAULT",color:"/*%PRIMARY3%*/ #406DEA",glyph:"checkmark"},{name:"ERROR",color:"/*%DESTRUCTIVE3%*/ #A61414",glyph:"exclamation"},{name:"WARN",color:"/*%WARNING3%*/ #EEDC00",glyph:"exclamation"},{name:"SUCCESS",color:" /*%APPROVAL3%*/ #117A41",glyph:"checkmark"},{name:"UNSTYLED",color:" /*%WHITE%*/ #FFFFFF"}]});
foam.CLASS({package:"foam.u2.dialog",name:"InlineNotificationMessage",extends:"foam.u2.View",requires:["foam.u2.ControllerMode","foam.u2.tag.CircleIndicator"],imports:["returnExpandedCSS"],properties:[{name:"icon",factory:function(){if(!this.type.glyph)return undefined;var props={size:16,backgroundColor:this.accentColor,icon:this.type.glyph.clone(this).getDataUrl({fill:this.iconColor})};return{class:"foam.u2.tag.CircleIndicator",...props}}},{class:"Enum",of:"foam.u2.dialog.InlineNotificationStyles",name:"type"},{name:"accentColor",factory:function(){return this.type&&this.returnExpandedCSS(this.type.color)},},{name:"iconColor",factory:function(){return this.returnExpandedCSS(this.type.background)||"#FFFFFF"},},{name:"isVisible",value:true,}],css:`
^outer {
align-items: center;
border: 1px solid;
border-radius: 3px;
border-left-width: 8px;
box-sizing: border-box;
display: flex;
justify-content: space-between;
padding: 8px 16px;
}
^outer > * + * {
padding-left: 16px;
}
^status-icon {
flex: 0 0 16px;
}
^content {
flex: 1;
}
`,methods:[function init(){var self=this;this.show(this.isVisible$).addClass(this.myClass("outer")).style({"border-color":this.accentColor$}).call(function(){if(!self.icon)return;if(foam.core.String.isInstance(this.icon)=="String"){this.start("img").addClass(self.myClass("status-icon")).attrs({src:self.icon$}).end()}else{this.tag(self.icon)}}).startContext({controllerMode:this.ControllerMode.VIEW}).start("",null,this.content$).addClass(this.myClass("content")).end().endContext()}]});
foam.CLASS({package:"foam.u2",name:"Autocompleter",properties:[{name:"dao",required:true,},{class:"String",name:"partial",},{name:"queryFactory",value:function(str){return foam.mlang.predicate.Keyword.create({arg1:str})}},{class:"foam.dao.DAOProperty",name:"filteredDAO",factory:function(){return this.dao}}],methods:[function init(){this.SUPER();this.partial$.sub(this.onUpdate);this.onUpdate()}],listeners:[{name:"onUpdate",isFramed:true,code:function onUpdate(){if(!this.dao)return;this.filteredDAO=this.partial?this.dao.where(this.queryFactory(this.partial)):this.dao}}]});
foam.CLASS({package:"foam.u2.filter",name:"PropertyRefinement",refines:"foam.core.Property",properties:[{class:"foam.u2.ViewSpec",name:"searchView",value:{class:"foam.u2.search.GroupAutocompleteSearchView"}}]});
foam.CLASS({package:"foam.u2.filter",name:"StringRefinement",refines:"foam.core.String",properties:[{class:"foam.u2.ViewSpec",name:"searchView",value:{class:"foam.u2.filter.properties.StringFilterView"}}]});
foam.CLASS({package:"foam.u2.filter",name:"BooleanRefinement",refines:"foam.core.Boolean",properties:[{class:"foam.u2.ViewSpec",name:"searchView",value:{class:"foam.u2.filter.properties.BooleanFilterView"}}]});
foam.CLASS({package:"foam.u2.filter",name:"ReferenceRefinement",refines:"foam.core.Reference",properties:[{class:"foam.u2.ViewSpec",name:"searchView",value:{class:"foam.u2.filter.properties.ReferenceFilterView"}}]});
foam.CLASS({package:"foam.u2.filter",name:"EnumRefinement",refines:"foam.core.Enum",properties:[{class:"foam.u2.ViewSpec",name:"searchView",value:{class:"foam.u2.filter.properties.EnumFilterView"}}]});
foam.CLASS({package:"foam.u2.filter",name:"UnitValueRefinement",refines:"foam.core.UnitValue",properties:[{class:"foam.u2.ViewSpec",name:"searchView",value:{class:"foam.u2.search.CurrencySearchView"}}]});
foam.CLASS({package:"foam.u2.filter",name:"DateRefinement",refines:"foam.core.Date",properties:[{class:"foam.u2.ViewSpec",name:"searchView",value:{class:"foam.u2.filter.properties.DateFilterView"}}]});
foam.CLASS({package:"foam.u2.filter",name:"DateTimeRefinement",refines:"foam.core.DateTime",properties:[{class:"foam.u2.ViewSpec",name:"searchView",value:{class:"foam.u2.filter.properties.DateTimeFilterView"}}]});
foam.CLASS({package:"foam.u2.filter",name:"IntRefinement",refines:"foam.core.Int",properties:[{class:"foam.u2.ViewSpec",name:"searchView",value:{class:"foam.u2.filter.properties.IntegerFilterView"}}]});
foam.CLASS({package:"foam.u2.filter",name:"ShortRefinement",refines:"foam.core.Short",properties:[{class:"foam.u2.ViewSpec",name:"searchView",value:{class:"foam.u2.filter.properties.IntegerFilterView"}}]});
foam.CLASS({package:"foam.u2.filter",name:"LongRefinement",refines:"foam.core.Long",properties:[{class:"foam.u2.ViewSpec",name:"searchView",value:{class:"foam.u2.filter.properties.IntegerFilterView"}}]});
foam.CLASS({package:"foam.u2.filter",name:"ByteRefinement",refines:"foam.core.Byte",properties:[{class:"foam.u2.ViewSpec",name:"searchView",value:{class:"foam.u2.filter.properties.IntegerFilterView"}}]});
foam.CLASS({package:"foam.u2.filter",name:"FloatRefinement",refines:"foam.core.Float",properties:[{class:"foam.u2.ViewSpec",name:"searchView",value:{class:"foam.u2.filter.properties.FloatFilterView"}}]});
foam.CLASS({package:"foam.u2.filter",name:"DAOPropertyRefinement",refines:"foam.dao.DAOProperty",properties:[{class:"foam.u2.ViewSpec",name:"searchView",value:null}]});
foam.CLASS({package:"foam.u2.filter",name:"ManyToManyRelationshipPropertyRefinement",refines:"foam.dao.ManyToManyRelationshipProperty",properties:[{class:"foam.u2.ViewSpec",name:"searchView",value:null}]});
foam.CLASS({package:"foam.u2.filter",name:"ReferenceRefinement",refines:"foam.core.Reference",properties:[{class:"foam.u2.ViewSpec",name:"searchView",expression:function(of){return of.ID.searchView}}]});
foam.CLASS({package:"foam.u2.filter",name:"FilterView",extends:"foam.u2.View",mixins:["foam.u2.memento.Memorable","foam.util.DeFeedback"],implements:["foam.mlang.Expressions"],requires:["foam.u2.memento.Memento","foam.core.SimpleSlot","foam.u2.dialog.Popup","foam.u2.filter.FilterController","foam.u2.filter.property.PropertyFilterView","foam.u2.search.TextSearchView","foam.parse.QueryParser"],imports:["auth","searchColumns"],exports:["as data","filterController"],css:`
^ {
flex: 1;
position: relative;
}
^container-search {
display: flex;
}
^container-drawer {
border-color: transparent;
border-radius: 5px;
display: flex;
max-height: 0;
overflow: hidden;
padding: 0 24px;
transition: all 0.24s linear;
-webkit-transition: all 0.24s linear;
-moz-transition: all 0.24s linear;
}
^container-drawer-open {
align-items: center;
max-height: -webkit-fill-available;
max-height: -moz-available;
overflow: auto;
padding: 24 0px;
}
^container-filters {
display: grid;
grid-gap: 24px 16px;
grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
width: 100%;
}
^general-field {
margin: 0;
flex: 0 0 60%;
}
^general-field input {
border: 1px solid /*%GREY4%*/ #e7eaec;
border-radius: 5px;
height: 34px;
width: 100%;
}
^container-handle {
box-sizing: border-box;
height: 34px;
align-items: center;
justify-content: center;
}
^container-handle:hover {
cursor: pointer;
}
^filter-button svg{
fill: initial;
transform: rotate(0deg);
transition: all 0.5s ease;
font-size: 0.6rem;
}
^filter-button-active{
color: /*%PRIMARY3%*/ #406DEA;
background: /*%GREY5%*/ #F5F7FA;
}
^filter-button-active svg {
fill: /*%PRIMARY3%*/ #406DEA;
transform: rotate(180deg);
}
^link-mode {
font-size: 1.4rem;
margin-left: 16px;
cursor: pointer;
}
^link-mode.advanced {
color: #9ba1a6;
text-decoration: underline;
}
^link-mode.advanced:hover {
color: #5e6061;
}
^link-mode.clear {
align-self: center;
color: /*%DESTRUCTIVE3%*/ red;
flex-shrink: 0;
margin-right: 0;
}
^link-mode.clear:hover {
color: /*%DESTRUCTIVE1%*/ darkred;
}
^message-advanced {
margin: 16px;
}
^message-view {
margin: 16px;
margin-left: auto;
color: #4D7AF7;
}
^message-view:hover {
cursor: pointer;
color: #233E8B;
}
^ .foam-u2-dialog-Popup-inner {
width: 75%;
height: 80%;
border-radius: 5px;
}
/* tablet and desktop */
@media only screen and (min-width: 768px) {
^container-search {
gap: 24px;
}
}
`,messages:[{name:"LINK_ADVANCED",message:"Advanced filters"},{name:"LINK_SIMPLE",message:"Switch to simple filters"},{name:"MESSAGE_ADVANCEDMODE",message:"Advanced filters are currently being used."},{name:"LABEL_FILTER",message:"Filters"}],properties:[{name:"filtersContainer"},{class:"Class",name:"of"},{name:"dao"},{name:"data"},{class:"Array",name:"filters",factory:null},{name:"generalSearchField",postSet:function(o,n){this.filterController.add(n,n.name,0)}},{name:"filterController",factory:function(){return this.FilterController.create({dao$:this.dao$,finalPredicate$:this.data$})}},{class:"Boolean",name:"isOpen"},{class:"Boolean",name:"isFiltering",expression:function(data){if(!data)return false;return Object.keys(data.instance_).length>0}},{class:"String",name:"resultLabel",expression:function(isFiltering,filterController$totalCount,filterController$resultsCount){if(!isFiltering)return"";return`${this.LABEL_RESULTS}${filterController$resultsCount} of ${filterController$totalCount}`}},{class:"String",name:"iconPath",expression:function(isOpen){return isOpen?"images/expand-less.svg":"images/expand-more.svg"}},{class:"String",name:"modeLabel",expression:function(filterController$isAdvanced){return filterController$isAdvanced?this.LINK_SIMPLE:this.LINK_ADVANCED}},{name:"mementoString",shortName:"filters",memorable:true},{name:"searchData",shortName:"search",memorable:true}],methods:[function init(){this.onDetach(this.searchColumns$.sub(this.updateFilters));this.onDetach(this.dao$.sub(this.updateFilters))},async function render(){var self=this;this.mementoString$.sub(this.getData);this.getData();this.data$.sub(this.updateMementoString);await this.updateFilters();this.onDetach(this.filterController$.dot("isAdvanced").sub(this.isAdvancedChanged));var selectedLabel=ctrl.__subContext__.translationService.getTranslation(foam.locale,"foam.u2.filter.FilterView.SELECTED",this.SELECTED);this.addClass(self.myClass()).add(this.slot(function(filters){var generalSearchField=foam.u2.ViewSpec.createView(self.TextSearchView,{richSearch:true,of:self.dao.of.id,onKey:true,searchData$:self.searchData$},this,self.__subContext__);self.show(filters&&filters.length);var e=this.E();var labelSlot=foam.core.ExpressionSlot.create({args:[this.filterController.activeFilterCount$],code:function(x){return x>0?`${self.LABEL_FILTER} (${x})`:self.LABEL_FILTER}});e.onDetach(self.filterController);e.start().addClass(self.myClass("container-search")).start().add(generalSearchField).addClass(self.myClass("general-field")).end().start().addClass(self.myClass("container-handle")).startContext({data:self}).start(self.TOGGLE_DRAWER,{label$:labelSlot,buttonStyle:"SECONDARY",isIconAfter:true,themeIcon:"dropdown"}).enableClass(this.myClass("filter-button-active"),this.isOpen$).addClass(this.myClass("filter-button")).end().endContext().end().start().style({overflow:"hidden","align-self":"center"}).end().end();self.filtersContainer=this.E().add(self.filterController.slot(function(criterias){if(!filters)return self.E();return self.E().start().addClass(self.myClass("container-drawer")).enableClass(self.myClass("container-drawer-open"),self.isOpen$).start().addClass(self.myClass("container-filters")).show(self.isOpen$).forEach(filters,function(f){var axiom=self.dao.of.getAxiomByName(f);if(axiom){var propView=foam.u2.ViewSpec.createView(self.PropertyFilterView,{criteria:0,searchView:axiom.searchView,property:axiom,dao:self.dao,preSetPredicate:self.assignPredicate(axiom)},self,self.__subContext__);this.start().add(propView).hide(self.filterController$.dot("isAdvanced")).end()}}).start("p").show(self.filterController$.dot("isAdvanced")).addClass(self.myClass("message-advanced")).add(self.MESSAGE_ADVANCEDMODE).end().start("p").show(self.filterController$.dot("isAdvanced")).addClass(self.myClass("message-view")).startContext({data:self}).tag(self.OPEN_ADVANCED,{buttonStyle:"TERTIARY"}).endContext().end().end().start().hide(self.filterController$.dot("isAdvanced")).addClass(self.myClass("link-mode")).addClass("clear").show(self.isOpen$).startContext({data:self}).tag(self.CLEAR_ALL,{isDestructive:true,buttonStyle:"TERTIARY"}).endContext().end().end()}));self.generalSearchField=generalSearchField;return e},this.filters$))},function addFilter(key){this.filters=this.filters.concat(key)},function removeFilter(key){this.filters=this.filters.filter(function(k){return key!==k})},function formatLargeValue(num){var symbols=["K","M","B","T"];var range="";if(num<1e3)return num;symbols.forEach((symbol,index)=>{var lowerBound=Math.pow(10,(index+1)*3);var upperBound=lowerBound*1e3;if(num>=lowerBound&&num<upperBound){range=`~ ${Math.round(num/lowerBound)}${symbol}`}});return range?range:"Value too large"},async function filterPropertiesByReadPermission(properties,of){if(!properties||!of)return[];var split=of.split(".");var modelName=split[split.length-1].toLowerCase();var permissionedProperties=[];var unpermissionedProperties=[];var classProperties=foam.lookup(of).getAxiomsByClass(foam.core.Property);for(prop of classProperties){if(properties.includes(prop.name)&&!prop.hidden){prop.readPermissionRequired?permissionedProperties.push(prop.name):unpermissionedProperties.push(prop.name)}}var perms=await Promise.all(permissionedProperties.map(async p=>await this.auth.check(ctrl.__subContext__,modelName+".rw."+p)||await this.auth.check(ctrl.__subContext__,modelName+".ro."+p)));var grantedProperties=permissionedProperties.filter((_v,index)=>perms[index]);var unorderedProperties=grantedProperties.concat(unpermissionedProperties);return properties.filter(v=>unorderedProperties.includes(v))},function assignPredicate(property){var predicate=this.filterController.finalPredicate;var retPred=null;if(predicate){if(foam.mlang.predicate.And.isInstance(predicate)){var subPredicates=predicate.args;for(subPredicate of subPredicates){let ret=this.unwrapPredicate(subPredicate,property);if(!ret)continue;if(retPred!=null){retPred=this.AND(retPred,ret)}else{retPred=ret}}}}else{if(predicate.arg1&&predicate.arg1.name==prop.name)retPred=predicate}return retPred},function unwrapPredicate(pred,prop){if(foam.mlang.predicate.Or.isInstance(pred)){var subPredicates=pred.args;for(subPredicate of subPredicates){if(subPredicate.arg1&&subPredicate.arg1.name==prop.name){let p=this.IN(subPredicate.arg1,subPredicates.map(s=>{if(s.arg1&&s.arg1.name==prop.name){return s.arg2.value}}));return p}}}else{if(pred.arg1&&pred.arg1.name==prop.name)return pred}}],listeners:[{name:"updateMementoString",code:function(){this.deFeedback(()=>{var mem=this.data.toMQL();if(mem){this.mementoString="{"+mem+"}"}else{this.mementoString=undefined}})}},{name:"getData",code:function(){this.deFeedback(()=>{var queryParser=foam.parse.QueryParser.create({of:this.dao.of},this);var value=this.mementoString;if(value&&value.indexOf("{")!=-1&&value.indexOf("}")!=-1){value=value.substr(value.indexOf("{")+1,value.indexOf("}")-1)}if(value){var mementoPredicate=queryParser.parseString(value);this.data=this.data!=this.TRUE?this.AND(mementoPredicate,this.data):mementoPredicate}})}},{name:"toggleMode",code:function(){if(this.filterController.isAdvanced){this.filterController.switchToSimple();return}this.filterController.switchToPreview();this.openAdvanced()}},{name:"isAdvancedChanged",code:function(){if(!this.filterController.isAdvanced){this.filterController.add(this.generalSearchField,"generalSearchField",0);this.generalSearchField.mode=foam.u2.DisplayMode.RW}else{this.generalSearchField.data="";this.generalSearchField.mode=foam.u2.DisplayMode.DISABLED}}},async function updateFilters(){var of=this.dao&&this.dao.of;if(!of)this.filters=[];var searchColumns_=await this.filterPropertiesByReadPermission(this.searchColumns,of.id);if(searchColumns_&&searchColumns_.length>0){this.filters=searchColumns_;return}var columns=of.getAxiomByName("searchColumns");columns=columns&&columns.columns;columns=await this.filterPropertiesByReadPermission(columns,of.id);if(columns){this.filters=columns;return}columns=of.getAxiomByName("tableColumns");columns=columns&&columns.columns;columns=await this.filterPropertiesByReadPermission(columns,of.id);if(columns){this.columns=columns.filter(function(c){if(c.split(".").length>1)return false;var a=of.getAxiomByName(c);if(!a)console.warn("Column does not exist for "+of.name+": "+c);return a&&!a.storageTransient&&!a.networkTransient&&a.searchView&&!a.hidden});return}columns=of.getAxiomsByClass(foam.core.Property).filter(p=>{return!p.storageTransient&&!p.networkTransient&&p.searchView&&!p.hidden}).map(foam.core.Property.NAME.f);this.filters=await this.filterPropertiesByReadPermission(columns,of.id)}],actions:[{name:"clearAll",label:"Clear all",code:function(){if(this.filterController.isAdvanced)return;this.filterController.clearAll();this.generalSearchField.view.data="";this.mementoString=""}},{name:"toggleDrawer",label:"Filters",icon:"/images/dropdown-icon.svg",code:function(){this.isOpen=!this.isOpen}},{name:"openAdvanced",label:"View filters",code:function(){this.add(this.Popup.create().tag({class:"foam.u2.filter.advanced.AdvancedFilterView",dao$:this.dao$}))}}]});
foam.CLASS({package:"foam.u2.filter.advanced",name:"AdvancedFilterView",extends:"foam.u2.View",implements:["foam.mlang.Expressions"],requires:["foam.u2.ModalHeader","foam.u2.filter.advanced.CriteriaView"],imports:["closeDialog","filterController"],css:`
^ {
display: flex;
flex-direction: column;
height: 90%;
}
^ .foam-u2-filter-property-PropertyFilterView {
margin-bottom: 0;
}
^ .foam-u2-ModalHeader {
color: /*%GREY1%*/ #5E6061;
}
^ .foam-u2-ModalHeader-title {
font-spacing: 0;
}
^label-subtitle {
margin: 0;
margin-bottom: 24px;
font-size: 1.6rem;
font-weight: 300;
}
^container-advanced {
flex: 1;
padding: 24px;
overflow-y: auto;
}
^container-handle {
height: 40px;
padding: 0 16px;
box-sizing: border-box;
border: 1px solid /*%GREY4%*/ #e7eaec;
border-radius: 5px;
display: flex;
align-items: center;
margin-top: 8px;
}
^container-handle:first-child {
margin: 0;
}
^container-handle:hover {
cursor: pointer;
}
^handle-title {
flex: 1;
margin: 0;
}
^handle-remove {
margin: 0;
padding: 0 8px;
color: red;
}
^handle-remove:hover {
cursor: pointer;
color: darkred;
}
^ .foam-u2-filter-advanced-CriteriaView {
max-height: 0;
overflow: hidden;
transition: max-height 0.24s ease-in-out;
}
^isOpen {
max-height: 1000px !important;
overflow: visible !important;
}
^ .foam-u2-ActionView-addCriteria {
width: 100%;
margin-top: 16px;
padding: 0;
}
^ .foam-u2-ActionView-clearAll {
color: red !important;
padding: 0 8px;
}
^ .foam-u2-ActionView-clearAll:hover {
color: darkred !important;
}
^ .foam-u2-ActionView-tertiary {
color: #4D7AF7;
}
^ .foam-u2-ActionView-tertiary:hover {
color: #233E8B;
}
^ .foam-u2-ActionView-tertiary:focus {
padding: 0 8px;
border: none;
}
^container-footer {
display: flex;
justify-content: flex-end;
padding: 16px 24px;
border-top: solid 1px #CBCFD4;
border-radius: 0 0 5px 5px;
background-color: #F6F6F6;
}
^label-results {
margin: 0;
font-size: 1.2rem;
padding: 0 8px;
flex: 1;
align-self: center;
}
`,messages:[{name:"TITLE_HEADER",message:"Advanced Filters"},{name:"LABEL_CRITERIA",message:"Criteria"},{name:"LABEL_REMOVE",message:"Remove"},{name:"LABEL_RESULTS",message:"Filter Results Preview: "},{name:"LABEL_INSTRUCTION",message:"In Advanced Mode, the results are an accumulation of each criteria. Within each criteria, the results will be a reflection that fully matches your selection."}],properties:[{class:"foam.dao.DAOProperty",name:"dao",},{class:"Long",name:"isOpenIndex",value:0},{class:"Long",name:"resultsCount",},{class:"String",name:"resultLabel",expression:function(filterController$totalCount,filterController$resultsCount){return`${this.LABEL_RESULTS}${filterController$resultsCount} of ${filterController$totalCount}`}}],methods:[function init(){this.SUPER();this.filterController.getResultsCount();this.onDetach(()=>{this.filterController.isPreview=false})},function render(){var self=this;this.addClass().start(this.ModalHeader,{title:this.TITLE_HEADER}).end().add(this.filterController.slot(function(previewCriterias){var keys=Object.keys(previewCriterias);return self.E().addClass(self.myClass("container-advanced")).start("p").addClass(self.myClass("label-subtitle")).add(self.LABEL_INSTRUCTION).end().forEach(keys,function(key,index){var criteria=previewCriterias[key];this.start().addClass(self.myClass("container-handle")).on("click",()=>{self.toggleDrawer(key)}).start("p").addClass(self.myClass("handle-title")).add(`${self.LABEL_CRITERIA} ${Number.parseInt(key)+1}`).end().start("p").addClass(self.myClass("handle-remove")).on("click",()=>{self.removeCriteria(key)}).add(`${self.LABEL_REMOVE}`).end().add(self.slot(function(isOpenIndex){var iconPath=self.getIconPath(key);return this.E().start({class:"foam.u2.tag.Image",data:iconPath}).end()})).end().start(self.CriteriaView,{criteria:key}).enableClass(self.myClass("isOpen"),self.slot(function(isOpenIndex){return key==isOpenIndex})).end()}).startContext({data:self}).start(self.ADD_CRITERIA,{buttonStyle:"TERTIARY"}).end().endContext()})).start().addClass(this.myClass("container-footer")).start("p").addClass(this.myClass("label-results")).add(this.resultLabel$).end().startContext({data:this}).start(this.CLEAR_ALL,{buttonStyle:"TERTIARY"}).end().start(this.FILTER).end().endContext().end()},function getIconPath(key){return key==this.isOpenIndex?"images/expand-less.svg":"images/expand-more.svg"}],actions:[{name:"addCriteria",label:"Add another criteria",code:function(X){this.filterController.addCriteria()}},{name:"closeModal",label:"Cancel",code:function(X){X.closeDialog()}},{name:"clearAll",label:"Clear changes",code:function(X){this.filterController.clearAll(true)}},{name:"filter",label:"Apply filters",isEnabled:function(filterController$previewPredicate){return filterController$previewPredicate!==this.TRUE},code:function(X){this.filterController.applyPreview();X.closeDialog()}}],listeners:[{name:"toggleDrawer",code:function(key){if(key==this.isOpenIndex){this.isOpenIndex=-1;return}this.isOpenIndex=key}},{name:"removeCriteria",code:function(key){if(key==this.isOpenIndex)this.isOpenIndex=-1;if(Object.keys(this.filterController.previewCriterias).length===1){this.clearAll(true);return}this.filterController.clearCriteria(key,true)}}]});
foam.CLASS({package:"foam.u2.filter.advanced",name:"CriteriaView",extends:"foam.u2.View",implements:["foam.mlang.Expressions"],requires:["foam.u2.filter.property.PropertyFilterView","foam.u2.search.TextSearchView"],imports:["filterController"],css:`
^ {
position: relative;
display: flex;
flex-direction: row;
flex-wrap: wrap;
}
^general-field {
margin: 0 8px;
margin-top: 8px;
flex: 1 1 100%;
}
^general-field .foam-u2-tag-Input {
width: 100%;
height: 34px;
border-radius: 5px;
border: solid 1px #cbcfd4;
}
^ .foam-u2-filter-property-PropertyFilterView {
flex: 1 1 250px;
}
`,properties:[{name:"searchView",postSet:function(_,n){var existingPredicate=this.filterController.getExistingPredicate(this.criteria,n.name);if(existingPredicate&&existingPredicate!==this.TRUE){n.view$.sub(()=>{n.view.data=existingPredicate.args[1].arg1.value})}this.filterController.add(n,n.name,this.criteria)}},{class:"Array",name:"modelProps",factory:function(){var dao=this.filterController.dao;var of=dao&&dao.of;if(!of)return[];return of.getAxiomsByClass(foam.core.Property).filter(prop=>prop.searchView&&!prop.hidden).map(foam.core.Property.NAME.f)}},{name:"criteria",}],methods:[function render(){var self=this;this.addClass().start(this.TextSearchView,{richSearch:true,of:this.filterController.dao.of.id,onKey:true,viewSpec:{class:"foam.u2.SearchField"}},this.searchView$).addClass(self.myClass("general-field")).end().forEach(this.modelProps,function(property){var axiom=self.filterController.dao.of.getAxiomByName(property);if(axiom){this.start(self.PropertyFilterView,{criteria:self.criteria,searchView:axiom.searchView,property:axiom,dao:self.filterController.dao}).end()}})}]});
foam.CLASS({package:"foam.u2.filter",name:"FilterController",implements:["foam.mlang.Expressions"],properties:[{class:"Map",name:"criterias",factory:function(){return{}}},{class:"Map",name:"previewCriterias",},{name:"finalPredicate",factory:function(){return this.TRUE}},{name:"previewPredicate",factory:function(){return this.TRUE}},{name:"dao",},{class:"Boolean",name:"isPreview"},{class:"Boolean",name:"isAdvanced"},{class:"Long",name:"resultsCount"},{class:"Long",name:"totalCount"},{class:"Int",name:"activeFilterCount",defaultValue:0}],methods:[function init(){this.addCriteria();this.onDetach(this.dao$.sub(this.onDAOUpdate));this.onDAOUpdate();this.onDetach(this.isPreview$.sub(this.getResultsCount));this.onDetach(this.finalPredicate$.sub(this.getResultsCount));this.onDetach(this.previewPredicate$.sub(this.getResultsCount))},function and(predicates){return this.And.create({args:Object.values(predicates).filter(predicate=>{return predicate!==undefined})}).partialEval()},function addCriteria(key){var criterias=this.isPreview?this.previewCriterias:this.criterias;var keys=Object.keys(criterias);var newKey;if(key){newKey=key}else{newKey=keys.length>0?Number.parseInt(keys[keys.length-1])+1:0}if(!this.isPreview){this.criterias$set(newKey,{views:{},subs:{},predicates:{}});return}this.previewCriterias$set(newKey,{views:{},subs:{},predicates:{}});this.updateFilterPredicate()},function add(view,name,criteriaKey){var criterias=this.isPreview?this.previewCriterias:this.criterias;criterias[criteriaKey].views[name]=view;criterias[criteriaKey].subs[name]=view.predicate$.sub(()=>{this.onViewPredicateUpdate(criteriaKey,name)});this.onViewPredicateUpdate(criteriaKey,name)},function onViewPredicateUpdate(criteriaKey,name){var criteria=this.isPreview?this.previewCriterias[criteriaKey]:this.criterias[criteriaKey];var predicate=criteria.views[name].predicate;criteria.predicates[name]=predicate;this.reciprocateInCriteria(criteriaKey)},function reciprocateInCriteria(criteriaKey){var criteria=this.isPreview?this.previewCriterias[criteriaKey]:this.criterias[criteriaKey];var predicates=criteria.predicates;foam.Object.forEach(predicates,function(_,name){var temp={};foam.Object.forEach(predicates,function(predicate,n){if(name===n)return;temp[n]=predicate});if(criteria.views[name]){criteria.views[name].dao=this.dao.where(this.and(temp))}}.bind(this));this.updateFilterPredicate()},function updateFilterPredicate(){var criterias=this.isPreview?this.previewCriterias:this.criterias;var orPredicate=this.Or.create({args:Object.values(criterias).map(criteria=>{return this.and(criteria.predicates)})}).partialEval();if(orPredicate===this.FALSE)orPredicate=this.TRUE;if(!this.isPreview){this.finalPredicate=orPredicate;return}this.previewPredicate=orPredicate},function getExistingPredicate(criteriaKey,property){var propertyName=typeof property==="string"?property:property.name;var previewCriteria=this.previewCriterias[criteriaKey];var criteria=this.criterias[criteriaKey];if(!previewCriteria&&!criteria)return null;var existingPredicate;if(previewCriteria){existingPredicate=previewCriteria.predicates[propertyName];if(existingPredicate&&existingPredicate!==this.TRUE)return existingPredicate}if(criteria){existingPredicate=criteria.predicates[propertyName];if(existingPredicate&&existingPredicate!==this.TRUE)return existingPredicate}return null},function setExistingPredicate(criteriaKey,property,predicate){var propertyName=typeof property==="string"?property:property.name;var previewCriteria=this.previewCriterias[criteriaKey];var criteria=this.criterias[criteriaKey];if(!previewCriteria&&!criteria){this.addCriteria(criteriaKey);criteria=this.criterias[criteriaKey]}if(previewCriteria){previewCriteria.predicates[propertyName]=predicate}if(criteria){criteria.predicates[propertyName]=predicate}this.updateFilterPredicate()},function applyPreview(){this.isAdvanced=true;this.isPreview=false;Object.keys(this.previewCriterias).forEach(criteriaKey=>{this.addCriteria(criteriaKey);Object.keys(this.previewCriterias[criteriaKey].views).forEach(viewKey=>{var view=this.previewCriterias[criteriaKey].views[viewKey];this.criterias[criteriaKey].views[viewKey]={property:view.property,predicate:view.predicate}});this.criterias[criteriaKey].predicate=this.previewCriterias[criteriaKey].predicate});this.finalPredicate=this.previewPredicate},function switchToPreview(){this.isPreview=true;this.clearAll(true);Object.keys(this.criterias).forEach(key=>{this.addCriteria(key);this.previewCriterias[key].predicates=this.criterias[key].predicates});this.updateFilterPredicate()},function switchToSimple(){this.isPreview=true;this.clearAll(true);this.updateFilterPredicate();this.isPreview=false;this.clearAll(true);this.updateFilterPredicate();this.isAdvanced=false},function clear(viewOrName,criteria,remove){var view;var name;var criterias=this.isPreview?this.previewCriterias:this.criterias;if(typeof viewOrName==="string"){view=criterias[criteria].views[viewOrName];name=viewOrName}else{view=viewOrName;name=view.property?view.property.name:view.name}if(!view||!criterias[criteria].views[name])return;if(criterias[criteria].views[name].clear)criterias[criteria].views[name].clear();criterias[criteria].predicates[name]=this.TRUE;if(remove){if(criterias[criteria].subs[name])criterias[criteria].subs[name].detach();delete criterias[criteria].views[name];delete criterias[criteria].subs[name];delete criterias[criteria].predicates[name]}},function clearCriteria(criteria,remove){var criterias=this.isPreview?this.previewCriterias:this.criterias;Object.values(criterias[criteria].views).forEach(view=>{this.clear(view,criteria,remove)});if(remove){if(this.isPreview)this.previewCriterias$remove(criteria);else this.criterias$remove(criteria)}this.updateFilterPredicate()},function clearAll(remove){var criterias=this.isPreview?this.previewCriterias:this.criterias;Object.keys(criterias).forEach(key=>{this.clearCriteria(key,remove)});if(remove)this.addCriteria();this.activeFilterCount=0}],listeners:[{name:"onDAOUpdate",code:function(){this.dao.select(this.COUNT()).then(count=>{this.totalCount=count.value;this.resultsCount=count.value})}},{name:"getResultsCount",code:function(){var predicate=this.isPreview?this.previewPredicate:this.finalPredicate;this.dao.where(predicate).select(this.COUNT()).then(count=>{this.resultsCount=count.value})}}]});
foam.CLASS({package:"foam.u2.filter.property",name:"PropertyFilterView",extends:"foam.u2.View",implements:["foam.mlang.Expressions"],imports:["filterController"],requires:["foam.parse.QueryParser"],css:`
^container-property {
display: flex;
box-sizing: border-box;
height: 32px;
padding: 6px 8px;
padding-right: 4px;
border-radius: 3px;
border: solid 1px #cbcfd4;
}
^container-property:hover {
cursor: pointer;
}
^container-property-active {
background-color: #f5f7fa;
}
^label-property {
margin: 0;
font-size: 1.4rem;
line-height: 1.43;
color: #5e6061;
flex: 1;
overflow: hidden;
}
^overlay-dismiss {
position: fixed;
top: 0;
left: 0;
right: 0;
bottom: 0;
z-index: 2;
}
^container-filter {
position: absolute;
z-index: 100;
margin-top: 8px;
min-width: 216px;
border-radius: 3px;
box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.08), 0 2px 8px 0 rgba(0, 0, 0, 0.16);
border: solid 1px #cbcfd4;
background-color: /*%WHITE%*/ #ffffff;
}
`,messages:[{name:"LABEL_PROPERTY_ALL",message:"All"},{name:"LABEL_PROPERTY_FILTER",message:"Filtering"}],properties:[{class:"Boolean",name:"activeFilterCheck_",value:true},{name:"searchView",required:true},{class:"Boolean",name:"active",},"container_","property","dao",{class:"Boolean",name:"firstTime_",value:true},"view_",{class:"String",name:"labelFiltering",factory:function(){return this.LABEL_PROPERTY_ALL}},{class:"String",name:"iconPath",value:"images/expand-more.svg"},{name:"criteria"},"isInit",{name:"queryParser",factory:function(){return this.QueryParser.create({of:this.dao.of||this.__subContext__.lookup(this.property.forClass_)})}},{class:"foam.mlang.predicate.PredicateProperty",name:"preSetPredicate"}],methods:[function render(){this.SUPER();var self=this;this.addClass().start().addClass(this.myClass("container-property")).enableClass(this.myClass("container-property-active"),this.active$).on("click",this.switchActive).start("p").addClass(this.myClass("label-property")).add(`${this.property.label}: `).add(this.labelFiltering$).end().start({class:"foam.u2.tag.Image",data$:this.iconPath$}).end().end().add(this.slot(function(active){return active?self.E().start().addClass(self.myClass("overlay-dismiss")).on("click",self.switchActive).end():self.E()})).start("div",null,this.container_$).addClass(this.myClass("container-filter")).show(this.active$).end();this.isInit=true;this.isFiltering();this.isInit=false;this.checkPresetPredicate()},function checkPresetPredicate(){if(this.preSetPredicate!=null){this.initView()}}],listeners:[function initView(){this.container_.tag(this.searchView,{property:this.property,dao$:this.dao$},this.view_$);var existingPredicate=this.filterController.getExistingPredicate(this.criteria,this.property);if(!existingPredicate&&this.preSetPredicate!=null){existingPredicate=this.preSetPredicate}if(existingPredicate){this.view_.restoreFromPredicate(existingPredicate)}this.filterController.add(this.view_,this.property.name,this.criteria);this.firstTime_=false;if(this.preSetPredicate!=null)this.isFiltering();this.onDetach(this.view_$.dot("predicate").sub(this.isFiltering))},function switchActive(){this.active=!this.active;this.iconPath=this.active?"images/expand-less.svg":"images/expand-more.svg";if(!this.active)return;if(!this.firstTime_)return;this.initView()},function isFiltering(){if(!this.isInit){if(!this.view_)return}if(this.filterController.getExistingPredicate(this.criteria,this.property)&&this.firstTime_){this.labelFiltering=this.LABEL_PROPERTY_FILTER;this.filterController.activeFilterCount++;this.activeFilterCheck_=false;return}if(!this.view_)return;if(this.view_.predicate!==this.TRUE&&this.activeFilterCheck_){this.labelFiltering=this.LABEL_PROPERTY_FILTER;this.filterController.activeFilterCount++;this.activeFilterCheck_=!this.activeFilterCheck_}else if(this.view_.predicate===this.TRUE&&!this.activeFilterCheck_){this.labelFiltering=this.LABEL_PROPERTY_ALL;this.filterController.activeFilterCount--;this.activeFilterCheck_=!this.activeFilterCheck_}}]});
foam.CLASS({package:"foam.u2.filter.properties",name:"StringFilterView",extends:"foam.u2.Controller",implements:["foam.mlang.Expressions"],requires:["foam.mlang.sink.Count","foam.mlang.sink.GroupBy"],css:`
^ {
position: relative;
}
^container-search {
padding: 16px;
border-bottom: solid 1px #cbcfd4;
}
^ .foam-u2-TextField {
width: 100%;
height: 36px;
font-size: 1.4rem;
border-radius: 3px;
border: solid 1px #cbcfd4;
background-color: /*%WHITE%*/ #ffffff;
background-image: url(images/ic-search.svg);
background-repeat: no-repeat;
background-position: 8px;
padding: 0 21px 0 38px;
}
^label-limit {
margin-top: 4px;
}
^container-filter {
max-height: 320px;
overflow: auto;
padding-bottom: 24px;
}
^label-section {
padding: 0 16px;
font-size: 1.2rem;
font-weight: 600;
line-height: 1.33;
letter-spacing: normal;
color: #1e1f21;
}
^label-loading {
padding: 0 16px;
font-size: 1.2rem;
font-weight: 600;
line-height: 1.33;
letter-spacing: normal;
color: #1e1f21;
text-align: center;
}
^container-option {
display: flex;
align-items: center;
padding: 4px 16px;
}
^container-option:hover {
cursor: pointer;
background-color: #f5f7fa;
}
^container-option .foam-u2-md-CheckBox-label {
position: relative;
margin-top: 0;
}
^container-option .foam-u2-md-CheckBox {
border-color: #9ba1a6;
}
^container-option .foam-u2-md-CheckBox:checked {
background-color: #406dea;
border-color: #406dea;
}
`,messages:[{name:"LABEL_PLACEHOLDER",message:"Search"},{name:"LABEL_LIMIT_REACHED",message:"Please refine your search to view more options"},{name:"LABEL_LOADING",message:"- LOADING OPTIONS -"},{name:"LABEL_NO_OPTIONS",message:"- NO OPTIONS AVAILABLE -"},{name:"LABEL_SELECTED",message:"SELECTED OPTIONS"},{name:"LABEL_FILTERED",message:"OPTIONS"},{name:"LABEL_EMPTY",message:"- Not Defined -"}],properties:[{name:"property",required:true},{class:"foam.dao.DAOProperty",name:"dao",required:true},{name:"daoContents",expression:function(countByContents){if(countByContents)return Object.keys(countByContents);return[]}},{name:"countByContents"},{class:"String",name:"search",postSet:function(_,n){this.isOverLimit=false;var pred=this.search&&this.search.trim().length>0?this.STARTS_WITH(this.property,this.search):this.TRUE;this.dao.where(pred).select(this.GROUP_BY(this.property,this.COUNT(),21)).then(results=>{this.countByContents=results.groups;if(Object.keys(results.groups).length>20)this.isOverLimit=true})}},{class:"Boolean",name:"isOverLimit"},{name:"selectedOptions",factory:function(){return[]}},{name:"filteredOptions",expression:function(daoContents,selectedOptions){if(!daoContents||daoContents.length===0)return[];var options=daoContents.map(obj=>obj.trim());selectedOptions.forEach(function(selection){options=options.filter(function(option){return option!==selection})});return options.sort()}},{class:"Boolean",name:"isLoading",value:true},{name:"predicate",expression:function(selectedOptions){if(selectedOptions.length<=0)return this.TRUE;if(selectedOptions.length===1){return this.EQ(this.property,selectedOptions[0])}return this.IN(this.property,selectedOptions)}},{name:"name",expression:function(property){return property.name}}],methods:[function render(){this.onDetach(this.dao$.sub(this.daoUpdate));this.daoUpdate();var self=this;this.addClass().start().addClass(this.myClass("container-search")).start({class:"foam.u2.TextField",data$:this.search$,placeholder:this.LABEL_PLACEHOLDER,onKey:true}).end().start().addClasses(["p-semibold",this.myClass("label-limit")]).show(this.isOverLimit$).add(this.LABEL_LIMIT_REACHED).end().end().start().addClass(self.myClass("container-filter")).add(this.slot(function(property,selectedOptions,isLoading){var element=this.E();if(isLoading||selectedOptions.length<=0)return element;return element.start("p").addClass(self.myClass("label-section")).add(self.LABEL_SELECTED).end().call(function(){self.selectedOptions.forEach(function(option,index){return element.start().addClass(self.myClass("container-option")).on("click",()=>self.deselectOption(index)).start({class:"foam.u2.CheckBox",data:true,showLabel:true,label:self.getLabelWithCount(option)}).end().end()})})})).add(this.slot(function(property,selectedOptions,filteredOptions,isLoading){var element=this.E();if(isLoading){return element.start("p").addClass(self.myClass("label-loading")).add(self.LABEL_LOADING).end()}if(filteredOptions.length===0){return element.start("p").addClass(self.myClass("label-loading")).add(self.LABEL_NO_OPTIONS).end()}return element.start("p").addClass(self.myClass("label-section")).add(self.LABEL_FILTERED).end().call(function(){self.filteredOptions.forEach(function(option,index){return element.start().addClass(self.myClass("container-option")).on("click",()=>self.selectOption(index)).start({class:"foam.u2.CheckBox",data:false,showLabel:true,label:self.getLabelWithCount(option)}).end().end()})})})).end()},function getLabelWithCount(option){if(!this.countByContents[option])console.error("String mismatch: ",option);var value=this.countByContents[option].value;if(value>1)return`[${this.countByContents[option].value}] ${option?option:this.LABEL_EMPTY}`;return option},function clear(){this.selectedOptions=[]},function restoreFromPredicate(predicate){if(predicate===this.TRUE)return;this.selectedOptions=Array.isArray(predicate.arg2.value)?predicate.arg2.value:[predicate.arg2.value]}],listeners:[{name:"daoUpdate",code:function(){this.isOverLimit=false;this.isLoading=true;var pred=this.search&&this.search.trim().length>0?this.STARTS_WITH(this.property,this.search):this.TRUE;this.dao.where(pred).select(this.GROUP_BY(this.property,this.COUNT(),21)).then(results=>{this.countByContents=results.groups;if(Object.keys(results.groups).length>20)this.isOverLimit=true;this.isLoading=false})}},{name:"selectOption",code:function(index){this.selectedOptions=this.selectedOptions.concat([this.filteredOptions[index]])}},{name:"deselectOption",code:function(index){this.selectedOptions=this.selectedOptions.filter(function(_,selectedIndex){return index!==selectedIndex})}}]});
foam.CLASS({package:"foam.u2.filter.properties",name:"IntegerFilterView",extends:"foam.u2.Controller",implements:["foam.mlang.Expressions"],css:`
^ {
padding: 24px 16px;
box-sizing: border-box;
min-width: 214px;
}
^ .foam-u2-tag-Select {
width: 100%;
border-radius: 3px;
border: solid 1px #cbcfd4;
background-color: #ffffff;
}
^ .foam-u2-FloatView {
width: 100%;
height: 36px;
margin-top: 16px;
border-radius: 3px;
border: solid 1px #cbcfd4;
background-color: #ffffff;
}
`,properties:[{name:"property",required:true},{class:"String",name:"qualifier",view:{class:"foam.u2.view.ChoiceView",choices:[["True","All"],["Eq","Equal"],["Neq","Not equal"],["Gt","Greater than"],["Lt","Less than"],["Gte","Greater than or equal"],["Lte","Less than or equal"],["Bt","Between (exclusive)"],["Bte","Between (inclusive)"]],defaultValue:"True"}},{class:"Float",name:"amount1",view:{class:"foam.u2.FloatView",onKey:true,step:1}},{class:"Float",name:"amount2",view:{class:"foam.u2.FloatView",onKey:true,step:1}},{name:"predicate",expression:function(qualifier,amount1,amount2){if(!qualifier)return this.TRUE;if(qualifier!=="Bt"&&qualifier!=="Bte"){return foam.mlang.predicate[qualifier].create({arg1:this.property,arg2:amount1})}var pred1="Gt";var pred2="Lt";if(qualifier==="Bte"){pred1="Gte";pred2="Lte"}return this.AND(foam.mlang.predicate[pred1].create({arg1:this.property,arg2:amount1}),foam.mlang.predicate[pred2].create({arg1:this.property,arg2:amount2}))}},{name:"name",expression:function(property){return property.name}}],methods:[function render(){var self=this;this.addClass().start(this.QUALIFIER).start("div").addClass(this.myClass("carrot")).end().end().add(this.slot(function(qualifier){if(!qualifier||qualifier==="True")return this.E();return qualifier==="Bt"||qualifier==="Bte"?this.E().add(self.AMOUNT1).add(self.AMOUNT2):this.E().add(self.AMOUNT1)}))},function restoreFromPredicate(predicate){if(predicate===this.TRUE)return;var qualifier=predicate.cls_.name;if(qualifier=="And"){this.qualifier=predicate.args[0].cls_.name=="Gte"?"Bte":"Bt";this.amount1=predicate.args[0].arg2.value;this.amount2=predicate.args[1].arg2.value}else{this.qualifier=qualifier;this.amount1=predicate.arg2.value}},function clear(){this.qualifier="True";this.value=0}]});
foam.CLASS({package:"foam.u2.filter.properties",name:"FloatFilterView",extends:"foam.u2.filter.properties.IntegerFilterView",properties:[{class:"Float",name:"amount",view:{class:"foam.u2.FloatView",onKey:true,precision:2}}]});
foam.CLASS({package:"foam.u2.filter.properties",name:"BooleanFilterView",extends:"foam.u2.Controller",implements:["foam.mlang.Expressions"],requires:["foam.u2.CheckBox"],css:`
^container {
display: flex;
align-items: center;
padding: 4px 16px;
}
^container:hover {
cursor: pointer;
background-color: #f5f7fa;
}
^container:first-child {
margin-top: 20px;
}
^container:last-child {
margin-bottom: 20px;
}
^container .foam-u2-md-CheckBox-label {
position: relative;
margin-top: 0;
}
^container .foam-u2-md-CheckBox {
border-color: #9ba1a6;
}
^container .foam-u2-md-CheckBox:checked {
background-color: #406dea;
border-color: #406dea;
}
`,properties:[{name:"property",required:true},{class:"Boolean",name:"boolT",label:"True",value:false},{class:"Boolean",name:"boolF",label:"False",value:false},{name:"predicate",expression:function(boolT,boolF){if(!boolT&&!boolF||boolT&&boolF)return this.TRUE;return this.EQ(this.property,boolT)}},{name:"name",expression:function(property){return property.name}}],methods:[function render(){var self=this;this.addClass().start().addClass(this.myClass("container")).start({class:"foam.u2.CheckBox",data$:this.boolF$,showLabel:true,label:this.BOOL_F.label}).end().end().start().addClass(this.myClass("container")).start({class:"foam.u2.CheckBox",data$:this.boolT$,showLabel:true,label:this.BOOL_T.label}).end().end()},function clear(){this.boolT=false;this.boolF=false},function restoreFromPredicate(predicate){if(predicate==this.TRUE)return;if(predicate.arg2.value)this.boolT=true;if(!predicate.arg2.value)this.boolF=true}]});
foam.CLASS({package:"foam.u2.filter.properties",name:"DateFilterView",extends:"foam.u2.Controller",implements:["foam.mlang.Expressions"],requires:["foam.u2.view.ChoiceView"],messages:[{name:"LABEL_ALL",message:"All Time"},{name:"LABEL_AFTER",message:"After"},{name:"LABEL_BEFORE",message:"Before"},{name:"LABEL_BETWEEN",message:"Between"}],css:`
^ {
padding: 24px 16px;
box-sizing: border-box;
min-width: 214px;
}
^ .foam-u2-tag-Select {
width: 100%;
border-radius: 3px;
border: solid 1px #cbcfd4;
background-color: /*%WHITE%*/ #ffffff;
}
^ .foam-u2-DateView {
width: 100%;
height: 36px;
margin-top: 16px;
border-radius: 3px;
border: solid 1px #cbcfd4;
background-color: /*%WHITE%*/ #ffffff;
}
`,properties:[{name:"property",required:true},{class:"String",name:"qualifier",},{class:"Date",name:"date1",},{class:"Date",name:"date2",preSet:function(o,n){if(this.isSetFromPredicate)return n;var n1=new Date(n);n1.setDate(n1.getDate()+1);return n1}},{name:"predicate",expression:function(qualifier,date1,date2){if(!qualifier||!date1||isNaN(date1.valueOf()))return this.TRUE;if(qualifier!=="Bt"){return foam.mlang.predicate[qualifier].create({arg1:this.property,arg2:date1})}if(!date2||isNaN(date2.valueOf()))return this.TRUE;return this.AND(this.GT(this.property,date1),this.LT(this.property,date2))}},{name:"name",expression:function(property){return property.name}},{class:"Boolean",name:"isSetFromPredicate"}],methods:[function render(){var self=this;this.addClass().start(this.ChoiceView,{data$:this.qualifier$,choices:[["True",this.LABEL_ALL],["Gt",this.LABEL_AFTER],["Lt",this.LABEL_BEFORE],["Bt",this.LABEL_BETWEEN]],defaultValue:"True"}).start("div").addClass(this.myClass("carrot")).end().end().add(this.onDetach(this.slot(function(qualifier){if(!qualifier||qualifier==="True")return this.E();return qualifier==="Bt"?this.E().add(self.DATE1).add(self.DATE2):this.E().add(self.DATE1)})))},function clear(){this.qualifier="True"},function restoreFromPredicate(predicate){if(predicate===this.TRUE)return;var qualifier=predicate.cls_.name;if(qualifier=="And"){this.qualifier="Bt";this.date1=predicate.args[0].arg2.value;this.isSetFromPredicate=true;this.date2=predicate.args[1].arg2.value;this.isSetFromPredicate=false}else{this.qualifier=qualifier;this.date1=predicate.arg2.value}}]});
foam.CLASS({package:"foam.u2.filter.properties",name:"DateTimeFilterView",extends:"foam.u2.filter.properties.DateFilterView",css:`
^ {
padding: 24px 16px;
box-sizing: border-box;
min-width: 214px;
}
^ .foam-u2-tag-Select {
width: 100%;
border-radius: 3px;
border: solid 1px #cbcfd4;
background-color: /*%WHITE%*/ #ffffff;
}
^ .foam-u2-DateTimeView {
width: 100%;
height: 36px;
margin-top: 16px;
border-radius: 3px;
border: solid 1px #cbcfd4;
background-color: /*%WHITE%*/ #ffffff;
}
`,properties:[{class:"DateTime",name:"date1",},{class:"DateTime",name:"date2",preSet:function(o,n){if(this.isSetFromPredicate)return n;return new Date(n)}}]});
foam.CLASS({package:"foam.u2.filter.properties",name:"EnumFilterView",extends:"foam.u2.Controller",implements:["foam.mlang.Expressions"],css:`
^container-search {
padding: 24px 16px;
border-bottom: solid 1px #cbcfd4;
}
^ .foam-u2-TextField {
width: 100%;
height: 36px;
font-size: 1.4rem;
border-radius: 3px;
border: solid 1px #cbcfd4;
background-color: /*%WHITE%*/ #ffffff;
background-image: url(images/ic-search.svg);
background-repeat: no-repeat;
background-position: 8px;
padding: 0 21px 0 38px;
}
^container-filter {
max-height: 320px;
overflow: auto;
padding-bottom: 24px;
}
^label-section {
padding: 0 16px;
font-size: 1.2rem;
font-weight: 600;
line-height: 1.33;
letter-spacing: normal;
color: #1e1f21;
}
^container-option {
display: flex;
align-items: center;
padding: 4px 16px;
}
^container-option:hover {
cursor: pointer;
background-color: #f5f7fa;
}
^container-option .foam-u2-md-CheckBox-label {
position: relative;
margin-top: 0;
}
^container-option .foam-u2-md-CheckBox {
border-color: #9ba1a6;
}
^container-option .foam-u2-md-CheckBox:checked {
background-color: #406dea;
border-color: #406dea;
}
`,messages:[{name:"LABEL_PLACEHOLDER",message:"Search"},{name:"LABEL_SELECTED",message:"SELECTED OPTIONS"},{name:"LABEL_FILTERED",message:"OPTIONS"}],properties:[{name:"property",required:true},{class:"String",name:"search"},{class:"Array",name:"selectedOptions",factory:function(){return[]}},{name:"filteredOptions",expression:function(property,search,selectedOptions){var options=property.of.VALUES;options.sort(function(a,b){if(a.label<b.label){return-1}if(a.label>b.label){return 1}return 0});if(search){var lowerCaseSearch=search.toLowerCase();options=options.filter(function(option){return option.label?option.label.toLowerCase().includes(lowerCaseSearch):option.name.toLowerCase().includes(lowerCaseSearch)})}selectedOptions.forEach(function(selection){options=options.filter(function(option){return option.name!==selection.name})});return options}},{name:"predicate",expression:function(selectedOptions){if(selectedOptions.length<=0)return this.TRUE;var ordinals=selectedOptions.map(option=>option.ordinal);if(ordinals.length===1){return this.EQ(this.property,ordinals[0])}return this.IN(this.property,ordinals)}},{name:"name",expression:function(property){return property.name}}],methods:[function render(){var self=this;this.addClass().start().addClass(this.myClass("container-search")).start({class:"foam.u2.TextField",data$:this.search$,placeholder:this.LABEL_PLACEHOLDER,onKey:true}).end().end().start().addClass(this.myClass("container-filter")).add(this.slot(function(selectedOptions){var element=this.E();if(selectedOptions.length<=0)return element;return element.start("p").addClass(self.myClass("label-section")).add(self.LABEL_SELECTED).end().call(function(){self.selectedOptions.forEach(function(option,index){const label=option.label?option.label:option.name;return element.start().addClass(self.myClass("container-option")).on("click",()=>self.deselectOption(index)).start({class:"foam.u2.CheckBox",data:true,showLabel:true,label:label}).end().end()})})})).add(this.slot(function(selectedOptions,filteredOptions){var element=this.E();return element.start("p").addClass(self.myClass("label-section")).add(self.LABEL_FILTERED).end().call(function(){self.filteredOptions.forEach(function(option,index){const label=option.label||option.name;return element.start().addClass(self.myClass("container-option")).on("click",()=>self.selectOption(index)).start({class:"foam.u2.CheckBox",data:false,showLabel:true,label:label}).end().end()})})})).end()},function clear(){this.selectedOptions=[]},function restoreFromPredicate(predicate){if(predicate===this.TRUE)return;if(Array.isArray(predicate.arg2.value)){var ordinals=predicate.arg2.value.map(e=>{return e.ordinal});this.selectedOptions=ordinals.map(o=>{return this.property.of.forOrdinal(o)});return}this.selectedOptions=[this.property.of.forOrdinal(predicate.arg2.value.ordinal)]}],listeners:[{name:"selectOption",code:function(index){this.selectedOptions$push(this.filteredOptions[index])}},{name:"deselectOption",code:function(index){this.selectedOptions=this.selectedOptions.filter(function(_,selectedIndex){return index!==selectedIndex})}}]});
foam.CLASS({package:"foam.u2.filter.properties",name:"ReferenceFilterView",extends:"foam.u2.Controller",implements:["foam.mlang.Expressions"],requires:["foam.u2.CheckBox"],css:`
^ {
position: relative;
}
^container-search {
padding: 24px 16px;
border-bottom: solid 1px #cbcfd4;
}
^ .foam-u2-TextField {
width: 100%;
height: 36px;
font-size: 1.4rem;
border-radius: 3px;
border: solid 1px #cbcfd4;
background-color: /*%WHITE%*/ #ffffff;
background-image: url(images/ic-search.svg);
background-repeat: no-repeat;
background-position: 8px;
padding: 0 21px 0 38px;
}
^label-limit {
margin-top: 8px;
margin-bottom: 0;
}
^container-filter {
max-height: 320px;
overflow: auto;
padding-bottom: 24px;
}
^label-section {
padding: 0 16px;
font-size: 1.2rem;
font-weight: 600;
line-height: 1.33;
letter-spacing: normal;
color: #1e1f21;
}
^label-loading {
padding: 0 16px;
font-size: 1.2rem;
font-weight: 600;
line-height: 1.33;
letter-spacing: normal;
color: #1e1f21;
text-align: center;
}
^container-option {
display: flex;
align-items: center;
padding: 4px 16px;
}
^container-option:hover {
cursor: pointer;
background-color: #f5f7fa;
}
^container-option .foam-u2-md-CheckBox-label {
position: relative;
margin-top: 0;
}
^container-option .foam-u2-md-CheckBox {
border-color: #9ba1a6;
}
^container-option .foam-u2-md-CheckBox:checked {
background-color: #406dea;
border-color: #406dea;
}
`,messages:[{name:"LABEL_PLACEHOLDER",message:"Search"},{name:"LABEL_LIMIT_REACHED",message:"Please refine your search to view more options"},{name:"LABEL_LOADING",message:"- LOADING OPTIONS -"},{name:"LABEL_NO_OPTIONS",message:"- NO OPTIONS AVAILABLE -"},{name:"LABEL_SELECTED",message:"SELECTED OPTIONS"},{name:"LABEL_FILTERED",message:"OPTIONS"},{name:"LABEL_EMPTY",message:"NO LABEL"}],properties:[{name:"property",required:true},{name:"targetDAOName",expression:function(property){return property.targetDAOKey}},{class:"foam.dao.DAOProperty",name:"dao",required:true},{name:"referenceObjectsArray",factory:function(){return[]}},{name:"idToStringDisplayMap",expression:function(referenceObjectsArray,daoContents){if(!daoContents)return{};if(referenceObjectsArray.length===0){var m={};daoContents.groupKeys.forEach(g=>m[g]=g);return m}var result={};for(i=0;i<daoContents.groupKeys.length;i++){var refObj=referenceObjectsArray.find(r=>r.id==daoContents.groupKeys[i]);if(refObj){var objectId=refObj.id;var summary=refObj.toSummary();if(summary){result[objectId]=summary}else{result[objectId]=`ID: ${objectId}`}}else{result[0]=""}}return result}},{name:"daoContents"},{name:"selectedOptions",factory:function(){return[]}},{class:"String",name:"search",},{name:"filteredOptions",expression:function(property,daoContents,idToStringDisplayMap,search,selectedOptions){if(!daoContents||!idToStringDisplayMap)return[];var options=Object.keys(idToStringDisplayMap);if(search){var lowerCaseSearch=search.toLowerCase();options=options.filter(function(option){return idToStringDisplayMap[option].toLowerCase().includes(lowerCaseSearch)})}selectedOptions.forEach(function(selection){options=options.filter(function(option){return option!==selection})});this.isLoading=false;return options.sort()}},{class:"Boolean",name:"isLoading",value:false},{class:"Boolean",name:"isOverLimit"},{name:"predicate",expression:function(selectedOptions){if(selectedOptions.length<=0||Object.keys(this.idToStringDisplayMap).length===0){return this.TRUE}if(selectedOptions.length===1){var key=selectedOptions[0];if(!isNaN(key))key=parseInt(key)?parseInt(key):key;return this.EQ(this.property,key)}var keys=selectedOptions.map(key=>{if(!isNaN(key))key=parseInt(key)?parseInt(key):key;return key});return this.IN(this.property,keys)}},{name:"name",expression:function(property){return property.name}}],methods:[function render(){var self=this;if(!this.targetDAOName){console.error("Please specify a targetDAOKey on the reference.");return}this.onDetach(this.daoContents$.sub(this.updateReferenceObjectsArray));this.onDetach(this.dao$.sub(this.daoUpdate));this.daoUpdate();this.addClass().start().addClass(this.myClass("container-search")).start({class:"foam.u2.TextField",data$:this.search$,placeholder:this.LABEL_PLACEHOLDER,onKey:true}).end().start("p").addClass(this.myClass("label-limit")).show(this.isOverLimit$).add(this.LABEL_LIMIT_REACHED).end().end().start().addClass(self.myClass("container-filter")).add(this.slot(function(property,selectedOptions,isLoading,idToStringDisplayMap){var element=this.E();if(isLoading||selectedOptions.length<=0)return element;return element.start("p").addClass(self.myClass("label-section")).add(self.LABEL_SELECTED).end().call(function(){self.selectedOptions.forEach(function(option,index){return element.start().addClass(self.myClass("container-option")).on("click",()=>self.deselectOption(index)).start({class:"foam.u2.CheckBox",data:true,showLabel:true,label:idToStringDisplayMap[option]?self.getLabelWithCount(option):self.LABEL_EMPTY}).end().end()})})})).add(this.slot(function(property,selectedOptions,filteredOptions,isLoading,idToStringDisplayMap){var element=this.E();if(isLoading){return element.start("p").addClass(self.myClass("label-loading")).add(self.LABEL_LOADING).end()}if(filteredOptions.length===0){return element.start("p").addClass(self.myClass("label-loading")).add(self.LABEL_NO_OPTIONS).end()}return element.start("p").addClass(self.myClass("label-section")).add(self.LABEL_FILTERED).end().call(function(){self.filteredOptions.forEach(function(option,index){return element.start().addClass(self.myClass("container-option")).on("click",()=>self.selectOption(index)).start({class:"foam.u2.CheckBox",data:false,showLabel:true,label:idToStringDisplayMap[option]?self.getLabelWithCount(option):self.LABEL_EMPTY}).end().end()})})})).end()},function getKeyByValue(value){return Object.keys(this.idToStringDisplayMap).find(key=>this.idToStringDisplayMap[key]===value)},function getLabelWithCount(option){var countForKey=this.daoContents.groups[option].value;return countForKey>1?`[${countForKey}] ${this.idToStringDisplayMap[option]}`:this.idToStringDisplayMap[option]},function restoreFromPredicate(predicate){if(predicate===this.TRUE)return;var selections=Array.isArray(predicate.arg2.value)?predicate.arg2.value:[predicate.arg2.value];this.idToStringDisplayMap$.sub(()=>{var options=[];selections.forEach(selection=>{options.push(selection)});this.selectedOptions=options})},function clear(){this.selectedOptions=[]}],listeners:[{name:"daoUpdate",code:function(){this.isOverLimit=false;this.isLoading=true;this.dao.select(this.GROUP_BY(this.property,null,101)).then(results=>{this.daoContents=results;if(Object.keys(results.groups).length>100)this.isOverLimit=true;this.isLoading=false})}},{name:"selectOption",code:function(index){this.selectedOptions=this.selectedOptions.concat([this.filteredOptions[index]])}},{name:"deselectOption",code:function(index){this.selectedOptions=this.selectedOptions.filter(function(_,selectedIndex){return index!==selectedIndex})}},{name:"updateReferenceObjectsArray",code:function(){if(!this.daoContents||this.daoContents.groupKeys.length===0)return;this.__subContext__[this.targetDAOName].where(this.IN(this.property.of.ID,this.daoContents.groupKeys)).select().then(results=>{this.referenceObjectsArray=results.array})}}]});
foam.CLASS({package:"foam.u2.search",name:"FilterController",extends:"foam.u2.View",requires:["foam.mlang.sink.Count","foam.u2.search.StringRefinement","foam.u2.search.BooleanRefinement","foam.u2.search.EnumRefinement","foam.u2.search.GroupAutocompleteSearchView","foam.u2.search.GroupBySearchView","foam.u2.search.PropertyRefinement","foam.u2.search.SearchManager","foam.u2.search.TextSearchView","foam.u2.TableView","foam.u2.tag.Card","foam.u2.tag.Input","foam.u2.view.ChoiceView","foam.u2.ViewSpec"],exports:["as filterController","data as unfilteredDAO"],css:`
^ {
display: flex;
overflow: hidden;
flex-grow: 1;
width: 100%;
}
^search-panel {
display: flex;
flex-direction: column;
flex-shrink: 0;
overflow: hidden;
min-width: 250px;
}
^adding {
border: none;
flex-shrink: 0;
flex-grow: 0;
padding: 8px;
}
^add-filter {
align-items: center;
display: flex;
justify-content: space-between;
}
^count {
align-items: center;
display: flex;
justify-content: space-between;
}
^results {
display: flex;
flex-grow: 1;
overflow: hidden;
}
^filter-area {
flex-grow: 1;
overflow-y: auto;
}
^filter-header {
align-items: center;
display: flex;
}
^filter-label {
flex-grow: 1;
}
^filter-container {
margin: 6px 8px 0px;
}
`,properties:["count","totalCount",{name:"countString",expression:function(count,totalCount){return(count||"0")+" of "+(totalCount||"0")}},{class:"foam.dao.DAOProperty",name:"data",required:true},"filteredDAO",{name:"filterChoice",label:"New Filter",factory:function(){return this.defaultFilter}},{name:"filters",adapt:function(old,nu){if(nu&&nu.length&&typeof nu[0]==="string"){var out=[];for(var i=0;i<nu.length;i++){var f=this.data.of.getAxiomByName(nu[i]);out.push([f.name,f.label])}return out}return nu},factory:function(){var props=this.data.of.getAxiomsByClass(foam.core.Property).filter(function(p){return!p.hidden});return props.sort(function(a,b){return a.LABEL.compare(a,b)}).map(function(p){return[p.name,p.label]})}},{class:"Boolean",name:"allowDuplicateFilters",help:"When this is true, you can create multiple filters for one "+"property.",value:false},{class:"Boolean",name:"allowAddingFilters",help:"When this is true, the controls for adding new filters is shown "+"at the top. When it is false, just the CLEAR button and count are "+"present.",value:true},{class:"foam.u2.ViewSpec",name:"filterAreaSpec",value:"DIV"},{class:"Boolean",name:"textSearch",help:"Set this to true to enable freeform text search.",value:false},{class:"Function",name:"buildFilter",value:function buildFilter(args){var e=this.Card.create();e.style({"margin-bottom":"0",overflow:"visible"}).addClass(this.myClass("filter-container")).start("div").addClass(this.myClass("filter-header")).add(args.label).end().startContext({data:args.key}).add(args.showRemove?this.REMOVE_FILTER:undefined).endContext().end();e.start("div").addClass(this.myClass("filter-body")).add(args.view).end();return e}},{name:"searchMgr_",factory:function(){return this.SearchManager.create({dao$:this.data$,filteredDAO$:this.filteredDAO$})}},{class:"StringArray",name:"searchFields",factory:function(){return this.data&&this.data.of&&this.data.of.tableColumns||[]}},{name:"searchViews_",factory:function(){return{}}},{name:"search",factory:function(){var of=this.data.of;if(of.id)of=of.id;return this.TextSearchView.create({of:of,richSearch:true,keywordSearch:true})}},{name:"filtersE_"},{class:"foam.u2.ViewSpec",name:"tableView",value:{class:"foam.u2.TableView"}},{name:"table"},{name:"loaded_",value:false},["oldSearchFields_",null],["addingSpec",undefined]],methods:[function render(){var _=this.searchMgr_;this.filteredDAO$.sub(this.onPredicateChange);this.onPredicateChange();this.addClass();this.startContext({data:this});var searchPanel=this.start().addClass(this.myClass("search-panel"));var topPanel=searchPanel.start(this.addingSpec).addClass(this.myClass("adding"));if(this.allowAddingFilters){topPanel.start().addClass(this.myClass("add-filter")).start(this.ChoiceView,{data$:this.filterChoice$,choices:this.filters}).end().add(this.NEW_FILTER).end()}topPanel.start().addClass(this.myClass("count")).start("span").addClass(this.myClass("count-text")).add(this.countString$).end().start(this.CLEAR,{raised:true}).end().end();this.filtersE_=searchPanel.start(this.filterAreaSpec).addClass(this.myClass("filter-area"));this.filtersE_.end();this.endContext();searchPanel.end();this.start().addClass(this.myClass("results")).start(this.tableView,{of:this.data.of,data$:this.filteredDAO$}).end().end();var self=this;this.onload.sub(function(){if(self.textSearch){self.filtersE_.add(self.buildFilter({label:"Search",showRemove:false,view:self.search}));self.searchMgr_.add(self.search)}self.loaded_=true});this.data$.sub(this.updateSearchFields);this.loaded_$.sub(this.updateSearchFields);this.searchFields$.sub(this.updateSearchFields);this.data$proxy.on.reset.sub(this.updateCount);if(this.data)this.updateCount()},function addGroup(spec,prop,opt_map){var map=opt_map||{};map.property=prop;map.size=map.size||1;map.dao=this.data;var e=this.ViewSpec.createView(spec,map,this,this.searchMgr_);var view=this.searchMgr_.add(e);var filterView=this.buildFilter({key:view.name,label:prop.label,prop:prop,showRemove:this.allowAddingFilters,view:view});this.searchViews_[view.name]=filterView;return filterView},function renderFilter(key){this.filtersE_.add(this.searchViews_[key])},function addFilter_(name){var highestCount=0;var alreadyExists=false;for(var i=0;i<this.searchFields.length;i++){var split=this.splitName(this.searchFields[i]);if(split.count>highestCount)highestCount=split.count;if(split.name===name)alreadyExists=true}if(alreadyExists&&!this.allowDuplicateFilters)return undefined;var key=name+(highestCount===0?"":"_"+(+highestCount+1));var temp=foam.Array.clone(this.searchFields);temp.push(key);this.searchFields=temp;return key},function addFilter(name){var key=this.addFilter_(name)},function removeFilter(key){var temp=foam.Array.clone(this.searchFields);for(var i=0;i<temp.length;i++){if(temp[i]===key){temp.splice(i,1);break}}this.searchFields=temp},function splitName(key){var match=key.match(/^(.*)_(\d+)$/);return match?{name:match[1],count:match[2]}:{name:key,count:1}}],listeners:[{name:"onPredicateChange",isMerged:true,mergeDelay:250,code:function(){this.filteredDAO.select(this.Count.create()).then(function(c){this.count=c.value}.bind(this))}},{name:"updateCount",isMerged:true,mergeDelay:250,code:function(){this.data.select(this.Count.create()).then(function(c){this.totalCount=c.value}.bind(this));this.onPredicateChange()}},{name:"updateSearchFields",isMerged:true,mergeDelay:250,code:function(){if(!this.loaded_||!this.data)return;var fields=this.searchFields;var oldFields=this.oldSearchFields_;if(oldFields){for(var i=0;i<oldFields.length;i++){if(!fields||fields.indexOf(oldFields[i])<0){this.searchMgr_.remove(oldFields[i]);this.searchViews_[oldFields[i]].remove();delete this.searchViews_[oldFields[i]]}}}if(fields){for(var i=0;i<fields.length;i++){if(!oldFields||oldFields.indexOf(fields[i])<0){var split=this.splitName(fields[i]);var prop=this.data.of.getAxiomByName(split.name);var spec=prop.searchView;var options={name:fields[i]};if(prop.tableSeparator){options.split=prop.tableSeparator}this.addGroup(spec,prop,options);this.renderFilter(fields[i])}}}this.oldSearchFields_=fields}}],actions:[{name:"clear",code:function(){this.searchMgr_.clear()}},{name:"newFilter",code:function(){this.addFilter_(this.filterChoice)}}]});
foam.CLASS({package:"foam.u2.search",name:"GroupCompleter",extends:"foam.u2.Autocompleter",requires:["foam.dao.MDAO","foam.dao.ProxyDAO","foam.mlang.LabeledValue","foam.mlang.predicate.ContainsIC"],properties:["groups",{name:"dao",factory:function(){return this.ProxyDAO.create({of:this.LabeledValue,delegate$:this.innerDAO_$})}},{name:"innerDAO_",expression:function(groups){var dao=this.MDAO.create({of:this.LabeledValue});if(!groups||!groups.length)return dao;for(var i=0;i<groups.length;i++){var str=""+groups[i];if(!str)continue;dao.put(this.LabeledValue.create({id:str,label:str,value:groups[i]}))}return dao}},{name:"queryFactory",value:function(str){return this.ContainsIC.create({arg1:this.LabeledValue.LABEL,arg2:str})}},{name:"objToString",value:function(lv){return lv.value}}]});
foam.CLASS({package:"foam.u2.search",name:"GroupAutocompleteSearchView",extends:"foam.u2.View",requires:["foam.mlang.predicate.True","foam.u2.search.GroupCompleter","foam.u2.view.TextField"],properties:[{class:"String",name:"split",},{class:"foam.u2.ViewSpec",name:"viewSpec",value:{class:"foam.u2.view.TextField",onKey:true}},{name:"dao",label:"DAO",required:true,postSet:function(){this.updateDAO()}},{name:"property",required:true,postSet:function(o,property){var isIntProp=foam.core.Int.isInstance(property)||foam.core.Reference.isInstance(property)&&foam.core.Int.isInstance(property.of.ID);if(!this.op){this.op=isIntProp?foam.mlang.predicate.Eq:foam.mlang.predicate.ContainsIC}}},{name:"name",expression:function(property){return property.name}},{class:"Class",name:"op"},{name:"predicate",factory:function(){return this.True.create()}},{name:"label",expression:function(property){return property.label}},{name:"groups",},{name:"autocompleter",factory:function(){var model=this.GroupCompleter;var args={groups$:this.groups$};if(this.split){model=this.GroupSplitCompleter;args.split=this.split}return model.create(args,this)}},{name:"view"}],methods:[function clear(){this.view.data=""},function render(){this.view=this.start(this.viewSpec,{prop:this.property,label$:this.label$,alwaysFloatLabel:true,autocompleter:this.autocompleter});this.dao.on.sub(this.updateDAO);this.view.data$.sub(this.updatePredicate)}],listeners:[{name:"updateDAO",isMerged:true,mergeDelay:100,code:function(){this.dao.select(foam.mlang.sink.GroupBy.create({arg1:this.property,arg2:foam.mlang.sink.Count.create()})).then(function(groups){this.groups=groups.sortedKeys()}.bind(this))}},{name:"updatePredicate",code:function(sub,_,__,slot){var str=slot.get();this.predicate=str?this.op.create({arg1:this.property,arg2:this.property.fromString?this.property.fromString(str):str}):this.True.create()}}]});
foam.CLASS({package:"foam.u2.search",name:"GroupBySearchView",extends:"foam.u2.View",requires:["foam.dao.FnSink","foam.mlang.Constant","foam.mlang.predicate.True","foam.mlang.sink.Count","foam.mlang.sink.GroupBy","foam.u2.view.ChoiceView"],css:`
^ select {
min-width: 220px;
}
^ .foam-u2-tag-Select {
height: auto;
}
`,properties:[{name:"view"},{class:"foam.u2.ViewSpec",name:"viewSpec",value:{class:"foam.u2.view.ChoiceView"}},{class:"foam.dao.DAOProperty",name:"dao",required:true},{name:"property",required:true},{name:"name",expression:function(property){return property.name}},{class:"Class",name:"op",value:"foam.mlang.predicate.Eq"},{name:"predicate",factory:function(){return this.True.create()}},{class:"Int",name:"width",value:17},{class:"String",name:"label",expression:function(property){return property.label}},{class:"Function",name:"aFormatLabel",value:function(key){return Promise.resolve(""+key)}},"previewMode","hardData"],methods:[function clear(){this.view.data="";this.hardData=undefined},function render(){var self=this;this.addClass(this.myClass()).tag(this.viewSpec,{label$:this.label$,alwaysFloatLabel:true,dynamicSize:true,maxSize:10},this.view$).on("click",function(e){try{self.previewMode=false;var data=self.view.choices[e.target.value][0];self.hardData=data}catch(x){}}).on("mouseover",function(e){try{var data=self.view.choices[e.target.value][0];if(!self.previewMode){self.previewMode=true;self.hardData=self.view.data}self.view.data=data}catch(x){}}).on("mouseout",function(e){self.view.data=self.hardData;if(self.hardData===undefined)self.view.data=""}).onDetach(this.dao$proxy.listen(this.FnSink.create({fn:this.updateDAO})));this.updateDAO();this.view.data$.sub(this.updatePredicate)},function updatePredicate_(choice){var exists=foam.Undefined.isInstance(choice)&&choice!=="";this.predicate=exists?this.op.create({arg1:this.property,arg2:this.Constant.create({value:choice})}):this.True.create()},function formatLabels(keys){return Promise.all(keys.map(this.aFormatLabel.bind(this)))}],listeners:[{name:"updateDAO",isMerged:true,mergeDelay:100,code:function(){var self=this;this.dao.select(this.GroupBy.create({arg1:this.property,arg2:this.Count.create()})).then(function(groups){var options=[];var selected;var sortedKeys=groups.sortedKeys();self.formatLabels(sortedKeys).then(function(labels){for(var i=0;i<sortedKeys.length;i++){var key=sortedKeys[i];if(typeof key==="undefined")continue;if(key==="")continue;var count=foam.String.intern("("+groups.groups[key].value+")");var subKey=labels[i].substring(0,self.width-count.length-3);var cleanKey=foam.core.Enum.isInstance(self.property)?self.property.of[key].label:subKey.replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;");if(self.view&&self.view.data===key){selected=key}options.push([key,cleanKey+foam.String.intern(Array(self.width-subKey.length-count.length).join(" "))+count])}options.splice(0,0,["","--"]);self.view.choices=options;if(typeof selected!=="undefined"){var oldData=self.view.data;self.view.data=selected;if(typeof oldData==="undefined"||oldData===""){self.updatePredicate_(selected)}}})})}},{name:"updatePredicate",code:function(_,__,___,slot){this.updatePredicate_(slot.get())}}]});
foam.CLASS({package:"foam.u2.search",name:"SearchManager",requires:["foam.mlang.predicate.And","foam.mlang.predicate.True"],imports:["memento"],properties:[{name:"views",factory:function(){return{}}},{name:"subs_",factory:function(){return{}}},{name:"predicate",factory:function(){return foam.mlang.predicate.True.create()}},{name:"dao"},{name:"filteredDAO",expression:function(dao,predicate){if(!dao)return;var d=dao.where(predicate);this.updateViews();return d}}],methods:[function and(views){return this.And.create({args:Object.keys(views).map(function(k){return views[k].predicate}).filter(function(predicate){return predicate!==undefined})}).partialEval()},function add(view){if(this.views[view.name]){var num=2;while(this.views[view.name+"_"+num]){num++}view.name=view.name+"_"+num}this.views[view.name]=view;this.subs_[view.name]=view.predicate$.sub(this.onViewUpdate);this.onViewUpdate();return view},function remove(viewOrName){var view;var name;if(typeof viewOrName==="string"){name=viewOrName;view=this.views[viewOrName]}else{view=viewOrName;name=view.name}if(!this.views[name])return;view.clear();this.subs_[name].detach();delete this.views[name];delete this.subs_[name]},function removeAll(){this.clear();foam.Object.forEach(this.subs_,function(sub){sub.detach()});this.views={};this.subs_={}},function clear(){foam.Object.forEach(this.views,function(view){view.clear()})}],listeners:[{name:"onViewUpdate",isMerged:true,mergeDelay:250,code:function(){this.predicate=this.and(this.views);this.updateViews()}},{name:"updateViews",isMerged:true,mergeDelay:250,code:function(){foam.Object.forEach(this.views,function(view,name){var temp={};foam.Object.forEach(this.views,function(v,n){if(name===n)return;temp[n]=v});this.views[name].dao=this.dao.where(this.and(temp))}.bind(this))}}]});
foam.CLASS({package:"foam.u2.search",name:"TextSearchView",extends:"foam.u2.View",requires:["foam.parse.QueryParser","foam.u2.tag.Input"],implements:["foam.mlang.Expressions"],messages:[{name:"LABEL_SEARCH",message:"Search"}],properties:[{class:"Class",name:"of"},{class:"Boolean",name:"richSearch",value:true},{class:"Boolean",name:"keywordSearch"},{class:"Boolean",name:"checkStrictEquality",},{name:"queryParser",factory:function(){return this.QueryParser.create({of:this.of})}},{class:"Int",name:"width",value:60},"property",{name:"predicate",factory:function(){return this.TRUE}},{class:"foam.u2.ViewSpec",name:"viewSpec",value:{class:"foam.u2.SearchField"}},{name:"view"},{name:"label",expression:function(property){return property&&property.label?property.label:this.LABEL_SEARCH}},{name:"name",value:"textSearchView"},{class:"Boolean",name:"onKey"},{class:"String",name:"searchData"}],methods:[function render(){this.addClass(this.myClass()).tag(this.viewSpec,{alwaysFloatLabel:true,label$:this.label$,ariaLabel$:this.label$,onKey:this.onKey,mode$:this.mode$},this.view$);this.view.data$.sub(this.updateValue);if(this.searchData){this.view.data=this.searchData}this.updateValue()},function clear(){this.view.data="";this.predicate=this.TRUE}],listeners:[{name:"updateValue",isMerged:true,mergeDelay:500,code:function(){var value=this.searchData=this.view.data;this.predicate=!value?this.True.create():this.richSearch?this.OR(this.queryParser.parseString(value)||this.FALSE,this.KEYWORD(value)):this.checkStrictEquality?this.EQ(this.property,value):this.CONTAINS_IC(this.property,value)}}]});
foam.CLASS({package:"foam.u2.search",name:"IntegerSearchView",extends:"foam.u2.Controller",requires:["foam.mlang.predicate.True","foam.u2.view.ChoiceView"],messages:[{name:"LABEL_EQ",message:"is equal to"},{name:"LABEL_NEQ",message:"is not equal to"},{name:"LABEL_GT",message:"is greater than"},{name:"LABEL_LT",message:"is less than"},{name:"LABEL_GTE",message:"is greater than or equal to"},{name:"LABEL_LTE",message:"is less than or equal to"}],properties:[{name:"property",required:true},{class:"String",name:"qualifier",},{class:"Float",name:"amount",view:{class:"foam.u2.FloatView",onKey:true,step:1}},{name:"predicate",expression:function(qualifier,amount){if(qualifier){return foam.mlang.predicate[qualifier].create({arg1:this.property,arg2:amount})}return this.True.create()}},{name:"name",value:"integer search view"}],methods:[function restoreFromPredicate(predicate){if(predicate===this.TRUE)return;this.qualifier=predicate.cls_.name;this.amount=predicate.arg2.value},function render(){this.addClass(this.myClass()).start(this.ChoiceView,{data$:this.qualifier$,choices:[["True","--"],["Eq",this.LABEL_EQ],["Neq",this.LABEL_NEQ],["Gt",this.LABEL_GT],["Lt",this.LABEL_LT],["Gte",this.LABEL_GTE],["Lte",this.LABEL_LTE]],defaultValue:"True"}).start("div").addClass(this.myClass("carrot")).end().end().add(this.AMOUNT)},function clear(){this.qualifier="True";this.value=0}],css:`
^ {
display: flex;
justify-content: center;
width: 100%;
}
^ > * + * {
margin-left: 13px;
}
^ .property-qualifier {
position: relative;
}
^carrot {
border-left: 5px solid transparent;
border-right: 5px solid transparent;
border-top: 5px solid black;
position: absolute;
right: 8px;
top: 18px;
z-index: 1;
}
^ .foam-u2-tag-Select {
background-color: /*%WHITE%*/ #ffffff;
border-radius: 2px;
border: 1px solid #dce0e7;
color: /*%BLACK%*/ #1e1f21;
padding: 0 20px 0 8px;
-webkit-appearance: none; /* Fix rounded corners in Chrome on OS X */
}
^ .foam-u2-FloatView {
border-radius: 2px;
border: 1px solid #dce0e7;
color: /*%BLACK%*/ #1e1f21;
font-size: 1.4rem;
height: 40px;
padding: 0 14px 0 21px;
width: 92px;
}
`});
foam.CLASS({package:"foam.u2.search",name:"FloatSearchView",extends:"foam.u2.search.IntegerSearchView",properties:[{class:"Float",name:"amount",view:{class:"foam.u2.FloatView",onKey:true,precision:2}},{name:"name",value:"float search view"}]});
foam.CLASS({package:"foam.u2.search",name:"CurrencySearchView",extends:"foam.u2.search.FloatSearchView",properties:[{name:"predicate",expression:function(qualifier,amount){amount=typeof amount==="number"?Math.floor(amount*100):0;if(qualifier){return foam.mlang.predicate[qualifier].create({arg1:this.property,arg2:amount})}return this.True.create()}},{name:"name",value:"currency search view"}],methods:[function restoreFromPredicate(predicate){if(predicate===this.TRUE)return;this.qualifier=predicate.cls_.name;this.amount=typeof predicate.arg2.value==="number"?predicate.arg2.value/100:0}]});
foam.CLASS({package:"foam.u2.search",name:"DateSearchView",extends:"foam.u2.Controller",properties:[{name:"property",required:true},{class:"String",name:"qualifier",view:{class:"foam.u2.view.ChoiceView",choices:[["True","--"],["Gt","after"],["Lt","before"]],defaultValue:"True"}},{class:"Date",name:"date",},{name:"predicate",expression:function(qualifier,date){if(qualifier.length>0&&date&&!isNaN(date.valueOf())){return foam.mlang.predicate[qualifier].create({arg1:this.property,arg2:new Date(date)})}return foam.mlang.predicate.True.create()}},{name:"name",value:"currency search view"}],methods:[function render(){this.addClass(this.myClass()).start(this.QUALIFIER).start("div").addClass(this.myClass("carrot")).end().end().add(this.DATE)},function clear(){this.qualifier="True"}],css:`
^ {
display: flex;
justify-content: center;
width: 100%;
}
^ > * + * {
margin-left: 13px;
}
^ .property-qualifier {
flex-grow: 2;
position: relative;
}
^carrot {
border-left: 5px solid transparent;
border-right: 5px solid transparent;
border-top: 5px solid black;
position: absolute;
right: 8px;
top: 18px;
z-index: 1;
}
^ input, ^ select {
background-color: /*%WHITE%*/ #ffffff;
border-radius: 2px;
border: 1px solid #dce0e7;
color: /*%BLACK%*/ #1e1f21;
height: 40px;
padding: 0 8px;
}
^ .foam-u2-tag-Select {
padding: 0 20px 0 8px;
width: 100%;
-webkit-appearance: none; /* Fix rounded corners in Chrome on OS X */
}
`});
foam.CLASS({package:"foam.u2.search",name:"Toolbar",extends:"foam.u2.View",css:`
^ {
display: none;
}
`,properties:[{class:"FObjectProperty",of:"foam.mlang.predicate.Predicate",name:"data",factory:function(){return foam.mlang.predicate.True.create()}},{class:"String",name:"search",label:"Search",view:{class:"foam.u2.TextField"},maxLength:0}],methods:[function render(){this.SUPER();this.addClass().startContext({controllerMode:foam.u2.ControllerMode.EDIT}).tag({class:"foam.u2.PropertyBorder",data:this,prop:this.SEARCH}).endContext()}]});
foam.CLASS({package:"foam.u2.stack",name:"Stack",requires:["foam.nanos.controller.Memento","foam.u2.stack.StackBlock"],constants:[{name:"BCRMB_ID",value:"b"},{name:"ACTION_ID",value:"a"}],properties:[{class:"FObjectArray",of:"foam.u2.stack.StackBlock",name:"stack_",hidden:true,factory:function(){return[]}},{class:"Int",name:"depth",value:0},{class:"Int",name:"pos",value:-1,preSet:function(_,p){if(isNaN(p)||p>this.depth)return this.depth-1;if(p<0)return 0;return p}},{class:"FObjectProperty",of:"foam.u2.stack.StackBlock",name:"top",hidden:true,expression:function(pos){return this.stack_[pos]||null}},{class:"foam.u2.ViewSpec",name:"topNonPopup",hidden:true,expression:function(pos){while(pos>=0&&this.stack_[pos].popup)pos--;return this.stack_[pos]||null}},{class:"Int",name:"navStackBottom",value:-1,preSet:function(_,p){if(isNaN(p)||p>this.depth||p<0)return 0;return p}}],methods:[function slotAt(i){return this.StackSlot.create({pos:i,stack:this})},function at(i){return i<0?this.stack_[this.pos+i+1]:this.stack_[i]},function push(block){if(!foam.u2.stack.StackBlock.isInstance(block)){console.warn("This function has been changed. Please pass in a StackBlock FObject");block=this.StackBlock.create({view:arguments[0],parent:arguments[1],id:arguments[2],shouldResetBreadcrumbs:arguments[3]&&arguments[3].menuItem,popup:arguments[3]&&arguments[3].popup,breadcrumbTitle:arguments[3]&&arguments[3].navStackTitle})}if(this.top&&block.id&&this.top.id==block.id)return;if(foam.u2.Element.isInstance(block.view)){console.warn("Views are not recommended to be pushed to a stack. Please use a viewSpec.")}var pos=this.pos+1;this.depth=pos+1;this.stack_.length=this.depth;this.stack_[pos]=block;if(pos>0&&ctrl.memento_&&block.parent?.memento_){this.stack_[pos-1].currentMemento=ctrl.memento_.toString(null,block.parent.memento_);ctrl.memento_.usedStr=ctrl.memento_.toString()}this.pos=pos;if(block.shouldResetBreadcrumbs)this.navStackBottom=pos},function jump(jumpPos){while(this.pos>jumpPos){this.stack_[this.pos].removed.pub();this.pos--}if(this.navStackBottom>this.pos){for(var i=this.pos;i>=0;i--){if(this.stack_[i].shouldResetBreadcrumbs){this.navStackBottom=i;break}}}},function getContextFromParent(parent,ctx){ctx=ctx||this;if(!parent)return ctx.__subSubContext__;if(parent.isContext)return parent;if(parent.__subContext__)return parent.__subContext__;console.warn("parent is neither an element nor a context");return ctx.__subSubContext__.createSubContext(parent)}],actions:[{name:"back",isEnabled:function(pos){return pos>0},code:function(X){this.jump(this.pos-1,X)}},{name:"forward",isEnabled:function(pos,depth){return pos<depth-1},code:function(){this.pos++}}],classes:[{name:"StackSlot",implements:["foam.core.Slot"],properties:[{name:"stack"},{class:"Int",name:"pos"}],methods:[function init(){this.onDetach(this.stack.pos$.sub(this.onStackChange))},function get(){return this.stack.at(this.pos)},function set(){},function sub(l){return this.SUPER("update",l)},function toString(){return"StackSlot("+this.pos+")"}],listeners:[function onStackChange(s){if(this.pos<0||this.pos===this.stack.pos){this.pub("update")}}]}]});
foam.CLASS({package:"foam.u2.stack",name:"StackView",extends:"foam.u2.View",requires:["foam.nanos.controller.Memento","foam.u2.stack.Stack"],imports:["ctrl"],exports:["data as stack"],properties:[{name:"data",factory:function(){return this.Stack.create()}},{class:"Boolean",name:"showActions",value:true}],css:"%CUSTOMCSS%",methods:[function init(){this.addClass();this.addClass("foam-u2-stack-StackView");if(this.showActions){this.start("actions").add(this.data.cls_.getAxiomsByClass(foam.core.Action)).end()}this.listenStackView()},function listenStackView(){this.add(this.slot(s=>this.renderStackView(s),this.data$.dot("top")))},function renderStackView(s,opt_popup){if(!s)return this.E("span");var view=s.view;var parent=s.parent;var X=opt_popup?opt_popup.__subContext__:this.data.getContextFromParent(parent,this);var v;var ctrlMem=this.ctrl.memento_;if(s.currentMemento){this.ctrl.window.location="#"+s.currentMemento;v=foam.u2.ViewSpec.createView(view,null,this,X);console.log("setting memento",s.currentMemento)}else{v=foam.u2.ViewSpec.createView(view,null,this,X)}if(v.viewTitle$||v.children[0]?.viewTitle$){this.data.top.breadcrumbTitle$.follow(v.viewTitle$||v.children[0].viewTitle$)}return v},function shouldMementoValueBeChanged(mementoValue,mementoHead){if(!mementoValue)return false;return!decodeURI(mementoValue).includes(mementoHead)}]});
foam.CLASS({package:"foam.u2.stack",name:"DesktopStackView",extends:"foam.u2.stack.StackView",requires:["foam.nanos.controller.Memento","foam.u2.dialog.Popup","foam.u2.stack.Stack"],properties:[{name:"popupsOpened",factory:()=>({})}],css:"%CUSTOMCSS%",methods:[function listenStackView(){var self=this;this.data$.dot("top").sub(()=>{var top=this.data.top;var pos=this.data.pos;if(this.popupsOpened[pos+1]){let popup=this.popupsOpened[pos+1];delete this.popupsOpened[pos+1];popup.close()}if(top.popup&&!this.popupsOpened[pos]){let cls=this.__subContext__.lookup(top.popup.class)||foam.u2.dialog.Popup;let X=this.data.getContextFromParent(top.parent,this);let popup=cls.create({...top.popup},X);popup.sub("action","closeModal",()=>{if(this.popupsOpened[pos]){delete this.popupsOpened[pos];this.data.back()}});popup.add(this.renderStackView(top,popup));this.popupsOpened[pos]=popup;ctrl.add(popup)}});this.add(this.slot(s=>self.renderStackView(s),this.data$.dot("topNonPopup")))}]});
foam.CLASS({package:"foam.u2.stack",name:"BreadcrumbView",extends:"foam.u2.View",imports:["stack"],requires:["foam.core.Action","foam.u2.view.OverlayActionListView"],css:`
^display {
align-items: center;
display: flex;
flex-wrap: wrap;
}
^slash{
padding: 8px;
vertical-align: middle;
}
^breadCrumb > * {
overflow: hidden;
text-overflow: ellipsis;
white-space: nowrap;
}
`,properties:[{name:"maxHead",value:3},{name:"maxTail",value:3},{name:"collapseBreakpoint",factory:function(){return this.maxHead+this.maxTail+1}},{class:"FObjectArray",of:"foam.core.Action",name:"actionArray"}],methods:[function render(){this.SUPER();var self=this;this.addClass(this.myClass("display"));if(this.stack&&this.stack.stack_){var navStack=this.stack.stack_.slice(this.stack.navStackBottom,this.stack.pos);var themeIcon=navStack.length==1?"back":"";navStack.map((v,i)=>{var index=i+this.stack.navStackBottom;var jumpAction=self.Action.create({name:"back",code:()=>{self.stack.jump(index,self)}});var labelSlot=this.stack.stack_[index].breadcrumbTitle$;jumpAction.label$=labelSlot;if(navStack.length<=self.collapseBreakpoint||i<self.maxHead||i>=navStack.length-self.maxTail){self.start(jumpAction,{themeIcon:themeIcon,buttonStyle:"LINK",size:"SMALL"}).show(labelSlot).addClass(this.myClass("breadCrumb")).end()}else if(i==self.maxHead){self.tag(this.OverlayActionListView,{label:"...",data$:self.actionArray$,obj:self,buttonStyle:"LINK",showDropdownIcon:false});self.actionArray.push(jumpAction)}else{self.actionArray.push(jumpAction)}self.callIf(navStack.length!=1&&(i<=self.maxHead||i>=navStack.length-self.maxTail),()=>{self.start("span").addClass(this.myClass("slash")).show(labelSlot).add("/").end()});if(!this.stack.stack_[index].breadcrumbTitle)console.warn("Missing Title for BreadcrumbView "+navStack[i].view)})}}]});
foam.CLASS({package:"foam.u2.stack",name:"StackBlock",flags:["web"],topics:["removed"],properties:[{class:"foam.u2.ViewSpec",name:"view"},{name:"parent"},{name:"id",},{class:"String",name:"breadcrumbTitle",},{class:"Boolean",name:"shouldResetBreadcrumbs",},{name:"popup",},{name:"currentMemento"}]});
foam.CLASS({package:"foam.u2.crunch",name:"Style",extends:"foam.u2.View",css:`
^ {
padding: 8px 12px 8px 12px;
width: 216px;
height: auto;
border: 1px solid rgba(255,255,255,0);
/* width is calculated width from ^cardpart plus 4 pixels */
width: calc(254px - (2*24px)/3);
/* Card highlight transition */
transition: background 200ms ease-in, border 200ms ease-in;
-webkit-transition: background 200ms ease-in, border 200ms ease-in;
-moz-transition: background 200ms ease-in, border 200ms ease-in;
}
^cardpart {
display: inline-block;
/* width: 272px;
/* height: 153px;
/**/
width: calc(250px - (2*24px)/3);
height: 132px;
margin-bottom: 15px;
/* Calculated 86% for this but 103% renders correctly */
background-size: 103%;
background-repeat: no-repeat;
border-radius: 3px;
box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.08);
border: solid 1px #e7eaec;
background-color: /*%WHITE%*/ #ffffff;
background-position: 50% 50%;
}
^card-title {
margin: 0;
min-height: 20px;
font-size: 1.6rem;
font-weight: 600;
font-style: normal;
font-stretch: normal;
line-height: 1.25;
letter-spacing: normal;
color: /*%BLACK%*/ #1e1f21;
}
^card-subtitle {
margin: 0;
font-size: 1.1rem;
font-weight: normal;
font-stretch: normal;
line-height: 1.27;
letter-spacing: normal;
color: #9ba1a6;
}
^card-description {
margin-top: 9px;
font-size: 1.4rem;
font-weight: normal;
font-style: normal;
font-stretch: normal;
line-height: 1.43;
letter-spacing: normal;
color: #5e6061;
cursor: pointer;
/* normalize for transitions */
border: solid 1px rgba(255,255,255,0);
/* Card highlight transition */
transition: background 200ms ease-in, border 200ms ease-in;
-webkit-transition: background 200ms ease-in, border 200ms ease-in;
-moz-transition: background 200ms ease-in, border 200ms ease-in;
}
^.state-hover {
cursor: pointer;
}
^mode-card.state-hover {
background-color: rgba(255,255,255,0.5);
border: solid 1px #e7eaec;
}
^mode-card.state-hover ^card-description {
position: relative;
left: -15px;
width: calc(250px - (2*24px)/3 + 30px);
}
^mode-circle.state-hover ^card-description {
width: auto;
height: auto;
}
^icon-circle {
display: inline-block;
width: 80px;
height: 80px;
border-radius: 40px;
box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.08);
background-color: /*%WHITE%*/ #ffffff;
}
^mode-card {
}
^mode-circle {
display: flex;
align-items: center;
padding: 24px;
width: 100%;
height: 100%;
background-color: /*%WHITE%*/ #ffffff;
border: 2px solid #f3f3f3;
border-radius: 5px;
box-sizing: border-box;
transition: all 0.3s ease-out;
}
^mode-circle::not(:first-of-type) {
margin-left: 14px;
}
^mode-circle:hover {
-webkit-box-shadow: 0 10px 6px -6px #e0e0e0;
-moz-box-shadow: 0 10px 6px -6px #e0e0e0;
box-shadow: 0 10px 6px -6px #e0e0e0;
border-color: white;
}
^badge {
height: 24px;
border-radius: 12px;
width: 79px;
padding: 0 8px;
background-color: #b5b5b5;
font-size: 1rem;
font-weight: 500;
font-style: normal;
font-stretch: normal;
line-height: 24px;
letter-spacing: normal;
text-align: center;
color: #ffffff;
}
^badge-neutral {
background-color: #b5b5b5;
}
^badge-good {
background-color: #32bf5e;
}
^badge-info {
background-color: #604aff;
}
^badge-bad {
background-color: #bf3232;
}
^renewable-description {
height: 24px;
padding: 2px 8px;
background-color: /*%WHITE%*/ #ffffff;
font-size: 1rem;
font-weight: 500;
font-style: normal;
font-stretch: normal;
color: /*%BLACK%*/ #1e1f21;
line-height: 24px;
letter-spacing: normal;
text-align: center;
opacity: 80%;
width: -moz-available;
width: -webkit-fill-available;
width: fill-available;
}
^category {
display: inline-block;
padding: 0;
}
^category:not(:last-child) {
margin-right: 8px;
}
^tooltip {
position: absolute;
bottom: 12px;
}
^tooltip ^tooltiptext {
visibility: hidden;
width: max-content;
max-width: 300%;
background-color: #555;
color: #f3f3f3;
text-align: left;
border-radius: 5px;
padding: 16px;
font-size: 1.2rem;
position: absolute;
z-index: 101;
bottom: -115%;
right: calc(100% + 16px);
opacity: 0;
transition: opacity 0.3s;
-webkit-box-shadow: 0 10px 6px -6px #e0e0e0;
-moz-box-shadow: 0 10px 6px -6px #e0e0e0;
box-shadow: 0 10px 6px -6px #e0e0e0;
}
^tooltip ^tooltiptext::after {
content: "";
position: absolute;
top: 50%;
left: 100%;
margin-top: -8px;
border-width: 8px;
border-style: solid;
border-color: transparent transparent transparent #555;
}
^tooltiptext^tooltip-bottom {
max-width: 200%;
top: calc(100% + 16px);
bottom: auto;
right: 0;
}
^tooltip ^tooltiptext^tooltip-bottom::after {
top: 0;
right: 17%;
left: auto;
margin-top: -16px;
border-color: transparent transparent #555 transparent;
}
^tooltip:hover ^tooltiptext {
visibility: visible;
opacity: 1;
}
^tooltiptext^tooltipDisabled {
visibility: hidden !important;
}
`,methods:[function addBinds(subj){subj.on("mouseover",function(){subj.addClass("state-hover")});subj.on("mouseout",function(){subj.removeClass("state-hover")});return subj}]});
foam.CLASS({package:"foam.u2.crunch",name:"CrunchController",implements:["foam.mlang.Expressions"],imports:["capabilityDAO","capabilityCategoryDAO","crunchService","ctrl","stack","subject","userCapabilityJunctionDAO","translationService"],requires:["foam.log.LogLevel","foam.nanos.crunch.AgentCapabilityJunction","foam.nanos.crunch.UserCapabilityJunction","foam.u2.crunch.wizardflow.CapabilityAdaptAgent","foam.u2.crunch.wizardflow.CheckRootIdAgent","foam.u2.crunch.wizardflow.GrantedEditAgent","foam.u2.crunch.wizardflow.CheckPendingAgent","foam.u2.crunch.wizardflow.CheckNoDataAgent","foam.u2.crunch.wizardflow.LoadCapabilitiesAgent","foam.u2.crunch.wizardflow.CreateWizardletsAgent","foam.u2.crunch.wizardflow.LoadWizardletsAgent","foam.u2.crunch.wizardflow.FilterWizardletsAgent","foam.u2.crunch.wizardflow.FilterGrantModeAgent","foam.u2.crunch.wizardflow.WizardStateAgent","foam.u2.crunch.wizardflow.RequirementsPreviewAgent","foam.u2.crunch.wizardflow.AutoSaveWizardletsAgent","foam.u2.crunch.wizardflow.PutFinalJunctionsAgent","foam.u2.crunch.wizardflow.PutFinalPayloadsAgent","foam.u2.crunch.wizardflow.TestAgent","foam.u2.crunch.wizardflow.LoadTopConfig","foam.u2.crunch.wizardflow.CapableDefaultConfigAgent","foam.u2.crunch.wizardflow.SkipGrantedAgent","foam.u2.crunch.wizardflow.MaybeDAOPutAgent","foam.u2.crunch.wizardflow.ShowPreexistingAgent","foam.u2.crunch.wizardflow.SaveAllAgent","foam.u2.crunch.wizardflow.SubmitAgent","foam.u2.crunch.wizardflow.CapabilityStoreAgent","foam.u2.crunch.wizardflow.DebugContextInterceptAgent","foam.u2.crunch.wizardflow.DebugAgent","foam.u2.crunch.wizardflow.WAOSettingAgent","foam.u2.crunch.wizardflow.lite.CheckGrantedAgent","foam.u2.wizard.agents.ConfigureFlowAgent","foam.u2.wizard.agents.DeveloperModeAgent","foam.u2.wizard.agents.StepWizardAgent","foam.u2.wizard.agents.CreateControllerAgent","foam.u2.wizard.agents.DetachAgent","foam.u2.wizard.agents.SpinnerAgent","foam.u2.wizard.agents.DetachSpinnerAgent","foam.util.async.Sequence","foam.u2.borders.SpacingBorder","foam.u2.crunch.CapabilityInterceptView","foam.u2.dialog.Popup"],properties:[{name:"activeIntercepts",class:"Array",},{class:"Map",name:"capabilityCache",factory:function(){return new Map}},{class:"Boolean",name:"debugMode",factory:function(){return false}}],methods:[{name:"createWizardSequence",code:function createWizardSequence(capabilityOrId,x){if(!x)x=this.__subContext__;var self=this;return this.Sequence.create(null,x.createSubContext({rootCapability:capabilityOrId})).add(this.DeveloperModeAgent).add(this.ConfigureFlowAgent).add(this.CapabilityAdaptAgent).add(this.LoadTopConfig).add(this.GrantedEditAgent).add(this.LoadCapabilitiesAgent).add(this.WAOSettingAgent).add(this.CheckRootIdAgent).add(this.CheckPendingAgent).add(this.CheckNoDataAgent).add(this.CreateWizardletsAgent).add(this.WizardStateAgent).add(this.FilterGrantModeAgent).add(this.LoadWizardletsAgent).add(this.SkipGrantedAgent).add(this.RequirementsPreviewAgent).add(this.AutoSaveWizardletsAgent).callIf(this.debugMode,function(){this.add(self.DebugAgent)}).add(this.CreateControllerAgent).add(this.StepWizardAgent).add(this.DetachAgent).add(this.SpinnerAgent).add(this.SaveAllAgent).add(this.SubmitAgent).add(this.DetachSpinnerAgent).add(this.CapabilityStoreAgent)}},{name:"createCapableWizardSequence",code:function createCapableWizardSequence(intercept,capable,capabilityId,x){x=x||this.__subContext__;x=x.createSubContext({intercept:intercept,capable:capable});return this.createWizardSequence(capabilityId,x).reconfigure("WAOSettingAgent",{waoSetting:this.WAOSettingAgent.WAOSetting.CAPABLE}).remove("SkipGrantedAgent").remove("CheckRootIdAgent").remove("CheckPendingAgent").remove("CheckNoDataAgent").addBefore("LoadTopConfig",this.CheckGrantedAgent).addBefore("RequirementsPreviewAgent",this.ShowPreexistingAgent).add(this.MaybeDAOPutAgent)}},{name:"createTransientWizardSequence",code:function createTransientWizardSequence(x){const capable=foam.nanos.crunch.lite.BaseCapable.create();x=x||this.__subContext__;x=x.createSubContext({capable:capable});return this.createWizardSequence("no-capability-id",x).reconfigure("WAOSettingAgent",{waoSetting:this.WAOSettingAgent.WAOSetting.CAPABLE}).remove("SkipGrantedAgent").remove("CheckRootIdAgent").remove("CheckPendingAgent").remove("CheckNoDataAgent").remove("AutoSaveWizardletsAgent").remove("SaveAllAgent").remove("WizardStateAgent").remove("FilterGrantModeAgent").remove("GrantedEditAgent").remove("CapabilityStoreAgent").addBefore("RequirementsPreviewAgent",this.ShowPreexistingAgent).add(this.MaybeDAOPutAgent)}},function wizardSequenceToViewSequence_(sequence){return sequence.remove("WizardStateAgent").remove("FilterGrantModeAgent").remove("SkipGrantedAgent").remove("RequirementsPreviewAgent").remove("CreateControllerAgent").remove("StepWizardAgent").remove("MaybeDAOPutAgent").remove("PutFinalPayloadsAgent").remove("CheckRootIdAgent").remove("CheckPendingAgent").remove("CheckNoDataAgent")},function createCapableViewSequence(capable,x){return this.wizardSequenceToViewSequence_(this.createCapableWizardSequence(undefined,capable,x)).add(this.SaveAllAgent)},function createCapabilityViewSequence(capabilityOrId,x){return this.wizardSequenceToViewSequence_(this.createWizardSequence(capabilityOrId,x)).add(this.SaveAllAgent)},function handleIntercept(intercept){var self=this;intercept.capabilities.forEach(c=>{self.capabilityCache.set(c,false)});let p=Promise.resolve();if(intercept.capabilities.length>1){p=p.then(()=>{return self.maybeLaunchInterceptView(intercept)})}else if(intercept.capabilities.length>0){p=p.then(()=>{return self.createWizardSequence(intercept.capabilities[0]).execute()})}let isCapable=intercept.capables.length>0;if(isCapable){p=p.then(x=>{if(!x||x.submitted){return self.launchCapableWizard(intercept)}return x})}p=p.then(x=>{var isCompleted=x.submitted||x.cancelled;if(isCapable){intercept.capables[0].isWizardIncomplete=!isCompleted;if(!isCompleted){intercept.resolve(intercept.capables[0]);return}intercept.returnCapable.isWizardIncomplete=!isCompleted;intercept.resolve(intercept.returnCapable);return}intercept.resend()});p.catch(err=>{console.error(err);if(err&&err.data&&err.data.id=="foam.core.ClientRuntimeException"&&err.data.exception.cause_){err.data.message=this.translationService.getTranslation(foam.locale,`${err.data.exception.cause_}`,err.data.message)}intercept.reject(err.data)});return p},function maybeLaunchInterceptView(intercept){this.activeIntercepts=this.activeIntercepts.filter(ic=>{return!ic.aquired&&!ic.cancelled});for(let i=0;i<this.activeIntercepts.length;i++){let activeIntercept=this.activeIntercepts[i];let hasAllOptions=true;activeIntercept.capabilities.forEach(capOpt=>{if(!intercept.capabilities.includes(capOpt)){hasAllOptions=false}});if(hasAllOptions){return activeIntercept.promise}}this.activeIntercepts.push(intercept);return new Promise((resolve,_)=>{this.ctrl.add(this.Popup.create({closeable:false}).tag(this.CapabilityInterceptView,{data:intercept,onClose:x=>{x.closeDialog();resolve(x)}}))})},function purgeCachedCapabilityDAOs(){this.capabilityDAO.cmd_(this,foam.dao.DAO.PURGE_CMD);this.capabilityDAO.cmd_(this,foam.dao.DAO.RESET_CMD);this.capabilityCategoryDAO.cmd_(this,foam.dao.DAO.PURGE_CMD);this.capabilityCategoryDAO.cmd_(this,foam.dao.DAO.RESET_CMD);this.userCapabilityJunctionDAO.cmd_(this,foam.dao.DAO.PURGE_CMD);this.userCapabilityJunctionDAO.cmd_(this,foam.dao.DAO.RESET_CMD)},function launchCapableWizard(intercept){var p=Promise.resolve(true);intercept.capables.forEach(capable=>{capable.capabilityIds.forEach(c=>{var seq=this.createCapableWizardSequence(intercept,capable,c);p=p.then(()=>{return seq.execute().then(x=>x)})})});return p}]});
foam.CLASS({package:"foam.u2.crunch",name:"UCJReferenceView",extends:"foam.u2.View",implements:["foam.mlang.Expressions"],imports:["capabilityDAO","crunchController","userCapabilityJunctionDAO"],requires:["foam.nanos.crunch.ui.UCJView","foam.nanos.crunch.Capability","foam.nanos.crunch.UserCapabilityJunction","foam.nanos.crunch.AgentCapabilityJunction","foam.u2.crunch.wizardflow.ApprovalRequestAgent","foam.u2.crunch.wizardflow.LoadCapabilitiesAgent","foam.u2.stack.Stack","foam.u2.stack.StackView"],css:`
^ .foam-u2-stack-StackView {
padding-left: 0px;
}
`,properties:[{name:"localStack",factory:function(){return this.Stack.create()}},{name:"ucj",transient:true},{name:"ucjPropertyList",class:"FObjectArray",of:"foam.nanos.crunch.UserCapabilityJunction",transient:true,},{name:"capabilitiesList",class:"FObjectArray",of:"foam.nanos.crunch.Capability",transient:true,}],methods:[async function render(){this.add(this.slot(async function(ucjPropertyList){var ucj=await ucjPropertyList.filter(u=>this.AgentCapabilityJunction.isInstance(u));this.capabilitiesList=(await this.capabilityDAO.where(this.AND(this.IN(this.Capability.ID,this.ucjPropertyList.map(u=>u.targetId)),this.NEQ(this.Capability.OF,null))).select()).array;return this.UCJView.create({isSettingCapabilities:true,data:ucj.length>0?ucj[0]:ucjPropertyList[0],mode:this.mode,capabilitiesList:this.capabilitiesList})}));this.ucjPropertyList=(await this.userCapabilityJunctionDAO.where(this.data).select()).array}]});
foam.CLASS({package:"foam.u2.crunch.wizardflow",name:"CapabilityAdaptAgent",implements:["foam.core.ContextAgent"],imports:["rootCapability as unadaptedRootCapability","capabilityDAO"],exports:["rootCapability"],properties:[{name:"rootCapability",class:"FObjectProperty",of:"foam.nanos.crunch.Capability"}],methods:[async function execute(){if(typeof this.unadaptedRootCapability=="string"){this.rootCapability=await this.capabilityDAO.find(this.unadaptedRootCapability);return}this.rootCapability=this.unadaptedRootCapability}]});
foam.CLASS({package:"foam.u2.crunch.wizardflow",name:"CheckRootIdAgent",imports:["rootCapability","sequence"],implements:["foam.core.ContextAgent","foam.mlang.Expressions"],properties:[{class:"StringArray",name:"rootIdsBlacklist",factory:function(){return["554af38a-8225-87c8-dfdf-eeb15f71215f-20"]}}],methods:[async function execute(){if(this.rootIdsBlacklist.includes(this.rootCapability.id)){this.sequence.endSequence();return}}]});
foam.CLASS({package:"foam.u2.crunch.wizardflow",name:"CheckPendingAgent",implements:["foam.core.ContextAgent","foam.mlang.Expressions"],imports:["capabilities","crunchService","ctrl","rootCapability","sequence"],exports:["cancelled"],requires:["foam.log.LogLevel","foam.nanos.crunch.AgentCapabilityJunction","foam.nanos.crunch.CapabilityJunctionStatus"],properties:[{name:"cancelled",class:"Boolean"},{name:"showToast",class:"Boolean"}],messages:[{name:"CANNOT_OPEN_GRANTED",message:"This capability has already been granted to you"},{name:"CANNOT_OPEN_PENDING_TITLE",message:"Pending Approval"},{name:"CANNOT_OPEN_PENDING",message:"Updates are not permitted at this time"},{name:"CANNOT_OPEN_ACTION_PENDING_TITLE",message:"Pending Review"}],methods:[async function execute(){var ucj=await this.crunchService.getJunction(null,this.rootCapability.id);var shouldReopen=false;if(ucj.status!==this.CapabilityJunctionStatus.AVAILABLE){var statusPending=ucj.status===this.CapabilityJunctionStatus.PENDING;var shouldReopen=await this.crunchService.maybeReopen(this.ctrl.__subContext__,ucj.targetId);if(!shouldReopen){if(this.showToast){statusPending?this.ctrl.notify(this.CANNOT_OPEN_PENDING_TITLE,this.CANNOT_OPEN_PENDING,this.LogLevel.WARN,true):this.ctrl.notify(this.CANNOT_OPEN_GRANTED,"",this.LogLevel.INFO,true)}this.cancelled=true;this.sequence.endSequence();return}else{if(this.showToast&&this.capabilities.length<1){this.ctrl.notify(this.CANNOT_OPEN_ACTION_PENDING_TITLE,this.CANNOT_OPEN_PENDING,this.LogLevel.WARN,true);this.cancelled=true;this.sequence.endSequence();return}}}}]});
foam.CLASS({package:"foam.u2.crunch.wizardflow",name:"GrantedEditAgent",implements:["foam.core.ContextAgent"],imports:["crunchService","rootCapability","sequence"],requires:["foam.nanos.crunch.CapabilityJunctionStatus","foam.u2.crunch.wizardflow.ApprovalRequestAgent","foam.u2.crunch.wizardflow.LoadCapabilitiesAgent","foam.u2.crunch.wizardflow.WAOSettingAgent","foam.u2.crunch.wizardflow.SkipMode"],properties:[{name:"subject",class:"FObjectProperty",of:"foam.nanos.auth.Subject",}],methods:[async function execute(){var ucj=this.subject?await this.crunchService.getJunctionFor(null,this.rootCapability.id,this.subject.user,this.subject.realUser):await this.crunchService.getJunction(null,this.rootCapability.id);var isRenewable=await this.crunchService.isRenewable(this.__subContext__,this.rootCapability.id);if(ucj.status===this.CapabilityJunctionStatus.GRANTED){if(isRenewable){this.sequence.reconfigure("SkipGrantedAgent",{mode:this.SkipMode.HIDE}).remove("AutoSaveWizardletsAgent").remove("WizardStateAgent");return}this.sequence.reconfigure("WAOSettingAgent",{waoSetting:this.WAOSettingAgent.WAOSetting.APPROVAL}).remove("LoadTopConfig").remove("CheckPendingAgent").remove("CheckNoDataAgent").remove("SkipGrantedAgent").remove("WizardStateAgent")}}]});
foam.CLASS({package:"foam.u2.crunch.wizardflow",name:"CheckNoDataAgent",implements:["foam.core.ContextAgent","foam.mlang.Expressions"],imports:["crunchService","rootCapability","sequence"],exports:["submitted"],properties:[{class:"Boolean",name:"submitted"}],methods:[async function execute(){var capabilitiesNeeded=await this.crunchService.getGrantPath(null,this.rootCapability.id);var shouldOpen=this.shouldOpenCapabilitiesArray(capabilitiesNeeded);if(!shouldOpen){var filteredCapabilitiesNeeded=capabilitiesNeeded.filter(capa=>{return foam.nanos.crunch.Capability.isInstance(capa)});var updateJunctionPromises=filteredCapabilitiesNeeded.map(capa=>{return this.crunchService.updateJunction(null,capa.id,null,null)});this.submitted=true;this.sequence.endSequence();return Promise.all(updateJunctionPromises)}},function shouldOpenCapabilitiesArray(array){var shouldOpen=false;array.forEach(capa=>{if(foam.nanos.crunch.MinMaxCapability.isInstance(capa)){shouldOpen=true}if(foam.nanos.crunch.Capability.isInstance(capa)){if(capa.of){shouldOpen=true}}if(Array.isArray(capa)){shouldOpen=this.shouldOpenCapabilitiesArray(capa)?true:shouldOpen}});return shouldOpen}]});
foam.CLASS({package:"foam.u2.crunch.wizardflow",name:"LoadCapabilitiesAgent",implements:["foam.core.ContextAgent"],imports:["crunchService","rootCapability"],exports:["capabilities","subject as wizardSubject"],properties:[{name:"capabilities",class:"Array",},{name:"subject",class:"FObjectProperty",of:"foam.nanos.auth.Subject",}],methods:[async function execute(){if(this.subject){await this.crunchService.getCapabilityPathFor(null,this.rootCapability.id,false,this.subject.user,this.subject.realUser).then(capabilities=>this.capabilities=capabilities);return}await this.crunchService.getCapabilityPath(null,this.rootCapability.id,false,true).then(capabilities=>this.capabilities=capabilities)}]});
foam.CLASS({package:"foam.u2.crunch.wizardflow",name:"LoadCapabilityGraphAgent",implements:["foam.core.ContextAgent"],imports:["rootCapability"],exports:["capabilityGraph"],requires:["foam.graph.GraphBuilder"],properties:[{name:"capabilityGraph",class:"FObjectProperty",of:"foam.graph.Graph"}],methods:[async function execute(){let graphBuilder=this.GraphBuilder.create();await graphBuilder.fromJunction(this.rootCapability,"capabilityDAO","prerequisiteCapabilityJunctionDAO","priority");this.capabilityGraph=graphBuilder.build()}]});
foam.CLASS({package:"foam.u2.crunch.wizardflow",name:"WAOSettingAgent",implements:["foam.core.ContextAgent"],imports:["wizardSubject"],exports:["getWAO"],requires:["foam.nanos.crunch.ui.ApprovableUserCapabilityJunctionWAO","foam.nanos.crunch.ui.UserCapabilityJunctionWAO","foam.nanos.crunch.ui.CapableWAO"],enums:[{name:"WAOSetting",values:["UCJ","CAPABLE","APPROVAL"]}],properties:[{name:"waoSetting",factory:function(){return this.WAOSetting.UCJ}}],methods:[function execute(){return Promise.resolve()},function getWAO(){switch(this.waoSetting){case this.WAOSetting.UCJ:return this.UserCapabilityJunctionWAO.create({subject:this.wizardSubject},this.__context__);case this.WAOSetting.CAPABLE:return this.CapableWAO.create({},this.__context__);case this.WAOSetting.APPROVAL:return this.ApprovableUserCapabilityJunctionWAO.create({subject:this.wizardSubject});default:throw new Error("WAOSetting is unrecognized: "+this.waoSetting)}}]});
foam.CLASS({package:"foam.u2.crunch.wizardflow",name:"GraphWizardletsAgent",implements:["foam.core.ContextAgent"],imports:["capabilities","capabilityGraph","getWAO"],exports:["wizardlets","capabilityToPrerequisite"],requires:["foam.graph.GraphTraverser","foam.graph.TraversalOrder","foam.graph.WeightPriorityStrategy","foam.nanos.crunch.ui.CapabilityWizardlet","foam.nanos.crunch.ui.LiftingAwareWizardlet","foam.nanos.crunch.ui.PrerequisiteAwareWizardlet","foam.u2.wizard.wao.NullWAO","foam.u2.wizard.wao.ProxyWAO"],properties:[{name:"wizardlets",class:"FObjectArray",of:"foam.u2.wizard.wizardlet.Wizardlet"},{class:"Map",name:"capabilityWizardletsMap"},{class:"Map",name:"capabilityToPrerequisite"}],methods:[async function execute(){this.createWizardlets()},function createWizardlets(){const traverser=this.GraphTraverser.create({graph:this.capabilityGraph,order:this.TraversalOrder.POST_ORDER,weightPriorityStrategy:this.WeightPriorityStrategy.MIN});this.capabilityToPrerequisite=traverser.nodeToDescendants;traverser.sub("process",(_1,_2,{parent,current})=>{const createdHere=this.createWizardletsForCapability(current);const entry=this.capabilityWizardletsMap[current.id];if(parent&&this.capabilityWizardletsMap[parent.id]){const parentEntry=this.capabilityWizardletsMap[parent.id];this.linkPrerequisite(parentEntry,entry,{lifted:!createdHere})}});traverser.traverse();const wizardlets=[];const rootNode=this.capabilityGraph.roots[0];const pushWizardlets=entry=>{if(entry.beforeWizardlet)wizardlets.push(entry.beforeWizardlet);for(const subEntry of entry.betweenWizardlets){pushWizardlets(subEntry)}if(entry.afterWizardlet)wizardlets.push(entry.afterWizardlet);for(let wizardlet of entry.wizardlets){if(this.isLiftingAware(wizardlet)){wizardlet.handleLifting(entry.liftedWizardlets.map(entry=>entry.primaryWizardlet))}}};pushWizardlets(this.capabilityWizardletsMap[rootNode.id]);this.wizardlets=wizardlets},function createWizardletsForCapability(current){const capability=current.data;if(this.capabilityWizardletsMap[capability.id]){return false}const afterWizardlet=this.adaptWizardlet({capability:capability},capability.wizardlet);const beforeWizardlet=this.adaptWizardlet({capability:capability},capability.beforeWizardlet);this.capabilityWizardletsMap[capability.id]={primaryWizardlet:afterWizardlet||beforeWizardlet,wizardlets:[beforeWizardlet,afterWizardlet].filter(v=>v),beforeWizardlet:beforeWizardlet,afterWizardlet:afterWizardlet,betweenWizardlets:[],liftedWizardlets:[],parentControlled:false,availabilitySlot:null,availabilityDetach:null};if(beforeWizardlet&&afterWizardlet){beforeWizardlet.isAvailable$.follow(afterWizardlet.isAvailable$);afterWizardlet.data$=beforeWizardlet.data$}return true},function linkPrerequisite(source,entry,{lifted}){if(source.betweenWizardlets.includes(entry))return;(lifted?source.liftedWizardlets:source.betweenWizardlets).push(entry);for(let parentWizardlet of source.wizardlets){if(this.isPrerequisiteAware(parentWizardlet)){parentWizardlet.addPrerequisite(entry.primaryWizardlet,{lifted:lifted})}parentWizardlet.prerequisiteWizardlets.push(entry.primaryWizardlet)}const parentControlsAvailability=this.isPrerequisiteAware(source.beforeWizardlet)||this.isPrerequisiteAware(source.afterWizardlet);entry.parentControlled=parentControlsAvailability||entry.parentControlled;if(!entry.parentControlled){if(!entry.availabilitySlot){entry.availabilitySlot=source.primaryWizardlet.isAvailable$;entry.availabilityDetach=entry.primaryWizardlet.isAvailable$.follow(entry.availabilitySlot)}else{entry.availabilityDetach.detach();entry.availabilitySlot=entry.availabilitySlot.or(source.primaryWizardlet.isAvailable$);entry.availabilityDetach=entry.primaryWizardlet.isAvailable$.follow(entry.availabilitySlot)}}},function adaptWizardlet({capability},wizardlet){if(!wizardlet)return null;wizardlet=wizardlet.clone(this.__subContext__);if(this.CapabilityWizardlet.isInstance(wizardlet)){wizardlet.copyFrom({capability:capability})}else{wizardlet.id=capability.id}var wao=wizardlet.wao;if(!wao)wao=wizardlet.wao=this.NullWAO.create();while(this.ProxyWAO.isInstance(wao)){if(wao.delegate&&!this.ProxyWAO.isInstance(wao.delegate))break;if(!wao.delegate){wao.delegate=this.getWAO();break}wao=wao.delegate}return wizardlet},function isPrerequisiteAware(wizardlet){return this.PrerequisiteAwareWizardlet.isInstance(wizardlet)},function isLiftingAware(wizardlet){return this.LiftingAwareWizardlet.isInstance(wizardlet)}]});
foam.CLASS({package:"foam.u2.crunch.wizardflow",name:"CreateWizardletsAgent",implements:["foam.core.ContextAgent"],imports:["capabilities","getWAO"],exports:["wizardlets"],requires:["foam.nanos.crunch.MinMaxCapability","foam.nanos.crunch.ui.CapableWAO","foam.nanos.crunch.ui.PrerequisiteAwareWizardlet","foam.u2.wizard.wao.ProxyWAO"],properties:[{name:"wizardlets",class:"FObjectArray",of:"foam.u2.wizard.wizardlet.Wizardlet"}],methods:[async function execute(){this.wizardlets=await this.parseArrayToWizardlets(this.capabilities)},async function parseArrayToWizardlets(array,parent){var capabilityDesired=array[array.length-1];var capabilityPrereqs=array.slice(0,-1);var wizardlets=[];var rootWizardlet=this.getWizardlet(capabilityDesired);var beforeWizardlet=this.getWizardlet(capabilityDesired,true);if(beforeWizardlet){beforeWizardlet.isAvailable$.follow(rootWizardlet.isAvailable$);rootWizardlet.data$=beforeWizardlet.data$}var addPrerequisite=wizardlet=>{var defaultPrerequisiteHandling=true;var preventPush=false;if(this.isPrerequisiteAware(rootWizardlet)){preventPush=rootWizardlet.addPrerequisite(wizardlet);defaultPrerequisiteHandling=false}if(beforeWizardlet&&this.isPrerequisiteAware(beforeWizardlet)){preventPush=beforeWizardlet.addPrerequisite(wizardlet);defaultPrerequisiteHandling=false}if(defaultPrerequisiteHandling)wizardlet.isAvailable$.follow(rootWizardlet.isAvailable$);return preventPush};for(let capability of capabilityPrereqs){if(Array.isArray(capability)){let subWizardlets=await this.parseArrayToWizardlets(capability);let preventPush=addPrerequisite(subWizardlets[subWizardlets.length-1]);if(!preventPush)wizardlets.push(...subWizardlets);continue}let wizardlet=this.getWizardlet(capability);let preventPush=addPrerequisite(wizardlet);if(!preventPush)wizardlets.push(wizardlet)}if(beforeWizardlet)wizardlets.unshift(beforeWizardlet);wizardlets.push(rootWizardlet);return wizardlets},function getWizardlet(capability,isBefore){let wizardlet=capability[isBefore?"beforeWizardlet":"wizardlet"];if(!wizardlet)return null;wizardlet=wizardlet.clone(this.__subContext__);wizardlet.copyFrom({capability:capability});var wao=wizardlet.wao;while(this.ProxyWAO.isInstance(wao)){if(wao.delegate&&!this.ProxyWAO.isInstance(wao.delegate))break;if(!wao.delegate){wao.delegate=this.getWAO();break}wao=wao.delegate}return wizardlet},function isPrerequisiteAware(wizardlet){return this.PrerequisiteAwareWizardlet.isInstance(wizardlet)}]});
foam.CLASS({package:"foam.u2.crunch.wizardflow",name:"LoadWizardletsAgent",imports:["wizardlets"],implements:["foam.core.ContextAgent"],methods:[async function execute(){await Promise.all(this.wizardlets.map(w=>w.load()))}]});
foam.CLASS({package:"foam.u2.crunch.wizardflow",name:"FilterWizardletsAgent",implements:["foam.core.ContextAgent"],imports:["crunchService","ctrl","wizardlets as unfilteredWizardlets"],exports:["wizardlets"],properties:[{name:"wizardlets",class:"FObjectArray",of:"foam.u2.wizard.wizardlet.Wizardlet",factory:()=>{return[]}}],methods:[async function execute(){for(var i=0;i<this.unfilteredWizardlets.length;i++){var wizardlet=this.unfilteredWizardlets[i];var shouldReopen=await this.crunchService.maybeReopen(this.ctrl.__subContext__,wizardlet.capability.id);if(shouldReopen)this.wizardlets.push(wizardlet)}}]});
foam.CLASS({package:"foam.u2.crunch.wizardflow",name:"FilterGrantModeAgent",extends:"foam.u2.crunch.wizardflow.FilterWizardletsAgent",implements:["foam.mlang.Expressions"],requires:["foam.nanos.crunch.ui.CapabilityWizardlet","foam.nanos.crunch.Capability","foam.nanos.crunch.CapabilityGrantMode"],properties:[{name:"allowedModes",class:"FObjectArray",of:"foam.nanos.crunch.CapabilityGrantMode",factory:function(){return[this.CapabilityGrantMode.AUTOMATIC]}}],methods:[async function execute(){this.wizardlets=foam.Array.filter(this.unfilteredWizardlets,this.AND(this.INSTANCE_OF(this.CapabilityWizardlet),this.IN(this.DOT(this.CapabilityWizardlet.CAPABILITY,this.Capability.GRANT_MODE),this.allowedModes)))}]});
foam.CLASS({package:"foam.u2.crunch.wizardflow",name:"WizardStateAgent",extends:"foam.u2.crunch.wizardflow.FilterWizardletsAgent",implements:["foam.mlang.Expressions"],imports:["crunchService","rootCapability"],requires:["foam.nanos.crunch.Capability","foam.nanos.crunch.ui.CapabilityWizardlet"],methods:[async function execute(){var wizardState=await this.crunchService.getWizardState(null,this.rootCapability.id);this.wizardlets=foam.Array.filter(this.unfilteredWizardlets,this.NOT(this.IN(this.DOT(this.CapabilityWizardlet.CAPABILITY,this.Capability.ID),wizardState.ignoreList)))}]});
foam.CLASS({package:"foam.u2.crunch.wizardflow",name:"SkipGrantedAgent",imports:["crunchService","wizardlets"],exports:["initialPosition"],requires:["foam.nanos.crunch.CapabilityJunctionStatus","foam.u2.crunch.wizardflow.SkipMode","foam.nanos.crunch.ui.CapabilityWizardlet","foam.u2.wizard.WizardPosition"],properties:[{name:"initialPosition",class:"FObjectProperty",of:"foam.u2.wizard.WizardPosition",factory:function(){return this.WizardPosition.create({wizardletIndex:0,sectionIndex:0})}},{name:"mode",class:"Enum",of:"foam.u2.crunch.wizardflow.SkipMode",factory:function(){return this.SkipMode.SKIP}}],methods:[async function execute(){if(this.mode==this.SkipMode.SHOW)return;let passedAtBeginning=0;let foundFirstWizardlet=false;for(let wizardlet of this.wizardlets){if(!this.CapabilityWizardlet.isInstance(wizardlet))continue;let isGranted=["GRANTED","PENDING"].some(status=>this.CapabilityJunctionStatus[status]==wizardlet.status);if(!isGranted||await this.crunchService.isRenewable(this.__subContext__,wizardlet.capability.id)){foundFirstWizardlet=true;continue}if(!foundFirstWizardlet)passedAtBeginning++;if(this.mode==this.SkipMode.HIDE){wizardlet.isVisible=false}}this.initialPosition.wizardletIndex=passedAtBeginning}]});
foam.CLASS({package:"foam.u2.crunch.wizardflow",name:"RequirementsPreviewAgent",implements:["foam.core.ContextAgent"],imports:["capabilities","ctrl","rootCapability","sequence","wizardlets"],requires:["foam.u2.detail.AbstractSectionedDetailView","foam.u2.dialog.Popup"],methods:[function execute(){var sectionsList=this.generateSections(this.wizardlets);const arrOfRequiredCapabilities=[];for(let i=0;i<sectionsList.length;i++){for(let j=0;j<sectionsList[i].length;j++){if(sectionsList[i][j].help){if(typeof sectionsList[i][j].help==="function"){let curCap=this.wizardlets[i].capability;let generateHelpText=sectionsList[i][j].help.bind(curCap.of.create({},this));sectionsList[i][j].help=generateHelpText(curCap)}arrOfRequiredCapabilities.push(sectionsList[i][j].help)}}}if(arrOfRequiredCapabilities.length<1){return Promise.resolve()}else{return new Promise((resolve,_)=>{this.ctrl.add(this.Popup.create({closeable:false},this.ctrl.__subContext__).tag({class:"foam.u2.crunch.CapabilityRequirementView",arrayRequirement:arrOfRequiredCapabilities,functionData:{caps:this.capabilities},capabilityId:this.rootCapability.id,onClose:(x,isContinueAction)=>{resolve(isContinueAction)}})).end()}).then(isContinueAction=>{if(!isContinueAction){this.sequence.endSequence();return Promise.resolve()}})}},function generateSections(generatedWizardlets){return generatedWizardlets.map(wizardlet=>this.AbstractSectionedDetailView.create({of:wizardlet.of}).sections)}]});
foam.CLASS({package:"foam.u2.crunch.wizardflow",name:"AutoSaveWizardletsAgent",imports:["wizardlets"],requires:["foam.nanos.crunch.ui.CapabilityWizardlet"],implements:["foam.core.ContextAgent"],methods:[async function execute(){for(let wizardlet of this.wizardlets){if(this.CapabilityWizardlet.isInstance(wizardlet)&&(wizardlet.capability&&wizardlet.capability.autoSave)){wizardlet.getDataUpdateSub().sub(()=>{wizardlet.save({reloadData:wizardlet.reloadOnAutoSave})})}}}]});
foam.CLASS({package:"foam.u2.crunch.wizardflow",name:"MaybeDAOPutAgent",implements:["foam.core.ContextAgent"],imports:["intercept","submitted","capable"],methods:[function execute(){var p=Promise.resolve();if(this.intercept?.daoKey&&this.submitted){p=p.then(()=>this.__subContext__[this.intercept.daoKey].put(this.capable).then(returnCapable=>{this.intercept.returnCapable=returnCapable}))}return p}]});
foam.CLASS({package:"foam.u2.crunch.wizardflow.lite",name:"CheckGrantedAgent",implements:["foam.core.ContextAgent"],requires:["foam.nanos.crunch.CapabilityJunctionStatus"],imports:["capable","rootCapability","sequence"],methods:[async function execute(){this.capable.capablePayloads.find(payload=>{if(payload.capability==this.rootCapability.id&&payload.status==this.CapabilityJunctionStatus.GRANTED){this.sequence.endSequence()}})}]});
foam.CLASS({package:"foam.u2.crunch.wizardflow",name:"PutFinalJunctionsAgent",implements:["foam.mlang.Expressions"],imports:["crunchService","wizardlets"],requires:["foam.nanos.crunch.AgentCapabilityJunction","foam.nanos.crunch.UserCapabilityJunction"],methods:[function execute(){return Promise.all(this.wizardlets.filter(wizardlet=>{return wizardlet.isAvailable&&!wizardlet.capability.of}).map(filteredWizard=>{return this.crunchService.updateJunction(null,filteredWizard.capability.id,null,null).then(ucj=>{return ucj})}))}]});
foam.CLASS({package:"foam.u2.crunch.wizardflow",name:"PutFinalPayloadsAgent",implements:["foam.mlang.Expressions"],imports:["wizardlets"],requires:["foam.nanos.crunch.AgentCapabilityJunction","foam.nanos.crunch.UserCapabilityJunction"],methods:[function execute(){return Promise.all(this.wizardlets.filter(wizardlet=>{return wizardlet.isAvailable&&!wizardlet.capability.of}).map(filteredWizard=>{return filteredWizard.save().then(data=>{return Promise.resolve()})}))}]});
foam.CLASS({package:"foam.u2.crunch.wizardflow",name:"TestAgent",implements:["foam.core.ContextAgent"],imports:["capabilities","wizardlets"],methods:[function execute(){return Promise.resolve()}]});
foam.CLASS({package:"foam.u2.crunch.wizardflow",name:"LoadTopConfig",implements:["foam.core.ContextAware"],imports:["rootCapability","sequence"],methods:[async function execute(){if(this.rootCapability.wizardConfig){await this.rootCapability.wizardConfig.clone(this).execute();this.rootCapability.wizardConfig.applyTo(this.sequence)}}]});
foam.CLASS({package:"foam.u2.crunch.wizardflow",name:"ShowPreexistingAgent",imports:["wizardlets"],requires:["foam.nanos.crunch.CapabilityJunctionStatus"],methods:[async function execute(){for(let wizardlet of this.wizardlets){if(foam.nanos.crunch.ui.MinMaxCapabilityWizardlet.isInstance(wizardlet)&&wizardlet.data.selectedData.length>0){var selectedDataCapabilityIds=wizardlet.data.selectedData;for(let choiceWizardlet of wizardlet.choiceWizardlets){if(selectedDataCapabilityIds.includes(choiceWizardlet.capability.id)){choiceWizardlet.isAvailable=true}}}}}]});
foam.CLASS({package:"foam.u2.crunch.wizardflow",name:"SaveAllAgent",flags:["web"],imports:["wizardlets","rootCapability"],properties:[{class:"Function",name:"onSave"}],methods:[async function execute(){let state={allValid:true,topLevelUCJ:null};await this.save(state);if(this.onSave){await this.onSave(state.allValid,state.topLevelUCJ)}},async function save(state){try{await foam.Promise.inOrder(this.wizardlets,async w=>{if(state.allValid)state.allValid=w.isValid;var ucj=await w.save();if(ucj&&ucj.targetId==this.rootCapability.id)state.topLevelUCJ=ucj})}catch(e){console.error(e);await new Promise(resolve=>{setTimeout(async()=>{await this.save(state);resolve()},5e3)})}}]});
foam.CLASS({package:"foam.u2.crunch.wizardflow",name:"SubmitAgent",flags:["web"],imports:["wizardlets"],methods:[async function execute(){for(let w of this.wizardlets){if(w.onSubmit)await w.onSubmit()}}]});
foam.CLASS({package:"foam.u2.crunch.wizardflow",name:"ApprovalRequestAgent",implements:["foam.core.ContextAgent"],imports:["approvableDAO","approvalRequestDAO","capabilities","crunchService","rootCapability","subject","submitted","wizardSubject"],requires:["foam.nanos.approval.ApprovalRequest","foam.nanos.approval.CompositeApprovable","foam.nanos.crunch.UCJUpdateApprovable","foam.nanos.dao.Operation"],properties:[{class:"String",name:"group"}],methods:[async function execute(){var id=foam.uuid.randomGUID();await this.crunchService.createApprovalRequest(null,this.rootCapability.id)}]});
foam.CLASS({package:"foam.u2.crunch.wizardflow",name:"CapabilityStoreAgent",flags:["web"],imports:["rootCapability","crunchService"],requires:["foam.nanos.crunch.CapabilityJunctionStatus"],methods:[async function execute(){let ucj=await this.crunchService.getJunction(null,this.rootCapability.id);this.crunchService.pub("updateJunction");if(ucj&&ucj.status===this.CapabilityJunctionStatus.GRANTED){this.crunchService.pub("grantedJunction")}}]});
foam.CLASS({package:"foam.u2.crunch.wizardflow",name:"DebugAgent",implements:["foam.core.ContextAgent"],imports:["wizardlets"],requires:["foam.u2.wizard.wao.ProxyWAO","foam.u2.wizard.wizardlet.WizardletSection","foam.u2.wizard.debug.DebugContextIntercept","foam.u2.wizard.debug.DebugWAO"],methods:[async function execute(){for(let wizardlet of this.wizardlets){var ctxIntercept=this.DebugContextIntercept.create();wizardlet.pushContext(ctxIntercept.createInterceptedValues(wizardlet.__subSubContext__));if(wizardlet.of){wizardlet.sections.push(this.WizardletSection.create({wizardlet:wizardlet,title:"Developer Tools",isAvailable:true,isValid:true,customView:{class:"foam.u2.wizard.debug.DebugWizardletView",wizardlet:wizardlet}}))}if(!this.ProxyWAO.isInstance(wizardlet.wao))continue;wizardlet.wao=this.DebugWAO.create({delegate:wizardlet.wao})}console.log("DebugAgent is ON")}]});
foam.CLASS({package:"foam.u2.crunch.wizardflow",name:"CapableDefaultConfigAgent",implements:["foam.core.ContextAware"],requires:["foam.u2.wizard.StepWizardConfig"],exports:["config as wizardConfig"],properties:[{class:"FObjectProperty",of:"foam.u2.wizard.StepWizardConfig",name:"config"}],methods:[async function execute(){this.config=this.StepWizardConfig.create({allowSkipping:false,allowBacktracking:false})}]});
foam.CLASS({package:"foam.u2.crunch",name:"CapabilityRequirementView",extends:"foam.u2.View",imports:["ctrl"],requires:["foam.u2.crunch.Style"],css:`
^ {
max-width: 60vw;
max-height: 75vh;
overflow: auto;
margin: 24px;
text-align: center;
}
^title {
padding-bottom: 1em;
}
^subTitle {
color: /*%GREY1%*/ #494F59;
width: 85%;
display: inline-block;
padding-bottom: 1em;
}
^ .table-content {
font-size: 1.4rem;
color: #7f8385;
padding-left: 1.5vw;
margin-top: -19px;
line-height: 1em;
padding-bottom: 2vh;
}
^ .circle-center {
padding-top: 1em;
padding-bottom: 1em;
text-align: center;
}
^ .actionPosition {
float: right;
padding: 1em;
}
`,messages:[{name:"INTRO_TEXT",message:`In this section, we ask you to enter some details relating to your business.`}],properties:[{class:"StringArray",name:"arrayRequirement"},{class:"Function",name:"onClose"},{class:"Object",name:"functionData"},{class:"String",name:"capabilityId"}],methods:[function render(){var style=this.Style.create();style.addBinds(this);var mainCapability=this.functionData?this.functionData.caps.filter(capability=>capability.id==this.capabilityId):undefined;this.addClass().addClass("start").start().callIf(mainCapability,function(){return this.addClass("circle-center").start().addClass(style.myClass("icon-circle")).style({"background-image":`url('${mainCapability[0].icon}')`,"background-size":"cover","background-position":"50% 50%"}).end()}).end().start().addClass("titles").start().addClasses([this.myClass("title"),"h400"]).translate(mainCapability[0].id+".name",mainCapability[0].name).end().start().addClasses([this.myClass("subTitle"),"p-lg"]).translate(mainCapability[0].id+".requirementViewTitle",mainCapability[0].requirementViewTitle||this.INTRO_TEXT).end().end().start().addClass("actionPosition").startContext({data:this}).tag(this.GET_STARTED,{buttonStyle:"PRIMARY"}).tag(this.CANCEL,{buttonStyle:"SECONDARY"}).endContext().end()}],actions:[{name:"getStarted",label:"Get started",code:function(x){x.closeDialog();this.onClose(x,true)}},{name:"cancel",code:function(x){x.closeDialog();this.onClose(x,false)}}]});
foam.CLASS({package:"foam.u2.crunch",name:"CapabilityCardView",extends:"foam.u2.View",implements:["foam.mlang.Expressions"],requires:["foam.nanos.crunch.AgentCapabilityJunction","foam.nanos.crunch.Capability","foam.nanos.crunch.CapabilityJunctionStatus","foam.nanos.crunch.UserCapabilityJunction","foam.u2.crunch.Style","foam.u2.Element","foam.u2.view.ReadOnlyEnumView"],css:`
^icon.foam-u2-crunch-Style-icon-circle {
width: 65px;
height: 65px;
margin-right: 24px;
background-size: cover;
background-position: 50% 50%;
flex-shrink: 0;
}
^ .foam-u2-crunch-Style-card-title {
margin-bottom: 4px;
}
`,imports:["auth","crunchService","ctrl","subject","userCapabilityJunctionDAO"],properties:[{name:"associatedEntity",expression:function(data,subject){if(!data||!subject)return"";return data.associatedEntity===foam.nanos.crunch.AssociatedEntity.USER?subject.user:subject.realUser}},{name:"cjStatus",factory:function(){return foam.nanos.crunch.CapabilityJunctionStatus.AVAILABLE}},{class:"Boolean",name:"isRenewable"},{class:"Boolean",name:"tooltipEnabled",value:true}],messages:[{name:"RENEW_DATA_LABEL",message:"Please review and update your data"}],methods:[function init(){this.SUPER();this.onDetach(this.crunchService.sub("updateJunction",this.daoUpdate));this.daoUpdate()},function render(){this.SUPER();var self=this;var style=self.Style.create();style.addBinds(self);self.addClass(this.myClass()).addClass(style.myClass()).addClass(style.myClass("mode-circle")).start().addClass(this.myClass("icon")).addClass(style.myClass("icon-circle")).style({"background-image":"url('"+self.data.icon+"')"}).end().start().style({flex:1}).start("p").addClass(style.myClass("card-title")).translate(self.data.id+"."+self.data.cls_.NAME.name,self.data.name).end().start("p").addClass(style.myClass("card-subtitle")).translate(self.data.id+"."+self.data.cls_.DESCRIPTION.name,self.data.description).end().end().start().add(this.slot(function(cjStatus){return this.E().addClass(style.myClass("tooltip")).start().addClass(this.myClass("badge")).add(self.ReadOnlyEnumView.create({data:cjStatus})).end().start("span").addClass(style.myClass("tooltiptext")).enableClass(style.myClass("tooltipDisabled"),self.tooltipEnabled,true).add(cjStatus.documentation).end()})).add(this.slot(function(isRenewable){return isRenewable?this.E().start().addClass(style.myClass("renewable-description")).add(self.RENEW_DATA_LABEL).end():null})).end()}],listeners:[{name:"daoUpdate",code:function(){this.crunchService.getJunction(null,this.data.id).then(ucj=>{if(ucj){this.cjStatus=ucj.status===this.CapabilityJunctionStatus.APPROVED?this.CapabilityJunctionStatus.PENDING:ucj.status}if(this.cjStatus===this.CapabilityJunctionStatus.GRANTED){this.crunchService.isRenewable(this.ctrl.__subContext__,ucj.targetId).then(isRenewable=>this.isRenewable=isRenewable)}if(this.cjStatus===this.CapabilityJunctionStatus.ACTION_REQUIRED&&ucj.targetId=="554af38a-8225-87c8-dfdf-eeb15f71215f-20"){this.cjStatus=this.CapabilityJunctionStatus.PENDING_REVIEW}})}}]});
foam.CLASS({package:"foam.u2.crunch",name:"CapabilityFeatureView",extends:"foam.u2.View",implements:["foam.mlang.Expressions"],imports:["auth","crunchService","ctrl","subject","userCapabilityJunctionDAO"],requires:["foam.nanos.crunch.AgentCapabilityJunction","foam.nanos.crunch.CapabilityJunctionStatus","foam.nanos.crunch.UserCapabilityJunction","foam.u2.crunch.Style","foam.u2.Tooltip","foam.u2.view.ReadOnlyEnumView"],css:`
^ .foam-u2-crunch-Style-cardpart {
position: relative;
}
^badge {
position: absolute;
bottom: 12px; 
}
^badge > * {
border-radius: 0px 11.2px 11.2px 0px !important;
border-style: none !important;
height: 24px;
width: 79px;
}
^ .foam-u2-crunch-Style-renewable-description {
position: absolute;
top: 0px;
}
`,properties:[{name:"associatedEntity",expression:function(data,subject){if(!data||!subject)return"";return data.associatedEntity===foam.nanos.crunch.AssociatedEntity.USER?subject.user:subject.realUser}},{name:"cjStatus",value:null},{class:"Boolean",name:"isRenewable"},{class:"Boolean",name:"tooltipEnabled",value:true}],messages:[{name:"RENEW_DATA_LABEL",message:"Please review and update your data"}],methods:[function init(){this.SUPER();this.onDetach(this.crunchService.sub("updateJunction",this.daoUpdate));this.daoUpdate();this.onDetach(this.cjStatus$.sub(this.statusUpdate))},function render(){this.SUPER();var self=this;this.addClass();var style=self.Style.create();style.addBinds(self);self.addClass(style.myClass()).addClass(style.myClass(),"mode-card").start().addClass(style.myClass("cardpart")).style({"background-image":"url('"+self.data.icon+"')"}).add(this.slot(function(cjStatus){if(!cjStatus)return;return this.E().start("",{tooltip:cjStatus.documentation}).addClass(this.myClass("badge")).add(this.ReadOnlyEnumView.create({data:cjStatus,showGlyph:true})).end()})).add(this.slot(function(isRenewable){return isRenewable?this.E().start().addClass(style.myClass("renewable-description")).add(self.RENEW_DATA_LABEL).end():null})).end().start().addClass(style.myClass("card-title")).translate(self.data.id+"."+self.data.cls_.NAME.name,self.data.name).end()}],listeners:[{name:"daoUpdate",code:function(){this.crunchService.getJunction(null,this.data.id).then(ucj=>{if(ucj){this.cjStatus=ucj.status===this.CapabilityJunctionStatus.APPROVED?this.CapabilityJunctionStatus.PENDING:ucj.status}if(this.cjStatus===this.CapabilityJunctionStatus.GRANTED){this.crunchService.isRenewable(this.ctrl.__subContext__,ucj.targetId).then(isRenewable=>this.isRenewable=isRenewable)}if(this.cjStatus===this.CapabilityJunctionStatus.ACTION_REQUIRED&&ucj.targetId=="554af38a-8225-87c8-dfdf-eeb15f71215f-20"){this.cjStatus=this.CapabilityJunctionStatus.PENDING_REVIEW}})}},{name:"statusUpdate",isMerged:true,mergeDelay:2e3,code:function(){if(this.cjStatus!=this.CapabilityJunctionStatus.PENDING&&this.cjStatus!=this.CapabilityJunctionStatus.PENDING_REVIEW){return}this.crunchService.getJunction(null,this.data.id).then(ucj=>{if(ucj&&ucj.status===this.CapabilityJunctionStatus.GRANTED){this.auth.cache={};this.crunchService.pub("grantedJunction");this.cjStatus=this.CapabilityJunctionStatus.GRANTED}else if(ucj&&ucj.status===this.CapabilityJunctionStatus.ACTION_REQUIRED){this.crunchService.pub("grantedJunction")}else{this.statusUpdate()}})}}]});
foam.CLASS({class:"foam.core.Model",package:"foam.u2.crunch",name:"TestView",extends:"foam.u2.View",properties:[{name:"something",factory:()=>({a:1})},{class:"String",name:"company",value:"Nanopay",view:{class:"foam.u2.view.ValueView"}}],methods:[function render(){this.something.a=2;this.start("h1").add("hello").end().start().start("p").startContext({data:this,controllerMode:foam.u2.ControllerMode.VIEW}).start(this.COMPANY).end().endContext().end().end()}]});
foam.CLASS({package:"foam.u2.crunch",name:"CapabilityStore",extends:"foam.u2.View",implements:["foam.mlang.Expressions"],requires:["foam.dao.ArrayDAO","foam.dao.NullDAO","foam.nanos.crunch.Capability","foam.nanos.crunch.CapabilityCategory","foam.nanos.crunch.CapabilityCategoryCapabilityJunction","foam.nanos.crunch.CapabilityJunctionStatus","foam.nanos.crunch.UserCapabilityJunction","foam.u2.ControllerMode","foam.u2.Element","foam.u2.Tab","foam.u2.Tabs","foam.u2.UnstyledTabs","foam.u2.crunch.CapabilityCardView","foam.u2.crunch.CapabilityFeatureView","foam.u2.layout.Grid","foam.u2.layout.GUnit"],imports:["auth","ctrl","capabilityCategoryCapabilityJunctionDAO","capabilityCategoryDAO","capabilityDAO","crunchController","crunchService","menuDAO","registerElement","subject","theme","window","themeDomainDAO"],messages:[{name:"TAB_ALL",message:"All"},{name:"TITLE",message:"Features"},{name:"SUBTITLE",message:"Unlock more features on {appName}"},{name:"EDITABLE",message:"Edit existing information"}],css:`
^ {
margin: auto;
padding: 12px 24px 24px 24px;
-webkit-box-sizing: border-box;
box-sizing: border-box;
}
^label-title {
font-weight: 900;
font-size: 3.2rem;
margin: 24px 16px;
margin-bottom: 8px;
}
^label-subtitle {
margin: 16px;
margin-top: 0;
color: #9ba1a6;
font-size: 1.8rem;
}
^category {
margin-top: 48px;
padding: 0px 12px;
}
^feature-column-grid {
display: inline-flex;
width: calc(100% - 48px);
overflow-x: auto;
}
^featureSection {
flex: 0;
height: auto;
}
^perFeature {
display: flex;
}
^left-arrow {
width: 24px;
height: 24px;
float: left;
display: flex;
cursor: pointer;
padding-top: 70px;
-webkit-transition: padding 2s;
}
^right-arrow {
width: 24px;
height: 24px;
float: right;
display: flex;
cursor: pointer;
padding-top: 70px;
margin-left: -20px;
z-index: 10000;
position: relative;
-webkit-transition: padding 2s;
}
^container {
display: inline-block;
width: 100%;
height: fit-content;
overflow-y: visible;
margin-top: 24px;
}
`,properties:[{name:"visibleCapabilityDAO",class:"foam.dao.DAOProperty",factory:function(){return this.NullDAO.create()}},{name:"featuredCapabilities",class:"foam.dao.DAOProperty",expression:function(visibleCapabilityDAO){return visibleCapabilityDAO.where(this.IN("featured",this.Capability.KEYWORDS))}},{name:"themeDomain",expression:function(themeDomainDAO,window){return themeDomainDAO.find(this.window.location.hostname)}},{name:"visibleCategoryDAO",class:"foam.dao.DAOProperty",expression:function(capabilityCategoryDAO){return capabilityCategoryDAO.where(this.EQ(this.CapabilityCategory.VISIBLE,true))}},{name:"carouselCounter",class:"Int",},{name:"totalNumCards",class:"Int",},{name:"featureCardArray",value:[],},{name:"cardsOverflow",class:"Boolean"},{name:"junctions",factory:()=>[]},"wizardOpened"],methods:[function init(){this.crunchService.getAllJunctionsForUser().then(juncs=>{this.junctions=juncs;this.daoUpdate()});this.crunchService.getEntryCapabilities().then(a=>{this.visibleCapabilityDAO=this.ArrayDAO.create({array:a.array})})},function render(){this.SUPER();this.onDetach(this.crunchService.sub("grantedJunction",this.onChange));var self=this;globalThis.cstore=self;self.addClass(self.myClass()).start("p").addClass(this.myClass("label-title")).add(this.TITLE).end().start("p").addClass(this.myClass("label-subtitle")).add(this.SUBTITLE.replace("{appName}",this.theme.appName)).end().add(this.slot(async function(junctions,featuredCapabilities,themeDomain){var themeCaps=await self.themeDomainDAO.find(self.window.location.hostname).then(function(ret){return ret?.getCapabilities(this.ctrl.__subContext__).dao.select()});if(themeCaps?.array?.length!=0)return self.renderFeatured(themeCaps.array);var featured=await this.featuredCapabilities.select();return self.renderFeatured(featured.array)})).end()},function renderFeatured(arr){var self=this;var spot=self.E();self.totalNumCards=arr.length;self.featureCardArray=[];for(let i=0;i<self.totalNumCards;i++){self.featureCardArray.push(()=>self.Element.create().start().addClass(self.myClass("perFeature")).start(self.CapabilityFeatureView,{data:arr[i]}).addClass(self.myClass("featureSection")).end().on("click",()=>{self.openWizard(arr[i],true)}).end())}spot.start().start("span").start("img").addClass(self.myClass("left-arrow")).show(this.cardsOverflow$).attr("src","images/arrow-back-24px.svg").on("click",function(){self.carouselCounter--}).end().end();var ele;async function checkCardsOverflow(evt){var el=await ele.el();self.cardsOverflow=el.scrollWidth>el.clientWidth}spot.add(self.slot(function(carouselCounter,totalNumCards){ele=self.E().addClass(self.myClass("feature-column-grid"));for(var k=0;k<totalNumCards;k++){let cc=carouselCounter%totalNumCards;let index=(cc+totalNumCards+k)%totalNumCards;ele=ele.add(self.featureCardArray[index].call(self))}return ele}));spot.start("span").start("img").addClass(self.myClass("right-arrow")).show(this.cardsOverflow$).attr("src","images/arrow-forward-24px.svg").on("click",function(){self.carouselCounter++}).end().end();window.addEventListener("resize",checkCardsOverflow);checkCardsOverflow();self.onDetach(()=>{window.removeEventListener("resize",checkCardsOverflow)});return spot},function accountAndAccountingCard(){var self=this;return self.E().style({width:"94%",margin:"auto "}).select(self.visibleCategoryDAO$proxy,function(category){var sectionElement=this.E("span");var returnElement=this.E().start("h3").add({data:category,clsInfo:category.cls_.NAME.name,default:category.name}).end().add(sectionElement).addClass(self.myClass("category"));var previewIdsPromise=self.getCategoryDAO_(category.id).limit(6).select().then(arraySink=>arraySink.array.map(x=>x.targetId));previewIdsPromise.then(capabilityIds=>{self.visibleCapabilityDAO.where(self.IN(self.Capability.ID,capabilityIds)).select().then(result=>{let arr=result.array;let grid=self.Grid.create();for(let i=0;i<arr.length;i++){let cap=arr[i];grid=grid.start(self.GUnit,{columns:4}).tag(self.CapabilityCardView,{data:cap}).on("click",()=>{self.openWizard(cap,true)}).end()}sectionElement.add(grid)})});return returnElement})},function renderCategorySection(category){var self=this;var sectionElement=this.E();var p=self.getCategoryDAO_(category.id).select(self.PROJECTION(self.CapabilityCategoryCapabilityJunction.TARGET_ID));p.then(arraySink=>{capabilityIds=arraySink.projection;self.visibleCapabilityDAO.where(self.IN(self.Capability.ID,capabilityIds)).select().then(result=>{let arr=result.array;let grid=self.Grid.create();for(let i=0;i<arr.length;i++){let cap=arr[i];grid=grid.start(self.GUnit,{columns:4}).tag(self.CapabilityCardView,{data:cap}).on("click",()=>{self.openWizard(cap,false)}).end()}sectionElement.add(grid)})});return sectionElement},function renderPredicatedSection(capPredicate,ucjPredicate){var self=this;var sectionElement=this.E();self.visibleCapabilityDAO.where(capPredicate).select().then(result=>{let arr=result.array;let grid=self.Grid.create();let addedFirstItem=false;for(let i=0;i<arr.length;i++){let cap=arr[i];let ucj=self.junctions.find(ucj=>ucj.targetId==cap.id);if(!ucjPredicate.f(ucj))continue;if(!addedFirstItem){addedFirstItem=true;sectionElement.addClass(this.myClass("category"))}grid=grid.start(self.GUnit,{columns:4}).tag(self.CapabilityCardView,{data:cap}).on("click",()=>{self.openWizard(cap,true)}).end()}sectionElement.add(grid)});return sectionElement},function getCategoryDAO_(categoryId){return this.capabilityCategoryCapabilityJunctionDAO.where(this.EQ(this.CapabilityCategoryCapabilityJunction.SOURCE_ID,categoryId))},function daoUpdate(){Promise.resolve().then(()=>this.visibleCategoryDAO.select()).then(categorySink=>categorySink.array.map(cat=>cat.id)).then(categories=>{return this.capabilityCategoryCapabilityJunctionDAO.where(this.IN(this.CapabilityCategoryCapabilityJunction.SOURCE_ID,categories)).select()}).then(cccjSink=>Object.keys(cccjSink.array.map(cccj=>cccj.targetId).reduce((set,capabilityId)=>({...set,[capabilityId]:true}),{}))).then(visibleList=>this.visibleCapabilityDAO.where(this.OR(this.IN(this.Capability.ID,visibleList),this.IN("featured",this.Capability.KEYWORDS))).select()).then(async sink=>{if(sink.array.length!==1)return;let cap=sink.array[0];let ucj=await this.junctions.find(ucj=>ucj.targetId==cap.id);if(ucj&&(ucj.status==this.CapabilityJunctionStatus.GRANTED||ucj.status==this.CapabilityJunctionStatus.PENDING))return;let x=this.ctrl.__subContext__;let capa=await this.crunchService.updateJunction(x,cap.id,null,this.CapabilityJunctionStatus.GRANTED);if(capa.status!=this.CapabilityJunctionStatus.GRANTED)this.openWizard(cap,false);else this.window.location.reload()})},async function openWizard(cap,showToast){if(this.wizardOpened)return;this.wizardOpened=true;let ucj=await this.junctions.find(ucj=>ucj.targetId==cap.id);let x=null;var editable=!ucj||await this.crunchService.maybeReopen(this.ctrl.__subContext__,cap.id);if(!editable){x=this.__subContext__.createSubContext({controllerMode:this.ControllerMode.VIEW})}this.crunchController.createWizardSequence(cap,x).reconfigure("CheckPendingAgent",{showToast:showToast}).execute().then(()=>{this.wizardOpened=false})}],listeners:[{name:"onChange",isMerged:true,mergeDelay:2e3,code:async function(){let a=await this.crunchService.getEntryCapabilities();this.visibleCapabilityDAO=this.ArrayDAO.create({array:a.array});let juncs=await this.crunchService.getAllJunctionsForUser();this.junctions=juncs;this.daoUpdate();this.menuDAO.cmd_(this,foam.dao.DAO.PURGE_CMD);this.menuDAO.cmd_(this,foam.dao.DAO.RESET_CMD)}}]});
foam.CLASS({package:"foam.u2.crunch",name:"CapabilityInterceptView",extends:"foam.u2.View",implements:["foam.mlang.Expressions"],requires:["foam.log.LogLevel","foam.nanos.crunch.AgentCapabilityJunction","foam.nanos.crunch.Capability","foam.nanos.crunch.CapabilityJunctionStatus","foam.nanos.crunch.UserCapabilityJunction","foam.u2.crunch.CapabilityCardView","foam.u2.layout.Rows"],imports:["capabilityDAO","crunchController","crunchService","notify"],properties:[{name:"onClose",class:"Function",factory:function(){return x=>x.closeDialog()}}],messages:[{name:"TITLE",message:"Missing Capability"},{name:"LABEL_CAP_LIST",message:"CAPABILITIES"},{name:"SUBTITLE_1",message:"You are currently incapable of performing this action."},{name:"SUBTITLE_2",message:"Please refer to the following list on how to obtain the capability."}],css:`
^{
display: flex;
flex-direction: column;
width: 55vw;
padding: 24px;
max-height: 75%;
}
^container-close {
display: flex;
justify-content: flex-end;
}
^container-close button {
padding: 0;
}
^container-close img {
margin-right: 0;
width: 16px;
}
^container-title {
text-align: center;
margin-top: 16px;
}
^detail-container {
overflow-y: auto;
width: 100%;
}
^main-section {
display: flex;
flex-direction: column;
align-items: flex-start;
padding: 80px;
max-height: 60%;
overflow-y: auto;
}
^label-title {
margin: 0;
font-size: 3.2rem;
font-weight: bold;
letter-spacing: 1;
}
^label-subtitle {
margin: 0;
margin-top: 8px;
font-size: 1.6rem;
color: #5e6061;
}
^label-subtitle:last-child {
margin-top: 0;
}
^label-cap {
margin: 0;
font-weight: bold;
font-size: 1.2rem;
}
^detail-container .foam-u2-crunch-Style-mode-circle {
width: 100%;
margin: 8px 0;
}
^detail-container .foam-u2-crunch-Style-mode-circle:hover {
border-color: #f3f3f3;
}
`,methods:[function render(){this.data.capabilityOptions.forEach(c=>{if(this.crunchController.capabilityCache.has(c)&&this.crunchController.capabilityCache.get(c)){this.aquire()}});var self=this;this.addClass(this.myClass()).start().addClass(this.myClass("container-close")).startContext({data:this}).tag(this.CANCEL,{buttonStyle:"TERTIARY"}).endContext().end().start().addClass(this.myClass("container-title")).start("p").addClass(this.myClass("label-title")).add(this.TITLE).end().start().start("p").addClass(this.myClass("label-subtitle")).add(this.SUBTITLE_1).end().start("p").addClass(this.myClass("label-subtitle")).add(this.SUBTITLE_2).end().end().end().start().addClass(this.myClass("main-section")).start("p").addClass(this.myClass("label-cap")).add(this.LABEL_CAP_LIST).end().start(this.Rows).addClass(this.myClass("detail-container")).add(this.slot(function(data$capabilityOptions){return this.E().select(this.capabilityDAO.where(self.IN(self.Capability.ID,data$capabilityOptions)),cap=>{return this.E().tag(self.CapabilityCardView,{data:cap}).on("click",()=>{self.crunchController.createWizardSequence(cap.id).execute()})})})).end().end()},function aquire(x){x=x||this.__subSubContext__;this.data.aquired=true;this.data.capabilityOptions.forEach(c=>{this.crunchController.capabilityCache.set(c,true)});this.onClose(x)},function reject(x){x=x||this.__subSubContext__;this.data.cancelled=true;this.data.capabilityOptions.forEach(c=>{this.crunchController.capabilityCache.set(c,true)});this.onClose(x)}],actions:[{name:"cancel",icon:"images/ic-cancelgray.svg",label:"",code:function(x){this.reject(x)}}]});
foam.CLASS({package:"foam.u2.crunch",name:"PermissionRow",extends:"foam.nanos.auth.Permission",tableColumns:["granted","id","description"],properties:[{class:"Boolean",name:"granted",tableWidth:70,tableCellFormatter:function(value,obj){var cb=foam.u2.CheckBox.create({data:value},this);this.onDetach(cb.data$.sub(()=>{if(cb.data==value)return;obj.granted=cb.data;if(cb.data){this.__context__.addPermission(obj.id)}else{this.__context__.removePermission(obj.id)}}));this.add(cb)}}]});
foam.CLASS({package:"foam.u2.crunch",name:"PermissionsStringArrayView",extends:"foam.u2.View",implements:["foam.mlang.Expressions"],imports:["permissionDAO"],exports:["addPermission","removePermission"],requires:["foam.u2.crunch.PermissionRow","foam.dao.MDAO","foam.nanos.auth.Permission","foam.u2.crunch.PermissionSelection","foam.u2.TextField"],css:`
.foam-u2-crunch-PermissionsStringArrayView-padding {
padding-top: 8px;
}
^ .property-filteredPermissions .foam-u2-view-ScrollTableView {
height: 374px;
}
`,properties:[{class:"foam.dao.DAOProperty",name:"permissions",factory:function(){return this.MDAO.create({of:this.PermissionRow})}},{class:"foam.dao.DAOProperty",name:"filteredPermissions",expression:function(search,permissions,mode){var dao=permissions.where(this.CONTAINS(this.Permission.ID,search));if(mode==foam.u2.DisplayMode.RO)dao=dao.where(this.EQ(this.PermissionRow.GRANTED,true));return dao.orderBy(this.PermissionRow.ID)},view:{class:"foam.u2.view.ScrollTableView",editColumnsEnabled:false,pageSize:10,dblClickListenerAction:function(){}}},{class:"String",name:"search",view:{class:"foam.u2.TextField",type:"search",placeholder:"capability search",onKey:true},readVisibility:foam.u2.DisplayMode.RW},{class:"String",name:"customPermission",view:{class:"foam.u2.TextField",placeholder:"custom permission",onKey:true}},{name:"pMap",factory:function(){return{}}}],methods:[function render(){this.SUPER();var self=this;this.data.forEach(p=>{if(p=="undefined")return;this.pMap[p]=true;this.permissions.put(this.PermissionRow.create({id:p,description:"custom permission",granted:true}))});this.permissionDAO.select(p=>{if(p.id=="undefined")return;this.permissions.put(this.PermissionRow.create({id:p.id,description:p.description,granted:this.pMap[p.id]}))});this.start().addClass(this.myClass()).startContext({data:this}).start().add(this.SEARCH," ",this.CUSTOM_PERMISSION).callIf(this.mode==foam.u2.DisplayMode.RW,function(){this.add(" ",self.ADD_CUSTOM)}).end().start().add(this.FILTERED_PERMISSIONS).end().endContext().end()},function onSelectFunction(permission,isSelected){var newArr=[];if(isSelected){this.data.forEach(p=>newArr.push(p));newArr.push(permission)}else{this.data.forEach(p=>{if(p!==permission)newArr.push(p)})}this.data=newArr},function addPermission(id){if(!this.data.includes(id)){var data=foam.util.clone(this.data);data.push(id);data.sort();this.data=data;this.permissions.put(this.PermissionRow.create({id:id,description:"custom permission",granted:true}))}this.permissions.find(id).then(row=>{if(row){row.granted=true;this.permissions.put(row)}else{this.permissions.put(this.PermissionRow.create({id:id,description:"custom permission",granted:true}))}})},function removePermission(id){this.data=this.data.filter(p=>p!=id);this.permissions.find(id).then(row=>{if(row){row.granted=false;this.permissions.put(row)}})},function onSearchChanged(){this.show=!this.search||this.search.length===0||this.permission.toLowerCase().includes(this.search.toLowerCase())},function onSearchChangedSelectAll(){this.stopOnSelect=true;this.isSelected=this.isSelectedPermissionsContainThisPermission(this.permission)}],actions:[{name:"addCustom",label:"Add",isEnabled:function(customPermission){return customPermission.trim()},code:function(){this.addPermission(this.customPermission);this.customPermission=""}}]});
foam.CLASS({package:"foam.u2.crunch",name:"FlatteningCapabilityWizardlet",extends:"foam.nanos.crunch.ui.CapabilityWizardlet",implements:["foam.nanos.crunch.ui.PrerequisiteAwareWizardlet"],requires:["foam.core.ArraySlot"],properties:[{name:"before",class:"Boolean"},{name:"indicator",class:"Enum",of:"foam.u2.wizard.WizardletIndicator",setter:function(v){this.realIndicator=v}},{name:"realIndicator",class:"Enum",of:"foam.u2.wizard.WizardletIndicator",expression:function(isValid){return isValid?this.WizardletIndicator.COMPLETED:this.WizardletIndicator.PLEASE_FILL}},{class:"Boolean",name:"delegateValidationToggle",},{name:"delegates",class:"FObjectArray",of:"foam.nanos.crunch.ui.CapabilityWizardlet",postSet:function(o,n){if(this.delegatesSub_)this.delegatesSub_.detach();if(!n)return;this.delegatesSub_=foam.core.FObject.create();this.delegatesSub_.onDetach(this.ArraySlot.create({slots:n.map(delegate=>delegate.indicator$)}).map(function(indicators){indicators.push(this.realIndicator);var checkStates=["PLEASE_FILL","SAVING","COMPLETED"].map(v=>this.WizardletIndicator[v]);for(let stateToCheck of checkStates){if(indicators.some(v=>v==stateToCheck)){this.indicator=stateToCheck;return}}this.clearProperty("indicator")}));for(delegate of n){this.onDetach(delegate.isValid$.sub(x=>{this.delegateValidationToggle=!this.delegateValidationToggle}))}}},{name:"sections",flags:["web"],transient:true,class:"FObjectArray",of:"foam.u2.wizard.wizardlet.WizardletSection",preSet:function(_,val){return val},factory:function(){var sections=foam.u2.detail.AbstractSectionedDetailView.create({of:this.of},this).sections.map(section=>this.WizardletSection.create({section:section,wizardlet:this,isAvailable$:section.createIsAvailableFor(this.data$)}));var prereqSections=this.delegates.reduce((sections,delegate)=>{return sections.concat(delegate.sections)},[]);return this.before?sections.concat(prereqSections):prereqSections.concat(sections)}},{name:"isValid",class:"Boolean",expression:function(of,data,data$errors_,delegates,delegateValidationToggle){if(!this.of)return true;if(!data||data$errors_)return false;for(delegate of delegates){if(!delegate.isValid)return false}return true}}],methods:[function addPrerequisite(wizardlet){this.delegates=[...this.delegates,wizardlet];return true},async function save(...args){await foam.Promise.inOrder(this.delegates,d=>d.save(...args));return await this.wao.save(this,...args)},async function cancel(){await foam.Promise.inOrder(this.delegates,d=>d.cancel());return await this.wao.cancel(this)},async function load(){await Promise.all(this.delegates.map(d=>d.load()));return await this.wao.load(this)},{name:"getDataUpdateSub",code:function(){var s=foam.core.FObject.create();s.onDetach(this.SUPER().sub(()=>{s.pub(true)}));for(let wizardlet of this.delegates){s.onDetach(wizardlet.getDataUpdateSub().sub(()=>{s.pub(true)}))}return s}},function getPrerequisiteAvailabilitySlot(){return this.isAvailable$}]});
foam.CLASS({package:"foam.u2.crunch.lab",name:"CapabilityGraphNodeView",extends:"foam.u2.View",requires:["foam.u2.crunch.CapabilityFeatureView"],imports:["memento"],css:`
^div {
position: relative;
top: 15px;
left: 15px;
background-size: cover;
background-position: center;
background-repeat: no-repeat;
border-radius: 10px;
box-shadow: 0 1px 5px 0 rgba(0, 0, 0, 0.2);
border: solid 1px #e7eaec;
background-color: /*%WHITE%*/ #ffffff;
overflow: hidden;
}
^segment {
border-bottom: 1px solid rgba(0,0,0,0.4);
background-color: rgba(255,255,255,0.7);
padding: 8px 0;
text-align: center;
margin-bottom: 8px;
box-shadow: 0 1px 5px 0 rgba(0, 0, 0, 0.2);
}
^segment.title {
font-size: 2.0rem;
}
^segment.tiny {
font-size: 0.9rem;
width: inherit;
}
`,properties:[{name:"nodeName",value:"foreignObject"},{name:"size",class:"Array",factory:()=>[100,100]},{name:"position",class:"Array",factory:()=>[0,0]},"capabilityClickedListener","ucjClickedListener"],methods:[function render(){var self=this;var dims={x:-15,y:-15,width:""+(this.size[0]+30),height:""+(this.size[1]+30)};var capability=this.data;var ucj=null;if(Array.isArray(this.data)){capability=this.data[0];ucj=this.data[1]}this.attrs({...dims}).start("div").attrs({xmlns:"http://www.w3.org/1999/xhtml"}).addClass(this.myClass("div")).style({width:this.size[0],height:this.size[1]}).callIf(capability.icon,function(){this.style({"background-image":`url('${capability.icon}')`})}).start().addClass(this.myClass("segment")).addClass("title").add(foam.String.labelize(capability.name)).end().start("button").addClass(this.myClass("segment")).addClass("tiny").add(capability.id).on("click",function(){self.capabilityClickedListener(capability)}).end().callIf(ucj!==null,function(){this.start("button").addClass(self.myClass("segment")).callIf(ucj.status.background,function(){this.style({"background-color":ucj.status.background,width:"inherit"})}).callIf(ucj.status.color,function(){this.style({color:ucj.status.color})}).add(ucj.status.label).on("click",function(){self.ucjClickedListener(ucj)}).end()}).end()}]});
foam.CLASS({package:"foam.u2.crunch",name:"CrunchLab",extends:"foam.u2.Controller",implements:["foam.mlang.Expressions"],css:`
^ {
padding: 32px;
}
^ svg {
display: inline-block;
}
^ .foam-u2-view-RichChoiceView-selection-view {
width: 30vw;
}
^ .foam-u2-Tabs-tabRow {
margin-bottom: 30px;
}
^ .foam-u2-Tabs-content > div > div {
display: inline-flex;
vertical-align: text-bottom;
margin-right: 20px;
}
`,imports:["capabilityDAO","memento","userCapabilityJunctionDAO"],exports:["sequenceReferenceDAO"],requires:["foam.dao.PromisedDAO","foam.graph.GraphBuilder","foam.graph.map2d.RelationshipGridPlacementStrategy","foam.nanos.crunch.AgentCapabilityJunction","foam.nanos.crunch.Capability","foam.nanos.crunch.UserCapabilityJunction","foam.u2.DetailPropertyView","foam.u2.Tab","foam.u2.crunch.lab.CapabilityGraphNodeView","foam.u2.borders.SideViewBorder","foam.u2.PropertyBorder","foam.u2.view.RichChoiceSummaryIdRowView","foam.u2.svg.TreeGraph","foam.u2.svg.graph.DAGView","foam.u2.svg.map2d.IdPropertyPlacementPlanDecorator","foam.u2.Tabs"],messages:[{name:"ALL_TAB",message:"All Capabilities"},{name:"UCJ_TAB",message:"User-Capability Junction"}],properties:[{class:"Reference",name:"crunchUser",label:"User",of:"foam.nanos.auth.User",help:`User reference used to populate UCJ data on capability graph.
This user references the sourceId/owner of a user capability junction.`,view:function(_,X){return{class:"foam.u2.view.RichChoiceView",search:true,allowClearingSelection:true,rowView:{class:"foam.u2.view.RichChoiceSummaryIdRowView"},sections:[{heading:"Users",dao:X.userDAO}]}},postSet:function(o,n){if(!n)this.clearProperty("effectiveUser")}},{class:"Reference",name:"effectiveUser",of:"foam.nanos.auth.User",help:`User reference used to further filter capabilities listed for rootCapability.
This user references the effectiveUser of a capabilityJunction.`,view:function(_,X){return{class:"foam.u2.view.RichChoiceView",search:true,allowClearingSelection:true,rowView:{class:"foam.u2.view.RichChoiceSummaryIdRowView"},sections:[{heading:"Users",dao:X.userDAO}]}}},{class:"foam.dao.DAOProperty",name:"filteredCapabilityDAO",hidden:true,expression:function(showAllCapabilities,effectiveUser,crunchUser){if(crunchUser==0||showAllCapabilities)return this.capabilityDAO;let predicate=effectiveUser?this.AND(this.EQ(this.AgentCapabilityJunction.SOURCE_ID,crunchUser),this.EQ(this.AgentCapabilityJunction.EFFECTIVE_USER,effectiveUser)):this.EQ(this.UserCapabilityJunction.SOURCE_ID,crunchUser);return this.PromisedDAO.create({of:"foam.nanos.crunch.Capability",promise:this.userCapabilityJunctionDAO.where(predicate).select(this.MAP(this.UserCapabilityJunction.TARGET_ID)).then(sink=>{let capabilities=sink.delegate.array?sink.delegate.array:[];return this.capabilityDAO.where(this.IN(this.Capability.ID,capabilities.flat()))})})}},{class:"foam.dao.DAOProperty",name:"featuredCapabilityDAO",hidden:true,expression:function(filteredCapabilityDAO){return filteredCapabilityDAO.where(this.CONTAINS(this.Capability.KEYWORDS,"featured"))}},{class:"foam.dao.DAOProperty",name:"otherCapabilityDAO",hidden:true,expression:function(filteredCapabilityDAO){return filteredCapabilityDAO.where(this.NOT(this.CONTAINS(this.Capability.KEYWORDS,"featured")))}},{class:"Reference",name:"rootCapability",of:"foam.nanos.crunch.Capability",help:`Root capability reference used to populate graph.
Graph renders prerequisites downward of the selected capabilty.`,view:function(_,X){const self=X.data;return{class:"foam.u2.view.RichChoiceView",search:true,allowClearingSelection:true,rowView:{class:"foam.u2.view.RichChoiceSummaryIdRowView"},sections:[{heading:"Store Capabilities",dao$:self.featuredCapabilityDAO$},{heading:"Other Capabilities",dao$:self.otherCapabilityDAO$}]}},postSet:function(_,n){if(this.memento){if(n)this.currentMemento_=foam.nanos.controller.Memento.create({value:n});else this.currentMemento_=null}},menuKeys:["admin.capabilities"]},{class:"Boolean",name:"showAllCapabilities",value:true,help:`Toggles dropdown list to contain all capabilities instead
of a filtered list based on user selections`},{name:"relation",class:"String",value:"prerequisites"},{class:"Boolean",name:"sideVisible"},{class:"foam.u2.ViewSpec",name:"sideView"},"currentMemento_",{class:"foam.dao.DAOProperty",name:"sequenceReferenceDAO",factory:function(){return this.createSequenceReferenceDAO_()}},{class:"foam.u2.ViewSpec",name:"capabilityExperimentView",value:{class:"foam.u2.crunch.lab.CapabilityExperimentView"}}],methods:[function render(){if(this.memento){this.currentMemento_$=this.memento.tail$}this.addClass(this.myClass()).start(this.SideViewBorder,{sideVisible$:this.sideVisible$,sideView$:this.sideView$}).start("h2").add(this.cls_.name).end().start(this.Tabs).start(this.Tab,{label:this.ALL_TAB,selected:true}).tag(this.ROOT_CAPABILITY.__,{data:this}).start().style({display:"block"}).add(this.getGraphSlot()).end().end().start(this.Tab,{label:this.UCJ_TAB}).startContext({data:this}).tag(this.ROOT_CAPABILITY.__).tag(this.CRUNCH_USER.__).tag(this.EFFECTIVE_USER.__).tag(this.SHOW_ALL_CAPABILITIES.__).endContext().start().style({display:"block"}).add(this.getGraphSlot(true)).end().end().end().end();this.mementoChange()},function getGraphSlot(replaceWithUCJ){var self=this;return this.slot(function(rootCapability,crunchUser,relation){if(!rootCapability)return this.E();var graphBuilder=self.GraphBuilder.create();var rootCapabilityObj=null;var placementPlan=null;var graph=null;return self.rootCapability$find.then(o=>{rootCapabilityObj=o;return graphBuilder.fromRelationship(o,self.relation)}).then(()=>{graph=graphBuilder.build();return self.RelationshipGridPlacementStrategy.create({graph:graph}).getPlan()}).then(placementPlan_=>{placementPlan=placementPlan_;if(replaceWithUCJ){capabilityIds=Object.keys(graph.data);return self.userCapabilityJunctionDAO.where(self.AND(self.IN(self.UserCapabilityJunction.TARGET_ID,capabilityIds),self.OR(self.EQ(self.UserCapabilityJunction.SOURCE_ID,this.crunchUser),self.EQ(self.UserCapabilityJunction.SOURCE_ID,this.effectiveUser),self.AND(self.EQ(self.AgentCapabilityJunction.SOURCE_ID,this.crunchUser),self.EQ(self.AgentCapabilityJunction.EFFECTIVE_USER,this.effectiveUser))))).select().then(r=>{r.array.forEach(ucj=>{let capability=graph.data[ucj.targetId].data;graph.data[ucj.targetId].data=[capability,ucj]})})}}).then(()=>{placementPlan=this.IdPropertyPlacementPlanDecorator.create({delegate:placementPlan,targetProperty:"id"});globalThis._testing={};globalThis._testing.placementPlan=placementPlan;globalThis._testing.graph=graph;return this.E().tag(self.DAGView,{gridPlacement:placementPlan,graph:graph,nodeView:{class:this.CapabilityGraphNodeView.id,capabilityClickedListener:self.capabilityClicked,ucjClickedListener:self.ucjClicked},cellSize:[200,200],zoom:.7})})})},function createSequenceReferenceDAO_(){const dao=foam.dao.MDAO.create({of:"foam.u2.crunch.lab.SequenceReference"});const values=[{class:"foam.u2.crunch.lab.ServiceMethodSequenceReference",label:"Transient Wizard",service:"crunchController",method:"createTransientWizardSequence"},{class:"foam.u2.crunch.lab.ServiceMethodSequenceReference",label:"User-Capability Wizard",service:"crunchController",method:"createWizardSequence"}];values.map(v=>foam.json.parse(v,undefined,this.__subContext__)).forEach(obj=>dao.put(obj));return dao}],listeners:[function mementoChange(){var m=this.currentMemento_;if(m&&this.rootCapability!=m.head)this.rootCapability=m.head},function capabilityClicked(capability){this.sideView={...this.capabilityExperimentView,data:capability};this.sideVisible=true},function ucjClicked(ucj){this.sideView={class:"foam.u2.detail.TabbedDetailView",data:ucj};this.sideVisible=true}]});
foam.CLASS({package:"foam.u2.crunch.lab",name:"SequenceReference",properties:[{class:"String",name:"id",factory:function(){return foam.uuid.randomGUID()}},{class:"String",name:"label"}],methods:[function toSummary(){return this.label}]});
foam.CLASS({package:"foam.u2.crunch.lab",name:"ServiceMethodSequenceReference",extends:"foam.u2.crunch.lab.SequenceReference",properties:[{class:"String",name:"service"},{class:"String",name:"method"}],methods:[async function getSequence(){return this.__subContext__[this.service][this.method]()}]});
foam.CLASS({package:"foam.u2.crunch.lab",name:"ModifiedSequenceReference",extends:"foam.u2.crunch.lab.SequenceReference",imports:["sequenceReferenceDAO?"],properties:[{class:"String",name:"delegateId"},{class:"FObjectArray",of:"foam.core.FObject",name:"changes"}],methods:[async function getSequence(){const seq=await this.sequenceReferenceDAO.find(this.delegateId);this.changes.apply(seq);return seq}]});
foam.CLASS({package:"foam.u2.crunch.lab",name:"CapabilityExperimentView",extends:"foam.u2.detail.TabbedDetailView",css:`
^vertical {
display: flex;
flex-direction: column;
gap: 10px;
}
`,requires:["foam.u2.Tab","foam.u2.Tabs","foam.u2.borders.CollapseBorder","foam.u2.tag.Button","foam.util.AddBeforeFluentSpec","foam.util.RemoveFluentSpec"],properties:[{name:"tabs",postSet:function(_,n){this.addCrunchLabTabs_(n)}},"experimentsTab",{class:"Reference",of:"foam.u2.crunch.lab.SequenceReference",name:"sequenceReferenceId"},{class:"FObjectArray",of:"foam.util.BaseFluentSpec",name:"sequenceModifications",view:function(_,x){return{class:"foam.u2.view.DAOListWithCreateView",dao:foam.dao.ArrayDAO.create({of:"foam.util.BaseFluentSpec",array:[x.data.AddBeforeFluentSpec.create({reference:"ConfigureFlowAgent",spec:{class:"foam.u2.wizard.agents.RootCapabilityAgent",rootCapability:x.data.data.id}}),x.data.AddBeforeFluentSpec.create({reference:"CreateWizardletsAgent",spec:{class:"foam.u2.crunch.wizardflow.LoadCapabilityGraphAgent"}}),x.data.AddBeforeFluentSpec.create({reference:"CreateWizardletsAgent",spec:{class:"foam.u2.crunch.wizardflow.GraphWizardletsAgent"}}),x.data.RemoveFluentSpec.create({reference:"CreateWizardletsAgent"})]},x),valueView:{class:"foam.u2.detail.VerticalDetailView"},addView:{class:"foam.u2.view.FObjectView",of:"foam.util.BaseFluentSpec"}}}}],methods:[function addCrunchLabTabs_(el){const self=this;el.start(this.Tab,{label:"Exec"},this.experimentsTab$).addClass(this.myClass("vertical")).startContext({data:this}).tag(this.SEQUENCE_REFERENCE_ID).endContext().start({class:"foam.u2.borders.CollapseBorder",expanded:false,title:"Sequence Modifications"}).startContext({data:this}).tag(this.SEQUENCE_MODIFICATIONS).endContext().end().endContext().add(this.slot(function(sequenceReferenceId,sequenceModifications){return this.E().add(foam.core.PromiseSlot.create({promise:(async()=>{const sequenceReference=await self.sequenceReferenceId$find;if(!sequenceReference)return self.E();const sequence=await sequenceReference.getSequence();if(sequenceModifications.length>0)try{for(const mod of sequenceModifications){mod.apply(sequence)}}catch(e){console.error(e)}console.log("sequence",sequence);return self.E().start({class:"foam.u2.borders.CollapseBorder",expanded:false,title:"Resulting Sequence"}).tag(foam.flow.widgets.SequenceSummary,{sequence:sequence}).end().start(self.Button,{label:"Launch Wizard"}).on("click",()=>{sequence.execute(this.__subContext__)}).end()})()}))})).end();this.experimentsTab.selected=true}]});
foam.CLASS({package:"foam.apploader",name:"ModelGetClassDepsRefinement",refines:"foam.core.Model",methods:[{name:"getClassDeps",code:function(){var deps=this.requires?this.requires.map(function(r){return r.path}):[];deps=deps.concat(this.implements?this.implements.map(function(i){return i.path}):[]);if(this.extends)deps.push(this.extends);if(this.refines)deps.push(this.refines);return deps.map(function(d){if(d.indexOf(".")==-1)return"foam.core."+d;return d});return deps}}]});
foam.CLASS({package:"foam.classloader",name:"OrDAO",extends:"foam.dao.ProxyDAO",requires:["foam.dao.DedupSink"],properties:[{name:"primary",help:"This is the DAO to look things up in first."}],methods:[function find_(x,id){var self=this;return this.primary.find_(x,id).then(function(o){return o||self.delegate.find_(x,id)})},function select_(x,sink,skip,limit,order,predicate){var self=this;sink=sink||self.ArraySink.create();var ddSink=self.DedupSink.create({delegate:sink});return self.primary.select_(x,ddSink,skip,limit,order,predicate).then(function(){return self.delegate.select_(x,ddSink,skip,limit,order,predicate)}).then(function(){return sink})}]});
foam.CLASS({package:"foam.apploader",name:"WebModelFileFetcher",requires:["foam.net.HTTPRequest"],properties:[{name:"root",preSet:function(_,a){if(a.endsWith("/"))a=a.substring(0,a.lastIndexOf("/"));return a}}],methods:[function getFile(id){return this.HTTPRequest.create({method:"GET",url:this.root+"/"+id.replace(/\./g,"/")+".js"}).send().then(function(payload){return payload.resp.text()})}]});
foam.CLASS({package:"foam.apploader",name:"WebModelFileDAO",extends:"foam.dao.ProxyDAO",requires:["foam.apploader.ModelFileDAO","foam.apploader.WebModelFileFetcher","foam.net.HTTPRequest"],properties:["root",{name:"delegate",expression:function(root){return this.ModelFileDAO.create({fetcher:this.WebModelFileFetcher.create({root:root})})}}]});
foam.CLASS({package:"foam.apploader",name:"NoClassLoaderContext",exports:["classloader"],properties:[{name:"classloader",factory:function(){return{load:function(id){var cls=foam.maybeLookup(id);return cls?Promise.resolve(cls):Promise.reject("No classloader enabled.")},addClassPath:function(){},maybeLoad:function(id){return this.load(id).catch(function(){return null})},latch:function(){}}}}]});foam.SCRIPT({package:"foam.apploader",name:"NoClassLoaderContextScript",requires:["foam.apploader.NoClassLoaderContext"],code:function(){var classLoaderContext=foam.apploader.NoClassLoaderContext.create(null,foam.__context__);foam.__context__=classLoaderContext.__subContext__}});
foam.CLASS({package:"foam.u2",name:"FoamTagLoader",imports:["classloader","document","window"],methods:[function init(){this.window.addEventListener("load",this.onLoad,false)},function findPropertyIC(cls,name){var ps=cls.getAxiomsByClass(foam.core.Property);for(var i=0;i<ps.length;i++){if(name==ps[i].name.toLowerCase())return ps[i]}},function loadTag(el){var clsName=el.getAttribute("class");this.classloader.load(clsName).then(cls=>{var obj=cls.create(null,foam.__context__);this.setAttributes(el,obj);if(obj.element_){el.parentNode.replaceChild(obj.element_,el);obj.load&&obj.load();if(obj.id)globalThis[obj.id]=obj}else if(obj.promiseE){obj.promiseE().then(function(view){this.installView(el,view)})}else if(obj.toE){this.installView(el,obj.toE({},obj))}else if(!foam.u2.Element.isInstance(obj)){var view=foam.u2.DetailView.create({data:obj,showActions:true});el.appendChild(view.element_);view.load()}},function(e){console.error(e);console.error("Failed to load class: ",clsName)})},function installView(el,view){var id=el.id;el.outerHTML=view.outerHTML;view.load();if(id)globalThis[id]=view},function setAttributes(el,obj){for(var j=0;j<el.attributes.length;j++){var attr=el.attributes[j];var p=this.findPropertyIC(obj.cls_,attr.name);if(p)p.set(obj,p.fromString(attr.value))}}],listeners:[function onLoad(){var els=Array.from(this.document.getElementsByTagName("foam"));this.window.removeEventListener("load",this.onLoad);els.forEach(this.loadTag.bind(this))}]});foam.SCRIPT({package:"foam.u2",name:"FoamTagLoaderScript",requires:["foam.u2.FoamTagLoader"],flags:["web"],code:function(){globalThis.window&&foam.u2.FoamTagLoader.create()}});
foam.CLASS({package:"foam.graphics",name:"Transform",properties:[{class:"Simple",name:"a"},{class:"Simple",name:"b"},{class:"Simple",name:"c"},{class:"Simple",name:"d"},{class:"Simple",name:"e"},{class:"Simple",name:"f"},{class:"Simple",name:"g"},{class:"Simple",name:"h"},{class:"Simple",name:"i"},{name:"inverse_",factory:function(){return this.cls_.create()},compare:function(){return 0}}],methods:[function initArgs(){this.a=1;this.b=0;this.c=0;this.d=0;this.e=1;this.f=0;this.g=0;this.h=0;this.i=1},function mul(a,b,c,d,e,f,g,h,i){var ta=this.a,tb=this.b,tc=this.c,td=this.d,te=this.e,tf=this.f,tg=this.g,th=this.h,ti=this.i;this.a=ta*a+tb*d+tc*g;this.b=ta*b+tb*e+tc*h;this.c=ta*c+tb*f+tc*i;this.d=td*a+te*d+tf*g;this.e=td*b+te*e+tf*h;this.f=td*c+te*f+tf*i;this.g=tg*a+th*d+ti*g;this.h=tg*b+th*e+ti*h;this.i=tg*c+th*f+ti*i;return this},function mulT(t){return this.mul(t.a,t.b,t.c,t.d,t.e,t.f,t.g,t.h,t.i)},function mulP(p){var ta=this.a,tb=this.b,tc=this.c,td=this.d,te=this.e,tf=this.f,tg=this.g,th=this.h,ti=this.i;var a=p.x;var d=p.y;var g=p.w;p.x=ta*a+tb*d+tc*g;p.y=td*a+te*d+tf*g;p.w=tg*a+th*d+ti*g;return this},function affine(m){return this.mul(m.a,m.b,m.c,m.d,m.e,m.f,m.g,m.h,m.i)},function transpose(){var tmp=this.b;this.b=this.d;this.d=tmp;tmp=this.c;this.c=this.g;this.g=tmp;tmp=this.f;this.f=this.h;this.h=tmp;return this},function invert(){var ta=this.a,tb=this.b,tc=this.c,td=this.d,te=this.e,tf=this.f,tg=this.g,th=this.h,ti=this.i;var det=ta*(te*ti-tf*th)-tb*(td*ti-tf*tg)+tc*(td*th-te*tg);var detinv=1/det;var inv=this.inverse_;inv.a=detinv*(te*ti-tf*th);inv.b=detinv*(tc*th-tb*ti);inv.c=detinv*(tb*tf-tc*te);inv.d=detinv*(tf*tg-td*ti);inv.e=detinv*(ta*ti-tc*tg);inv.f=detinv*(tc*td-ta*tf);inv.g=detinv*(td*th-te*tg);inv.h=detinv*(tb*tg-ta*th);inv.i=detinv*(ta*te-tb*td);return inv},function det(){var a=this.a,b=this.b,c=this.c,d=this.d,e=this.e,f=this.f,g=this.g,h=this.h,i=this.i;return a*(e*i-f*h)-b*(d*i-f*g)+c*(d*h-e*g)},function reset(){this.initArgs();return this},function translate(dx,dy){if(dx||dy)this.mul(1,0,dx,0,1,dy,0,0,1);return this},function skew(x,y){if(x||y)this.mul(1,x,0,y,1,0,0,0,1);return this},function scale(x,y){if(y===undefined)y=x;if(x!=1||y!=1)this.mul(x,0,0,0,y,0,0,0,1);return this},function rotate(a){if(a)this.mul(Math.cos(a),Math.sin(a),0,-Math.sin(a),Math.cos(a),0,0,0,1);return this},function rotateAround(a,x,y){return this.translate(-x,-y).rotate(a).translate(x,y)}]});
foam.CLASS({package:"foam.graphics",name:"Transform3D",properties:[{class:"Simple",name:"a"},{class:"Simple",name:"b"},{class:"Simple",name:"c"},{class:"Simple",name:"d"},{class:"Simple",name:"e"},{class:"Simple",name:"f"},{class:"Simple",name:"g"},{class:"Simple",name:"h"},{class:"Simple",name:"i"},{class:"Simple",name:"j"},{class:"Simple",name:"k"},{class:"Simple",name:"l"},{class:"Simple",name:"m"},{class:"Simple",name:"n"},{class:"Simple",name:"o"},{class:"Simple",name:"p"}],methods:[function init(){this.a=1;this.b=0;this.c=0;this.d=0;this.e=0;this.f=1;this.g=0;this.h=0;this.i=0;this.j=0;this.k=1;this.l=0;this.m=0;this.n=0;this.o=0;this.p=1},function mulM(o){return this.mul(o.a,o.b,o.c,o.d,o.e,o.f,o.h,o.i,o.j,o.j,o.k,o.l,o.m,o.n,o.o,o.p)},function mulP(p){var ta=this.a,tb=this.b,tc=this.c,td=this.d,te=this.e,tf=this.f,tg=this.g,th=this.h,ti=this.i,tj=this.j,tk=this.k,tl=this.l,tm=this.m,tn=this.n,to=this.o,tp=this.p;var a=p.x;var b=p.y;var c=p.z;var d=p.w;p.x=ta*a+tb*b+tc*c+td*d;p.y=te*a+tf*b+tg*c+th*d;p.z=ti*a+tj*b+tk*c+tl*d;p.w=tm*a+tn*b+to*c+tp*d;return this},function mul(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p){var ta=this.a,tb=this.b,tc=this.c,td=this.d,te=this.e,tf=this.f,tg=this.g,th=this.h,ti=this.i,tj=this.j,tk=this.k,tl=this.l,tm=this.m,tn=this.n,to=this.o,tp=this.p;this.a=ta*a+tb*e+tc*i+td*m;this.b=ta*b+tb*f+tc*j+td*n;this.c=ta*c+tb*g+tc*k+td*o;this.d=ta*d+tb*h+tc*l+td*p;this.e=te*a+tf*e+tg*i+th*m;this.f=te*b+tf*f+tg*j+th*n;this.g=te*c+tf*g+tg*k+th*o;this.h=te*d+tf*h+tg*l+th*p;this.i=ti*a+tj*e+tk*i+tl*m;this.j=ti*b+tj*f+tk*j+tl*n;this.k=ti*c+tj*g+tk*k+tl*o;this.l=ti*d+tj*h+tk*l+tl*p;this.m=tm*a+tn*e+to*i+tp*m;this.n=tm*b+tn*f+to*j+tp*n;this.o=tm*c+tn*g+to*k+tp*o;this.p=tm*d+tn*h+to*l+tp*p;return this},function affine(m){return this.mul(m.a,m.b,m.c,m.d,m.e,m.f,m.g,m.h,m.i,m.j,m.k,m.l,m.m,m.n,m.o,m.p)},function invert(){var tmp=this.b;this.b=this.e;this.e=tmp;tmp=this.c;this.c=this.i;this.i=tmp;tmp=this.d;this.d=this.m;this.m=tmp;tmp=this.g;this.g=this.j;this.j=tmp;tmp=this.h;this.h=this.n;this.n=tmp;tmp=this.l;this.l=this.o;this.o=tmp;return this},function reset(){this.init();return this},function translate(dx,dy,dz){if(!dx&&!dy&&!dz)return;this.mul(1,0,0,dx,0,1,0,dy,0,0,1,dz,0,0,0,1)},function skew(x,y,z){if(!x&&!y&&!z)return;throw new Error("not implemented yet.")},function scale(x,y,z){if(x===1&&y===1&&z==1)return;this.mul(x,0,0,0,0,y,0,0,0,0,z,0,0,0,0,1)},function rotateX(a){if(!a)return;var c=Math.cos(a);var s=Math.sin(a);this.mul(1,0,0,0,0,c,-s,0,0,s,c,0,0,0,0,1)},function rotateY(a){if(!a)return;var c=Math.cos(a);var s=Math.sin(a);this.mul(c,0,s,0,0,1,0,0,-s,0,c,0,0,0,0,1)},function rotateZ(a){if(!a)return;var c=Math.cos(a);var s=Math.sin(a);this.mul(c,-s,0,0,s,c,0,0,0,0,1,0,0,0,0,1)},function rotate(x,y,z,r){var d=Math.sqrt(x*x+y*y+z*z);x/=d;y/=d;z/=d;var cos=Math.cos(r);var sin=Math.sin(r);this.mul(cos+x*x*(1-cos),x*y*(1-cos)-z*sin,x*z*(1-cos)+y*sin,0,y*x*(1-cos)+z*sin,cos+y*y*(1-cos),y*z*(1-cos)-x*sin,0,z*x*(1-cos)-y*sin,z*y*(1-cos)+x*sin,cos+z*z*(1-cos),0,0,0,0,1)}]});
foam.CLASS({package:"foam.graphics",name:"CView",requires:["foam.graphics.Canvas","foam.graphics.Transform"],topics:["invalidated"],properties:[{class:"Float",name:"width"},{class:"Float",name:"height"},{class:"Float",name:"rotation",preSet:function(_,r){if(r>2*Math.PI)return r-2*Math.PI;if(r<-2*Math.PI)return r+2*Math.PI;return r},view:{class:"foam.u2.view.DualView",viewa:{class:"foam.u2.FloatView",precision:4,onKey:true},viewb:{class:"foam.u2.RangeView",step:1e-5,minValue:-Math.PI*2,maxValue:Math.PI*2,onKey:true}}},{name:"originX",class:"Float"},{name:"originY",class:"Float"},{name:"scaleX",class:"Float",value:1},{name:"scaleY",class:"Float",value:1},{name:"skewX",class:"Float",hidden:true},{name:"skewY",class:"Float",hidden:true},{name:"x",class:"Float"},{name:"y",class:"Float"},{name:"alpha",class:"Float",view:{class:"foam.u2.view.DualView",viewa:{class:"foam.u2.FloatView",precision:4,onKey:true},viewb:{class:"foam.u2.RangeView",step:1e-4,maxValue:1,onKey:true}},value:1},{class:"Color",name:"border"},{class:"Color",name:"color"},{class:"Color",name:"shadowColor"},{class:"Int",name:"shadowBlur",units:"pixels"},{name:"children",factory:function(){return[]},postSet:function(o,n){for(var i=0;o&&i<o.length;i++)this.removeChild_(o[i]);for(var i=0;n&&i<n.length;i++)this.addChild_(n[i])},hidden:true},{name:"state",value:"initial",hidden:"true",transient:true},{name:"parent",hidden:"true",transient:true},{name:"canvas",hidden:"true",transient:true,expression:function(parent$canvas){return parent$canvas}},{name:"transform_",hidden:"true",transient:true,factory:function(){return this.Transform.create()}},{name:"transform",hidden:"true",expression:function getTransform(x,originX,y,originY,rotation,skewX,skewY,scaleX,scaleY){var t=this.transform_.reset();t.translate(x+originX,y+originY);t.rotate(rotation);t.skew(skewX,skewY);t.scale(scaleX,scaleY);t.translate(-originX,-originY);return t}},{class:"Boolean",name:"autoRepaint",hidden:true,value:true},{name:"x_",hidden:true,transient:true,getter:function(){return this.x+this.width/2}},{name:"y_",hidden:true,transient:true,getter:function(){return this.y+this.height/2}},{name:"top_",hidden:true,transient:true,getter:function(){return this.y}},{name:"left_",hidden:true,transient:true,getter:function(){return this.x}},{name:"bottom_",hidden:true,transient:true,getter:function(){return this.y+this.height}},{name:"right_",hidden:true,transient:true,getter:function(){return this.x+this.width}},{name:"invalidate_",transient:true,hidden:true,getter:function(){return this.parent?this.parent.invalidate_:this.autoRepaint?this.invalidated.pub:null}}],methods:[function initCView(){this.invalidate_&&this.propertyChange.sub(this.invalidate_)},function invalidate(){this.invalidate_&&this.invalidate_()},function parentToLocalCoordinates(p){this.transform.invert().mulP(p);p.x/=p.w;p.y/=p.w;p.w=1;return p},function globalToLocalCoordinates(p){if(this.parent)p=this.parent.globalToLocalCoordinates(p);return this.parentToLocalCoordinates(p)},function localToGlobalCoordinates(p){var curr=this;while(curr){curr.transform.mulP(p);p.x*=p.w;p.y*=p.w;p.w=1;curr=curr.parent}return p},function findFirstChildAt(p){if(arguments.length>1){var tmp=foam.graphics.Point.create();tmp.x=arguments[0];tmp.y=arguments[1];tmp.w=1;p=tmp}this.parentToLocalCoordinates(p);if(this.children.length){var p2=foam.graphics.Point.create();for(var i=0;i<this.children.length;i++){p2.x=p.x;p2.y=p.y;p2.w=p.w;var c=this.children[i].findFirstChildAt(p2);if(c)return c}}if(this.hitTest(p))return this},function hitTest(p){return p.x>=0&&p.y>=0&&p.x<this.width&&p.y<this.height},function maybeInitCView(x){if(this.state==="initial"){this.state="initailized";this.initCView(x)}},function paint(x){this.maybeInitCView(x);x.save();var alpha=this.alpha,border=this.border,color=this.color,shadowColor=this.shadowColor,shadowBlur=this.shadowBlur;if(alpha!==1){x.globalAlpha*=alpha}if(border){x.strokeStyle=border.toCanvasStyle?border.toCanvasStyle(x):border}if(color){x.fillStyle=color.toCanvasStyle?color.toCanvasStyle(x):color}this.doTransform(x);if(shadowColor&&shadowBlur){x.shadowColor=shadowColor;x.shadowBlur=shadowBlur}this.paintSelf(x);this.paintChildren(x);x.restore()},function doTransform(x){var t=this.transform;x.transform(t.a,t.d,t.b,t.e,t.c,t.f)},function paintChildren(x){for(var i=0;i<this.children.length;i++){this.children[i].paint(x)}},function remove(c){for(var i=0;i<this.children.length;i++){if(this.children[i]===c){this.children.splice(i,1);this.removeChild_(c);return}}},function removeAllChildren(){var children=this.children;this.children=[];for(var i=0;i<children.length;i++){this.removeChild_(children[i])}},function removeChild(c){console.log("Deprecated use of CView.removeChild(). Use .remove() instead.");this.remove(c)},function addChild_(c){c.parent=this;return c},function removeChild_(c){c.parent=undefined;c.canvas=undefined;this.invalidate();return c},function add(){for(var i=0;i<arguments.length;i++){this.children.push(arguments[i]);this.addChild_(arguments[i])}this.invalidate();return this},function addChildren(){console.warn("Deprecated use of CView.addChildren(). Use add() instead.");return this.add.apply(this,arguments)},function paintSelf(x){},function hsl(h,s,l){return"hsl("+h+","+s+"%,"+l+"%)"},function write(){return this.toE().write()},function toE(args,X){return this.Canvas.create({cview:this},X).attrs({width:this.slot(function(x,width,scaleX){return x+width*scaleX}),height:this.slot(function(y,height,scaleY){return y+height*scaleY})})},function intersects(c){if(c.RADIUS){return!(this.x+this.width<c.x-c.radius||this.y+this.height<c.y-c.radius||c.x+c.radius<this.x||c.y+c.radius<this.y)}return!(this.x+this.width<c.x||this.y+this.height<c.y||c.x+c.width<this.x||c.y+c.height<this.y)},function equals(b){return this===b}]});
foam.CLASS({package:"foam.graphics",name:"CView3D",requires:["foam.graphics.Transform3D"],properties:[{class:"Float",name:"x"},{class:"Float",name:"y"},{class:"Float",name:"z"},{class:"Float",name:"rotateX"},{class:"Float",name:"rotateY"},{class:"Float",name:"rotateZ"},{class:"Float",name:"scaleX",value:1},{class:"Float",name:"scaleY",value:1},{class:"Float",name:"scaleZ",value:1},{name:"transform_",factory:function(){return this.Transform3D.create()}},{name:"transform",getter:function(){var t=this.transform_.reset();t.translate(this.x,this.y,this.z);t.rotateX(this.rotateX);t.rotateY(this.rotateY);t.rotateZ(this.rotateZ);t.scale(this.scaleX,this.scaleY,this.scaleZ);return t}}],methods:[function paint3D(gl){this.paintSelf(gl)},function paintSelf(gl){gl.bindBuffer(gl.ARRAY_BUFFER,this.vertexBuffer);gl.enableVertexAttribArray(this.positionAttribute);gl.vertexAttribPoint(this.positionAttribute);gl.drawArrays(this.drawType,0,this.vertexCount)}]});
foam.CLASS({package:"foam.graphics",name:"Box",extends:"foam.graphics.CView",properties:[{class:"Float",name:"width"},{class:"Float",name:"height"},{class:"Float",name:"borderWidth",value:1},{name:"border",value:"#000000"},{class:"Boolean",name:"clip"}],methods:[function paintSelf(x){x.beginPath();x.rect(0,0,this.width,this.height);if(this.border&&this.borderWidth){x.lineWidth=this.borderWidth;x.stroke()}if(this.color)x.fill();if(this.clip)x.clip()}]});
foam.CLASS({package:"foam.graphics",name:"Line",extends:"foam.graphics.CView",properties:[{class:"Float",name:"startX",getter:function(){return this.x},setter:function(v){this.x=v}},{class:"Float",name:"startY",getter:function(){return this.y},setter:function(v){this.y=v}},{class:"Float",name:"endX"},{class:"Float",name:"endY"},{class:"Float",name:"lineWidth",value:1},{class:"foam.core.Color",name:"color",value:"#000000"},{name:"lineDash",}],methods:[function paintSelf(x){x.beginPath();if(this.lineDash)x.setLineDash(this.lineDash);x.moveTo(0,0);x.lineTo(this.endX-this.x,this.endY-this.y);x.lineWidth=this.lineWidth;x.strokeStyle=this.color;x.stroke()},function hitTest(p){var ax=p.x-this.startX;var ay=p.y-this.startY;var bx=this.endX-this.startX;var by=this.endY-this.startY;var blen=Math.sqrt(bx*bx+by*by);var scalarProj=(ax*bx+ay*by)/blen;var factor=scalarProj/blen;var projX=bx*factor;var projY=by*factor;var rejX=ax-projX;var rejY=ay-projY;var distance=Math.sqrt(rejX*rejX+rejY*rejY);var pos=scalarProj;return distance<5&&pos>-5&&pos<blen+5;return false}]});
foam.CLASS({package:"foam.graphics",name:"Polygon",extends:"foam.graphics.CView",properties:[{class:"Array",of:"Float",name:"xCoordinates"},{class:"Array",of:"Float",name:"yCoordinates"},{class:"foam.core.Color",name:"color",value:"#000"},{class:"Float",name:"lineWidth",value:1}],methods:[function paintSelf(x){x.beginPath();x.moveTo(this.xCoordinates[0],this.yCoordinates[0]);for(var i=1;i<this.xCoordinates.length;i++){x.lineTo(this.xCoordinates[i],this.yCoordinates[i])}x.lineWidth=this.lineWidth;x.strokeStyle=this.color;x.stroke()}]});
foam.CLASS({package:"foam.graphics",name:"Arc",extends:"foam.graphics.CView",properties:[{name:"radius",class:"Float",preSet:function(_,r){return Math.max(0,r)}},{name:"start",class:"Float"},{name:"end",class:"Float"},{name:"arcWidth",class:"Float"},{name:"border",value:"#000000"},{name:"x_",hidden:true,transient:true,getter:function(){return this.x}},{name:"y_",hidden:true,transient:true,getter:function(){return this.y}},{name:"top_",hidden:true,transient:true,getter:function(){return this.y-this.radius-this.arcWidth}},{name:"left_",hidden:true,transient:true,getter:function(){return this.x-this.radius-this.arcWidth}},{name:"bottom_",hidden:true,transient:true,getter:function(){return this.y+this.radius+this.arcWidth}},{name:"right_",hidden:true,transient:true,getter:function(){return this.x+this.radius+this.arcWidth}}],methods:[function paintSelf(x){x.beginPath();x.arc(0,0,this.radius,this.start,this.end);if(this.color)x.fill();if(this.border){x.lineWidth=this.arcWidth;x.stroke()}},function hitTest(p){var r=this.radius+this.arcWidth/2-1;return p.x*p.x+p.y*p.y<=r*r},function intersects(c){if(!c.RADIUS)return c.intersects(this);var r=this.radius+c.radius;if(this.border)r+=this.arcWidth/2-1;if(c.border)r+=c.arcWidth/2-1;var dx=this.x-c.x;var dy=this.y-c.y;return dx*dx+dy*dy<=r*r},function toE(args,X){return this.Canvas.create({cview:this},X).attrs({width:this.x+this.radius+this.arcWidth,height:this.y+this.radius+this.arcWidth})}]});
foam.CLASS({package:"foam.graphics",name:"RegularPolygon",extends:"foam.graphics.Arc",properties:[{class:"Int",name:"sides"}],methods:[function paintSelf(x){var r=this.radius,sides=this.sides;x.beginPath();for(var i=0;i<=sides+1;i++){x[i?"lineTo":"moveTo"](r*Math.cos(2*Math.PI*i/sides),r*Math.sin(2*Math.PI*i/sides))}if(this.color)x.fill();if(this.border){x.lineWidth=this.arcWidth;x.stroke()}}]});
foam.CLASS({package:"foam.graphics",name:"Circle",extends:"foam.graphics.Arc",properties:[{name:"start",value:0,view:{class:"foam.u2.view.DualView",viewa:{class:"foam.u2.FloatView",precision:4,onKey:true},viewb:{class:"foam.u2.RangeView",maxValue:Math.PI*2,step:.01,onKey:true}}},{name:"end",value:2*Math.PI,view:{class:"foam.u2.view.DualView",viewa:{class:"foam.u2.FloatView",precision:4,onKey:true},viewb:{class:"foam.u2.RangeView",maxValue:Math.PI*2,step:.01,onKey:true}}}],methods:[function paintSelf(x){x.beginPath();x.arc(0,0,this.radius,this.start,this.end);if(this.start!=0||this.end!=Math.PI*2){x.lineTo(0,0);x.lineTo(this.radius*Math.cos(this.start)+.5,this.radius*Math.sin(this.start))}if(this.color)x.fill();if(this.border){x.lineWidth=this.arcWidth;x.stroke()}}]});
foam.CLASS({package:"foam.graphics",name:"Ellipse",extends:"foam.graphics.CView",properties:[{class:"Float",name:"radiusX",preSet:function(_,r){return Math.max(0,r)}},{class:"Float",name:"radiusY",preSet:function(_,r){return Math.max(0,r)}},{name:"start",value:0,view:{class:"foam.u2.view.DualView",viewa:{class:"foam.u2.FloatView",precision:4,onKey:true},viewb:{class:"foam.u2.RangeView",maxValue:Math.PI*2,step:.01,onKey:true}}},{name:"end",value:2*Math.PI,view:{class:"foam.u2.view.DualView",viewa:{class:"foam.u2.FloatView",precision:4,onKey:true},viewb:{class:"foam.u2.RangeView",maxValue:Math.PI*2,step:.01,onKey:true}}},{name:"borderWidth",class:"Float"},{name:"border",value:"#000000"},{class:"Float",name:"width",getter:function(){return 2*this.radiusX},setter:function(w){this.radiusX=w/2}},{class:"Float",name:"height",getter:function(){return 2*this.radiusY},setter:function(h){this.radiusY=h/2}},{name:"x_",hidden:true,transient:true,getter:function(){return this.x}},{name:"y_",hidden:true,transient:true,getter:function(){return this.y}},{name:"top_",hidden:true,transient:true,getter:function(){return this.y}},{name:"left_",hidden:true,transient:true,getter:function(){return this.x}},{name:"bottom_",hidden:true,transient:true,getter:function(){return this.y+2*this.radiusY}},{name:"right_",hidden:true,transient:true,getter:function(){return this.x+2*this.radiusX}}],methods:[function paintSelf(x){x.beginPath();x.ellipse(this.radiusX,this.radiusY,this.radiusX,this.radiusY,0,this.start,this.end);if(this.color)x.fill();if(this.border){x.lineWidth=this.borderWidth;x.stroke()}}]});
foam.CLASS({package:"foam.graphics",name:"Point",properties:[{class:"Simple",name:"x"},{class:"Simple",name:"y"},{class:"Simple",name:"w"}],methods:[function clone(){var p=this.cls_.create();p.x=this.x;p.y=this.y;p.w=this.w;return p},function toCartesian(){this.x=this.x/this.w;this.y=this.y/this.w;this.w=1}]});
foam.CLASS({package:"foam.graphics",name:"Canvas",extends:"foam.u2.Element",requires:["foam.input.Pointer"],properties:[["nodeName","CANVAS"],{name:"context",factory:function(){return this.el_().getContext("2d")}},{name:"context3D",factory:function(){return this.el_().getContext("webgl")}},{name:"cview",postSet:function(o,n){n.canvas=this;if(this.attributeMap.width===undefined||this.attributeMap.height===undefined){this.setAttribute("width",n.width);this.setAttribute("height",n.height)}this.paint()}},{name:"pointer",factory:function(){return this.Pointer.create({element:this})}}],methods:[function render(){this.SUPER();this.sub("onload",this.paint);this.cview$.valueSub("invalidated",this.paint)},function erase(){this.el_().width=this.el_().width}],listeners:[{name:"paint",isFramed:true,code:function paintCanvas(){if(this.state!==this.LOADED||!this.cview)return;var ctx=this.cview.paint3D?this.context3D:this.context;this.erase(ctx);if(this.cview.paint3D){this.cview.paint3D(ctx)}else{this.cview.paint(ctx)}}}]});
foam.CLASS({package:"foam.graphics",name:"Gradient",properties:["x0","y0","r0","x1","y1","r1",{name:"radial",class:"Boolean",value:false},{name:"colors",factory:function(){return[]}}],methods:[function toCanvasStyle(x){var t=this;var g=this.radial?x.createRadialGradient(t.x0,t.y0,t.r0,t.x1,t.y1,t.r1):x.createLinearGradient(t.x0,t.y0,t.x1,t.y1);for(var i=0;i<t.colors.length;i++)g.addColorStop(t.colors[i][0],t.colors[i][1]);return g}]});
foam.CLASS({package:"foam.graphics",name:"Label",extends:"foam.graphics.CView",properties:[{class:"String",name:"text",view:{class:"foam.u2.TextField",onKey:true}},{name:"align",label:"Alignment",value:"start",view:{class:"foam.u2.view.RadioView",choices:["start","center","end"]}},{class:"String",name:"font"},{class:"Color",name:"color",value:"#000000"},{class:"Color",name:"border",label:"Border Color"},{class:"Float",name:"maxWidth",label:"Maximum Width",value:-1}],methods:[function paintSelf(c){if(this.font)c.font=this.font;c.textAlign=this.align;c.fillStyle=this.color;c.fillText(this.text,this.align==="start"?0:this.align==="center"?this.width/2:this.width,this.height/2+10);if(this.border){c.strokeStyle=this.border;c.strokeRect(0,0,this.width-1,this.height-1)}}]});
foam.CLASS({package:"foam.graphics",name:"TreeGraph",extends:"foam.graphics.Box",requires:["foam.graphics.TreeNode"],exports:["as graph","formatNode","relationship","isAutoExpandedByDefault","childNodesForAutoExpansion"],properties:[["nodeWidth",155],["nodeHeight",60],["lineWidth",.5],["padding",30],["color","white"],{name:"data"},{name:"relationship"},"root",{name:"formatNode",value:function(){}},{class:"Boolean",name:"isAutoExpandedByDefault",value:true},{class:"Int",name:"childNodesForAutoExpansion",value:5}],topics:["onSizeChangeComplete"],methods:[function initCView(){this.SUPER();if(this.data){this.root=this.TreeNode.create({width:this.nodeWidth,height:this.nodeHeight,padding:this.padding,lineWidth:this.lineWidth,y:this.nodeHeight*2,data:this.data});this.add(this.root);this.doLayout()}}],listeners:[{name:"doLayout",isMerged:true,code:function(){if(this.root&&this.root.layout()){this.invalidate();this.doLayout()}else{this.updateCSize()}}},{name:"updateCSize",isFramed:true,code:function(){const maxes={maxLeft:Number.MAX_SAFE_INTEGER,maxRight:Number.MIN_SAFE_INTEGER};this.root.outline.forEach(level=>{maxes.maxLeft=Math.min(level.left,maxes.maxLeft);maxes.maxRight=Math.max(level.right,maxes.maxRight)});var width=Math.abs(maxes.maxLeft-maxes.maxRight);var height=this.nodeHeight*2*(this.root.outline.length+1);if(this.width!=width||this.height!=height){this.width=width;this.height=height;this.root.centerX=0;this.root.centerX=-Math.min.apply(Math,this.root.outline.map(o=>o.left));this.invalidate();this.doLayout()}else{this.onSizeChangeComplete.pub()}}}]});
foam.CLASS({package:"foam.graphics",name:"TreeNode",extends:"foam.graphics.Box",requires:["foam.graphics.Box","foam.graphics.CView","foam.graphics.Label","foam.graphics.Line"],imports:["formatNode","graph","parentNode?","relationship","isAutoExpandedByDefault","childNodesForAutoExpansion"],exports:["as parentNode"],properties:["data",["height",155],["width",60],["padding",30],["lineWidth",.5],["border","gray"],["color","white"],{name:"outline",expression:function(x,width,expanded,childNodes,padding){var outlineBelowRoot=[];for(let i=0;i<childNodes.length&&expanded;i++){var childOutline=childNodes[i].outline.map(o=>({left:o.left+x,right:o.right+x}));for(var j=0;j<childOutline.length;j++){outlineBelowRoot[j]=outlineBelowRoot[j]||{left:Number.MAX_SAFE_INTEGER,right:Number.MIN_SAFE_INTEGER};outlineBelowRoot[j].left=Math.min(childOutline[j].left,outlineBelowRoot[j].left);outlineBelowRoot[j].right=Math.max(childOutline[j].right,outlineBelowRoot[j].right)}}var rootLevelOutline=[{left:x-width/2-padding/2,right:x+width/2+padding/2}];return rootLevelOutline.concat(outlineBelowRoot)}},{name:"childNodes",factory:function(){return[]}},{name:"x",expression:function(neighborX,centerX){return neighborX+centerX}},{class:"Float",name:"neighborX",},{class:"Float",name:"centerX",},{class:"Boolean",name:"expanded",expression:function(isAutoExpandedByDefault,childNodesForAutoExpansion,childNodes){if(isAutoExpandedByDefault){return childNodes.length<childNodesForAutoExpansion}return false},postSet:function(){this.graph.doLayout()}}],methods:[function initCView(){this.SUPER();this.formatNode();if(this.relationship){this.data[this.relationship.forwardName].select(childData=>{this.addChildNode({data:childData,width:this.width,height:this.height,padding:this.padding,lineWidth:this.lineWidth})})}this.canvas.on("click",e=>{var p=this.parent;while(this.cls_.isInstance(p)){if(!p.expanded)return;p=p.parent}var point=this.globalToLocalCoordinates({w:1,x:e.offsetX,y:e.offsetY});point.x+=this.width/2;if(this.hitTest(point)){this.expanded=!this.expanded}})},function paint(x){if(!this.parentNode||this.parentNode.expanded)this.SUPER(x)},function paintSelf(x){x.save();x.translate(-this.width/2,0);this.SUPER(x);x.restore();this.paintConnectors(x)},function paintConnectors(x){function line(x1,y1,x2,y2){x.beginPath();x.moveTo(x1,y1);x.lineTo(x2,y2);x.stroke()}x.lineWidth=this.lineWidth;x.strokeStyle=this.border;if(this.expanded&&this.childNodes.length){var h=this.childNodes[0].y*3/4;var l=this.childNodes.length;line(0,this.height,0,h);for(var i=0;i<l;i++){var c=this.childNodes[i];line(0,h,c.x,h);line(c.x,h,c.x,c.y)}}x.lineWidth=this.borderWidth;if(this.childNodes.length){var d=this.expanded?5:-5;var y=this.height-8;line(-5,y,0,y+d);line(0,y+d,5,y)}},function addChildNode(args){var node=this.cls_.create(args,this);node.y=this.height*2;this.add(node);this.childNodes=this.childNodes.concat(node);node.outline$.sub(()=>{this.outline=[];this.outline=undefined});return this},function distanceTo(node){minLevels=Math.min(this.outline.length,node.outline.length);var minDistance=Number.MAX_SAFE_INTEGER;for(var i=0;i<minLevels;i++){var overlapDistance=node.outline[i].left-this.outline[i].right;minDistance=Math.min(minDistance,overlapDistance)}return minDistance},function layout(){var moved=false;for(var i=0;i<this.childNodes.length;i++){var n1=this.childNodes[i];for(var j=i+1;j<this.childNodes.length;j++){var n2=this.childNodes[j];var distance=n1.distanceTo(n2);if(distance<0){n2.neighborX-=distance;moved=true}}}for(var i=0;i<this.childNodes.length-1;i++){var n1=this.childNodes[i];var n2=this.childNodes[i+1];var distance=n1.distanceTo(n2);if(distance>0){for(var j=0;j<i;j++){var n3=this.childNodes[j];distance=Math.min(distance,n3.distanceTo(n2))}if(distance){n2.neighborX-=distance;moved=true}}}for(var i=0;i<this.childNodes.length;i++){if(this.childNodes[i].layout())moved=true}if(this.outline[1]){var rootLevelWidth=this.outline[0].right-this.outline[0].left;var childLevelWidth=this.outline[1].right-this.outline[1].left;var d=-(childLevelWidth-rootLevelWidth)/2;this.childNodes.forEach(c=>{if(c.centerX!=d){c.centerX=d;moved=true}})}return moved},function findNode(id){if(this.data.id===id)return this;for(var i=0;i<this.childNodes.length;i++){var foundNode=this.childNodes[i].findNode(id);if(foundNode)return foundNode}}]});
foam.CLASS({package:"foam.graphics",name:"ScrollCView",extends:"foam.graphics.CView",properties:[{class:"Float",name:"width",value:20},{class:"Float",name:"height",value:100},{class:"Boolean",name:"vertical",value:true},{class:"Int",name:"value",preSet:function(_,value){return Math.max(0,Math.min(this.size-this.extent,value))},postSet:function(old,nu){if(old!==nu)this.invalidated.pub()}},{class:"Int",name:"extent",value:10,postSet:function(old,nu){if(old!==nu)this.invalidated.pub()}},{class:"Int",name:"size",value:0,postSet:function(old,size){if(old!==size)this.invalidated.pub();this.value=this.value}},{class:"Int",name:"minHandleSize",value:10},{class:"Float",name:"handleSize",expression:function(minHandleSize,size,extent,height,innerBorder){var h=height-2*innerBorder;var hs=size>0?extent*h/size:0;return hs<minHandleSize?minHandleSize:hs}},{class:"Int",name:"innerBorder",value:2},{class:"String",name:"handleColor",value:"rgb(107,136,173)"},{class:"String",name:"borderColor",value:"#999"},{name:"yMax",expression:function(height,innerBorder,handleSize){return height-innerBorder-handleSize}},{name:"rate",expression:function(size,extent,yMax,innerBorder){return size?(yMax-innerBorder)/(size-extent):0}}],methods:[function initCView(){this.onDetach(this.canvas.pointer.touch.sub(this.onTouch));var self=this;var mouseInput=this.canvas.pointer.mouseInput;this.onDetach(mouseInput.down.sub(function(){var moveSub=mouseInput.move.sub(function(){self.value=self.yToValue(mouseInput.y)});mouseInput.up.sub(function(s){moveSub.detach();s.detach()})}))},function yToValue(y){return(y-this.innerBorder)/this.rate},function valueToY(value){return value*this.rate+this.innerBorder},function paintSelf(c){if(!this.size)return;if(!c)return;if(this.extent>=this.size)return;c.strokeStyle=this.borderColor;c.lineWidth=.4;c.strokeRect(0,0,this.width,this.height);c.fillStyle=this.handleColor;c.fillRect(2,this.valueToY(this.value),this.width-4,this.handleSize)}],listeners:[{name:"onTouch",code:function(_,__,touch){this.value=this.yToValue(touch.y);touch.claimed=true}}]});
foam.CLASS({package:"foam.physics",name:"PhysicalCircle",extends:"foam.graphics.Circle",implements:["foam.physics.Physical"],});
foam.CLASS({package:"foam.u2.view",name:"SimpleSearch",extends:"foam.u2.View",requires:["foam.u2.search.SearchManager"],imports:["dao","memento"],exports:["as filterController","as data","currentMemento_ as memento"],properties:[{class:"Class",name:"of"},{name:"data"},{class:"Int",name:"selectedCount"},{class:"Int",name:"totalCount"},{class:"String",name:"countText",expression:function(selectedCount,totalCount){var singular=this.dao.of.name.toLowerCase();var plural=this.dao.of.model_.plural.toLowerCase();var word=totalCount===1?singular:plural;var format=int=>int.toString().replace(/\B(?=(\d{3})+(?!\d))/g,",");return selectedCount!==totalCount?`Showing ${format(selectedCount)} out of ${format(totalCount)} ${plural}`:`${format(totalCount)} ${word}`}},{name:"searchManager"},{class:"Boolean",name:"showCount",value:true},"currentMemento_"],methods:[function render(){var self=this;if(this.memento){if(!this.memento.tail){this.memento.tail=foam.nanos.controller.Memento.create()}this.currentMemento_$=this.memento.tail$}this.dao.on.sub(this.updateTotalCount);this.updateTotalCount();this.searchManager=self.SearchManager.create({dao:this.dao,predicate$:this.data$});this.searchManager.filteredDAO$.sub(self.updateSelectedCount);self.updateSelectedCount(0,0,0,this.searchManager.filteredDAO$);var generalQueryView=foam.u2.ViewSpec.createView({class:"foam.u2.search.TextSearchView"},{richSearch:true,of:this.dao.of.id,onKey:true,viewSpec:{class:"foam.u2.SearchField",focused:true}},this,this.__subSubContext__);this.searchManager.add(generalQueryView);this.addClass(this.myClass()).start().tag(generalQueryView).end().callIf(this.showCount,function(){this.start("p").add(self.countText$).end()})}],listeners:[{name:"updateTotalCount",isFramed:true,code:function(){this.dao.select(foam.mlang.sink.Count.create()).then(function(c){this.totalCount=c.value}.bind(this));this.updateSelectedCount(0,0,0,this.searchManager.filteredDAO$)}},{name:"updateSelectedCount",isFramed:true,code:function(_,__,___,dao){dao.get().select(foam.mlang.sink.Count.create()).then(function(c){this.selectedCount=c.value}.bind(this))}}]});foam.ENUM({package:"foam.comics",name:"SearchMode",values:[{name:"FULL",label:"Full",},{name:"NONE",label:"None",},{name:"SIMPLE",label:"Simple",}]});
foam.CLASS({package:"foam.comics",name:"DAOController",requires:["foam.comics.SearchMode","foam.u2.borders.NullBorder","foam.nanos.export.CSVTableExportDriver"],topics:["finished"],exports:["filteredTableColumns"],properties:[{class:"StringArray",name:"filteredTableColumns"},{name:"data",hidden:true},{name:"predicate"},{name:"csvDriver",factory:function(){return this.CSVTableExportDriver.create()}},{name:"filteredDAO",view:{class:"foam.u2.view.ScrollTableView"},expression:function(data,predicate){return predicate?data.where(predicate):data}},{name:"relationship"},{name:"selection",hidden:true},{class:"Boolean",name:"createEnabled",value:true},{class:"Boolean",name:"editEnabled",value:true},{class:"Boolean",name:"selectEnabled",value:false},{class:"Boolean",name:"exportEnabled",value:true},{class:"Boolean",name:"exportCSVEnabled",},{class:"Boolean",name:"toggleEnabled",value:true},{name:"border",factory:function(){return this.NullBorder.create()}},{class:"Boolean",name:"searchHidden",value:false},{class:"Enum",of:"foam.comics.SearchMode",name:"searchMode",factory:function(){return this.SearchMode.FULL}},{name:"searchColumns",},{class:"String",name:"title",expression:function(data$of){return data$of.model_.plural}},{class:"String",name:"subtitle"},{class:"FObjectProperty",of:"foam.core.Action",name:"primaryAction",factory:function(){return this.relationship?this.SELECT:this.cls_.CREATE}},{class:"foam.u2.ViewSpec",name:"summaryView",},{class:"String",name:"createLabel",},{class:"foam.u2.ViewSpec",name:"detailView",factory:function(){var sectionName=undefined;var hasManySections=false;var cls=this.data.of;while(foam.core.FObject.isSubClass(cls)&&foam.core.FObject!==cls){if(cls.model_.sections){hasManySections=cls.model_.sections.length>1;if(!hasManySections&&cls.model_.sections.length===1){sectionName=sectionName||cls.model_.sections[0].name;hasManySections=sectionName!==cls.model_.sections[0].name}}if(hasManySections)break;cls=cls.getSuperClass()}var classId=hasManySections?"foam.u2.detail.TabbedDetailView":"foam.u2.detail.SectionedDetailView";return{class:classId,of:this.data.of}}},"selectedObjects"],actions:[{name:"create",isAvailable:function(createEnabled){return createEnabled},code:function(){}},{name:"edit",isEnabled:function(selection){return!!selection},isAvailable:function(editEnabled){return editEnabled},code:function(){this.pub("edit",this.selection.id)}},{name:"select",isAvailable:function(selectEnabled){return selectEnabled},isEnabled:function(selection,selectedObjects){return this.relationship?!!selectedObjects:!!selection},code:function(){this.pub("select",this.relationship?this.selectedObjects:this.selection.id);this.finished.pub()}},{name:"export",isAvailable:function(exportEnabled){return exportEnabled},code:function(){this.pub("export",this.filteredDAO)}},{name:"exportCSV",label:"Export as CSV",icon:"images/export-icon-resting.svg",isAvailable:function(exportCSVEnabled){return exportCSVEnabled},code:function(x){this.downloadCSV(x,this.filteredDAO)}}],listeners:[function downloadCSV(x,data){this.csvDriver.exportDAO(x,data).then(function(result){let encodedUri=encodeURIComponent(result);let uri="data:text/csv;charset=utf-8,"+encodedUri;var link=document.createElement("a");link.setAttribute("href",uri);link.setAttribute("download","data.csv");document.body.appendChild(link);link.click();document.body.removeChild(link)})}]});
foam.CLASS({package:"foam.comics",name:"DAOControllerView",extends:"foam.u2.View",requires:["foam.comics.SearchMode","foam.comics.DAOController","foam.comics.DAOUpdateControllerView","foam.nanos.controller.Memento","foam.nanos.u2.navigation.IFrameTopNavigation","foam.u2.dialog.Popup","foam.u2.view.ScrollTableView"],imports:["createControllerView? as importedCreateControllerView","data? as importedData","stack","summaryView? as importedSummaryView","updateView? as importedUpdateView","translationService"],exports:["as controllerView","data.selection as selection","data.data as dao","data.filteredTableColumns as filteredTableColumns","data.searchColumns as searchColumns","dblclick as click","dblclick"],css:`
^ {
margin: 24px auto 0 auto;
padding: 0 32px;
}
^top-row {
align-items: center;
margin-bottom: 10px;
}
^separate {
display: flex;
justify-content: space-between;
}
^title-container > * {
color: /*%BLACK%*/ #1e1f21;
margin: 0;
}
^container {
padding: 0 0px;
}
^ .actions {
display: inline-block;
margin-bottom: 8px;
}
^ .actions button + button {
margin-left: 8px;
}
^full-search-container {
flex: 0 0 250px;
padding-right: 18px;
width: 250px;
float: left;
padding-top: 23px;
}
^manual-width-adjust {
width: inherit;
}
`,properties:[{class:"FObjectProperty",of:"foam.comics.DAOController",name:"data",expression:function(importedData){return importedData}},{name:"cls",expression:function(data){return data.cls_}},{class:"foam.u2.ViewSpec",name:"defaultSummaryView_",value:{class:"foam.u2.table.TableView"}},{class:"foam.u2.ViewSpec",name:"summaryView",factory:function(){return this.data.summaryView||this.importedSummaryView||this.defaultSummaryView_}},{name:"createControllerView",expression:function(data){return this.importedCreateControllerView||{class:"foam.comics.DAOCreateControllerView",detailView:data.detailView}}},{name:"updateView",expression:function(){return this.importedUpdateView||{class:"foam.comics.DAOUpdateControllerView"}}}],reactions:[["data","action.create","onCreate"],["data","edit","onEdit"],["data","finished","onFinished"],["data","export","onExport"]],methods:[function render(){var self=this;var summaryViewParent;var reciprocalSearch=foam.u2.ViewSpec.createView({class:"foam.u2.view.ReciprocalSearch",data$:this.data.predicate$},{},self,self.__subContext__.createSubContext({memento_:this.memento_}));var searchView=foam.u2.ViewSpec.createView({class:"foam.u2.view.SimpleSearch",data$:this.data.predicate$},{},self,reciprocalSearch.__subContext__.createSubContext());if(this.data.searchMode===this.SearchMode.FULL){summaryViewParent=reciprocalSearch}if(this.data.searchMode===this.SearchMode.SIMPLE){summaryViewParent=searchView}var summaryView=foam.u2.ViewSpec.createView(this.summaryView,{data$:this.data.filteredDAO$,multiSelectEnabled:!!this.data.relationship,selectedObjects$:this.data.selectedObjects$},{},summaryViewParent);this.data.border.add(this.E().addClass(this.myClass()).start().start().addClass(this.myClass("top-row")).addClass(this.myClass("separate")).start().addClass(this.myClass("title-container")).start("h1").translate(this.data.title,this.data.title).end().start().translate(this.data.subtitle,this.data.subtitle).end().end().callIfElse(self.data.createLabel,function(){this.tag(self.data.primaryAction,{label:self.translationService.getTranslation(foam.locale,`${self.createControllerView.menu}.createLabel`,self.data.createLabel),size:"LARGE",buttonStyle:foam.u2.ButtonStyle.PRIMARY})},function(){this.start().tag(self.data.primaryAction,{size:"LARGE",buttonStyle:foam.u2.ButtonStyle.PRIMARY}).end()}).end().start().addClass(this.myClass("container")).callIf(this.data.searchMode===this.SearchMode.FULL,function(){this.start().hide(self.data.searchHidden$).addClass(self.myClass("full-search-container")).add(reciprocalSearch).end()}).start().addClass(this.myClass("manual-width-adjust")).start().addClass(this.myClass("separate")).callIf(this.data.searchMode===this.SearchMode.SIMPLE,function(){this.start().add(searchView).end()}).start().show(self.mode$.map(m=>m===foam.u2.DisplayMode.RW)).forEach(self.cls.getAxiomsByClass(foam.core.Action).filter(action=>{return action.name!==self.data.primaryAction.name}),function(action){this.tag(action,{buttonStyle:"LINK"})}).add().end().end().add(summaryView).end().end().end());this.add(this.data.border);if(this.isIframe())this.tag(this.IFrameTopNavigation)},function isIframe(){try{return globalThis.self!==globalThis.top}catch(e){return true}},function dblclick(obj,id){if(this.data.dblclick){this.data.dblclick(obj,obj&&obj.id?obj.id:id)}else{this.onEdit(null,null,obj&&obj.id?obj.id:id)}}],listeners:[function onCreate(){this.stack.push(this.createControllerView,this.__subContext__)},function onEdit(s,edit,id){this.stack.push({class:this.updateView.class,detailView:this.data.detailView,editEnabled:this.data.editEnabled,key:id},this.__subContext__)},function onFinished(){this.stack.back()},function onExport(dao){this.add(this.Popup.create().tag({class:"foam.u2.ExportModal",exportData:dao.src.filteredDAO}))}]});
foam.CLASS({package:"foam.comics",name:"InlineDAOControllerView",extends:"foam.comics.DAOControllerView",exports:["click","click as dblclick"],imports:["stack"],properties:[{class:"foam.u2.ViewSpec",name:"defaultSummaryView_",value:{class:"foam.u2.view.EmbeddedTableView"}}],methods:[function render(){this.currentMemento_=this.memento;this.tag(this.summaryView,{data$:this.data.filteredDAO$,multiSelectEnabled:this.data.relationship,selectedObjects$:this.data.selectedObjects$}).start("span").show(this.mode$.map(function(m){return m==foam.u2.DisplayMode.RW})).add(this.cls.getAxiomsByClass(foam.core.Action)).end()},function click(obj,id){if(!this.stack)return;ctrl.stack.push({class:"foam.comics.v2.DAOSummaryView",data:obj,config:foam.comics.v2.DAOControllerConfig.create({dao:this.__subContext__[this.data.data.targetDAOKey]}),idOfRecord:id,backLabel:"Back"},this.__subContext__.createSubContext({memento:this.memento}))}]});
foam.CLASS({package:"foam.comics",name:"DAOCreateController",topics:["finished","throwError"],properties:[{name:"dao"},{class:"Boolean",name:"inProgress"},{name:"exception"},{name:"view",value:"foam.u2.DetailView"},{name:"factory",factory:function(){return this.dao?this.dao.of:()=>null}},{name:"data",factory:function(){return this.factory.create({},this)}}],actions:[{name:"save",buttonStyle:"PRIMARY",isEnabled:function(dao,data$errors_,inProgress){return!!dao&&!inProgress&&!data$errors_},code:function(){this.inProgress=true;this.clearProperty("exception");var self=this;this.dao.put(this.data.clone()).then(function(){self.inProgress=false;self.finished.pub()},function(e){self.inProgress=false;self.exception=e;self.throwError.pub()})}}]});
foam.CLASS({package:"foam.comics",name:"DAOCreateControllerView",extends:"foam.u2.View",requires:["foam.comics.DAOCreateController","foam.log.LogLevel","foam.nanos.notification.Notification","foam.nanos.notification.ToastState","foam.u2.DisplayMode"],imports:["dao","notify","stack"],exports:["data"],css:`
^ {
width: 1024px;
margin: auto;
}
^action-container {
display: flex;
justify-content: space-between;
margin: 8px 0;
}
^action-container > div > div > * + * {
margin-left: 8px;
}
^detail-container {
overflow-x: auto;
}
`,properties:[{class:"FObjectProperty",of:"foam.comics.DAOCreateController",name:"data",factory:function(){return this.DAOCreateController.create({dao:this.dao})}},{class:"String",name:"title",expression:function(data$dao$of){return"Create "+data$dao$of.name}},{class:"foam.u2.ViewSpec",name:"detailView"}],reactions:[["data","finished","onFinished"],["data","throwError","onThrowError"]],methods:[function render(){this.addClass(this.myClass()).start().addClass(this.myClass("action-container")).start().startContext({data:this}).tag(this.CANCEL).endContext().end().start().start().show(this.mode$.map(m=>m===this.DisplayMode.RW)).add(this.data.cls_.getAxiomsByClass(foam.core.Action)).end().end().end().start().addClass(this.myClass("detail-container")).tag({class:"foam.u2.view.FObjectView",of:this.dao.of,data$:this.data$.dot("data"),dataView:this.detailView}).end()}],actions:[{name:"cancel",code:function(){this.stack.back()}}],listeners:[function onFinished(){this.stack.back()},function onThrowError(){var self=this;self.notify(self.data.exception.message,"",self.LogLevel.ERROR,true)}]});
foam.CLASS({package:"foam.comics",name:"DAOUpdateController",topics:["finished","throwError"],properties:[{name:"dao"},{name:"data"},{name:"exception"},{name:"obj",factory:function(){this.dao.find(this.data).then(obj=>this.obj=obj.clone());return null}}],actions:[{name:"save",isEnabled:function(obj){return!!obj},code:function(){var self=this;this.dao.put(this.obj.clone()).then(function(){self.finished.pub()},function(e){self.exception=e;self.throwError.pub()})}},{name:"delete",isEnabled:function(obj){return!!obj},confirmationRequired:function(){return true},code:function(){var self=this;this.dao.remove(this.obj).then(function(){self.finished.pub()},function(e){self.exception=e;self.throwError.pub()})}}]});
foam.CLASS({package:"foam.comics",name:"DAOUpdateControllerView",extends:"foam.u2.View",requires:["foam.comics.DAOUpdateController","foam.log.LogLevel","foam.nanos.controller.Memento","foam.u2.ControllerMode","foam.u2.DisplayMode"],imports:["dao? as importedDAO","notify","memento","stack"],exports:["controllerMode","data","memento"],css:`
^ {
max-width: 1024px;
margin: auto;
}
^action-container {
display: flex;
justify-content: space-between;
margin: 8px 0;
}
^action-container > div > div > * + * {
margin-left: 8px;
}
^detail-container {
overflow-x: auto;
}
`,properties:[{name:"key"},{class:"foam.dao.DAOProperty",name:"dao",factory:function(){return this.importedDAO}},{class:"FObjectProperty",of:"foam.comics.DAOUpdateController",name:"data",factory:function(){return this.DAOUpdateController.create({data:this.key,dao:this.dao})}},{class:"String",name:"title",expression:function(data$dao$of){return"Edit "+data$dao$of.name}},{class:"foam.u2.ViewSpec",name:"detailView"},{name:"controllerMode",factory:function(){return this.ControllerMode.VIEW}},{class:"Boolean",name:"editEnabled"},{class:"FObjectProperty",of:"foam.u2.Element",name:"container_"},{class:"FObjectProperty",of:"foam.u2.Element",name:"detailViewElement_"},"currentMemento_",{class:"String",name:"mementoHead",value:"Edit"}],reactions:[["data","finished","onFinished"],["data","throwError","onThrowError"]],methods:[function render(){if(this.memento)this.currentMemento_$=this.memento.tail$;this.addClass(this.myClass()).start().addClass(this.myClass("action-container")).start().startContext({data:this}).tag(this.CANCEL,{buttonStyle:"SECONDARY"}).endContext().end().start().start().show(this.mode$.map(m=>m===this.DisplayMode.RW)).add(this.data.cls_.getAxiomsByClass(foam.core.Action)).end().start().show(this.mode$.map(m=>m===this.DisplayMode.RO)).startContext({data:this}).add(this.EDIT).endContext().end().end().end().start("div",[],this.container_$).addClass(this.myClass("detail-container")).tag(this.detailView,{of:this.dao.of,data$:this.data$.dot("obj"),showActions:true},this.detailViewElement_$).end()}],actions:[{name:"cancel",code:function(){this.stack.back()}},{name:"edit",isAvailable:function(controllerMode,editEnabled){return editEnabled&&controllerMode===this.ControllerMode.VIEW},code:function(){this.controllerMode=this.ControllerMode.EDIT;var newE=this.container_.createChild_(this.detailView,{of:this.dao.of,data$:this.data$.dot("obj"),showActions:true});this.container_.replaceChild(newE,this.detailViewElement_);this.detailViewElement_=newE}}],listeners:[function onFinished(){this.stack.back()},function onThrowError(){var self=this;self.notify(self.data.exception.message,"",self.LogLevel.ERROR,true)}]});
foam.CLASS({package:"foam.comics",name:"BrowserView",extends:"foam.u2.View",requires:["foam.comics.DAOController","foam.comics.DAOControllerView"],imports:["memento"],exports:["controller as data","createControllerView","memento","serviceName","summaryView","updateView"],properties:[{name:"data"},{name:"title",expression:function(data$of){return data$of.model_.plural}},{class:"String",name:"subtitle"},{class:"String",name:"customDAOController"},{class:"String",name:"createLabel",},{class:"Enum",of:"foam.comics.SearchMode",name:"searchMode",},{class:"Boolean",name:"createEnabled",value:true,},{class:"Boolean",name:"editEnabled",value:true},{class:"Boolean",name:"selectEnabled",value:true,},{class:"Boolean",name:"exportEnabled",value:true},{class:"Boolean",name:"exportCSVEnabled",},{class:"Boolean",name:"toggleEnabled",},{name:"controller",expression:function(data,title,subtitle,customDAOController,createLabel,searchMode,createEnabled,editEnabled,selectEnabled,exportEnabled,exportCSVEnabled,toggleEnabled,detailView){var config={};if(createLabel)config.createLabel=createLabel;if(searchMode)config.searchMode=searchMode;if(subtitle)config.subtitle=subtitle;if(title)config.title=title;if(detailView)config.detailView=detailView;config.createEnabled=createEnabled;config.editEnabled=editEnabled;config.exportEnabled=exportEnabled;config.exportCSVEnabled=exportCSVEnabled;config.selectEnabled=selectEnabled;config.toggleEnabled=toggleEnabled;if(customDAOController){var controller=this.__context__.lookup(customDAOController).create(config,this);controller.data=controller.data||data;return controller}config.data=data;return this.DAOController.create(config,this)}},{class:"foam.u2.ViewSpec",name:"summaryView",fromJSON:function fromJSON(value,ctx,prop,json){return value}},"updateView","createControllerView",{class:"foam.u2.ViewSpec",name:"detailView"},{name:"serviceName",class:"String",factory:function(){return this.config&&this.config.daoKey?this.config.daoKey:this.returnServiceName(this.data)}}],methods:[function render(){this.addClass(this.myClass()).addClass(this.myClass(this.data.of.id.replace(/\./g,"-"))).tag(this.DAOControllerView)},function returnServiceName(data){if(!data)return;if(data.serviceName)return data.serviceName;if(!data.delegate)return null;return this.returnServiceName(data.delegate)}]});
foam.CLASS({package:"foam.comics",name:"InlineBrowserView",extends:"foam.comics.BrowserView",requires:["foam.comics.InlineDAOControllerView as DAOControllerView"]});
foam.CLASS({package:"foam.comics",name:"RelationshipView",extends:"foam.comics.InlineBrowserView",properties:[{name:"controller",expression:function(data){return this.DAOController.create({data:data.dao,relationship:data})}}]});
foam.CLASS({package:"foam.u2.view",name:"ReciprocalSearch",extends:"foam.u2.View",requires:["foam.core.SimpleSlot","foam.u2.search.SearchManager","foam.u2.search.TextSearchView","foam.u2.view.SearchViewWrapper"],imports:["dao","memento","searchColumns","translationService"],exports:["as filterController","as data","currentMemento_ as memento","searchManager"],css:`
^ {
background-color: /*%WHITE%*/ #ffffff;
border-radius: 2px;
min-width: 250px;
}
^ input {
font-size: medium;
}
^ .foam-u2-tag-Input {
width: 100%;
}
^ input:not([type="checkbox"]):focus,
^ select:focus {
outline: none;
border: 1px solid /*%PRIMARY3%*/ #406dea;
}
^ .general-query {
padding: 16px 20px;
}
^count {
font-size: 12pt;
color: #555;
margin: 20px 20px 0 20px;
}
^ .foam-u2-ActionView-clear {
margin: 20px;
}
`,messages:[{name:"SELECTED_TEXT",message:"selected"},{name:"OF_TEXT",message:"of"}],properties:[{class:"Class",name:"of"},{name:"data"},{class:"Array",name:"filters",factory:null,expression:function(dao,searchColumns){var of=dao&&dao.of;if(!of)return[];if(searchColumns)return searchColumns;var searchColumnsAxiom=of.getAxiomByName("searchColumns");if(searchColumnsAxiom!=null&&Array.isArray(searchColumnsAxiom.columns)){return searchColumnsAxiom.columns}var tableColumnsAxiom=of.getAxiomByName("tableColumns");if(tableColumnsAxiom!=null&&Array.isArray(tableColumnsAxiom.columns)){return tableColumnsAxiom.columns.filter(function(c){var axiom=of.getAxiomByName(c);return axiom&&axiom.searchView})}return of.getAxiomsByClass(foam.core.Property).filter(prop=>prop.searchView&&!prop.hidden).map(foam.core.Property.NAME.f)}},{class:"Int",name:"selectedCount"},{class:"Int",name:"totalCount"},{name:"searchManager",factory:function(){return this.SearchManager.create({dao$:this.dao$,predicate$:this.data$})}},{class:"Int",name:"loadingRequests",},{class:"String",name:"countText",expression:function(selectedCount,totalCount,loadingRequests){var selected_=ctrl.__subContext__.translationService.getTranslation(foam.locale,"foam.u2.view.ReciprocalSearch.SELECTED",this.SELECTED_TEXT);var of_=ctrl.__subContext__.translationService.getTranslation(foam.locale,"foam.u2.view.ReciprocalSearch.OF",this.OF_TEXT);if(loadingRequests>0){return"Loading..."}return`${selectedCount.toLocaleString(foam.locale)} `+of_+` ${totalCount.toLocaleString(foam.locale)} `+selected_}},"currentMemento_"],methods:[function render(){var self=this;this.dao.on.sub(this.updateTotalCount);this.dao.on.sub(function(){self.updateSelectedCount(0,0,0,self.searchManager.filteredDAO$)});this.updateTotalCount();var m;if(this.memento){m=this.memento.tail||this.memento;if(!m.tail){m.tail=foam.nanos.controller.Memento.create()}m=this.memento.tail||this.memento;this.currentMemento_=this.memento.tail}var counter=this.filters.length;this.addClass(self.myClass()).add(this.slot(function(filters){this.searchManager.filteredDAO$.sub(self.updateSelectedCount);self.updateSelectedCount(0,0,0,this.searchManager.filteredDAO$);var e=this.E("div");e.onDetach(this.searchManager);var searchView=foam.u2.ViewSpec.createView(self.TextSearchView,{richSearch:true,of:self.dao.of.id,onKey:true,viewSpec:{class:"foam.u2.SearchField",focused:true}},this,this.__subContext__.createSubContext({memento:this.memento?this.memento.tail:this.memento}));var slot=self.SimpleSlot.create({value:searchView});e.start().tag(slot).addClass("general-query").end();if(this.memento&&this.memento.tail)m=this.memento.tail.tail;else m=null;this.searchManager.add(slot.value);e.forEach(filters,function(f){var axiom=self.dao.of.getAxiomByName(f);var localM=m;var propView=foam.u2.ViewSpec.createView(self.SearchViewWrapper,{searchView:axiom.searchView,property:axiom,dao:self.dao},self,self.__subSubContext__.createSubContext({memento:localM}));this.start().add(propView).addClass(self.myClass("filter")).end();if(self.memento&&m){if(!m.tail)m.tail=foam.nanos.controller.Memento.create();counter--;if(counter!=0)m=m.tail}});return e},this.filters$)).start().addClass(self.myClass("count")).add(self.countText$).end().tag(this.CLEAR,{buttonStyle:"SECONDARY"});this.currentMemento_=m},function addFilter(key){this.filters=this.filters.concat(key)},function removeFilter(key){this.filters=this.filters.filter(function(k){return key!==k})}],actions:[{name:"clear",code:function(){this.data=undefined;this.filters=this.filters.slice()}}],listeners:[{name:"updateTotalCount",isMerged:true,mergeDelay:250,code:function(){this.loadingRequests++;this.dao.select(foam.mlang.sink.Count.create()).then(c=>{this.totalCount=c.value}).finally(()=>{this.loadingRequests--})}},{name:"updateSelectedCount",isMerged:true,mergeDelay:500,code:function(_,__,___,sink){this.loadingRequests++;sink.get().select(foam.mlang.sink.Count.create()).then(c=>{this.selectedCount=c.value}).finally(()=>{this.loadingRequests--})}}]});foam.SCRIPT({package:"foam.net",name:"WebLibScript",flags:["web"],requires:["foam.net.web.HTTPRequest","foam.net.web.HTTPRequestScript","foam.net.web.HTTPResponse","foam.net.web.WebSocket","foam.net.web.WebSocketService"],code:function(){var pkg="foam.net.web";var clss=["BaseHTTPRequest","HTTPRequest","HTTPResponse","WebSocket","WebSocketService"];for(var i=0;i<clss.length;i++){foam.register(foam.lookup(pkg+"."+clss[i]),"foam.net."+clss[i])}}});
foam.CLASS({package:"foam.net",name:"RetryHTTPRequest",extends:"foam.net.BaseHTTPRequest",requires:["foam.net.BaseHTTPRequest"],imports:["error","warn"],properties:[{class:"Int",name:"numTries",value:4},{class:"Proxy",of:"foam.net.BaseHTTPRequest",name:"delegate",factory:function(){return this.BaseHTTPRequest.create(this)}},{class:"Int",name:"currentTry_"}],methods:[function send(){return this.delegate.send().catch(this.onError)}],listeners:[function onError(error){this.currentTry_++;this.__context__.warn("RetryHTTPRequest: Try #"+this.currentTry_+" failed on "+error);if(this.currentTry_<this.numTries){return this.send()}else{this.error("RetryHTTPRequest: Max tries reached");throw new Error("RetryHTTPRequest: Max tries reached")}}]});
foam.CLASS({package:"foam.net.auth",name:"TokenBearerCredential",properties:[{class:"String",name:"accessToken"},{class:"Int",name:"expiry"}]});
foam.CLASS({package:"foam.net.auth",name:"AuthAwareHTTPRequest",extends:"foam.net.BaseHTTPRequest",requires:["foam.net.BaseHTTPRequest"],imports:["authAgent? as ctxAuthAgent"],properties:[{class:"Proxy",of:"foam.net.BaseHTTPRequest",name:"delegate",factory:function(){return this.BaseHTTPRequest.create(this)}},{class:"FObjectProperty",of:"foam.net.auth.AuthAgent",name:"authAgent",factory:function(){return this.ctxAuthAgent||null}}],methods:[function send(){var send=this.delegate.send.bind(this.delegate);if(!this.authAgent)return send();if(!this.authAgent.requiresAuthorization(this))return send();return this.authAgent.getCredential().then(this.onGetCredential).then(send).then(this.onAuthorizedResponse)}],listeners:[{name:"onGetCredential",code:function(){throw new Error("Abstract AuthAwareHTTPRequest doesn't understand "+"credentials")}},{name:"onAuthorizedResponse",code:function(response){if(response.status!==401)return response;var send=this.delegate.send.bind(this.delegate);return this.authAgent.refreshCredential().then(this.onGetCredential).then(send).then(this.onRetryResponse)}},{name:"onRetryResponse",code:function(response){if(response.status!==401)return response;throw new Error("Authorization failed: Request rejected after forced credential refresh")}}]});
foam.CLASS({package:"foam.net.auth",name:"TokenBearerHTTPRequest",extends:"foam.net.auth.AuthAwareHTTPRequest",listeners:[function onGetCredential(credential){this.delegate.headers["Authorization"]="Bearer "+credential.accessToken}]});
foam.CLASS({package:"foam.net.auth",name:"AuthAgent",exports:["as authAgent"],properties:[{class:"Function",name:"requiresAuthorization",required:true}],methods:[function init(){this.validate();this.SUPER()},function validate(){this.SUPER();foam.assert(this.__context__.lookup("foam.net.BaseHTTPRequest")!==this.__subContext__.lookup("foam.net.HTTPRequest"),"AuthAgent implementation must register its HTTPRequest decorator "+"as foam.net.HTTPRequest")},{name:"getCredential",code:function(){return Promise.reject(new Error("Unable to get credential"))}},{name:"refreshCredential",code:function(){return Promise.reject(new Error("Unable to refresh credential"))}}]});
foam.CLASS({package:"foam.u2.view",name:"FObjectArrayTableView",extends:"foam.u2.View",requires:["foam.comics.v2.DAOBrowserView","foam.dao.MDAO"],properties:[{class:"Class",name:"of",expression:function(data){return data[0].cls_}}],methods:[function fromProperty(p){this.of=p.of},function render(){var self=this;self.SUPER();self.add(self.slot(function(data){var dao=self.MDAO.create({of:self.of});data.forEach(d=>dao.put(d));return self.DAOBrowserView.create({data:dao})}))}]});
foam.CLASS({package:"foam.doc",name:"CodeTabs",extends:"foam.u2.UnstyledTabs",css:`
^ {
background: gray;
display: block;
padding: 10px 4px;
}
^tabRow { height: 38px; }
^tab {
background: lightgray;
border: 1px solid black;
border-radius: 3px 3px 0 0;
display: inline-block;
height: 12px;
padding: 8px;
}
^tab.selected {
background:/*%WHITE%*/ #ffffff;
position: relative;
z-index: 1;
}
^bottomEdge {
background:/*%WHITE%*/ #ffffff;
height: 2.5px;
left: 0;
position: absolute;
top: 27px;
width: 100%;
}
^content {
margin: 4px;
padding: 6px;
background:/*%WHITE%*/ #ffffff;
border: 1px solid black;
position: relative;
top: -13px;
left: -4px;
}
`});foam.SCRIPT({package:"foam.parser.html",name:"LibScript",code:function(){var selfClosingNodeNames={area:true,base:true,br:true,col:true,command:true,embed:true,hr:true,img:true,input:true,keygen:true,link:true,meta:true,param:true,source:true,track:true,wbr:true};var unescapeMap={"#100":"d","#101":"e","#102":"f","#103":"g","#104":"h","#105":"i","#106":"j","#107":"k","#108":"l","#109":"m","#110":"n","#111":"o","#112":"p","#113":"q","#114":"r","#115":"s","#116":"t","#117":"u","#118":"v","#119":"w","#120":"x","#121":"y","#122":"z","#123":"{","#124":"|","#125":"}","#126":"~","#160":" ","#161":"¡","#162":"¢","#163":"£","#164":"¤","#165":"¥","#166":"¦","#167":"§","#168":"¨","#169":"©","#170":"ª","#171":"«","#172":"¬","#174":"®","#175":"¯","#176":"°","#177":"±","#178":"²","#179":"³","#180":"´","#181":"µ","#182":"¶","#183":"·","#184":"¸","#185":"¹","#186":"º","#187":"»","#188":"¼","#189":"½","#19":"Å","#190":"¾","#191":"¿","#192":"À","#193":"Á","#194":"Â","#195":"Ã","#196":"Ä","#198":"Æ","#199":"Ç","#200":"È","#201":"É","#202":"Ê","#203":"Ë","#204":"Ì","#205":"Í","#206":"Î","#207":"Ï","#208":"Ð","#209":"Ñ","#210":"Ò","#211":"Ó","#212":"Ô","#213":"Õ","#214":"Ö","#215":"×","#216":"Ø","#217":"Ù","#218":"Ú","#219":"Û","#220":"Ü","#221":"Ý","#222":"Þ","#223":"ß","#224":"à","#225":"á","#226":"â","#227":"ã","#228":"ä","#229":"å","#23":"í","#230":"æ","#231":"ç","#232":"è","#233":"é","#234":"ê","#235":"ë","#236":"ì","#238":"î","#239":"ï","#240":"ð","#241":"ñ","#242":"ò","#243":"ó","#244":"ô","#245":"õ","#246":"ö","#247":"÷","#248":"ø","#249":"ù","#250":"ú","#251":"û","#252":"ü","#253":"ý","#254":"þ","#255":"ÿ","#256":"Ā","#257":"ā","#258":"Ă","#259":"ă","#260":"Ą","#261":"ą","#262":"Ć","#263":"ć","#264":"Ĉ","#265":"ĉ","#266":"Ċ","#267":"ċ","#268":"Č","#269":"č","#27":"ĕ","#270":"Ď","#271":"ď","#272":"Đ","#273":"đ","#274":"Ē","#275":"ē","#276":"Ĕ","#278":"Ė","#279":"ė","#280":"Ę","#281":"ę","#282":"Ě","#283":"ě","#284":"Ĝ","#285":"ĝ","#286":"Ğ","#287":"ğ","#288":"Ġ","#289":"ġ","#290":"Ģ","#291":"ģ","#292":"Ĥ","#293":"ĥ","#294":"Ħ","#295":"ħ","#296":"Ĩ","#297":"ĩ","#298":"Ī","#299":"ī","#300":"Ĭ","#301":"ĭ","#302":"Į","#303":"į","#304":"İ","#305":"ı","#306":"Ĳ","#307":"ĳ","#308":"Ĵ","#309":"ĵ","#31":"Ľ","#310":"Ķ","#311":"ķ","#312":"ĸ","#313":"Ĺ","#314":"ĺ","#315":"Ļ","#316":"ļ","#318":"ľ","#319":"Ŀ","#32":" ","#320":"ŀ","#321":"Ł","#322":"ł","#323":"Ń","#324":"ń","#325":"Ņ","#326":"ņ","#327":"Ň","#328":"ň","#329":"ŉ","#33":"!","#330":"Ŋ","#331":"ŋ","#332":"Ō","#333":"ō","#334":"Ŏ","#335":"ŏ","#336":"Ő","#337":"ő","#338":"Œ","#339":"œ","#34":'"',"#340":"Ŕ","#340":"Ŕ","#341":"ŕ","#341":"ŕ","#342":"Ŗ","#342":"Ŗ","#343":"ŗ","#343":"ŗ","#344":"Ř","#344":"Ř","#345":"ř","#345":"ř","#346":"Ś","#346":"Ś","#347":"ś","#347":"ś","#348":"Ŝ","#348":"Ŝ","#349":"ŝ","#349":"ŝ","#35":"#","#35":"ť","#350":"Ş","#350":"Ş","#351":"ş","#351":"ş","#352":"Š","#352":"Š","#353":"š","#353":"š","#354":"Ţ","#354":"Ţ","#355":"ţ","#355":"ţ","#356":"Ť","#356":"Ť","#358":"Ŧ","#358":"Ŧ","#359":"ŧ","#359":"ŧ","#36":"$","#360":"Ũ","#360":"Ũ","#361":"ũ","#361":"ũ","#362":"Ū","#362":"Ū","#363":"ū","#363":"ū","#364":"Ŭ","#364":"Ŭ","#365":"ŭ","#365":"ŭ","#366":"Ů","#366":"Ů","#367":"ů","#367":"ů","#368":"Ű","#368":"Ű","#369":"ű","#369":"ű","#37":"%","#37":"Ź","#370":"Ų","#370":"Ų","#371":"ų","#371":"ų","#372":"Ŵ","#372":"Ŵ","#373":"ŵ","#373":"ŵ","#374":"Ŷ","#374":"Ŷ","#375":"ŷ","#375":"ŷ","#376":"Ÿ","#376":"Ÿ","#377":"Ź","#378":"ź","#378":"ź","#379":"Ż","#379":"Ż","#38":"&","#380":"ż","#380":"ż","#381":"Ž","#381":"Ž","#382":"ž","#382":"ž","#383":"ſ","#383":"ſ","#39":"'","#40":"(","#41":")","#42":"*","#43":"+","#44":",","#45":"-","#46":".","#47":"/","#48":"0","#49":"1","#50":"2","#51":"3","#52":"4","#53":"5","#54":"6","#55":"7","#56":"8","#57":"9","#577":"ť","#58":":","#59":";","#60":"<","#61":"=","#62":">","#63":"?","#64":"@","#65":"A","#66":"B","#67":"C","#68":"D","#69":"E","#70":"F","#71":"G","#72":"H","#73":"I","#74":"J","#75":"K","#76":"L","#77":"M","#78":"N","#79":"O","#80":"P","#81":"Q","#82":"R","#83":"S","#84":"T","#8482":"™","#85":"U","#86":"V","#87":"W","#88":"X","#89":"Y","#90":"Z","#91":"[","#92":"\\","#93":"]","#94":"^","#95":"_","#96":"`","#97":"a","#98":"b","#99":"c","&#173;":"",AElig:"Æ",Aacute:"Á",Acirc:"Â",Agrave:"À",Aring:"Å",Atilde:"Ã",Auml:"Ä",Ccedil:"Ç",ETH:"Ð",Eacute:"É",Ecirc:"Ê",Egrave:"È",Euml:"Ë",Iacute:"Í",Icirc:"Î",Igrave:"Ì",Iuml:"Ï",Ntilde:"Ñ",Oacute:"Ó",Ocirc:"Ô",Ograve:"Ò",Oslash:"Ø",Otilde:"Õ",Ouml:"Ö",THORN:"Þ",Uacute:"Ú",Ucirc:"Û",Ugrave:"Ù",Uuml:"Ü",Yacute:"Ý",aacute:"á",acirc:"â",acute:"´",aelig:"æ",agrave:"à",amp:"&",aring:"å",atilde:"ã",auml:"ä",brvbar:"¦",ccedil:"ç",cedil:"¸",cent:"¢",copy:"©",curren:"¤",deg:"°",divide:"÷",eacute:"é",ecirc:"ê",egrave:"è",eth:"ð",euml:"ë",euro:"€",frac12:"½",frac14:"¼",frac34:"¾",gt:">",iacute:"í",icirc:"î",iexcl:"¡",igrave:"ì",iquest:"¿",iuml:"ï",lt:"<",macr:"¯",micro:"µ",middot:"·",nbsp:" ",nbsp:"",not:"¬",ntilde:"ñ",oacute:"ó",ocirc:"ô",ograve:"ò",ordf:"ª",ordm:"º",oslash:"ø",otilde:"õ",ouml:"ö",para:"¶",plusmn:"±",pound:"£",quot:'"',raquo:"»",reg:"®",sect:"§",shy:"",sup1:"¹",sup2:"²",sup3:"³",szlig:"ß",thorn:"þ",times:"×",uacute:"ú",ucirc:"û",ugrave:"ù",uml:"¨",uuml:"ü",yacute:"ý",yen:"¥"};var escapeMap={};for(var key in unescapeMap){if(unescapeMap.hasOwnProperty(key))escapeMap[unescapeMap[key]]=key}var unescapeKeys=Object.keys(unescapeMap).map(function(key){return`&${key};`});var escapeSequenceRegExp=RegExp(`(?=(${unescapeKeys.join("|")}))\\1`,"g");var escapeKeys=Object.keys(escapeMap).map(function(escapeChar){return`[${escapeChar}]`});var escapableCharRegExp=RegExp(`(?=(${escapeKeys.join("|")}))\\1`,"g");foam.LIB({name:"foam.parsers.html",methods:[function getHtmlEscapeChar(id){if(!unescapeMap.hasOwnProperty(id))return"";return unescapeMap[id]},function getHtmlEscapeSequence(c){if(!escapeMap.hasOwnProperty(c))return"";return escapeMap[c]},function isSelfClosing(nodeName){return selfClosingNodeNames[nodeName]},function unescapeString(str){if(!foam.String.isInstance(str))return"";return str.replace(escapeSequenceRegExp,function(m){var id=m.slice(1,-1);return unescapeMap[id]})},function escapeString(str){if(!foam.String.isInstance(str))return"";return str.replace(escapableCharRegExp,function(id){return`&${escapeMap[id]};`})}]})}});
foam.CLASS({package:"foam.parsers.html",name:"Attribute",properties:[{class:"String",name:"name"},{class:"String",name:"value"}]});foam.ENUM({package:"foam.parsers.html",name:"TagType",values:[{name:"OPEN",label:"Open"},{name:"CLOSE",label:"Close"},{name:"OPEN_CLOSE",label:"Open & Close"}]});
foam.CLASS({package:"foam.parsers.html",name:"Tag",properties:[{class:"Enum",of:"foam.parsers.html.TagType",name:"type",factory:function(){return foam.parser.html.TagType.OPEN}},{class:"String",name:"nodeName",value:"div"},{class:"FObjectArray",of:"foam.parsers.html.Attribute",name:"attributes"}]});
foam.CLASS({package:"foam.parsers.html",name:"HTMLLexer",requires:["foam.parse.ImperativeGrammar","foam.parse.Parsers","foam.parse.StringPStream","foam.parsers.html.Attribute","foam.parsers.html.Tag","foam.parsers.html.TagType"],axioms:[foam.pattern.Singleton.create()],properties:[{name:"lib",factory:function(){return foam.parsers.html}},{name:"symbolsFactory",value:function(seq1,sym,seq,repeat,alt,optional,str,plus,notChars,repeat0,not,anyChar,range,literalIC){return{START:seq1(1,optional(sym("header")),sym("html")),html:repeat(sym("htmlPart")),htmlPart:alt(sym("cdata"),sym("comment"),sym("closeTag"),sym("openTag"),sym("text")),openTag:seq("<",sym("tagName"),sym("whitespace"),sym("attributes"),sym("whitespace"),optional("/"),">"),closeTag:seq1(1,"</",sym("tagName"),sym("whitespace"),">"),header:seq(sym("whitespace"),optional(sym("langTag")),sym("whitespace"),optional(sym("doctype")),sym("whitespace")),langTag:seq("<?",repeat0(notChars("?")),"?>"),doctype:seq("<!",literalIC("DOCTYPE"),sym("whitespace"),repeat0(sym("doctypePart")),">"),doctypePart:alt(plus(notChars("[>",anyChar())),seq("[",repeat0(notChars("]",anyChar())),"]")),cdata:seq1(1,"<![CDATA[",str(repeat(not("]]>",anyChar()))),"]]>"),comment:seq("\x3c!--",repeat0(not("--\x3e",anyChar())),"--\x3e"),attributes:repeat(sym("attribute"),sym("whitespace")),label:str(plus(notChars(" =/\t\r\n<>"))),tagName:sym("label"),text:str(plus(not(alt(sym("closeTag"),sym("openTag")),anyChar()))),attribute:seq(sym("label"),optional(seq1(3,sym("whitespace"),"=",sym("whitespace"),sym("value")))),value:str(alt(plus(notChars("'\" \t\r\n<>")),seq1(1,'"',repeat(notChars('"',anyChar())),'"'),seq1(1,"'",repeat(notChars("'",anyChar())),"'"))),whitespace:repeat0(alt(" ","\t","\r","\n"))}}},{name:"symbols",factory:function(){return foam.Function.withArgs(this.symbolsFactory,this.Parsers.create(),this)}},{name:"actions",factory:function(){var self=this;var lib=self.lib;var Tag=self.Tag;var Attribute=self.Attribute;var OPEN=self.TagType.OPEN;var CLOSE=self.TagType.CLOSE;var OPEN_CLOSE=self.TagType.OPEN_CLOSE;return{openTag:function(v){return Tag.create({type:v[5]||lib.isSelfClosing(v[1])?OPEN_CLOSE:OPEN,nodeName:v[1],attributes:v[3]})},closeTag:function(v){return Tag.create({type:CLOSE,nodeName:v})},header:function(v){return null},langTag:function(v){return null},doctype:function(v){return null},doctypePart:function(v){return null},cdata:function(v){return null},comment:function(v){return null},attribute:function(v){return Attribute.create({name:v[0],value:v[1]||null})}}}},{name:"grammar",factory:function(){var grammar=this.ImperativeGrammar.create({symbols:this.symbols});grammar.addActions(this.actions);return grammar}},{name:"ps",factory:function(){return this.StringPStream.create()}}],methods:[function parseString(str,opt_name){opt_name=opt_name||"START";this.ps.setString(str);var start=this.grammar.getSymbol(opt_name);foam.assert(start,"No symbol found for",opt_name);return start.parse(this.ps,this.grammar)}]});foam.INTERFACE({package:"foam.core",name:"ContextAware",methods:[{name:"getX",type:"Context"},{name:"setX",type:"Void",args:[{name:"x",type:"Context"}]}],axioms:[{name:"javaExtras",buildJavaClass:function(cls){cls.methods.push(`
static <T> T maybeContextualize(X x, T obj) {
if ( obj instanceof ContextAware ) {
((ContextAware) obj).setX(x);
}
return obj;
}
`)}}]});
foam.CLASS({package:"foam.dao.history",name:"PropertyUpdate",properties:[{class:"String",name:"name"},{class:"Object",name:"oldValue",view:"foam.u2.view.AnyView"},{class:"Object",name:"newValue",view:"foam.u2.view.AnyView"}]});
foam.CLASS({package:"foam.dao.history",name:"HistoryRecord",ids:["objectId","seqNo"],tableColumns:["timestamp","objectId","user","updates"],properties:[{class:"Long",name:"seqNo",hidden:true},{class:"Object",name:"objectId",label:"Updated Object",tableWidth:150},{class:"FObjectProperty",of:"foam.nanos.auth.Subject",name:"subject",postSet:function(o,n){this.userId=n.user.id;this.agentId=n.realUser.id;this.user=n.user.toSummary();this.agent=n.realUser.toSummary()},},{class:"Reference",of:"foam.nanos.auth.User",name:"userId"},{class:"Reference",of:"foam.nanos.auth.User",name:"agentId"},{class:"String",name:"user",label:"Updated By",tableWidth:200},{class:"String",name:"agent",label:"Updated By",},{class:"DateTime",name:"timestamp",tableWidth:200},{class:"FObjectArray",of:"foam.dao.history.PropertyUpdate",name:"updates",label:"Updated Properties",}]});
foam.CLASS({package:"foam.dao.jdbc",name:"JDBCConnectionSpec",properties:[{class:"String",name:"databaseServer"},{class:"String",name:"hostName"},{class:"String",name:"databaseName"},{class:"String",name:"userName"},{class:"Password",name:"userPassword"}],methods:[{name:"buildConnectionURI",type:"String",}]});
foam.CLASS({package:"foam.dao.jdbc",name:"ConnectionPool",implements:["foam.nanos.NanoService"],properties:[{class:"Object",name:"pool",},{class:"Int",name:"poolSize",value:20,},{class:"String",name:"driver",},{class:"String",name:"prefix",},{class:"String",name:"hostname",},{class:"String",name:"port",},{class:"String",name:"database",},{class:"String",name:"username",},{class:"String",name:"password",},{class:"String",name:"connectionString",transient:true,}],methods:[{name:"start",},{name:"getConnection",}]});foam.INTERFACE({package:"foam.lib",name:"Outputter",javaExtends:["java.io.Closeable","java.io.Flushable"],methods:[{name:"close",javaThrows:["java.io.IOException"]},{name:"flush",javaThrows:["java.io.IOException"]},{name:"stringify",type:"String",args:[{name:"obj",type:"FObject"}]},{name:"output",type:"Void",args:[{name:"value",type:"Any"}]}]});foam.INTERFACE({package:"foam.lib",name:"PropertyPredicate",methods:[{name:"propertyPredicateCheck",type:"Boolean",args:[{name:"x",type:"Context"},{name:"of",type:"String"},{name:"prop",}]}]});
foam.CLASS({package:"foam.lib",name:"PermissionedPropertyPredicate",implements:["foam.lib.PropertyPredicate"],methods:[{name:"propertyPredicateCheck",}]});
foam.CLASS({package:"foam.lib",name:"NetworkPropertyPredicate",implements:["foam.lib.PropertyPredicate"],methods:[{name:"propertyPredicateCheck",}]});
foam.CLASS({package:"foam.lib",name:"StorageOptionalPropertyPredicate",implements:["foam.lib.PropertyPredicate"],methods:[{name:"propertyPredicateCheck",}]});
foam.CLASS({package:"foam.lib",name:"StoragePropertyPredicate",implements:["foam.lib.PropertyPredicate"],methods:[{name:"propertyPredicateCheck",}]});
foam.CLASS({package:"foam.lib",name:"AndPropertyPredicate",implements:["foam.lib.PropertyPredicate"],properties:[{class:"Array",type:"foam.lib.PropertyPredicate[]",name:"delegates"}],methods:[{name:"propertyPredicateCheck",}]});
foam.CLASS({package:"foam.lib.json",name:"JSONParser",methods:[{name:"parseString",args:[{name:"data",type:"String"}],type:"FObject",}]});foam.ENUM({package:"foam.lib.json",name:"OutputterMode",values:[{name:"NETWORK",label:"Network"},{name:"STORAGE",label:"Storage"},{name:"FULL",label:"Full",}]});
foam.CLASS({package:"foam.lib.json",name:"ClassReferenceParserTest",extends:"foam.nanos.test.Test",methods:[{name:"runTest",},{name:"ClassReferenceParserTest_StringWithValidClassReference",args:[{name:"x",type:"Context"},{name:"data",type:"String"},{name:"expected",type:"Class"},{name:"message",type:"String"}],},{name:"ClassReferenceParserTest_StringWithInvalidClassReference",args:"Context x, String data, String message",}]});
foam.CLASS({package:"foam.lib.json",name:"PropertyReferenceParserTest",extends:"foam.nanos.test.Test",methods:[{name:"runTest",},{name:"PropertyReferenceParserTest_ValidPropertyReference",args:[{name:"x",type:"Context"},{name:"data",type:"String"},{name:"expected",},{name:"message",type:"String"}],},{name:"PropertyReferenceParserTest_InvalidPropertyReference",args:"Context x, String data, String message",}]});
foam.CLASS({package:"foam.lib.json",name:"UnknownFObject",implements:["foam.lib.json.OutputJSON"],properties:[{class:"String",name:"json"}],methods:[{name:"outputJSON",args:[{name:"outputter",}],},{name:"formatJSON",args:[{name:"formatter",}],}]});foam.INTERFACE({package:"foam.lib.json",name:"OutputJSON",methods:[{name:"outputJSON",args:[{name:"outputter",}]},{name:"formatJSON",args:[{name:"formatter",}]}]});foam.INTERFACE({package:"foam.lib.parse",name:"Parser",proxy:true,methods:[{name:"parse",type:"foam.lib.parse.PStream",args:"foam.lib.parse.PStream ps, foam.lib.parse.ParserContext x"}]});foam.INTERFACE({package:"foam.lib.parse",name:"PStream",proxy:true,methods:[{name:"head",type:"Char"},{name:"valid",type:"Boolean"},{name:"tail",type:"foam.lib.parse.PStream"},{name:"value",type:"Any"},{name:"setValue",type:"foam.lib.parse.PStream",args:[{name:"value",type:"Any"}]},{name:"substring",type:"String",args:[{name:"end",type:"foam.lib.parse.PStream"}]},{name:"apply",type:"foam.lib.parse.PStream",args:[{name:"ps",type:"foam.lib.parse.Parser"},{name:"x",}]},{name:"pos",type:"int"}]});
foam.CLASS({package:"foam.lib.parse",name:"BlobPStream",implements:["foam.lib.parse.PStream"],properties:[{class:"Blob",name:"blob"},{class:"Int",name:"pos_"},{class:"String",name:"head_",},{class:"FObjectProperty",of:"foam.lib.parse.BlobPStream",name:"tail_",},{class:"Object",name:"value_"}],methods:[{name:"head",},{name:"valid",},{name:"tail",},{name:"value",},{name:"setValue",},{name:"substring",},{name:"apply",},{name:"pos",}]});foam.INTERFACE({package:"foam.crypto.hash",name:"Hasher",methods:[{name:"includeInDigest",type:"Boolean",},{name:"updateDigest",args:[{name:"obj",type:"foam.core.FObject"},{name:"md",}]}]});foam.INTERFACE({package:"foam.crypto.hash",name:"Hashable",});
foam.CLASS({package:"foam.crypto.hash",name:"HashableTest",extends:"foam.nanos.test.Test",methods:[{name:"runTest",},{name:"Hashable_HashWithValidAlgorithm",args:[{type:"FObject",name:"input"},{type:"String",name:"algorithm"},{type:"String",name:"expected"}],},{name:"Hashable_HashingSameObjects_ProducesSameDigest",args:[{type:"FObject",name:"o1"},{type:"FObject",name:"o2"},{type:"String",name:"message"}],},{name:"Hashable_HashWithInvalidAlgorithm_NoSuchAlgorithmException",args:[{type:"FObject",name:"input"}],}]});foam.INTERFACE({package:"foam.crypto.sign",name:"Signer",methods:[{name:"includeInSignature",type:"Boolean",},{name:"updateSignature",type:"Void",args:[{name:"obj",type:"FObject"},{name:"sig",}]}]});foam.INTERFACE({package:"foam.crypto.sign",name:"Signable",});
foam.CLASS({package:"foam.crypto.sign",name:"SignableTest",extends:"foam.nanos.test.Test",constants:[{name:"RSA_PRIVATE_KEY",type:"String",value:"MIIJQwIBADANBgkqhkiG9w0BAQEFAASCCS0wggkpAgEAAoICAQCYhm9xs09iwIyBo1ED68M+1pCZpPCUrWtXm6OhfxEIOGmvKP1H61PnCAdP9pmDdWW992Ge5dTl98en/eZwMvLAvr/JD4K03aeXBXj89l949SkkaFL/7Ca81ymJHPYu3XWMf596AlrQij1AaydyuqZgKYiQ6SsRFw03VXqmaYqF+y6GcnMhRBHJiHz5XtVjm70xwu+JbtIq/D3HYh1jIn86/uS28dPMEJGK8gFF34wpDXkJn0++YAwe/TzqQQRZMsIWTwgKZWGdLOW8wNkJr4Yp5n+AVg/LGWfk4P/GPGwq2k+6RlMcyRiyic9z0fYGz9gkH/OowEg8LLPjmr1/P0m+Q8odJohcUOFAIZFaQm0b65lfwR+n2zA8p3SNdZYUQOt5IZeO1MFQ2tCNPnJZfFCx7o/sheZd4PyuGPbp5HlZv8Yq3rkNJZLuUcwdDAS51OL2V1CmTQlrBIfAxKgXdLakkljNsAA+5gmoawizR52ckzf4bnaAjkdUpNe8qYKlP6g8D+izxeufO8loBgmL9WS0Rm5F74XeFRGXSmlwCuMMeAB4th/t+XyQj+oSUEfIqhafnqH//EmxB0ayWpdFDdVUDvDOSCbdMsBU1aHO9tRb/pIsIj9ZRtHabzPTg6LSgHZ5cY7DWNR+iTIyJ7W9wP/+YElfU0xOPjuyefDkduY5PwIDAQABAoICAAZZ6sAYUGDzVaZ8T35TTfEK7ECJnr8CLasbPwgVi3cFKllx4oIhKYBAVFWfFitkMxVi/LyqI2BkHfs/1l2rsXIXP1M3AyFW7YibYLtf4v/dbZYnhfVENyS77O3Zt+KhtChilBh3iqKObxiEncLoRM9SS26FVxbCF/nK5G2TjYIgwII2t9aVyAvVVCbqLQaV0J4G2QSnCbdig4wO6Nxc7mFdhdacYU5pDjZz91uagHKhLf4ZlS9/PmH395ZlmLHCLFTTe6k7KYJrATIH8cG2fma2Q27rpoK1jx73w47Uq0hpiNJf5UwYj5+3n1zaTF1iQETY08OeJiPjVKZQpj1rPD3QQMKsC1UmKvVGgAtuVcjoXzft0nbRvY6dwxo2Wf4BWk+GfKLZwzF6UDc/J1BQPYc0njlzcZVP1McQzKpMl09TiF1NlQxOcNEKLqKm6cDzpxa6iCwCYrZJcTRyyqlBrKyt0aGrACpwmhaU2n95o7Fw+E8eBX4grekHofuhd3r8OdT7pv9ZU44xZjX4WeGfJDkJv/WU5bmBXxoFySb9qKIlZowZT+mz1W8w5N6hc3VhT9cPyQnOWxAEwcF5k88LoV3L1hfLOMmIQMiNkKfaFb35kjC5M7TdSc/+iI9wPtHajRuY2bUWH8hZunsbjVxAaq8LlvqoSeciSUdrfLGBJ2rZAoIBAQDvNRgxL6elxkz7U4mseZXSRY1RtFxSDL/wiPzR/eJsN22Jqs5YL5nan14CLDo5PEsWUVEI0MeqBxavWM23vDjtYvRnPDsRL4ZtiGqeHXFXJKuHz9pZ6qb7493Crfo5fadkfWzPO6Jhxe8nRdlaVHHjJX11rUKLCu/tkJhV9NuJeluVrl1FKsiG5aP+ZPKJfj86YqX2XcCmRV++IhDOihcTX7iN0IOZukIlyyu7ZsnTcFt8Lh10sRSSyRXMYXoVHE2I1h4PNCIy8+LcXdRzSSqInwiqh2a5rT0HQNvoOwjfk0gb4apwmv/hF/k1/WK03F4DDlyrFSx8FOZhCBoRyUMdAoIBAQCjO4jGoUtepG3+b+oQ0Yr2U1MijdmKaqdF6KjMeax/lyoBiWDcD5TmtI5SRBu9O0o4Q0qQZ8js7+D/Q/O4RE/tht/7QPtnHWFrSJcse1LdnExY2KSvmudKcl3lQv92g+hmxNGrODwCwtC40zyZaAWSW9RW0UuxPqwNZEqOvF4ka30XE1BgBgUNN+BOkz9dR+f2qFiBbg6yMC21cZsyQGY9cfzdK2Rk59OvEDex22IDqANxVc+jMBMjXlob1Rzq/P7oDKbn8CB+sLJK87v3/yIkCmAHxCLc0NGHyqH6sHqbo0vK0BfkG/6n1jpBIYgwit1oNCOm8Xy70+YymhZMowMLAoIBAQDlH2A6zMCyQw09triqYhOlw0Unu7CqTtgS18QCiEK3ESh0swzO31lpVTlAr4hdhmkNyXnrDcASFpQeBNuXYEzO5PfhYonZXkJO7FnjdaQ4qkE651boxaCIqayiau7A3qDV2mW84gwZxvPaFEerBDPKNQDFFN4mPKWwUc34l38pYfAToV5pgB9vRsscQyklla2OiSsanpaHLPAWOJ8MlqyfvBIUlGNZflUZyk/rQvuS8Y5PlgRU38ErED029S9wxRlnNmC4g2E2mPD1z1JN0wlQr7QnU2aL92n7Zp69BL7tGC/7tN4C2hS6ULI+iqRfRK0wFDOjE7b2azZ4PsBpxPPpAoIBAQChwhCTzikze7zoxJzu18hevEoJVwq6KWDkXWBRaU4xDmr5JNuQl/xV952GFqpqhwPQ55ZPrhml+z07mWo/M6sFVoBFq6q3D52HxGLTGM8Qf6AE94OT5ezIkLdNx2wDVUqL9QVWKJ8HmWlfjy1hVH0ZAdlVw4i/97xmdPmRo0ejzcUjhedDkROWesXU+AR1+xj7DO7QLHFx0V6qjQ9f6AOpZnlP731IpZfXxzl6Dk5+ExR+Tqw6Khz9ErY3GKTUlaxB5q/L7uE0ywOUVR7z7qg1kPaDG7H0oxbQ+1QzaonGDDfCnx7d1YQxbJFEE+ezOxmX9vtRp8OVGrLneF0ayvvrAoIBABgDpFiZZg7CZGtZGgGJuQ+WBdmgX1LXV4A+pJNtVfWWuD2Khyt0SnY7c28CqR+ntrXFG4ZdUPCI9hzyLi7Zeg3ASY5JEQvz63PoYo6w95Vll/erElMAXYX6tqVMzm9XXAOFDVM85S2n3M6d/rHQlnu5/U74AvTAkIPRMjznG2fOhrwyEwwUvaUTRb9p/NRnuHJEnKeu6nQrOvAJ5ccnrH9F0IRs92vF5t2CQy47Y2FPp6Y9fBsKdtHt//vjVTLP6AvSWioFXVPTa2Y5L+PVsNrmkn4CpEG2E2B824qsfxKbb004HjL85nx6WkLHmRgJyiRAPXs8XfNF0ow58VJVKEw="},{name:"RSA_PUBLIC_KEY",type:"String",value:"MIICIjANBgkqhkiG9w0BAQEFAAOCAg8AMIICCgKCAgEAmIZvcbNPYsCMgaNRA+vDPtaQmaTwlK1rV5ujoX8RCDhpryj9R+tT5wgHT/aZg3VlvfdhnuXU5ffHp/3mcDLywL6/yQ+CtN2nlwV4/PZfePUpJGhS/+wmvNcpiRz2Lt11jH+fegJa0Io9QGsncrqmYCmIkOkrERcNN1V6pmmKhfsuhnJzIUQRyYh8+V7VY5u9McLviW7SKvw9x2IdYyJ/Ov7ktvHTzBCRivIBRd+MKQ15CZ9PvmAMHv086kEEWTLCFk8ICmVhnSzlvMDZCa+GKeZ/gFYPyxln5OD/xjxsKtpPukZTHMkYsonPc9H2Bs/YJB/zqMBIPCyz45q9fz9JvkPKHSaIXFDhQCGRWkJtG+uZX8Efp9swPKd0jXWWFEDreSGXjtTBUNrQjT5yWXxQse6P7IXmXeD8rhj26eR5Wb/GKt65DSWS7lHMHQwEudTi9ldQpk0JawSHwMSoF3S2pJJYzbAAPuYJqGsIs0ednJM3+G52gI5HVKTXvKmCpT+oPA/os8XrnzvJaAYJi/VktEZuRe+F3hURl0ppcArjDHgAeLYf7fl8kI/qElBHyKoWn56h//xJsQdGslqXRQ3VVA7wzkgm3TLAVNWhzvbUW/6SLCI/WUbR2m8z04Oi0oB2eXGOw1jUfokyMie1vcD//mBJX1NMTj47snnw5HbmOT8CAwEAAQ=="},{name:"ECDSA_PRIVATE_KEY",type:"String",value:"MIH3AgEAMBAGByqGSM49AgEGBSuBBAAjBIHfMIHcAgEBBEIA/5NXupegNi4+T7D7yEb4fE8ipLnasyoWOo2ippURQC9oMPtF4k/JhqdCh2kdorYthmf9ANcAZAUKWJ7S0DETQ3GgBwYFK4EEACOhgYkDgYYABAAQDu9DO0C6ILRIsJFwxeycH3vWxxzuvMYu2VFjWq9WCiU3aUr1VF+WytSepXzvuCU7+E1aYPhp8AIHabQ7ZMzMOAE7Pm54YJzvnO2KASQWJm/W78QfgyH5US4Mze/LGNjsgQ1IwtDKeIef/QE1E/99gsoRJ7jkbeTOTgokUorYmMkzXg=="},{name:"ECDSA_PUBLIC_KEY",type:"String",value:"MIGbMBAGByqGSM49AgEGBSuBBAAjA4GGAAQAEA7vQztAuiC0SLCRcMXsnB971scc7rzGLtlRY1qvVgolN2lK9VRflsrUnqV877glO/hNWmD4afACB2m0O2TMzDgBOz5ueGCc75ztigEkFiZv1u/EH4Mh+VEuDM3vyxjY7IENSMLQyniHn/0BNRP/fYLKESe45G3kzk4KJFKK2JjJM14="}],methods:[{name:"runTest",},{name:"Signable_SignWithValidAlgorithmAndKey",type:"String",args:[{name:"input",type:"FObject"},{name:"algorithm",type:"String"},{name:"key",type:"Any"}],},{name:"Signable_VerifyWithValidAlgorithmSignatureAndKey",args:[{name:"input",type:"FObject"},{name:"algorithm",type:"String"},{name:"key",type:"Any"},{name:"signature",type:"String"}],},{name:"Signable_SignWithInvalidAlgorithm_NoSuchAlgorithmException",args:[{type:"FObject",name:"input"}],},{name:"Signable_SignWithNullPrivateKey_InvalidKeyException",args:[{type:"FObject",name:"input"}],},{name:"Signable_SignWithMismatchedAlgorithmAndKey_InvalidKeyException",args:[{type:"FObject",name:"input"},{type:"String",name:"algorithm"},{type:"Any",name:"key"}],}]});
foam.CLASS({package:"foam.test",name:"AllProperties",properties:[{class:"foam.core.Int",name:"intProp"},{class:"foam.core.String",name:"stringProp"},{class:"foam.core.FObjectArray",of:"foam.test.TestObj",name:"fObjectArrayProp"},{class:"foam.core.Object",name:"objectProp"},{class:"foam.core.Function",name:"functionProp"},{class:"foam.core.StringArray",name:"stringArray"},{class:"foam.core.Class",name:"classProp"},{class:"foam.core.FObjectProperty",of:"foam.test.TestObj",name:"fObjectPropertyProp"},{class:"foam.core.EMail",name:"emailProp"},{class:"foam.u2.ViewSpec",name:"viewSpecProp"},{class:"foam.core.Enum",of:"foam.test.TestEnum",name:"enumProp"},{class:"foam.core.Date",name:"dateProp"},{class:"foam.core.DateTime",name:"dateTimeProp"},{class:"foam.core.Float",name:"floatProp"},{class:"foam.core.Long",name:"longProp"},{class:"foam.core.UnitValue",name:"currencyProp"},{class:"foam.core.Color",name:"colorProp"},{class:"foam.core.Array",name:"arrayProp"},{class:"foam.core.Map",name:"mapProp"},{class:"foam.u2.view.TableCellFormatter",name:"tableCellFormatterProp"},{class:"foam.core.Byte",name:"byteProp"},{class:"foam.core.Short",name:"shortProp"},{class:"foam.core.Double",name:"doubleProp"},{class:"foam.core.List",name:"listProp"},{class:"foam.core.Image",name:"imageProp"},{class:"foam.core.URL",name:"urlProp"},{class:"foam.core.Password",name:"passwordProp"},{class:"foam.core.PhoneNumber",name:"phoneNumberProp"},{class:"foam.parse.ParserArray",name:"parserArrayProp"},{class:"foam.parse.ParserProperty",name:"parserPropertyProp"},{class:"foam.mlang.ExprProperty",name:"exprPropertyProp"},{class:"foam.mlang.SinkProperty",name:"sinkPropertyProp"},{class:"foam.mlang.predicate.PredicateProperty",name:"predicatePropertyProp"},{class:"foam.mlang.predicate.PredicateArray",name:"predicateArrayProp"},{class:"foam.core.Blob",name:"blobProp"},{class:"foam.u2.ViewFactory",name:"viewFactoryProp"},{class:"foam.core.Int",transient:true,name:"transientInt"},{class:"foam.core.String",transient:true,name:"transientString"},{class:"foam.core.FObjectArray",of:"foam.test.TestObj",transient:true,name:"transientFObjectArray"},{class:"foam.core.Object",transient:true,name:"transientObject"},{class:"foam.core.Function",transient:true,name:"transientFunction"},{class:"foam.core.StringArray",transient:true,name:"transientStringArray"},{class:"foam.core.Class",transient:true,name:"transientClass"},{class:"foam.core.FObjectProperty",of:"foam.test.TestObj",transient:true,name:"transientFObjectProperty"},{class:"foam.core.EMail",transient:true,name:"transientEMail"},{class:"foam.u2.ViewSpec",transient:true,name:"transientViewSpec"},{class:"foam.core.Enum",transient:true,of:"foam.test.TestEnum",name:"transientEnum"},{class:"foam.core.Date",transient:true,name:"transientDate"},{class:"foam.core.DateTime",transient:true,name:"transientDateTime"},{class:"foam.core.Float",transient:true,name:"transientFloat"},{class:"foam.core.Long",transient:true,name:"transientLong"},{class:"foam.core.UnitValue",transient:true,name:"transientCurrency"},{class:"foam.core.Color",transient:true,name:"transientColor"},{class:"foam.core.Array",transient:true,name:"transientArray"},{class:"foam.core.Map",transient:true,name:"transientMap"},{class:"foam.u2.view.TableCellFormatter",transient:true,name:"transientTableCellFormatter"},{class:"foam.core.Byte",transient:true,name:"transientByte"},{class:"foam.core.Short",transient:true,name:"transientShort"},{class:"foam.core.Double",transient:true,name:"transientDouble"},{class:"foam.core.List",transient:true,name:"transientList"},{class:"foam.core.Image",transient:true,name:"transientImage"},{class:"foam.core.URL",transient:true,name:"transientURL"},{class:"foam.core.Password",transient:true,name:"transientPassword"},{class:"foam.core.PhoneNumber",transient:true,name:"transientPhoneNumber"},{class:"foam.parse.ParserArray",transient:true,name:"transientParserArray"},{class:"foam.parse.ParserProperty",transient:true,name:"transientParserProperty"},{class:"foam.mlang.ExprProperty",transient:true,name:"transientExprProperty"},{class:"foam.mlang.SinkProperty",transient:true,name:"transientSinkProperty"},{class:"foam.mlang.predicate.PredicateProperty",transient:true,name:"transientPredicateProperty"},{class:"foam.mlang.predicate.PredicateArray",transient:true,name:"transientPredicateArray"},{class:"foam.core.Blob",transient:true,name:"transientBlob"},{class:"foam.u2.ViewFactory",transient:true,name:"transientViewFactory"}],classes:[{name:"InnerClass1",properties:[{class:"String",name:"name"}]}],static:[function createPopulated(){return foam.test.AllProperties.create({intProp:12,stringProp:"asdf",fObjectArrayProp:[foam.test.TestObj.create({description:"An object in an array!"}),foam.test.TestObj.create({description:"Another object in an array!"})],objectProp:[1,2,3],stringArrayProp:["Hello","World"],classProp:foam.test.AllProperties,fObjectPropertyProp:foam.test.TestObj.create({description:"some object"}),emailProp:"test@example.com",enumProp:foam.test.TestEnum.BAR,dateProp:new Date("1995-12-17T03:24:00"),dateTimeProp:new Date("1995-12-18T04:23:44"),floatProp:1.2345,longProp:12341234,currencyProp:342342,colorProp:"rgba(0, 0, 255, 0)",imageProp:"/favicon/favicon-32x32.png",urlProp:"https://google.com/",passwordProp:"superSecret111!",phoneNumberProp:"555-3455"})}]});
foam.CLASS({package:"foam.test",name:"AllSerializableProperties",properties:[{class:"foam.core.Int",name:"intProp"},{class:"foam.core.String",name:"stringProp"},{class:"foam.core.FObjectArray",of:"foam.test.TestObj",name:"fObjectArrayProp"},{class:"foam.core.Object",name:"objectProp"},{class:"foam.core.StringArray",name:"stringArray"},{class:"foam.core.Class",name:"classProp"},{class:"foam.core.FObjectProperty",of:"foam.test.TestObj",name:"fObjectPropertyProp"},{class:"foam.core.EMail",name:"emailProp"},{class:"foam.u2.ViewSpec",name:"viewSpecProp"},{class:"foam.core.Enum",of:"foam.test.TestEnum",name:"enumProp"},{class:"foam.core.Date",name:"dateProp"},{class:"foam.core.DateTime",name:"dateTimeProp"},{class:"foam.core.Float",name:"floatProp"},{class:"foam.core.Long",name:"longProp"},{class:"foam.core.UnitValue",name:"currencyProp"},{class:"foam.core.Color",name:"colorProp"},{class:"foam.core.Array",name:"arrayProp"},{class:"foam.core.Map",name:"mapProp"},{class:"foam.core.Byte",name:"byteProp"},{class:"foam.core.Short",name:"shortProp"},{class:"foam.core.Double",name:"doubleProp"},{class:"foam.core.Image",name:"imageProp"},{class:"foam.core.URL",name:"urlProp"},{class:"foam.core.Password",name:"passwordProp"},{class:"foam.core.PhoneNumber",name:"phoneNumberProp"},{class:"foam.core.Blob",name:"blobProp"}],static:[function createPopulated(){return foam.test.AllSerializableProperties.create({intProp:12,stringProp:"asdf",fObjectArrayProp:[foam.test.TestObj.create({description:"An object in an array!"}),foam.test.TestObj.create({description:"Another object in an array!"})],objectProp:[1,"foo",new Date,foam.test.AllSerializableProperties,[3,4]],stringArrayProp:["Hello","World"],classProp:foam.test.AllSerializableProperties,fObjectPropertyProp:foam.test.TestObj.create({description:"some object"}),emailProp:"test@example.com",enumProp:foam.test.TestEnum.BAR,dateProp:new Date("1995-12-17T03:24:00"),dateTimeProp:new Date("1995-12-18T04:23:44"),floatProp:1.2345,longProp:12341234,currencyProp:342342,colorProp:"rgba(0, 0, 255, 0)",imageProp:"/favicon/favicon-32x32.png",urlProp:"https://google.com/",passwordProp:"superSecret111!",phoneNumberProp:"555-3455"})}]});foam.ENUM({package:"foam.test",name:"TestEnum",values:[{name:"FOO"},{name:"BAR"}]});
foam.CLASS({package:"foam.test",name:"TestObj",properties:[{class:"String",name:"id"},{class:"String",name:"description",}]});
foam.CLASS({package:"foam.test",name:"IdentifiedStringHolder",properties:[{name:"id",class:"String"},{name:"value",class:"String"}]});
foam.CLASS({package:"foam.core",name:"FObjectTest",extends:"foam.nanos.test.Test",methods:[{name:"runTest",},{name:"FObject_fclone_ClonedObjectEqualsOriginal",args:[{type:"FObject",name:"input"}],}]});
foam.CLASS({package:"foam.flow",name:"Document",properties:[{class:"String",name:"id"},{class:"String",name:"title"},{class:"String",name:"markup",view:{class:"foam.flow.MarkupEditor"}}],methods:[function toE(args,x){var f=this.htmlish.parseString(this.markup,this.cls_.id);return f?f(x):x.E("span").add(this.htmlish.getLastError())}],grammars:[{name:"htmlish",symbols:function(){return{"foam.flow.Document":seq(optional(sym("title")),sym("content"),eof()),title:seq1(1,"<title>",join(until("</title>"))),content:repeat(alt(sym("entity"),sym("tag"),sym("text"))),text:substring(plus(not(alt(sym("entity"),chars("<")),anyChar()))),entity:seq1(1,"&",alt(literal("nbsp"," "),literal("lt","<"),literal("gt",">"),literal("amp","&")),";"),"normal-tag":seq("<",sym("tag-identifier"),sym("attributes"),">",sym("content"),"</",sym("tag-identifier"),">"),"self-closed-tag":seq("<",sym("tag-identifier"),sym("attributes"),"/>"),tag:alt(sym("foam"),sym("foam-with-contents"),sym("code"),sym("self-closed-tag"),sym("normal-tag")),"tag-identifier":substring(plus(notChars(" />"))),xtag:alt(sym("br"),sym("bold"),sym("italic"),sym("paragraph"),sym("unordered-list"),sym("ordered-list"),sym("code"),sym("anchor"),sym("section"),sym("h1"),sym("h2"),sym("h3"),sym("h4"),sym("h5"),sym("h6"),sym("foam")),br:seq("<br/>"),section:seq("<section",sym("attributes"),">",sym("content"),"</section>"),paragraph:seq1(1,"<p>",sym("content"),"</p>"),anchor:seq("<a",sym("attributes"),">",sym("content"),"</a>"),h1:seq1(1,"<h1>",sym("content"),"</h1>"),h2:seq1(1,"<h2>",sym("content"),"</h2>"),h3:seq1(1,"<h3>",sym("content"),"</h3>"),h4:seq1(1,"<h4>",sym("content"),"</h4>"),h5:seq1(1,"<h5>",sym("content"),"</h5>"),h6:seq1(1,"<h6>",sym("content"),"</h6>"),bold:seq1(1,"<b>",sym("content"),"</b>"),italic:seq1(1,"<i>",sym("content"),"</i>"),ws:repeat(chars(" \r\n\t")),"unordered-list":seq1(1,"<ul>",repeat(seq1(1,sym("ws"),sym("list-item"))),sym("ws"),"</ul>"),"ordered-list":seq1(1,"<ol>",repeat(seq1(1,sym("ws"),sym("list-item"))),sym("ws"),"</ol>"),"list-item":seq1(1,"<li>",sym("content"),"</li>"),code:seq1(1,"<code>",join(until("</code>"))),foam:seq1(1,"<foam",sym("attributes"),"/>"),"foam-with-contents":seq(seq1(1,"<foam",sym("attributes"),">"),join(until("</foam>"))),attributes:seq(repeat(sym("attrib-key-value")," "),optional(sym("ws"))),"attrib-key-value":seq(sym("attrib-key"),'="',sym("attrib-value"),'"'),"attrib-key":seq1(1,repeat0(" "),plus(notChars("=>"))),"attrib-value":repeat(notChars('"'))}},actions:{"foam.flow.Document":function(v){if(foam.String.isInstance(v[0]))this.title=v[0];var children=v[1];var self=this;return function(x){return x.E("article").addClass("foam-flow-Document").style({"margin-top":"60px"}).call(children,[x])}},text:function(str){return function(x){this.add(str)}},br:function(){return function(x){this.tag("br")}},content:function(children){return function(x){this.forEach(children,function(c){c.call(this,x)})}},"normal-tag":function(v){var openIdent=v[1];var closeIdent=v[6];var attributes=v[2];var children=v[4];if(closeIdent!==openIdent){console.warn("Expected close of",openIdent,"but instead found close of",closeIdent)}return function(x){this.start(openIdent).attrs(attributes).call(children,[x]).end()}},"self-closed-tag":function(v){var ident=v[1];var attributes=v[2];return function(x){this.start(ident).attrs(attributes).end()}},section:function(v){var attributes=v[1];var children=v[3];return function(x){this.start("section").call(children,[x]).end()}},paragraph:function(content){return function(x){this.start("p").call(content,[x]).end()}},anchor:function(v){var attributes=v[1];var children=v[3];return function(x){this.start("a").callIf(attributes.href,function(){this.setAttribute("href",attributes.href)}).call(children,[x]).end()}},entity:function(e){return function(){this.add(e)}},h1:function(content){return function(x){this.start("h1").call(content,[x]).end()}},h2:function(v){return function(x){this.start("h2").call(v,[x]).end()}},h3:function(v){return function(x){this.start("h3").call(v,[x]).end()}},h4:function(v){return function(x){this.start("h4").call(v,[x]).end()}},h5:function(v){return function(x){this.start("h5").call(v,[x]).end()}},h6:function(v){return function(x){this.start("h6").call(v,[x]).end()}},bold:function(v){var children=v;return function(x){this.start("b").call(children,[x]).end()}},italic:function(v){var children=v;return function(x){this.start("i").call(children,[x]).end()}},"unordered-list":function(v){var children=v;return function(x){this.start("ul").forEach(children,function(c){c.call(this,x)}).end()}},"ordered-list":function(v){var children=v;return function(x){this.start("ol").forEach(children,function(c){c.call(this,x)}).end()}},"list-item":function(children){return function(x){this.start("li").call(children,[x]).end()}},code:function(code){return function(x){this.start("pre").addClass("code").add(code).end()}},foam:function(attributes){return function(x){var viewName=attributes.view;var className=attributes.class;var promise=Promise.all([viewName?x.classloader.load(viewName):Promise.resolve(),className?x.classloader.load(className):Promise.resolve()]);var self=this;this.add(promise.then(function(o){return self.E().callIf(o,function(){var cls=x.maybeLookup(className);var view=x.maybeLookup(viewName);if(className&&!cls)this.add("Unknown class",className);if(viewName&&!view)this.add("Unknown view",viewName);if(!cls&&!view)return;var obj=cls.create(attributes,this);if(!viewName)this.add(obj);else this.tag(view,{data:obj})})}))}},"foam-with-contents":function(v){var attributes=v[0];var body=v[1];return function(x){var viewName=attributes.view;var className=attributes.class;var promise=Promise.all([viewName?x.classloader.load(viewName):Promise.resolve(),className?x.classloader.load(className):Promise.resolve()]);var self=this;this.add(promise.then(function(o){return self.E().callIf(o,function(){var cls=x.maybeLookup(className);var view=x.maybeLookup(viewName);if(className&&!cls)this.add("Unknown class",className);if(viewName&&!view)this.add("Unknown view",viewName);if(!cls&&!view)return;var subCtx=this.__subContext__.createSubContext({innerFLOW:body});var obj=null;this.startContext({innerFLOW:body}).callIf(true,function(){obj=cls.create(attributes,this.__subSubContext__)}).callIfElse(!!viewName,function(){this.tag(view,{data:obj})},function(){this.add(obj)}).endContext()})}))}},attributes:function(v){return v[0].reduce(function(a,kv){a[kv[0]]=kv[1];return a},{})},"attrib-key-value":function(v){return[v[0],v[2]]},"attrib-key":function(v){return v.join("")},"attrib-value":function(v){return v.join("")}}}]});
foam.CLASS({package:"foam.flow",name:"DocumentMenu",extends:"foam.nanos.menu.Menu",implements:["foam.mlang.Expressions"],requires:["foam.nanos.menu.DocumentFileMenu","foam.dao.ArrayDAO","foam.dao.PromisedDAO","foam.nanos.controller.Memento","foam.nanos.menu.Menu"],imports:["documentDAO"],properties:[{name:"children_",factory:function(){var aDAO=this.ArrayDAO.create();var pDAO=this.PromisedDAO.create();this.documentDAO.select(doc=>{var menu=this.Menu.create({id:this.id+"/"+doc.id,label:foam.String.labelize(doc.id),parent:this.id,handler:this.DocumentFileMenu.create({docKey:doc.id})});aDAO.put(menu)}).then(()=>pDAO.promise.resolve(aDAO));return pDAO}},{name:"children",getter:function(){return this.children_}}]});
foam.CLASS({package:"foam.flow",name:"MarkupEditor",extends:"foam.u2.View",requires:["foam.u2.tag.TextArea"],properties:[{name:"preview"}],css:`
^{
table-layout: fixed;
}
^left {
}
^right {
}`,methods:[function render(){this.onDetach(this.data$.sub(this.updatePreview));this.updatePreview();this.start("table").addClass(this.myClass()).start("tr").start("td").attrs({valign:"top"}).addClass(this.myClass("left")).add(this.slot(function(preview){return preview?preview.toE(this.__subSubContext__):this.E()})).end("td").start("td").attrs({valign:"top"}).addClass(this.myClass("right")).start(this.TextArea,{rows:24,cols:80,onKey:true,data$:this.data$}).end("td").end("tr").end("table")}],listeners:[{name:"updatePreview",isMerged:1e3,code:function(){this.preview=this.__context__.lookup("foam.flow.Document").create({markup:this.data})}}]});
foam.CLASS({package:"foam.flow",name:"DocumentationFolderDAO",extends:"foam.dao.AbstractDAO",requires:["foam.flow.Document"],properties:[{name:"of",},{name:"delegate",},{class:"Object",name:"storage",}],methods:[{name:"select_",},{name:"verifyId",args:[{name:"id",type:"String"}],},{name:"put_",},{name:"remove_",},{name:"find_",}]});
foam.CLASS({package:"foam.flow.widgets",name:"AxiomShortSummary",extends:"foam.u2.Element",css:`
^preformatted {
white-space: pre;
}
^ {
width: '100%';
}
^td,
^th {
word-break: break-all;
}
`,properties:[{name:"of",class:"Class"},{name:"whitelist",class:"StringArray"},{name:"ownAxioms",class:"Boolean"},{name:"axiomClass",class:"Class",value:"foam.core.Axiom"}],methods:[function render(){var getAxioms=`get${this.ownAxioms?"Own":""}AxiomsByClass`;var axs=this.of[getAxioms](this.axiomClass);if(this.whitelist.length>0){axs=axs.filter(ax=>this.whitelist.includes(ax.name))}var self=this;this.start("table").start("tr").start("th").add("Name").end().call(function(){self.generateAxiomClassHeadings.call(self,this)}).start("th").add("Documentation").end().end().forEach(axs,function(ax){this.start("tr").start("td").add(ax.name).end().call(function(){self.generateAxiomClassFields.call(self,this,ax)}).start("td").addClass(self.myClass("preformatted")).add(ax.documentation).end().end()}).end()},function generateAxiomClassHeadings(){},function generateAxiomClassFields(){},function toFriendlyType(p){var propCls=p.cls_.id;const prefix="foam.core.";if(propCls.startsWith(prefix)){propCls=propCls.slice(prefix.length)}if(propCls=="FObjectProperty"){return"FObject of "+p.of.id}if(propCls=="FObjectArray"){return"FObject[] of "+p.of.id}if(propCls=="Enum"){return"Enum of "+p.of.id}if(propCls=="foam.dao.DaoSpec"){return"DAO of "+p.of.id}return propCls}]});
foam.CLASS({package:"foam.flow.widgets",name:"MethodShortSummary",extends:"foam.flow.widgets.AxiomShortSummary",properties:[["axiomClass","foam.core.Method"],["ownAxioms",true]],css:`
^argumentRow {
display: flex;
justify-content: space-between;
}
^rowGap {
flex: 1 0 10px;
}
`,methods:[function generateAxiomClassHeadings(el){el.start("th").add("Type").end();el.start("th").add("Arguments").end()},function generateAxiomClassFields(el,m){var self=this;var args=m.args;if((!args||!args.length)&&m.code){args=foam.Function.argNames(m.code).map(name=>({type:"Any",name:name}))}el.start("td").add(m.type).end().start("td").forEach(args,function(arg){this.start().addClass(self.myClass("argumentRow")).start().add(arg.name).end().start().addClass(self.myClass("rowGap")).end().start().add(arg.type).end().end()}).end()},function toFriendlyType(p){var propCls=p.cls_.id;const prefix="foam.core.";if(propCls.startsWith(prefix)){propCls=propCls.slice(prefix.length)}if(propCls=="FObjectProperty"){return"FObject of "+p.of.id}if(propCls=="FObjectArray"){return"FObject[] of "+p.of.id}if(propCls=="Enum"){return"Enum of "+p.of.id}if(propCls=="foam.dao.DaoSpec"){return"DAO of "+p.of.id}return propCls}]});
foam.CLASS({package:"foam.flow.widgets",name:"PropertyShortSummary",extends:"foam.flow.widgets.AxiomShortSummary",properties:[{name:"axiomClass",value:"foam.core.Property"}],methods:[function generateAxiomClassHeadings(el){el.start("th").add("Type").end()},function generateAxiomClassFields(el,p){el.start("td").add(this.toFriendlyType(p)).end()},function toFriendlyType(p){var propCls=p.cls_.id;const prefix="foam.core.";if(propCls.startsWith(prefix)){propCls=propCls.slice(prefix.length)}if(propCls=="FObjectProperty"){return"FObject of "+p.of.id}if(propCls=="FObjectArray"){return"FObject[] of "+p.of.id}if(propCls=="Enum"){return"Enum of "+p.of.id}if(propCls=="foam.dao.DaoSpec"){return"DAO of "+p.of.id}return propCls}]});
foam.CLASS({package:"foam.flow.widgets",name:"SequenceSummary",extends:"foam.u2.Element",requires:["foam.core.NullAgent"],css:`
^nullAgent {
background-color: %DESTRUCTIVE2% !important;
color: %WHITE%;
}
`,properties:[{name:"of",class:"Class"},{name:"method",class:"String"},{class:"FObjectProperty",name:"sequence"}],methods:[function render(){var sequence=this.sequence||(()=>{var instance=this.of.create(null,this.__subContext__);return instance[this.method]()})();var self=this;this.start("table").start("tr").start("th").add("Name").end().start("th").add("Documentation").end().end().forEach(sequence.contextAgentSpecs,function(step){this.start("tr").start("td").add(step.name).end().start("td").callIfElse(self.NullAgent.isSubClass(step.spec),function(){this.addClass(self.myClass("nullAgent")).add("This agent was removed from a parent sequence.")},function(){this.add(self.getCls_(step.spec).model_.documentation)}).callIf(step.args,function(){var views=self.viewsFor_(step.args);this.start("table").start("tr").start("th").add("Property").end().start("th").add("Value").end().end().forEach(Object.keys(views),function(k){this.start("tr").start("td").add(k).end().start("td").callIfElse(views[k]==null,function(){this.add(step.args(k))},function(){this.startContext({data:step.args[k]}).tag(views[k],{data:step.args[k]}).endContext()}).end()}).end()}).end().end()}).end()},function viewsFor_(args){var views={};for(let k in args){if(args[k]&&args[k].cls_&&foam.core.AbstractEnum.isInstance(args[k])){views[k]={class:"foam.u2.view.ReadOnlyEnumView"};continue}views[k]=null}return views},function getCls_(spec){if(spec.create)return spec;return this.__subContext__.lookup(spec.class)}]});foam.ENUM({package:"foam.flow.widgets",name:"ModelType",values:[{name:"CLASS",background:"#D57D11",color:"#FFFFFF"},{name:"ENUM",color:"#865300"},{name:"INTERFACE",color:"#007328"}]});
foam.CLASS({package:"foam.flow.widgets",name:"ModelSummary",extends:"foam.u2.Element",imports:["capabilityDAO?"],requires:["foam.core.PromiseSlot","foam.flow.widgets.ModelType","foam.u2.Element","foam.u2.view.ReadOnlyEnumView"],properties:[{name:"of",class:"Class"},{name:"modelType",class:"Enum",of:"foam.flow.widgets.ModelType",expression:function(of){const typeMapping=[[foam.core.AbstractInterface,this.ModelType.INTERFACE],[foam.core.AbstractEnum,this.ModelType.ENUM]];for(let mapping of typeMapping){if(mapping[0].isSubClass(of))return mapping[1]}return this.ModelType.CLASS}},{name:"showProperties",class:"Boolean"},{name:"visibleModelProps",class:"StringArray",factory:()=>["package","name","extends","implements"],adapt:function(_,v){if(typeof v==="string"){return v.split(",")}return v}},{name:"moreModelProps",class:"StringArray",factory:()=>["imports","exports","requires"]},{name:"adapters",factory:()=>({implements:arry=>(arry||[]).map(impl=>impl.path).join(", ")})},{name:"tables",factory:()=>({"foam.core.Constant":{headings:["Name","Documentation","Value"],adapt:cons=>[cons.name,cons.documentation,cons.value]}})}],methods:[function render(){var self=this;this.start("table").start("tr").start("th").add("Property").end().start("th").add("Value").end().end().start("tr").start("td").add("type").end().start("td").tag(this.ReadOnlyEnumView,{data$:this.modelType$}).end().end().forEach(this.visibleModelProps,function(p){var value=self.of.model_[p];if(self.adapters[p])value=self.adapters[p](value);var subTable=value&&Array.isArray(value)&&value.length>0&&self.tables[value[0].cls_.id];this.start("tr").start("td").add(p).end().start("td").callIfElse(subTable,function(){this.start("table").start("tr").forEach(subTable.headings,function(h){this.start("th").add(h).end()}).end().forEach(value,function(vRow){this.start("tr").forEach(subTable.adapt(vRow),function(vCell){this.start("td").add(self.matchRef(vCell)).end()}).end()}).end()},function(){this.add(value)}).end().end()}).end()},function matchRef(id){if(typeof id!=="string")return id;if(this.capabilityDAO){return this.PromiseSlot.create({promise:this.capabilityDAO.find(id)}).map(found=>found?this.Element.create({nodeName:"a"}).attrs({href:"#admin.crunchlab:"+id,target:"_blank"}).add(id):id)}}]});
foam.CLASS({package:"foam.flow.widgets",name:"EnumSummary",extends:"foam.u2.Element",properties:[{name:"of",class:"Class"},{name:"whitelist",class:"StringArray"}],methods:[function render(){var vals=this.of.VALUES;if(this.whitelist.length>0){vals=vals.filter(ax=>this.whitelist.includes(ax.name))}var self=this;this.start("table").start("tr").start("th").add("Name").end().start("th").add("Documentation").end().end().forEach(vals,function(ax){this.start("tr").start("td").add(ax.name).end().start("td").add(ax.documentation).end().end()}).end()}]});
foam.CLASS({package:"foam.flow.widgets",name:"TabbedModelDocumentation",extends:"foam.u2.Element",requires:["foam.flow.widgets.PropertyShortSummary","foam.flow.widgets.MethodShortSummary","foam.flow.widgets.ModelSummary","foam.u2.Tab","foam.u2.Tabs"],properties:[{name:"of",class:"Class"},{name:"defaultTab",class:"String",value:"summary"}],messages:[{name:"TAB_SUMMARY",message:"Summary"}],methods:[function render(){var self=this;this.start(this.Tabs).start(this.Tab,{label:this.TAB_SUMMARY,selected:this.defaultTab=="summary"}).tag(this.ModelSummary,{of$:this.of$}).end().start(this.Tab,{label:foam.core.Model.METHODS.label,selected:this.defaultTab=="methods"}).tag(this.MethodShortSummary,{of$:this.of$}).end().start(this.Tab,{label:foam.core.Model.PROPERTIES.label,selected:this.defaultTab=="properties"}).tag(this.PropertyShortSummary,{of$:this.of$}).end().end()},function matchRef(id){if(typeof id!=="string")return id;if(this.capabilityDAO){return this.PromiseSlot.create({promise:this.capabilityDAO.find(id)}).map(found=>found?this.Element.create({nodeName:"a"}).attrs({href:"#admin.crunchlab:"+id,target:"_blank"}).add(id):id)}}]});
foam.CLASS({package:"foam.flow.widgets",name:"DocumentationIncomplete",extends:"foam.u2.Element",css:`
^ {
padding: 10pt;
}
^ > .cautionTape {
background-color: #e6e600;
padding: 8pt;
/*
transform: rotateZ(-4deg);
it was a fun idea, but not practical as it will overlap
other text at certain widths.
*/
font-size: 14pt;
text-align: center;
pointer-events: none;
opacity: 0.9;
}
`,properties:[{name:"status",class:"String"},{name:"isSection",class:"Boolean"},{name:"message",class:"String",expression:function(status,isSection){return"This "+(isSection?"section":"documentation")+" "+(status=="todo"?"has not been written yet":"is incomplete")+"."}}],methods:[function render(){this.addClass(this.myClass()).start().addClass("cautionTape").add(this.message$).end()}]});
foam.CLASS({package:"foam.flow.widgets",name:"TryItSnippet",extends:"foam.u2.Element",imports:["innerFLOW"],requires:["foam.nanos.script.Script","foam.u2.view.PreView"],properties:[{name:"server",class:"Boolean"},{name:"language",class:"Enum",of:"foam.nanos.script.Language"},{name:"code",class:"Code"},{name:"scriptOutput",class:"String",updateVisibility:"RO",view:{class:"foam.u2.view.PreView"}},{name:"scriptId",factory:()=>foam.uuid.randomGUID()},{name:"script",class:"FObjectProperty",of:"foam.nanos.script.Script",factory:function(){return this.Script.create({id$:this.scriptId$,code$:this.code$,server$:this.server$,language$:this.language$,output$:this.scriptOutput$,isSynchronous:true})}}],methods:[function init(){this.code=this.innerFLOW;this.innerFLOW$.sub(()=>{this.code=this.innerFLOW})},function render(){this.tag(this.SERVER.view,{data$:this.server$}).tag(this.CODE.view,{data$:this.code$}).tag(this.SCRIPT_OUTPUT.view,{data$:this.scriptOutput$}).startContext({data:this}).tag(this.RUN).endContext()}],actions:[{name:"run",tableWidth:90,confirmationRequired:function(){return true},code:function(){console.log("script...",this.script,this);return this.script.run()}}]});
foam.CLASS({package:"foam.flow.widgets",name:"ApiShortSummary",extends:"foam.flow.widgets.AxiomShortSummary",properties:[{name:"axiomClass",value:"foam.core.Property"}],methods:[function generateAxiomClassHeadings(el){el.start("th").add("Type").end().start("th").add("Usage").end().start("th").add("Default").end()},function generateAxiomClassFields(el,p){el.start("td").add(this.toFriendlyType(p)).end().start("td").add(this.toFriendlyUsage(p)).end().start("td").add(this.toFriendlyValue(p)).end()},function toFriendlyUsage(p){return p.required?"Required":"Optional"},function toFriendlyValue(p){return p.value?p.value:""},function toFriendlyType(p){var propCls=p.cls_.id;const prefix="foam.core.";if(propCls.startsWith(prefix)){propCls=propCls.slice(prefix.length)}if(propCls=="FObjectProperty"){return"FObject of "+p.of.id}if(propCls=="FObjectArray"){return"FObject[] of "+p.of.id}if(propCls=="Enum"){return"Enum of "+p.of.id}if(propCls=="foam.dao.DaoSpec"){return"DAO of "+p.of.id}return propCls}]});
foam.CLASS({package:"org.chartjs",name:"Lib",flags:["web"],constants:[{name:"CHART",factory:function(){try{!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):t.Chart=e()}(this,function(){"use strict";var t={rgb2hsl:e,rgb2hsv:i,rgb2hwb:n,rgb2cmyk:a,rgb2keyword:o,rgb2xyz:s,rgb2lab:l,rgb2lch:function(t){return v(l(t))},hsl2rgb:u,hsl2hsv:function(t){var e=t[0],i=t[1]/100,n=t[2]/100;if(0===n)return[0,0,0];return[e,100*(2*(i*=(n*=2)<=1?n:2-n)/(n+i)),100*((n+i)/2)]},hsl2hwb:function(t){return n(u(t))},hsl2cmyk:function(t){return a(u(t))},hsl2keyword:function(t){return o(u(t))},hsv2rgb:d,hsv2hsl:function(t){var e,i,n=t[0],a=t[1]/100,r=t[2]/100;return e=a*r,[n,100*(e=(e/=(i=(2-a)*r)<=1?i:2-i)||0),100*(i/=2)]},hsv2hwb:function(t){return n(d(t))},hsv2cmyk:function(t){return a(d(t))},hsv2keyword:function(t){return o(d(t))},hwb2rgb:h,hwb2hsl:function(t){return e(h(t))},hwb2hsv:function(t){return i(h(t))},hwb2cmyk:function(t){return a(h(t))},hwb2keyword:function(t){return o(h(t))},cmyk2rgb:c,cmyk2hsl:function(t){return e(c(t))},cmyk2hsv:function(t){return i(c(t))},cmyk2hwb:function(t){return n(c(t))},cmyk2keyword:function(t){return o(c(t))},keyword2rgb:_,keyword2hsl:function(t){return e(_(t))},keyword2hsv:function(t){return i(_(t))},keyword2hwb:function(t){return n(_(t))},keyword2cmyk:function(t){return a(_(t))},keyword2lab:function(t){return l(_(t))},keyword2xyz:function(t){return s(_(t))},xyz2rgb:f,xyz2lab:m,xyz2lch:function(t){return v(m(t))},lab2xyz:p,lab2rgb:y,lab2lch:v,lch2lab:x,lch2xyz:function(t){return p(x(t))},lch2rgb:function(t){return y(x(t))}};function e(t){var e,i,n=t[0]/255,a=t[1]/255,r=t[2]/255,o=Math.min(n,a,r),s=Math.max(n,a,r),l=s-o;return s==o?e=0:n==s?e=(a-r)/l:a==s?e=2+(r-n)/l:r==s&&(e=4+(n-a)/l),(e=Math.min(60*e,360))<0&&(e+=360),i=(o+s)/2,[e,100*(s==o?0:i<=.5?l/(s+o):l/(2-s-o)),100*i]}function i(t){var e,i,n=t[0],a=t[1],r=t[2],o=Math.min(n,a,r),s=Math.max(n,a,r),l=s-o;return i=0==s?0:l/s*1e3/10,s==o?e=0:n==s?e=(a-r)/l:a==s?e=2+(r-n)/l:r==s&&(e=4+(n-a)/l),(e=Math.min(60*e,360))<0&&(e+=360),[e,i,s/255*1e3/10]}function n(t){var i=t[0],n=t[1],a=t[2];return[e(t)[0],100*(1/255*Math.min(i,Math.min(n,a))),100*(a=1-1/255*Math.max(i,Math.max(n,a)))]}function a(t){var e,i=t[0]/255,n=t[1]/255,a=t[2]/255;return[100*((1-i-(e=Math.min(1-i,1-n,1-a)))/(1-e)||0),100*((1-n-e)/(1-e)||0),100*((1-a-e)/(1-e)||0),100*e]}function o(t){return w[JSON.stringify(t)]}function s(t){var e=t[0]/255,i=t[1]/255,n=t[2]/255;return[100*(.4124*(e=e>.04045?Math.pow((e+.055)/1.055,2.4):e/12.92)+.3576*(i=i>.04045?Math.pow((i+.055)/1.055,2.4):i/12.92)+.1805*(n=n>.04045?Math.pow((n+.055)/1.055,2.4):n/12.92)),100*(.2126*e+.7152*i+.0722*n),100*(.0193*e+.1192*i+.9505*n)]}function l(t){var e=s(t),i=e[0],n=e[1],a=e[2];return n/=100,a/=108.883,i=(i/=95.047)>.008856?Math.pow(i,1/3):7.787*i+16/116,[116*(n=n>.008856?Math.pow(n,1/3):7.787*n+16/116)-16,500*(i-n),200*(n-(a=a>.008856?Math.pow(a,1/3):7.787*a+16/116))]}function u(t){var e,i,n,a,r,o=t[0]/360,s=t[1]/100,l=t[2]/100;if(0==s)return[r=255*l,r,r];e=2*l-(i=l<.5?l*(1+s):l+s-l*s),a=[0,0,0];for(var u=0;u<3;u++)(n=o+1/3*-(u-1))<0&&n++,n>1&&n--,r=6*n<1?e+6*(i-e)*n:2*n<1?i:3*n<2?e+(i-e)*(2/3-n)*6:e,a[u]=255*r;return a}function d(t){var e=t[0]/60,i=t[1]/100,n=t[2]/100,a=Math.floor(e)%6,r=e-Math.floor(e),o=255*n*(1-i),s=255*n*(1-i*r),l=255*n*(1-i*(1-r));n*=255;switch(a){case 0:return[n,l,o];case 1:return[s,n,o];case 2:return[o,n,l];case 3:return[o,s,n];case 4:return[l,o,n];case 5:return[n,o,s]}}function h(t){var e,i,n,a,o=t[0]/360,s=t[1]/100,l=t[2]/100,u=s+l;switch(u>1&&(s/=u,l/=u),n=6*o-(e=Math.floor(6*o)),0!=(1&e)&&(n=1-n),a=s+n*((i=1-l)-s),e){default:case 6:case 0:r=i,g=a,b=s;break;case 1:r=a,g=i,b=s;break;case 2:r=s,g=i,b=a;break;case 3:r=s,g=a,b=i;break;case 4:r=a,g=s,b=i;break;case 5:r=i,g=s,b=a}return[255*r,255*g,255*b]}function c(t){var e=t[0]/100,i=t[1]/100,n=t[2]/100,a=t[3]/100;return[255*(1-Math.min(1,e*(1-a)+a)),255*(1-Math.min(1,i*(1-a)+a)),255*(1-Math.min(1,n*(1-a)+a))]}function f(t){var e,i,n,a=t[0]/100,r=t[1]/100,o=t[2]/100;return i=-.9689*a+1.8758*r+.0415*o,n=.0557*a+-.204*r+1.057*o,e=(e=3.2406*a+-1.5372*r+-.4986*o)>.0031308?1.055*Math.pow(e,1/2.4)-.055:e*=12.92,i=i>.0031308?1.055*Math.pow(i,1/2.4)-.055:i*=12.92,n=n>.0031308?1.055*Math.pow(n,1/2.4)-.055:n*=12.92,[255*(e=Math.min(Math.max(0,e),1)),255*(i=Math.min(Math.max(0,i),1)),255*(n=Math.min(Math.max(0,n),1))]}function m(t){var e=t[0],i=t[1],n=t[2];return i/=100,n/=108.883,e=(e/=95.047)>.008856?Math.pow(e,1/3):7.787*e+16/116,[116*(i=i>.008856?Math.pow(i,1/3):7.787*i+16/116)-16,500*(e-i),200*(i-(n=n>.008856?Math.pow(n,1/3):7.787*n+16/116))]}function p(t){var e,i,n,a,r=t[0],o=t[1],s=t[2];return r<=8?a=(i=100*r/903.3)/100*7.787+16/116:(i=100*Math.pow((r+16)/116,3),a=Math.pow(i/100,1/3)),[e=e/95.047<=.008856?e=95.047*(o/500+a-16/116)/7.787:95.047*Math.pow(o/500+a,3),i,n=n/108.883<=.008859?n=108.883*(a-s/200-16/116)/7.787:108.883*Math.pow(a-s/200,3)]}function v(t){var e,i=t[0],n=t[1],a=t[2];return(e=360*Math.atan2(a,n)/2/Math.PI)<0&&(e+=360),[i,Math.sqrt(n*n+a*a),e]}function y(t){return f(p(t))}function x(t){var e,i=t[0],n=t[1];return e=t[2]/360*2*Math.PI,[i,n*Math.cos(e),n*Math.sin(e)]}function _(t){return k[t]}var k={aliceblue:[240,248,255],antiquewhite:[250,235,215],aqua:[0,255,255],aquamarine:[127,255,212],azure:[240,255,255],beige:[245,245,220],bisque:[255,228,196],black:[0,0,0],blanchedalmond:[255,235,205],blue:[0,0,255],blueviolet:[138,43,226],brown:[165,42,42],burlywood:[222,184,135],cadetblue:[95,158,160],chartreuse:[127,255,0],chocolate:[210,105,30],coral:[255,127,80],cornflowerblue:[100,149,237],cornsilk:[255,248,220],crimson:[220,20,60],cyan:[0,255,255],darkblue:[0,0,139],darkcyan:[0,139,139],darkgoldenrod:[184,134,11],darkgray:[169,169,169],darkgreen:[0,100,0],darkgrey:[169,169,169],darkkhaki:[189,183,107],darkmagenta:[139,0,139],darkolivegreen:[85,107,47],darkorange:[255,140,0],darkorchid:[153,50,204],darkred:[139,0,0],darksalmon:[233,150,122],darkseagreen:[143,188,143],darkslateblue:[72,61,139],darkslategray:[47,79,79],darkslategrey:[47,79,79],darkturquoise:[0,206,209],darkviolet:[148,0,211],deeppink:[255,20,147],deepskyblue:[0,191,255],dimgray:[105,105,105],dimgrey:[105,105,105],dodgerblue:[30,144,255],firebrick:[178,34,34],floralwhite:[255,250,240],forestgreen:[34,139,34],fuchsia:[255,0,255],gainsboro:[220,220,220],ghostwhite:[248,248,255],gold:[255,215,0],goldenrod:[218,165,32],gray:[128,128,128],green:[0,128,0],greenyellow:[173,255,47],grey:[128,128,128],honeydew:[240,255,240],hotpink:[255,105,180],indianred:[205,92,92],indigo:[75,0,130],ivory:[255,255,240],khaki:[240,230,140],lavender:[230,230,250],lavenderblush:[255,240,245],lawngreen:[124,252,0],lemonchiffon:[255,250,205],lightblue:[173,216,230],lightcoral:[240,128,128],lightcyan:[224,255,255],lightgoldenrodyellow:[250,250,210],lightgray:[211,211,211],lightgreen:[144,238,144],lightgrey:[211,211,211],lightpink:[255,182,193],lightsalmon:[255,160,122],lightseagreen:[32,178,170],lightskyblue:[135,206,250],lightslategray:[119,136,153],lightslategrey:[119,136,153],lightsteelblue:[176,196,222],lightyellow:[255,255,224],lime:[0,255,0],limegreen:[50,205,50],linen:[250,240,230],magenta:[255,0,255],maroon:[128,0,0],mediumaquamarine:[102,205,170],mediumblue:[0,0,205],mediumorchid:[186,85,211],mediumpurple:[147,112,219],mediumseagreen:[60,179,113],mediumslateblue:[123,104,238],mediumspringgreen:[0,250,154],mediumturquoise:[72,209,204],mediumvioletred:[199,21,133],midnightblue:[25,25,112],mintcream:[245,255,250],mistyrose:[255,228,225],moccasin:[255,228,181],navajowhite:[255,222,173],navy:[0,0,128],oldlace:[253,245,230],olive:[128,128,0],olivedrab:[107,142,35],orange:[255,165,0],orangered:[255,69,0],orchid:[218,112,214],palegoldenrod:[238,232,170],palegreen:[152,251,152],paleturquoise:[175,238,238],palevioletred:[219,112,147],papayawhip:[255,239,213],peachpuff:[255,218,185],peru:[205,133,63],pink:[255,192,203],plum:[221,160,221],powderblue:[176,224,230],purple:[128,0,128],rebeccapurple:[102,51,153],red:[255,0,0],rosybrown:[188,143,143],royalblue:[65,105,225],saddlebrown:[139,69,19],salmon:[250,128,114],sandybrown:[244,164,96],seagreen:[46,139,87],seashell:[255,245,238],sienna:[160,82,45],silver:[192,192,192],skyblue:[135,206,235],slateblue:[106,90,205],slategray:[112,128,144],slategrey:[112,128,144],snow:[255,250,250],springgreen:[0,255,127],steelblue:[70,130,180],tan:[210,180,140],teal:[0,128,128],thistle:[216,191,216],tomato:[255,99,71],turquoise:[64,224,208],violet:[238,130,238],wheat:[245,222,179],white:[255,255,255],whitesmoke:[245,245,245],yellow:[255,255,0],yellowgreen:[154,205,50]},w={};for(var M in k)w[JSON.stringify(k[M])]=M;var S=function(){return new O};for(var D in t){S[D+"Raw"]=function(e){return function(i){return"number"==typeof i&&(i=Array.prototype.slice.call(arguments)),t[e](i)}}(D);var C=/(\w+)2(\w+)/.exec(D),P=C[1],T=C[2];(S[P]=S[P]||{})[T]=S[D]=function(e){return function(i){"number"==typeof i&&(i=Array.prototype.slice.call(arguments));var n=t[e](i);if("string"==typeof n||void 0===n)return n;for(var a=0;a<n.length;a++)n[a]=Math.round(n[a]);return n}}(D)}var O=function(){this.convs={}};O.prototype.routeSpace=function(t,e){var i=e[0];return void 0===i?this.getValues(t):("number"==typeof i&&(i=Array.prototype.slice.call(e)),this.setValues(t,i))},O.prototype.setValues=function(t,e){return this.space=t,this.convs={},this.convs[t]=e,this},O.prototype.getValues=function(t){var e=this.convs[t];if(!e){var i=this.space,n=this.convs[i];e=S[i][t](n),this.convs[t]=e}return e},["rgb","hsl","hsv","cmyk","keyword"].forEach(function(t){O.prototype[t]=function(e){return this.routeSpace(t,arguments)}});var I=S,A={aliceblue:[240,248,255],antiquewhite:[250,235,215],aqua:[0,255,255],aquamarine:[127,255,212],azure:[240,255,255],beige:[245,245,220],bisque:[255,228,196],black:[0,0,0],blanchedalmond:[255,235,205],blue:[0,0,255],blueviolet:[138,43,226],brown:[165,42,42],burlywood:[222,184,135],cadetblue:[95,158,160],chartreuse:[127,255,0],chocolate:[210,105,30],coral:[255,127,80],cornflowerblue:[100,149,237],cornsilk:[255,248,220],crimson:[220,20,60],cyan:[0,255,255],darkblue:[0,0,139],darkcyan:[0,139,139],darkgoldenrod:[184,134,11],darkgray:[169,169,169],darkgreen:[0,100,0],darkgrey:[169,169,169],darkkhaki:[189,183,107],darkmagenta:[139,0,139],darkolivegreen:[85,107,47],darkorange:[255,140,0],darkorchid:[153,50,204],darkred:[139,0,0],darksalmon:[233,150,122],darkseagreen:[143,188,143],darkslateblue:[72,61,139],darkslategray:[47,79,79],darkslategrey:[47,79,79],darkturquoise:[0,206,209],darkviolet:[148,0,211],deeppink:[255,20,147],deepskyblue:[0,191,255],dimgray:[105,105,105],dimgrey:[105,105,105],dodgerblue:[30,144,255],firebrick:[178,34,34],floralwhite:[255,250,240],forestgreen:[34,139,34],fuchsia:[255,0,255],gainsboro:[220,220,220],ghostwhite:[248,248,255],gold:[255,215,0],goldenrod:[218,165,32],gray:[128,128,128],green:[0,128,0],greenyellow:[173,255,47],grey:[128,128,128],honeydew:[240,255,240],hotpink:[255,105,180],indianred:[205,92,92],indigo:[75,0,130],ivory:[255,255,240],khaki:[240,230,140],lavender:[230,230,250],lavenderblush:[255,240,245],lawngreen:[124,252,0],lemonchiffon:[255,250,205],lightblue:[173,216,230],lightcoral:[240,128,128],lightcyan:[224,255,255],lightgoldenrodyellow:[250,250,210],lightgray:[211,211,211],lightgreen:[144,238,144],lightgrey:[211,211,211],lightpink:[255,182,193],lightsalmon:[255,160,122],lightseagreen:[32,178,170],lightskyblue:[135,206,250],lightslategray:[119,136,153],lightslategrey:[119,136,153],lightsteelblue:[176,196,222],lightyellow:[255,255,224],lime:[0,255,0],limegreen:[50,205,50],linen:[250,240,230],magenta:[255,0,255],maroon:[128,0,0],mediumaquamarine:[102,205,170],mediumblue:[0,0,205],mediumorchid:[186,85,211],mediumpurple:[147,112,219],mediumseagreen:[60,179,113],mediumslateblue:[123,104,238],mediumspringgreen:[0,250,154],mediumturquoise:[72,209,204],mediumvioletred:[199,21,133],midnightblue:[25,25,112],mintcream:[245,255,250],mistyrose:[255,228,225],moccasin:[255,228,181],navajowhite:[255,222,173],navy:[0,0,128],oldlace:[253,245,230],olive:[128,128,0],olivedrab:[107,142,35],orange:[255,165,0],orangered:[255,69,0],orchid:[218,112,214],palegoldenrod:[238,232,170],palegreen:[152,251,152],paleturquoise:[175,238,238],palevioletred:[219,112,147],papayawhip:[255,239,213],peachpuff:[255,218,185],peru:[205,133,63],pink:[255,192,203],plum:[221,160,221],powderblue:[176,224,230],purple:[128,0,128],rebeccapurple:[102,51,153],red:[255,0,0],rosybrown:[188,143,143],royalblue:[65,105,225],saddlebrown:[139,69,19],salmon:[250,128,114],sandybrown:[244,164,96],seagreen:[46,139,87],seashell:[255,245,238],sienna:[160,82,45],silver:[192,192,192],skyblue:[135,206,235],slateblue:[106,90,205],slategray:[112,128,144],slategrey:[112,128,144],snow:[255,250,250],springgreen:[0,255,127],steelblue:[70,130,180],tan:[210,180,140],teal:[0,128,128],thistle:[216,191,216],tomato:[255,99,71],turquoise:[64,224,208],violet:[238,130,238],wheat:[245,222,179],white:[255,255,255],whitesmoke:[245,245,245],yellow:[255,255,0],yellowgreen:[154,205,50]},F={getRgba:R,getHsla:L,getRgb:function(t){var e=R(t);return e&&e.slice(0,3)},getHsl:function(t){var e=L(t);return e&&e.slice(0,3)},getHwb:W,getAlpha:function(t){var e=R(t);if(e)return e[3];if(e=L(t))return e[3];if(e=W(t))return e[3]},hexString:function(t,e){var e=void 0!==e&&3===t.length?e:t[3];return"#"+H(t[0])+H(t[1])+H(t[2])+(e>=0&&e<1?H(Math.round(255*e)):"")},rgbString:function(t,e){if(e<1||t[3]&&t[3]<1)return Y(t,e);return"rgb("+t[0]+", "+t[1]+", "+t[2]+")"},rgbaString:Y,percentString:function(t,e){if(e<1||t[3]&&t[3]<1)return N(t,e);var i=Math.round(t[0]/255*100),n=Math.round(t[1]/255*100),a=Math.round(t[2]/255*100);return"rgb("+i+"%, "+n+"%, "+a+"%)"},percentaString:N,hslString:function(t,e){if(e<1||t[3]&&t[3]<1)return z(t,e);return"hsl("+t[0]+", "+t[1]+"%, "+t[2]+"%)"},hslaString:z,hwbString:function(t,e){void 0===e&&(e=void 0!==t[3]?t[3]:1);return"hwb("+t[0]+", "+t[1]+"%, "+t[2]+"%"+(void 0!==e&&1!==e?", "+e:"")+")"},keyword:function(t){return E[t.slice(0,3)]}};function R(t){if(t){var e=[0,0,0],i=1,n=t.match(/^#([a-fA-F0-9]{3,4})$/i),a="";if(n){a=(n=n[1])[3];for(var r=0;r<e.length;r++)e[r]=parseInt(n[r]+n[r],16);a&&(i=Math.round(parseInt(a+a,16)/255*100)/100)}else if(n=t.match(/^#([a-fA-F0-9]{6}([a-fA-F0-9]{2})?)$/i)){a=n[2],n=n[1];for(r=0;r<e.length;r++)e[r]=parseInt(n.slice(2*r,2*r+2),16);a&&(i=Math.round(parseInt(a,16)/255*100)/100)}else if(n=t.match(/^rgba?\(\s*([+-]?\d+)\s*,\s*([+-]?\d+)\s*,\s*([+-]?\d+)\s*(?:,\s*([+-]?[\d\.]+)\s*)?\)$/i)){for(r=0;r<e.length;r++)e[r]=parseInt(n[r+1]);i=parseFloat(n[4])}else if(n=t.match(/^rgba?\(\s*([+-]?[\d\.]+)\%\s*,\s*([+-]?[\d\.]+)\%\s*,\s*([+-]?[\d\.]+)\%\s*(?:,\s*([+-]?[\d\.]+)\s*)?\)$/i)){for(r=0;r<e.length;r++)e[r]=Math.round(2.55*parseFloat(n[r+1]));i=parseFloat(n[4])}else if(n=t.match(/(\w+)/)){if("transparent"==n[1])return[0,0,0,0];if(!(e=A[n[1]]))return}for(r=0;r<e.length;r++)e[r]=V(e[r],0,255);return i=i||0==i?V(i,0,1):1,e[3]=i,e}}function L(t){if(t){var e=t.match(/^hsla?\(\s*([+-]?\d+)(?:deg)?\s*,\s*([+-]?[\d\.]+)%\s*,\s*([+-]?[\d\.]+)%\s*(?:,\s*([+-]?[\d\.]+)\s*)?\)/);if(e){var i=parseFloat(e[4]);return[V(parseInt(e[1]),0,360),V(parseFloat(e[2]),0,100),V(parseFloat(e[3]),0,100),V(isNaN(i)?1:i,0,1)]}}}function W(t){if(t){var e=t.match(/^hwb\(\s*([+-]?\d+)(?:deg)?\s*,\s*([+-]?[\d\.]+)%\s*,\s*([+-]?[\d\.]+)%\s*(?:,\s*([+-]?[\d\.]+)\s*)?\)/);if(e){var i=parseFloat(e[4]);return[V(parseInt(e[1]),0,360),V(parseFloat(e[2]),0,100),V(parseFloat(e[3]),0,100),V(isNaN(i)?1:i,0,1)]}}}function Y(t,e){return void 0===e&&(e=void 0!==t[3]?t[3]:1),"rgba("+t[0]+", "+t[1]+", "+t[2]+", "+e+")"}function N(t,e){return"rgba("+Math.round(t[0]/255*100)+"%, "+Math.round(t[1]/255*100)+"%, "+Math.round(t[2]/255*100)+"%, "+(e||t[3]||1)+")"}function z(t,e){return void 0===e&&(e=void 0!==t[3]?t[3]:1),"hsla("+t[0]+", "+t[1]+"%, "+t[2]+"%, "+e+")"}function V(t,e,i){return Math.min(Math.max(e,t),i)}function H(t){var e=t.toString(16).toUpperCase();return e.length<2?"0"+e:e}var E={};for(var B in A)E[A[B]]=B;var j=function(t){return t instanceof j?t:this instanceof j?(this.valid=!1,this.values={rgb:[0,0,0],hsl:[0,0,0],hsv:[0,0,0],hwb:[0,0,0],cmyk:[0,0,0,0],alpha:1},void("string"==typeof t?(e=F.getRgba(t))?this.setValues("rgb",e):(e=F.getHsla(t))?this.setValues("hsl",e):(e=F.getHwb(t))&&this.setValues("hwb",e):"object"==typeof t&&(void 0!==(e=t).r||void 0!==e.red?this.setValues("rgb",e):void 0!==e.l||void 0!==e.lightness?this.setValues("hsl",e):void 0!==e.v||void 0!==e.value?this.setValues("hsv",e):void 0!==e.w||void 0!==e.whiteness?this.setValues("hwb",e):void 0===e.c&&void 0===e.cyan||this.setValues("cmyk",e)))):new j(t);var e};j.prototype={isValid:function(){return this.valid},rgb:function(){return this.setSpace("rgb",arguments)},hsl:function(){return this.setSpace("hsl",arguments)},hsv:function(){return this.setSpace("hsv",arguments)},hwb:function(){return this.setSpace("hwb",arguments)},cmyk:function(){return this.setSpace("cmyk",arguments)},rgbArray:function(){return this.values.rgb},hslArray:function(){return this.values.hsl},hsvArray:function(){return this.values.hsv},hwbArray:function(){var t=this.values;return 1!==t.alpha?t.hwb.concat([t.alpha]):t.hwb},cmykArray:function(){return this.values.cmyk},rgbaArray:function(){var t=this.values;return t.rgb.concat([t.alpha])},hslaArray:function(){var t=this.values;return t.hsl.concat([t.alpha])},alpha:function(t){return void 0===t?this.values.alpha:(this.setValues("alpha",t),this)},red:function(t){return this.setChannel("rgb",0,t)},green:function(t){return this.setChannel("rgb",1,t)},blue:function(t){return this.setChannel("rgb",2,t)},hue:function(t){return t&&(t=(t%=360)<0?360+t:t),this.setChannel("hsl",0,t)},saturation:function(t){return this.setChannel("hsl",1,t)},lightness:function(t){return this.setChannel("hsl",2,t)},saturationv:function(t){return this.setChannel("hsv",1,t)},whiteness:function(t){return this.setChannel("hwb",1,t)},blackness:function(t){return this.setChannel("hwb",2,t)},value:function(t){return this.setChannel("hsv",2,t)},cyan:function(t){return this.setChannel("cmyk",0,t)},magenta:function(t){return this.setChannel("cmyk",1,t)},yellow:function(t){return this.setChannel("cmyk",2,t)},black:function(t){return this.setChannel("cmyk",3,t)},hexString:function(){return F.hexString(this.values.rgb)},rgbString:function(){return F.rgbString(this.values.rgb,this.values.alpha)},rgbaString:function(){return F.rgbaString(this.values.rgb,this.values.alpha)},percentString:function(){return F.percentString(this.values.rgb,this.values.alpha)},hslString:function(){return F.hslString(this.values.hsl,this.values.alpha)},hslaString:function(){return F.hslaString(this.values.hsl,this.values.alpha)},hwbString:function(){return F.hwbString(this.values.hwb,this.values.alpha)},keyword:function(){return F.keyword(this.values.rgb,this.values.alpha)},rgbNumber:function(){var t=this.values.rgb;return t[0]<<16|t[1]<<8|t[2]},luminosity:function(){for(var t=this.values.rgb,e=[],i=0;i<t.length;i++){var n=t[i]/255;e[i]=n<=.03928?n/12.92:Math.pow((n+.055)/1.055,2.4)}return.2126*e[0]+.7152*e[1]+.0722*e[2]},contrast:function(t){var e=this.luminosity(),i=t.luminosity();return e>i?(e+.05)/(i+.05):(i+.05)/(e+.05)},level:function(t){var e=this.contrast(t);return e>=7.1?"AAA":e>=4.5?"AA":""},dark:function(){var t=this.values.rgb;return(299*t[0]+587*t[1]+114*t[2])/1e3<128},light:function(){return!this.dark()},negate:function(){for(var t=[],e=0;e<3;e++)t[e]=255-this.values.rgb[e];return this.setValues("rgb",t),this},lighten:function(t){var e=this.values.hsl;return e[2]+=e[2]*t,this.setValues("hsl",e),this},darken:function(t){var e=this.values.hsl;return e[2]-=e[2]*t,this.setValues("hsl",e),this},saturate:function(t){var e=this.values.hsl;return e[1]+=e[1]*t,this.setValues("hsl",e),this},desaturate:function(t){var e=this.values.hsl;return e[1]-=e[1]*t,this.setValues("hsl",e),this},whiten:function(t){var e=this.values.hwb;return e[1]+=e[1]*t,this.setValues("hwb",e),this},blacken:function(t){var e=this.values.hwb;return e[2]+=e[2]*t,this.setValues("hwb",e),this},greyscale:function(){var t=this.values.rgb,e=.3*t[0]+.59*t[1]+.11*t[2];return this.setValues("rgb",[e,e,e]),this},clearer:function(t){var e=this.values.alpha;return this.setValues("alpha",e-e*t),this},opaquer:function(t){var e=this.values.alpha;return this.setValues("alpha",e+e*t),this},rotate:function(t){var e=this.values.hsl,i=(e[0]+t)%360;return e[0]=i<0?360+i:i,this.setValues("hsl",e),this},mix:function(t,e){var i=t,n=void 0===e?.5:e,a=2*n-1,r=this.alpha()-i.alpha(),o=((a*r==-1?a:(a+r)/(1+a*r))+1)/2,s=1-o;return this.rgb(o*this.red()+s*i.red(),o*this.green()+s*i.green(),o*this.blue()+s*i.blue()).alpha(this.alpha()*n+i.alpha()*(1-n))},toJSON:function(){return this.rgb()},clone:function(){var t,e,i=new j,n=this.values,a=i.values;for(var r in n)n.hasOwnProperty(r)&&(t=n[r],"[object Array]"===(e={}.toString.call(t))?a[r]=t.slice(0):"[object Number]"===e?a[r]=t:console.error("unexpected color value:",t));return i}},j.prototype.spaces={rgb:["red","green","blue"],hsl:["hue","saturation","lightness"],hsv:["hue","saturation","value"],hwb:["hue","whiteness","blackness"],cmyk:["cyan","magenta","yellow","black"]},j.prototype.maxes={rgb:[255,255,255],hsl:[360,100,100],hsv:[360,100,100],hwb:[360,100,100],cmyk:[100,100,100,100]},j.prototype.getValues=function(t){for(var e=this.values,i={},n=0;n<t.length;n++)i[t.charAt(n)]=e[t][n];return 1!==e.alpha&&(i.a=e.alpha),i},j.prototype.setValues=function(t,e){var i,n,a=this.values,r=this.spaces,o=this.maxes,s=1;if(this.valid=!0,"alpha"===t)s=e;else if(e.length)a[t]=e.slice(0,t.length),s=e[t.length];else if(void 0!==e[t.charAt(0)]){for(i=0;i<t.length;i++)a[t][i]=e[t.charAt(i)];s=e.a}else if(void 0!==e[r[t][0]]){var l=r[t];for(i=0;i<t.length;i++)a[t][i]=e[l[i]];s=e.alpha}if(a.alpha=Math.max(0,Math.min(1,void 0===s?a.alpha:s)),"alpha"===t)return!1;for(i=0;i<t.length;i++)n=Math.max(0,Math.min(o[t][i],a[t][i])),a[t][i]=Math.round(n);for(var u in r)u!==t&&(a[u]=I[t][u](a[t]));return!0},j.prototype.setSpace=function(t,e){var i=e[0];return void 0===i?this.getValues(t):("number"==typeof i&&(i=Array.prototype.slice.call(e)),this.setValues(t,i),this)},j.prototype.setChannel=function(t,e,i){var n=this.values[t];return void 0===i?n[e]:i===n[e]?this:(n[e]=i,this.setValues(t,n),this)},"undefined"!=typeof window&&(globalThis.Color=j);var U,G=j,q={noop:function(){},uid:(U=0,function(){return U++}),isNullOrUndef:function(t){return null==t},isArray:function(t){if(Array.isArray&&Array.isArray(t))return!0;var e=Object.prototype.toString.call(t);return"[object"===e.substr(0,7)&&"Array]"===e.substr(-6)},isObject:function(t){return null!==t&&"[object Object]"===Object.prototype.toString.call(t)},isFinite:function(t){return("number"==typeof t||t instanceof Number)&&isFinite(t)},valueOrDefault:function(t,e){return void 0===t?e:t},valueAtIndexOrDefault:function(t,e,i){return q.valueOrDefault(q.isArray(t)?t[e]:t,i)},callback:function(t,e,i){if(t&&"function"==typeof t.call)return t.apply(i,e)},each:function(t,e,i,n){var a,r,o;if(q.isArray(t))if(r=t.length,n)for(a=r-1;a>=0;a--)e.call(i,t[a],a);else for(a=0;a<r;a++)e.call(i,t[a],a);else if(q.isObject(t))for(r=(o=Object.keys(t)).length,a=0;a<r;a++)e.call(i,t[o[a]],o[a])},arrayEquals:function(t,e){var i,n,a,r;if(!t||!e||t.length!==e.length)return!1;for(i=0,n=t.length;i<n;++i)if(a=t[i],r=e[i],a instanceof Array&&r instanceof Array){if(!q.arrayEquals(a,r))return!1}else if(a!==r)return!1;return!0},clone:function(t){if(q.isArray(t))return t.map(q.clone);if(q.isObject(t)){for(var e={},i=Object.keys(t),n=i.length,a=0;a<n;++a)e[i[a]]=q.clone(t[i[a]]);return e}return t},_merger:function(t,e,i,n){var a=e[t],r=i[t];q.isObject(a)&&q.isObject(r)?q.merge(a,r,n):e[t]=q.clone(r)},_mergerIf:function(t,e,i){var n=e[t],a=i[t];q.isObject(n)&&q.isObject(a)?q.mergeIf(n,a):e.hasOwnProperty(t)||(e[t]=q.clone(a))},merge:function(t,e,i){var n,a,r,o,s,l=q.isArray(e)?e:[e],u=l.length;if(!q.isObject(t))return t;for(n=(i=i||{}).merger||q._merger,a=0;a<u;++a)if(e=l[a],q.isObject(e))for(s=0,o=(r=Object.keys(e)).length;s<o;++s)n(r[s],t,e,i);return t},mergeIf:function(t,e){return q.merge(t,e,{merger:q._mergerIf})},extend:function(t){for(var e=function(e,i){t[i]=e},i=1,n=arguments.length;i<n;++i)q.each(arguments[i],e);return t},inherits:function(t){var e=this,i=t&&t.hasOwnProperty("constructor")?t.constructor:function(){return e.apply(this,arguments)},n=function(){this.constructor=i};return n.prototype=e.prototype,i.prototype=new n,i.extend=q.inherits,t&&q.extend(i.prototype,t),i.__super__=e.prototype,i}},Z=q;q.callCallback=q.callback,q.indexOf=function(t,e,i){return Array.prototype.indexOf.call(t,e,i)},q.getValueOrDefault=q.valueOrDefault,q.getValueAtIndexOrDefault=q.valueAtIndexOrDefault;var $={linear:function(t){return t},easeInQuad:function(t){return t*t},easeOutQuad:function(t){return-t*(t-2)},easeInOutQuad:function(t){return(t/=.5)<1?.5*t*t:-.5*(--t*(t-2)-1)},easeInCubic:function(t){return t*t*t},easeOutCubic:function(t){return(t-=1)*t*t+1},easeInOutCubic:function(t){return(t/=.5)<1?.5*t*t*t:.5*((t-=2)*t*t+2)},easeInQuart:function(t){return t*t*t*t},easeOutQuart:function(t){return-((t-=1)*t*t*t-1)},easeInOutQuart:function(t){return(t/=.5)<1?.5*t*t*t*t:-.5*((t-=2)*t*t*t-2)},easeInQuint:function(t){return t*t*t*t*t},easeOutQuint:function(t){return(t-=1)*t*t*t*t+1},easeInOutQuint:function(t){return(t/=.5)<1?.5*t*t*t*t*t:.5*((t-=2)*t*t*t*t+2)},easeInSine:function(t){return 1-Math.cos(t*(Math.PI/2))},easeOutSine:function(t){return Math.sin(t*(Math.PI/2))},easeInOutSine:function(t){return-.5*(Math.cos(Math.PI*t)-1)},easeInExpo:function(t){return 0===t?0:Math.pow(2,10*(t-1))},easeOutExpo:function(t){return 1===t?1:1-Math.pow(2,-10*t)},easeInOutExpo:function(t){return 0===t?0:1===t?1:(t/=.5)<1?.5*Math.pow(2,10*(t-1)):.5*(2-Math.pow(2,-10*--t))},easeInCirc:function(t){return t>=1?t:-(Math.sqrt(1-t*t)-1)},easeOutCirc:function(t){return Math.sqrt(1-(t-=1)*t)},easeInOutCirc:function(t){return(t/=.5)<1?-.5*(Math.sqrt(1-t*t)-1):.5*(Math.sqrt(1-(t-=2)*t)+1)},easeInElastic:function(t){var e=1.70158,i=0,n=1;return 0===t?0:1===t?1:(i||(i=.3),n<1?(n=1,e=i/4):e=i/(2*Math.PI)*Math.asin(1/n),-n*Math.pow(2,10*(t-=1))*Math.sin((t-e)*(2*Math.PI)/i))},easeOutElastic:function(t){var e=1.70158,i=0,n=1;return 0===t?0:1===t?1:(i||(i=.3),n<1?(n=1,e=i/4):e=i/(2*Math.PI)*Math.asin(1/n),n*Math.pow(2,-10*t)*Math.sin((t-e)*(2*Math.PI)/i)+1)},easeInOutElastic:function(t){var e=1.70158,i=0,n=1;return 0===t?0:2==(t/=.5)?1:(i||(i=.45),n<1?(n=1,e=i/4):e=i/(2*Math.PI)*Math.asin(1/n),t<1?n*Math.pow(2,10*(t-=1))*Math.sin((t-e)*(2*Math.PI)/i)*-.5:n*Math.pow(2,-10*(t-=1))*Math.sin((t-e)*(2*Math.PI)/i)*.5+1)},easeInBack:function(t){var e=1.70158;return t*t*((e+1)*t-e)},easeOutBack:function(t){var e=1.70158;return(t-=1)*t*((e+1)*t+e)+1},easeInOutBack:function(t){var e=1.70158;return(t/=.5)<1?t*t*((1+(e*=1.525))*t-e)*.5:.5*((t-=2)*t*((1+(e*=1.525))*t+e)+2)},easeInBounce:function(t){return 1-$.easeOutBounce(1-t)},easeOutBounce:function(t){return t<1/2.75?7.5625*t*t:t<2/2.75?7.5625*(t-=1.5/2.75)*t+.75:t<2.5/2.75?7.5625*(t-=2.25/2.75)*t+.9375:7.5625*(t-=2.625/2.75)*t+.984375},easeInOutBounce:function(t){return t<.5?.5*$.easeInBounce(2*t):.5*$.easeOutBounce(2*t-1)+.5}},X={effects:$};Z.easingEffects=$;var K=Math.PI,J=K/180,Q=2*K,tt=K/2,et=K/4,it=2*K/3,nt={clear:function(t){t.ctx.clearRect(0,0,t.width,t.height)},roundedRect:function(t,e,i,n,a,r){if(r){var o=Math.min(r,a/2,n/2),s=e+o,l=i+o,u=e+n-o,d=i+a-o;t.moveTo(e,l),s<u&&l<d?(t.arc(s,l,o,-K,-tt),t.arc(u,l,o,-tt,0),t.arc(u,d,o,0,tt),t.arc(s,d,o,tt,K)):s<u?(t.moveTo(s,i),t.arc(u,l,o,-tt,tt),t.arc(s,l,o,tt,K+tt)):l<d?(t.arc(s,l,o,-K,0),t.arc(s,d,o,0,K)):t.arc(s,l,o,-K,K),t.closePath(),t.moveTo(e,i)}else t.rect(e,i,n,a)},drawPoint:function(t,e,i,n,a,r){var o,s,l,u,d,h=(r||0)*J;if(!e||"object"!=typeof e||"[object HTMLImageElement]"!==(o=e.toString())&&"[object HTMLCanvasElement]"!==o){if(!(isNaN(i)||i<=0)){switch(t.beginPath(),e){default:t.arc(n,a,i,0,Q),t.closePath();break;case"triangle":t.moveTo(n+Math.sin(h)*i,a-Math.cos(h)*i),h+=it,t.lineTo(n+Math.sin(h)*i,a-Math.cos(h)*i),h+=it,t.lineTo(n+Math.sin(h)*i,a-Math.cos(h)*i),t.closePath();break;case"rectRounded":u=i-(d=.516*i),s=Math.cos(h+et)*u,l=Math.sin(h+et)*u,t.arc(n-s,a-l,d,h-K,h-tt),t.arc(n+l,a-s,d,h-tt,h),t.arc(n+s,a+l,d,h,h+tt),t.arc(n-l,a+s,d,h+tt,h+K),t.closePath();break;case"rect":if(!r){u=Math.SQRT1_2*i,t.rect(n-u,a-u,2*u,2*u);break}h+=et;case"rectRot":s=Math.cos(h)*i,l=Math.sin(h)*i,t.moveTo(n-s,a-l),t.lineTo(n+l,a-s),t.lineTo(n+s,a+l),t.lineTo(n-l,a+s),t.closePath();break;case"crossRot":h+=et;case"cross":s=Math.cos(h)*i,l=Math.sin(h)*i,t.moveTo(n-s,a-l),t.lineTo(n+s,a+l),t.moveTo(n+l,a-s),t.lineTo(n-l,a+s);break;case"star":s=Math.cos(h)*i,l=Math.sin(h)*i,t.moveTo(n-s,a-l),t.lineTo(n+s,a+l),t.moveTo(n+l,a-s),t.lineTo(n-l,a+s),h+=et,s=Math.cos(h)*i,l=Math.sin(h)*i,t.moveTo(n-s,a-l),t.lineTo(n+s,a+l),t.moveTo(n+l,a-s),t.lineTo(n-l,a+s);break;case"line":s=Math.cos(h)*i,l=Math.sin(h)*i,t.moveTo(n-s,a-l),t.lineTo(n+s,a+l);break;case"dash":t.moveTo(n,a),t.lineTo(n+Math.cos(h)*i,a+Math.sin(h)*i)}t.fill(),t.stroke()}}else t.drawImage(e,n-e.width/2,a-e.height/2,e.width,e.height)},_isPointInArea:function(t,e){return t.x>e.left-1e-6&&t.x<e.right+1e-6&&t.y>e.top-1e-6&&t.y<e.bottom+1e-6},clipArea:function(t,e){t.save(),t.beginPath(),t.rect(e.left,e.top,e.right-e.left,e.bottom-e.top),t.clip()},unclipArea:function(t){t.restore()},lineTo:function(t,e,i,n){var a=i.steppedLine;if(a){if("middle"===a){var r=(e.x+i.x)/2;t.lineTo(r,n?i.y:e.y),t.lineTo(r,n?e.y:i.y)}else"after"===a&&!n||"after"!==a&&n?t.lineTo(e.x,i.y):t.lineTo(i.x,e.y);t.lineTo(i.x,i.y)}else i.tension?t.bezierCurveTo(n?e.controlPointPreviousX:e.controlPointNextX,n?e.controlPointPreviousY:e.controlPointNextY,n?i.controlPointNextX:i.controlPointPreviousX,n?i.controlPointNextY:i.controlPointPreviousY,i.x,i.y):t.lineTo(i.x,i.y)}},at=nt;Z.clear=nt.clear,Z.drawRoundedRectangle=function(t){t.beginPath(),nt.roundedRect.apply(nt,arguments)};var rt={_set:function(t,e){return Z.merge(this[t]||(this[t]={}),e)}};rt._set("global",{defaultColor:"rgba(0,0,0,0.1)",defaultFontColor:"#666",defaultFontFamily:"'Helvetica Neue', 'Helvetica', 'Arial', sans-serif",defaultFontSize:12,defaultFontStyle:"normal",defaultLineHeight:1.2,showLines:!0});var ot=rt,st=Z.valueOrDefault;var lt={toLineHeight:function(t,e){var i=(""+t).match(/^(normal|(\d+(?:\.\d+)?)(px|em|%)?)$/);if(!i||"normal"===i[1])return 1.2*e;switch(t=+i[2],i[3]){case"px":return t;case"%":t/=100}return e*t},toPadding:function(t){var e,i,n,a;return Z.isObject(t)?(e=+t.top||0,i=+t.right||0,n=+t.bottom||0,a=+t.left||0):e=i=n=a=+t||0,{top:e,right:i,bottom:n,left:a,height:e+n,width:a+i}},_parseFont:function(t){var e=ot.globalThis,i=st(t.fontSize,e.defaultFontSize),n={family:st(t.fontFamily,e.defaultFontFamily),lineHeight:Z.options.toLineHeight(st(t.lineHeight,e.defaultLineHeight),i),size:i,style:st(t.fontStyle,e.defaultFontStyle),weight:null,string:""};return n.string=function(t){return!t||Z.isNullOrUndef(t.size)||Z.isNullOrUndef(t.family)?null:(t.style?t.style+" ":"")+(t.weight?t.weight+" ":"")+t.size+"px "+t.family}(n),n},resolve:function(t,e,i){var n,a,r;for(n=0,a=t.length;n<a;++n)if(void 0!==(r=t[n])&&(void 0!==e&&"function"==typeof r&&(r=r(e)),void 0!==i&&Z.isArray(r)&&(r=r[i]),void 0!==r))return r}},ut=Z,dt=X,ht=at,ct=lt;ut.easing=dt,ut.canvas=ht,ut.options=ct;var ft=function(t){ut.extend(this,t),this.initialize.apply(this,arguments)};ut.extend(ft.prototype,{initialize:function(){this.hidden=!1},pivot:function(){var t=this;return t._view||(t._view=ut.clone(t._model)),t._start={},t},transition:function(t){var e=this,i=e._model,n=e._start,a=e._view;return i&&1!==t?(a||(a=e._view={}),n||(n=e._start={}),function(t,e,i,n){var a,r,o,s,l,u,d,h,c,f=Object.keys(i);for(a=0,r=f.length;a<r;++a)if(u=i[o=f[a]],e.hasOwnProperty(o)||(e[o]=u),(s=e[o])!==u&&"_"!==o[0]){if(t.hasOwnProperty(o)||(t[o]=s),(d=typeof u)==typeof(l=t[o]))if("string"===d){if((h=G(l)).valid&&(c=G(u)).valid){e[o]=c.mix(h,n).rgbString();continue}}else if(ut.isFinite(l)&&ut.isFinite(u)){e[o]=l+(u-l)*n;continue}e[o]=u}}(n,a,i,t),e):(e._view=i,e._start=null,e)},tooltipPosition:function(){return{x:this._model.x,y:this._model.y}},hasValue:function(){return ut.isNumber(this._model.x)&&ut.isNumber(this._model.y)}}),ft.extend=ut.inherits;var gt=ft,mt=gt.extend({chart:null,currentStep:0,numSteps:60,easing:"",render:null,onAnimationProgress:null,onAnimationComplete:null}),pt=mt;Object.defineProperty(mt.prototype,"animationObject",{get:function(){return this}}),Object.defineProperty(mt.prototype,"chartInstance",{get:function(){return this.chart},set:function(t){this.chart=t}}),ot._set("global",{animation:{duration:1e3,easing:"easeOutQuart",onProgress:ut.noop,onComplete:ut.noop}});var vt={animations:[],request:null,addAnimation:function(t,e,i,n){var a,r,o=this.animations;for(e.chart=t,e.startTime=Date.now(),e.duration=i,n||(t.animating=!0),a=0,r=o.length;a<r;++a)if(o[a].chart===t)return void(o[a]=e);o.push(e),1===o.length&&this.requestAnimationFrame()},cancelAnimation:function(t){var e=ut.findIndex(this.animations,function(e){return e.chart===t});-1!==e&&(this.animations.splice(e,1),t.animating=!1)},requestAnimationFrame:function(){var t=this;null===t.request&&(t.request=ut.requestAnimFrame.call(window,function(){t.request=null,t.startDigest()}))},startDigest:function(){this.advance(),this.animations.length>0&&this.requestAnimationFrame()},advance:function(){for(var t,e,i,n,a=this.animations,r=0;r<a.length;)e=(t=a[r]).chart,i=t.numSteps,n=Math.floor((Date.now()-t.startTime)/t.duration*i)+1,t.currentStep=Math.min(n,i),ut.callback(t.render,[e,t],e),ut.callback(t.onAnimationProgress,[t],e),t.currentStep>=i?(ut.callback(t.onAnimationComplete,[t],e),e.animating=!1,a.splice(r,1)):++r}},yt=ut.options.resolve,bt=["push","pop","shift","splice","unshift"];function xt(t,e){var i=t._chartjs;if(i){var n=i.listeners,a=n.indexOf(e);-1!==a&&n.splice(a,1),n.length>0||(bt.forEach(function(e){delete t[e]}),delete t._chartjs)}}var _t=function(t,e){this.initialize(t,e)};ut.extend(_t.prototype,{datasetElementType:null,dataElementType:null,initialize:function(t,e){this.chart=t,this.index=e,this.linkScales(),this.addElements()},updateIndex:function(t){this.index=t},linkScales:function(){var t=this,e=t.getMeta(),i=t.getDataset();null!==e.xAxisID&&e.xAxisID in t.chart.scales||(e.xAxisID=i.xAxisID||t.chart.options.scales.xAxes[0].id),null!==e.yAxisID&&e.yAxisID in t.chart.scales||(e.yAxisID=i.yAxisID||t.chart.options.scales.yAxes[0].id)},getDataset:function(){return this.chart.data.datasets[this.index]},getMeta:function(){return this.chart.getDatasetMeta(this.index)},getScaleForId:function(t){return this.chart.scales[t]},_getValueScaleId:function(){return this.getMeta().yAxisID},_getIndexScaleId:function(){return this.getMeta().xAxisID},_getValueScale:function(){return this.getScaleForId(this._getValueScaleId())},_getIndexScale:function(){return this.getScaleForId(this._getIndexScaleId())},reset:function(){this.update(!0)},destroy:function(){this._data&&xt(this._data,this)},createMetaDataset:function(){var t=this.datasetElementType;return t&&new t({_chart:this.chart,_datasetIndex:this.index})},createMetaData:function(t){var e=this.dataElementType;return e&&new e({_chart:this.chart,_datasetIndex:this.index,_index:t})},addElements:function(){var t,e,i=this.getMeta(),n=this.getDataset().data||[],a=i.data;for(t=0,e=n.length;t<e;++t)a[t]=a[t]||this.createMetaData(t);i.dataset=i.dataset||this.createMetaDataset()},addElementAndReset:function(t){var e=this.createMetaData(t);this.getMeta().data.splice(t,0,e),this.updateElement(e,t,!0)},buildOrUpdateElements:function(){var t,e,i=this,n=i.getDataset(),a=n.data||(n.data=[]);i._data!==a&&(i._data&&xt(i._data,i),a&&Object.isExtensible(a)&&(e=i,(t=a)._chartjs?t._chartjs.listeners.push(e):(Object.defineProperty(t,"_chartjs",{configurable:!0,enumerable:!1,value:{listeners:[e]}}),bt.forEach(function(e){var i="onData"+e.charAt(0).toUpperCase()+e.slice(1),n=t[e];Object.defineProperty(t,e,{configurable:!0,enumerable:!1,value:function(){var e=Array.prototype.slice.call(arguments),a=n.apply(this,e);return ut.each(t._chartjs.listeners,function(t){"function"==typeof t[i]&&t[i].apply(t,e)}),a}})}))),i._data=a),i.resyncElements()},update:ut.noop,transition:function(t){for(var e=this.getMeta(),i=e.data||[],n=i.length,a=0;a<n;++a)i[a].transition(t);e.dataset&&e.dataset.transition(t)},draw:function(){var t=this.getMeta(),e=t.data||[],i=e.length,n=0;for(t.dataset&&t.dataset.draw();n<i;++n)e[n].draw()},removeHoverStyle:function(t){ut.merge(t._model,t.$previousStyle||{}),delete t.$previousStyle},setHoverStyle:function(t){var e=this.chart.data.datasets[t._datasetIndex],i=t._index,n=t.custom||{},a=t._model,r=ut.getHoverColor;t.$previousStyle={backgroundColor:a.backgroundColor,borderColor:a.borderColor,borderWidth:a.borderWidth},a.backgroundColor=yt([n.hoverBackgroundColor,e.hoverBackgroundColor,r(a.backgroundColor)],void 0,i),a.borderColor=yt([n.hoverBorderColor,e.hoverBorderColor,r(a.borderColor)],void 0,i),a.borderWidth=yt([n.hoverBorderWidth,e.hoverBorderWidth,a.borderWidth],void 0,i)},resyncElements:function(){var t=this.getMeta(),e=this.getDataset().data,i=t.data.length,n=e.length;n<i?t.data.splice(n,i-n):n>i&&this.insertElements(i,n-i)},insertElements:function(t,e){for(var i=0;i<e;++i)this.addElementAndReset(t+i)},onDataPush:function(){var t=arguments.length;this.insertElements(this.getDataset().data.length-t,t)},onDataPop:function(){this.getMeta().data.pop()},onDataShift:function(){this.getMeta().data.shift()},onDataSplice:function(t,e){this.getMeta().data.splice(t,e),this.insertElements(t,arguments.length-2)},onDataUnshift:function(){this.insertElements(0,arguments.length)}}),_t.extend=ut.inherits;var kt=_t;ot._set("global",{elements:{arc:{backgroundColor:ot.globalThis.defaultColor,borderColor:"#fff",borderWidth:2,borderAlign:"center"}}});var wt=gt.extend({inLabelRange:function(t){var e=this._view;return!!e&&Math.pow(t-e.x,2)<Math.pow(e.radius+e.hoverRadius,2)},inRange:function(t,e){var i=this._view;if(i){for(var n=ut.getAngleFromPoint(i,{x:t,y:e}),a=n.angle,r=n.distance,o=i.startAngle,s=i.endAngle;s<o;)s+=2*Math.PI;for(;a>s;)a-=2*Math.PI;for(;a<o;)a+=2*Math.PI;var l=a>=o&&a<=s,u=r>=i.innerRadius&&r<=i.outerRadius;return l&&u}return!1},getCenterPoint:function(){var t=this._view,e=(t.startAngle+t.endAngle)/2,i=(t.innerRadius+t.outerRadius)/2;return{x:t.x+Math.cos(e)*i,y:t.y+Math.sin(e)*i}},getArea:function(){var t=this._view;return Math.PI*((t.endAngle-t.startAngle)/(2*Math.PI))*(Math.pow(t.outerRadius,2)-Math.pow(t.innerRadius,2))},tooltipPosition:function(){var t=this._view,e=t.startAngle+(t.endAngle-t.startAngle)/2,i=(t.outerRadius-t.innerRadius)/2+t.innerRadius;return{x:t.x+Math.cos(e)*i,y:t.y+Math.sin(e)*i}},draw:function(){var t,e=this._chart.ctx,i=this._view,n=i.startAngle,a=i.endAngle,r="inner"===i.borderAlign?.33:0;e.save(),e.beginPath(),e.arc(i.x,i.y,Math.max(i.outerRadius-r,0),n,a),e.arc(i.x,i.y,i.innerRadius,a,n,!0),e.closePath(),e.fillStyle=i.backgroundColor,e.fill(),i.borderWidth&&("inner"===i.borderAlign?(e.beginPath(),t=r/i.outerRadius,e.arc(i.x,i.y,i.outerRadius,n-t,a+t),i.innerRadius>r?(t=r/i.innerRadius,e.arc(i.x,i.y,i.innerRadius-r,a+t,n-t,!0)):e.arc(i.x,i.y,r,a+Math.PI/2,n-Math.PI/2),e.closePath(),e.clip(),e.beginPath(),e.arc(i.x,i.y,i.outerRadius,n,a),e.arc(i.x,i.y,i.innerRadius,a,n,!0),e.closePath(),e.lineWidth=2*i.borderWidth,e.lineJoin="round"):(e.lineWidth=i.borderWidth,e.lineJoin="bevel"),e.strokeStyle=i.borderColor,e.stroke()),e.restore()}}),Mt=ut.valueOrDefault,St=ot.globalThis.defaultColor;ot._set("global",{elements:{line:{tension:.4,backgroundColor:St,borderWidth:3,borderColor:St,borderCapStyle:"butt",borderDash:[],borderDashOffset:0,borderJoinStyle:"miter",capBezierPoints:!0,fill:!0}}});var Dt=gt.extend({draw:function(){var t,e,i,n,a=this._view,r=this._chart.ctx,o=a.spanGaps,s=this._children.slice(),l=ot.globalThis,u=l.elements.line,d=-1;for(this._loop&&s.length&&s.push(s[0]),r.save(),r.lineCap=a.borderCapStyle||u.borderCapStyle,r.setLineDash&&r.setLineDash(a.borderDash||u.borderDash),r.lineDashOffset=Mt(a.borderDashOffset,u.borderDashOffset),r.lineJoin=a.borderJoinStyle||u.borderJoinStyle,r.lineWidth=Mt(a.borderWidth,u.borderWidth),r.strokeStyle=a.borderColor||l.defaultColor,r.beginPath(),d=-1,t=0;t<s.length;++t)e=s[t],i=ut.previousItem(s,t),n=e._view,0===t?n.skip||(r.moveTo(n.x,n.y),d=t):(i=-1===d?i:s[d],n.skip||(d!==t-1&&!o||-1===d?r.moveTo(n.x,n.y):ut.canvas.lineTo(r,i._view,e._view),d=t));r.stroke(),r.restore()}}),Ct=ut.valueOrDefault,Pt=ot.globalThis.defaultColor;function Tt(t){var e=this._view;return!!e&&Math.abs(t-e.x)<e.radius+e.hitRadius}ot._set("global",{elements:{point:{radius:3,pointStyle:"circle",backgroundColor:Pt,borderColor:Pt,borderWidth:1,hitRadius:1,hoverRadius:4,hoverBorderWidth:1}}});var Ot=gt.extend({inRange:function(t,e){var i=this._view;return!!i&&Math.pow(t-i.x,2)+Math.pow(e-i.y,2)<Math.pow(i.hitRadius+i.radius,2)},inLabelRange:Tt,inXRange:Tt,inYRange:function(t){var e=this._view;return!!e&&Math.abs(t-e.y)<e.radius+e.hitRadius},getCenterPoint:function(){var t=this._view;return{x:t.x,y:t.y}},getArea:function(){return Math.PI*Math.pow(this._view.radius,2)},tooltipPosition:function(){var t=this._view;return{x:t.x,y:t.y,padding:t.radius+t.borderWidth}},draw:function(t){var e=this._view,i=this._chart.ctx,n=e.pointStyle,a=e.rotation,r=e.radius,o=e.x,s=e.y,l=ot.globalThis,u=l.defaultColor;e.skip||(void 0===t||ut.canvas._isPointInArea(e,t))&&(i.strokeStyle=e.borderColor||u,i.lineWidth=Ct(e.borderWidth,l.elements.point.borderWidth),i.fillStyle=e.backgroundColor||u,ut.canvas.drawPoint(i,n,r,o,s,a))}}),It=ot.globalThis.defaultColor;function At(t){return t&&void 0!==t.width}function Ft(t){var e,i,n,a,r;return At(t)?(r=t.width/2,e=t.x-r,i=t.x+r,n=Math.min(t.y,t.base),a=Math.max(t.y,t.base)):(r=t.height/2,e=Math.min(t.x,t.base),i=Math.max(t.x,t.base),n=t.y-r,a=t.y+r),{left:e,top:n,right:i,bottom:a}}function Rt(t,e,i){return t===e?i:t===i?e:t}function Lt(t,e,i){var n,a,r,o,s=t.borderWidth,l=function(t){var e=t.borderSkipped,i={};return e?(t.horizontal?t.base>t.x&&(e=Rt(e,"left","right")):t.base<t.y&&(e=Rt(e,"bottom","top")),i[e]=!0,i):i}(t);return ut.isObject(s)?(n=+s.top||0,a=+s.right||0,r=+s.bottom||0,o=+s.left||0):n=a=r=o=+s||0,{t:l.top||n<0?0:n>i?i:n,r:l.right||a<0?0:a>e?e:a,b:l.bottom||r<0?0:r>i?i:r,l:l.left||o<0?0:o>e?e:o}}function Wt(t,e,i){var n=null===e,a=null===i,r=!(!t||n&&a)&&Ft(t);return r&&(n||e>=r.left&&e<=r.right)&&(a||i>=r.top&&i<=r.bottom)}ot._set("global",{elements:{rectangle:{backgroundColor:It,borderColor:It,borderSkipped:"bottom",borderWidth:0}}});var Yt=gt.extend({draw:function(){var t=this._chart.ctx,e=this._view,i=function(t){var e=Ft(t),i=e.right-e.left,n=e.bottom-e.top,a=Lt(t,i/2,n/2);return{outer:{x:e.left,y:e.top,w:i,h:n},inner:{x:e.left+a.l,y:e.top+a.t,w:i-a.l-a.r,h:n-a.t-a.b}}}(e),n=i.outer,a=i.inner;t.fillStyle=e.backgroundColor,t.fillRect(n.x,n.y,n.w,n.h),n.w===a.w&&n.h===a.h||(t.save(),t.beginPath(),t.rect(n.x,n.y,n.w,n.h),t.clip(),t.fillStyle=e.borderColor,t.rect(a.x,a.y,a.w,a.h),t.fill("evenodd"),t.restore())},height:function(){var t=this._view;return t.base-t.y},inRange:function(t,e){return Wt(this._view,t,e)},inLabelRange:function(t,e){var i=this._view;return At(i)?Wt(i,t,null):Wt(i,null,e)},inXRange:function(t){return Wt(this._view,t,null)},inYRange:function(t){return Wt(this._view,null,t)},getCenterPoint:function(){var t,e,i=this._view;return At(i)?(t=i.x,e=(i.y+i.base)/2):(t=(i.x+i.base)/2,e=i.y),{x:t,y:e}},getArea:function(){var t=this._view;return At(t)?t.width*Math.abs(t.y-t.base):t.height*Math.abs(t.x-t.base)},tooltipPosition:function(){var t=this._view;return{x:t.x,y:t.y}}}),Nt={},zt=wt,Vt=Dt,Ht=Ot,Et=Yt;Nt.Arc=zt,Nt.Line=Vt,Nt.Point=Ht,Nt.Rectangle=Et;var Bt=ut.options.resolve;ot._set("bar",{hover:{mode:"label"},scales:{xAxes:[{type:"category",categoryPercentage:.8,barPercentage:.9,offset:!0,gridLines:{offsetGridLines:!0}}],yAxes:[{type:"linear"}]}});var jt=kt.extend({dataElementType:Nt.Rectangle,initialize:function(){var t;kt.prototype.initialize.apply(this,arguments),(t=this.getMeta()).stack=this.getDataset().stack,t.bar=!0},update:function(t){var e,i,n=this.getMeta().data;for(this._ruler=this.getRuler(),e=0,i=n.length;e<i;++e)this.updateElement(n[e],e,t)},updateElement:function(t,e,i){var n=this,a=n.getMeta(),r=n.getDataset(),o=n._resolveElementOptions(t,e);t._xScale=n.getScaleForId(a.xAxisID),t._yScale=n.getScaleForId(a.yAxisID),t._datasetIndex=n.index,t._index=e,t._model={backgroundColor:o.backgroundColor,borderColor:o.borderColor,borderSkipped:o.borderSkipped,borderWidth:o.borderWidth,datasetLabel:r.label,label:n.chart.data.labels[e]},n._updateElementGeometry(t,e,i),t.pivot()},_updateElementGeometry:function(t,e,i){var n=this,a=t._model,r=n._getValueScale(),o=r.getBasePixel(),s=r.isHorizontal(),l=n._ruler||n.getRuler(),u=n.calculateBarValuePixels(n.index,e),d=n.calculateBarIndexPixels(n.index,e,l);a.horizontal=s,a.base=i?o:u.base,a.x=s?i?o:u.head:d.center,a.y=s?d.center:i?o:u.head,a.height=s?d.size:void 0,a.width=s?void 0:d.size},_getStacks:function(t){var e,i,n=this.chart,a=this._getIndexScale().options.stacked,r=void 0===t?n.data.datasets.length:t+1,o=[];for(e=0;e<r;++e)(i=n.getDatasetMeta(e)).bar&&n.isDatasetVisible(e)&&(!1===a||!0===a&&-1===o.indexOf(i.stack)||void 0===a&&(void 0===i.stack||-1===o.indexOf(i.stack)))&&o.push(i.stack);return o},getStackCount:function(){return this._getStacks().length},getStackIndex:function(t,e){var i=this._getStacks(t),n=void 0!==e?i.indexOf(e):-1;return-1===n?i.length-1:n},getRuler:function(){var t,e,i=this._getIndexScale(),n=this.getStackCount(),a=this.index,r=i.isHorizontal(),o=r?i.left:i.top,s=o+(r?i.width:i.height),l=[];for(t=0,e=this.getMeta().data.length;t<e;++t)l.push(i.getPixelForValue(null,t,a));return{min:ut.isNullOrUndef(i.options.barThickness)?function(t,e){var i,n,a,r,o=t.isHorizontal()?t.width:t.height,s=t.getTicks();for(a=1,r=e.length;a<r;++a)o=Math.min(o,Math.abs(e[a]-e[a-1]));for(a=0,r=s.length;a<r;++a)n=t.getPixelForTick(a),o=a>0?Math.min(o,n-i):o,i=n;return o}(i,l):-1,pixels:l,start:o,end:s,stackCount:n,scale:i}},calculateBarValuePixels:function(t,e){var i,n,a,r,o,s,l=this.chart,u=this.getMeta(),d=this._getValueScale(),h=d.isHorizontal(),c=l.data.datasets,f=+d.getRightValue(c[t].data[e]),g=d.options.minBarLength,m=d.options.stacked,p=u.stack,v=0;if(m||void 0===m&&void 0!==p)for(i=0;i<t;++i)(n=l.getDatasetMeta(i)).bar&&n.stack===p&&n.controller._getValueScaleId()===d.id&&l.isDatasetVisible(i)&&(a=+d.getRightValue(c[i].data[e]),(f<0&&a<0||f>=0&&a>0)&&(v+=a));return r=d.getPixelForValue(v),s=(o=d.getPixelForValue(v+f))-r,void 0!==g&&Math.abs(s)<g&&(s=g,o=f>=0&&!h||f<0&&h?r-g:r+g),{size:s,base:r,head:o,center:o+s/2}},calculateBarIndexPixels:function(t,e,i){var n=i.scale.options,a="flex"===n.barThickness?function(t,e,i){var n,a=e.pixels,r=a[t],o=t>0?a[t-1]:null,s=t<a.length-1?a[t+1]:null,l=i.categoryPercentage;return null===o&&(o=r-(null===s?e.end-e.start:s-r)),null===s&&(s=r+r-o),n=r-(r-Math.min(o,s))/2*l,{chunk:Math.abs(s-o)/2*l/e.stackCount,ratio:i.barPercentage,start:n}}(e,i,n):function(t,e,i){var n,a,r=i.barThickness,o=e.stackCount,s=e.pixels[t];return ut.isNullOrUndef(r)?(n=e.min*i.categoryPercentage,a=i.barPercentage):(n=r*o,a=1),{chunk:n/o,ratio:a,start:s-n/2}}(e,i,n),r=this.getStackIndex(t,this.getMeta().stack),o=a.start+a.chunk*r+a.chunk/2,s=Math.min(ut.valueOrDefault(n.maxBarThickness,1/0),a.chunk*a.ratio);return{base:o-s/2,head:o+s/2,center:o,size:s}},draw:function(){var t=this.chart,e=this._getValueScale(),i=this.getMeta().data,n=this.getDataset(),a=i.length,r=0;for(ut.canvas.clipArea(t.ctx,t.chartArea);r<a;++r)isNaN(e.getRightValue(n.data[r]))||i[r].draw();ut.canvas.unclipArea(t.ctx)},_resolveElementOptions:function(t,e){var i,n,a,r=this.chart,o=r.data.datasets[this.index],s=t.custom||{},l=r.options.elements.rectangle,u={},d={chart:r,dataIndex:e,dataset:o,datasetIndex:this.index},h=["backgroundColor","borderColor","borderSkipped","borderWidth"];for(i=0,n=h.length;i<n;++i)u[a=h[i]]=Bt([s[a],o[a],l[a]],d,e);return u}}),Ut=ut.valueOrDefault,Gt=ut.options.resolve;ot._set("bubble",{hover:{mode:"single"},scales:{xAxes:[{type:"linear",position:"bottom",id:"x-axis-0"}],yAxes:[{type:"linear",position:"left",id:"y-axis-0"}]},tooltips:{callbacks:{title:function(){return""},label:function(t,e){var i=e.datasets[t.datasetIndex].label||"",n=e.datasets[t.datasetIndex].data[t.index];return i+": ("+t.xLabel+", "+t.yLabel+", "+n.r+")"}}}});var qt=kt.extend({dataElementType:Nt.Point,update:function(t){var e=this,i=e.getMeta().data;ut.each(i,function(i,n){e.updateElement(i,n,t)})},updateElement:function(t,e,i){var n=this,a=n.getMeta(),r=t.custom||{},o=n.getScaleForId(a.xAxisID),s=n.getScaleForId(a.yAxisID),l=n._resolveElementOptions(t,e),u=n.getDataset().data[e],d=n.index,h=i?o.getPixelForDecimal(.5):o.getPixelForValue("object"==typeof u?u:NaN,e,d),c=i?s.getBasePixel():s.getPixelForValue(u,e,d);t._xScale=o,t._yScale=s,t._options=l,t._datasetIndex=d,t._index=e,t._model={backgroundColor:l.backgroundColor,borderColor:l.borderColor,borderWidth:l.borderWidth,hitRadius:l.hitRadius,pointStyle:l.pointStyle,rotation:l.rotation,radius:i?0:l.radius,skip:r.skip||isNaN(h)||isNaN(c),x:h,y:c},t.pivot()},setHoverStyle:function(t){var e=t._model,i=t._options,n=ut.getHoverColor;t.$previousStyle={backgroundColor:e.backgroundColor,borderColor:e.borderColor,borderWidth:e.borderWidth,radius:e.radius},e.backgroundColor=Ut(i.hoverBackgroundColor,n(i.backgroundColor)),e.borderColor=Ut(i.hoverBorderColor,n(i.borderColor)),e.borderWidth=Ut(i.hoverBorderWidth,i.borderWidth),e.radius=i.radius+i.hoverRadius},_resolveElementOptions:function(t,e){var i,n,a,r=this.chart,o=r.data.datasets[this.index],s=t.custom||{},l=r.options.elements.point,u=o.data[e],d={},h={chart:r,dataIndex:e,dataset:o,datasetIndex:this.index},c=["backgroundColor","borderColor","borderWidth","hoverBackgroundColor","hoverBorderColor","hoverBorderWidth","hoverRadius","hitRadius","pointStyle","rotation"];for(i=0,n=c.length;i<n;++i)d[a=c[i]]=Gt([s[a],o[a],l[a]],h,e);return d.radius=Gt([s.radius,u?u.r:void 0,o.radius,l.radius],h,e),d}}),Zt=ut.options.resolve,$t=ut.valueOrDefault;ot._set("doughnut",{animation:{animateRotate:!0,animateScale:!1},hover:{mode:"single"},legendCallback:function(t){var e=[];e.push('<ul class="'+t.id+'-legend">');var i=t.data,n=i.datasets,a=i.labels;if(n.length)for(var r=0;r<n[0].data.length;++r)e.push('<li><span style="background-color:'+n[0].backgroundColor[r]+'"></span>'),a[r]&&e.push(a[r]),e.push("</li>");return e.push("</ul>"),e.join("")},legend:{labels:{generateLabels:function(t){var e=t.data;return e.labels.length&&e.datasets.length?e.labels.map(function(i,n){var a=t.getDatasetMeta(0),r=e.datasets[0],o=a.data[n],s=o&&o.custom||{},l=t.options.elements.arc;return{text:i,fillStyle:Zt([s.backgroundColor,r.backgroundColor,l.backgroundColor],void 0,n),strokeStyle:Zt([s.borderColor,r.borderColor,l.borderColor],void 0,n),lineWidth:Zt([s.borderWidth,r.borderWidth,l.borderWidth],void 0,n),hidden:isNaN(r.data[n])||a.data[n].hidden,index:n}}):[]}},onClick:function(t,e){var i,n,a,r=e.index,o=this.chart;for(i=0,n=(o.data.datasets||[]).length;i<n;++i)(a=o.getDatasetMeta(i)).data[r]&&(a.data[r].hidden=!a.data[r].hidden);o.update()}},cutoutPercentage:50,rotation:-.5*Math.PI,circumference:2*Math.PI,tooltips:{callbacks:{title:function(){return""},label:function(t,e){var i=e.labels[t.index],n=": "+e.datasets[t.datasetIndex].data[t.index];return ut.isArray(i)?(i=i.slice())[0]+=n:i+=n,i}}}});var Xt=kt.extend({dataElementType:Nt.Arc,linkScales:ut.noop,getRingIndex:function(t){for(var e=0,i=0;i<t;++i)this.chart.isDatasetVisible(i)&&++e;return e},update:function(t){var e,i,n=this,a=n.chart,r=a.chartArea,o=a.options,s=r.right-r.left,l=r.bottom-r.top,u=Math.min(s,l),d={x:0,y:0},h=n.getMeta(),c=h.data,f=o.cutoutPercentage,g=o.circumference,m=n._getRingWeight(n.index);if(g<2*Math.PI){var p=o.rotation%(2*Math.PI),v=(p+=2*Math.PI*(p>=Math.PI?-1:p<-Math.PI?1:0))+g,y={x:Math.cos(p),y:Math.sin(p)},b={x:Math.cos(v),y:Math.sin(v)},x=p<=0&&v>=0||p<=2*Math.PI&&2*Math.PI<=v,_=p<=.5*Math.PI&&.5*Math.PI<=v||p<=2.5*Math.PI&&2.5*Math.PI<=v,k=p<=-Math.PI&&-Math.PI<=v||p<=Math.PI&&Math.PI<=v,w=p<=.5*-Math.PI&&.5*-Math.PI<=v||p<=1.5*Math.PI&&1.5*Math.PI<=v,M=f/100,S={x:k?-1:Math.min(y.x*(y.x<0?1:M),b.x*(b.x<0?1:M)),y:w?-1:Math.min(y.y*(y.y<0?1:M),b.y*(b.y<0?1:M))},D={x:x?1:Math.max(y.x*(y.x>0?1:M),b.x*(b.x>0?1:M)),y:_?1:Math.max(y.y*(y.y>0?1:M),b.y*(b.y>0?1:M))},C={width:.5*(D.x-S.x),height:.5*(D.y-S.y)};u=Math.min(s/C.width,l/C.height),d={x:-.5*(D.x+S.x),y:-.5*(D.y+S.y)}}for(e=0,i=c.length;e<i;++e)c[e]._options=n._resolveElementOptions(c[e],e);for(a.borderWidth=n.getMaxBorderWidth(),a.outerRadius=Math.max((u-a.borderWidth)/2,0),a.innerRadius=Math.max(f?a.outerRadius/100*f:0,0),a.radiusLength=(a.outerRadius-a.innerRadius)/(n._getVisibleDatasetWeightTotal()||1),a.offsetX=d.x*a.outerRadius,a.offsetY=d.y*a.outerRadius,h.total=n.calculateTotal(),n.outerRadius=a.outerRadius-a.radiusLength*n._getRingWeightOffset(n.index),n.innerRadius=Math.max(n.outerRadius-a.radiusLength*m,0),e=0,i=c.length;e<i;++e)n.updateElement(c[e],e,t)},updateElement:function(t,e,i){var n=this,a=n.chart,r=a.chartArea,o=a.options,s=o.animation,l=(r.left+r.right)/2,u=(r.top+r.bottom)/2,d=o.rotation,h=o.rotation,c=n.getDataset(),f=i&&s.animateRotate?0:t.hidden?0:n.calculateCircumference(c.data[e])*(o.circumference/(2*Math.PI)),g=i&&s.animateScale?0:n.innerRadius,m=i&&s.animateScale?0:n.outerRadius,p=t._options||{};ut.extend(t,{_datasetIndex:n.index,_index:e,_model:{backgroundColor:p.backgroundColor,borderColor:p.borderColor,borderWidth:p.borderWidth,borderAlign:p.borderAlign,x:l+a.offsetX,y:u+a.offsetY,startAngle:d,endAngle:h,circumference:f,outerRadius:m,innerRadius:g,label:ut.valueAtIndexOrDefault(c.label,e,a.data.labels[e])}});var v=t._model;i&&s.animateRotate||(v.startAngle=0===e?o.rotation:n.getMeta().data[e-1]._model.endAngle,v.endAngle=v.startAngle+v.circumference),t.pivot()},calculateTotal:function(){var t,e=this.getDataset(),i=this.getMeta(),n=0;return ut.each(i.data,function(i,a){t=e.data[a],isNaN(t)||i.hidden||(n+=Math.abs(t))}),n},calculateCircumference:function(t){var e=this.getMeta().total;return e>0&&!isNaN(t)?2*Math.PI*(Math.abs(t)/e):0},getMaxBorderWidth:function(t){var e,i,n,a,r,o,s,l,u=0,d=this.chart;if(!t)for(e=0,i=d.data.datasets.length;e<i;++e)if(d.isDatasetVisible(e)){t=(n=d.getDatasetMeta(e)).data,e!==this.index&&(r=n.controller);break}if(!t)return 0;for(e=0,i=t.length;e<i;++e)a=t[e],"inner"!==(o=r?r._resolveElementOptions(a,e):a._options).borderAlign&&(s=o.borderWidth,u=(l=o.hoverBorderWidth)>(u=s>u?s:u)?l:u);return u},setHoverStyle:function(t){var e=t._model,i=t._options,n=ut.getHoverColor;t.$previousStyle={backgroundColor:e.backgroundColor,borderColor:e.borderColor,borderWidth:e.borderWidth},e.backgroundColor=$t(i.hoverBackgroundColor,n(i.backgroundColor)),e.borderColor=$t(i.hoverBorderColor,n(i.borderColor)),e.borderWidth=$t(i.hoverBorderWidth,i.borderWidth)},_resolveElementOptions:function(t,e){var i,n,a,r=this.chart,o=this.getDataset(),s=t.custom||{},l=r.options.elements.arc,u={},d={chart:r,dataIndex:e,dataset:o,datasetIndex:this.index},h=["backgroundColor","borderColor","borderWidth","borderAlign","hoverBackgroundColor","hoverBorderColor","hoverBorderWidth"];for(i=0,n=h.length;i<n;++i)u[a=h[i]]=Zt([s[a],o[a],l[a]],d,e);return u},_getRingWeightOffset:function(t){for(var e=0,i=0;i<t;++i)this.chart.isDatasetVisible(i)&&(e+=this._getRingWeight(i));return e},_getRingWeight:function(t){return Math.max($t(this.chart.data.datasets[t].weight,1),0)},_getVisibleDatasetWeightTotal:function(){return this._getRingWeightOffset(this.chart.data.datasets.length)}});ot._set("horizontalBar",{hover:{mode:"index",axis:"y"},scales:{xAxes:[{type:"linear",position:"bottom"}],yAxes:[{type:"category",position:"left",categoryPercentage:.8,barPercentage:.9,offset:!0,gridLines:{offsetGridLines:!0}}]},elements:{rectangle:{borderSkipped:"left"}},tooltips:{mode:"index",axis:"y"}});var Kt=jt.extend({_getValueScaleId:function(){return this.getMeta().xAxisID},_getIndexScaleId:function(){return this.getMeta().yAxisID}}),Jt=ut.valueOrDefault,Qt=ut.options.resolve,te=ut.canvas._isPointInArea;function ee(t,e){return Jt(t.showLine,e.showLines)}ot._set("line",{showLines:!0,spanGaps:!1,hover:{mode:"label"},scales:{xAxes:[{type:"category",id:"x-axis-0"}],yAxes:[{type:"linear",id:"y-axis-0"}]}});var ie=kt.extend({datasetElementType:Nt.Line,dataElementType:Nt.Point,update:function(t){var e,i,n=this,a=n.getMeta(),r=a.dataset,o=a.data||[],s=n.getScaleForId(a.yAxisID),l=n.getDataset(),u=ee(l,n.chart.options);for(u&&(void 0!==l.tension&&void 0===l.lineTension&&(l.lineTension=l.tension),r._scale=s,r._datasetIndex=n.index,r._children=o,r._model=n._resolveLineOptions(r),r.pivot()),e=0,i=o.length;e<i;++e)n.updateElement(o[e],e,t);for(u&&0!==r._model.tension&&n.updateBezierControlPoints(),e=0,i=o.length;e<i;++e)o[e].pivot()},updateElement:function(t,e,i){var n,a,r=this,o=r.getMeta(),s=t.custom||{},l=r.getDataset(),u=r.index,d=l.data[e],h=r.getScaleForId(o.yAxisID),c=r.getScaleForId(o.xAxisID),f=o.dataset._model,g=r._resolvePointOptions(t,e);n=c.getPixelForValue("object"==typeof d?d:NaN,e,u),a=i?h.getBasePixel():r.calculatePointY(d,e,u),t._xScale=c,t._yScale=h,t._options=g,t._datasetIndex=u,t._index=e,t._model={x:n,y:a,skip:s.skip||isNaN(n)||isNaN(a),radius:g.radius,pointStyle:g.pointStyle,rotation:g.rotation,backgroundColor:g.backgroundColor,borderColor:g.borderColor,borderWidth:g.borderWidth,tension:Jt(s.tension,f?f.tension:0),steppedLine:!!f&&f.steppedLine,hitRadius:g.hitRadius}},_resolvePointOptions:function(t,e){var i,n,a,r=this.chart,o=r.data.datasets[this.index],s=t.custom||{},l=r.options.elements.point,u={},d={chart:r,dataIndex:e,dataset:o,datasetIndex:this.index},h={backgroundColor:"pointBackgroundColor",borderColor:"pointBorderColor",borderWidth:"pointBorderWidth",hitRadius:"pointHitRadius",hoverBackgroundColor:"pointHoverBackgroundColor",hoverBorderColor:"pointHoverBorderColor",hoverBorderWidth:"pointHoverBorderWidth",hoverRadius:"pointHoverRadius",pointStyle:"pointStyle",radius:"pointRadius",rotation:"pointRotation"},c=Object.keys(h);for(i=0,n=c.length;i<n;++i)u[a=c[i]]=Qt([s[a],o[h[a]],o[a],l[a]],d,e);return u},_resolveLineOptions:function(t){var e,i,n,a=this.chart,r=a.data.datasets[this.index],o=t.custom||{},s=a.options,l=s.elements.line,u={},d=["backgroundColor","borderWidth","borderColor","borderCapStyle","borderDash","borderDashOffset","borderJoinStyle","fill","cubicInterpolationMode"];for(e=0,i=d.length;e<i;++e)u[n=d[e]]=Qt([o[n],r[n],l[n]]);return u.spanGaps=Jt(r.spanGaps,s.spanGaps),u.tension=Jt(r.lineTension,l.tension),u.steppedLine=Qt([o.steppedLine,r.steppedLine,l.stepped]),u},calculatePointY:function(t,e,i){var n,a,r,o=this.chart,s=this.getMeta(),l=this.getScaleForId(s.yAxisID),u=0,d=0;if(l.options.stacked){for(n=0;n<i;n++)if(a=o.data.datasets[n],"line"===(r=o.getDatasetMeta(n)).type&&r.yAxisID===l.id&&o.isDatasetVisible(n)){var h=Number(l.getRightValue(a.data[e]));h<0?d+=h||0:u+=h||0}var c=Number(l.getRightValue(t));return c<0?l.getPixelForValue(d+c):l.getPixelForValue(u+c)}return l.getPixelForValue(t)},updateBezierControlPoints:function(){var t,e,i,n,a=this.chart,r=this.getMeta(),o=r.dataset._model,s=a.chartArea,l=r.data||[];function u(t,e,i){return Math.max(Math.min(t,i),e)}if(o.spanGaps&&(l=l.filter(function(t){return!t._model.skip})),"monotone"===o.cubicInterpolationMode)ut.splineCurveMonotone(l);else for(t=0,e=l.length;t<e;++t)i=l[t]._model,n=ut.splineCurve(ut.previousItem(l,t)._model,i,ut.nextItem(l,t)._model,o.tension),i.controlPointPreviousX=n.previous.x,i.controlPointPreviousY=n.previous.y,i.controlPointNextX=n.next.x,i.controlPointNextY=n.next.y;if(a.options.elements.line.capBezierPoints)for(t=0,e=l.length;t<e;++t)i=l[t]._model,te(i,s)&&(t>0&&te(l[t-1]._model,s)&&(i.controlPointPreviousX=u(i.controlPointPreviousX,s.left,s.right),i.controlPointPreviousY=u(i.controlPointPreviousY,s.top,s.bottom)),t<l.length-1&&te(l[t+1]._model,s)&&(i.controlPointNextX=u(i.controlPointNextX,s.left,s.right),i.controlPointNextY=u(i.controlPointNextY,s.top,s.bottom)))},draw:function(){var t,e=this.chart,i=this.getMeta(),n=i.data||[],a=e.chartArea,r=n.length,o=0;for(ee(this.getDataset(),e.options)&&(t=(i.dataset._model.borderWidth||0)/2,ut.canvas.clipArea(e.ctx,{left:a.left,right:a.right,top:a.top-t,bottom:a.bottom+t}),i.dataset.draw(),ut.canvas.unclipArea(e.ctx));o<r;++o)n[o].draw(a)},setHoverStyle:function(t){var e=t._model,i=t._options,n=ut.getHoverColor;t.$previousStyle={backgroundColor:e.backgroundColor,borderColor:e.borderColor,borderWidth:e.borderWidth,radius:e.radius},e.backgroundColor=Jt(i.hoverBackgroundColor,n(i.backgroundColor)),e.borderColor=Jt(i.hoverBorderColor,n(i.borderColor)),e.borderWidth=Jt(i.hoverBorderWidth,i.borderWidth),e.radius=Jt(i.hoverRadius,i.radius)}}),ne=ut.options.resolve;ot._set("polarArea",{scale:{type:"radialLinear",angleLines:{display:!1},gridLines:{circular:!0},pointLabels:{display:!1},ticks:{beginAtZero:!0}},animation:{animateRotate:!0,animateScale:!0},startAngle:-.5*Math.PI,legendCallback:function(t){var e=[];e.push('<ul class="'+t.id+'-legend">');var i=t.data,n=i.datasets,a=i.labels;if(n.length)for(var r=0;r<n[0].data.length;++r)e.push('<li><span style="background-color:'+n[0].backgroundColor[r]+'"></span>'),a[r]&&e.push(a[r]),e.push("</li>");return e.push("</ul>"),e.join("")},legend:{labels:{generateLabels:function(t){var e=t.data;return e.labels.length&&e.datasets.length?e.labels.map(function(i,n){var a=t.getDatasetMeta(0),r=e.datasets[0],o=a.data[n].custom||{},s=t.options.elements.arc;return{text:i,fillStyle:ne([o.backgroundColor,r.backgroundColor,s.backgroundColor],void 0,n),strokeStyle:ne([o.borderColor,r.borderColor,s.borderColor],void 0,n),lineWidth:ne([o.borderWidth,r.borderWidth,s.borderWidth],void 0,n),hidden:isNaN(r.data[n])||a.data[n].hidden,index:n}}):[]}},onClick:function(t,e){var i,n,a,r=e.index,o=this.chart;for(i=0,n=(o.data.datasets||[]).length;i<n;++i)(a=o.getDatasetMeta(i)).data[r].hidden=!a.data[r].hidden;o.update()}},tooltips:{callbacks:{title:function(){return""},label:function(t,e){return e.labels[t.index]+": "+t.yLabel}}}});var ae=kt.extend({dataElementType:Nt.Arc,linkScales:ut.noop,update:function(t){var e,i,n,a=this,r=a.getDataset(),o=a.getMeta(),s=a.chart.options.startAngle||0,l=a._starts=[],u=a._angles=[],d=o.data;for(a._updateRadius(),o.count=a.countVisibleElements(),e=0,i=r.data.length;e<i;e++)l[e]=s,n=a._computeAngle(e),u[e]=n,s+=n;for(e=0,i=d.length;e<i;++e)d[e]._options=a._resolveElementOptions(d[e],e),a.updateElement(d[e],e,t)},_updateRadius:function(){var t=this,e=t.chart,i=e.chartArea,n=e.options,a=Math.min(i.right-i.left,i.bottom-i.top);e.outerRadius=Math.max(a/2,0),e.innerRadius=Math.max(n.cutoutPercentage?e.outerRadius/100*n.cutoutPercentage:1,0),e.radiusLength=(e.outerRadius-e.innerRadius)/e.getVisibleDatasetCount(),t.outerRadius=e.outerRadius-e.radiusLength*t.index,t.innerRadius=t.outerRadius-e.radiusLength},updateElement:function(t,e,i){var n=this,a=n.chart,r=n.getDataset(),o=a.options,s=o.animation,l=a.scale,u=a.data.labels,d=l.xCenter,h=l.yCenter,c=o.startAngle,f=t.hidden?0:l.getDistanceFromCenterForValue(r.data[e]),g=n._starts[e],m=g+(t.hidden?0:n._angles[e]),p=s.animateScale?0:l.getDistanceFromCenterForValue(r.data[e]),v=t._options||{};ut.extend(t,{_datasetIndex:n.index,_index:e,_scale:l,_model:{backgroundColor:v.backgroundColor,borderColor:v.borderColor,borderWidth:v.borderWidth,borderAlign:v.borderAlign,x:d,y:h,innerRadius:0,outerRadius:i?p:f,startAngle:i&&s.animateRotate?c:g,endAngle:i&&s.animateRotate?c:m,label:ut.valueAtIndexOrDefault(u,e,u[e])}}),t.pivot()},countVisibleElements:function(){var t=this.getDataset(),e=this.getMeta(),i=0;return ut.each(e.data,function(e,n){isNaN(t.data[n])||e.hidden||i++}),i},setHoverStyle:function(t){var e=t._model,i=t._options,n=ut.getHoverColor,a=ut.valueOrDefault;t.$previousStyle={backgroundColor:e.backgroundColor,borderColor:e.borderColor,borderWidth:e.borderWidth},e.backgroundColor=a(i.hoverBackgroundColor,n(i.backgroundColor)),e.borderColor=a(i.hoverBorderColor,n(i.borderColor)),e.borderWidth=a(i.hoverBorderWidth,i.borderWidth)},_resolveElementOptions:function(t,e){var i,n,a,r=this.chart,o=this.getDataset(),s=t.custom||{},l=r.options.elements.arc,u={},d={chart:r,dataIndex:e,dataset:o,datasetIndex:this.index},h=["backgroundColor","borderColor","borderWidth","borderAlign","hoverBackgroundColor","hoverBorderColor","hoverBorderWidth"];for(i=0,n=h.length;i<n;++i)u[a=h[i]]=ne([s[a],o[a],l[a]],d,e);return u},_computeAngle:function(t){var e=this,i=this.getMeta().count,n=e.getDataset(),a=e.getMeta();if(isNaN(n.data[t])||a.data[t].hidden)return 0;var r={chart:e.chart,dataIndex:t,dataset:n,datasetIndex:e.index};return ne([e.chart.options.elements.arc.angle,2*Math.PI/i],r,t)}});ot._set("pie",ut.clone(ot.doughnut)),ot._set("pie",{cutoutPercentage:0});var re=Xt,oe=ut.valueOrDefault,se=ut.options.resolve;ot._set("radar",{scale:{type:"radialLinear"},elements:{line:{tension:0}}});var le=kt.extend({datasetElementType:Nt.Line,dataElementType:Nt.Point,linkScales:ut.noop,update:function(t){var e,i,n=this,a=n.getMeta(),r=a.dataset,o=a.data||[],s=n.chart.scale,l=n.getDataset();for(void 0!==l.tension&&void 0===l.lineTension&&(l.lineTension=l.tension),r._scale=s,r._datasetIndex=n.index,r._children=o,r._loop=!0,r._model=n._resolveLineOptions(r),r.pivot(),e=0,i=o.length;e<i;++e)n.updateElement(o[e],e,t);for(n.updateBezierControlPoints(),e=0,i=o.length;e<i;++e)o[e].pivot()},updateElement:function(t,e,i){var n=this,a=t.custom||{},r=n.getDataset(),o=n.chart.scale,s=o.getPointPositionForValue(e,r.data[e]),l=n._resolvePointOptions(t,e),u=n.getMeta().dataset._model,d=i?o.xCenter:s.x,h=i?o.yCenter:s.y;t._scale=o,t._options=l,t._datasetIndex=n.index,t._index=e,t._model={x:d,y:h,skip:a.skip||isNaN(d)||isNaN(h),radius:l.radius,pointStyle:l.pointStyle,rotation:l.rotation,backgroundColor:l.backgroundColor,borderColor:l.borderColor,borderWidth:l.borderWidth,tension:oe(a.tension,u?u.tension:0),hitRadius:l.hitRadius}},_resolvePointOptions:function(t,e){var i,n,a,r=this.chart,o=r.data.datasets[this.index],s=t.custom||{},l=r.options.elements.point,u={},d={chart:r,dataIndex:e,dataset:o,datasetIndex:this.index},h={backgroundColor:"pointBackgroundColor",borderColor:"pointBorderColor",borderWidth:"pointBorderWidth",hitRadius:"pointHitRadius",hoverBackgroundColor:"pointHoverBackgroundColor",hoverBorderColor:"pointHoverBorderColor",hoverBorderWidth:"pointHoverBorderWidth",hoverRadius:"pointHoverRadius",pointStyle:"pointStyle",radius:"pointRadius",rotation:"pointRotation"},c=Object.keys(h);for(i=0,n=c.length;i<n;++i)u[a=c[i]]=se([s[a],o[h[a]],o[a],l[a]],d,e);return u},_resolveLineOptions:function(t){var e,i,n,a=this.chart,r=a.data.datasets[this.index],o=t.custom||{},s=a.options.elements.line,l={},u=["backgroundColor","borderWidth","borderColor","borderCapStyle","borderDash","borderDashOffset","borderJoinStyle","fill"];for(e=0,i=u.length;e<i;++e)l[n=u[e]]=se([o[n],r[n],s[n]]);return l.tension=oe(r.lineTension,s.tension),l},updateBezierControlPoints:function(){var t,e,i,n,a=this.getMeta(),r=this.chart.chartArea,o=a.data||[];function s(t,e,i){return Math.max(Math.min(t,i),e)}for(t=0,e=o.length;t<e;++t)i=o[t]._model,n=ut.splineCurve(ut.previousItem(o,t,!0)._model,i,ut.nextItem(o,t,!0)._model,i.tension),i.controlPointPreviousX=s(n.previous.x,r.left,r.right),i.controlPointPreviousY=s(n.previous.y,r.top,r.bottom),i.controlPointNextX=s(n.next.x,r.left,r.right),i.controlPointNextY=s(n.next.y,r.top,r.bottom)},setHoverStyle:function(t){var e=t._model,i=t._options,n=ut.getHoverColor;t.$previousStyle={backgroundColor:e.backgroundColor,borderColor:e.borderColor,borderWidth:e.borderWidth,radius:e.radius},e.backgroundColor=oe(i.hoverBackgroundColor,n(i.backgroundColor)),e.borderColor=oe(i.hoverBorderColor,n(i.borderColor)),e.borderWidth=oe(i.hoverBorderWidth,i.borderWidth),e.radius=oe(i.hoverRadius,i.radius)}});ot._set("scatter",{hover:{mode:"single"},scales:{xAxes:[{id:"x-axis-1",type:"linear",position:"bottom"}],yAxes:[{id:"y-axis-1",type:"linear",position:"left"}]},showLines:!1,tooltips:{callbacks:{title:function(){return""},label:function(t){return"("+t.xLabel+", "+t.yLabel+")"}}}});var ue={bar:jt,bubble:qt,doughnut:Xt,horizontalBar:Kt,line:ie,polarArea:ae,pie:re,radar:le,scatter:ie};function de(t,e){return t.native?{x:t.x,y:t.y}:ut.getRelativePosition(t,e)}function he(t,e){var i,n,a,r,o;for(n=0,r=t.data.datasets.length;n<r;++n)if(t.isDatasetVisible(n))for(a=0,o=(i=t.getDatasetMeta(n)).data.length;a<o;++a){var s=i.data[a];s._view.skip||e(s)}}function ce(t,e){var i=[];return he(t,function(t){t.inRange(e.x,e.y)&&i.push(t)}),i}function fe(t,e,i,n){var a=Number.POSITIVE_INFINITY,r=[];return he(t,function(t){if(!i||t.inRange(e.x,e.y)){var o=t.getCenterPoint(),s=n(e,o);s<a?(r=[t],a=s):s===a&&r.push(t)}}),r}function ge(t){var e=-1!==t.indexOf("x"),i=-1!==t.indexOf("y");return function(t,n){var a=e?Math.abs(t.x-n.x):0,r=i?Math.abs(t.y-n.y):0;return Math.sqrt(Math.pow(a,2)+Math.pow(r,2))}}function me(t,e,i){var n=de(e,t);i.axis=i.axis||"x";var a=ge(i.axis),r=i.intersect?ce(t,n):fe(t,n,!1,a),o=[];return r.length?(t.data.datasets.forEach(function(e,i){if(t.isDatasetVisible(i)){var n=t.getDatasetMeta(i).data[r[0]._index];n&&!n._view.skip&&o.push(n)}}),o):[]}var pe={modes:{single:function(t,e){var i=de(e,t),n=[];return he(t,function(t){if(t.inRange(i.x,i.y))return n.push(t),n}),n.slice(0,1)},label:me,index:me,dataset:function(t,e,i){var n=de(e,t);i.axis=i.axis||"xy";var a=ge(i.axis),r=i.intersect?ce(t,n):fe(t,n,!1,a);return r.length>0&&(r=t.getDatasetMeta(r[0]._datasetIndex).data),r},"x-axis":function(t,e){return me(t,e,{intersect:!1})},point:function(t,e){return ce(t,de(e,t))},nearest:function(t,e,i){var n=de(e,t);i.axis=i.axis||"xy";var a=ge(i.axis);return fe(t,n,i.intersect,a)},x:function(t,e,i){var n=de(e,t),a=[],r=!1;return he(t,function(t){t.inXRange(n.x)&&a.push(t),t.inRange(n.x,n.y)&&(r=!0)}),i.intersect&&!r&&(a=[]),a},y:function(t,e,i){var n=de(e,t),a=[],r=!1;return he(t,function(t){t.inYRange(n.y)&&a.push(t),t.inRange(n.x,n.y)&&(r=!0)}),i.intersect&&!r&&(a=[]),a}}};function ve(t,e){return ut.where(t,function(t){return t.position===e})}function ye(t,e){t.forEach(function(t,e){return t._tmpIndex_=e,t}),t.sort(function(t,i){var n=e?i:t,a=e?t:i;return n.weight===a.weight?n._tmpIndex_-a._tmpIndex_:n.weight-a.weight}),t.forEach(function(t){delete t._tmpIndex_})}function be(t,e){ut.each(t,function(t){e[t.position]+=t.isHorizontal()?t.height:t.width})}ot._set("global",{layout:{padding:{top:0,right:0,bottom:0,left:0}}});var xe={defaults:{},addBox:function(t,e){t.boxes||(t.boxes=[]),e.fullWidth=e.fullWidth||!1,e.position=e.position||"top",e.weight=e.weight||0,t.boxes.push(e)},removeBox:function(t,e){var i=t.boxes?t.boxes.indexOf(e):-1;-1!==i&&t.boxes.splice(i,1)},configure:function(t,e,i){for(var n,a=["fullWidth","position","weight"],r=a.length,o=0;o<r;++o)n=a[o],i.hasOwnProperty(n)&&(e[n]=i[n])},update:function(t,e,i){if(t){var n=t.options.layout||{},a=ut.options.toPadding(n.padding),r=a.left,o=a.right,s=a.top,l=a.bottom,u=ve(t.boxes,"left"),d=ve(t.boxes,"right"),h=ve(t.boxes,"top"),c=ve(t.boxes,"bottom"),f=ve(t.boxes,"chartArea");ye(u,!0),ye(d,!1),ye(h,!0),ye(c,!1);var g,m=u.concat(d),p=h.concat(c),v=m.concat(p),y=e-r-o,b=i-s-l,x=(e-y/2)/m.length,_=y,k=b,w={top:s,left:r,bottom:l,right:o},M=[];ut.each(v,function(t){var e,i=t.isHorizontal();i?(e=t.update(t.fullWidth?y:_,b/2),k-=e.height):(e=t.update(x,k),_-=e.width),M.push({horizontal:i,width:e.width,box:t})}),g=function(t){var e=0,i=0,n=0,a=0;return ut.each(t,function(t){if(t.getPadding){var r=t.getPadding();e=Math.max(e,r.top),i=Math.max(i,r.left),n=Math.max(n,r.bottom),a=Math.max(a,r.right)}}),{top:e,left:i,bottom:n,right:a}}(v),ut.each(m,I),be(m,w),ut.each(p,I),be(p,w),ut.each(m,function(t){var e=ut.findNextWhere(M,function(e){return e.box===t}),i={left:0,right:0,top:w.top,bottom:w.bottom};e&&t.update(e.width,k,i)}),be(v,w={top:s,left:r,bottom:l,right:o});var S=Math.max(g.left-w.left,0);w.left+=S,w.right+=Math.max(g.right-w.right,0);var D=Math.max(g.top-w.top,0);w.top+=D,w.bottom+=Math.max(g.bottom-w.bottom,0);var C=i-w.top-w.bottom,P=e-w.left-w.right;P===_&&C===k||(ut.each(m,function(t){t.height=C}),ut.each(p,function(t){t.fullWidth||(t.width=P)}),k=C,_=P);var T=r+S,O=s+D;ut.each(u.concat(h),A),T+=_,O+=k,ut.each(d,A),ut.each(c,A),t.chartArea={left:w.left,top:w.top,right:w.left+_,bottom:w.top+k},ut.each(f,function(e){e.left=t.chartArea.left,e.top=t.chartArea.top,e.right=t.chartArea.right,e.bottom=t.chartArea.bottom,e.update(_,k)})}function I(t){var e=ut.findNextWhere(M,function(e){return e.box===t});if(e)if(e.horizontal){var i={left:Math.max(w.left,g.left),right:Math.max(w.right,g.right),top:0,bottom:0};t.update(t.fullWidth?y:_,b/2,i)}else t.update(e.width,k)}function A(t){t.isHorizontal()?(t.left=t.fullWidth?r:w.left,t.right=t.fullWidth?e-o:w.left+_,t.top=O,t.bottom=O+t.height,O=t.bottom):(t.left=T,t.right=T+t.width,t.top=w.top,t.bottom=w.top+k,T=t.right)}}};"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self&&self;function _e(){throw new Error("Dynamic requires are not currently supported by rollup-plugin-commonjs")}var ke,we=(ke=Object.freeze({default:"@keyframes chartjs-render-animation{from{opacity:.99}to{opacity:1}}.chartjs-render-monitor{animation:chartjs-render-animation 1ms}.chartjs-size-monitor,.chartjs-size-monitor-expand,.chartjs-size-monitor-shrink{position:absolute;direction:ltr;left:0;top:0;right:0;bottom:0;overflow:hidden;pointer-events:none;visibility:hidden;z-index:-1}.chartjs-size-monitor-expand>div{position:absolute;width:1000000px;height:1000000px;left:0;top:0}.chartjs-size-monitor-shrink>div{position:absolute;width:200%;height:200%;left:0;top:0}"}))&&ke.default||ke,Me="$chartjs",Se="chartjs-size-monitor",De="chartjs-render-monitor",Ce="chartjs-render-animation",Pe=["animationstart","webkitAnimationStart"],Te={touchstart:"mousedown",touchmove:"mousemove",touchend:"mouseup",pointerenter:"mouseenter",pointerdown:"mousedown",pointermove:"mousemove",pointerup:"mouseup",pointerleave:"mouseout",pointerout:"mouseout"};function Oe(t,e){var i=ut.getStyle(t,e),n=i&&i.match(/^(\d+)(\.\d+)?px$/);return n?Number(n[1]):void 0}var Ie=!!function(){var t=!1;try{var e=Object.defineProperty({},"passive",{get:function(){t=!0}});window.addEventListener("e",null,e)}catch(t){}return t}()&&{passive:!0};function Ae(t,e,i){t.addEventListener(e,i,Ie)}function Fe(t,e,i){t.removeEventListener(e,i,Ie)}function Re(t,e,i,n,a){return{type:t,chart:e,native:a||null,x:void 0!==i?i:null,y:void 0!==n?n:null}}function Le(t){var e=document.createElement("div");return e.className=t||"",e}function We(t,e,i){var n,a,r,o,s=t[Me]||(t[Me]={}),l=s.resizer=function(t){var e=Le(Se),i=Le(Se+"-expand"),n=Le(Se+"-shrink");i.appendChild(Le()),n.appendChild(Le()),e.appendChild(i),e.appendChild(n),e._reset=function(){i.scrollLeft=1e6,i.scrollTop=1e6,n.scrollLeft=1e6,n.scrollTop=1e6};var a=function(){e._reset(),t()};return Ae(i,"scroll",a.bind(i,"expand")),Ae(n,"scroll",a.bind(n,"shrink")),e}((n=function(){if(s.resizer){var n=i.options.maintainAspectRatio&&t.parentNode,a=n?n.clientWidth:0;e(Re("resize",i)),n&&n.clientWidth<a&&i.canvas&&e(Re("resize",i))}},r=!1,o=[],function(){o=Array.prototype.slice.call(arguments),a=a||this,r||(r=!0,ut.requestAnimFrame.call(window,function(){r=!1,n.apply(a,o)}))}));!function(t,e){var i=t[Me]||(t[Me]={}),n=i.renderProxy=function(t){t.animationName===Ce&&e()};ut.each(Pe,function(e){Ae(t,e,n)}),i.reflow=!!t.offsetParent,t.classList.add(De)}(t,function(){if(s.resizer){var e=t.parentNode;e&&e!==l.parentNode&&e.insertBefore(l,e.firstChild),l._reset()}})}function Ye(t){var e=t[Me]||{},i=e.resizer;delete e.resizer,function(t){var e=t[Me]||{},i=e.renderProxy;i&&(ut.each(Pe,function(e){Fe(t,e,i)}),delete e.renderProxy),t.classList.remove(De)}(t),i&&i.parentNode&&i.parentNode.removeChild(i)}var Ne={disableCSSInjection:!1,_enabled:"undefined"!=typeof window&&"undefined"!=typeof document,_ensureLoaded:function(){var t,e,i;this._loaded||(this._loaded=!0,this.disableCSSInjection||(e=we,i=(t=this)._style||document.createElement("style"),t._style||(t._style=i,e="/* Chart.js */\n"+e,i.setAttribute("type","text/css"),document.getElementsByTagName("head")[0].appendChild(i)),i.appendChild(document.createTextNode(e))))},acquireContext:function(t,e){"string"==typeof t?t=document.getElementById(t):t.length&&(t=t[0]),t&&t.canvas&&(t=t.canvas);var i=t&&t.getContext&&t.getContext("2d");return this._ensureLoaded(),i&&i.canvas===t?(function(t,e){var i=t.style,n=t.getAttribute("height"),a=t.getAttribute("width");if(t[Me]={initial:{height:n,width:a,style:{display:i.display,height:i.height,width:i.width}}},i.display=i.display||"block",null===a||""===a){var r=Oe(t,"width");void 0!==r&&(t.width=r)}if(null===n||""===n)if(""===t.style.height)t.height=t.width/(e.options.aspectRatio||2);else{var o=Oe(t,"height");void 0!==r&&(t.height=o)}}(t,e),i):null},releaseContext:function(t){var e=t.canvas;if(e[Me]){var i=e[Me].initial;["height","width"].forEach(function(t){var n=i[t];ut.isNullOrUndef(n)?e.removeAttribute(t):e.setAttribute(t,n)}),ut.each(i.style||{},function(t,i){e.style[i]=t}),e.width=e.width,delete e[Me]}},addEventListener:function(t,e,i){var n=t.canvas;if("resize"!==e){var a=i[Me]||(i[Me]={});Ae(n,e,(a.proxies||(a.proxies={}))[t.id+"_"+e]=function(e){i(function(t,e){var i=Te[t.type]||t.type,n=ut.getRelativePosition(t,e);return Re(i,e,n.x,n.y,t)}(e,t))})}else We(n,i,t)},removeEventListener:function(t,e,i){var n=t.canvas;if("resize"!==e){var a=((i[Me]||{}).proxies||{})[t.id+"_"+e];a&&Fe(n,e,a)}else Ye(n)}};ut.addEvent=Ae,ut.removeEvent=Fe;var ze=Ne._enabled?Ne:{acquireContext:function(t){return t&&t.canvas&&(t=t.canvas),t&&t.getContext("2d")||null}},Ve=ut.extend({initialize:function(){},acquireContext:function(){},releaseContext:function(){},addEventListener:function(){},removeEventListener:function(){}},ze);ot._set("global",{plugins:{}});var He={_plugins:[],_cacheId:0,register:function(t){var e=this._plugins;[].concat(t).forEach(function(t){-1===e.indexOf(t)&&e.push(t)}),this._cacheId++},unregister:function(t){var e=this._plugins;[].concat(t).forEach(function(t){var i=e.indexOf(t);-1!==i&&e.splice(i,1)}),this._cacheId++},clear:function(){this._plugins=[],this._cacheId++},count:function(){return this._plugins.length},getAll:function(){return this._plugins},notify:function(t,e,i){var n,a,r,o,s,l=this.descriptors(t),u=l.length;for(n=0;n<u;++n)if("function"==typeof(s=(r=(a=l[n]).plugin)[e])&&((o=[t].concat(i||[])).push(a.options),!1===s.apply(r,o)))return!1;return!0},descriptors:function(t){var e=t.$plugins||(t.$plugins={});if(e.id===this._cacheId)return e.descriptors;var i=[],n=[],a=t&&t.config||{},r=a.options&&a.options.plugins||{};return this._plugins.concat(a.plugins||[]).forEach(function(t){if(-1===i.indexOf(t)){var e=t.id,a=r[e];!1!==a&&(!0===a&&(a=ut.clone(ot.globalThis.plugins[e])),i.push(t),n.push({plugin:t,options:a||{}}))}}),e.descriptors=n,e.id=this._cacheId,n},_invalidate:function(t){delete t.$plugins}},Ee={constructors:{},defaults:{},registerScaleType:function(t,e,i){this.constructors[t]=e,this.defaults[t]=ut.clone(i)},getScaleConstructor:function(t){return this.constructors.hasOwnProperty(t)?this.constructors[t]:void 0},getScaleDefaults:function(t){return this.defaults.hasOwnProperty(t)?ut.merge({},[ot.scale,this.defaults[t]]):{}},updateScaleDefaults:function(t,e){this.defaults.hasOwnProperty(t)&&(this.defaults[t]=ut.extend(this.defaults[t],e))},addScalesToLayout:function(t){ut.each(t.scales,function(e){e.fullWidth=e.options.fullWidth,e.position=e.options.position,e.weight=e.options.weight,xe.addBox(t,e)})}},Be=ut.valueOrDefault;ot._set("global",{tooltips:{enabled:!0,custom:null,mode:"nearest",position:"average",intersect:!0,backgroundColor:"rgba(0,0,0,0.8)",titleFontStyle:"bold",titleSpacing:2,titleMarginBottom:6,titleFontColor:"#fff",titleAlign:"left",bodySpacing:2,bodyFontColor:"#fff",bodyAlign:"left",footerFontStyle:"bold",footerSpacing:2,footerMarginTop:6,footerFontColor:"#fff",footerAlign:"left",yPadding:6,xPadding:6,caretPadding:2,caretSize:5,cornerRadius:6,multiKeyBackground:"#fff",displayColors:!0,borderColor:"rgba(0,0,0,0)",borderWidth:0,callbacks:{beforeTitle:ut.noop,title:function(t,e){var i="",n=e.labels,a=n?n.length:0;if(t.length>0){var r=t[0];r.label?i=r.label:r.xLabel?i=r.xLabel:a>0&&r.index<a&&(i=n[r.index])}return i},afterTitle:ut.noop,beforeBody:ut.noop,beforeLabel:ut.noop,label:function(t,e){var i=e.datasets[t.datasetIndex].label||"";return i&&(i+=": "),ut.isNullOrUndef(t.value)?i+=t.yLabel:i+=t.value,i},labelColor:function(t,e){var i=e.getDatasetMeta(t.datasetIndex).data[t.index]._view;return{borderColor:i.borderColor,backgroundColor:i.backgroundColor}},labelTextColor:function(){return this._options.bodyFontColor},afterLabel:ut.noop,afterBody:ut.noop,beforeFooter:ut.noop,footer:ut.noop,afterFooter:ut.noop}}});var je={average:function(t){if(!t.length)return!1;var e,i,n=0,a=0,r=0;for(e=0,i=t.length;e<i;++e){var o=t[e];if(o&&o.hasValue()){var s=o.tooltipPosition();n+=s.x,a+=s.y,++r}}return{x:n/r,y:a/r}},nearest:function(t,e){var i,n,a,r=e.x,o=e.y,s=Number.POSITIVE_INFINITY;for(i=0,n=t.length;i<n;++i){var l=t[i];if(l&&l.hasValue()){var u=l.getCenterPoint(),d=ut.distanceBetweenPoints(e,u);d<s&&(s=d,a=l)}}if(a){var h=a.tooltipPosition();r=h.x,o=h.y}return{x:r,y:o}}};function Ue(t,e){return e&&(ut.isArray(e)?Array.prototype.push.apply(t,e):t.push(e)),t}function Ge(t){return("string"==typeof t||t instanceof String)&&t.indexOf("\n")>-1?t.split("\n"):t}function qe(t){var e=ot.global;return{xPadding:t.xPadding,yPadding:t.yPadding,xAlign:t.xAlign,yAlign:t.yAlign,bodyFontColor:t.bodyFontColor,_bodyFontFamily:Be(t.bodyFontFamily,e.defaultFontFamily),_bodyFontStyle:Be(t.bodyFontStyle,e.defaultFontStyle),_bodyAlign:t.bodyAlign,bodyFontSize:Be(t.bodyFontSize,e.defaultFontSize),bodySpacing:t.bodySpacing,titleFontColor:t.titleFontColor,_titleFontFamily:Be(t.titleFontFamily,e.defaultFontFamily),_titleFontStyle:Be(t.titleFontStyle,e.defaultFontStyle),titleFontSize:Be(t.titleFontSize,e.defaultFontSize),_titleAlign:t.titleAlign,titleSpacing:t.titleSpacing,titleMarginBottom:t.titleMarginBottom,footerFontColor:t.footerFontColor,_footerFontFamily:Be(t.footerFontFamily,e.defaultFontFamily),_footerFontStyle:Be(t.footerFontStyle,e.defaultFontStyle),footerFontSize:Be(t.footerFontSize,e.defaultFontSize),_footerAlign:t.footerAlign,footerSpacing:t.footerSpacing,footerMarginTop:t.footerMarginTop,caretSize:t.caretSize,cornerRadius:t.cornerRadius,backgroundColor:t.backgroundColor,opacity:0,legendColorBackground:t.multiKeyBackground,displayColors:t.displayColors,borderColor:t.borderColor,borderWidth:t.borderWidth}}function Ze(t,e){return"center"===e?t.x+t.width/2:"right"===e?t.x+t.width-t.xPadding:t.x+t.xPadding}function $e(t){return Ue([],Ge(t))}var Xe=gt.extend({initialize:function(){this._model=qe(this._options),this._lastActive=[]},getTitle:function(){var t=this._options.callbacks,e=t.beforeTitle.apply(this,arguments),i=t.title.apply(this,arguments),n=t.afterTitle.apply(this,arguments),a=[];return a=Ue(a,Ge(e)),a=Ue(a,Ge(i)),a=Ue(a,Ge(n))},getBeforeBody:function(){return $e(this._options.callbacks.beforeBody.apply(this,arguments))},getBody:function(t,e){var i=this,n=i._options.callbacks,a=[];return ut.each(t,function(t){var r={before:[],lines:[],after:[]};Ue(r.before,Ge(n.beforeLabel.call(i,t,e))),Ue(r.lines,n.label.call(i,t,e)),Ue(r.after,Ge(n.afterLabel.call(i,t,e))),a.push(r)}),a},getAfterBody:function(){return $e(this._options.callbacks.afterBody.apply(this,arguments))},getFooter:function(){var t=this._options.callbacks,e=t.beforeFooter.apply(this,arguments),i=t.footer.apply(this,arguments),n=t.afterFooter.apply(this,arguments),a=[];return a=Ue(a,Ge(e)),a=Ue(a,Ge(i)),a=Ue(a,Ge(n))},update:function(t){var e,i,n,a,r,o,s,l,u,d,h=this,c=h._options,f=h._model,g=h._model=qe(c),m=h._active,p=h._data,v={xAlign:f.xAlign,yAlign:f.yAlign},y={x:f.x,y:f.y},b={width:f.width,height:f.height},x={x:f.caretX,y:f.caretY};if(m.length){g.opacity=1;var _=[],k=[];x=je[c.position].call(h,m,h._eventPosition);var w=[];for(e=0,i=m.length;e<i;++e)w.push((n=m[e],a=void 0,r=void 0,o=void 0,s=void 0,l=void 0,u=void 0,d=void 0,a=n._xScale,r=n._yScale||n._scale,o=n._index,s=n._datasetIndex,l=n._chart.getDatasetMeta(s).controller,u=l._getIndexScale(),d=l._getValueScale(),{xLabel:a?a.getLabelForIndex(o,s):"",yLabel:r?r.getLabelForIndex(o,s):"",label:u?""+u.getLabelForIndex(o,s):"",value:d?""+d.getLabelForIndex(o,s):"",index:o,datasetIndex:s,x:n._model.x,y:n._model.y}));c.filter&&(w=w.filter(function(t){return c.filter(t,p)})),c.itemSort&&(w=w.sort(function(t,e){return c.itemSort(t,e,p)})),ut.each(w,function(t){_.push(c.callbacks.labelColor.call(h,t,h._chart)),k.push(c.callbacks.labelTextColor.call(h,t,h._chart))}),g.title=h.getTitle(w,p),g.beforeBody=h.getBeforeBody(w,p),g.body=h.getBody(w,p),g.afterBody=h.getAfterBody(w,p),g.footer=h.getFooter(w,p),g.x=x.x,g.y=x.y,g.caretPadding=c.caretPadding,g.labelColors=_,g.labelTextColors=k,g.dataPoints=w,b=function(t,e){var i=t._chart.ctx,n=2*e.yPadding,a=0,r=e.body,o=r.reduce(function(t,e){return t+e.before.length+e.lines.length+e.after.length},0);o+=e.beforeBody.length+e.afterBody.length;var s=e.title.length,l=e.footer.length,u=e.titleFontSize,d=e.bodyFontSize,h=e.footerFontSize;n+=s*u,n+=s?(s-1)*e.titleSpacing:0,n+=s?e.titleMarginBottom:0,n+=o*d,n+=o?(o-1)*e.bodySpacing:0,n+=l?e.footerMarginTop:0,n+=l*h,n+=l?(l-1)*e.footerSpacing:0;var c=0,f=function(t){a=Math.max(a,i.measureText(t).width+c)};return i.font=ut.fontString(u,e._titleFontStyle,e._titleFontFamily),ut.each(e.title,f),i.font=ut.fontString(d,e._bodyFontStyle,e._bodyFontFamily),ut.each(e.beforeBody.concat(e.afterBody),f),c=e.displayColors?d+2:0,ut.each(r,function(t){ut.each(t.before,f),ut.each(t.lines,f),ut.each(t.after,f)}),c=0,i.font=ut.fontString(h,e._footerFontStyle,e._footerFontFamily),ut.each(e.footer,f),{width:a+=2*e.xPadding,height:n}}(this,g),y=function(t,e,i,n){var a=t.x,r=t.y,o=t.caretSize,s=t.caretPadding,l=t.cornerRadius,u=i.xAlign,d=i.yAlign,h=o+s,c=l+s;return"right"===u?a-=e.width:"center"===u&&((a-=e.width/2)+e.width>n.width&&(a=n.width-e.width),a<0&&(a=0)),"top"===d?r+=h:r-="bottom"===d?e.height+h:e.height/2,"center"===d?"left"===u?a+=h:"right"===u&&(a-=h):"left"===u?a-=c:"right"===u&&(a+=c),{x:a,y:r}}(g,b,v=function(t,e){var i,n,a,r,o,s=t._model,l=t._chart,u=t._chart.chartArea,d="center",h="center";s.y<e.height?h="top":s.y>l.height-e.height&&(h="bottom");var c=(u.left+u.right)/2,f=(u.top+u.bottom)/2;"center"===h?(i=function(t){return t<=c},n=function(t){return t>c}):(i=function(t){return t<=e.width/2},n=function(t){return t>=l.width-e.width/2}),a=function(t){return t+e.width+s.caretSize+s.caretPadding>l.width},r=function(t){return t-e.width-s.caretSize-s.caretPadding<0},o=function(t){return t<=f?"top":"bottom"},i(s.x)?(d="left",a(s.x)&&(d="center",h=o(s.y))):n(s.x)&&(d="right",r(s.x)&&(d="center",h=o(s.y)));var g=t._options;return{xAlign:g.xAlign?g.xAlign:d,yAlign:g.yAlign?g.yAlign:h}}(this,b),h._chart)}else g.opacity=0;return g.xAlign=v.xAlign,g.yAlign=v.yAlign,g.x=y.x,g.y=y.y,g.width=b.width,g.height=b.height,g.caretX=x.x,g.caretY=x.y,h._model=g,t&&c.custom&&c.custom.call(h,g),h},drawCaret:function(t,e){var i=this._chart.ctx,n=this._view,a=this.getCaretPosition(t,e,n);i.lineTo(a.x1,a.y1),i.lineTo(a.x2,a.y2),i.lineTo(a.x3,a.y3)},getCaretPosition:function(t,e,i){var n,a,r,o,s,l,u=i.caretSize,d=i.cornerRadius,h=i.xAlign,c=i.yAlign,f=t.x,g=t.y,m=e.width,p=e.height;if("center"===c)s=g+p/2,"left"===h?(a=(n=f)-u,r=n,o=s+u,l=s-u):(a=(n=f+m)+u,r=n,o=s-u,l=s+u);else if("left"===h?(n=(a=f+d+u)-u,r=a+u):"right"===h?(n=(a=f+m-d-u)-u,r=a+u):(n=(a=i.caretX)-u,r=a+u),"top"===c)s=(o=g)-u,l=o;else{s=(o=g+p)+u,l=o;var v=r;r=n,n=v}return{x1:n,x2:a,x3:r,y1:o,y2:s,y3:l}},drawTitle:function(t,e,i){var n=e.title;if(n.length){t.x=Ze(e,e._titleAlign),i.textAlign=e._titleAlign,i.textBaseline="top";var a,r,o=e.titleFontSize,s=e.titleSpacing;for(i.fillStyle=e.titleFontColor,i.font=ut.fontString(o,e._titleFontStyle,e._titleFontFamily),a=0,r=n.length;a<r;++a)i.fillText(n[a],t.x,t.y),t.y+=o+s,a+1===n.length&&(t.y+=e.titleMarginBottom-s)}},drawBody:function(t,e,i){var n,a=e.bodyFontSize,r=e.bodySpacing,o=e._bodyAlign,s=e.body,l=e.displayColors,u=e.labelColors,d=0,h=l?Ze(e,"left"):0;i.textAlign=o,i.textBaseline="top",i.font=ut.fontString(a,e._bodyFontStyle,e._bodyFontFamily),t.x=Ze(e,o);var c=function(e){i.fillText(e,t.x+d,t.y),t.y+=a+r};i.fillStyle=e.bodyFontColor,ut.each(e.beforeBody,c),d=l&&"right"!==o?"center"===o?a/2+1:a+2:0,ut.each(s,function(r,o){n=e.labelTextColors[o],i.fillStyle=n,ut.each(r.before,c),ut.each(r.lines,function(r){l&&(i.fillStyle=e.legendColorBackground,i.fillRect(h,t.y,a,a),i.lineWidth=1,i.strokeStyle=u[o].borderColor,i.strokeRect(h,t.y,a,a),i.fillStyle=u[o].backgroundColor,i.fillRect(h+1,t.y+1,a-2,a-2),i.fillStyle=n),c(r)}),ut.each(r.after,c)}),d=0,ut.each(e.afterBody,c),t.y-=r},drawFooter:function(t,e,i){var n=e.footer;n.length&&(t.x=Ze(e,e._footerAlign),t.y+=e.footerMarginTop,i.textAlign=e._footerAlign,i.textBaseline="top",i.fillStyle=e.footerFontColor,i.font=ut.fontString(e.footerFontSize,e._footerFontStyle,e._footerFontFamily),ut.each(n,function(n){i.fillText(n,t.x,t.y),t.y+=e.footerFontSize+e.footerSpacing}))},drawBackground:function(t,e,i,n){i.fillStyle=e.backgroundColor,i.strokeStyle=e.borderColor,i.lineWidth=e.borderWidth;var a=e.xAlign,r=e.yAlign,o=t.x,s=t.y,l=n.width,u=n.height,d=e.cornerRadius;i.beginPath(),i.moveTo(o+d,s),"top"===r&&this.drawCaret(t,n),i.lineTo(o+l-d,s),i.quadraticCurveTo(o+l,s,o+l,s+d),"center"===r&&"right"===a&&this.drawCaret(t,n),i.lineTo(o+l,s+u-d),i.quadraticCurveTo(o+l,s+u,o+l-d,s+u),"bottom"===r&&this.drawCaret(t,n),i.lineTo(o+d,s+u),i.quadraticCurveTo(o,s+u,o,s+u-d),"center"===r&&"left"===a&&this.drawCaret(t,n),i.lineTo(o,s+d),i.quadraticCurveTo(o,s,o+d,s),i.closePath(),i.fill(),e.borderWidth>0&&i.stroke()},draw:function(){var t=this._chart.ctx,e=this._view;if(0!==e.opacity){var i={width:e.width,height:e.height},n={x:e.x,y:e.y},a=Math.abs(e.opacity<.001)?0:e.opacity,r=e.title.length||e.beforeBody.length||e.body.length||e.afterBody.length||e.footer.length;this._options.enabled&&r&&(t.save(),t.globalAlpha=a,this.drawBackground(n,e,t,i),n.y+=e.yPadding,this.drawTitle(n,e,t),this.drawBody(n,e,t),this.drawFooter(n,e,t),t.restore())}},handleEvent:function(t){var e,i=this,n=i._options;return i._lastActive=i._lastActive||[],"mouseout"===t.type?i._active=[]:i._active=i._chart.getElementsAtEventForMode(t,n.mode,n),(e=!ut.arrayEquals(i._active,i._lastActive))&&(i._lastActive=i._active,(n.enabled||n.custom)&&(i._eventPosition={x:t.x,y:t.y},i.update(!0),i.pivot())),e}}),Ke=je,Je=Xe;Je.positioners=Ke;var Qe=ut.valueOrDefault;function ti(){return ut.merge({},[].slice.call(arguments),{merger:function(t,e,i,n){if("xAxes"===t||"yAxes"===t){var a,r,o,s=i[t].length;for(e[t]||(e[t]=[]),a=0;a<s;++a)o=i[t][a],r=Qe(o.type,"xAxes"===t?"category":"linear"),a>=e[t].length&&e[t].push({}),!e[t][a].type||o.type&&o.type!==e[t][a].type?ut.merge(e[t][a],[Ee.getScaleDefaults(r),o]):ut.merge(e[t][a],o)}else ut._merger(t,e,i,n)}})}function ei(){return ut.merge({},[].slice.call(arguments),{merger:function(t,e,i,n){var a=e[t]||{},r=i[t];"scales"===t?e[t]=ti(a,r):"scale"===t?e[t]=ut.merge(a,[Ee.getScaleDefaults(r.type),r]):ut._merger(t,e,i,n)}})}function ii(t){return"top"===t||"bottom"===t}ot._set("global",{elements:{},events:["mousemove","mouseout","click","touchstart","touchmove"],hover:{onHover:null,mode:"nearest",intersect:!0,animationDuration:400},onClick:null,maintainAspectRatio:!0,responsive:!0,responsiveAnimationDuration:0});var ni=function(t,e){return this.construct(t,e),this};ut.extend(ni.prototype,{construct:function(t,e){var i=this;e=function(t){var e=(t=t||{}).data=t.data||{};return e.datasets=e.datasets||[],e.labels=e.labels||[],t.options=ei(ot.globalThis,ot[t.type],t.options||{}),t}(e);var n=Ve.acquireContext(t,e),a=n&&n.canvas,r=a&&a.height,o=a&&a.width;i.id=ut.uid(),i.ctx=n,i.canvas=a,i.config=e,i.width=o,i.height=r,i.aspectRatio=r?o/r:null,i.options=e.options,i._bufferedRender=!1,i.chart=i,i.controller=i,ni.instances[i.id]=i,Object.defineProperty(i,"data",{get:function(){return i.config.data},set:function(t){i.config.data=t}}),n&&a?(i.initialize(),i.update()):console.error("Failed to create chart: can't acquire context from the given item")},initialize:function(){var t=this;return He.notify(t,"beforeInit"),ut.retinaScale(t,t.options.devicePixelRatio),t.bindEvents(),t.options.responsive&&t.resize(!0),t.ensureScalesHaveIDs(),t.buildOrUpdateScales(),t.initToolTip(),He.notify(t,"afterInit"),t},clear:function(){return ut.canvas.clear(this),this},stop:function(){return vt.cancelAnimation(this),this},resize:function(t){var e=this,i=e.options,n=e.canvas,a=i.maintainAspectRatio&&e.aspectRatio||null,r=Math.max(0,Math.floor(ut.getMaximumWidth(n))),o=Math.max(0,Math.floor(a?r/a:ut.getMaximumHeight(n)));if((e.width!==r||e.height!==o)&&(n.width=e.width=r,n.height=e.height=o,n.style.width=r+"px",n.style.height=o+"px",ut.retinaScale(e,i.devicePixelRatio),!t)){var s={width:r,height:o};He.notify(e,"resize",[s]),i.onResize&&i.onResize(e,s),e.stop(),e.update({duration:i.responsiveAnimationDuration})}},ensureScalesHaveIDs:function(){var t=this.options,e=t.scales||{},i=t.scale;ut.each(e.xAxes,function(t,e){t.id=t.id||"x-axis-"+e}),ut.each(e.yAxes,function(t,e){t.id=t.id||"y-axis-"+e}),i&&(i.id=i.id||"scale")},buildOrUpdateScales:function(){var t=this,e=t.options,i=t.scales||{},n=[],a=Object.keys(i).reduce(function(t,e){return t[e]=!1,t},{});e.scales&&(n=n.concat((e.scales.xAxes||[]).map(function(t){return{options:t,dtype:"category",dposition:"bottom"}}),(e.scales.yAxes||[]).map(function(t){return{options:t,dtype:"linear",dposition:"left"}}))),e.scale&&n.push({options:e.scale,dtype:"radialLinear",isDefault:!0,dposition:"chartArea"}),ut.each(n,function(e){var n=e.options,r=n.id,o=Qe(n.type,e.dtype);ii(n.position)!==ii(e.dposition)&&(n.position=e.dposition),a[r]=!0;var s=null;if(r in i&&i[r].type===o)(s=i[r]).options=n,s.ctx=t.ctx,s.chart=t;else{var l=Ee.getScaleConstructor(o);if(!l)return;s=new l({id:r,type:o,options:n,ctx:t.ctx,chart:t}),i[s.id]=s}s.mergeTicksOptions(),e.isDefault&&(t.scale=s)}),ut.each(a,function(t,e){t||delete i[e]}),t.scales=i,Ee.addScalesToLayout(this)},buildOrUpdateControllers:function(){var t=this,e=[];return ut.each(t.data.datasets,function(i,n){var a=t.getDatasetMeta(n),r=i.type||t.config.type;if(a.type&&a.type!==r&&(t.destroyDatasetMeta(n),a=t.getDatasetMeta(n)),a.type=r,a.controller)a.controller.updateIndex(n),a.controller.linkScales();else{var o=ue[a.type];if(void 0===o)throw new Error('"'+a.type+'" is not a chart type.');a.controller=new o(t,n),e.push(a.controller)}},t),e},resetElements:function(){var t=this;ut.each(t.data.datasets,function(e,i){t.getDatasetMeta(i).controller.reset()},t)},reset:function(){this.resetElements(),this.tooltip.initialize()},update:function(t){var e,i,n=this;if(t&&"object"==typeof t||(t={duration:t,lazy:arguments[1]}),i=(e=n).options,ut.each(e.scales,function(t){xe.removeBox(e,t)}),i=ei(ot.globalThis,ot[e.config.type],i),e.options=e.config.options=i,e.ensureScalesHaveIDs(),e.buildOrUpdateScales(),e.tooltip._options=i.tooltips,e.tooltip.initialize(),He._invalidate(n),!1!==He.notify(n,"beforeUpdate")){n.tooltip._data=n.data;var a=n.buildOrUpdateControllers();ut.each(n.data.datasets,function(t,e){n.getDatasetMeta(e).controller.buildOrUpdateElements()},n),n.updateLayout(),n.options.animation&&n.options.animation.duration&&ut.each(a,function(t){t.reset()}),n.updateDatasets(),n.tooltip.initialize(),n.lastActive=[],He.notify(n,"afterUpdate"),n._bufferedRender?n._bufferedRequest={duration:t.duration,easing:t.easing,lazy:t.lazy}:n.render(t)}},updateLayout:function(){!1!==He.notify(this,"beforeLayout")&&(xe.update(this,this.width,this.height),He.notify(this,"afterScaleUpdate"),He.notify(this,"afterLayout"))},updateDatasets:function(){if(!1!==He.notify(this,"beforeDatasetsUpdate")){for(var t=0,e=this.data.datasets.length;t<e;++t)this.updateDataset(t);He.notify(this,"afterDatasetsUpdate")}},updateDataset:function(t){var e=this.getDatasetMeta(t),i={meta:e,index:t};!1!==He.notify(this,"beforeDatasetUpdate",[i])&&(e.controller.update(),He.notify(this,"afterDatasetUpdate",[i]))},render:function(t){var e=this;t&&"object"==typeof t||(t={duration:t,lazy:arguments[1]});var i=e.options.animation,n=Qe(t.duration,i&&i.duration),a=t.lazy;if(!1!==He.notify(e,"beforeRender")){var r=function(t){He.notify(e,"afterRender"),ut.callback(i&&i.onComplete,[t],e)};if(i&&n){var o=new pt({numSteps:n/16.66,easing:t.easing||i.easing,render:function(t,e){var i=ut.easing.effects[e.easing],n=e.currentStep,a=n/e.numSteps;t.draw(i(a),a,n)},onAnimationProgress:i.onProgress,onAnimationComplete:r});vt.addAnimation(e,o,n,a)}else e.draw(),r(new pt({numSteps:0,chart:e}));return e}},draw:function(t){var e=this;e.clear(),ut.isNullOrUndef(t)&&(t=1),e.transition(t),e.width<=0||e.height<=0||!1!==He.notify(e,"beforeDraw",[t])&&(ut.each(e.boxes,function(t){t.draw(e.chartArea)},e),e.drawDatasets(t),e._drawTooltip(t),He.notify(e,"afterDraw",[t]))},transition:function(t){for(var e=0,i=(this.data.datasets||[]).length;e<i;++e)this.isDatasetVisible(e)&&this.getDatasetMeta(e).controller.transition(t);this.tooltip.transition(t)},drawDatasets:function(t){var e=this;if(!1!==He.notify(e,"beforeDatasetsDraw",[t])){for(var i=(e.data.datasets||[]).length-1;i>=0;--i)e.isDatasetVisible(i)&&e.drawDataset(i,t);He.notify(e,"afterDatasetsDraw",[t])}},drawDataset:function(t,e){var i=this.getDatasetMeta(t),n={meta:i,index:t,easingValue:e};!1!==He.notify(this,"beforeDatasetDraw",[n])&&(i.controller.draw(e),He.notify(this,"afterDatasetDraw",[n]))},_drawTooltip:function(t){var e=this.tooltip,i={tooltip:e,easingValue:t};!1!==He.notify(this,"beforeTooltipDraw",[i])&&(e.draw(),He.notify(this,"afterTooltipDraw",[i]))},getElementAtEvent:function(t){return pe.modes.single(this,t)},getElementsAtEvent:function(t){return pe.modes.label(this,t,{intersect:!0})},getElementsAtXAxis:function(t){return pe.modes["x-axis"](this,t,{intersect:!0})},getElementsAtEventForMode:function(t,e,i){var n=pe.modes[e];return"function"==typeof n?n(this,t,i):[]},getDatasetAtEvent:function(t){return pe.modes.dataset(this,t,{intersect:!0})},getDatasetMeta:function(t){var e=this.data.datasets[t];e._meta||(e._meta={});var i=e._meta[this.id];return i||(i=e._meta[this.id]={type:null,data:[],dataset:null,controller:null,hidden:null,xAxisID:null,yAxisID:null}),i},getVisibleDatasetCount:function(){for(var t=0,e=0,i=this.data.datasets.length;e<i;++e)this.isDatasetVisible(e)&&t++;return t},isDatasetVisible:function(t){var e=this.getDatasetMeta(t);return"boolean"==typeof e.hidden?!e.hidden:!this.data.datasets[t].hidden},generateLegend:function(){return this.options.legendCallback(this)},destroyDatasetMeta:function(t){var e=this.id,i=this.data.datasets[t],n=i._meta&&i._meta[e];n&&(n.controller.destroy(),delete i._meta[e])},destroy:function(){var t,e,i=this,n=i.canvas;for(i.stop(),t=0,e=i.data.datasets.length;t<e;++t)i.destroyDatasetMeta(t);n&&(i.unbindEvents(),ut.canvas.clear(i),Ve.releaseContext(i.ctx),i.canvas=null,i.ctx=null),He.notify(i,"destroy"),delete ni.instances[i.id]},toBase64Image:function(){return this.canvas.toDataURL.apply(this.canvas,arguments)},initToolTip:function(){var t=this;t.tooltip=new Je({_chart:t,_chartInstance:t,_data:t.data,_options:t.options.tooltips},t)},bindEvents:function(){var t=this,e=t._listeners={},i=function(){t.eventHandler.apply(t,arguments)};ut.each(t.options.events,function(n){Ve.addEventListener(t,n,i),e[n]=i}),t.options.responsive&&(i=function(){t.resize()},Ve.addEventListener(t,"resize",i),e.resize=i)},unbindEvents:function(){var t=this,e=t._listeners;e&&(delete t._listeners,ut.each(e,function(e,i){Ve.removeEventListener(t,i,e)}))},updateHoverStyle:function(t,e,i){var n,a,r,o=i?"setHoverStyle":"removeHoverStyle";for(a=0,r=t.length;a<r;++a)(n=t[a])&&this.getDatasetMeta(n._datasetIndex).controller[o](n)},eventHandler:function(t){var e=this,i=e.tooltip;if(!1!==He.notify(e,"beforeEvent",[t])){e._bufferedRender=!0,e._bufferedRequest=null;var n=e.handleEvent(t);i&&(n=i._start?i.handleEvent(t):n|i.handleEvent(t)),He.notify(e,"afterEvent",[t]);var a=e._bufferedRequest;return a?e.render(a):n&&!e.animating&&(e.stop(),e.render({duration:e.options.hover.animationDuration,lazy:!0})),e._bufferedRender=!1,e._bufferedRequest=null,e}},handleEvent:function(t){var e,i=this,n=i.options||{},a=n.hover;return i.lastActive=i.lastActive||[],"mouseout"===t.type?i.active=[]:i.active=i.getElementsAtEventForMode(t,a.mode,a),ut.callback(n.onHover||n.hover.onHover,[t.native,i.active],i),"mouseup"!==t.type&&"click"!==t.type||n.onClick&&n.onClick.call(i,t.native,i.active),i.lastActive.length&&i.updateHoverStyle(i.lastActive,a.mode,!1),i.active.length&&a.mode&&i.updateHoverStyle(i.active,a.mode,!0),e=!ut.arrayEquals(i.active,i.lastActive),i.lastActive=i.active,e}}),ni.instances={};var ai=ni;ni.Controller=ni,ni.types={},ut.configMerge=ei,ut.scaleMerge=ti;function ri(){throw new Error("This method is not implemented: either no adapter can be found or an incomplete integration was provided.")}function oi(t){this.options=t||{}}ut.extend(oi.prototype,{formats:ri,parse:ri,format:ri,add:ri,diff:ri,startOf:ri,endOf:ri,_create:function(t){return t}}),oi.override=function(t){ut.extend(oi.prototype,t)};var si={_date:oi},li={formatters:{values:function(t){return ut.isArray(t)?t:""+t},linear:function(t,e,i){var n=i.length>3?i[2]-i[1]:i[1]-i[0];Math.abs(n)>1&&t!==Math.floor(t)&&(n=t-Math.floor(t));var a=ut.log10(Math.abs(n)),r="";if(0!==t)if(Math.max(Math.abs(i[0]),Math.abs(i[i.length-1]))<1e-4){var o=ut.log10(Math.abs(t));r=t.toExponential(Math.floor(o)-Math.floor(a))}else{var s=-1*Math.floor(a);s=Math.max(Math.min(s,20),0),r=t.toFixed(s)}else r="0";return r},logarithmic:function(t,e,i){var n=t/Math.pow(10,Math.floor(ut.log10(t)));return 0===t?"0":1===n||2===n||5===n||0===e||e===i.length-1?t.toExponential():""}}},ui=ut.valueOrDefault,di=ut.valueAtIndexOrDefault;function hi(t){var e,i,n=[];for(e=0,i=t.length;e<i;++e)n.push(t[e].label);return n}function ci(t,e,i){return ut.isArray(e)?ut.longestText(t,i,e):t.measureText(e).width}ot._set("scale",{display:!0,position:"left",offset:!1,gridLines:{display:!0,color:"rgba(0, 0, 0, 0.1)",lineWidth:1,drawBorder:!0,drawOnChartArea:!0,drawTicks:!0,tickMarkLength:10,zeroLineWidth:1,zeroLineColor:"rgba(0,0,0,0.25)",zeroLineBorderDash:[],zeroLineBorderDashOffset:0,offsetGridLines:!1,borderDash:[],borderDashOffset:0},scaleLabel:{display:!1,labelString:"",padding:{top:4,bottom:4}},ticks:{beginAtZero:!1,minRotation:0,maxRotation:50,mirror:!1,padding:0,reverse:!1,display:!0,autoSkip:!0,autoSkipPadding:0,labelOffset:0,callback:li.formatters.values,minor:{},major:{}}});var fi=gt.extend({getPadding:function(){return{left:this.paddingLeft||0,top:this.paddingTop||0,right:this.paddingRight||0,bottom:this.paddingBottom||0}},getTicks:function(){return this._ticks},mergeTicksOptions:function(){var t=this.options.ticks;for(var e in!1===t.minor&&(t.minor={display:!1}),!1===t.major&&(t.major={display:!1}),t)"major"!==e&&"minor"!==e&&(void 0===t.minor[e]&&(t.minor[e]=t[e]),void 0===t.major[e]&&(t.major[e]=t[e]))},beforeUpdate:function(){ut.callback(this.options.beforeUpdate,[this])},update:function(t,e,i){var n,a,r,o,s,l,u=this;for(u.beforeUpdate(),u.maxWidth=t,u.maxHeight=e,u.margins=ut.extend({left:0,right:0,top:0,bottom:0},i),u._maxLabelLines=0,u.longestLabelWidth=0,u.longestTextCache=u.longestTextCache||{},u.beforeSetDimensions(),u.setDimensions(),u.afterSetDimensions(),u.beforeDataLimits(),u.determineDataLimits(),u.afterDataLimits(),u.beforeBuildTicks(),s=u.buildTicks()||[],s=u.afterBuildTicks(s)||s,u.beforeTickToLabelConversion(),r=u.convertTicksToLabels(s)||u.ticks,u.afterTickToLabelConversion(),u.ticks=r,n=0,a=r.length;n<a;++n)o=r[n],(l=s[n])?l.label=o:s.push(l={label:o,major:!1});return u._ticks=s,u.beforeCalculateTickRotation(),u.calculateTickRotation(),u.afterCalculateTickRotation(),u.beforeFit(),u.fit(),u.afterFit(),u.afterUpdate(),u.minSize},afterUpdate:function(){ut.callback(this.options.afterUpdate,[this])},beforeSetDimensions:function(){ut.callback(this.options.beforeSetDimensions,[this])},setDimensions:function(){var t=this;t.isHorizontal()?(t.width=t.maxWidth,t.left=0,t.right=t.width):(t.height=t.maxHeight,t.top=0,t.bottom=t.height),t.paddingLeft=0,t.paddingTop=0,t.paddingRight=0,t.paddingBottom=0},afterSetDimensions:function(){ut.callback(this.options.afterSetDimensions,[this])},beforeDataLimits:function(){ut.callback(this.options.beforeDataLimits,[this])},determineDataLimits:ut.noop,afterDataLimits:function(){ut.callback(this.options.afterDataLimits,[this])},beforeBuildTicks:function(){ut.callback(this.options.beforeBuildTicks,[this])},buildTicks:ut.noop,afterBuildTicks:function(t){var e=this;return ut.isArray(t)&&t.length?ut.callback(e.options.afterBuildTicks,[e,t]):(e.ticks=ut.callback(e.options.afterBuildTicks,[e,e.ticks])||e.ticks,t)},beforeTickToLabelConversion:function(){ut.callback(this.options.beforeTickToLabelConversion,[this])},convertTicksToLabels:function(){var t=this.options.ticks;this.ticks=this.ticks.map(t.userCallback||t.callback,this)},afterTickToLabelConversion:function(){ut.callback(this.options.afterTickToLabelConversion,[this])},beforeCalculateTickRotation:function(){ut.callback(this.options.beforeCalculateTickRotation,[this])},calculateTickRotation:function(){var t=this,e=t.ctx,i=t.options.ticks,n=hi(t._ticks),a=ut.options._parseFont(i);e.font=a.string;var r=i.minRotation||0;if(n.length&&t.options.display&&t.isHorizontal())for(var o,s=ut.longestText(e,a.string,n,t.longestTextCache),l=s,u=t.getPixelForTick(1)-t.getPixelForTick(0)-6;l>u&&r<i.maxRotation;){var d=ut.toRadians(r);if(o=Math.cos(d),Math.sin(d)*s>t.maxHeight){r--;break}r++,l=o*s}t.labelRotation=r},afterCalculateTickRotation:function(){ut.callback(this.options.afterCalculateTickRotation,[this])},beforeFit:function(){ut.callback(this.options.beforeFit,[this])},fit:function(){var t=this,e=t.minSize={width:0,height:0},i=hi(t._ticks),n=t.options,a=n.ticks,r=n.scaleLabel,o=n.gridLines,s=t._isVisible(),l=n.position,u=t.isHorizontal(),d=ut.options._parseFont,h=d(a),c=n.gridLines.tickMarkLength;if(e.width=u?t.isFullWidth()?t.maxWidth-t.margins.left-t.margins.right:t.maxWidth:s&&o.drawTicks?c:0,e.height=u?s&&o.drawTicks?c:0:t.maxHeight,r.display&&s){var f=d(r),g=ut.options.toPadding(r.padding),m=f.lineHeight+g.height;u?e.height+=m:e.width+=m}if(a.display&&s){var p=ut.longestText(t.ctx,h.string,i,t.longestTextCache),v=ut.numberOfLabelLines(i),y=.5*h.size,b=t.options.ticks.padding;if(t._maxLabelLines=v,t.longestLabelWidth=p,u){var x=ut.toRadians(t.labelRotation),_=Math.cos(x),k=Math.sin(x)*p+h.lineHeight*v+y;e.height=Math.min(t.maxHeight,e.height+k+b),t.ctx.font=h.string;var w,M,S=ci(t.ctx,i[0],h.string),D=ci(t.ctx,i[i.length-1],h.string),C=t.getPixelForTick(0)-t.left,P=t.right-t.getPixelForTick(i.length-1);0!==t.labelRotation?(w="bottom"===l?_*S:_*y,M="bottom"===l?_*y:_*D):(w=S/2,M=D/2),t.paddingLeft=Math.max(w-C,0)+3,t.paddingRight=Math.max(M-P,0)+3}else a.mirror?p=0:p+=b+y,e.width=Math.min(t.maxWidth,e.width+p),t.paddingTop=h.size/2,t.paddingBottom=h.size/2}t.handleMargins(),t.width=e.width,t.height=e.height},handleMargins:function(){var t=this;t.margins&&(t.paddingLeft=Math.max(t.paddingLeft-t.margins.left,0),t.paddingTop=Math.max(t.paddingTop-t.margins.top,0),t.paddingRight=Math.max(t.paddingRight-t.margins.right,0),t.paddingBottom=Math.max(t.paddingBottom-t.margins.bottom,0))},afterFit:function(){ut.callback(this.options.afterFit,[this])},isHorizontal:function(){return"top"===this.options.position||"bottom"===this.options.position},isFullWidth:function(){return this.options.fullWidth},getRightValue:function(t){if(ut.isNullOrUndef(t))return NaN;if(("number"==typeof t||t instanceof Number)&&!isFinite(t))return NaN;if(t)if(this.isHorizontal()){if(void 0!==t.x)return this.getRightValue(t.x)}else if(void 0!==t.y)return this.getRightValue(t.y);return t},getLabelForIndex:ut.noop,getPixelForValue:ut.noop,getValueForPixel:ut.noop,getPixelForTick:function(t){var e=this,i=e.options.offset;if(e.isHorizontal()){var n=(e.width-(e.paddingLeft+e.paddingRight))/Math.max(e._ticks.length-(i?0:1),1),a=n*t+e.paddingLeft;i&&(a+=n/2);var r=e.left+a;return r+=e.isFullWidth()?e.margins.left:0}var o=e.height-(e.paddingTop+e.paddingBottom);return e.top+t*(o/(e._ticks.length-1))},getPixelForDecimal:function(t){var e=this;if(e.isHorizontal()){var i=(e.width-(e.paddingLeft+e.paddingRight))*t+e.paddingLeft,n=e.left+i;return n+=e.isFullWidth()?e.margins.left:0}return e.top+t*e.height},getBasePixel:function(){return this.getPixelForValue(this.getBaseValue())},getBaseValue:function(){var t=this.min,e=this.max;return this.beginAtZero?0:t<0&&e<0?e:t>0&&e>0?t:0},_autoSkip:function(t){var e,i,n=this,a=n.isHorizontal(),r=n.options.ticks.minor,o=t.length,s=!1,l=r.maxTicksLimit,u=n._tickSize()*(o-1),d=a?n.width-(n.paddingLeft+n.paddingRight):n.height-(n.paddingTop+n.PaddingBottom),h=[];for(u>d&&(s=1+Math.floor(u/d)),o>l&&(s=Math.max(s,1+Math.floor(o/l))),e=0;e<o;e++)i=t[e],s>1&&e%s>0&&delete i.label,h.push(i);return h},_tickSize:function(){var t=this,e=t.isHorizontal(),i=t.options.ticks.minor,n=ut.toRadians(t.labelRotation),a=Math.abs(Math.cos(n)),r=Math.abs(Math.sin(n)),o=i.autoSkipPadding||0,s=t.longestLabelWidth+o||0,l=ut.options._parseFont(i),u=t._maxLabelLines*l.lineHeight+o||0;return e?u*a>s*r?s/a:u/r:u*r<s*a?u/a:s/r},_isVisible:function(){var t,e,i,n=this.chart,a=this.options.display;if("auto"!==a)return!!a;for(t=0,e=n.data.datasets.length;t<e;++t)if(n.isDatasetVisible(t)&&((i=n.getDatasetMeta(t)).xAxisID===this.id||i.yAxisID===this.id))return!0;return!1},draw:function(t){var e=this,i=e.options;if(e._isVisible()){var n,a,r,o=e.chart,s=e.ctx,l=ot.globalThis.defaultFontColor,u=i.ticks.minor,d=i.ticks.major||u,h=i.gridLines,c=i.scaleLabel,f=i.position,g=0!==e.labelRotation,m=u.mirror,p=e.isHorizontal(),v=ut.options._parseFont,y=u.display&&u.autoSkip?e._autoSkip(e.getTicks()):e.getTicks(),b=ui(u.fontColor,l),x=v(u),_=x.lineHeight,k=ui(d.fontColor,l),w=v(d),M=u.padding,S=u.labelOffset,D=h.drawTicks?h.tickMarkLength:0,C=ui(c.fontColor,l),P=v(c),T=ut.options.toPadding(c.padding),O=ut.toRadians(e.labelRotation),I=[],A=h.drawBorder?di(h.lineWidth,0,0):0,F=ut._alignPixel;"top"===f?(n=F(o,e.bottom,A),a=e.bottom-D,r=n-A/2):"bottom"===f?(n=F(o,e.top,A),a=n+A/2,r=e.top+D):"left"===f?(n=F(o,e.right,A),a=e.right-D,r=n-A/2):(n=F(o,e.left,A),a=n+A/2,r=e.left+D);if(ut.each(y,function(n,s){if(!ut.isNullOrUndef(n.label)){var l,u,d,c,v,y,b,x,k,w,C,P,T,R,L,W,Y=n.label;s===e.zeroLineIndex&&i.offset===h.offsetGridLines?(l=h.zeroLineWidth,u=h.zeroLineColor,d=h.zeroLineBorderDash||[],c=h.zeroLineBorderDashOffset||0):(l=di(h.lineWidth,s),u=di(h.color,s),d=h.borderDash||[],c=h.borderDashOffset||0);var N=ut.isArray(Y)?Y.length:1,z=function(t,e,i){var n=t.getPixelForTick(e);return i&&(1===t.getTicks().length?n-=t.isHorizontal()?Math.max(n-t.left,t.right-n):Math.max(n-t.top,t.bottom-n):n-=0===e?(t.getPixelForTick(1)-n)/2:(n-t.getPixelForTick(e-1))/2),n}(e,s,h.offsetGridLines);if(p){var V=D+M;z<e.left-1e-7&&(u="rgba(0,0,0,0)"),v=b=k=C=F(o,z,l),y=a,x=r,T=e.getPixelForTick(s)+S,"top"===f?(w=F(o,t.top,A)+A/2,P=t.bottom,L=((g?1:.5)-N)*_,W=g?"left":"center",R=e.bottom-V):(w=t.top,P=F(o,t.bottom,A)-A/2,L=(g?0:.5)*_,W=g?"right":"center",R=e.top+V)}else{var H=(m?0:D)+M;z<e.top-1e-7&&(u="rgba(0,0,0,0)"),v=a,b=r,y=x=w=P=F(o,z,l),R=e.getPixelForTick(s)+S,L=(1-N)*_/2,"left"===f?(k=F(o,t.left,A)+A/2,C=t.right,W=m?"left":"right",T=e.right-H):(k=t.left,C=F(o,t.right,A)-A/2,W=m?"right":"left",T=e.left+H)}I.push({tx1:v,ty1:y,tx2:b,ty2:x,x1:k,y1:w,x2:C,y2:P,labelX:T,labelY:R,glWidth:l,glColor:u,glBorderDash:d,glBorderDashOffset:c,rotation:-1*O,label:Y,major:n.major,textOffset:L,textAlign:W})}}),ut.each(I,function(t){var e=t.glWidth,i=t.glColor;if(h.display&&e&&i&&(s.save(),s.lineWidth=e,s.strokeStyle=i,s.setLineDash&&(s.setLineDash(t.glBorderDash),s.lineDashOffset=t.glBorderDashOffset),s.beginPath(),h.drawTicks&&(s.moveTo(t.tx1,t.ty1),s.lineTo(t.tx2,t.ty2)),h.drawOnChartArea&&(s.moveTo(t.x1,t.y1),s.lineTo(t.x2,t.y2)),s.stroke(),s.restore()),u.display){s.save(),s.translate(t.labelX,t.labelY),s.rotate(t.rotation),s.font=t.major?w.string:x.string,s.fillStyle=t.major?k:b,s.textBaseline="middle",s.textAlign=t.textAlign;var n=t.label,a=t.textOffset;if(ut.isArray(n))for(var r=0;r<n.length;++r)s.fillText(""+n[r],0,a),a+=_;else s.fillText(n,0,a);s.restore()}}),c.display){var R,L,W=0,Y=P.lineHeight/2;if(p)R=e.left+(e.right-e.left)/2,L="bottom"===f?e.bottom-Y-T.bottom:e.top+Y+T.top;else{var N="left"===f;R=N?e.left+Y+T.top:e.right-Y-T.top,L=e.top+(e.bottom-e.top)/2,W=N?-.5*Math.PI:.5*Math.PI}s.save(),s.translate(R,L),s.rotate(W),s.textAlign="center",s.textBaseline="middle",s.fillStyle=C,s.font=P.string,s.fillText(c.labelString,0,0),s.restore()}if(A){var z,V,H,E,B=A,j=di(h.lineWidth,y.length-1,0);p?(z=F(o,e.left,B)-B/2,V=F(o,e.right,j)+j/2,H=E=n):(H=F(o,e.top,B)-B/2,E=F(o,e.bottom,j)+j/2,z=V=n),s.lineWidth=A,s.strokeStyle=di(h.color,0),s.beginPath(),s.moveTo(z,H),s.lineTo(V,E),s.stroke()}}}}),gi=fi.extend({getLabels:function(){var t=this.chart.data;return this.options.labels||(this.isHorizontal()?t.xLabels:t.yLabels)||t.labels},determineDataLimits:function(){var t,e=this,i=e.getLabels();e.minIndex=0,e.maxIndex=i.length-1,void 0!==e.options.ticks.min&&(t=i.indexOf(e.options.ticks.min),e.minIndex=-1!==t?t:e.minIndex),void 0!==e.options.ticks.max&&(t=i.indexOf(e.options.ticks.max),e.maxIndex=-1!==t?t:e.maxIndex),e.min=i[e.minIndex],e.max=i[e.maxIndex]},buildTicks:function(){var t=this,e=t.getLabels();t.ticks=0===t.minIndex&&t.maxIndex===e.length-1?e:e.slice(t.minIndex,t.maxIndex+1)},getLabelForIndex:function(t,e){var i=this,n=i.chart;return n.getDatasetMeta(e).controller._getValueScaleId()===i.id?i.getRightValue(n.data.datasets[e].data[t]):i.ticks[t-i.minIndex]},getPixelForValue:function(t,e){var i,n=this,a=n.options.offset,r=Math.max(n.maxIndex+1-n.minIndex-(a?0:1),1);if(null!=t&&(i=n.isHorizontal()?t.x:t.y),void 0!==i||void 0!==t&&isNaN(e)){t=i||t;var o=n.getLabels().indexOf(t);e=-1!==o?o:e}if(n.isHorizontal()){var s=n.width/r,l=s*(e-n.minIndex);return a&&(l+=s/2),n.left+l}var u=n.height/r,d=u*(e-n.minIndex);return a&&(d+=u/2),n.top+d},getPixelForTick:function(t){return this.getPixelForValue(this.ticks[t],t+this.minIndex,null)},getValueForPixel:function(t){var e=this,i=e.options.offset,n=Math.max(e._ticks.length-(i?0:1),1),a=e.isHorizontal(),r=(a?e.width:e.height)/n;return t-=a?e.left:e.top,i&&(t-=r/2),(t<=0?0:Math.round(t/r))+e.minIndex},getBasePixel:function(){return this.bottom}}),mi={position:"bottom"};gi._defaults=mi;var pi=ut.noop,vi=ut.isNullOrUndef;var yi=fi.extend({getRightValue:function(t){return"string"==typeof t?+t:fi.prototype.getRightValue.call(this,t)},handleTickRangeOptions:function(){var t=this,e=t.options.ticks;if(e.beginAtZero){var i=ut.sign(t.min),n=ut.sign(t.max);i<0&&n<0?t.max=0:i>0&&n>0&&(t.min=0)}var a=void 0!==e.min||void 0!==e.suggestedMin,r=void 0!==e.max||void 0!==e.suggestedMax;void 0!==e.min?t.min=e.min:void 0!==e.suggestedMin&&(null===t.min?t.min=e.suggestedMin:t.min=Math.min(t.min,e.suggestedMin)),void 0!==e.max?t.max=e.max:void 0!==e.suggestedMax&&(null===t.max?t.max=e.suggestedMax:t.max=Math.max(t.max,e.suggestedMax)),a!==r&&t.min>=t.max&&(a?t.max=t.min+1:t.min=t.max-1),t.min===t.max&&(t.max++,e.beginAtZero||t.min--)},getTickLimit:function(){var t,e=this.options.ticks,i=e.stepSize,n=e.maxTicksLimit;return i?t=Math.ceil(this.max/i)-Math.floor(this.min/i)+1:(t=this._computeTickLimit(),n=n||11),n&&(t=Math.min(n,t)),t},_computeTickLimit:function(){return Number.POSITIVE_INFINITY},handleDirectionalChanges:pi,buildTicks:function(){var t=this,e=t.options.ticks,i=t.getTickLimit(),n={maxTicks:i=Math.max(2,i),min:e.min,max:e.max,precision:e.precision,stepSize:ut.valueOrDefault(e.fixedStepSize,e.stepSize)},a=t.ticks=function(t,e){var i,n,a,r,o=[],s=t.stepSize,l=s||1,u=t.maxTicks-1,d=t.min,h=t.max,c=t.precision,f=e.min,g=e.max,m=ut.niceNum((g-f)/u/l)*l;if(m<1e-14&&vi(d)&&vi(h))return[f,g];(r=Math.ceil(g/m)-Math.floor(f/m))>u&&(m=ut.niceNum(r*m/u/l)*l),s||vi(c)?i=Math.pow(10,ut._decimalPlaces(m)):(i=Math.pow(10,c),m=Math.ceil(m*i)/i),n=Math.floor(f/m)*m,a=Math.ceil(g/m)*m,s&&(!vi(d)&&ut.almostWhole(d/m,m/1e3)&&(n=d),!vi(h)&&ut.almostWhole(h/m,m/1e3)&&(a=h)),r=(a-n)/m,r=ut.almostEquals(r,Math.round(r),m/1e3)?Math.round(r):Math.ceil(r),n=Math.round(n*i)/i,a=Math.round(a*i)/i,o.push(vi(d)?n:d);for(var p=1;p<r;++p)o.push(Math.round((n+p*m)*i)/i);return o.push(vi(h)?a:h),o}(n,t);t.handleDirectionalChanges(),t.max=ut.max(a),t.min=ut.min(a),e.reverse?(a.reverse(),t.start=t.max,t.end=t.min):(t.start=t.min,t.end=t.max)},convertTicksToLabels:function(){var t=this;t.ticksAsNumbers=t.ticks.slice(),t.zeroLineIndex=t.ticks.indexOf(0),fi.prototype.convertTicksToLabels.call(t)}}),bi={position:"left",ticks:{callback:li.formatters.linear}},xi=yi.extend({determineDataLimits:function(){var t=this,e=t.options,i=t.chart,n=i.data.datasets,a=t.isHorizontal();function r(e){return a?e.xAxisID===t.id:e.yAxisID===t.id}t.min=null,t.max=null;var o=e.stacked;if(void 0===o&&ut.each(n,function(t,e){if(!o){var n=i.getDatasetMeta(e);i.isDatasetVisible(e)&&r(n)&&void 0!==n.stack&&(o=!0)}}),e.stacked||o){var s={};ut.each(n,function(n,a){var o=i.getDatasetMeta(a),l=[o.type,void 0===e.stacked&&void 0===o.stack?a:"",o.stack].join(".");void 0===s[l]&&(s[l]={positiveValues:[],negativeValues:[]});var u=s[l].positiveValues,d=s[l].negativeValues;i.isDatasetVisible(a)&&r(o)&&ut.each(n.data,function(i,n){var a=+t.getRightValue(i);isNaN(a)||o.data[n].hidden||(u[n]=u[n]||0,d[n]=d[n]||0,e.relativePoints?u[n]=100:a<0?d[n]+=a:u[n]+=a)})}),ut.each(s,function(e){var i=e.positiveValues.concat(e.negativeValues),n=ut.min(i),a=ut.max(i);t.min=null===t.min?n:Math.min(t.min,n),t.max=null===t.max?a:Math.max(t.max,a)})}else ut.each(n,function(e,n){var a=i.getDatasetMeta(n);i.isDatasetVisible(n)&&r(a)&&ut.each(e.data,function(e,i){var n=+t.getRightValue(e);isNaN(n)||a.data[i].hidden||(null===t.min?t.min=n:n<t.min&&(t.min=n),null===t.max?t.max=n:n>t.max&&(t.max=n))})});t.min=isFinite(t.min)&&!isNaN(t.min)?t.min:0,t.max=isFinite(t.max)&&!isNaN(t.max)?t.max:1,this.handleTickRangeOptions()},_computeTickLimit:function(){var t;return this.isHorizontal()?Math.ceil(this.width/40):(t=ut.options._parseFont(this.options.ticks),Math.ceil(this.height/t.lineHeight))},handleDirectionalChanges:function(){this.isHorizontal()||this.ticks.reverse()},getLabelForIndex:function(t,e){return+this.getRightValue(this.chart.data.datasets[e].data[t])},getPixelForValue:function(t){var e=this,i=e.start,n=+e.getRightValue(t),a=e.end-i;return e.isHorizontal()?e.left+e.width/a*(n-i):e.bottom-e.height/a*(n-i)},getValueForPixel:function(t){var e=this,i=e.isHorizontal(),n=i?e.width:e.height,a=(i?t-e.left:e.bottom-t)/n;return e.start+(e.end-e.start)*a},getPixelForTick:function(t){return this.getPixelForValue(this.ticksAsNumbers[t])}}),_i=bi;xi._defaults=_i;var ki=ut.valueOrDefault;var wi={position:"left",ticks:{callback:li.formatters.logarithmic}};function Mi(t,e){return ut.isFinite(t)&&t>=0?t:e}var Si=fi.extend({determineDataLimits:function(){var t=this,e=t.options,i=t.chart,n=i.data.datasets,a=t.isHorizontal();function r(e){return a?e.xAxisID===t.id:e.yAxisID===t.id}t.min=null,t.max=null,t.minNotZero=null;var o=e.stacked;if(void 0===o&&ut.each(n,function(t,e){if(!o){var n=i.getDatasetMeta(e);i.isDatasetVisible(e)&&r(n)&&void 0!==n.stack&&(o=!0)}}),e.stacked||o){var s={};ut.each(n,function(n,a){var o=i.getDatasetMeta(a),l=[o.type,void 0===e.stacked&&void 0===o.stack?a:"",o.stack].join(".");i.isDatasetVisible(a)&&r(o)&&(void 0===s[l]&&(s[l]=[]),ut.each(n.data,function(e,i){var n=s[l],a=+t.getRightValue(e);isNaN(a)||o.data[i].hidden||a<0||(n[i]=n[i]||0,n[i]+=a)}))}),ut.each(s,function(e){if(e.length>0){var i=ut.min(e),n=ut.max(e);t.min=null===t.min?i:Math.min(t.min,i),t.max=null===t.max?n:Math.max(t.max,n)}})}else ut.each(n,function(e,n){var a=i.getDatasetMeta(n);i.isDatasetVisible(n)&&r(a)&&ut.each(e.data,function(e,i){var n=+t.getRightValue(e);isNaN(n)||a.data[i].hidden||n<0||(null===t.min?t.min=n:n<t.min&&(t.min=n),null===t.max?t.max=n:n>t.max&&(t.max=n),0!==n&&(null===t.minNotZero||n<t.minNotZero)&&(t.minNotZero=n))})});this.handleTickRangeOptions()},handleTickRangeOptions:function(){var t=this,e=t.options.ticks;t.min=Mi(e.min,t.min),t.max=Mi(e.max,t.max),t.min===t.max&&(0!==t.min&&null!==t.min?(t.min=Math.pow(10,Math.floor(ut.log10(t.min))-1),t.max=Math.pow(10,Math.floor(ut.log10(t.max))+1)):(t.min=1,t.max=10)),null===t.min&&(t.min=Math.pow(10,Math.floor(ut.log10(t.max))-1)),null===t.max&&(t.max=0!==t.min?Math.pow(10,Math.floor(ut.log10(t.min))+1):10),null===t.minNotZero&&(t.min>0?t.minNotZero=t.min:t.max<1?t.minNotZero=Math.pow(10,Math.floor(ut.log10(t.max))):t.minNotZero=1)},buildTicks:function(){var t=this,e=t.options.ticks,i=!t.isHorizontal(),n={min:Mi(e.min),max:Mi(e.max)},a=t.ticks=function(t,e){var i,n,a=[],r=ki(t.min,Math.pow(10,Math.floor(ut.log10(e.min)))),o=Math.floor(ut.log10(e.max)),s=Math.ceil(e.max/Math.pow(10,o));0===r?(i=Math.floor(ut.log10(e.minNotZero)),n=Math.floor(e.minNotZero/Math.pow(10,i)),a.push(r),r=n*Math.pow(10,i)):(i=Math.floor(ut.log10(r)),n=Math.floor(r/Math.pow(10,i)));var l=i<0?Math.pow(10,Math.abs(i)):1;do{a.push(r),10==++n&&(n=1,l=++i>=0?1:l),r=Math.round(n*Math.pow(10,i)*l)/l}while(i<o||i===o&&n<s);var u=ki(t.max,r);return a.push(u),a}(n,t);t.max=ut.max(a),t.min=ut.min(a),e.reverse?(i=!i,t.start=t.max,t.end=t.min):(t.start=t.min,t.end=t.max),i&&a.reverse()},convertTicksToLabels:function(){this.tickValues=this.ticks.slice(),fi.prototype.convertTicksToLabels.call(this)},getLabelForIndex:function(t,e){return+this.getRightValue(this.chart.data.datasets[e].data[t])},getPixelForTick:function(t){return this.getPixelForValue(this.tickValues[t])},_getFirstTickValue:function(t){var e=Math.floor(ut.log10(t));return Math.floor(t/Math.pow(10,e))*Math.pow(10,e)},getPixelForValue:function(t){var e,i,n,a,r,o=this,s=o.options.ticks,l=s.reverse,u=ut.log10,d=o._getFirstTickValue(o.minNotZero),h=0;return t=+o.getRightValue(t),l?(n=o.end,a=o.start,r=-1):(n=o.start,a=o.end,r=1),o.isHorizontal()?(e=o.width,i=l?o.right:o.left):(e=o.height,r*=-1,i=l?o.top:o.bottom),t!==n&&(0===n&&(e-=h=ki(s.fontSize,ot.globalThis.defaultFontSize),n=d),0!==t&&(h+=e/(u(a)-u(n))*(u(t)-u(n))),i+=r*h),i},getValueForPixel:function(t){var e,i,n,a,r=this,o=r.options.ticks,s=o.reverse,l=ut.log10,u=r._getFirstTickValue(r.minNotZero);if(s?(i=r.end,n=r.start):(i=r.start,n=r.end),r.isHorizontal()?(e=r.width,a=s?r.right-t:t-r.left):(e=r.height,a=s?t-r.top:r.bottom-t),a!==i){if(0===i){var d=ki(o.fontSize,ot.globalThis.defaultFontSize);a-=d,e-=d,i=u}a*=l(n)-l(i),a/=e,a=Math.pow(10,l(i)+a)}return a}}),Di=wi;Si._defaults=Di;var Ci=ut.valueOrDefault,Pi=ut.valueAtIndexOrDefault,Ti=ut.options.resolve,Oi={display:!0,animate:!0,position:"chartArea",angleLines:{display:!0,color:"rgba(0, 0, 0, 0.1)",lineWidth:1,borderDash:[],borderDashOffset:0},gridLines:{circular:!1},ticks:{showLabelBackdrop:!0,backdropColor:"rgba(255,255,255,0.75)",backdropPaddingY:2,backdropPaddingX:2,callback:li.formatters.linear},pointLabels:{display:!0,fontSize:10,callback:function(t){return t}}};function Ii(t){var e=t.options;return e.angleLines.display||e.pointLabels.display?t.chart.data.labels.length:0}function Ai(t){var e=t.ticks;return e.display&&t.display?Ci(e.fontSize,ot.globalThis.defaultFontSize)+2*e.backdropPaddingY:0}function Fi(t,e,i,n,a){return t===n||t===a?{start:e-i/2,end:e+i/2}:t<n||t>a?{start:e-i,end:e}:{start:e,end:e+i}}function Ri(t){return 0===t||180===t?"center":t<180?"left":"right"}function Li(t,e,i,n){var a,r,o=i.y+n/2;if(ut.isArray(e))for(a=0,r=e.length;a<r;++a)t.fillText(e[a],i.x,o),o+=n;else t.fillText(e,i.x,o)}function Wi(t,e,i){90===t||270===t?i.y-=e.h/2:(t>270||t<90)&&(i.y-=e.h)}function Yi(t){return ut.isNumber(t)?t:0}var Ni=yi.extend({setDimensions:function(){var t=this;t.width=t.maxWidth,t.height=t.maxHeight,t.paddingTop=Ai(t.options)/2,t.xCenter=Math.floor(t.width/2),t.yCenter=Math.floor((t.height-t.paddingTop)/2),t.drawingArea=Math.min(t.height-t.paddingTop,t.width)/2},determineDataLimits:function(){var t=this,e=t.chart,i=Number.POSITIVE_INFINITY,n=Number.NEGATIVE_INFINITY;ut.each(e.data.datasets,function(a,r){if(e.isDatasetVisible(r)){var o=e.getDatasetMeta(r);ut.each(a.data,function(e,a){var r=+t.getRightValue(e);isNaN(r)||o.data[a].hidden||(i=Math.min(r,i),n=Math.max(r,n))})}}),t.min=i===Number.POSITIVE_INFINITY?0:i,t.max=n===Number.NEGATIVE_INFINITY?0:n,t.handleTickRangeOptions()},_computeTickLimit:function(){return Math.ceil(this.drawingArea/Ai(this.options))},convertTicksToLabels:function(){var t=this;yi.prototype.convertTicksToLabels.call(t),t.pointLabels=t.chart.data.labels.map(t.options.pointLabels.callback,t)},getLabelForIndex:function(t,e){return+this.getRightValue(this.chart.data.datasets[e].data[t])},fit:function(){var t=this.options;t.display&&t.pointLabels.display?function(t){var e,i,n,a=ut.options._parseFont(t.options.pointLabels),r={l:0,r:t.width,t:0,b:t.height-t.paddingTop},o={};t.ctx.font=a.string,t._pointLabelSizes=[];var s,l,u,d=Ii(t);for(e=0;e<d;e++){n=t.getPointPosition(e,t.drawingArea+5),s=t.ctx,l=a.lineHeight,u=t.pointLabels[e]||"",i=ut.isArray(u)?{w:ut.longestText(s,s.font,u),h:u.length*l}:{w:s.measureText(u).width,h:l},t._pointLabelSizes[e]=i;var h=t.getIndexAngle(e),c=ut.toDegrees(h)%360,f=Fi(c,n.x,i.w,0,180),g=Fi(c,n.y,i.h,90,270);f.start<r.l&&(r.l=f.start,o.l=h),f.end>r.r&&(r.r=f.end,o.r=h),g.start<r.t&&(r.t=g.start,o.t=h),g.end>r.b&&(r.b=g.end,o.b=h)}t.setReductions(t.drawingArea,r,o)}(this):this.setCenterPoint(0,0,0,0)},setReductions:function(t,e,i){var n=this,a=e.l/Math.sin(i.l),r=Math.max(e.r-n.width,0)/Math.sin(i.r),o=-e.t/Math.cos(i.t),s=-Math.max(e.b-(n.height-n.paddingTop),0)/Math.cos(i.b);a=Yi(a),r=Yi(r),o=Yi(o),s=Yi(s),n.drawingArea=Math.min(Math.floor(t-(a+r)/2),Math.floor(t-(o+s)/2)),n.setCenterPoint(a,r,o,s)},setCenterPoint:function(t,e,i,n){var a=this,r=a.width-e-a.drawingArea,o=t+a.drawingArea,s=i+a.drawingArea,l=a.height-a.paddingTop-n-a.drawingArea;a.xCenter=Math.floor((o+r)/2+a.left),a.yCenter=Math.floor((s+l)/2+a.top+a.paddingTop)},getIndexAngle:function(t){return t*(2*Math.PI/Ii(this))+(this.chart.options&&this.chart.options.startAngle?this.chart.options.startAngle:0)*Math.PI*2/360},getDistanceFromCenterForValue:function(t){var e=this;if(null===t)return 0;var i=e.drawingArea/(e.max-e.min);return e.options.ticks.reverse?(e.max-t)*i:(t-e.min)*i},getPointPosition:function(t,e){var i=this.getIndexAngle(t)-Math.PI/2;return{x:Math.cos(i)*e+this.xCenter,y:Math.sin(i)*e+this.yCenter}},getPointPositionForValue:function(t,e){return this.getPointPosition(t,this.getDistanceFromCenterForValue(e))},getBasePosition:function(){var t=this.min,e=this.max;return this.getPointPositionForValue(0,this.beginAtZero?0:t<0&&e<0?e:t>0&&e>0?t:0)},draw:function(){var t=this,e=t.options,i=e.gridLines,n=e.ticks;if(e.display){var a=t.ctx,r=this.getIndexAngle(0),o=ut.options._parseFont(n);(e.angleLines.display||e.pointLabels.display)&&function(t){var e=t.ctx,i=t.options,n=i.angleLines,a=i.gridLines,r=i.pointLabels,o=Ci(n.lineWidth,a.lineWidth),s=Ci(n.color,a.color),l=Ai(i);e.save(),e.lineWidth=o,e.strokeStyle=s,e.setLineDash&&(e.setLineDash(Ti([n.borderDash,a.borderDash,[]])),e.lineDashOffset=Ti([n.borderDashOffset,a.borderDashOffset,0]));var u=t.getDistanceFromCenterForValue(i.ticks.reverse?t.min:t.max),d=ut.options._parseFont(r);e.font=d.string,e.textBaseline="middle";for(var h=Ii(t)-1;h>=0;h--){if(n.display&&o&&s){var c=t.getPointPosition(h,u);e.beginPath(),e.moveTo(t.xCenter,t.yCenter),e.lineTo(c.x,c.y),e.stroke()}if(r.display){var f=0===h?l/2:0,g=t.getPointPosition(h,u+f+5),m=Pi(r.fontColor,h,ot.globalThis.defaultFontColor);e.fillStyle=m;var p=t.getIndexAngle(h),v=ut.toDegrees(p);e.textAlign=Ri(v),Wi(v,t._pointLabelSizes[h],g),Li(e,t.pointLabels[h]||"",g,d.lineHeight)}}e.restore()}(t),ut.each(t.ticks,function(e,s){if(s>0||n.reverse){var l=t.getDistanceFromCenterForValue(t.ticksAsNumbers[s]);if(i.display&&0!==s&&function(t,e,i,n){var a,r=t.ctx,o=e.circular,s=Ii(t),l=Pi(e.color,n-1),u=Pi(e.lineWidth,n-1);if((o||s)&&l&&u){if(r.save(),r.strokeStyle=l,r.lineWidth=u,r.setLineDash&&(r.setLineDash(e.borderDash||[]),r.lineDashOffset=e.borderDashOffset||0),r.beginPath(),o)r.arc(t.xCenter,t.yCenter,i,0,2*Math.PI);else{a=t.getPointPosition(0,i),r.moveTo(a.x,a.y);for(var d=1;d<s;d++)a=t.getPointPosition(d,i),r.lineTo(a.x,a.y)}r.closePath(),r.stroke(),r.restore()}}(t,i,l,s),n.display){var u=Ci(n.fontColor,ot.globalThis.defaultFontColor);if(a.font=o.string,a.save(),a.translate(t.xCenter,t.yCenter),a.rotate(r),n.showLabelBackdrop){var d=a.measureText(e).width;a.fillStyle=n.backdropColor,a.fillRect(-d/2-n.backdropPaddingX,-l-o.size/2-n.backdropPaddingY,d+2*n.backdropPaddingX,o.size+2*n.backdropPaddingY)}a.textAlign="center",a.textBaseline="middle",a.fillStyle=u,a.fillText(e,0,-l),a.restore()}}})}}}),zi=Oi;Ni._defaults=zi;var Vi=ut.valueOrDefault,Hi=Number.MIN_SAFE_INTEGER||-9007199254740991,Ei=Number.MAX_SAFE_INTEGER||9007199254740991,Bi={millisecond:{common:!0,size:1,steps:[1,2,5,10,20,50,100,250,500]},second:{common:!0,size:1e3,steps:[1,2,5,10,15,30]},minute:{common:!0,size:6e4,steps:[1,2,5,10,15,30]},hour:{common:!0,size:36e5,steps:[1,2,3,6,12]},day:{common:!0,size:864e5,steps:[1,2,5]},week:{common:!1,size:6048e5,steps:[1,2,3,4]},month:{common:!0,size:2628e6,steps:[1,2,3]},quarter:{common:!1,size:7884e6,steps:[1,2,3,4]},year:{common:!0,size:3154e7}},ji=Object.keys(Bi);function Ui(t,e){return t-e}function Gi(t){var e,i,n,a={},r=[];for(e=0,i=t.length;e<i;++e)a[n=t[e]]||(a[n]=!0,r.push(n));return r}function qi(t,e,i,n){var a=function(t,e,i){for(var n,a,r,o=0,s=t.length-1;o>=0&&o<=s;){if(a=t[(n=o+s>>1)-1]||null,r=t[n],!a)return{lo:null,hi:r};if(r[e]<i)o=n+1;else{if(!(a[e]>i))return{lo:a,hi:r};s=n-1}}return{lo:r,hi:null}}(t,e,i),r=a.lo?a.hi?a.lo:t[t.length-2]:t[0],o=a.lo?a.hi?a.hi:t[t.length-1]:t[1],s=o[e]-r[e],l=s?(i-r[e])/s:0,u=(o[n]-r[n])*l;return r[n]+u}function Zi(t,e){var i=t._adapter,n=t.options.time,a=n.parser,r=a||n.format,o=e;return"function"==typeof a&&(o=a(o)),ut.isFinite(o)||(o="string"==typeof r?i.parse(o,r):i.parse(o)),null!==o?+o:(a||"function"!=typeof r||(o=r(e),ut.isFinite(o)||(o=i.parse(o))),o)}function $i(t,e){if(ut.isNullOrUndef(e))return null;var i=t.options.time,n=Zi(t,t.getRightValue(e));return null===n?n:(i.round&&(n=+t._adapter.startOf(n,i.round)),n)}function Xi(t){for(var e=ji.indexOf(t)+1,i=ji.length;e<i;++e)if(Bi[ji[e]].common)return ji[e]}function Ki(t,e,i,n){var a,r=t._adapter,o=t.options,s=o.time,l=s.unit||function(t,e,i,n){var a,r,o,s=ji.length;for(a=ji.indexOf(t);a<s-1;++a)if(o=(r=Bi[ji[a]]).steps?r.steps[r.steps.length-1]:Ei,r.common&&Math.ceil((i-e)/(o*r.size))<=n)return ji[a];return ji[s-1]}(s.minUnit,e,i,n),u=Xi(l),d=Vi(s.stepSize,s.unitStepSize),h="week"===l&&s.isoWeekday,c=o.ticks.major.enabled,f=Bi[l],g=e,m=i,p=[];for(d||(d=function(t,e,i,n){var a,r,o,s=e-t,l=Bi[i],u=l.size,d=l.steps;if(!d)return Math.ceil(s/(n*u));for(a=0,r=d.length;a<r&&(o=d[a],!(Math.ceil(s/(u*o))<=n));++a);return o}(e,i,l,n)),h&&(g=+r.startOf(g,"isoWeek",h),m=+r.startOf(m,"isoWeek",h)),g=+r.startOf(g,h?"day":l),(m=+r.startOf(m,h?"day":l))<i&&(m=+r.add(m,1,l)),a=g,c&&u&&!h&&!s.round&&(a=+r.startOf(a,u),a=+r.add(a,~~((g-a)/(f.size*d))*d,l));a<m;a=+r.add(a,d,l))p.push(+a);return p.push(+a),p}var Ji=fi.extend({initialize:function(){this.mergeTicksOptions(),fi.prototype.initialize.call(this)},update:function(){var t=this.options,e=t.time||(t.time={}),i=this._adapter=new si._date(t.adapters.date);return e.format&&console.warn("options.time.format is deprecated and replaced by options.time.parser."),ut.mergeIf(e.displayFormats,i.formats()),fi.prototype.update.apply(this,arguments)},getRightValue:function(t){return t&&void 0!==t.t&&(t=t.t),fi.prototype.getRightValue.call(this,t)},determineDataLimits:function(){var t,e,i,n,a,r,o=this,s=o.chart,l=o._adapter,u=o.options.time,d=u.unit||"day",h=Ei,c=Hi,f=[],g=[],m=[],p=s.data.labels||[];for(t=0,i=p.length;t<i;++t)m.push($i(o,p[t]));for(t=0,i=(s.data.datasets||[]).length;t<i;++t)if(s.isDatasetVisible(t))if(a=s.data.datasets[t].data,ut.isObject(a[0]))for(g[t]=[],e=0,n=a.length;e<n;++e)r=$i(o,a[e]),f.push(r),g[t][e]=r;else{for(e=0,n=m.length;e<n;++e)f.push(m[e]);g[t]=m.slice(0)}else g[t]=[];m.length&&(m=Gi(m).sort(Ui),h=Math.min(h,m[0]),c=Math.max(c,m[m.length-1])),f.length&&(f=Gi(f).sort(Ui),h=Math.min(h,f[0]),c=Math.max(c,f[f.length-1])),h=$i(o,u.min)||h,c=$i(o,u.max)||c,h=h===Ei?+l.startOf(Date.now(),d):h,c=c===Hi?+l.endOf(Date.now(),d)+1:c,o.min=Math.min(h,c),o.max=Math.max(h+1,c),o._horizontal=o.isHorizontal(),o._table=[],o._timestamps={data:f,datasets:g,labels:m}},buildTicks:function(){var t,e,i,n=this,a=n.min,r=n.max,o=n.options,s=o.time,l=[],u=[];switch(o.ticks.source){case"data":l=n._timestamps.data;break;case"labels":l=n._timestamps.labels;break;case"auto":default:l=Ki(n,a,r,n.getLabelCapacity(a))}for("ticks"===o.bounds&&l.length&&(a=l[0],r=l[l.length-1]),a=$i(n,s.min)||a,r=$i(n,s.max)||r,t=0,e=l.length;t<e;++t)(i=l[t])>=a&&i<=r&&u.push(i);return n.min=a,n.max=r,n._unit=s.unit||function(t,e,i,n,a){var r,o;for(r=ji.length-1;r>=ji.indexOf(i);r--)if(o=ji[r],Bi[o].common&&t._adapter.diff(a,n,o)>=e.length)return o;return ji[i?ji.indexOf(i):0]}(n,u,s.minUnit,n.min,n.max),n._majorUnit=Xi(n._unit),n._table=function(t,e,i,n){if("linear"===n||!t.length)return[{time:e,pos:0},{time:i,pos:1}];var a,r,o,s,l,u=[],d=[e];for(a=0,r=t.length;a<r;++a)(s=t[a])>e&&s<i&&d.push(s);for(d.push(i),a=0,r=d.length;a<r;++a)l=d[a+1],o=d[a-1],s=d[a],void 0!==o&&void 0!==l&&Math.round((l+o)/2)===s||u.push({time:s,pos:a/(r-1)});return u}(n._timestamps.data,a,r,o.distribution),n._offsets=function(t,e,i,n,a){var r,o,s=0,l=0;return a.offset&&e.length&&(a.time.min||(r=qi(t,"time",e[0],"pos"),s=1===e.length?1-r:(qi(t,"time",e[1],"pos")-r)/2),a.time.max||(o=qi(t,"time",e[e.length-1],"pos"),l=1===e.length?o:(o-qi(t,"time",e[e.length-2],"pos"))/2)),{start:s,end:l}}(n._table,u,0,0,o),o.ticks.reverse&&u.reverse(),function(t,e,i){var n,a,r,o,s=[];for(n=0,a=e.length;n<a;++n)r=e[n],o=!!i&&r===+t._adapter.startOf(r,i),s.push({value:r,major:o});return s}(n,u,n._majorUnit)},getLabelForIndex:function(t,e){var i=this,n=i._adapter,a=i.chart.data,r=i.options.time,o=a.labels&&t<a.labels.length?a.labels[t]:"",s=a.datasets[e].data[t];return ut.isObject(s)&&(o=i.getRightValue(s)),r.tooltipFormat?n.format(Zi(i,o),r.tooltipFormat):"string"==typeof o?o:n.format(Zi(i,o),r.displayFormats.datetime)},tickFormatFunction:function(t,e,i,n){var a=this._adapter,r=this.options,o=r.time.displayFormats,s=o[this._unit],l=this._majorUnit,u=o[l],d=+a.startOf(t,l),h=r.ticks.major,c=h.enabled&&l&&u&&t===d,f=a.format(t,n||(c?u:s)),g=c?h:r.ticks.minor,m=Vi(g.callback,g.userCallback);return m?m(f,e,i):f},convertTicksToLabels:function(t){var e,i,n=[];for(e=0,i=t.length;e<i;++e)n.push(this.tickFormatFunction(t[e].value,e,t));return n},getPixelForOffset:function(t){var e=this,i=e.options.ticks.reverse,n=e._horizontal?e.width:e.height,a=e._horizontal?i?e.right:e.left:i?e.bottom:e.top,r=qi(e._table,"time",t,"pos"),o=n*(e._offsets.start+r)/(e._offsets.start+1+e._offsets.end);return i?a-o:a+o},getPixelForValue:function(t,e,i){var n=null;if(void 0!==e&&void 0!==i&&(n=this._timestamps.datasets[i][e]),null===n&&(n=$i(this,t)),null!==n)return this.getPixelForOffset(n)},getPixelForTick:function(t){var e=this.getTicks();return t>=0&&t<e.length?this.getPixelForOffset(e[t].value):null},getValueForPixel:function(t){var e=this,i=e._horizontal?e.width:e.height,n=e._horizontal?e.left:e.top,a=(i?(t-n)/i:0)*(e._offsets.start+1+e._offsets.start)-e._offsets.end,r=qi(e._table,"pos",a,"time");return e._adapter._create(r)},getLabelWidth:function(t){var e=this.options.ticks,i=this.ctx.measureText(t).width,n=ut.toRadians(e.maxRotation),a=Math.cos(n),r=Math.sin(n);return i*a+Vi(e.fontSize,ot.globalThis.defaultFontSize)*r},getLabelCapacity:function(t){var e=this,i=e.options.time.displayFormats.millisecond,n=e.tickFormatFunction(t,0,[],i),a=e.getLabelWidth(n),r=e.isHorizontal()?e.width:e.height,o=Math.floor(r/a);return o>0?o:1}}),Qi={position:"bottom",distribution:"linear",bounds:"data",adapters:{},time:{parser:!1,format:!1,unit:!1,round:!1,displayFormat:!1,isoWeekday:!1,minUnit:"millisecond",displayFormats:{}},ticks:{autoSkip:!1,source:"auto",major:{enabled:!1}}};Ji._defaults=Qi;var tn,en={category:gi,linear:xi,logarithmic:Si,radialLinear:Ni,time:Ji},nn=(function(t,e){t.exports=function(){var e,i;function n(){return e.apply(null,arguments)}function a(t){return t instanceof Array||"[object Array]"===Object.prototype.toString.call(t)}function r(t){return null!=t&&"[object Object]"===Object.prototype.toString.call(t)}function o(t){return void 0===t}function s(t){return"number"==typeof t||"[object Number]"===Object.prototype.toString.call(t)}function l(t){return t instanceof Date||"[object Date]"===Object.prototype.toString.call(t)}function u(t,e){var i,n=[];for(i=0;i<t.length;++i)n.push(e(t[i],i));return n}function d(t,e){return Object.prototype.hasOwnProperty.call(t,e)}function h(t,e){for(var i in e)d(e,i)&&(t[i]=e[i]);return d(e,"toString")&&(t.toString=e.toString),d(e,"valueOf")&&(t.valueOf=e.valueOf),t}function c(t,e,i,n){return Oe(t,e,i,n,!0).utc()}function f(t){return null==t._pf&&(t._pf={empty:!1,unusedTokens:[],unusedInput:[],overflow:-2,charsLeftOver:0,nullInput:!1,invalidMonth:null,invalidFormat:!1,userInvalidated:!1,iso:!1,parsedDateParts:[],meridiem:null,rfc2822:!1,weekdayMismatch:!1}),t._pf}function g(t){if(null==t._isValid){var e=f(t),n=i.call(e.parsedDateParts,function(t){return null!=t}),a=!isNaN(t._d.getTime())&&e.overflow<0&&!e.empty&&!e.invalidMonth&&!e.invalidWeekday&&!e.weekdayMismatch&&!e.nullInput&&!e.invalidFormat&&!e.userInvalidated&&(!e.meridiem||e.meridiem&&n);if(t._strict&&(a=a&&0===e.charsLeftOver&&0===e.unusedTokens.length&&void 0===e.bigHour),null!=Object.isFrozen&&Object.isFrozen(t))return a;t._isValid=a}return t._isValid}function m(t){var e=c(NaN);return null!=t?h(f(e),t):f(e).userInvalidated=!0,e}i=Array.prototype.some?Array.prototype.some:function(t){for(var e=Object(this),i=e.length>>>0,n=0;n<i;n++)if(n in e&&t.call(this,e[n],n,e))return!0;return!1};var p=n.momentProperties=[];function v(t,e){var i,n,a;if(o(e._isAMomentObject)||(t._isAMomentObject=e._isAMomentObject),o(e._i)||(t._i=e._i),o(e._f)||(t._f=e._f),o(e._l)||(t._l=e._l),o(e._strict)||(t._strict=e._strict),o(e._tzm)||(t._tzm=e._tzm),o(e._isUTC)||(t._isUTC=e._isUTC),o(e._offset)||(t._offset=e._offset),o(e._pf)||(t._pf=f(e)),o(e._locale)||(t._locale=e._locale),p.length>0)for(i=0;i<p.length;i++)n=p[i],o(a=e[n])||(t[n]=a);return t}var y=!1;function b(t){v(this,t),this._d=new Date(null!=t._d?t._d.getTime():NaN),this.isValid()||(this._d=new Date(NaN)),!1===y&&(y=!0,n.updateOffset(this),y=!1)}function x(t){return t instanceof b||null!=t&&null!=t._isAMomentObject}function _(t){return t<0?Math.ceil(t)||0:Math.floor(t)}function k(t){var e=+t,i=0;return 0!==e&&isFinite(e)&&(i=_(e)),i}function w(t,e,i){var n,a=Math.min(t.length,e.length),r=Math.abs(t.length-e.length),o=0;for(n=0;n<a;n++)(i&&t[n]!==e[n]||!i&&k(t[n])!==k(e[n]))&&o++;return o+r}function M(t){!1===n.suppressDeprecationWarnings&&"undefined"!=typeof console&&console.warn&&console.warn("Deprecation warning: "+t)}function S(t,e){var i=!0;return h(function(){if(null!=n.deprecationHandler&&n.deprecationHandler(null,t),i){for(var a,r=[],o=0;o<arguments.length;o++){if(a="","object"==typeof arguments[o]){for(var s in a+="\n["+o+"] ",arguments[0])a+=s+": "+arguments[0][s]+", ";a=a.slice(0,-2)}else a=arguments[o];r.push(a)}M(t+"\nArguments: "+Array.prototype.slice.call(r).join("")+"\n"+(new Error).stack),i=!1}return e.apply(this,arguments)},e)}var D,C={};function P(t,e){null!=n.deprecationHandler&&n.deprecationHandler(t,e),C[t]||(M(e),C[t]=!0)}function T(t){return t instanceof Function||"[object Function]"===Object.prototype.toString.call(t)}function O(t,e){var i,n=h({},t);for(i in e)d(e,i)&&(r(t[i])&&r(e[i])?(n[i]={},h(n[i],t[i]),h(n[i],e[i])):null!=e[i]?n[i]=e[i]:delete n[i]);for(i in t)d(t,i)&&!d(e,i)&&r(t[i])&&(n[i]=h({},n[i]));return n}function I(t){null!=t&&this.set(t)}n.suppressDeprecationWarnings=!1,n.deprecationHandler=null,D=Object.keys?Object.keys:function(t){var e,i=[];for(e in t)d(t,e)&&i.push(e);return i};var A={};function F(t,e){var i=t.toLowerCase();A[i]=A[i+"s"]=A[e]=t}function R(t){return"string"==typeof t?A[t]||A[t.toLowerCase()]:void 0}function L(t){var e,i,n={};for(i in t)d(t,i)&&(e=R(i))&&(n[e]=t[i]);return n}var W={};function Y(t,e){W[t]=e}function N(t,e,i){var n=""+Math.abs(t),a=e-n.length,r=t>=0;return(r?i?"+":"":"-")+Math.pow(10,Math.max(0,a)).toString().substr(1)+n}var z=/(\[[^\[]*\])|(\\)?([Hh]mm(ss)?|Mo|MM?M?M?|Do|DDDo|DD?D?D?|ddd?d?|do?|w[o|w]?|W[o|W]?|Qo?|YYYYYY|YYYYY|YYYY|YY|gg(ggg?)?|GG(GGG?)?|e|E|a|A|hh?|HH?|kk?|mm?|ss?|S{1,9}|x|X|zz?|ZZ?|.)/g,V=/(\[[^\[]*\])|(\\)?(LTS|LT|LL?L?L?|l{1,4})/g,H={},E={};function B(t,e,i,n){var a=n;"string"==typeof n&&(a=function(){return this[n]()}),t&&(E[t]=a),e&&(E[e[0]]=function(){return N(a.apply(this,arguments),e[1],e[2])}),i&&(E[i]=function(){return this.localeData().ordinal(a.apply(this,arguments),t)})}function j(t,e){return t.isValid()?(e=U(e,t.localeData()),H[e]=H[e]||function(t){var e,i,n,a=t.match(z);for(e=0,i=a.length;e<i;e++)E[a[e]]?a[e]=E[a[e]]:a[e]=(n=a[e]).match(/\[[\s\S]/)?n.replace(/^\[|\]$/g,""):n.replace(/\\/g,"");return function(e){var n,r="";for(n=0;n<i;n++)r+=T(a[n])?a[n].call(e,t):a[n];return r}}(e),H[e](t)):t.localeData().invalidDate()}function U(t,e){var i=5;function n(t){return e.longDateFormat(t)||t}for(V.lastIndex=0;i>=0&&V.test(t);)t=t.replace(V,n),V.lastIndex=0,i-=1;return t}var G=/\d/,q=/\d\d/,Z=/\d{3}/,$=/\d{4}/,X=/[+-]?\d{6}/,K=/\d\d?/,J=/\d\d\d\d?/,Q=/\d\d\d\d\d\d?/,tt=/\d{1,3}/,et=/\d{1,4}/,it=/[+-]?\d{1,6}/,nt=/\d+/,at=/[+-]?\d+/,rt=/Z|[+-]\d\d:?\d\d/gi,ot=/Z|[+-]\d\d(?::?\d\d)?/gi,st=/[0-9]{0,256}['a-z\u00A0-\u05FF\u0700-\uD7FF\uF900-\uFDCF\uFDF0-\uFF07\uFF10-\uFFEF]{1,256}|[\u0600-\u06FF\/]{1,256}(\s*?[\u0600-\u06FF]{1,256}){1,2}/i,lt={};function ut(t,e,i){lt[t]=T(e)?e:function(t,n){return t&&i?i:e}}function dt(t,e){return d(lt,t)?lt[t](e._strict,e._locale):new RegExp(ht(t.replace("\\","").replace(/\\(\[)|\\(\])|\[([^\]\[]*)\]|\\(.)/g,function(t,e,i,n,a){return e||i||n||a})))}function ht(t){return t.replace(/[-\/\\^$*+?.()|[\]{}]/g,"\\$&")}var ct={};function ft(t,e){var i,n=e;for("string"==typeof t&&(t=[t]),s(e)&&(n=function(t,i){i[e]=k(t)}),i=0;i<t.length;i++)ct[t[i]]=n}function gt(t,e){ft(t,function(t,i,n,a){n._w=n._w||{},e(t,n._w,n,a)})}function mt(t,e,i){null!=e&&d(ct,t)&&ct[t](e,i._a,i,t)}var pt=0,vt=1,yt=2,bt=3,xt=4,_t=5,kt=6,wt=7,Mt=8;function St(t){return Dt(t)?366:365}function Dt(t){return t%4==0&&t%100!=0||t%400==0}B("Y",0,0,function(){var t=this.year();return t<=9999?""+t:"+"+t}),B(0,["YY",2],0,function(){return this.year()%100}),B(0,["YYYY",4],0,"year"),B(0,["YYYYY",5],0,"year"),B(0,["YYYYYY",6,!0],0,"year"),F("year","y"),Y("year",1),ut("Y",at),ut("YY",K,q),ut("YYYY",et,$),ut("YYYYY",it,X),ut("YYYYYY",it,X),ft(["YYYYY","YYYYYY"],pt),ft("YYYY",function(t,e){e[pt]=2===t.length?n.parseTwoDigitYear(t):k(t)}),ft("YY",function(t,e){e[pt]=n.parseTwoDigitYear(t)}),ft("Y",function(t,e){e[pt]=parseInt(t,10)}),n.parseTwoDigitYear=function(t){return k(t)+(k(t)>68?1900:2e3)};var Ct,Pt=Tt("FullYear",!0);function Tt(t,e){return function(i){return null!=i?(It(this,t,i),n.updateOffset(this,e),this):Ot(this,t)}}function Ot(t,e){return t.isValid()?t._d["get"+(t._isUTC?"UTC":"")+e]():NaN}function It(t,e,i){t.isValid()&&!isNaN(i)&&("FullYear"===e&&Dt(t.year())&&1===t.month()&&29===t.date()?t._d["set"+(t._isUTC?"UTC":"")+e](i,t.month(),At(i,t.month())):t._d["set"+(t._isUTC?"UTC":"")+e](i))}function At(t,e){if(isNaN(t)||isNaN(e))return NaN;var i,n=(e%(i=12)+i)%i;return t+=(e-n)/12,1===n?Dt(t)?29:28:31-n%7%2}Ct=Array.prototype.indexOf?Array.prototype.indexOf:function(t){var e;for(e=0;e<this.length;++e)if(this[e]===t)return e;return-1},B("M",["MM",2],"Mo",function(){return this.month()+1}),B("MMM",0,0,function(t){return this.localeData().monthsShort(this,t)}),B("MMMM",0,0,function(t){return this.localeData().months(this,t)}),F("month","M"),Y("month",8),ut("M",K),ut("MM",K,q),ut("MMM",function(t,e){return e.monthsShortRegex(t)}),ut("MMMM",function(t,e){return e.monthsRegex(t)}),ft(["M","MM"],function(t,e){e[vt]=k(t)-1}),ft(["MMM","MMMM"],function(t,e,i,n){var a=i._locale.monthsParse(t,n,i._strict);null!=a?e[vt]=a:f(i).invalidMonth=t});var Ft=/D[oD]?(\[[^\[\]]*\]|\s)+MMMM?/,Rt="January_February_March_April_May_June_July_August_September_October_November_December".split("_"),Lt="Jan_Feb_Mar_Apr_May_Jun_Jul_Aug_Sep_Oct_Nov_Dec".split("_");function Wt(t,e){var i;if(!t.isValid())return t;if("string"==typeof e)if(/^\d+$/.test(e))e=k(e);else if(!s(e=t.localeData().monthsParse(e)))return t;return i=Math.min(t.date(),At(t.year(),e)),t._d["set"+(t._isUTC?"UTC":"")+"Month"](e,i),t}function Yt(t){return null!=t?(Wt(this,t),n.updateOffset(this,!0),this):Ot(this,"Month")}var Nt=st,zt=st;function Vt(){function t(t,e){return e.length-t.length}var e,i,n=[],a=[],r=[];for(e=0;e<12;e++)i=c([2e3,e]),n.push(this.monthsShort(i,"")),a.push(this.months(i,"")),r.push(this.months(i,"")),r.push(this.monthsShort(i,""));for(n.sort(t),a.sort(t),r.sort(t),e=0;e<12;e++)n[e]=ht(n[e]),a[e]=ht(a[e]);for(e=0;e<24;e++)r[e]=ht(r[e]);this._monthsRegex=new RegExp("^("+r.join("|")+")","i"),this._monthsShortRegex=this._monthsRegex,this._monthsStrictRegex=new RegExp("^("+a.join("|")+")","i"),this._monthsShortStrictRegex=new RegExp("^("+n.join("|")+")","i")}function Ht(t){var e;if(t<100&&t>=0){var i=Array.prototype.slice.call(arguments);i[0]=t+400,e=new Date(Date.UTC.apply(null,i)),isFinite(e.getUTCFullYear())&&e.setUTCFullYear(t)}else e=new Date(Date.UTC.apply(null,arguments));return e}function Et(t,e,i){var n=7+e-i,a=(7+Ht(t,0,n).getUTCDay()-e)%7;return-a+n-1}function Bt(t,e,i,n,a){var r,o,s=(7+i-n)%7,l=Et(t,n,a),u=1+7*(e-1)+s+l;return u<=0?o=St(r=t-1)+u:u>St(t)?(r=t+1,o=u-St(t)):(r=t,o=u),{year:r,dayOfYear:o}}function jt(t,e,i){var n,a,r=Et(t.year(),e,i),o=Math.floor((t.dayOfYear()-r-1)/7)+1;return o<1?(a=t.year()-1,n=o+Ut(a,e,i)):o>Ut(t.year(),e,i)?(n=o-Ut(t.year(),e,i),a=t.year()+1):(a=t.year(),n=o),{week:n,year:a}}function Ut(t,e,i){var n=Et(t,e,i),a=Et(t+1,e,i);return(St(t)-n+a)/7}function Gt(t,e){return t.slice(e,7).concat(t.slice(0,e))}B("w",["ww",2],"wo","week"),B("W",["WW",2],"Wo","isoWeek"),F("week","w"),F("isoWeek","W"),Y("week",5),Y("isoWeek",5),ut("w",K),ut("ww",K,q),ut("W",K),ut("WW",K,q),gt(["w","ww","W","WW"],function(t,e,i,n){e[n.substr(0,1)]=k(t)}),B("d",0,"do","day"),B("dd",0,0,function(t){return this.localeData().weekdaysMin(this,t)}),B("ddd",0,0,function(t){return this.localeData().weekdaysShort(this,t)}),B("dddd",0,0,function(t){return this.localeData().weekdays(this,t)}),B("e",0,0,"weekday"),B("E",0,0,"isoWeekday"),F("day","d"),F("weekday","e"),F("isoWeekday","E"),Y("day",11),Y("weekday",11),Y("isoWeekday",11),ut("d",K),ut("e",K),ut("E",K),ut("dd",function(t,e){return e.weekdaysMinRegex(t)}),ut("ddd",function(t,e){return e.weekdaysShortRegex(t)}),ut("dddd",function(t,e){return e.weekdaysRegex(t)}),gt(["dd","ddd","dddd"],function(t,e,i,n){var a=i._locale.weekdaysParse(t,n,i._strict);null!=a?e.d=a:f(i).invalidWeekday=t}),gt(["d","e","E"],function(t,e,i,n){e[n]=k(t)});var qt="Sunday_Monday_Tuesday_Wednesday_Thursday_Friday_Saturday".split("_"),Zt="Sun_Mon_Tue_Wed_Thu_Fri_Sat".split("_"),$t="Su_Mo_Tu_We_Th_Fr_Sa".split("_"),Xt=st,Kt=st,Jt=st;function Qt(){function t(t,e){return e.length-t.length}var e,i,n,a,r,o=[],s=[],l=[],u=[];for(e=0;e<7;e++)i=c([2e3,1]).day(e),n=this.weekdaysMin(i,""),a=this.weekdaysShort(i,""),r=this.weekdays(i,""),o.push(n),s.push(a),l.push(r),u.push(n),u.push(a),u.push(r);for(o.sort(t),s.sort(t),l.sort(t),u.sort(t),e=0;e<7;e++)s[e]=ht(s[e]),l[e]=ht(l[e]),u[e]=ht(u[e]);this._weekdaysRegex=new RegExp("^("+u.join("|")+")","i"),this._weekdaysShortRegex=this._weekdaysRegex,this._weekdaysMinRegex=this._weekdaysRegex,this._weekdaysStrictRegex=new RegExp("^("+l.join("|")+")","i"),this._weekdaysShortStrictRegex=new RegExp("^("+s.join("|")+")","i"),this._weekdaysMinStrictRegex=new RegExp("^("+o.join("|")+")","i")}function te(){return this.hours()%12||12}function ee(t,e){B(t,0,0,function(){return this.localeData().meridiem(this.hours(),this.minutes(),e)})}function ie(t,e){return e._meridiemParse}B("H",["HH",2],0,"hour"),B("h",["hh",2],0,te),B("k",["kk",2],0,function(){return this.hours()||24}),B("hmm",0,0,function(){return""+te.apply(this)+N(this.minutes(),2)}),B("hmmss",0,0,function(){return""+te.apply(this)+N(this.minutes(),2)+N(this.seconds(),2)}),B("Hmm",0,0,function(){return""+this.hours()+N(this.minutes(),2)}),B("Hmmss",0,0,function(){return""+this.hours()+N(this.minutes(),2)+N(this.seconds(),2)}),ee("a",!0),ee("A",!1),F("hour","h"),Y("hour",13),ut("a",ie),ut("A",ie),ut("H",K),ut("h",K),ut("k",K),ut("HH",K,q),ut("hh",K,q),ut("kk",K,q),ut("hmm",J),ut("hmmss",Q),ut("Hmm",J),ut("Hmmss",Q),ft(["H","HH"],bt),ft(["k","kk"],function(t,e,i){var n=k(t);e[bt]=24===n?0:n}),ft(["a","A"],function(t,e,i){i._isPm=i._locale.isPM(t),i._meridiem=t}),ft(["h","hh"],function(t,e,i){e[bt]=k(t),f(i).bigHour=!0}),ft("hmm",function(t,e,i){var n=t.length-2;e[bt]=k(t.substr(0,n)),e[xt]=k(t.substr(n)),f(i).bigHour=!0}),ft("hmmss",function(t,e,i){var n=t.length-4,a=t.length-2;e[bt]=k(t.substr(0,n)),e[xt]=k(t.substr(n,2)),e[_t]=k(t.substr(a)),f(i).bigHour=!0}),ft("Hmm",function(t,e,i){var n=t.length-2;e[bt]=k(t.substr(0,n)),e[xt]=k(t.substr(n))}),ft("Hmmss",function(t,e,i){var n=t.length-4,a=t.length-2;e[bt]=k(t.substr(0,n)),e[xt]=k(t.substr(n,2)),e[_t]=k(t.substr(a))});var ne,ae=Tt("Hours",!0),re={calendar:{sameDay:"[Today at] LT",nextDay:"[Tomorrow at] LT",nextWeek:"dddd [at] LT",lastDay:"[Yesterday at] LT",lastWeek:"[Last] dddd [at] LT",sameElse:"L"},longDateFormat:{LTS:"h:mm:ss A",LT:"h:mm A",L:"MM/DD/YYYY",LL:"MMMM D, YYYY",LLL:"MMMM D, YYYY h:mm A",LLLL:"dddd, MMMM D, YYYY h:mm A"},invalidDate:"Invalid date",ordinal:"%d",dayOfMonthOrdinalParse:/\d{1,2}/,relativeTime:{future:"in %s",past:"%s ago",s:"a few seconds",ss:"%d seconds",m:"a minute",mm:"%d minutes",h:"an hour",hh:"%d hours",d:"a day",dd:"%d days",M:"a month",MM:"%d months",y:"a year",yy:"%d years"},months:Rt,monthsShort:Lt,week:{dow:0,doy:6},weekdays:qt,weekdaysMin:$t,weekdaysShort:Zt,meridiemParse:/[ap]\.?m?\.?/i},oe={},se={};function le(t){return t?t.toLowerCase().replace("_","-"):t}function ue(e){var i=null;if(!oe[e]&&t&&t.exports)try{i=ne._abbr;var n=_e;n("./locale/"+e),de(i)}catch(t){}return oe[e]}function de(t,e){var i;return t&&((i=o(e)?ce(t):he(t,e))?ne=i:"undefined"!=typeof console&&console.warn&&console.warn("Locale "+t+" not found. Did you forget to load it?")),ne._abbr}function he(t,e){if(null!==e){var i,n=re;if(e.abbr=t,null!=oe[t])P("defineLocaleOverride","use moment.updateLocale(localeName, config) to change an existing locale. moment.defineLocale(localeName, config) should only be used for creating a new locale See http://momentjs.com/guides/#/warnings/define-locale/ for more info."),n=oe[t]._config;else if(null!=e.parentLocale)if(null!=oe[e.parentLocale])n=oe[e.parentLocale]._config;else{if(null==(i=ue(e.parentLocale)))return se[e.parentLocale]||(se[e.parentLocale]=[]),se[e.parentLocale].push({name:t,config:e}),null;n=i._config}return oe[t]=new I(O(n,e)),se[t]&&se[t].forEach(function(t){he(t.name,t.config)}),de(t),oe[t]}return delete oe[t],null}function ce(t){var e;if(t&&t._locale&&t._locale._abbr&&(t=t._locale._abbr),!t)return ne;if(!a(t)){if(e=ue(t))return e;t=[t]}return function(t){for(var e,i,n,a,r=0;r<t.length;){for(a=le(t[r]).split("-"),e=a.length,i=(i=le(t[r+1]))?i.split("-"):null;e>0;){if(n=ue(a.slice(0,e).join("-")))return n;if(i&&i.length>=e&&w(a,i,!0)>=e-1)break;e--}r++}return ne}(t)}function fe(t){var e,i=t._a;return i&&-2===f(t).overflow&&(e=i[vt]<0||i[vt]>11?vt:i[yt]<1||i[yt]>At(i[pt],i[vt])?yt:i[bt]<0||i[bt]>24||24===i[bt]&&(0!==i[xt]||0!==i[_t]||0!==i[kt])?bt:i[xt]<0||i[xt]>59?xt:i[_t]<0||i[_t]>59?_t:i[kt]<0||i[kt]>999?kt:-1,f(t)._overflowDayOfYear&&(e<pt||e>yt)&&(e=yt),f(t)._overflowWeeks&&-1===e&&(e=wt),f(t)._overflowWeekday&&-1===e&&(e=Mt),f(t).overflow=e),t}function ge(t,e,i){return null!=t?t:null!=e?e:i}function me(t){var e,i,a,r,o,s=[];if(!t._d){for(a=function(t){var e=new Date(n.now());return t._useUTC?[e.getUTCFullYear(),e.getUTCMonth(),e.getUTCDate()]:[e.getFullYear(),e.getMonth(),e.getDate()]}(t),t._w&&null==t._a[yt]&&null==t._a[vt]&&function(t){var e,i,n,a,r,o,s,l;if(null!=(e=t._w).GG||null!=e.W||null!=e.E)r=1,o=4,i=ge(e.GG,t._a[pt],jt(Ie(),1,4).year),n=ge(e.W,1),((a=ge(e.E,1))<1||a>7)&&(l=!0);else{r=t._locale._week.dow,o=t._locale._week.doy;var u=jt(Ie(),r,o);i=ge(e.gg,t._a[pt],u.year),n=ge(e.w,u.week),null!=e.d?((a=e.d)<0||a>6)&&(l=!0):null!=e.e?(a=e.e+r,(e.e<0||e.e>6)&&(l=!0)):a=r}n<1||n>Ut(i,r,o)?f(t)._overflowWeeks=!0:null!=l?f(t)._overflowWeekday=!0:(s=Bt(i,n,a,r,o),t._a[pt]=s.year,t._dayOfYear=s.dayOfYear)}(t),null!=t._dayOfYear&&(o=ge(t._a[pt],a[pt]),(t._dayOfYear>St(o)||0===t._dayOfYear)&&(f(t)._overflowDayOfYear=!0),i=Ht(o,0,t._dayOfYear),t._a[vt]=i.getUTCMonth(),t._a[yt]=i.getUTCDate()),e=0;e<3&&null==t._a[e];++e)t._a[e]=s[e]=a[e];for(;e<7;e++)t._a[e]=s[e]=null==t._a[e]?2===e?1:0:t._a[e];24===t._a[bt]&&0===t._a[xt]&&0===t._a[_t]&&0===t._a[kt]&&(t._nextDay=!0,t._a[bt]=0),t._d=(t._useUTC?Ht:function(t,e,i,n,a,r,o){var s;return t<100&&t>=0?(s=new Date(t+400,e,i,n,a,r,o),isFinite(s.getFullYear())&&s.setFullYear(t)):s=new Date(t,e,i,n,a,r,o),s}).apply(null,s),r=t._useUTC?t._d.getUTCDay():t._d.getDay(),null!=t._tzm&&t._d.setUTCMinutes(t._d.getUTCMinutes()-t._tzm),t._nextDay&&(t._a[bt]=24),t._w&&void 0!==t._w.d&&t._w.d!==r&&(f(t).weekdayMismatch=!0)}}var pe=/^\s*((?:[+-]\d{6}|\d{4})-(?:\d\d-\d\d|W\d\d-\d|W\d\d|\d\d\d|\d\d))(?:(T| )(\d\d(?::\d\d(?::\d\d(?:[.,]\d+)?)?)?)([\+\-]\d\d(?::?\d\d)?|\s*Z)?)?$/,ve=/^\s*((?:[+-]\d{6}|\d{4})(?:\d\d\d\d|W\d\d\d|W\d\d|\d\d\d|\d\d))(?:(T| )(\d\d(?:\d\d(?:\d\d(?:[.,]\d+)?)?)?)([\+\-]\d\d(?::?\d\d)?|\s*Z)?)?$/,ye=/Z|[+-]\d\d(?::?\d\d)?/,be=[["YYYYYY-MM-DD",/[+-]\d{6}-\d\d-\d\d/],["YYYY-MM-DD",/\d{4}-\d\d-\d\d/],["GGGG-[W]WW-E",/\d{4}-W\d\d-\d/],["GGGG-[W]WW",/\d{4}-W\d\d/,!1],["YYYY-DDD",/\d{4}-\d{3}/],["YYYY-MM",/\d{4}-\d\d/,!1],["YYYYYYMMDD",/[+-]\d{10}/],["YYYYMMDD",/\d{8}/],["GGGG[W]WWE",/\d{4}W\d{3}/],["GGGG[W]WW",/\d{4}W\d{2}/,!1],["YYYYDDD",/\d{7}/]],xe=[["HH:mm:ss.SSSS",/\d\d:\d\d:\d\d\.\d+/],["HH:mm:ss,SSSS",/\d\d:\d\d:\d\d,\d+/],["HH:mm:ss",/\d\d:\d\d:\d\d/],["HH:mm",/\d\d:\d\d/],["HHmmss.SSSS",/\d\d\d\d\d\d\.\d+/],["HHmmss,SSSS",/\d\d\d\d\d\d,\d+/],["HHmmss",/\d\d\d\d\d\d/],["HHmm",/\d\d\d\d/],["HH",/\d\d/]],ke=/^\/?Date\((\-?\d+)/i;function we(t){var e,i,n,a,r,o,s=t._i,l=pe.exec(s)||ve.exec(s);if(l){for(f(t).iso=!0,e=0,i=be.length;e<i;e++)if(be[e][1].exec(l[1])){a=be[e][0],n=!1!==be[e][2];break}if(null==a)return void(t._isValid=!1);if(l[3]){for(e=0,i=xe.length;e<i;e++)if(xe[e][1].exec(l[3])){r=(l[2]||" ")+xe[e][0];break}if(null==r)return void(t._isValid=!1)}if(!n&&null!=r)return void(t._isValid=!1);if(l[4]){if(!ye.exec(l[4]))return void(t._isValid=!1);o="Z"}t._f=a+(r||"")+(o||""),Pe(t)}else t._isValid=!1}var Me=/^(?:(Mon|Tue|Wed|Thu|Fri|Sat|Sun),?\s)?(\d{1,2})\s(Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Oct|Nov|Dec)\s(\d{2,4})\s(\d\d):(\d\d)(?::(\d\d))?\s(?:(UT|GMT|[ECMP][SD]T)|([Zz])|([+-]\d{4}))$/;function Se(t){var e=parseInt(t,10);return e<=49?2e3+e:e<=999?1900+e:e}var De={UT:0,GMT:0,EDT:-240,EST:-300,CDT:-300,CST:-360,MDT:-360,MST:-420,PDT:-420,PST:-480};function Ce(t){var e,i,n,a,r,o,s,l=Me.exec(t._i.replace(/\([^)]*\)|[\n\t]/g," ").replace(/(\s\s+)/g," ").replace(/^\s\s*/,"").replace(/\s\s*$/,""));if(l){var u=(e=l[4],i=l[3],n=l[2],a=l[5],r=l[6],o=l[7],s=[Se(e),Lt.indexOf(i),parseInt(n,10),parseInt(a,10),parseInt(r,10)],o&&s.push(parseInt(o,10)),s);if(!function(t,e,i){if(t){var n=Zt.indexOf(t),a=new Date(e[0],e[1],e[2]).getDay();if(n!==a)return f(i).weekdayMismatch=!0,i._isValid=!1,!1}return!0}(l[1],u,t))return;t._a=u,t._tzm=function(t,e,i){if(t)return De[t];if(e)return 0;var n=parseInt(i,10),a=n%100,r=(n-a)/100;return 60*r+a}(l[8],l[9],l[10]),t._d=Ht.apply(null,t._a),t._d.setUTCMinutes(t._d.getUTCMinutes()-t._tzm),f(t).rfc2822=!0}else t._isValid=!1}function Pe(t){if(t._f!==n.ISO_8601)if(t._f!==n.RFC_2822){t._a=[],f(t).empty=!0;var e,i,a,r,o,s=""+t._i,l=s.length,u=0;for(a=U(t._f,t._locale).match(z)||[],e=0;e<a.length;e++)r=a[e],(i=(s.match(dt(r,t))||[])[0])&&((o=s.substr(0,s.indexOf(i))).length>0&&f(t).unusedInput.push(o),s=s.slice(s.indexOf(i)+i.length),u+=i.length),E[r]?(i?f(t).empty=!1:f(t).unusedTokens.push(r),mt(r,i,t)):t._strict&&!i&&f(t).unusedTokens.push(r);f(t).charsLeftOver=l-u,s.length>0&&f(t).unusedInput.push(s),t._a[bt]<=12&&!0===f(t).bigHour&&t._a[bt]>0&&(f(t).bigHour=void 0),f(t).parsedDateParts=t._a.slice(0),f(t).meridiem=t._meridiem,t._a[bt]=(d=t._locale,h=t._a[bt],null==(c=t._meridiem)?h:null!=d.meridiemHour?d.meridiemHour(h,c):null!=d.isPM?((g=d.isPM(c))&&h<12&&(h+=12),g||12!==h||(h=0),h):h),me(t),fe(t)}else Ce(t);else we(t);var d,h,c,g}function Te(t){var e=t._i,i=t._f;return t._locale=t._locale||ce(t._l),null===e||void 0===i&&""===e?m({nullInput:!0}):("string"==typeof e&&(t._i=e=t._locale.preparse(e)),x(e)?new b(fe(e)):(l(e)?t._d=e:a(i)?function(t){var e,i,n,a,r;if(0===t._f.length)return f(t).invalidFormat=!0,void(t._d=new Date(NaN));for(a=0;a<t._f.length;a++)r=0,e=v({},t),null!=t._useUTC&&(e._useUTC=t._useUTC),e._f=t._f[a],Pe(e),g(e)&&(r+=f(e).charsLeftOver,r+=10*f(e).unusedTokens.length,f(e).score=r,(null==n||r<n)&&(n=r,i=e));h(t,i||e)}(t):i?Pe(t):function(t){var e=t._i;o(e)?t._d=new Date(n.now()):l(e)?t._d=new Date(e.valueOf()):"string"==typeof e?function(t){var e=ke.exec(t._i);null===e?(we(t),!1===t._isValid&&(delete t._isValid,Ce(t),!1===t._isValid&&(delete t._isValid,n.createFromInputFallback(t)))):t._d=new Date(+e[1])}(t):a(e)?(t._a=u(e.slice(0),function(t){return parseInt(t,10)}),me(t)):r(e)?function(t){if(!t._d){var e=L(t._i);t._a=u([e.year,e.month,e.day||e.date,e.hour,e.minute,e.second,e.millisecond],function(t){return t&&parseInt(t,10)}),me(t)}}(t):s(e)?t._d=new Date(e):n.createFromInputFallback(t)}(t),g(t)||(t._d=null),t))}function Oe(t,e,i,n,o){var s,l={};return!0!==i&&!1!==i||(n=i,i=void 0),(r(t)&&function(t){if(Object.getOwnPropertyNames)return 0===Object.getOwnPropertyNames(t).length;var e;for(e in t)if(t.hasOwnProperty(e))return!1;return!0}(t)||a(t)&&0===t.length)&&(t=void 0),l._isAMomentObject=!0,l._useUTC=l._isUTC=o,l._l=i,l._i=t,l._f=e,l._strict=n,(s=new b(fe(Te(l))))._nextDay&&(s.add(1,"d"),s._nextDay=void 0),s}function Ie(t,e,i,n){return Oe(t,e,i,n,!1)}n.createFromInputFallback=S("value provided is not in a recognized RFC2822 or ISO format. moment construction falls back to js Date(), which is not reliable across all browsers and versions. Non RFC2822/ISO date formats are discouraged and will be removed in an upcoming major release. Please refer to http://momentjs.com/guides/#/warnings/js-date/ for more info.",function(t){t._d=new Date(t._i+(t._useUTC?" UTC":""))}),n.ISO_8601=function(){},n.RFC_2822=function(){};var Ae=S("moment().min is deprecated, use moment.max instead. http://momentjs.com/guides/#/warnings/min-max/",function(){var t=Ie.apply(null,arguments);return this.isValid()&&t.isValid()?t<this?this:t:m()}),Fe=S("moment().max is deprecated, use moment.min instead. http://momentjs.com/guides/#/warnings/min-max/",function(){var t=Ie.apply(null,arguments);return this.isValid()&&t.isValid()?t>this?this:t:m()});function Re(t,e){var i,n;if(1===e.length&&a(e[0])&&(e=e[0]),!e.length)return Ie();for(i=e[0],n=1;n<e.length;++n)e[n].isValid()&&!e[n][t](i)||(i=e[n]);return i}var Le=["year","quarter","month","week","day","hour","minute","second","millisecond"];function We(t){var e=L(t),i=e.year||0,n=e.quarter||0,a=e.month||0,r=e.week||e.isoWeek||0,o=e.day||0,s=e.hour||0,l=e.minute||0,u=e.second||0,d=e.millisecond||0;this._isValid=function(t){for(var e in t)if(-1===Ct.call(Le,e)||null!=t[e]&&isNaN(t[e]))return!1;for(var i=!1,n=0;n<Le.length;++n)if(t[Le[n]]){if(i)return!1;parseFloat(t[Le[n]])!==k(t[Le[n]])&&(i=!0)}return!0}(e),this._milliseconds=+d+1e3*u+6e4*l+1e3*s*60*60,this._days=+o+7*r,this._months=+a+3*n+12*i,this._data={},this._locale=ce(),this._bubble()}function Ye(t){return t instanceof We}function Ne(t){return t<0?-1*Math.round(-1*t):Math.round(t)}function ze(t,e){B(t,0,0,function(){var t=this.utcOffset(),i="+";return t<0&&(t=-t,i="-"),i+N(~~(t/60),2)+e+N(~~t%60,2)})}ze("Z",":"),ze("ZZ",""),ut("Z",ot),ut("ZZ",ot),ft(["Z","ZZ"],function(t,e,i){i._useUTC=!0,i._tzm=He(ot,t)});var Ve=/([\+\-]|\d\d)/gi;function He(t,e){var i=(e||"").match(t);if(null===i)return null;var n=i[i.length-1]||[],a=(n+"").match(Ve)||["-",0,0],r=60*a[1]+k(a[2]);return 0===r?0:"+"===a[0]?r:-r}function Ee(t,e){var i,a;return e._isUTC?(i=e.clone(),a=(x(t)||l(t)?t.valueOf():Ie(t).valueOf())-i.valueOf(),i._d.setTime(i._d.valueOf()+a),n.updateOffset(i,!1),i):Ie(t).local()}function Be(t){return 15*-Math.round(t._d.getTimezoneOffset()/15)}function je(){return!!this.isValid()&&this._isUTC&&0===this._offset}n.updateOffset=function(){};var Ue=/^(\-|\+)?(?:(\d*)[. ])?(\d+)\:(\d+)(?:\:(\d+)(\.\d*)?)?$/,Ge=/^(-|\+)?P(?:([-+]?[0-9,.]*)Y)?(?:([-+]?[0-9,.]*)M)?(?:([-+]?[0-9,.]*)W)?(?:([-+]?[0-9,.]*)D)?(?:T(?:([-+]?[0-9,.]*)H)?(?:([-+]?[0-9,.]*)M)?(?:([-+]?[0-9,.]*)S)?)?$/;function qe(t,e){var i,n,a,r,o,l,u=t,h=null;return Ye(t)?u={ms:t._milliseconds,d:t._days,M:t._months}:s(t)?(u={},e?u[e]=t:u.milliseconds=t):(h=Ue.exec(t))?(i="-"===h[1]?-1:1,u={y:0,d:k(h[yt])*i,h:k(h[bt])*i,m:k(h[xt])*i,s:k(h[_t])*i,ms:k(Ne(1e3*h[kt]))*i}):(h=Ge.exec(t))?(i="-"===h[1]?-1:1,u={y:Ze(h[2],i),M:Ze(h[3],i),w:Ze(h[4],i),d:Ze(h[5],i),h:Ze(h[6],i),m:Ze(h[7],i),s:Ze(h[8],i)}):null==u?u={}:"object"==typeof u&&("from"in u||"to"in u)&&(r=Ie(u.from),o=Ie(u.to),a=r.isValid()&&o.isValid()?(o=Ee(o,r),r.isBefore(o)?l=$e(r,o):((l=$e(o,r)).milliseconds=-l.milliseconds,l.months=-l.months),l):{milliseconds:0,months:0},(u={}).ms=a.milliseconds,u.M=a.months),n=new We(u),Ye(t)&&d(t,"_locale")&&(n._locale=t._locale),n}function Ze(t,e){var i=t&&parseFloat(t.replace(",","."));return(isNaN(i)?0:i)*e}function $e(t,e){var i={};return i.months=e.month()-t.month()+12*(e.year()-t.year()),t.clone().add(i.months,"M").isAfter(e)&&--i.months,i.milliseconds=+e-+t.clone().add(i.months,"M"),i}function Xe(t,e){return function(i,n){var a;return null===n||isNaN(+n)||(P(e,"moment()."+e+"(period, number) is deprecated. Please use moment()."+e+"(number, period). See http://momentjs.com/guides/#/warnings/add-inverted-param/ for more info."),a=i,i=n,n=a),Ke(this,qe(i="string"==typeof i?+i:i,n),t),this}}function Ke(t,e,i,a){var r=e._milliseconds,o=Ne(e._days),s=Ne(e._months);t.isValid()&&(a=null==a||a,s&&Wt(t,Ot(t,"Month")+s*i),o&&It(t,"Date",Ot(t,"Date")+o*i),r&&t._d.setTime(t._d.valueOf()+r*i),a&&n.updateOffset(t,o||s))}qe.fn=We.prototype,qe.invalid=function(){return qe(NaN)};var Je=Xe(1,"add"),Qe=Xe(-1,"subtract");function ti(t,e){var i,n,a=12*(e.year()-t.year())+(e.month()-t.month()),r=t.clone().add(a,"months");return e-r<0?(i=t.clone().add(a-1,"months"),n=(e-r)/(r-i)):(i=t.clone().add(a+1,"months"),n=(e-r)/(i-r)),-(a+n)||0}function ei(t){var e;return void 0===t?this._locale._abbr:(null!=(e=ce(t))&&(this._locale=e),this)}n.defaultFormat="YYYY-MM-DDTHH:mm:ssZ",n.defaultFormatUtc="YYYY-MM-DDTHH:mm:ss[Z]";var ii=S("moment().lang() is deprecated. Instead, use moment().localeData() to get the language configuration. Use moment().locale() to change languages.",function(t){return void 0===t?this.localeData():this.locale(t)});function ni(){return this._locale}var ai=1e3,ri=60*ai,oi=60*ri,si=3506328*oi;function li(t,e){return(t%e+e)%e}function ui(t,e,i){return t<100&&t>=0?new Date(t+400,e,i)-si:new Date(t,e,i).valueOf()}function di(t,e,i){return t<100&&t>=0?Date.UTC(t+400,e,i)-si:Date.UTC(t,e,i)}function hi(t,e){B(0,[t,t.length],0,e)}function ci(t,e,i,n,a){var r;return null==t?jt(this,n,a).year:(r=Ut(t,n,a),e>r&&(e=r),function(t,e,i,n,a){var r=Bt(t,e,i,n,a),o=Ht(r.year,0,r.dayOfYear);return this.year(o.getUTCFullYear()),this.month(o.getUTCMonth()),this.date(o.getUTCDate()),this}.call(this,t,e,i,n,a))}B(0,["gg",2],0,function(){return this.weekYear()%100}),B(0,["GG",2],0,function(){return this.isoWeekYear()%100}),hi("gggg","weekYear"),hi("ggggg","weekYear"),hi("GGGG","isoWeekYear"),hi("GGGGG","isoWeekYear"),F("weekYear","gg"),F("isoWeekYear","GG"),Y("weekYear",1),Y("isoWeekYear",1),ut("G",at),ut("g",at),ut("GG",K,q),ut("gg",K,q),ut("GGGG",et,$),ut("gggg",et,$),ut("GGGGG",it,X),ut("ggggg",it,X),gt(["gggg","ggggg","GGGG","GGGGG"],function(t,e,i,n){e[n.substr(0,2)]=k(t)}),gt(["gg","GG"],function(t,e,i,a){e[a]=n.parseTwoDigitYear(t)}),B("Q",0,"Qo","quarter"),F("quarter","Q"),Y("quarter",7),ut("Q",G),ft("Q",function(t,e){e[vt]=3*(k(t)-1)}),B("D",["DD",2],"Do","date"),F("date","D"),Y("date",9),ut("D",K),ut("DD",K,q),ut("Do",function(t,e){return t?e._dayOfMonthOrdinalParse||e._ordinalParse:e._dayOfMonthOrdinalParseLenient}),ft(["D","DD"],yt),ft("Do",function(t,e){e[yt]=k(t.match(K)[0])});var fi=Tt("Date",!0);B("DDD",["DDDD",3],"DDDo","dayOfYear"),F("dayOfYear","DDD"),Y("dayOfYear",4),ut("DDD",tt),ut("DDDD",Z),ft(["DDD","DDDD"],function(t,e,i){i._dayOfYear=k(t)}),B("m",["mm",2],0,"minute"),F("minute","m"),Y("minute",14),ut("m",K),ut("mm",K,q),ft(["m","mm"],xt);var gi=Tt("Minutes",!1);B("s",["ss",2],0,"second"),F("second","s"),Y("second",15),ut("s",K),ut("ss",K,q),ft(["s","ss"],_t);var mi,pi=Tt("Seconds",!1);for(B("S",0,0,function(){return~~(this.millisecond()/100)}),B(0,["SS",2],0,function(){return~~(this.millisecond()/10)}),B(0,["SSS",3],0,"millisecond"),B(0,["SSSS",4],0,function(){return 10*this.millisecond()}),B(0,["SSSSS",5],0,function(){return 100*this.millisecond()}),B(0,["SSSSSS",6],0,function(){return 1e3*this.millisecond()}),B(0,["SSSSSSS",7],0,function(){return 1e4*this.millisecond()}),B(0,["SSSSSSSS",8],0,function(){return 1e5*this.millisecond()}),B(0,["SSSSSSSSS",9],0,function(){return 1e6*this.millisecond()}),F("millisecond","ms"),Y("millisecond",16),ut("S",tt,G),ut("SS",tt,q),ut("SSS",tt,Z),mi="SSSS";mi.length<=9;mi+="S")ut(mi,nt);function vi(t,e){e[kt]=k(1e3*("0."+t))}for(mi="S";mi.length<=9;mi+="S")ft(mi,vi);var yi=Tt("Milliseconds",!1);B("z",0,0,"zoneAbbr"),B("zz",0,0,"zoneName");var bi=b.prototype;function xi(t){return t}bi.add=Je,bi.calendar=function(t,e){var i=t||Ie(),a=Ee(i,this).startOf("day"),r=n.calendarFormat(this,a)||"sameElse",o=e&&(T(e[r])?e[r].call(this,i):e[r]);return this.format(o||this.localeData().calendar(r,this,Ie(i)))},bi.clone=function(){return new b(this)},bi.diff=function(t,e,i){var n,a,r;if(!this.isValid())return NaN;if(!(n=Ee(t,this)).isValid())return NaN;switch(a=6e4*(n.utcOffset()-this.utcOffset()),e=R(e)){case"year":r=ti(this,n)/12;break;case"month":r=ti(this,n);break;case"quarter":r=ti(this,n)/3;break;case"second":r=(this-n)/1e3;break;case"minute":r=(this-n)/6e4;break;case"hour":r=(this-n)/36e5;break;case"day":r=(this-n-a)/864e5;break;case"week":r=(this-n-a)/6048e5;break;default:r=this-n}return i?r:_(r)},bi.endOf=function(t){var e;if(void 0===(t=R(t))||"millisecond"===t||!this.isValid())return this;var i=this._isUTC?di:ui;switch(t){case"year":e=i(this.year()+1,0,1)-1;break;case"quarter":e=i(this.year(),this.month()-this.month()%3+3,1)-1;break;case"month":e=i(this.year(),this.month()+1,1)-1;break;case"week":e=i(this.year(),this.month(),this.date()-this.weekday()+7)-1;break;case"isoWeek":e=i(this.year(),this.month(),this.date()-(this.isoWeekday()-1)+7)-1;break;case"day":case"date":e=i(this.year(),this.month(),this.date()+1)-1;break;case"hour":e=this._d.valueOf(),e+=oi-li(e+(this._isUTC?0:this.utcOffset()*ri),oi)-1;break;case"minute":e=this._d.valueOf(),e+=ri-li(e,ri)-1;break;case"second":e=this._d.valueOf(),e+=ai-li(e,ai)-1}return this._d.setTime(e),n.updateOffset(this,!0),this},bi.format=function(t){t||(t=this.isUtc()?n.defaultFormatUtc:n.defaultFormat);var e=j(this,t);return this.localeData().postformat(e)},bi.from=function(t,e){return this.isValid()&&(x(t)&&t.isValid()||Ie(t).isValid())?qe({to:this,from:t}).locale(this.locale()).humanize(!e):this.localeData().invalidDate()},bi.fromNow=function(t){return this.from(Ie(),t)},bi.to=function(t,e){return this.isValid()&&(x(t)&&t.isValid()||Ie(t).isValid())?qe({from:this,to:t}).locale(this.locale()).humanize(!e):this.localeData().invalidDate()},bi.toNow=function(t){return this.to(Ie(),t)},bi.get=function(t){return T(this[t=R(t)])?this[t]():this},bi.invalidAt=function(){return f(this).overflow},bi.isAfter=function(t,e){var i=x(t)?t:Ie(t);return!(!this.isValid()||!i.isValid())&&("millisecond"===(e=R(e)||"millisecond")?this.valueOf()>i.valueOf():i.valueOf()<this.clone().startOf(e).valueOf())},bi.isBefore=function(t,e){var i=x(t)?t:Ie(t);return!(!this.isValid()||!i.isValid())&&("millisecond"===(e=R(e)||"millisecond")?this.valueOf()<i.valueOf():this.clone().endOf(e).valueOf()<i.valueOf())},bi.isBetween=function(t,e,i,n){var a=x(t)?t:Ie(t),r=x(e)?e:Ie(e);return!!(this.isValid()&&a.isValid()&&r.isValid())&&(("("===(n=n||"()")[0]?this.isAfter(a,i):!this.isBefore(a,i))&&(")"===n[1]?this.isBefore(r,i):!this.isAfter(r,i)))},bi.isSame=function(t,e){var i,n=x(t)?t:Ie(t);return!(!this.isValid()||!n.isValid())&&("millisecond"===(e=R(e)||"millisecond")?this.valueOf()===n.valueOf():(i=n.valueOf(),this.clone().startOf(e).valueOf()<=i&&i<=this.clone().endOf(e).valueOf()))},bi.isSameOrAfter=function(t,e){return this.isSame(t,e)||this.isAfter(t,e)},bi.isSameOrBefore=function(t,e){return this.isSame(t,e)||this.isBefore(t,e)},bi.isValid=function(){return g(this)},bi.lang=ii,bi.locale=ei,bi.localeData=ni,bi.max=Fe,bi.min=Ae,bi.parsingFlags=function(){return h({},f(this))},bi.set=function(t,e){if("object"==typeof t)for(var i=function(t){var e=[];for(var i in t)e.push({unit:i,priority:W[i]});return e.sort(function(t,e){return t.priority-e.priority}),e}(t=L(t)),n=0;n<i.length;n++)this[i[n].unit](t[i[n].unit]);else if(T(this[t=R(t)]))return this[t](e);return this},bi.startOf=function(t){var e;if(void 0===(t=R(t))||"millisecond"===t||!this.isValid())return this;var i=this._isUTC?di:ui;switch(t){case"year":e=i(this.year(),0,1);break;case"quarter":e=i(this.year(),this.month()-this.month()%3,1);break;case"month":e=i(this.year(),this.month(),1);break;case"week":e=i(this.year(),this.month(),this.date()-this.weekday());break;case"isoWeek":e=i(this.year(),this.month(),this.date()-(this.isoWeekday()-1));break;case"day":case"date":e=i(this.year(),this.month(),this.date());break;case"hour":e=this._d.valueOf(),e-=li(e+(this._isUTC?0:this.utcOffset()*ri),oi);break;case"minute":e=this._d.valueOf(),e-=li(e,ri);break;case"second":e=this._d.valueOf(),e-=li(e,ai)}return this._d.setTime(e),n.updateOffset(this,!0),this},bi.subtract=Qe,bi.toArray=function(){var t=this;return[t.year(),t.month(),t.date(),t.hour(),t.minute(),t.second(),t.millisecond()]},bi.toObject=function(){var t=this;return{years:t.year(),months:t.month(),date:t.date(),hours:t.hours(),minutes:t.minutes(),seconds:t.seconds(),milliseconds:t.milliseconds()}},bi.toDate=function(){return new Date(this.valueOf())},bi.toISOString=function(t){if(!this.isValid())return null;var e=!0!==t,i=e?this.clone().utc():this;return i.year()<0||i.year()>9999?j(i,e?"YYYYYY-MM-DD[T]HH:mm:ss.SSS[Z]":"YYYYYY-MM-DD[T]HH:mm:ss.SSSZ"):T(Date.prototype.toISOString)?e?this.toDate().toISOString():new Date(this.valueOf()+60*this.utcOffset()*1e3).toISOString().replace("Z",j(i,"Z")):j(i,e?"YYYY-MM-DD[T]HH:mm:ss.SSS[Z]":"YYYY-MM-DD[T]HH:mm:ss.SSSZ")},bi.inspect=function(){if(!this.isValid())return"moment.invalid(/* "+this._i+" */)";var t="moment",e="";this.isLocal()||(t=0===this.utcOffset()?"moment.utc":"moment.parseZone",e="Z");var i="["+t+'("]',n=0<=this.year()&&this.year()<=9999?"YYYY":"YYYYYY",a=e+'[")]';return this.format(i+n+"-MM-DD[T]HH:mm:ss.SSS"+a)},bi.toJSON=function(){return this.isValid()?this.toISOString():null},bi.toString=function(){return this.clone().locale("en").format("ddd MMM DD YYYY HH:mm:ss [GMT]ZZ")},bi.unix=function(){return Math.floor(this.valueOf()/1e3)},bi.valueOf=function(){return this._d.valueOf()-6e4*(this._offset||0)},bi.creationData=function(){return{input:this._i,format:this._f,locale:this._locale,isUTC:this._isUTC,strict:this._strict}},bi.year=Pt,bi.isLeapYear=function(){return Dt(this.year())},bi.weekYear=function(t){return ci.call(this,t,this.week(),this.weekday(),this.localeData()._week.dow,this.localeData()._week.doy)},bi.isoWeekYear=function(t){return ci.call(this,t,this.isoWeek(),this.isoWeekday(),1,4)},bi.quarter=bi.quarters=function(t){return null==t?Math.ceil((this.month()+1)/3):this.month(3*(t-1)+this.month()%3)},bi.month=Yt,bi.daysInMonth=function(){return At(this.year(),this.month())},bi.week=bi.weeks=function(t){var e=this.localeData().week(this);return null==t?e:this.add(7*(t-e),"d")},bi.isoWeek=bi.isoWeeks=function(t){var e=jt(this,1,4).week;return null==t?e:this.add(7*(t-e),"d")},bi.weeksInYear=function(){var t=this.localeData()._week;return Ut(this.year(),t.dow,t.doy)},bi.isoWeeksInYear=function(){return Ut(this.year(),1,4)},bi.date=fi,bi.day=bi.days=function(t){if(!this.isValid())return null!=t?this:NaN;var e=this._isUTC?this._d.getUTCDay():this._d.getDay();return null!=t?(t=function(t,e){return"string"!=typeof t?t:isNaN(t)?"number"==typeof(t=e.weekdaysParse(t))?t:null:parseInt(t,10)}(t,this.localeData()),this.add(t-e,"d")):e},bi.weekday=function(t){if(!this.isValid())return null!=t?this:NaN;var e=(this.day()+7-this.localeData()._week.dow)%7;return null==t?e:this.add(t-e,"d")},bi.isoWeekday=function(t){if(!this.isValid())return null!=t?this:NaN;if(null!=t){var e=function(t,e){return"string"==typeof t?e.weekdaysParse(t)%7||7:isNaN(t)?null:t}(t,this.localeData());return this.day(this.day()%7?e:e-7)}return this.day()||7},bi.dayOfYear=function(t){var e=Math.round((this.clone().startOf("day")-this.clone().startOf("year"))/864e5)+1;return null==t?e:this.add(t-e,"d")},bi.hour=bi.hours=ae,bi.minute=bi.minutes=gi,bi.second=bi.seconds=pi,bi.millisecond=bi.milliseconds=yi,bi.utcOffset=function(t,e,i){var a,r=this._offset||0;if(!this.isValid())return null!=t?this:NaN;if(null!=t){if("string"==typeof t){if(null===(t=He(ot,t)))return this}else Math.abs(t)<16&&!i&&(t*=60);return!this._isUTC&&e&&(a=Be(this)),this._offset=t,this._isUTC=!0,null!=a&&this.add(a,"m"),r!==t&&(!e||this._changeInProgress?Ke(this,qe(t-r,"m"),1,!1):this._changeInProgress||(this._changeInProgress=!0,n.updateOffset(this,!0),this._changeInProgress=null)),this}return this._isUTC?r:Be(this)},bi.utc=function(t){return this.utcOffset(0,t)},bi.local=function(t){return this._isUTC&&(this.utcOffset(0,t),this._isUTC=!1,t&&this.subtract(Be(this),"m")),this},bi.parseZone=function(){if(null!=this._tzm)this.utcOffset(this._tzm,!1,!0);else if("string"==typeof this._i){var t=He(rt,this._i);null!=t?this.utcOffset(t):this.utcOffset(0,!0)}return this},bi.hasAlignedHourOffset=function(t){return!!this.isValid()&&(t=t?Ie(t).utcOffset():0,(this.utcOffset()-t)%60==0)},bi.isDST=function(){return this.utcOffset()>this.clone().month(0).utcOffset()||this.utcOffset()>this.clone().month(5).utcOffset()},bi.isLocal=function(){return!!this.isValid()&&!this._isUTC},bi.isUtcOffset=function(){return!!this.isValid()&&this._isUTC},bi.isUtc=je,bi.isUTC=je,bi.zoneAbbr=function(){return this._isUTC?"UTC":""},bi.zoneName=function(){return this._isUTC?"Coordinated Universal Time":""},bi.dates=S("dates accessor is deprecated. Use date instead.",fi),bi.months=S("months accessor is deprecated. Use month instead",Yt),bi.years=S("years accessor is deprecated. Use year instead",Pt),bi.zone=S("moment().zone is deprecated, use moment().utcOffset instead. http://momentjs.com/guides/#/warnings/zone/",function(t,e){return null!=t?("string"!=typeof t&&(t=-t),this.utcOffset(t,e),this):-this.utcOffset()}),bi.isDSTShifted=S("isDSTShifted is deprecated. See http://momentjs.com/guides/#/warnings/dst-shifted/ for more information",function(){if(!o(this._isDSTShifted))return this._isDSTShifted;var t={};if(v(t,this),(t=Te(t))._a){var e=t._isUTC?c(t._a):Ie(t._a);this._isDSTShifted=this.isValid()&&w(t._a,e.toArray())>0}else this._isDSTShifted=!1;return this._isDSTShifted});var _i=I.prototype;function ki(t,e,i,n){var a=ce(),r=c().set(n,e);return a[i](r,t)}function wi(t,e,i){if(s(t)&&(e=t,t=void 0),t=t||"",null!=e)return ki(t,e,i,"month");var n,a=[];for(n=0;n<12;n++)a[n]=ki(t,n,i,"month");return a}function Mi(t,e,i,n){"boolean"==typeof t?(s(e)&&(i=e,e=void 0),e=e||""):(i=e=t,t=!1,s(e)&&(i=e,e=void 0),e=e||"");var a,r=ce(),o=t?r._week.dow:0;if(null!=i)return ki(e,(i+o)%7,n,"day");var l=[];for(a=0;a<7;a++)l[a]=ki(e,(a+o)%7,n,"day");return l}_i.calendar=function(t,e,i){var n=this._calendar[t]||this._calendar.sameElse;return T(n)?n.call(e,i):n},_i.longDateFormat=function(t){var e=this._longDateFormat[t],i=this._longDateFormat[t.toUpperCase()];return e||!i?e:(this._longDateFormat[t]=i.replace(/MMMM|MM|DD|dddd/g,function(t){return t.slice(1)}),this._longDateFormat[t])},_i.invalidDate=function(){return this._invalidDate},_i.ordinal=function(t){return this._ordinal.replace("%d",t)},_i.preparse=xi,_i.postformat=xi,_i.relativeTime=function(t,e,i,n){var a=this._relativeTime[i];return T(a)?a(t,e,i,n):a.replace(/%d/i,t)},_i.pastFuture=function(t,e){var i=this._relativeTime[t>0?"future":"past"];return T(i)?i(e):i.replace(/%s/i,e)},_i.set=function(t){var e,i;for(i in t)T(e=t[i])?this[i]=e:this["_"+i]=e;this._config=t,this._dayOfMonthOrdinalParseLenient=new RegExp((this._dayOfMonthOrdinalParse.source||this._ordinalParse.source)+"|"+/\d{1,2}/.source)},_i.months=function(t,e){return t?a(this._months)?this._months[t.month()]:this._months[(this._months.isFormat||Ft).test(e)?"format":"standalone"][t.month()]:a(this._months)?this._months:this._months.standalone},_i.monthsShort=function(t,e){return t?a(this._monthsShort)?this._monthsShort[t.month()]:this._monthsShort[Ft.test(e)?"format":"standalone"][t.month()]:a(this._monthsShort)?this._monthsShort:this._monthsShort.standalone},_i.monthsParse=function(t,e,i){var n,a,r;if(this._monthsParseExact)return function(t,e,i){var n,a,r,o=t.toLocaleLowerCase();if(!this._monthsParse)for(this._monthsParse=[],this._longMonthsParse=[],this._shortMonthsParse=[],n=0;n<12;++n)r=c([2e3,n]),this._shortMonthsParse[n]=this.monthsShort(r,"").toLocaleLowerCase(),this._longMonthsParse[n]=this.months(r,"").toLocaleLowerCase();return i?"MMM"===e?-1!==(a=Ct.call(this._shortMonthsParse,o))?a:null:-1!==(a=Ct.call(this._longMonthsParse,o))?a:null:"MMM"===e?-1!==(a=Ct.call(this._shortMonthsParse,o))?a:-1!==(a=Ct.call(this._longMonthsParse,o))?a:null:-1!==(a=Ct.call(this._longMonthsParse,o))?a:-1!==(a=Ct.call(this._shortMonthsParse,o))?a:null}.call(this,t,e,i);for(this._monthsParse||(this._monthsParse=[],this._longMonthsParse=[],this._shortMonthsParse=[]),n=0;n<12;n++){if(a=c([2e3,n]),i&&!this._longMonthsParse[n]&&(this._longMonthsParse[n]=new RegExp("^"+this.months(a,"").replace(".","")+"$","i"),this._shortMonthsParse[n]=new RegExp("^"+this.monthsShort(a,"").replace(".","")+"$","i")),i||this._monthsParse[n]||(r="^"+this.months(a,"")+"|^"+this.monthsShort(a,""),this._monthsParse[n]=new RegExp(r.replace(".",""),"i")),i&&"MMMM"===e&&this._longMonthsParse[n].test(t))return n;if(i&&"MMM"===e&&this._shortMonthsParse[n].test(t))return n;if(!i&&this._monthsParse[n].test(t))return n}},_i.monthsRegex=function(t){return this._monthsParseExact?(d(this,"_monthsRegex")||Vt.call(this),t?this._monthsStrictRegex:this._monthsRegex):(d(this,"_monthsRegex")||(this._monthsRegex=zt),this._monthsStrictRegex&&t?this._monthsStrictRegex:this._monthsRegex)},_i.monthsShortRegex=function(t){return this._monthsParseExact?(d(this,"_monthsRegex")||Vt.call(this),t?this._monthsShortStrictRegex:this._monthsShortRegex):(d(this,"_monthsShortRegex")||(this._monthsShortRegex=Nt),this._monthsShortStrictRegex&&t?this._monthsShortStrictRegex:this._monthsShortRegex)},_i.week=function(t){return jt(t,this._week.dow,this._week.doy).week},_i.firstDayOfYear=function(){return this._week.doy},_i.firstDayOfWeek=function(){return this._week.dow},_i.weekdays=function(t,e){var i=a(this._weekdays)?this._weekdays:this._weekdays[t&&!0!==t&&this._weekdays.isFormat.test(e)?"format":"standalone"];return!0===t?Gt(i,this._week.dow):t?i[t.day()]:i},_i.weekdaysMin=function(t){return!0===t?Gt(this._weekdaysMin,this._week.dow):t?this._weekdaysMin[t.day()]:this._weekdaysMin},_i.weekdaysShort=function(t){return!0===t?Gt(this._weekdaysShort,this._week.dow):t?this._weekdaysShort[t.day()]:this._weekdaysShort},_i.weekdaysParse=function(t,e,i){var n,a,r;if(this._weekdaysParseExact)return function(t,e,i){var n,a,r,o=t.toLocaleLowerCase();if(!this._weekdaysParse)for(this._weekdaysParse=[],this._shortWeekdaysParse=[],this._minWeekdaysParse=[],n=0;n<7;++n)r=c([2e3,1]).day(n),this._minWeekdaysParse[n]=this.weekdaysMin(r,"").toLocaleLowerCase(),this._shortWeekdaysParse[n]=this.weekdaysShort(r,"").toLocaleLowerCase(),this._weekdaysParse[n]=this.weekdays(r,"").toLocaleLowerCase();return i?"dddd"===e?-1!==(a=Ct.call(this._weekdaysParse,o))?a:null:"ddd"===e?-1!==(a=Ct.call(this._shortWeekdaysParse,o))?a:null:-1!==(a=Ct.call(this._minWeekdaysParse,o))?a:null:"dddd"===e?-1!==(a=Ct.call(this._weekdaysParse,o))?a:-1!==(a=Ct.call(this._shortWeekdaysParse,o))?a:-1!==(a=Ct.call(this._minWeekdaysParse,o))?a:null:"ddd"===e?-1!==(a=Ct.call(this._shortWeekdaysParse,o))?a:-1!==(a=Ct.call(this._weekdaysParse,o))?a:-1!==(a=Ct.call(this._minWeekdaysParse,o))?a:null:-1!==(a=Ct.call(this._minWeekdaysParse,o))?a:-1!==(a=Ct.call(this._weekdaysParse,o))?a:-1!==(a=Ct.call(this._shortWeekdaysParse,o))?a:null}.call(this,t,e,i);for(this._weekdaysParse||(this._weekdaysParse=[],this._minWeekdaysParse=[],this._shortWeekdaysParse=[],this._fullWeekdaysParse=[]),n=0;n<7;n++){if(a=c([2e3,1]).day(n),i&&!this._fullWeekdaysParse[n]&&(this._fullWeekdaysParse[n]=new RegExp("^"+this.weekdays(a,"").replace(".","\\.?")+"$","i"),this._shortWeekdaysParse[n]=new RegExp("^"+this.weekdaysShort(a,"").replace(".","\\.?")+"$","i"),this._minWeekdaysParse[n]=new RegExp("^"+this.weekdaysMin(a,"").replace(".","\\.?")+"$","i")),this._weekdaysParse[n]||(r="^"+this.weekdays(a,"")+"|^"+this.weekdaysShort(a,"")+"|^"+this.weekdaysMin(a,""),this._weekdaysParse[n]=new RegExp(r.replace(".",""),"i")),i&&"dddd"===e&&this._fullWeekdaysParse[n].test(t))return n;if(i&&"ddd"===e&&this._shortWeekdaysParse[n].test(t))return n;if(i&&"dd"===e&&this._minWeekdaysParse[n].test(t))return n;if(!i&&this._weekdaysParse[n].test(t))return n}},_i.weekdaysRegex=function(t){return this._weekdaysParseExact?(d(this,"_weekdaysRegex")||Qt.call(this),t?this._weekdaysStrictRegex:this._weekdaysRegex):(d(this,"_weekdaysRegex")||(this._weekdaysRegex=Xt),this._weekdaysStrictRegex&&t?this._weekdaysStrictRegex:this._weekdaysRegex)},_i.weekdaysShortRegex=function(t){return this._weekdaysParseExact?(d(this,"_weekdaysRegex")||Qt.call(this),t?this._weekdaysShortStrictRegex:this._weekdaysShortRegex):(d(this,"_weekdaysShortRegex")||(this._weekdaysShortRegex=Kt),this._weekdaysShortStrictRegex&&t?this._weekdaysShortStrictRegex:this._weekdaysShortRegex)},_i.weekdaysMinRegex=function(t){return this._weekdaysParseExact?(d(this,"_weekdaysRegex")||Qt.call(this),t?this._weekdaysMinStrictRegex:this._weekdaysMinRegex):(d(this,"_weekdaysMinRegex")||(this._weekdaysMinRegex=Jt),this._weekdaysMinStrictRegex&&t?this._weekdaysMinStrictRegex:this._weekdaysMinRegex)},_i.isPM=function(t){return"p"===(t+"").toLowerCase().charAt(0)},_i.meridiem=function(t,e,i){return t>11?i?"pm":"PM":i?"am":"AM"},de("en",{dayOfMonthOrdinalParse:/\d{1,2}(th|st|nd|rd)/,ordinal:function(t){var e=t%10,i=1===k(t%100/10)?"th":1===e?"st":2===e?"nd":3===e?"rd":"th";return t+i}}),n.lang=S("moment.lang is deprecated. Use moment.locale instead.",de),n.langData=S("moment.langData is deprecated. Use moment.localeData instead.",ce);var Si=Math.abs;function Di(t,e,i,n){var a=qe(e,i);return t._milliseconds+=n*a._milliseconds,t._days+=n*a._days,t._months+=n*a._months,t._bubble()}function Ci(t){return t<0?Math.floor(t):Math.ceil(t)}function Pi(t){return 4800*t/146097}function Ti(t){return 146097*t/4800}function Oi(t){return function(){return this.as(t)}}var Ii=Oi("ms"),Ai=Oi("s"),Fi=Oi("m"),Ri=Oi("h"),Li=Oi("d"),Wi=Oi("w"),Yi=Oi("M"),Ni=Oi("Q"),zi=Oi("y");function Vi(t){return function(){return this.isValid()?this._data[t]:NaN}}var Hi=Vi("milliseconds"),Ei=Vi("seconds"),Bi=Vi("minutes"),ji=Vi("hours"),Ui=Vi("days"),Gi=Vi("months"),qi=Vi("years"),Zi=Math.round,$i={ss:44,s:45,m:45,h:22,d:26,M:11},Xi=Math.abs;function Ki(t){return(t>0)-(t<0)||+t}function Ji(){if(!this.isValid())return this.localeData().invalidDate();var t,e,i=Xi(this._milliseconds)/1e3,n=Xi(this._days),a=Xi(this._months);t=_(i/60),e=_(t/60),i%=60,t%=60;var r=_(a/12),o=a%=12,s=n,l=e,u=t,d=i?i.toFixed(3).replace(/\.?0+$/,""):"",h=this.asSeconds();if(!h)return"P0D";var c=h<0?"-":"",f=Ki(this._months)!==Ki(h)?"-":"",g=Ki(this._days)!==Ki(h)?"-":"",m=Ki(this._milliseconds)!==Ki(h)?"-":"";return c+"P"+(r?f+r+"Y":"")+(o?f+o+"M":"")+(s?g+s+"D":"")+(l||u||d?"T":"")+(l?m+l+"H":"")+(u?m+u+"M":"")+(d?m+d+"S":"")}var Qi=We.prototype;return Qi.isValid=function(){return this._isValid},Qi.abs=function(){var t=this._data;return this._milliseconds=Si(this._milliseconds),this._days=Si(this._days),this._months=Si(this._months),t.milliseconds=Si(t.milliseconds),t.seconds=Si(t.seconds),t.minutes=Si(t.minutes),t.hours=Si(t.hours),t.months=Si(t.months),t.years=Si(t.years),this},Qi.add=function(t,e){return Di(this,t,e,1)},Qi.subtract=function(t,e){return Di(this,t,e,-1)},Qi.as=function(t){if(!this.isValid())return NaN;var e,i,n=this._milliseconds;if("month"===(t=R(t))||"quarter"===t||"year"===t)switch(e=this._days+n/864e5,i=this._months+Pi(e),t){case"month":return i;case"quarter":return i/3;case"year":return i/12}else switch(e=this._days+Math.round(Ti(this._months)),t){case"week":return e/7+n/6048e5;case"day":return e+n/864e5;case"hour":return 24*e+n/36e5;case"minute":return 1440*e+n/6e4;case"second":return 86400*e+n/1e3;case"millisecond":return Math.floor(864e5*e)+n;default:throw new Error("Unknown unit "+t)}},Qi.asMilliseconds=Ii,Qi.asSeconds=Ai,Qi.asMinutes=Fi,Qi.asHours=Ri,Qi.asDays=Li,Qi.asWeeks=Wi,Qi.asMonths=Yi,Qi.asQuarters=Ni,Qi.asYears=zi,Qi.valueOf=function(){return this.isValid()?this._milliseconds+864e5*this._days+this._months%12*2592e6+31536e6*k(this._months/12):NaN},Qi._bubble=function(){var t,e,i,n,a,r=this._milliseconds,o=this._days,s=this._months,l=this._data;return r>=0&&o>=0&&s>=0||r<=0&&o<=0&&s<=0||(r+=864e5*Ci(Ti(s)+o),o=0,s=0),l.milliseconds=r%1e3,t=_(r/1e3),l.seconds=t%60,e=_(t/60),l.minutes=e%60,i=_(e/60),l.hours=i%24,o+=_(i/24),a=_(Pi(o)),s+=a,o-=Ci(Ti(a)),n=_(s/12),s%=12,l.days=o,l.months=s,l.years=n,this},Qi.clone=function(){return qe(this)},Qi.get=function(t){return t=R(t),this.isValid()?this[t+"s"]():NaN},Qi.milliseconds=Hi,Qi.seconds=Ei,Qi.minutes=Bi,Qi.hours=ji,Qi.days=Ui,Qi.weeks=function(){return _(this.days()/7)},Qi.months=Gi,Qi.years=qi,Qi.humanize=function(t){if(!this.isValid())return this.localeData().invalidDate();var e=this.localeData(),i=function(t,e,i){var n=qe(t).abs(),a=Zi(n.as("s")),r=Zi(n.as("m")),o=Zi(n.as("h")),s=Zi(n.as("d")),l=Zi(n.as("M")),u=Zi(n.as("y")),d=a<=$i.ss&&["s",a]||a<$i.s&&["ss",a]||r<=1&&["m"]||r<$i.m&&["mm",r]||o<=1&&["h"]||o<$i.h&&["hh",o]||s<=1&&["d"]||s<$i.d&&["dd",s]||l<=1&&["M"]||l<$i.M&&["MM",l]||u<=1&&["y"]||["yy",u];return d[2]=e,d[3]=+t>0,d[4]=i,function(t,e,i,n,a){return a.relativeTime(e||1,!!i,t,n)}.apply(null,d)}(this,!t,e);return t&&(i=e.pastFuture(+this,i)),e.postformat(i)},Qi.toISOString=Ji,Qi.toString=Ji,Qi.toJSON=Ji,Qi.locale=ei,Qi.localeData=ni,Qi.toIsoString=S("toIsoString() is deprecated. Please use toISOString() instead (notice the capitals)",Ji),Qi.lang=ii,B("X",0,0,"unix"),B("x",0,0,"valueOf"),ut("x",at),ut("X",/[+-]?\d+(\.\d{1,3})?/),ft("X",function(t,e,i){i._d=new Date(1e3*parseFloat(t,10))}),ft("x",function(t,e,i){i._d=new Date(k(t))}),n.version="2.24.0",e=Ie,n.fn=bi,n.min=function(){return Re("isBefore",[].slice.call(arguments,0))},n.max=function(){return Re("isAfter",[].slice.call(arguments,0))},n.now=function(){return Date.now?Date.now():+new Date},n.utc=c,n.unix=function(t){return Ie(1e3*t)},n.months=function(t,e){return wi(t,e,"months")},n.isDate=l,n.locale=de,n.invalid=m,n.duration=qe,n.isMoment=x,n.weekdays=function(t,e,i){return Mi(t,e,i,"weekdays")},n.parseZone=function(){return Ie.apply(null,arguments).parseZone()},n.localeData=ce,n.isDuration=Ye,n.monthsShort=function(t,e){return wi(t,e,"monthsShort")},n.weekdaysMin=function(t,e,i){return Mi(t,e,i,"weekdaysMin")},n.defineLocale=he,n.updateLocale=function(t,e){if(null!=e){var i,n,a=re;null!=(n=ue(t))&&(a=n._config),e=O(a,e),(i=new I(e)).parentLocale=oe[t],oe[t]=i,de(t)}else null!=oe[t]&&(null!=oe[t].parentLocale?oe[t]=oe[t].parentLocale:null!=oe[t]&&delete oe[t]);return oe[t]},n.locales=function(){return D(oe)},n.weekdaysShort=function(t,e,i){return Mi(t,e,i,"weekdaysShort")},n.normalizeUnits=R,n.relativeTimeRounding=function(t){return void 0===t?Zi:"function"==typeof t&&(Zi=t,!0)},n.relativeTimeThreshold=function(t,e){return void 0!==$i[t]&&(void 0===e?$i[t]:($i[t]=e,"s"===t&&($i.ss=e-1),!0))},n.calendarFormat=function(t,e){var i=t.diff(e,"days",!0);return i<-6?"sameElse":i<-1?"lastWeek":i<0?"lastDay":i<1?"sameDay":i<2?"nextDay":i<7?"nextWeek":"sameElse"},n.prototype=bi,n.HTML5_FMT={DATETIME_LOCAL:"YYYY-MM-DDTHH:mm",DATETIME_LOCAL_SECONDS:"YYYY-MM-DDTHH:mm:ss",DATETIME_LOCAL_MS:"YYYY-MM-DDTHH:mm:ss.SSS",DATE:"YYYY-MM-DD",TIME:"HH:mm",TIME_SECONDS:"HH:mm:ss",TIME_MS:"HH:mm:ss.SSS",WEEK:"GGGG-[W]WW",MONTH:"YYYY-MM"},n}()}(tn={exports:{}},tn.exports),tn.exports),an={datetime:"MMM D, YYYY, h:mm:ss a",millisecond:"h:mm:ss.SSS a",second:"h:mm:ss a",minute:"h:mm a",hour:"hA",day:"MMM D",week:"ll",month:"MMM YYYY",quarter:"[Q]Q - YYYY",year:"YYYY"};si._date.override("function"==typeof nn?{_id:"moment",formats:function(){return an},parse:function(t,e){return"string"==typeof t&&"string"==typeof e?t=nn(t,e):t instanceof nn||(t=nn(t)),t.isValid()?t.valueOf():null},format:function(t,e){return nn(t).format(e)},add:function(t,e,i){return nn(t).add(e,i).valueOf()},diff:function(t,e,i){return nn.duration(nn(t).diff(nn(e))).as(i)},startOf:function(t,e,i){return t=nn(t),"isoWeek"===e?t.isoWeekday(i).valueOf():t.startOf(e).valueOf()},endOf:function(t,e){return nn(t).endOf(e).valueOf()},_create:function(t){return nn(t)}}:{}),ot._set("global",{plugins:{filler:{propagate:!0}}});var rn={dataset:function(t){var e=t.fill,i=t.chart,n=i.getDatasetMeta(e),a=n&&i.isDatasetVisible(e)&&n.dataset._children||[],r=a.length||0;return r?function(t,e){return e<r&&a[e]._view||null}:null},boundary:function(t){var e=t.boundary,i=e?e.x:null,n=e?e.y:null;return function(t){return{x:null===i?t.x:i,y:null===n?t.y:n}}}};function on(t,e,i){var n,a=t._model||{},r=a.fill;if(void 0===r&&(r=!!a.backgroundColor),!1===r||null===r)return!1;if(!0===r)return"origin";if(n=parseFloat(r,10),isFinite(n)&&Math.floor(n)===n)return"-"!==r[0]&&"+"!==r[0]||(n=e+n),!(n===e||n<0||n>=i)&&n;switch(r){case"bottom":return"start";case"top":return"end";case"zero":return"origin";case"origin":case"start":case"end":return r;default:return!1}}function sn(t){var e,i=t.el._model||{},n=t.el._scale||{},a=t.fill,r=null;if(isFinite(a))return null;if("start"===a?r=void 0===i.scaleBottom?n.bottom:i.scaleBottom:"end"===a?r=void 0===i.scaleTop?n.top:i.scaleTop:void 0!==i.scaleZero?r=i.scaleZero:n.getBasePosition?r=n.getBasePosition():n.getBasePixel&&(r=n.getBasePixel()),null!=r){if(void 0!==r.x&&void 0!==r.y)return r;if(ut.isFinite(r))return{x:(e=n.isHorizontal())?r:null,y:e?null:r}}return null}function ln(t,e,i){var n,a=t[e].fill,r=[e];if(!i)return a;for(;!1!==a&&-1===r.indexOf(a);){if(!isFinite(a))return a;if(!(n=t[a]))return!1;if(n.visible)return a;r.push(a),a=n.fill}return!1}function un(t){var e=t.fill,i="dataset";return!1===e?null:(isFinite(e)||(i="boundary"),rn[i](t))}function dn(t){return t&&!t.skip}function hn(t,e,i,n,a){var r;if(n&&a){for(t.moveTo(e[0].x,e[0].y),r=1;r<n;++r)ut.canvas.lineTo(t,e[r-1],e[r]);for(t.lineTo(i[a-1].x,i[a-1].y),r=a-1;r>0;--r)ut.canvas.lineTo(t,i[r],i[r-1],!0)}}var cn={id:"filler",afterDatasetsUpdate:function(t,e){var i,n,a,r,o=(t.data.datasets||[]).length,s=e.propagate,l=[];for(n=0;n<o;++n)r=null,(a=(i=t.getDatasetMeta(n)).dataset)&&a._model&&a instanceof Nt.Line&&(r={visible:t.isDatasetVisible(n),fill:on(a,n,o),chart:t,el:a}),i.$filler=r,l.push(r);for(n=0;n<o;++n)(r=l[n])&&(r.fill=ln(l,n,s),r.boundary=sn(r),r.mapper=un(r))},beforeDatasetDraw:function(t,e){var i=e.meta.$filler;if(i){var n=t.ctx,a=i.el,r=a._view,o=a._children||[],s=i.mapper,l=r.backgroundColor||ot.globalThis.defaultColor;s&&l&&o.length&&(ut.canvas.clipArea(n,t.chartArea),function(t,e,i,n,a,r){var o,s,l,u,d,h,c,f=e.length,g=n.spanGaps,m=[],p=[],v=0,y=0;for(t.beginPath(),o=0,s=f+!!r;o<s;++o)d=i(u=e[l=o%f]._view,l,n),h=dn(u),c=dn(d),h&&c?(v=m.push(u),y=p.push(d)):v&&y&&(g?(h&&m.push(u),c&&p.push(d)):(hn(t,m,p,v,y),v=y=0,m=[],p=[]));hn(t,m,p,v,y),t.closePath(),t.fillStyle=a,t.fill()}(n,o,s,r,l,a._loop),ut.canvas.unclipArea(n))}}},fn=ut.noop,gn=ut.valueOrDefault;function mn(t,e){return t.usePointStyle&&t.boxWidth>e?e:t.boxWidth}ot._set("global",{legend:{display:!0,position:"top",fullWidth:!0,reverse:!1,weight:1e3,onClick:function(t,e){var i=e.datasetIndex,n=this.chart,a=n.getDatasetMeta(i);a.hidden=null===a.hidden?!n.data.datasets[i].hidden:null,n.update()},onHover:null,onLeave:null,labels:{boxWidth:40,padding:10,generateLabels:function(t){var e=t.data;return ut.isArray(e.datasets)?e.datasets.map(function(e,i){return{text:e.label,fillStyle:ut.isArray(e.backgroundColor)?e.backgroundColor[0]:e.backgroundColor,hidden:!t.isDatasetVisible(i),lineCap:e.borderCapStyle,lineDash:e.borderDash,lineDashOffset:e.borderDashOffset,lineJoin:e.borderJoinStyle,lineWidth:e.borderWidth,strokeStyle:e.borderColor,pointStyle:e.pointStyle,datasetIndex:i}},this):[]}}},legendCallback:function(t){var e=[];e.push('<ul class="'+t.id+'-legend">');for(var i=0;i<t.data.datasets.length;i++)e.push('<li><span style="background-color:'+t.data.datasets[i].backgroundColor+'"></span>'),t.data.datasets[i].label&&e.push(t.data.datasets[i].label),e.push("</li>");return e.push("</ul>"),e.join("")}});var pn=gt.extend({initialize:function(t){ut.extend(this,t),this.legendHitBoxes=[],this._hoveredItem=null,this.doughnutMode=!1},beforeUpdate:fn,update:function(t,e,i){var n=this;return n.beforeUpdate(),n.maxWidth=t,n.maxHeight=e,n.margins=i,n.beforeSetDimensions(),n.setDimensions(),n.afterSetDimensions(),n.beforeBuildLabels(),n.buildLabels(),n.afterBuildLabels(),n.beforeFit(),n.fit(),n.afterFit(),n.afterUpdate(),n.minSize},afterUpdate:fn,beforeSetDimensions:fn,setDimensions:function(){var t=this;t.isHorizontal()?(t.width=t.maxWidth,t.left=0,t.right=t.width):(t.height=t.maxHeight,t.top=0,t.bottom=t.height),t.paddingLeft=0,t.paddingTop=0,t.paddingRight=0,t.paddingBottom=0,t.minSize={width:0,height:0}},afterSetDimensions:fn,beforeBuildLabels:fn,buildLabels:function(){var t=this,e=t.options.labels||{},i=ut.callback(e.generateLabels,[t.chart],t)||[];e.filter&&(i=i.filter(function(i){return e.filter(i,t.chart.data)})),t.options.reverse&&i.reverse(),t.legendItems=i},afterBuildLabels:fn,beforeFit:fn,fit:function(){var t=this,e=t.options,i=e.labels,n=e.display,a=t.ctx,r=ut.options._parseFont(i),o=r.size,s=t.legendHitBoxes=[],l=t.minSize,u=t.isHorizontal();if(u?(l.width=t.maxWidth,l.height=n?10:0):(l.width=n?10:0,l.height=t.maxHeight),n)if(a.font=r.string,u){var d=t.lineWidths=[0],h=0;a.textAlign="left",a.textBaseline="top",ut.each(t.legendItems,function(t,e){var n=mn(i,o)+o/2+a.measureText(t.text).width;(0===e||d[d.length-1]+n+i.padding>l.width)&&(h+=o+i.padding,d[d.length-(e>0?0:1)]=i.padding),s[e]={left:0,top:0,width:n,height:o},d[d.length-1]+=n+i.padding}),l.height+=h}else{var c=i.padding,f=t.columnWidths=[],g=i.padding,m=0,p=0,v=o+c;ut.each(t.legendItems,function(t,e){var n=mn(i,o)+o/2+a.measureText(t.text).width;e>0&&p+v>l.height-c&&(g+=m+i.padding,f.push(m),m=0,p=0),m=Math.max(m,n),p+=v,s[e]={left:0,top:0,width:n,height:o}}),g+=m,f.push(m),l.width+=g}t.width=l.width,t.height=l.height},afterFit:fn,isHorizontal:function(){return"top"===this.options.position||"bottom"===this.options.position},draw:function(){var t=this,e=t.options,i=e.labels,n=ot.globalThis,a=n.defaultColor,r=n.elements.line,o=t.width,s=t.lineWidths;if(e.display){var l,u=t.ctx,d=gn(i.fontColor,n.defaultFontColor),h=ut.options._parseFont(i),c=h.size;u.textAlign="left",u.textBaseline="middle",u.lineWidth=.5,u.strokeStyle=d,u.fillStyle=d,u.font=h.string;var f=mn(i,c),g=t.legendHitBoxes,m=t.isHorizontal();l=m?{x:t.left+(o-s[0])/2+i.padding,y:t.top+i.padding,line:0}:{x:t.left+i.padding,y:t.top+i.padding,line:0};var p=c+i.padding;ut.each(t.legendItems,function(n,d){var h=u.measureText(n.text).width,v=f+c/2+h,y=l.x,b=l.y;m?d>0&&y+v+i.padding>t.left+t.minSize.width&&(b=l.y+=p,l.line++,y=l.x=t.left+(o-s[l.line])/2+i.padding):d>0&&b+p>t.top+t.minSize.height&&(y=l.x=y+t.columnWidths[l.line]+i.padding,b=l.y=t.top+i.padding,l.line++),function(t,i,n){if(!(isNaN(f)||f<=0)){u.save();var o=gn(n.lineWidth,r.borderWidth);if(u.fillStyle=gn(n.fillStyle,a),u.lineCap=gn(n.lineCap,r.borderCapStyle),u.lineDashOffset=gn(n.lineDashOffset,r.borderDashOffset),u.lineJoin=gn(n.lineJoin,r.borderJoinStyle),u.lineWidth=o,u.strokeStyle=gn(n.strokeStyle,a),u.setLineDash&&u.setLineDash(gn(n.lineDash,r.borderDash)),e.labels&&e.labels.usePointStyle){var s=f*Math.SQRT2/2,l=t+f/2,d=i+c/2;ut.canvas.drawPoint(u,n.pointStyle,s,l,d)}else 0!==o&&u.strokeRect(t,i,f,c),u.fillRect(t,i,f,c);u.restore()}}(y,b,n),g[d].left=y,g[d].top=b,function(t,e,i,n){var a=c/2,r=f+a+t,o=e+a;u.fillText(i.text,r,o),i.hidden&&(u.beginPath(),u.lineWidth=2,u.moveTo(r,o),u.lineTo(r+n,o),u.stroke())}(y,b,n,h),m?l.x+=v+i.padding:l.y+=p})}},_getLegendItemAt:function(t,e){var i,n,a,r=this;if(t>=r.left&&t<=r.right&&e>=r.top&&e<=r.bottom)for(a=r.legendHitBoxes,i=0;i<a.length;++i)if(t>=(n=a[i]).left&&t<=n.left+n.width&&e>=n.top&&e<=n.top+n.height)return r.legendItems[i];return null},handleEvent:function(t){var e,i=this,n=i.options,a="mouseup"===t.type?"click":t.type;if("mousemove"===a){if(!n.onHover&&!n.onLeave)return}else{if("click"!==a)return;if(!n.onClick)return}e=i._getLegendItemAt(t.x,t.y),"click"===a?e&&n.onClick&&n.onClick.call(i,t.native,e):(n.onLeave&&e!==i._hoveredItem&&(i._hoveredItem&&n.onLeave.call(i,t.native,i._hoveredItem),i._hoveredItem=e),n.onHover&&e&&n.onHover.call(i,t.native,e))}});function vn(t,e){var i=new pn({ctx:t.ctx,options:e,chart:t});xe.configure(t,i,e),xe.addBox(t,i),t.legend=i}var yn={id:"legend",_element:pn,beforeInit:function(t){var e=t.options.legend;e&&vn(t,e)},beforeUpdate:function(t){var e=t.options.legend,i=t.legend;e?(ut.mergeIf(e,ot.globalThis.legend),i?(xe.configure(t,i,e),i.options=e):vn(t,e)):i&&(xe.removeBox(t,i),delete t.legend)},afterEvent:function(t,e){var i=t.legend;i&&i.handleEvent(e)}},bn=ut.noop;ot._set("global",{title:{display:!1,fontStyle:"bold",fullWidth:!0,padding:10,position:"top",text:"",weight:2e3}});var xn=gt.extend({initialize:function(t){ut.extend(this,t),this.legendHitBoxes=[]},beforeUpdate:bn,update:function(t,e,i){var n=this;return n.beforeUpdate(),n.maxWidth=t,n.maxHeight=e,n.margins=i,n.beforeSetDimensions(),n.setDimensions(),n.afterSetDimensions(),n.beforeBuildLabels(),n.buildLabels(),n.afterBuildLabels(),n.beforeFit(),n.fit(),n.afterFit(),n.afterUpdate(),n.minSize},afterUpdate:bn,beforeSetDimensions:bn,setDimensions:function(){var t=this;t.isHorizontal()?(t.width=t.maxWidth,t.left=0,t.right=t.width):(t.height=t.maxHeight,t.top=0,t.bottom=t.height),t.paddingLeft=0,t.paddingTop=0,t.paddingRight=0,t.paddingBottom=0,t.minSize={width:0,height:0}},afterSetDimensions:bn,beforeBuildLabels:bn,buildLabels:bn,afterBuildLabels:bn,beforeFit:bn,fit:function(){var t=this,e=t.options,i=e.display,n=t.minSize,a=ut.isArray(e.text)?e.text.length:1,r=ut.options._parseFont(e),o=i?a*r.lineHeight+2*e.padding:0;t.isHorizontal()?(n.width=t.maxWidth,n.height=o):(n.width=o,n.height=t.maxHeight),t.width=n.width,t.height=n.height},afterFit:bn,isHorizontal:function(){var t=this.options.position;return"top"===t||"bottom"===t},draw:function(){var t=this,e=t.ctx,i=t.options;if(i.display){var n,a,r,o=ut.options._parseFont(i),s=o.lineHeight,l=s/2+i.padding,u=0,d=t.top,h=t.left,c=t.bottom,f=t.right;e.fillStyle=ut.valueOrDefault(i.fontColor,ot.globalThis.defaultFontColor),e.font=o.string,t.isHorizontal()?(a=h+(f-h)/2,r=d+l,n=f-h):(a="left"===i.position?h+l:f-l,r=d+(c-d)/2,n=c-d,u=Math.PI*("left"===i.position?-.5:.5)),e.save(),e.translate(a,r),e.rotate(u),e.textAlign="center",e.textBaseline="middle";var g=i.text;if(ut.isArray(g))for(var m=0,p=0;p<g.length;++p)e.fillText(g[p],0,m,n),m+=s;else e.fillText(g,0,0,n);e.restore()}}});function _n(t,e){var i=new xn({ctx:t.ctx,options:e,chart:t});xe.configure(t,i,e),xe.addBox(t,i),t.titleBlock=i}var kn={},wn=cn,Mn=yn,Sn={id:"title",_element:xn,beforeInit:function(t){var e=t.options.title;e&&_n(t,e)},beforeUpdate:function(t){var e=t.options.title,i=t.titleBlock;e?(ut.mergeIf(e,ot.globalThis.title),i?(xe.configure(t,i,e),i.options=e):_n(t,e)):i&&(xe.removeBox(t,i),delete t.titleBlock)}};for(var Dn in kn.filler=wn,kn.legend=Mn,kn.title=Sn,ai.helpers=ut,function(){function t(t,e,i){var n;return"string"==typeof t?(n=parseInt(t,10),-1!==t.indexOf("%")&&(n=n/100*e.parentNode[i])):n=t,n}function e(t){return null!=t&&"none"!==t}function i(i,n,a){var r=document.defaultView,o=ut._getParentNode(i),s=r.getComputedStyle(i)[n],l=r.getComputedStyle(o)[n],u=e(s),d=e(l),h=Number.POSITIVE_INFINITY;return u||d?Math.min(u?t(s,i,a):h,d?t(l,o,a):h):"none"}ut.where=function(t,e){if(ut.isArray(t)&&Array.prototype.filter)return t.filter(e);var i=[];return ut.each(t,function(t){e(t)&&i.push(t)}),i},ut.findIndex=Array.prototype.findIndex?function(t,e,i){return t.findIndex(e,i)}:function(t,e,i){i=void 0===i?t:i;for(var n=0,a=t.length;n<a;++n)if(e.call(i,t[n],n,t))return n;return-1},ut.findNextWhere=function(t,e,i){ut.isNullOrUndef(i)&&(i=-1);for(var n=i+1;n<t.length;n++){var a=t[n];if(e(a))return a}},ut.findPreviousWhere=function(t,e,i){ut.isNullOrUndef(i)&&(i=t.length);for(var n=i-1;n>=0;n--){var a=t[n];if(e(a))return a}},ut.isNumber=function(t){return!isNaN(parseFloat(t))&&isFinite(t)},ut.almostEquals=function(t,e,i){return Math.abs(t-e)<i},ut.almostWhole=function(t,e){var i=Math.round(t);return i-e<t&&i+e>t},ut.max=function(t){return t.reduce(function(t,e){return isNaN(e)?t:Math.max(t,e)},Number.NEGATIVE_INFINITY)},ut.min=function(t){return t.reduce(function(t,e){return isNaN(e)?t:Math.min(t,e)},Number.POSITIVE_INFINITY)},ut.sign=Math.sign?function(t){return Math.sign(t)}:function(t){return 0==(t=+t)||isNaN(t)?t:t>0?1:-1},ut.log10=Math.log10?function(t){return Math.log10(t)}:function(t){var e=Math.log(t)*Math.LOG10E,i=Math.round(e);return t===Math.pow(10,i)?i:e},ut.toRadians=function(t){return t*(Math.PI/180)},ut.toDegrees=function(t){return t*(180/Math.PI)},ut._decimalPlaces=function(t){if(ut.isFinite(t)){for(var e=1,i=0;Math.round(t*e)/e!==t;)e*=10,i++;return i}},ut.getAngleFromPoint=function(t,e){var i=e.x-t.x,n=e.y-t.y,a=Math.sqrt(i*i+n*n),r=Math.atan2(n,i);return r<-.5*Math.PI&&(r+=2*Math.PI),{angle:r,distance:a}},ut.distanceBetweenPoints=function(t,e){return Math.sqrt(Math.pow(e.x-t.x,2)+Math.pow(e.y-t.y,2))},ut.aliasPixel=function(t){return t%2==0?0:.5},ut._alignPixel=function(t,e,i){var n=t.currentDevicePixelRatio,a=i/2;return Math.round((e-a)*n)/n+a},ut.splineCurve=function(t,e,i,n){var a=t.skip?e:t,r=e,o=i.skip?e:i,s=Math.sqrt(Math.pow(r.x-a.x,2)+Math.pow(r.y-a.y,2)),l=Math.sqrt(Math.pow(o.x-r.x,2)+Math.pow(o.y-r.y,2)),u=s/(s+l),d=l/(s+l),h=n*(u=isNaN(u)?0:u),c=n*(d=isNaN(d)?0:d);return{previous:{x:r.x-h*(o.x-a.x),y:r.y-h*(o.y-a.y)},next:{x:r.x+c*(o.x-a.x),y:r.y+c*(o.y-a.y)}}},ut.EPSILON=Number.EPSILON||1e-14,ut.splineCurveMonotone=function(t){var e,i,n,a,r,o,s,l,u,d=(t||[]).map(function(t){return{model:t._model,deltaK:0,mK:0}}),h=d.length;for(e=0;e<h;++e)if(!(n=d[e]).model.skip){if(i=e>0?d[e-1]:null,(a=e<h-1?d[e+1]:null)&&!a.model.skip){var c=a.model.x-n.model.x;n.deltaK=0!==c?(a.model.y-n.model.y)/c:0}!i||i.model.skip?n.mK=n.deltaK:!a||a.model.skip?n.mK=i.deltaK:this.sign(i.deltaK)!==this.sign(n.deltaK)?n.mK=0:n.mK=(i.deltaK+n.deltaK)/2}for(e=0;e<h-1;++e)n=d[e],a=d[e+1],n.model.skip||a.model.skip||(ut.almostEquals(n.deltaK,0,this.EPSILON)?n.mK=a.mK=0:(r=n.mK/n.deltaK,o=a.mK/n.deltaK,(l=Math.pow(r,2)+Math.pow(o,2))<=9||(s=3/Math.sqrt(l),n.mK=r*s*n.deltaK,a.mK=o*s*n.deltaK)));for(e=0;e<h;++e)(n=d[e]).model.skip||(i=e>0?d[e-1]:null,a=e<h-1?d[e+1]:null,i&&!i.model.skip&&(u=(n.model.x-i.model.x)/3,n.model.controlPointPreviousX=n.model.x-u,n.model.controlPointPreviousY=n.model.y-u*n.mK),a&&!a.model.skip&&(u=(a.model.x-n.model.x)/3,n.model.controlPointNextX=n.model.x+u,n.model.controlPointNextY=n.model.y+u*n.mK))},ut.nextItem=function(t,e,i){return i?e>=t.length-1?t[0]:t[e+1]:e>=t.length-1?t[t.length-1]:t[e+1]},ut.previousItem=function(t,e,i){return i?e<=0?t[t.length-1]:t[e-1]:e<=0?t[0]:t[e-1]},ut.niceNum=function(t,e){var i=Math.floor(ut.log10(t)),n=t/Math.pow(10,i);return(e?n<1.5?1:n<3?2:n<7?5:10:n<=1?1:n<=2?2:n<=5?5:10)*Math.pow(10,i)},ut.requestAnimFrame="undefined"==typeof window?function(t){t()}:globalThis.requestAnimationFrame||globalThis.webkitRequestAnimationFrame||globalThis.mozRequestAnimationFrame||globalThis.oRequestAnimationFrame||globalThis.msRequestAnimationFrame||function(t){return globalThis.setTimeout(t,1e3/60)},ut.getRelativePosition=function(t,e){var i,n,a=t.originalEvent||t,r=t.target||t.srcElement,o=r.getBoundingClientRect(),s=a.touches;s&&s.length>0?(i=s[0].clientX,n=s[0].clientY):(i=a.clientX,n=a.clientY);var l=parseFloat(ut.getStyle(r,"padding-left")),u=parseFloat(ut.getStyle(r,"padding-top")),d=parseFloat(ut.getStyle(r,"padding-right")),h=parseFloat(ut.getStyle(r,"padding-bottom")),c=o.right-o.left-l-d,f=o.bottom-o.top-u-h;return{x:i=Math.round((i-o.left-l)/c*r.width/e.currentDevicePixelRatio),y:n=Math.round((n-o.top-u)/f*r.height/e.currentDevicePixelRatio)}},ut.getConstraintWidth=function(t){return i(t,"max-width","clientWidth")},ut.getConstraintHeight=function(t){return i(t,"max-height","clientHeight")},ut._calculatePadding=function(t,e,i){return(e=ut.getStyle(t,e)).indexOf("%")>-1?i*parseInt(e,10)/100:parseInt(e,10)},ut._getParentNode=function(t){var e=t.parentNode;return e&&"[object ShadowRoot]"===e.toString()&&(e=e.host),e},ut.getMaximumWidth=function(t){var e=ut._getParentNode(t);if(!e)return t.clientWidth;var i=e.clientWidth,n=i-ut._calculatePadding(e,"padding-left",i)-ut._calculatePadding(e,"padding-right",i),a=ut.getConstraintWidth(t);return isNaN(a)?n:Math.min(n,a)},ut.getMaximumHeight=function(t){var e=ut._getParentNode(t);if(!e)return t.clientHeight;var i=e.clientHeight,n=i-ut._calculatePadding(e,"padding-top",i)-ut._calculatePadding(e,"padding-bottom",i),a=ut.getConstraintHeight(t);return isNaN(a)?n:Math.min(n,a)},ut.getStyle=function(t,e){return t.currentStyle?t.currentStyle[e]:document.defaultView.getComputedStyle(t,null).getPropertyValue(e)},ut.retinaScale=function(t,e){var i=t.currentDevicePixelRatio=e||"undefined"!=typeof window&&globalThis.devicePixelRatio||1;if(1!==i){var n=t.canvas,a=t.height,r=t.width;n.height=a*i,n.width=r*i,t.ctx.scale(i,i),n.style.height||n.style.width||(n.style.height=a+"px",n.style.width=r+"px")}},ut.fontString=function(t,e,i){return e+" "+t+"px "+i},ut.longestText=function(t,e,i,n){var a=(n=n||{}).data=n.data||{},r=n.garbageCollect=n.garbageCollect||[];n.font!==e&&(a=n.data={},r=n.garbageCollect=[],n.font=e),t.font=e;var o=0;ut.each(i,function(e){null!=e&&!0!==ut.isArray(e)?o=ut.measureText(t,a,r,o,e):ut.isArray(e)&&ut.each(e,function(e){null==e||ut.isArray(e)||(o=ut.measureText(t,a,r,o,e))})});var s=r.length/2;if(s>i.length){for(var l=0;l<s;l++)delete a[r[l]];r.splice(0,s)}return o},ut.measureText=function(t,e,i,n,a){var r=e[a];return r||(r=e[a]=t.measureText(a).width,i.push(a)),r>n&&(n=r),n},ut.numberOfLabelLines=function(t){var e=1;return ut.each(t,function(t){ut.isArray(t)&&t.length>e&&(e=t.length)}),e},ut.color=G?function(t){return t instanceof CanvasGradient&&(t=ot.globalThis.defaultColor),G(t)}:function(t){return console.error("Color.js not found!"),t},ut.getHoverColor=function(t){return t instanceof CanvasPattern||t instanceof CanvasGradient?t:ut.color(t).saturate(.5).darken(.1).rgbString()}}(),ai._adapters=si,ai.Animation=pt,ai.animationService=vt,ai.controllers=ue,ai.DatasetController=kt,ai.defaults=ot,ai.Element=gt,ai.elements=Nt,ai.Interaction=pe,ai.layouts=xe,ai.platform=Ve,ai.plugins=He,ai.Scale=fi,ai.scaleService=Ee,ai.Ticks=li,ai.Tooltip=Je,ai.helpers.each(en,function(t,e){ai.scaleService.registerScaleType(e,t,t._defaults)}),kn)kn.hasOwnProperty(Dn)&&ai.plugins.register(kn[Dn]);ai.platform.initialize();var Cn=ai;return"undefined"!=typeof window&&(globalThis.Chart=ai),ai.Chart=ai,ai.Legend=kn.legend._element,ai.Title=kn.title._element,ai.pluginService=ai.plugins,ai.PluginBase=ai.Element.extend({}),ai.canvasHelpers=ai.helpers.canvas,ai.layoutService=ai.layouts,ai.LinearScaleBase=yi,ai.helpers.each(["Bar","Bubble","Doughnut","Line","PolarArea","Radar","Scatter"],function(t){ai[t]=function(e,i){return new ai(e,ai.helpers.merge(i||{},{type:t.charAt(0).toLowerCase()+t.slice(1)}))}}),Cn})}catch(e){return null}return Chart}}]});
foam.CLASS({package:"org.chartjs",name:"ChartCView",extends:"foam.graphics.CView",requires:["org.chartjs.Lib"],properties:[{class:"Map",name:"config"},{class:"Simple",name:"chart_"}],reactions:[["","propertyChange.config","invalidate"]],methods:[function paintSelf(x){if(this.chart_)this.chart_.destroy();this.chart_=new this.Lib.CHART(x,this.config);this.chart_.render()}]});
foam.CLASS({package:"org.chartjs",name:"ChartJSPropertyFormatterRefinement",refines:"foam.core.Property",properties:[{name:"chartJsFormatter",value:function(v){return v.toLocaleString(foam.locale)}}]});
foam.CLASS({package:"org.chartjs",name:"ChartJSDateFormatterRefinement",refines:"foam.core.Date",properties:[{name:"chartJsFormatter",value:function(d){if(!foam.Date.isInstance(d)){d=new Date(d)}var month=d.getMonth()+1;if(month<10)month="0"+month;var day=d.getDate();if(day<10)day="0"+day;var year=d.getFullYear();return`${year}-${month}-${day}`}}]});
foam.CLASS({package:"org.chartjs",name:"ChartJSDateTimeFormatterRefinement",refines:"foam.core.DateTime",properties:[{name:"chartJsFormatter",value:function(d){if(!foam.Date.isInstance(d)){d=new Date(d)}var month=d.getMonth()+1;if(month<10)month="0"+month;var day=d.getDate();if(day<10)day="0"+day;var year=d.getFullYear();var hour=d.getHours();var min=d.getMinutes();if(min<10)min="0"+min;return`${year}-${month}-${day} ${hour}:${min}`}}]});
foam.CLASS({package:"org.chartjs",name:"AbstractChartCView",extends:"foam.graphics.CView",requires:["foam.dao.ProxySink","foam.mlang.sink.AbstractUnarySink","foam.mlang.sink.GroupBy","org.chartjs.Lib"],properties:["chart","chartType","colors","data",{name:"xFormatter",expression:function(dataProperties_){return dataProperties_[dataProperties_.length-2].chartJsFormatter||function(v){return v.toLocaleString(foam.locale)}}},{name:"xAxisLabel",expression:function(dataProperties_){return dataProperties_[dataProperties_.length-2].label}},{name:"yFormatter",expression:function(dataProperties_){return dataProperties_[dataProperties_.length-1].chartJsFormatter||function(v){return v.toLocaleString(foam.locale)}}},{name:"yAxisLabel",expression:function(dataProperties_){return dataProperties_[dataProperties_.length-1].label}},{name:"tooltipLabelFormatter",value:function(tooltipItem,data){var yLabel=data.datasets[tooltipItem.datasetIndex].data[tooltipItem.index];if(foam.Object.isInstance(yLabel))yLabel=yLabel.y;return data.datasets[tooltipItem.datasetIndex].label+": "+this.yFormatter(yLabel)}},{name:"tooltipTitleFormatter",value:function(tooltipItem,data){return tooltipItem[0].xLabel}},{name:"dataProperties_",expression:function(data){var getData=function(data){if(this.GroupBy.isInstance(data)){return getData(data.arg1).concat(getData(data.arg2))}else if(this.ProxySink.isInstance(data)){return getData(data.delegate)}else if(this.AbstractUnarySink.isInstance(data)){return getData(data.arg1)}else{return[data]}}.bind(this);return getData(data)}},{name:"config",factory:function(){return{type:this.chartType,datasets:[{}],options:{responsive:false,maintainAspectRatio:false,tooltips:{callbacks:{title:this.tooltipTitleFormatter.bind(this),label:this.tooltipLabelFormatter.bind(this)}},scales:{yAxes:[{ticks:{callback:this.yFormatter.bind(this)},scaleLabel:{display:true,labelString:this.yAxisLabel}}],xAxes:[{ticks:{callback:this.xFormatter.bind(this)},scaleLabel:{display:true,labelString:this.xAxisLabel}}]}}}}}],reactions:[["data","propertyChange","update"],["","propertyChange.data","update"],["","propertyChange.chart","update"]],classes:[{name:"ChartData",properties:["key","data"]}],methods:[function initCView(x){this.chart=new this.Lib.CHART(x,this.config);this.configChart_(this.chart)},function paintSelf(x){this.chart.render()},function configChart_(chart){},function genChartData_(data){},function normalizeData(){var getData=function(data){if(this.GroupBy.isInstance(data)){var ps=[];var o=[];data.sortedKeys().forEach(function(k){ps.push(getData(data.groups[k]).then(function(o2){o2.forEach(function(o3){o.push([k].concat(o3))})}))});return Promise.all(ps).then(function(){return o})}else if(this.ProxySink.isInstance(data)){return getData(data.delegate)}else if(data&&data.value){return Promise.resolve([data.value])}else{return Promise.resolve([data])}}.bind(this);return getData(this.data).then(function(o){o.sort(foam.util.compare);return o})},function toChartData(data){var dimensions=data.length&&data[0].length;if(dimensions==3){var xValues=[];data.forEach(function(row){var x=row[1];if(xValues.indexOf(x)==-1)xValues.push(x)});xValues.sort(foam.util.compare);var datasets=[];for(var i=0;i<data.length;){var o={label:data[i][0],data:[]};for(var xi=0;xi<xValues.length;xi++){if(i>=data.length)break;if(o.label!=data[i][0])break;var x=xValues[xi];var y=null;if(x==data[i][1]){y=data[i][2];i++}o.data.push({x:x,y:y})}datasets.push(o)}return{labels:xValues,datasets:datasets}}else{return{labels:data.map(function(o){return o[0]}),datasets:[{label:"Total",data:data.map(function(o){return o[1]})}]}}}],listeners:[{name:"update",isFramed:true,code:function(){if(this.chart&&this.data){var copyFrom=function(to,from){if(foam.Array.isInstance(from)){to=to||[];while(to.length>from.length){to.pop()}for(var i=0;i<from.length;i++){to[i]=copyFrom(to[i],from[i])}return to}else if(foam.Date.isInstance(from)){return from}else if(foam.Object.isInstance(to)){to=to||{};Object.keys(from).forEach(function(k){to[k]=copyFrom(to[k],from[k])});return to}return from};this.normalizeData().then(function(o){var data=this.genChartData_(o);copyFrom(this.chart.data,data);this.chart.update()}.bind(this))}}}]});
foam.CLASS({package:"org.chartjs",name:"AbstractChartView",extends:"foam.u2.View",flags:["web"],requires:["foam.dao.FnSink","org.chartjs.ChartCView"],properties:[{class:"foam.dao.DAOProperty",name:"data"},{class:"Map",name:"config",preSet:function(_,n){n.options.responsive=false;return n}},{name:"parentEl_"},{name:"chart_"}],methods:[async function init(){if(!this.parentEl_)return null;var el=await this.parentEl_.el();this.chart_=this.ChartCView.create({config$:this.config$,height:el.clientHeight,width:el.clientWidth})},function render(){this.onDetach(this.data$proxy.listen(this.FnSink.create({fn:this.dataUpdate})));this.dataUpdate();window.addEventListener("resize",this.onResize);this.start("div",null,this.parentEl_$).style({width:"100%",height:"100%"}).add(this.chart_$).end()}],reactions:[["parentEl_","onload","onResize"]],listeners:[{name:"onResize",isFramed:true,code:function(){this.chart_=undefined}},{name:"dataUpdate",isFramed:true,code:function(){}}]});
foam.CLASS({package:"org.chartjs",name:"HorizontalBarDAOChartView",extends:"org.chartjs.AbstractChartView",implements:["foam.mlang.Expressions"],properties:[{class:"Map",name:"config",factory:function(){return{type:"horizontalBar"}}},{class:"Map",name:"customDatasetStyling",},{class:"foam.mlang.ExprProperty",name:"keyExpr"},{class:"foam.mlang.ExprProperty",name:"xExpr"},{class:"foam.mlang.ExprProperty",name:"yExpr"}],reactions:[["","propertyChange.yExpr","dataUpdate"],["","propertyChange.data","dataUpdate"]],listeners:[{name:"dataUpdate",isFramed:true,code:function(){var self=this;self.data.orderBy(this.yExpr).select(this.GROUP_BY(this.yExpr,this.GROUP_BY(this.keyExpr,this.SUM(this.xExpr)))).then(function(sink){self.config.data={datasets:[]};var config=foam.Object.clone(self.config);var dataMap=Object.keys(sink.groups).reduce((map,y)=>{return sink.groups[y].groupKeys.reduce((map,k)=>{map[k]=[];return map},map)},{});Object.keys(sink.groups).forEach((y,yi)=>{Object.keys(dataMap).forEach(k=>{dataMap[k][yi]=0});sink.groups[y].groupKeys.forEach(k=>{dataMap[k][yi]=sink.groups[y].groups[k].value})});config.data={labels:sink.groupKeys,datasets:Object.keys(dataMap).map(k=>{var data={label:k,data:dataMap[k]};var style=self.customDatasetStyling[k]||{};Object.keys(style).forEach(function(k){data[k]=style[k]});return data})};self.config=config})}}]});
foam.CLASS({package:"org.chartjs",name:"CandlestickDAOChartView",extends:"org.chartjs.AbstractChartView",requires:["foam.nanos.analytics.Candlestick"],implements:["foam.mlang.Expressions"],properties:[{class:"Map",name:"config",factory:function(){return{type:"line",data:{datasets:[]},options:{scales:{xAxes:[{type:"time",distribution:"linear"}]}}}}},{class:"Map",name:"customDatasetStyling",},{class:"foam.mlang.ExprProperty",name:"keyExpr",factory:function(){return this.Candlestick.KEY}},{class:"foam.mlang.ExprProperty",name:"xExpr",factory:function(){return this.Candlestick.CLOSE_TIME}},{class:"foam.mlang.ExprProperty",name:"yExpr",factory:function(){return this.Candlestick.AVERAGE}}],reactions:[["","propertyChange.customDatasetStyling","dataUpdate"]],listeners:[{name:"dataUpdate",isFramed:true,code:function(){var self=this;self.data.orderBy(this.xExpr).select(this.GROUP_BY(this.keyExpr,this.PLOT(this.xExpr,this.yExpr))).then(function(sink){self.config.data={datasets:[]};var config=foam.Object.clone(self.config);config.data={datasets:Object.keys(sink.groups).map(key=>{var data={label:key,data:sink.groups[key].data.map(arr=>({x:arr[0],y:arr[1]}))};var style=self.customDatasetStyling[key]||{};Object.keys(style).forEach(function(k){data[k]=style[k]});return data})};self.config=config})}}]});
foam.CLASS({package:"org.chartjs",name:"PieDAOChartView",extends:"org.chartjs.AbstractChartView",requires:["foam.nanos.analytics.Candlestick"],implements:["foam.mlang.Expressions"],properties:[{name:"config",factory:function(){return{type:"pie"}}},{class:"foam.mlang.ExprProperty",name:"keyExpr"},{class:"foam.mlang.ExprProperty",name:"valueExpr"},{name:"palette",value:["#E3170D","#AF4035","#CC1100","#FFE4E1","#FF6347","#FF6600"],}],listeners:[{name:"dataUpdate",isFramed:true,code:function(){var self=this;self.data.select(this.GROUP_BY(this.keyExpr,this.SUM(this.valueExpr))).then(function(sink){self.config.data={datasets:[]};var config=foam.Object.clone(self.config);var keys=Object.keys(sink.groups);var data=[];var backgroundColors=[];keys.forEach(key=>{data.push(sink.groups[key].value);if(foam.Object.isInstance(self.palette)){var color=self.palette[key];var unsupportedKeyColor=self.palette["default"]?self.palette["default"]:"lightgray";color?backgroundColors.push(color):backgroundColors.push(unsupportedKeyColor)}});if(Array.isArray(self.palette)&&self.palette.length>0){data.forEach(function(_,index){backgroundColors.push(self.palette[index%self.palette.length])})}else if(typeof self.palette==="function"){backgroundColors=self.palette(keys,data)}else if(backgroundColors.length===0){data.forEach(function(_,index){backgroundColors.push("lightgray")})}config.data={datasets:[{data:data,backgroundColor:backgroundColors}],labels:keys};self.config=config})}}]});
foam.CLASS({package:"org.chartjs",name:"Pie",extends:"org.chartjs.AbstractChartCView",flags:["web"],properties:[["chartType","pie"],{name:"tooltipLabelFormatter",value:function(tooltipItem,data){return data.labels[tooltipItem.index]+": "+this.yFormatter(data.datasets[tooltipItem.datasetIndex].data[tooltipItem.index])}},{name:"tooltipTitleFormatter",value:function(tooltipItem,data){tooltipItem=tooltipItem[0];return data.datasets[tooltipItem.datasetIndex].label}}],methods:[function configChart_(chart){delete chart.options.scales},function genChartData_(data){var chartData=this.toChartData(data);chartData.datasets.forEach(function(d,i){if(d.data.length&&foam.Object.isInstance(d.data[0])){d.data=d.data.map(function(d){return d.y})}d.backgroundColor=this.colors.map(function(c){return this.Lib.CHART.helpers.color(c).alpha(.5).rgbString()}.bind(this));d.borderColor=this.colors}.bind(this));return chartData}]});
foam.CLASS({package:"org.chartjs",name:"Bar",extends:"org.chartjs.AbstractChartCView",flags:["web"],properties:[["chartType","bar"]],methods:[function configChart_(chart){chart.options.scales.yAxes[0].ticks.beginAtZero=true},function genChartData_(data){var chartData=this.toChartData(data);chartData.datasets.forEach(function(d,i){d.backgroundColor=this.Lib.CHART.helpers.color(this.colors[i]).alpha(.5).rgbString();d.borderColor=this.colors[i];d.borderWidth=2}.bind(this));return chartData}]});
foam.CLASS({package:"org.chartjs",name:"Line",extends:"org.chartjs.AbstractChartCView",flags:["web"],properties:[["chartType","line"]],methods:[function genChartData_(data){var chartData=this.toChartData(data);chartData.datasets.forEach(function(d,i){d.backgroundColor=this.colors[i];d.borderColor=this.colors[i];d.fill=false;d.spanGaps=true}.bind(this));return chartData}]});
foam.CLASS({package:"org.chartjs",name:"Line2",extends:"foam.graphics.CView",requires:["org.chartjs.Lib"],properties:["chart",{name:"data",factory:function(){return{datasets:[]}},postSet:function(){this.update()}},{name:"xAxis",postSet:function(_,v){if(this.chart){this.chart.options.scales.xAxes=[v]}}},{name:"config",factory:function(){return{type:"line",data:this.data,options:{responsive:false,maintainAspectRatio:false,scales:{xAxes:this.xAxis?[this.xAxis]:[]}}}}}],reactions:[["","propertyChange.data","update"]],methods:[function initCView(x){this.chart=new this.Lib.CHART(x,this.config);this.update()},function paintSelf(x){this.chart.render()}],listeners:[{name:"update",isFramed:true,code:function(){if(!this.chart)return;this.chart.data=this.data;this.chart.update()}}]});
foam.CLASS({package:"org.chartjs",name:"Bar2",extends:"foam.graphics.CView",requires:["org.chartjs.Lib"],properties:["chart",{name:"data",factory:function(){return{datasets:[]}},postSet:function(){this.update()}},{name:"config",required:true}],reactions:[["","propertyChange.data","update"]],methods:[function initCView(x){this.chart=new this.Lib.CHART(x,this.config);this.update()},function paintSelf(x){this.chart.render()}],listeners:[{name:"update",isFramed:true,code:function(){if(!this.chart)return;this.chart.data=this.data;this.chart.update()}}]});
foam.CLASS({package:"org.chartjs",name:"Pie2",extends:"foam.graphics.CView",requires:["org.chartjs.Lib"],properties:["chart",{name:"data",factory:function(){return{labels:[],datasets:[]}},postSet:function(){this.update()}},{name:"config",factory:function(){return{type:"pie",data:this.data,options:{animation:{duration:0},responsive:false,maintainAspectRatio:false}}}}],reactions:[["","propertyChange.data","update"]],methods:[function initCView(x){this.chart=new this.Lib.CHART(x,this.config);this.update()},function paintSelf(x){this.chart.render()}],listeners:[{name:"update",isFramed:true,code:function(){if(!this.chart)return;this.chart.data=this.data;this.chart.update()}}]});foam.ENUM({package:"foam.dashboard.model",name:"VisualizationSize",values:["tiny","small","smedium","medium","lmedium","large","xlarge"]});
foam.CLASS({package:"foam.dashboard.model",name:"Visualization",requires:["foam.dao.NullDAO","foam.dashboard.view.Card","foam.dao.ArraySink","foam.mlang.sink.Sum","foam.mlang.sink.Count","foam.mlang.sink.Average","foam.mlang.order.Desc","foam.parse.QueryParser","foam.mlang.predicate.False","foam.mlang.predicate.True"],properties:[{class:"String",name:"predicate",hidden:true},{class:"FObjectProperty",type:"foam.core.Property",name:"order",view:{class:"foam.u2.view.ExprView"},hidden:true},{class:"Boolean",name:"descending",value:false},{class:"String",label:"DAO",hidden:true,name:"daoName"},{class:"String",name:"label"},{name:"dao",hidden:true,expression:function(daoName,predicate,order,descending){var dao=this.__context__[daoName];if(!dao)return this.NullDAO.create();var pred=predicate?this.QueryParser.create({of:dao.of}).parseString(predicate)||this.True.create():this.True.create();return this.__context__[daoName].where(pred).orderBy(descending?this.Desc.create({arg1:order}):order)}},{class:"FObjectProperty",type:"foam.dao.Sink",hidden:true,view:{class:"foam.u2.view.FObjectView",choices:[["foam.mlang.sink.ArraySink","LIST"],["foam.mlang.sink.Count","COUNT"],["foam.mlang.sink.Sum","SUM"],["foam.mlang.sink.Average","AVG"]]},name:"sink",factory:function(){return this.ArraySink.create()}},{name:"data",factory:function(){return this.sink.clone()},hidden:true},{name:"configView",hidden:true,factory:function(){return this.CURRENT_VIEW}},{name:"currentView",view:function(args,x){return{class:"foam.u2.view.ChoiceView",choices:x.data.views}},hidden:true,factory:function(){return this.views[0][0]},adapt:function(_,n){if(foam.String.isInstance(n)){return this.views.find(function(o){return o[1]==n})[0]}return n}},{class:"String",name:"mode",hidden:true,expression:function(currentView){return currentView==this.DetailView?"config":"display"}},{name:"views",hidden:true,factory:function(){return[[this.DetailView,"Configuration"]]}},{class:"Enum",of:"foam.dashboard.model.VisualizationSize",name:"size",value:"MEDIUM"},{class:"StringArray",name:"colors",factory:function(){return["#4dc9f6","#f67019","#f53794","#537bc4","#acc236","#166a8f","#00a950","#58595b","#8549ba"]}}],methods:[function toE(args,x){return x.lookup("foam.dashboard.view.Card").create({data:this},x)}],reactions:[["sink","propertyChange","update"],["sink","nestedPropertyChange","update"],["","propertyChange.sink","update"],["","propertyChange.dao","update"]],listeners:[function update(){var sink=this.sink.clone();this.dao.select(sink).then(function(result){this.data=result}.bind(this))}]});
foam.CLASS({package:"foam.dashboard.model",name:"GroupBy",extends:"foam.dashboard.model.Visualization",requires:["foam.mlang.sink.Count","foam.mlang.sink.GroupBy","foam.dashboard.view.Pie","foam.dashboard.view.Table","foam.dashboard.view.Line","foam.dashboard.view.Bar","foam.u2.ContextSensitiveDetailView as DetailView"],properties:[{class:"String",name:"arg1"},{name:"views",factory:function(){return[[this.Pie,"Pie"],[this.Bar,"Bar"],[this.Line,"Line"],[this.Table,"Table"],[this.DetailView,"Configure"]]}},{name:"sink",expression:function(arg1,dao){if(!dao)return null;var of=dao.of;if(!of)return null;var arg1Prop=of.getAxiomByName(arg1);if(!arg1Prop)return null;return this.GroupBy.create({arg1:arg1Prop,arg2:this.Count.create()})}}]});
foam.CLASS({package:"foam.dashboard.model",name:"Count",extends:"foam.dashboard.model.Visualization",requires:["foam.dashboard.view.Count as CountView","foam.mlang.sink.Count","foam.mlang.predicate.False","foam.parse.QueryParser","foam.u2.ContextSensitiveDetailView as DetailView"],properties:[{name:"views",factory:function(){return[[this.CountView,"Count"],[this.DetailView,"Configure"]]}},{name:"sink",factory:function(){return this.Count.create()}}]});
foam.CLASS({package:"foam.dashboard.model",name:"Table",extends:"foam.dashboard.model.Visualization",requires:["foam.dao.ArraySink","foam.mlang.sink.Count","foam.mlang.sink.GroupBy","foam.dashboard.view.DAOTable","foam.u2.ContextSensitiveDetailView as DetailView","foam.mlang.sink.NullSink"],properties:[{class:"Int",name:"limit",value:5},{name:"columns",hidden:true},{name:"views",factory:function(){return[[this.DAOTable,"Table"],[this.DetailView,"Configure"]]}}],listeners:[{name:"update",isFramed:true,code:function(){}}]});
foam.CLASS({package:"foam.dashboard.view",name:"Count",extends:"foam.u2.Element",imports:["data","visualizationWidth","visualizationHeight"],properties:[["nodeName","div"]],css:`
^ {
display: flex;
justify-content: center;
align-items: center;
font-weight: bold;
font-size: xx-large;
}
`,methods:[function render(){var view=this;this.style({width:this.visualizationWidth$.map(function(w){return w+"px"}),height:this.visualizationHeight$.map(function(h){return h+"px"})}).addClass(this.myClass()).add(this.slot(function(data$data){return this.E("span").add(data$data.value)}))}]});
foam.CLASS({package:"foam.dashboard.view",name:"Table",extends:"foam.u2.Element",requires:["foam.core.Model","foam.dao.ArrayDAO","foam.dashboard.view.DashboardCitationView"],imports:["data"],properties:[{name:"citationView",factory:function(){return this.DashboardCitationView}},{name:"listDAOName"},{name:"searchKey"},{name:"dao"},{name:"tableCls",expression:function(data$data$arg1,data$data$arg2){var model=this.Model.create({name:"TableModel",tableColumns:["id","value"],properties:[{name:"id",label:data$data$arg1.label||data$data$arg1.cls_.name},{name:"value",label:data$data$arg2.label||data$data$arg2.cls_.name},{name:"listDAOName"},{name:"searchKey"}]});return model.buildClass()}}],methods:[function render(){var self=this;this.addClass(this.myClass()).add(this.slot(function(data$data$groups,data$data){var dao=this.ArrayDAO.create({of:self.tableCls});data$data.sortedKeys().forEach(function(k){dao.put(self.tableCls.create({id:""+k,value:data$data$groups[k].value,searchKey:self.searchKey,listDAOName:self.listDAOName}))});return self.E().addClass(this.myClass()).select(dao,function(obj){return self.E().start().addClass("table-row").start({class:self.citationView,data:obj,of:dao.of}).end().end()})}))}],css:`
^ .table-row:hover {
background: /*%GREY5%*/ #f5f7fa;
cursor: pointer;
}
^ .table-row {
padding-left: 20px;
padding-right: 20px;
}
^ div div:last-child div.table-row div {
border-bottom: none;
}
`});
foam.CLASS({package:"foam.dashboard.view",name:"Pie",extends:"org.chartjs.Pie",imports:["visualizationWidth","visualizationHeight","visualizationColors","data as visualization"],properties:[{name:"width",expression:function(visualizationWidth){return visualizationWidth}},{name:"height",expression:function(visualizationHeight){return visualizationHeight-16}},{name:"colors",expression:function(visualizationColors){return visualizationColors}}],methods:[function initCView(x){this.data$=this.visualization$.dot("data");this.SUPER(x)}]});
foam.CLASS({package:"foam.dashboard.view",name:"Bar",extends:"org.chartjs.Bar",imports:["visualizationWidth","visualizationHeight","visualizationColors","data as visualization"],properties:[{name:"width",expression:function(visualizationWidth){return visualizationWidth}},{name:"height",expression:function(visualizationHeight){return visualizationHeight}},{name:"colors",expression:function(visualizationColors){return visualizationColors}}],methods:[function initCView(x){this.data$=this.visualization$.dot("data");this.SUPER(x)}]});
foam.CLASS({package:"foam.dashboard.view",name:"Line",extends:"org.chartjs.Line",imports:["data as visualization","visualizationColors","visualizationHeight","visualizationWidth"],properties:[{name:"width",expression:function(visualizationWidth){return visualizationWidth}},{name:"height",expression:function(visualizationHeight){return visualizationHeight}},{name:"colors",expression:function(visualizationColors){return visualizationColors}}],methods:[function initCView(x){this.data$=this.visualization$.dot("data");this.SUPER(x)}]});
foam.CLASS({package:"foam.dashboard.view",name:"DAOTable",extends:"foam.u2.Element",requires:["foam.dashboard.view.DashboardCitationView","foam.comics.v2.DAOBrowseControllerView","foam.u2.stack.StackBlock"],imports:["dashboardController","pushMenu","stack"],css:`
^ {
position: relative;
height: 100%;
}
^center {
height: 100%;
display: flex;
align-items: center;
justify-content: center;
flex-direction: column;
}
^ .table-row:hover {
background: /*%GREY5%*/ #f5f7fa;
cursor: pointer;
}
^ .table-row {
padding-left: 20px;
padding-right: 20px;
}
^ div.table-row:last-child div {
border-bottom: none;
}
^ .view-more button {
width: 100%;
height: 100%;
max-height: max-content;
}
^ .view-more button:hover {
background: /*%GREY5%*/ #f5f7fa;
cursor: pointer;
border-bottom-left-radius: 22px;
border-bottom-right-radius: 22px;
}
^scroll-container {
overflow-y: scroll;
display: grid;
grid-auto-rows: 20%;
height: 100%;
}
^grid-container {
display: grid;
grid-template-rows: repeat(6, 1fr);
height: 100%;
}
`,properties:[{name:"citationView",factory:function(){return this.DashboardCitationView}},{class:"Boolean",name:"viewMore",postSet:function(){if(this.viewMore)this.limit=5}},{class:"Array",name:"currentValues",value:[]},{class:"String",name:"emptyTitle"},{class:"String",name:"emptySubTitle"},{class:"foam.dao.DAOProperty",name:"dao"},{class:"FObjectProperty",of:"foam.mlang.predicate.Predicate",name:"predicate",factory:function(){return foam.mlang.predicate.True.create()}},{class:"String",name:"viewMoreMenuItem",},["limit",5],"mode"],methods:[function init(){if(this.dashboardController){this.onDetach(this.dashboardController.sub("dashboard","update",this.fetchValues))}},function render(){var self=this;this.fetchValues();this.addClass(this.myClass()).add(this.slot(function(currentValues){var e=self.E();self.callIfElse(self.viewMore,function(){if(currentValues.length!=0){e.addClass(self.myClass("grid-container"))}},function(){e.addClass(self.myClass("scroll-container"))});return e.callIf(currentValues.length==0,function(){e.start().addClass(self.myClass("center")).start().addClass("p-semiBold").translate(self.emptyTitle,self.emptyTitle).end().start().addClass("p").translate(self.emptySubTitle,self.emptySubTitle).end().end()}).forEach(currentValues,function(obj){e.start().addClass("table-row").start({class:self.citationView,data:obj}).end()}).callIf(self.viewMore&&currentValues.length>=self.limit,function(){e.start().addClass("view-more").startContext({data:self}).tag(self.VIEW_MORE_ACTION,{buttonStyle:foam.u2.ButtonStyle.UNSTYLED}).endContext().end()})}))}],actions:[{name:"viewMoreAction",label:"View more activities",code:function(){if(this.viewMoreMenuItem){this.pushMenu(this.viewMoreMenuItem)}else{this.stack.push(this.StackBlock.create({view:{class:this.DAOBrowseControllerView,data:this.dao.where(this.predicate)},parent:this.__subContext__}))}}}],listeners:[{name:"fetchValues",code:function(){var self=this;if(!this.dao)return;this.dao.where(this.predicate).limit(this.limit).select().then(objects=>{var fetchedValues=objects.array;if(JSON.stringify(self.currentValues.map(o=>o.id))!=JSON.stringify(fetchedValues.map(o=>o.id))){self.currentValues=fetchedValues}})}}]});
foam.CLASS({package:"foam.dashboard.view",name:"HorizontalDAOTable",extends:"foam.dashboard.view.DAOTable",requires:["foam.dashboard.model.VisualizationSize"],css:`
^ {
display: grid;
grid-template-rows: 2em 1fr;
}
^title-container {
display: flex;
justify-content: space-between;
}
^entry-container {
display: flex;
gap: 30px;
padding-bottom: 1.5vh;
overflow: scroll;
}
^ .foam-u2-ActionView-viewMoreAction {
padding-top: 0;
}
^entry-container > * {
max-width: 400px;
max-height: 200px;
}
`,properties:["title","actionView","data",["limit",3],{class:"FObjectProperty",name:"size",factory:function(){return this.VisualizationSize.MEDIUM}},{name:"viewMoreLabel",value:"Show all"}],methods:[function init(){if(this.dashboardController){this.onDetach(this.dashboardController.sub("dashboard","update",this.fetchValues))}},function render(){var self=this;this.fetchValues();this.addClass(this.myClass()).start().addClass(this.myClass("title-container")).start().addClass("h500").add(self.title).end().start().startContext({data:self}).tag(self.VIEW_MORE_ACTION,{buttonStyle:foam.u2.ButtonStyle.UNSTYLED,label:self.viewMoreLabel}).endContext().end().end().add(this.slot(function(currentValues){var e=self.E();return e.addClass(self.myClass("entry-container")).forEach(currentValues,function(data){e.tag(self.citationView,{data:data})}).callIf(self.actionView,function(){e.tag(self.actionView)})}))}]});
foam.CLASS({package:"foam.dashboard.view",name:"UserGreetingView",extends:"foam.u2.View",imports:["subject"],css:`
^ {
height: 100%;
width: 100%;
}
`,messages:[{name:"MORNING_TITLE",message:"Good morning"},{name:"AFTERNOON_TITLE",message:"Good afternoon"},{name:"EVENING_TITLE",message:"Good evening"}],properties:[{name:"title",factory:function(){let hours=(new Date).getHours();if(hours>=5&&hours<12){return this.MORNING_TITLE}if(hours>=12&&hours<17){return this.AFTERNOON_TITLE}return this.EVENING_TITLE}}],methods:[function render(){this.addClasses([this.myClass(),"h200"]).start().add(this.slot(function(subject$user){return this.title+(this.subject.user!=null?", "+this.subject.user.firstName:"")})).end()}]});
foam.CLASS({package:"foam.dashboard.view",name:"GroupByDAOTable",extends:"foam.dashboard.view.DAOTable",imports:["dashboardController"],css:`
^no-entry {
height: 100%;
display: flex;
align-items: center;
justify-content: center;
}
^ .table-row {
padding-left: 0px;
padding-right: 0px;
}
`,properties:[{class:"String",name:"groupByPropertyName",},{class:"FObjectProperty",of:"foam.nanos.menu.Menu",name:"redirectMenu",},{name:"noEntriesMessage",type:"foam.box.Message"},{name:"groupingsCount",factory:function(){return new Map}},"customizeKey","dao"],methods:[function init(){this.onDetach(this.dashboardController.sub("dashboard","update",this.populateGroupingsCount));this.onDetach(this.dao$.sub(this.populateGroupingsCount))},async function render(){var self=this;await this.populateGroupingsCount();this.addClass(this.myClass()).add(this.slot(function(groupingsCount){var e=self.E();return e.callIf(groupingsCount.size==0,function(){e.start().addClass(self.myClass("no-entry")).add(self.noEntriesMessage).end()}).forEach(Array.from(this.groupingsCount.entries()),function(grouping){e.start().addClass("table-row").start({class:self.citationView,data:grouping,groupByPropertyName:self.groupByPropertyName,redirectMenu:self.redirectMenu,dao:self.dao,customizeKey:self.customizeKey}).end()})}))}],listeners:[{name:"populateGroupingsCount",code:async function(){var map_=new Map;var out=await this.dao.select();for(v of out.array){var key=v[this.groupByPropertyName];if(map_.has(key)){var count=map_.get(key);map_.set(key,count+1);continue}map_.set(key,1)}this.groupingsCount=map_}}]});
foam.CLASS({package:"foam.dashboard.view",name:"GroupByCitationView",extends:"foam.dashboard.view.DashboardCitationView",imports:["translationService"],requires:["foam.comics.v2.DAOBrowseControllerView","foam.u2.stack.StackBlock"],implements:["foam.mlang.Expressions"],css:`
^ {
padding-top: 0px;
padding-bottom: 0px;
align-items: center;
}
^ .foam-u2-ActionView {
width: 100%;
height: 100%;
max-height: none;
padding: 15px 15px;
}
^row-label {
width: 100%;
display: flex;
justify-content: space-between;
}
`,properties:[{class:"String",name:"groupByPropertyName"},{class:"FObjectProperty",of:"foam.nanos.menu.Menu",name:"redirectMenu"},"dao","customizeKey"],methods:[async function render(){var label=this.customizeKey?await this.customizeKey(this.data[0]):this.data[0];var count=this.data[1];this.addClass(this.myClass()).startContext({data:this}).tag(this.CLICK,{label:this.E().addClass(this.myClass("row-label")).start().add(label).end().start().add(count).end(),buttonStyle:foam.u2.ButtonStyle.UNSTYLED}).endContext()}],actions:[{name:"click",code:function(X){var config=this.redirectMenu.handler.config;var propertyValue=this.data[0];var predicate=this.EQ(this.dao.of.getAxiomByName(this.groupByPropertyName),propertyValue);config.searchPredicate=predicate;config.browseTitle=this.translationService.getTranslation(foam.locale,`${this.redirectMenu.id}.browseTitle`,this.redirectMenu.handler.config.browseTitle);config.dao=this.dao;this.stack.push(this.StackBlock.create({view:{class:this.DAOBrowseControllerView,data$:this.dao$,config:config},parent:this.__subContext__}))}}]});
foam.CLASS({package:"foam.dashboard.view",name:"Card",extends:"foam.u2.View",requires:["foam.u2.view.SimpleAltView"],imports:["dashboardController"],exports:["contentWidth as visualizationWidth","contentHeight as visualizationHeight","data.colors as visualizationColors","data.dao.of as of"],constants:[{name:"SIZES",value:{TINY:[176,358],SMALL:[312,"-"],SMEDIUM:[312,358],MEDIUM:[424,356],LMEDIUM:[570,450],LARGE:[936,528],XLARGE:[1580,698]}}],properties:[{name:"width",expression:function(data$size){return this.SIZES[data$size.name][0]}},{name:"height",expression:function(data$size){return this.SIZES[data$size.name][1]}},{name:"contentWidth",expression:function(width){return width}},{name:"contentHeight",expression:function(height){return height-60}},{class:"FObjectProperty",name:"cardData"}],css:`
^ {
border-radius: 10px;
background: /*%WHITE%*/ #ffffff;
box-shadow: 3px 8px 6px -2px /*%GREY4%*/;;
}
^header {
padding-left: 20px;
padding-right: 16px;
padding-top: 20px;
padding-bottom: 20px;
font-weight: 500;
height: 20px;
display: flex;
align-items: center;
font-size: 1.7rem;
justify-content: space-between;
}
`,methods:[function init(){this.onDetach(this.dashboardController.sub("dashboard","update",function(){this.data.update()}.bind(this)));this.data.update();var view=this;this.style({width:this.slot(function(data$mode,width){return data$mode=="config"?"inherit":width+"px"}),height:this.slot(function(data$mode,height){return data$mode=="config"?"inherit":height+"px"})}).addClass(this.myClass()).start("div").addClass(this.myClass("header")).show(!!this.data.label||!!this.data.configView).start().style({float:"left"}).add(this.data.label$).end().start().style({float:"right"}).tag(this.data.configView).end().end("div").start("div").addClass(this.myClass("content")).tag("div",null,this.content$).end("div")}]});
foam.CLASS({package:"foam.dashboard.view",name:"CardWrapper",extends:"foam.u2.Element",imports:["dashboardController"],requires:["foam.dashboard.model.VisualizationSize","foam.dashboard.view.Card"],css:`
^ .foam-dashboard-view-Card {
border-radius: 22px;
overflow: hidden;
}
^titled-container {
display: grid;
grid-template-rows: 2em 1fr;
}
`,properties:[{class:"foam.u2.ViewSpec",name:"border",factory:function(){return this.Card}},"title","currentView",["viewTitle","Dashboard"],{class:"FObjectProperty",name:"size",factory:function(){return this.VisualizationSize.MEDIUM}},"data","obj","mode",["aspectRatio","auto"]],methods:[function render(){this.addClass(this.myClass()).enableClass(this.myClass("titled-container"),this.title).style({"aspect-ratio":this.aspectRatio}).callIf(!!this.title,function(){this.start().addClasses([this.myClass("title"),"h500"]).translate(this.title,this.title).end()}).start(this.border,{data:this}).tag(this.slot(function(currentView){return foam.u2.ViewSpec.createView(currentView,{data$:this.data$},this,this.__subSubContext__)})).end()}],listeners:[{name:"update",code:function(){}}]});
foam.CLASS({package:"foam.dashboard.view",name:"Dashboard",extends:"foam.u2.Element",imports:["setInterval","clearInterval"],exports:["as dashboardController"],requires:["foam.dashboard.model.Count","foam.dashboard.model.GroupBy","foam.dashboard.model.Table","foam.dashboard.model.VisualizationSize"],properties:[["nodeName","div"]],css:`
^ {
display: flex;
flex-wrap: wrap;
}
`,methods:[function render(){var timeout=this.setInterval(this.onUpdate,5e3);var view=this;this.onDetach(function(){this.clearInterval(timeout)}.bind(this));this.addClass(this.myClass())}],listeners:[function onUpdate(){this.pub("dashboard","update")}]});
foam.CLASS({package:"foam.dashboard.view",name:"DashboardView",extends:"foam.dashboard.view.Dashboard",imports:["menuDAO","displayWidth?"],requires:["foam.nanos.menu.Menu"],css:`
^ {
height: 100%;
width: 100%;
display: flex;
flex-direction: column;
}
^main {
height: min(600px,100%);
padding: 24px 32px;
}
^widget-container {
width: 100%;
display: grid;
flex-grow: 1;
}
`,messages:[{name:"TITLE",message:"Dashboard"}],properties:[{class:"String",name:"viewTitle",factory:function(){return this.TITLE}},"dashboardTitle",{name:"main",value:false},{name:"width",expression:function(displayWidth){if(!displayWidth)return"repeat(12, 1fr)";return`repeat(${displayWidth.cols}, 1fr)`}},{name:"height",value:"min-content"},{name:"gap",value:"1.6em"},{class:"Map",name:"widgets",factory:function(){return{}}}],methods:[function render(){this.SUPER();var widgetContainer=this.E().addClass(this.myClass("widget-container")).style({"grid-template-columns":this.width$,"grid-template-rows":this.height$,"grid-gap":this.gap$});Object.keys(this.widgets).map(async menuId=>{let menu=await this.menuDAO.find(menuId);if(menu){let aspectRatio=this.widgets[menu.id];widgetContainer.startContext().start(menu.handler.view).style({"grid-column":this.displayWidth$.map(v=>{return"span "+(v?.cols?Math.min(aspectRatio.split("/")[0],v?.cols):aspectRatio.split("/")[0])}),"grid-row":"span "+aspectRatio.split("/")[1]}).end()}});this.addClass(this.myClass()).enableClass(this.myClass("main"),this.main).start().hide(!this.dashboardTitle).enableClass("h500",this.dashboardTitle).style({height:"2em"}).add(this.dashboardTitle).end().tag(widgetContainer)}]});
foam.CLASS({package:"foam.build",name:"Library",ids:["name","iteration"],flags:[],properties:[{name:"name"},{class:"Int",name:"iteration",value:0},{name:"order"},{name:"flags"},{name:"methods"},{name:"constants"}]});
foam.CLASS({package:"foam.build",name:"EmbeddedModelDAO",extends:"foam.dao.ProxyDAO",requires:["foam.json2.Deserializer"],properties:[{class:"Map",name:"json"},{class:"Boolean",name:"loaded",value:false},{class:"Map",name:"loading"},{name:"deserializer",factory:function(){return this.Deserializer.create()}}],methods:[{name:"load_",code:async function(id){var obj=await this.delegate.find(id);if(obj)return obj;if(this.loading[id])return this.loading[id];if(!this.json[id]){console.log("No value found for",id);return null}var json=this.json[id];delete this.json[id];this.loading[id]=this.deserializer.aparse(this.__context__,json).then(function(obj){return this.delegate.put(obj)}.bind(this)).then(function(obj){delete this.loading[id];return obj}.bind(this));return await this.loading[id]}},{name:"find_",code:function(x,id){return this.load_(id)}},{name:"select_",code:function(x,sink,skip,limit,order,predicate){var keys=Object.keys(this.json);if(keys.length!=0){return Promise.all(keys.map(function(key){return this.load_(key)}.bind(this))).then(function(){return Promise.all(Object.keys(this.loading).map(k=>this.loading[k]))}.bind(this)).then(function(){console.log("embedded model dao restart query");return this.select_(x,sink,skip,limit,order,predicate)}.bind(this))}return this.SUPER(x,sink,skip,limit,order,predicate)}}]});
foam.CLASS({package:"foam.u2.view",name:"JSONTextView",extends:"foam.u2.View",requires:["foam.u2.PropertyBorder","foam.u2.tag.TextArea"],properties:[{class:"String",label:"",name:"data_",view:function(_,x){return x.data.TextArea.create({rows:x.data.rows,cols:x.data.cols})},expression:function(data){return foam.json.Pretty.stringify(data)},postSet:function(_,n){try{this.data=foam.json.parseString(n,this.__context__);this.clearProperty("data_");this.error=""}catch(e){this.error=e}},validateObj:function(error){return error||null}},{class:"String",name:"error"},"rows","cols"],methods:[function render(){this.startContext({data:this}).tag(this.DATA.__).endContext()}]});
foam.CLASS({package:"foam.u2.view",name:"MapView",extends:"foam.u2.View",requires:["foam.u2.layout.Cols","foam.u2.layout.Rows"],exports:["as view","mode"],css:`
^key { flex-grow: 1; flex-basis: 0; }
^value { flex-grow: 1; flex-basis: 0; }
^ .foam-u2-ActionView-addRow { margin: 0 0 4px 0; }
^ .foam-u2-ActionView-remove { margin-left: 6px; padding: 6px 14px; height: 32px;}
^ .foam-u2-layout-Cols { padding-bottom: 4px; display: flex; align-items: center;}
`,classes:[{name:"KeyValueRow",imports:["mode","view"],properties:[{class:"String",name:"key"},{name:"value",view:"foam.u2.view.AnyView"}],actions:[{name:"remove",isAvailable:function(mode){return mode===foam.u2.DisplayMode.RW},code:function(){var d2=foam.Object.shallowClone(this.view.data);delete d2[this.key];this.view.data=d2}}]}],methods:[function render(){var self=this;this.addClass(this.myClass()).add(this.slot(function(data){return self.Rows.create().forEach(Object.entries(data||{}),function(e){let oldKey=e[0];let row=self.KeyValueRow.create({key:e[0],value:e[1]});row.onDetach(row.sub("propertyChange",function(){delete self.data[oldKey];self.data[row.key]=row.value;oldKey=row.key}));this.startContext({data:row}).start(self.Cols).start().addClass(self.myClass("key")).add(self.KeyValueRow.KEY).end().start().addClass(self.myClass("value")).add(self.KeyValueRow.VALUE).end().tag(self.KeyValueRow.REMOVE,{isDestructive:true}).end().endContext()})})).startContext({data:this}).add(this.ADD_ROW).endContext()}],actions:[{name:"addRow",label:"Add",isAvailable:function(mode){return mode===foam.u2.DisplayMode.RW},code:function(){var d2=foam.Object.shallowClone(this.data);d2[Date.now()]="";this.data=d2}}]});
foam.CLASS({package:"foam.u2.view",name:"AnyView",extends:"foam.u2.View",requires:["foam.u2.layout.Cols","foam.u2.CheckBox","foam.u2.DateTimeView","foam.u2.TextField","foam.u2.view.ArrayView","foam.u2.view.ChoiceView","foam.u2.view.MapView"],classes:[{name:"Choice",properties:[{class:"String",name:"label"},{name:"type"},{class:"foam.u2.ViewSpec",name:"view"},{class:"Function",name:"toType"}]}],properties:[{name:"types",factory:function(){return[foam.u2.view.AnyView.Choice.create({label:"--",type:foam.Undefined,view:foam.u2.View,toType:function(o){return undefined}}),foam.u2.view.AnyView.Choice.create({label:"String",type:foam.String,view:foam.u2.TextField,toType:function(o){return o+""}}),foam.u2.view.AnyView.Choice.create({label:"Boolean",type:foam.Boolean,view:foam.u2.CheckBox,toType:function(o){return!!o}}),foam.u2.view.AnyView.Choice.create({label:"Number",type:foam.Number,view:foam.u2.FloatView,toType:function(o){return parseFloat(o)||0}}),foam.u2.view.AnyView.Choice.create({label:"Map",type:foam.Object,view:foam.u2.view.MapView,toType:function(o){return foam.Object.isInstance(o)?o:{}}}),foam.u2.view.AnyView.Choice.create({label:"FObject",type:foam.core.FObject,view:foam.u2.view.FObjectView,toType:function(o){return foam.core.FObject.isInstance(o)?o:foam.core.FObject.create()}}),foam.u2.view.AnyView.Choice.create({label:"Enum",type:foam.core.AbstractEnum,view:foam.u2.view.EnumView,toType:function(o){return foam.core.AbstractEnum.isInstance(o)?o:foam.core.AbstractEnum.create()}}),foam.u2.view.AnyView.Choice.create({label:"Array",type:foam.Array,view:foam.u2.view.ArrayView,toType:function(o){return foam.Array.isInstance(o)?o:[]}}),foam.u2.view.AnyView.Choice.create({label:"Date",type:foam.Date,view:foam.u2.DateTimeView,toType:function(o){if(foam.Date.isInstance(o))return o;return new Date(Date.parse(o)||Date.now())}})]}},{name:"selected",expression:function(data,types){var type=foam.typeOf(data);if(type==foam.core.FObject){if(foam.core.AbstractEnum.isInstance(data)){type=foam.core.AbstractEnum}}var choice=types.find(t=>type==t.type);if(!choice){console.warn("Unable to find view for type!");console.log(data)}return choice||types[0]}},{class:"Boolean",name:"enableChoice",value:true}],methods:[function render(){var self=this;this.start(self.Cols).callIf(this.enableChoice,function(){this.start(self.ChoiceView,{choices$:self.types$.map(types=>types.map(t=>[t,t.label])),data$:self.selected$}).style({"margin-right":"8px"}).end()}).start().style({flex:1}).add(this.slot(function(selected){return self.E().tag(selected.view,{data$:self.data$})})).end().end()}]});
foam.CLASS({package:"foam.u2.view",name:"ArrayView",extends:"foam.u2.View",requires:["foam.core.FObject","foam.u2.layout.Cols","foam.u2.layout.Rows"],exports:["enableRemoving","mode","updateData","updateDataWithoutFeedback"],properties:[{class:"foam.u2.ViewSpec",name:"valueView",value:{class:"foam.u2.view.AnyView"}},{name:"defaultNewItem",value:""},{class:"Boolean",name:"enableAdding",value:true},{class:"Boolean",name:"enableRemoving",value:true},{class:"Boolean",name:"allowDuplicates",value:true},{name:"disabledData_",expression:function(allowDuplicates,data){return allowDuplicates?[]:data}},{class:"Int",name:"arrayLength_",value:-1},{name:"data2_"},{class:"Boolean",name:"feedback_"}],actions:[{name:"addRow",label:"Add",isAvailable:function(mode,enableAdding){return enableAdding&&mode===foam.u2.DisplayMode.RW},isEnabled:function(allowDuplicates,data,arrayLength_){return allowDuplicates||data.length!==arrayLength_},code:function(){var newItem=this.defaultNewItem;if(this.FObject.isInstance(newItem)){newItem=newItem.clone()}this.data[this.data.length]=newItem;this.updateData()}}],classes:[{name:"Row",imports:["data","enableRemoving","mode","updateData","updateDataWithoutFeedback"],properties:[{class:"Int",name:"index",visibility:"RO"},{name:"value",postSet:function(_,n){if(this.data[this.index]===n)return;this.data[this.index]=n;this.updateDataWithoutFeedback()}}],actions:[{name:"remove",isAvailable:function(enableRemoving,mode){return enableRemoving&&mode===foam.u2.DisplayMode.RW},code:function(){this.data.splice(this.index,1);this.updateData()}}]}],css:`
^value-view {
flex: 1;
max-width: 100%;
}
^addButton.foam-u2-ActionView {
border: 1.5px dashed /*%GREY4%*/ #DADDE2;
justify-content: flex-start;
text-align: left;
width: 100%;
}
^value-view-container {
gap: 4px;
}
`,methods:[function render(){this.SUPER();var self=this;this.onDetach(this.data$.sub(()=>{if(!this.feedback_)this.data2_=this.data}));this.data2_=foam.Array.isInstance(this.data)&&this.data;this.addClass();this.add(this.slot(function(data2_,valueView){var data=data2_;return self.E().start(self.Rows).forEach(data||[],function(e,i){var row=self.Row.create({index:i,value:e});this.startContext({data:row}).start(self.Cols).addClass(self.myClass("value-view-container")).start(valueView,{data$:row.value$}).addClass(self.myClass("value-view")).end().tag(self.Row.REMOVE,{label:"",themeIcon:"close",icon:"data:image/svg+xml;utf8,%0A%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24'%3E%3Cpath d='M0 0h24v24H0z' fill='none'/%3E%3Cpath fill='%23d9170e' d='M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm5 11H7v-2h10v2z'/%3E%3C/svg%3E",buttonStyle:"TERTIARY"}).end().endContext();row.onDetach(row.sub(self.updateDataWithoutFeedback))})})).startContext({data:this}).add(this.slot(this.addAction)).endContext()},function addAction(){return this.E().start(this.ADD_ROW,{themeIcon:"plus",icon:"data:image/svg+xml;utf8,%0A%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24'%3E%3Cpath d='M0 0h24v24H0z' fill='none'/%3E%3Cpath fill='%2317d90e' d='M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm5 11h-4v4h-2v-4H7v-2h4V7h2v4h4v2z'/%3E%3C/svg%3E",buttonStyle:"TERTIARY"}).addClass(this.myClass("addButton")).end()}],listeners:[{name:"updateData",code:function(){this.data=foam.Array.shallowClone(this.data)}},{name:"updateDataWithoutFeedback",code:function(){this.feedback_=true;this.updateData();this.feedback_=false}}]});
foam.CLASS({package:"io.c9.ace",name:"Config",imports:["controllerMode?"],properties:[{class:"Int",name:"height",value:800},{class:"Int",name:"width",value:800},{class:"Enum",of:"io.c9.ace.Theme",name:"theme"},{class:"Enum",of:"io.c9.ace.Mode",name:"mode",value:"JAVA"},{class:"Enum",of:"io.c9.ace.KeyBinding",name:"keyBinding",value:"ACE"},{class:"Boolean",name:"isReadOnly",expression:function(controllerMode){return controllerMode===foam.u2.ControllerMode.VIEW}}]});
foam.CLASS({package:"io.c9.ace",name:"Editor",extends:"foam.u2.View",requires:["foam.u2.DetailView","foam.u2.tag.TextArea","io.c9.ace.Config"],imports:["warn"],reactions:[["container","onload","renderditor"],["config","propertyChange","updateEditor"],["","propertyChange.data","dataToEditor"]],properties:[{class:"Boolean",name:"preventFeedback"},{name:"container"},{name:"editor"},{class:"FObjectProperty",of:"io.c9.ace.Config",name:"config",factory:function(){return this.Config.create()}},{class:"Boolean",name:"showConfig"}],methods:[function render(){var self=this;this.add(this.slot(function(editor){return editor?null:self.TextArea.create({data$:self.data$,rows:20,cols:120,css:{"font-family":"monospace"}})})).start().style({display:this.editor$.map(e=>e?"block":"none")}).start("div",null,this.container$).style({height:this.config$.dot("height").map(h=>h+"px"),width:this.config$.dot("width").map(h=>h+"px")}).end().start("span").style({cursor:"pointer"}).add(self.showConfig$.map(b=>b?"Hide Editor Config":"Show Editor Config")).on("click",function(){self.showConfig=!self.showConfig}).end().add(this.slot(function(showConfig){return this.E().callIf(showConfig,function(){this.tag(self.DetailView,{data$:self.config$})})})).end()}],listeners:[function renderditor(){var self=this;io.c9.ace.Lib.ACE().then(function(ace){self.editor=ace.edit(self.container.id);self.editor.session.on("change",self.editorToData);self.updateEditor();self.dataToEditor()}).catch(function(){self.warn("Unable to load ace editor.")})},{name:"editorToData",isFramed:true,code:function(){if(!this.editor)return;this.preventFeedback=true;this.data=this.editor.session.getValue();this.preventFeedback=false}},{name:"dataToEditor",code:function(){if(!this.editor)return;if(this.preventFeedback)return;this.editor.session.setValue(this.data||"")}},function updateEditor(){if(!this.editor)return;this.editor.setTheme(this.config.theme.path);this.editor.setReadOnly(this.config.isReadOnly);this.editor.resize();this.editor.session.setMode(this.config.mode.path);this.editor.setKeyboardHandler(this.config.keyBinding.path)}]});foam.ENUM({package:"io.c9.ace",name:"KeyBinding",properties:["path"],values:[{path:null,name:"ACE"},{path:"ace/keyboard/vim",name:"VIN"},{path:"ace/keyboard/emacs",name:"EMACS"},{path:"ace/keyboard/sublime",name:"SUBLIME"}]});foam.LIB({name:"io.c9.ace.Lib",methods:[{name:"ACE",code:foam.Function.memoize0(function(){return new Promise(function(resolve,reject){var url=globalThis.FOAM_ROOT&&globalThis.FOAM_ROOT+"../node_modules/ace-builds/src-min-noconflict/ace.js"||"/ace.js";var script=document.createElement("script");script.onload=function(){resolve(ace)};script.onerror=reject;script.src=url;document.head.appendChild(script)})})}]});foam.ENUM({package:"io.c9.ace",name:"Mode",properties:["path"],values:[{path:"ace/mode/abap",label:"ABAP",name:"ABAP"},{path:"ace/mode/abc",label:"ABC",name:"ABC"},{path:"ace/mode/actionscript",label:"ActionScript",name:"ACTION_SRCRIPT"},{path:"ace/mode/ada",label:"ADA",name:"ADA"},{path:"ace/mode/apache_conf",label:"Apache Conf",name:"APACHE_CONF"},{path:"ace/mode/asciidoc",label:"AsciiDoc",name:"ASCII_DOC"},{path:"ace/mode/asl",label:"ASL",name:"ASL"},{path:"ace/mode/assembly_x86",label:"Assembly x86",name:"ASSEMLBY_X86"},{path:"ace/mode/autohotkey",label:"AutoHotkey / AutoIt",name:"AUTOHOTKEY_AUTOIT"},{path:"ace/mode/apex",label:"Apex",name:"APEX"},{path:"ace/mode/batchfile",label:"BatchFile",name:"BATACH_FILE"},{path:"ace/mode/bro",label:"Bro",name:"BRO"},{path:"ace/mode/c_cpp",label:"C and C++",name:"C_AND_CPP"},{path:"ace/mode/c9search",label:"C9Search",name:"C9_SEARCH"},{path:"ace/mode/cirru",label:"Cirru",name:"CIRRU"},{path:"ace/mode/clojure",label:"Clojure",name:"CLOJURE"},{path:"ace/mode/cobol",label:"Cobol",name:"COBOL"},{path:"ace/mode/coffee",label:"CoffeeScript",name:"COFFE_SCRIPT"},{path:"ace/mode/coldfusion",label:"ColdFusion",name:"COLD_FUSION"},{path:"ace/mode/csharp",label:"C#",name:"C"},{path:"ace/mode/csound_document",label:"Csound Document",name:"C_SOUND_DOCUMENT"},{path:"ace/mode/csound_orchestra",label:"Csound",name:"C_SOUND"},{path:"ace/mode/csound_score",label:"Csound Score",name:"C_SOUND_CORE"},{path:"ace/mode/css",label:"CSS",name:"CSS"},{path:"ace/mode/curly",label:"Curly",name:"CURLY"},{path:"ace/mode/d",label:"D",name:"D"},{path:"ace/mode/dart",label:"Dart",name:"DART"},{path:"ace/mode/diff",label:"Diff",name:"DIFF"},{path:"ace/mode/dockerfile",label:"Dockerfile",name:"DOCKER_FILE"},{path:"ace/mode/dot",label:"Dot",name:"DOT"},{path:"ace/mode/drools",label:"Drools",name:"DROOLS"},{path:"ace/mode/edifact",label:"Edifact",name:"EDIFACT"},{path:"ace/mode/eiffel",label:"Eiffel",name:"EIFFEL"},{path:"ace/mode/ejs",label:"EJS",name:"EJS"},{path:"ace/mode/elixir",label:"Elixir",name:"ELIXIR"},{path:"ace/mode/elm",label:"Elm",name:"ELM"},{path:"ace/mode/erlang",label:"Erlang",name:"ERLAND"},{path:"ace/mode/forth",label:"Forth",name:"FORTH"},{path:"ace/mode/fortran",label:"Fortran",name:"FORTRAN"},{path:"ace/mode/fsharp",label:"FSharp",name:"FSHARP"},{path:"ace/mode/fsl",label:"FSL",name:"FSL"},{path:"ace/mode/ftl",label:"FreeMarker",name:"FREE_MARKER"},{path:"ace/mode/gcode",label:"Gcode",name:"GCODE"},{path:"ace/mode/gherkin",label:"Gherkin",name:"GHERKIN"},{path:"ace/mode/gitignore",label:"Gitignore",name:"GIT_IGNORE"},{path:"ace/mode/glsl",label:"Glsl",name:"GLSL"},{path:"ace/mode/gobstones",label:"Gobstones",name:"GOBSTONES"},{path:"ace/mode/golang",label:"Go",name:"GO"},{path:"ace/mode/graphqlschema",label:"GraphQLSchema",name:"GRAPH_QLS_SCHEMA"},{path:"ace/mode/groovy",label:"Groovy",name:"GROOVY"},{path:"ace/mode/haml",label:"HAML",name:"HAML"},{path:"ace/mode/handlebars",label:"Handlebars",name:"HANDLE_BARS"},{path:"ace/mode/haskell",label:"Haskell",name:"HASKELL"},{path:"ace/mode/haskell_cabal",label:"Haskell Cabal",name:"HASKELL_CABAL"},{path:"ace/mode/haxe",label:"haXe",name:"HAXE"},{path:"ace/mode/hjson",label:"Hjson",name:"HJSON"},{path:"ace/mode/html",label:"HTML",name:"HTML"},{path:"ace/mode/html_elixir",label:"HTML (Elixir)",name:"HTML_ELIXIR"},{path:"ace/mode/html_ruby",label:"HTML (Ruby)",name:"HTML_RUBY"},{path:"ace/mode/ini",label:"INI",name:"INI"},{path:"ace/mode/io",label:"Io",name:"IO"},{path:"ace/mode/jack",label:"Jack",name:"JACK"},{path:"ace/mode/jade",label:"Jade",name:"JADE"},{path:"ace/mode/java",label:"Java",name:"JAVA"},{path:"ace/mode/javascript",label:"JavaScript",name:"JAVASCRIPT"},{path:"ace/mode/json",label:"JSON",name:"JSON"},{path:"ace/mode/jsoniq",label:"JSONiq",name:"JSON_IQ"},{path:"ace/mode/jsp",label:"JSP",name:"JSP"},{path:"ace/mode/jssm",label:"JSSM",name:"JSSM"},{path:"ace/mode/jsx",label:"JSX",name:"JSX"},{path:"ace/mode/julia",label:"Julia",name:"JULIA"},{path:"ace/mode/kotlin",label:"Kotlin",name:"KOTLIN"},{path:"ace/mode/latex",label:"LaTeX",name:"LATEX"},{path:"ace/mode/less",label:"LESS",name:"LESS"},{path:"ace/mode/liquid",label:"Liquid",name:"LIQUID"},{path:"ace/mode/lisp",label:"Lisp",name:"LISP"},{path:"ace/mode/livescript",label:"LiveScript",name:"LIVE_SCRIPT"},{path:"ace/mode/logiql",label:"LogiQL",name:"LOGIQL"},{path:"ace/mode/lsl",label:"LSL",name:"LSL"},{path:"ace/mode/lua",label:"Lua",name:"LUA"},{path:"ace/mode/luapage",label:"LuaPage",name:"LUA_PAGE"},{path:"ace/mode/lucene",label:"Lucene",name:"LUCENE"},{path:"ace/mode/makefile",label:"Makefile",name:"MAKE_FILE"},{path:"ace/mode/markdown",label:"Markdown",name:"MARK_DOWN"},{path:"ace/mode/mask",label:"Mask",name:"MASK"},{path:"ace/mode/matlab",label:"MATLAB",name:"MATLAB"},{path:"ace/mode/maze",label:"Maze",name:"MAZE"},{path:"ace/mode/mel",label:"MEL",name:"MEL"},{path:"ace/mode/mixal",label:"MIXAL",name:"MIXAL"},{path:"ace/mode/mushcode",label:"MUSHCode",name:"MUSHCode"},{path:"ace/mode/mysql",label:"MySQL",name:"MYSQL"},{path:"ace/mode/nix",label:"Nix",name:"NIX"},{path:"ace/mode/nsis",label:"NSIS",name:"NSIS"},{path:"ace/mode/objectivec",label:"Objective-C",name:"OBJECTIVE_C"},{path:"ace/mode/ocaml",label:"OCaml",name:"OCAML"},{path:"ace/mode/pascal",label:"Pascal",name:"PASCAL"},{path:"ace/mode/perl",label:"Perl",name:"PERL"},{path:"ace/mode/perl6",label:"Perl 6",name:"PERL6"},{path:"ace/mode/pgsql",label:"pgSQL",name:"PGSQL"},{path:"ace/mode/php_laravel_blade",label:"PHP (Blade Template)",name:"PHP_BLADE_TEMPLATE"},{path:"ace/mode/php",label:"PHP",name:"PHP"},{path:"ace/mode/puppet",label:"Puppet",name:"PUPPET"},{path:"ace/mode/pig",label:"Pig",name:"PIG"},{path:"ace/mode/powershell",label:"Powershell",name:"POWERSHELL"},{path:"ace/mode/praat",label:"Praat",name:"PRAAT"},{path:"ace/mode/prolog",label:"Prolog",name:"PROLOG"},{path:"ace/mode/properties",label:"Properties",name:"PROPERTIES"},{path:"ace/mode/protobuf",label:"Protobuf",name:"PROTOBUFF"},{path:"ace/mode/python",label:"Python",name:"PYTHON"},{path:"ace/mode/r",label:"R",name:"R"},{path:"ace/mode/razor",label:"Razor",name:"RAZOR"},{path:"ace/mode/rdoc",label:"RDoc",name:"R_DOC"},{path:"ace/mode/red",label:"Red",name:"RED"},{path:"ace/mode/rhtml",label:"RHTML",name:"RHTML"},{path:"ace/mode/rst",label:"RST",name:"RST"},{path:"ace/mode/ruby",label:"Ruby",name:"RUBY"},{path:"ace/mode/rust",label:"Rust",name:"RUST"},{path:"ace/mode/sass",label:"SASS",name:"SASS"},{path:"ace/mode/scad",label:"SCAD",name:"SCAD"},{path:"ace/mode/scala",label:"Scala",name:"SCALA"},{path:"ace/mode/scheme",label:"Scheme",name:"SCHEME"},{path:"ace/mode/scss",label:"SCSS",name:"SCSS"},{path:"ace/mode/sh",label:"SH",name:"SH"},{path:"ace/mode/sjs",label:"SJS",name:"SJS"},{path:"ace/mode/slim",label:"Slim",name:"SLIM"},{path:"ace/mode/smarty",label:"Smarty",name:"SMARTY"},{path:"ace/mode/snippets",label:"snippets",name:"SNIPPETS"},{path:"ace/mode/soy_template",label:"Soy Template",name:"SOY_TEMPLATE"},{path:"ace/mode/space",label:"Space",name:"SPACE"},{path:"ace/mode/sql",label:"SQL",name:"SQL"},{path:"ace/mode/sqlserver",label:"SQLServer",name:"SQLServer"},{path:"ace/mode/stylus",label:"Stylus",name:"STYLUS"},{path:"ace/mode/svg",label:"SVG",name:"SVG"},{path:"ace/mode/swift",label:"Swift",name:"SWIFT"},{path:"ace/mode/tcl",label:"Tcl",name:"TCL"},{path:"ace/mode/terraform",label:"Terraform",name:"TERRAFORM"},{path:"ace/mode/tex",label:"Tex",name:"TEX"},{path:"ace/mode/text",label:"Text",name:"TEXT"},{path:"ace/mode/textile",label:"Textile",name:"TEXTILE"},{path:"ace/mode/toml",label:"Toml",name:"TOML"},{path:"ace/mode/tsx",label:"TSX",name:"TSX"},{path:"ace/mode/twig",label:"Twig",name:"TWIG"},{path:"ace/mode/typescript",label:"Typescript",name:"TYPESCRIPT"},{path:"ace/mode/vala",label:"Vala",name:"VALA"},{path:"ace/mode/vbscript",label:"VBScript",name:"VBSCIPT"},{path:"ace/mode/velocity",label:"Velocity",name:"VELOCITY"},{path:"ace/mode/verilog",label:"Verilog",name:"VERILOG"},{path:"ace/mode/vhdl",label:"VHDL",name:"VHDL"},{path:"ace/mode/visualforce",label:"Visualforce",name:"VISUAL_FORCE"},{path:"ace/mode/wollok",label:"Wollok",name:"WOLLOK"},{path:"ace/mode/xml",label:"XML",name:"XML"},{path:"ace/mode/xquery",label:"XQuery",name:"XQUERY"},{path:"ace/mode/yaml",label:"YAML",name:"YAML"},{path:"ace/mode/django",label:"Django",name:"DJANGO"}]});foam.ENUM({package:"io.c9.ace",name:"Theme",values:[{path:"ace/theme/chrome",name:"CHROME"},{path:"ace/theme/clouds",name:"CLOUDS"},{path:"ace/theme/crimson_editor",name:"CRIMSON_EDITOR"},{path:"ace/theme/dawn",name:"DAWN"},{path:"ace/theme/dreamweaver",name:"DREAMWEAVER"},{path:"ace/theme/eclipse",name:"ECLIPSE"},{path:"ace/theme/github",name:"GITHUB"},{path:"ace/theme/iplastic",name:"IPLASTIC"},{path:"ace/theme/solarized_light",name:"SOLARIZED_LIGHT"},{path:"ace/theme/textmate",name:"TEXTMATE"},{path:"ace/theme/tomorrow",name:"TOMORROW"},{path:"ace/theme/xcode",name:"XCODE"},{path:"ace/theme/kuroir",name:"KUROIR"},{path:"ace/theme/katzenmilch",name:"KATZEN_MILCH"},{path:"ace/theme/sqlserver",name:"SQL_SERVER"},{path:"ace/theme/ambiance",name:"AMBIANCE"},{path:"ace/theme/chaos",name:"CHAOS"},{path:"ace/theme/clouds_midnight",name:"CLOUDS_MIDNIGHT"},{path:"ace/theme/dracula",name:"DRACULA"},{path:"ace/theme/cobalt",name:"COBALT"},{path:"ace/theme/gruvbox",name:"GRUVBOX"},{path:"ace/theme/gob",name:"GREEN_ON_BLACK"},{path:"ace/theme/idle_fingers",name:"IDLE_FINGERS"},{path:"ace/theme/kr_theme",name:"KR_THEME"},{path:"ace/theme/merbivore",name:"MERBIVORE"},{path:"ace/theme/merbivore_soft",name:"MERBIVORE_SOFT"},{path:"ace/theme/mono_industrial",name:"MONO_INDUSTRIAL"},{path:"ace/theme/monokai",name:"MONOKAI"},{path:"ace/theme/pastel_on_dark",name:"PASTEL_ON_DARK"},{path:"ace/theme/solarized_dark",name:"SOLOARIZED_DARK"},{path:"ace/theme/terminal",name:"TERMINAL"},{path:"ace/theme/tomorrow_night",name:"TOMORROW_NIGHT"},{path:"ace/theme/tomorrow_night_blue",name:"TOMORROW_NIGHT_BLUE"},{path:"ace/theme/tomorrow_night_bright",name:"TOMORROW_NIGHT_BRIGHT"},{path:"ace/theme/tomorrow_night_eighties",name:"TOMORROW_NIGHT_EIGHTIES"},{path:"ace/theme/twilight",name:"TWILIGHT"},{path:"ace/theme/vibrant_ink",name:"VIBRANT_INK"}],properties:["path"]});
foam.CLASS({package:"foam.u2.view.date",name:"AbstractDateView",extends:"foam.u2.View",properties:[{class:"DateTime",name:"data"},{class:"Int",name:"year",expression:function(data){if(!data||isNaN(data.getYear())){return(new Date).getYear()+1900}return data.getYear()+1900},preSet:function(old,nu){var regex=/^\d{4}$/;if(regex.test(nu))return nu;return old},postSet:function(_,n){var d=new Date(this.data);d.setYear(n);this.data=d;this.year=undefined}},{class:"Int",name:"monthIndex",expression:function(data){if(!data||isNaN(data.getMonth())){return(new Date).getMonth()}return data.getMonth()},postSet:function(_,n){var d=new Date(this.data);d.setMonth(n);this.data=d;this.monthIndex=undefined}},{class:"Enum",of:"foam.u2.view.date.Month",name:"month",expression:function(monthIndex){return this.Month.VALUES[monthIndex%this.Month.VALUES.length]},postSet:function(_,n){this.monthIndex=n.ordinal;this.month=undefined}},{class:"Int",name:"day",expression:function(data){if(!data||isNaN(data.getDate())){return(new Date).getDate()}return data.getDate()},postSet:function(_,n){var d=new Date(this.data);d.setDate(n);this.data=d;this.day=undefined}},{name:"hour24",expression:function(data){if(!data||isNaN(data.getDate())){return(new Date).getHours()}return data.getHours()},postSet:function(_,n){var d=new Date(this.data);d.setHours(n);this.data=d;this.hour24=undefined}},{name:"hour12",expression:function(hour24){var h=hour24%12||12;return(h<10?"0":"")+h},preSet:function(_,n){return parseInt(n)%12},postSet:function(_,n){this.hour24=n+(this.period=="pm"?12:0);this.hour12=undefined}},{name:"minute",expression:function(data){var m;if(!data||isNaN(data.getDate())){m=(new Date).getMinutes()}else{m=data.getMinutes()}return(m<10?"0":"")+m},postSet:function(_,n){var d=new Date(this.data);d.setMinutes(n);this.data=d;this.minute=undefined}},{name:"second",expression:function(data){if(!data||isNaN(data.getDate())){return(new Date).getSeconds()}return data.getSeconds()},postSet:function(_,n){var d=new Date(this.data);d.setSeconds(n);this.data=d;this.second=undefined}},{name:"period",view:{class:"foam.u2.view.ChoiceView",choices:["am","pm"]},expression:function(hour24){return hour24>=12?"pm":"am"},postSet:function(_,n){this.hour24=this.hour24+(n=="am"?-12:12);this.period=undefined}}],actions:[{name:"noon",code:function(){this.hour24=12;this.minute=0;this.second=0}}]});
foam.CLASS({package:"foam.u2.view.date",name:"RODateView",extends:"foam.u2.View",methods:[function render(){this.SUPER();this.start().addClass(this.myClass()).add(this.data$.map(d=>d?d.toLocaleDateString():foam.u2.DateView.DATE_FORMAT)).end()}]});
foam.CLASS({package:"foam.u2.view.date",name:"ROMillisecondView",extends:"foam.u2.View",methods:[function render(){this.SUPER();this.start().addClass(this.myClass()).add(this.data$.map(d=>d?new Date(d).toISOString():d)).end()}]});
foam.CLASS({package:"foam.u2.view.date",name:"CalendarDatePicker",extends:"foam.u2.Element",requires:["foam.u2.view.date.Weekday"],properties:[{class:"Date",name:"data"},{name:"nodeName",value:"table"},{class:"Boolean",name:"skipDateUpdate",value:false}],css:`
^selected_day_cell {
background-color: #e5f1fc;
}
^prev_month_cell, ^next_month_cell {
color: lightgray !important;
}
^calendar_table td {
text-align: center;
}
^calendar_table th {
cursor: default;
}
^calendar_table td {
cursor: pointer;
}
^calendar_table td:hover {
background-color: #F5F7FA;
}
^calendar_table tr > td {
border:1px solid #cbcfd4;
color: #5e6061;
padding: 6px 7px 6px 7px;
font-size: 1.4rem;
font-weight: 300;
}
^calendar_table  {
border-collapse: collapse;
width: 224px;
height: 160px;
}
^calendar_table tbody > tr > th {
font-size: 1rem;
color: #5e6061;
font-weight: 300;
font-style: normal;
font-stretch: normal;
line-height: 1.5;
letter-spacing: normal;
}
`,methods:[function daysInMonth(month,year){var d=new Date;d.setYear(year);d.setMonth(month+1);d.setDate(0);return d.getDate()},function startingWeekday(month,year){var d=new Date;d.setYear(year);d.setMonth(month);d.setDate(1);return d.getDay()},function weeksOfMonth(month,year){var weeks=[[]];var curWeekday=this.startingWeekday(month,year);var curDay=1;var daysInMonth=this.daysInMonth(month,year);while(curDay<=daysInMonth){weeks[weeks.length-1][curWeekday]=curDay;curDay++;curWeekday=(curWeekday+1)%this.Weekday.VALUES.length;if(curWeekday==0&&curDay<=daysInMonth)weeks.push([])}return weeks},function render(){var self=this;this.startContext({data:this.data}).addClass(this.myClass("calendar_table")).add(this.slot(function(data){data=data||new Date;var month=data.getMonth();var year=data.getYear()+1900;var prevMonthLastWeek=self.weeksOfMonth(month-1,year).pop().map(function(day){return self.E("td").add(day).on("click",function(){var d=new Date(data);d.setDate(1);d.setMonth(d.getMonth()-1);d.setDate(day);self.data=d}).addClass(self.myClass("prev_month_cell"))});var curMonthWeeks=self.weeksOfMonth(month,year).map(function(week){return week.map(function(day){return self.E("td").add(day).on("click",function(){var d=new Date(data);d.setDate(day);self.data=d}).addClass(day==data.getDate()?self.myClass("selected_day_cell"):"").addClass(self.myClass("cur_month_cell"))})});var nextMonthFirstWeek=self.weeksOfMonth(month+1,year).shift().map(function(day){return self.E("td").add(day).on("click",function(){var d=new Date(data);d.setDate(1);d.setMonth(d.getMonth()+1);d.setDate(day);self.data=d}).addClass(self.myClass("next_month_cell"))}).filter(function(d){return d});if(prevMonthLastWeek.length<7){prevMonthLastWeek=prevMonthLastWeek.concat(curMonthWeeks.shift())}if(nextMonthFirstWeek.length<7){nextMonthFirstWeek=curMonthWeeks.pop().concat(nextMonthFirstWeek)}var weeks=[].concat([prevMonthLastWeek],curMonthWeeks,[nextMonthFirstWeek]);return this.E("tbody").start("tr").forEach(self.Weekday.VALUES,function(wd){this.start("th").add(wd.label).end()}).end().forEach(weeks,function(w){this.start("tr").forEach(w,function(wd){this.add(wd)}).end()})})).endContext()}]});
foam.CLASS({package:"foam.u2.view.date",name:"DateTimePicker",extends:"foam.u2.view.date.AbstractDateView",requires:["foam.u2.view.date.CalendarDatePicker","foam.u2.view.date.Month","foam.u2.view.ChoiceView"],css:`
^date_time_picker input,
^date_time_picker select {
font-size: inherit;
}
^next_btn, ^prev_btn {
display: inline-block;
width: 31px;
height: 31px;
line-height: 31px;
background-color: lightgray;
margin: 1px;
text-align: center;
cursor: pointer;
-webkit-user-select: none;
-khtml-user-select: none;
-moz-user-select: none;
-ms-user-select: none;
user-select: none;
}
^ .date-time-picker {
display: inline-block;
width: 333px;
min-height: 304px;
text-align: center;
box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.08), 0 2px 8px 0 rgba(0, 0, 0, 0.16);
border: solid 1px #cbcfd4;
border-radius: 5px;
background-color: /*%WHITE%*/ #ffffff;
padding-bottom: 25px;
margin-top: 16px;
z-index: 100002;
position: absolute;
}
.time-of-day {
display: block;
justify-content: center;
font-size: medium;
}
^ .colon {
padding': '0 4px';
font-weight': 'bold;
}
^ .year {
border-radius: 5px 5px 0px 0px;
background-color: /*%PRIMARY3%*/ #406dea;
color: #ffffff;
display: inline-block;
align-items: center;
height: 47px;
width: 333px;
text-align: center;
}
^ .year .property-year {
padding-top:4px;
}
^ .year .property-year .foam-u2-IntView {
width: 70px;
text-align: center;
}
^ .year-number {
background: rgba(0,0,0,0);
border: none;
color: white;
display: inline-block;
font-size: large;
}
^ .arrow-left {
float: left;
padding: 10px;
margin-top: 10px;
margin-left: 23px;
}
^ .arrow-right {
float: right;
padding: 10px;
margin-top: 10px;
margin-right: 23px;
}
^ .month {
display: inline-block;
display: block;
align-items: center;
padding-top: 24px;
padding-bottom: 24px;
text-align: center;
}
^ .month-name {
padding-top: 3px;
padding-bottom: 3px;
display: inline-block;
font-weight: 500;
}
^ .arrow-container {
display: inline-block;
width: 24px;
height: 24px;
background-image: linear-gradient(#ffffff, #e7eaec);
text-align: center;
border: 1px solid #cbcfd4;
}
^ .arrow-container-left{
margin-left: 25px;
float: left;
}
.arrow-container-left:hover, .arrow-container-right:hover, .arrow-left:hover, .arrow-right:hover {
cursor: pointer;
}
^ .arrow-container-right{
margin-right: 25px;
float:right;
}
^ .arrow-black {
padding-top: 6px;
}
^ .calendar {
display: inline-block;
text-align: center;
}
^ .time-of-day {
display: inline-block;
}
^overlay {
position: fixed;
top: 0;
bottom: 0;
left: 0;
right: 0;
z-index: 10000;
}
^ .date-display-box {
height: 36px;
width: 100%;
font-size: 1.4rem;
background-color: /*%WHITE%*/ #ffffff;
border: 1px solid #cbcfd4;
border-radius: 3px;
}
^ .date-display-box:hover {
border-color: #9ba1a6;
}
^ .focus-border {
border-radius: 1px;
border: solid 1px #406dea;
box-shadow: inset 0 2px 1px 0 rgba(32, 46, 120, 0.42);
}
^ .date-display-text {
display: inline-block;
margin-top: 9px;
margin-left: 8px;
width: 176px;
height: 18px;
}
^ .date-display-image {
float: right;
display: inline-block;
margin-top: 10px;
margin-right: 8px;
position: relative;
}
^ .date-display-image-cancel {
z-index: 10001;
}
^ {
position: relative;
}
`,messages:[{name:"SELECT_DATE",message:"Select date"}],properties:[{type:"Boolean",name:"showTimeOfDay",value:false},{type:"String",name:"monthName",expression:function(month){return this.month.label}},{class:"Boolean",name:"isOpen_",value:false,},{class:"String",name:"date",expression:function(day,year,month){if(!this.data){return this.SELECT_DATE}return this.formatMonth(month.name)+" "+day+" "+year}},{class:"String",name:"dateTime",expression:function(day,year,month,hour12,minute,period){if(!this.data){return this.SELECT_DATE}return this.formatMonth(month.name)+" "+day+" "+year+", "+hour12+":"+minute+" "+period}},{class:"String",name:"icon",expression:function(isOpen_){return this.data&&isOpen_?"/images/cancel-round.svg":"/images/calendar.svg"}}],methods:[function render(){var zeroLeadingNumArray=function(start,end){var a=[];for(var i=start;i<=end;i++){a.push((i<10?"0":"")+i)}return a};if(!this.mode){this.mode=foam.u2.DisplayMode.RW}var self=this;this.start().addClass(this.myClass()).start().addClass("date-display-box").enableClass("focus-border",this.isOpen_$).call(function(){let display=self.showTimeOfDay?self.dateTime$:self.date$;this.start().addClass("date-display-text").add(display).end().start().addClass("date-display-image").enableClass("date-display-image-cancel",self.slot(function(icon){return icon==="/images/cancel-round.svg"})).start("img").attrs({src:self.icon$}).on("click",self.clearDate).end().end()}).on("click",function(){if(self.mode===foam.u2.DisplayMode.RW){self.isOpen_=!self.isOpen_}}).end().start().addClass(this.myClass("overlay")).show(this.isOpen_$).on("click",this.onCancel).end().startContext({data:this}).start().show(this.isOpen_$).addClass("date-time-picker").start().addClass("year").start("img").attrs({src:"/images/arrow-left-white.svg"}).addClass("arrow-left").on("click",this.updateDate).on("click",function(){self.year--}).end().start(this.YEAR,{type:""}).addClass("year-number").end().start("img").attrs({src:"/images/arrow-right-white.svg"}).addClass("arrow-right").on("click",this.updateDate).on("click",function(){self.year++}).end().end().start().addClass("month").start().addClass("arrow-container").addClass("arrow-container-left").on("click",this.updateDate).on("click",function(){self.monthIndex--}).start("img").attrs({src:"/images/arrow-left-black.svg"}).addClass("arrow-black").end().end().start().add(this.monthName$).addClass("month-name").end().start().addClass("arrow-container").addClass("arrow-container-right").on("click",this.updateDate).on("click",function(){self.monthIndex++}).start("img").attrs({src:"/images/arrow-right-black.svg"}).addClass("arrow-black").end().end().end().start().addClass("calendar").start(this.CalendarDatePicker,{data$:this.data$}).end().on("click",function(){if(self.mode===foam.u2.DisplayMode.RW){self.isOpen_=!self.isOpen_}}).end().start().addClass("time-of-day").show(this.showTimeOfDay$).start(this.ChoiceView,{choices:zeroLeadingNumArray(1,12),data$:this.hour12$}).on("click",this.updateDate).addClass("time-of-day").attrs({size:2,maxlength:2}).end().start().add(":").addClass("colon").addClass("time-of-day").end().start(this.ChoiceView,{choices:zeroLeadingNumArray(0,59),data$:this.minute$}).on("click",this.updateDate).attrs({size:2,maxlength:2}).addClass("time-of-day").end().start().add(this.PERIOD).on("click",this.updateDate).addClass("time-of-day").end().end().end().endContext().end()},function formatMonth(month){return month[0]+month.slice(1).toLowerCase()}],listeners:[function onCancel(){this.isOpen_=false},function clearDate(event){if(this.icon==="images/cancel-round.svg"){event.stopPropagation();this.data=null;this.isOpen_=false}},function updateDate(){if(!this.data||this.data===undefined){this.data=new Date}}]});foam.ENUM({package:"foam.u2.view.date",name:"Month",values:[{name:"JAN",label:"January"},{name:"FEB",label:"February"},{name:"MAR",label:"March"},{name:"APR",label:"April"},{name:"MAY",label:"May"},{name:"JUN",label:"June"},{name:"JUL",label:"July"},{name:"AUG",label:"August"},{name:"SEP",label:"September"},{name:"OCT",label:"October"},{name:"NOV",label:"November"},{name:"DEC",label:"December"}]});foam.ENUM({package:"foam.u2.view.date",name:"Weekday",values:[{name:"SU",label:"Su"},{name:"MO",label:"Mo"},{name:"TU",label:"Tu"},{name:"WE",label:"We"},{name:"TH",label:"Th"},{name:"FR",label:"Fr"},{name:"SA",label:"Sa"}]});
foam.CLASS({package:"foam.u2.view",name:"DAOtoFObjectArrayView",extends:"foam.u2.Controller",requires:["foam.u2.stack.Stack","foam.dao.ArrayDAO"],exports:["stack"],css:`
^ .foam-u2-stack-StackView {
height: auto;
}
`,properties:[{name:"stack",view:{class:"foam.u2.stack.StackView",showActions:false},factory:function(){return this.Stack.create()}},{class:"foam.u2.ViewSpec",name:"daoView",factory:function(){return foam.u2.view.EmbeddedTableView}},{name:"dao",factory:function(){return this.ArrayDAO.create({of:this.of,array$:this.data$})}},"of"],methods:[function fromProperty(p){this.of=p.of},function render(){var self=this;this.SUPER();this.addClass();this.start(this.daoView,{data:this.dao}).end()}]});foam.ENUM({package:"foam.u2.layout",name:"DisplayWidth",values:[{name:"XXS",minWidth:0,cols:4},{name:"XS",minWidth:320,cols:6},{name:"SM",minWidth:576,cols:12},{name:"MD",minWidth:768,cols:12},{name:"LG",minWidth:960,cols:12},{name:"XL",minWidth:1280,cols:12}],properties:[{class:"Int",name:"cols"},{class:"Int",name:"minWidth"},{class:"String",name:"minWidthString",expression:function(minWidth){return minWidth+"px"}}]});
foam.CLASS({package:"foam.u2.layout",name:"Rows",extends:"foam.u2.Element",css:`
^ {
display: flex;
flex-direction: column;
justify-content: space-between;
align-items: stretch;
}
`,methods:[function render(){this.SUPER();this.addClass()}]});
foam.CLASS({package:"foam.u2.layout",name:"Cols",extends:"foam.u2.Element",css:`
^ {
display: flex;
justify-content: space-between;
align-items: stretch;
}
`,methods:[function render(){this.SUPER();this.addClass()}]});
foam.CLASS({package:"foam.u2.layout",name:"Grid",extends:"foam.u2.Element",imports:["displayWidth?"],requires:["foam.u2.layout.GUnit"],css:`
^ {
display: grid;
grid-gap: 24px 12px;
}
`,listeners:[{name:"resizeChildren",isFramed:true,code:function(){this.shown=false;var currentWidth=0;this.childNodes.forEach(ret=>{var cols=12,width=12;if(this.displayWidth){cols=this.displayWidth.cols;width=Math.min(this.GUnit.isInstance(ret)&&ret.columns&&ret.columns[`${this.displayWidth.name.toLowerCase()}Columns`]||cols,cols)}var startCol=currentWidth+1;currentWidth+=width;if(currentWidth>cols){startCol=1;currentWidth=width}var endCol=startCol+width;ret.style({"grid-column":`${startCol} / ${endCol}`})});this.shown=true}}],methods:[function render(){this.SUPER();this.addClass();if(this.displayWidth){this.onDetach(this.displayWidth$.sub(this.resizeChildren));this.style({"grid-template-columns":this.displayWidth$.map(dw=>{dw=dw||foam.u2.layout.DisplayWidth.XL;return`repeat(${dw.cols}, 1fr)`})});this.shown=false}},function onAddChildren(){this.resizeChildren()}]});
foam.CLASS({package:"foam.u2.layout",name:"Card",extends:"foam.u2.layout.GUnit",css:`
^ {
padding: 8px;
border-radius: 6px;
box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.08);
border: solid 1px #e7eaec;
background-color: /*%WHITE%*/ #ffffff;
}
`,methods:[function render(){this.addClass();this.SUPER()}]});
foam.CLASS({package:"foam.u2.layout",name:"GUnit",extends:"foam.u2.Element",requires:["foam.u2.layout.GridColumns"],properties:[{class:"FObjectProperty",of:"foam.u2.layout.GridColumns",name:"columns",adapt:function(o,n,p){n=foam.Number.isInstance(n)?{columns:n}:n;return foam.core.FObjectProperty.ADAPT.value.call(this,o,n,p)}}]});
foam.CLASS({package:"foam.u2.layout",name:"GridColumns",extends:"foam.u2.Element",properties:[{class:"Int",name:"columns",value:12},{class:"Int",name:"xxsColumns",expression:function(columns){return Math.min(8,columns)}},{class:"Int",name:"xsColumns",expression:function(columns){return Math.min(8,columns)}},{class:"Int",name:"smColumns",expression:function(columns){return columns}},{class:"Int",name:"mdColumns",expression:function(columns){return columns}},{class:"Int",name:"lgColumns",expression:function(columns){return columns}},{class:"Int",name:"xlColumns",expression:function(columns){return columns}}]});
foam.CLASS({package:"foam.u2.layout",name:"PropertyGridRefinement",refines:"foam.core.Property",properties:[{name:"gridColumns",value:12}]});
foam.CLASS({package:"foam.comics.v2",name:"CannedQuery",properties:[{class:"String",name:"name",hidden:true,expression:function(label){return label.replace(/[^0-9a-z]/gi,"")+"__CannedQuery"}},{class:"String",name:"label"},{class:"foam.mlang.predicate.PredicateProperty",name:"predicate",expression:function(predicateFactory){return predicateFactory?predicateFactory(foam.mlang.ExpressionsSingleton.create()):null}},{name:"predicateFactory",hidden:true}]});foam.INTERFACE({package:"foam.comics.v2",name:"EnabledActionsAuth",methods:[{name:"getModelName",type:"String"},{name:"setModelName",args:[{name:"value",type:"String"}]},{name:"permissionFactory",type:"String",args:[{name:"operation",type:"foam.nanos.dao.Operation"},{name:"obj",type:"FObject"}]}]});
foam.CLASS({package:"foam.comics.v2",name:"BasicEnabledActionsAuth",implements:["foam.comics.v2.EnabledActionsAuth"],properties:[{class:"String",name:"modelName"}],methods:[{name:"permissionFactory",type:"String",args:[{name:"operation",type:"foam.nanos.dao.Operation"},{name:"obj",type:"FObject"}],code:function(operation,obj){let outputString=this.modelName.toLowerCase();if(operation===foam.nanos.dao.Operation.CREATE){outputString+=".create"}else if(operation===foam.nanos.dao.Operation.UPDATE){outputString+=".update."+obj.id}else if(operation===foam.nanos.dao.Operation.REMOVE){outputString+=".remove."+obj.id}else{throw new Error("Unsupported operation: "+operation.label)}return outputString}}]});
foam.CLASS({package:"foam.comics.v2",name:"CRUDEnabledActionsAuth",properties:[{class:"Boolean",name:"isEnabled"},{class:"FObjectProperty",of:"foam.comics.v2.EnabledActionsAuth",name:"enabledActionsAuth"}]});
foam.CLASS({package:"foam.comics.v2",name:"DAOBrowseControllerView",extends:"foam.u2.View",mixins:["foam.u2.memento.Memorable"],imports:["auth","currentMenu?","stack","translationService"],exports:["config","click","route as currentControllerMode","setControllerMode"],requires:["foam.comics.v2.DAOBrowserView","foam.u2.borders.CardBorder","foam.u2.layout.Cols","foam.u2.layout.Rows","foam.u2.stack.BreadcrumbView","foam.u2.stack.StackBlock","foam.u2.view.IconChoiceView","foam.u2.view.OverlayActionListView"],css:`
^container {
padding: 36px 16px 8px 16px;
height: 100%;
box-sizing: border-box;
}
^header-container {
padding-bottom: 32px;
align-items: center;
}
^altview-container {
position: absolute;
right: 0;
padding: 12px 16px 0 0;
}
^buttons{
margin-right: 8px;
}
^ .foam-u2-borders-CardBorder {
border: 1px solid /*%GREY4%*/ #DADDE2;
border-radius: 4px;
box-sizing: border-box;
box-shadow: 0px 1px 2px rgba(0, 0, 0, 0.06), 0px 1px 3px rgba(0, 0, 0, 0.1);
height: 100%;
padding: 0;
}
@media only screen and (min-width: 768px) {
^container {
padding: 24px 32px 16px 32px;
}
}
`,messages:[{name:"VIEW_ALL",message:"View all "},{name:"ACTIONS",message:"Actions"}],properties:[{name:"route",memorable:true,value:"browse"},{class:"foam.dao.DAOProperty",name:"data"},{class:"FObjectProperty",of:"foam.comics.v2.DAOControllerConfig",name:"config",factory:function(){return foam.comics.v2.DAOControllerConfig.create({dao:this.data})}},{class:"foam.u2.ViewSpec",name:"browseView",expression:function(config$browseViews){return config$browseViews&&config$browseViews.length?config$browseViews[0].view:this.DAOBrowserView}},{class:"Boolean",name:"showNav",value:true},{name:"viewTitle",expression:function(config){var menuID=this.currentMenu?this.currentMenu.id:config.of.id;return this.translationService.getTranslation(foam.locale,menuID+".browseTitle",config.browseTitle)}},{name:"click",expression:function(config$click){if(this.config.click&&typeof this.config.click==="function")return this.config.click;return function(obj,id){if(!this.stack){console.warn("Missing stack, can not push view");return}this.stack.push(foam.u2.stack.StackBlock.create({view:{class:"foam.comics.v2.DAOSummaryView",data:obj,config:this.config||this.__subContext__.config,idOfRecord:id},parent:this.__subContext__},this))}}}],actions:[{name:"create",isEnabled:function(config,data){if(config.CRUDEnabledActionsAuth&&config.CRUDEnabledActionsAuth.isEnabled){try{let permissionString=config.CRUDEnabledActionsAuth.enabledActionsAuth.permissionFactory(foam.nanos.dao.Operation.CREATE,data);return this.auth.check(null,permissionString)}catch(e){return false}}return true},isAvailable:function(config){try{return config.createPredicate.f()}catch(e){return false}},code:function(){if(!this.stack)return;if(this.config.createController.class==="foam.comics.v2.DAOCreateView"){this.stack.push(this.StackBlock.create({view:{class:this.config.createController.class,data:(this.config.factory||this.data.of).create({mode:"create"},this),config$:this.config$,of:this.data.of},parent:this,popup:this.config.createPopup}))}else if(this.config.createControllerView){this.stack.push(this.StackBlock.create({view:this.config.createControllerView,parent:this,popup:this.config.createPopup}))}else{this.stack.push(this.StackBlock.create({view:{class:this.config.createController.class,config$:this.config$,of:this.data.of,data:this.selection,detailView:this.config.detailView.class,menu:this.config.menu,controllerMode:foam.u2.ControllerMode.CREATE,isEdit:true},parent:this,popup:this.config.createPopup}))}}}],methods:[function setControllerMode(mode){this.route=mode},async function render(){this.SUPER();var self=this;if(this.route!="browse"&&(this.route=="view"||this.route=="edit")){let b=this.memento_.createBindings(this.memento_.tailStr);let idCheck=false;if(b.length&&b[0][0]=="route"&&b[0][1]){idCheck=!!await this.data.find(b[0][1])}if(idCheck){self.click.call(this,null,null)}else{this.route="browse"}}else{this.route="browse"}var menuId=this.currentMenu?this.currentMenu.id:this.config.of.id;var nav=this.showNav?self.BreadcrumbView:"";this.addClass().add(this.slot(function(data,config,config$of,config$browseBorder,config$browseViews,config$browseTitle,config$primaryAction,config$createTitle,config$createControllerView){return self.E().start(self.Rows).addClass(self.myClass("container")).start().addClass(self.myClass("header-container")).tag(nav).start(self.Cols).start().addClasses(["h100",self.myClass("browse-title")]).translate(menuId+".browseTitle",config$browseTitle).end().start(self.Cols).add(this.slot(function(config$browseContext){return this.E().callIf(config.browseActions.length&&config.browseContext,function(){if(config.browseActions.length>2){this.start(self.OverlayActionListView,{label:this.ACTIONS,data:config.browseActions,obj:config$browseContext}).addClass(self.myClass("buttons")).end()}else{var actions=this.E().addClass(self.myClass("buttons")).startContext({data:config.browseContext});for(action of config.browseActions){actions.tag(action,{size:"LARGE"})}this.add(actions.endContext())}})})).callIf(!config.detailView,function(){this.startContext({data:self}).tag(self.CREATE,{label:this.translationService.getTranslation(foam.locale,menuId+".createTitle",config$createTitle),buttonStyle:foam.u2.ButtonStyle.PRIMARY,size:"LARGE"}).endContext()}).callIf(config.createControllerView,function(){this.startContext({data:self}).tag(self.CREATE,{label:this.translationService.getTranslation(foam.locale,menuId+".handler.createControllerView.view.title",config$createControllerView.view.title),buttonStyle:foam.u2.ButtonStyle.PRIMARY,size:"LARGE"}).endContext()}).callIf(config$primaryAction,function(){this.startContext({data:self}).tag(config$primaryAction,{size:"LARGE",buttonStyle:"PRIMARY"}).endContext()}).end().end().end().start(self.CardBorder).style({position:"relative","min-height":config.minHeight+"px"}).start(config$browseBorder).callIf(config$browseViews.length>1&&config.cannedQueries.length>0,function(){this.start(self.IconChoiceView,{choices:config$browseViews.map(o=>[o.view,o.icon]),data$:self.browseView$}).addClass(self.myClass("altview-container")).end()}).call(function(){this.add(self.slot(function(browseView){return self.E().tag(browseView,{data:data,config:config})}))}).end().end().end()}))}]});
foam.CLASS({package:"foam.comics.v2",name:"DAOBrowserView",extends:"foam.u2.View",requires:["foam.comics.SearchMode","foam.comics.v2.DAOControllerConfig","foam.log.LogLevel","foam.u2.ActionView","foam.u2.dialog.Popup","foam.u2.filter.FilterView","foam.u2.layout.Cols","foam.u2.layout.DisplayWidth","foam.u2.layout.Rows","foam.u2.stack.StackBlock","foam.u2.view.OverlayActionListView","foam.u2.view.ScrollTableView","foam.u2.view.SimpleSearch","foam.u2.view.TabChoiceView"],implements:["foam.mlang.Expressions"],css:`
^wrapper {
box-sizing: border-box;
height: 100%;
justify-content: flex-start;
background-color:/*%WHITE%*/ #ffffff;
}
^top-bar {
border-bottom: solid 1px #e7eaec;
align-items: center;
padding-top: 16px;
}
^toolbar {
flex-grow: 1;
}
^query-bar {
padding: 12px 24px;
padding-top: 32px;
}
^buttons{
gap: 0.5em;
align-items: flex-start;
}
^filters{
padding: 0 24px;
padding-bottom: 12px;
}
^browse-view-container {
box-sizing: border-box;
display: flex;
flex-direction: column;
height: 100%;
overflow: hidden;
}
^actions svg {
height: 1em;
width: 1em;
}
/*
Scroll is handled here to ensure summaryView always has a scroll
even if it is not configured in the summaryView.
This is the generalised way to do this but should be removed
if double scroll bars start appearing
*/
^browse-view-container > * {
height: 100%;
overflow: auto;
}
^canned-queries {
padding: 0 16px;
}
^ .foam-u2-view-TableView th {
background: #ffffff
}
^ .foam-u2-view-TableView td {
padding-left: 16px;
}
^ .foam-u2-view-SimpleSearch {
flex-grow: 1;
}
^ .foam-u2-view-SimpleSearch input {
width: 100%;
height: 34px;
border-radius: 0 5px 5px 0;
border: 1px solid;
}
`,messages:[{name:"REFRESH_MSG",message:"Refresh Requested... "},{name:"ACTIONS",message:"Actions"}],imports:["auth","ctrl","displayWidth","exportDriverRegistryDAO","stack?"],exports:["config","data as dao","filteredTableColumns","searchColumns","serviceName"],properties:[{class:"StringArray",name:"filteredTableColumns"},{class:"foam.dao.DAOProperty",name:"data"},{class:"FObjectProperty",of:"foam.comics.v2.DAOControllerConfig",name:"config",factory:function(){return this.DAOControllerConfig.create({dao:this.data})}},{class:"StringArray",name:"searchColumns",factory:null,expression:function(config$searchColumns){return config$searchColumns}},{class:"foam.u2.ViewSpec",name:"summaryView",expression:function(config$summaryView){return config$summaryView}},{class:"foam.u2.ViewSpec",name:"cannedQueriesView",factory:function(){return{class:"foam.u2.view.TabChoiceView"}}},{class:"foam.mlang.predicate.PredicateProperty",name:"cannedPredicate",expression:function(config$cannedQueries,config$preSelectedCannedQuery){return config$cannedQueries&&config$cannedQueries.length?config$preSelectedCannedQuery!=null?config$cannedQueries[config$preSelectedCannedQuery].predicate:config$cannedQueries[1].predicate:foam.mlang.predicate.True.create()}},{class:"foam.mlang.predicate.PredicateProperty",name:"searchPredicate",expression:function(config$searchPredicate){return config$searchPredicate?config$searchPredicate:foam.mlang.predicate.True.create()}},{class:"foam.dao.DAOProperty",name:"predicatedDAO",expression:function(config,cannedPredicate,searchPredicate){var predicate=this.AND(cannedPredicate,searchPredicate);return config.dao$proxy.where(predicate)}},{class:"foam.dao.DAOProperty",name:"searchFilterDAO",expression:function(config,cannedPredicate){return config.dao$proxy.where(cannedPredicate)}},{name:"serviceName",class:"String",factory:function(){return this.data&&this.data.serviceName?this.data.serviceName:this.config.daoKey}},{name:"importModal",factory:function(){return{class:"foam.nanos.google.api.sheets.views.modal.ImportFromGoogleSheetsForm",of:this.config.of,dao:this.serviceName||this.data.delegate.serviceName}}},{class:"Int",name:"maxActions",expression:function(displayWidth){return displayWidth.minWidth<this.DisplayWidth.MD.minWidth?0:displayWidth.minWidth<this.DisplayWidth.LG.minWidth?1:3}}],actions:[{name:"export",label:"Export",toolTip:"Export Table Data",icon:"images/export-arrow-icon.svg",isAvailable:async function(config){if(!config.exportPredicate.f())return false;var records=await this.exportDriverRegistryDAO.select();return records&&records.array&&records.array.length!=0},code:function(X){var adao;if(this.config?.summaryView?.selectedObjects&&!foam.Object.equals(this.config.summaryView.selectedObjects,{})){adao=foam.dao.ArrayDAO.create({of:this.data.of});foam.Object.forEach(this.config.summaryView.selectedObjects,function(y){adao.put(y)})}this.add(this.Popup.create(null,X).tag({class:"foam.u2.ExportModal",exportData:adao?adao:this.predicatedDAO$proxy,predicate:this.config.filterExportPredicate}))}},{name:"refreshTable",label:"Refresh",toolTip:"Refresh Table",icon:"images/refresh-icon-black.svg",isAvailable:function(config){if(!config.refreshPredicate.f())return false;return true},code:function(X){this.config.dao.cmd_(X,foam.dao.DAO.PURGE_CMD);this.config.dao.cmd_(X,foam.dao.DAO.RESET_CMD);this.ctrl.notify(this.REFRESH_MSG,"",this.LogLevel.INFO,true,"/images/Progress.svg")}},{name:"import",label:"Import",icon:"images/import-arrow-icon.svg",availablePermissions:["data.import.googleSheets"],toolTip:"Import From Google Sheet",isAvailable:function(config){if(!config.importPredicate.f())return false;return true},code:function(X){this.add(this.Popup.create(null,X).tag(this.importModal))}}],methods:[function init(){this.onDetach(this.cannedPredicate$.sub(()=>{this.searchPredicate=foam.mlang.predicate.True.create()}))},function render(){[this.EXPORT,this.IMPORT,this.REFRESH_TABLE].forEach(action=>{if(this.config.DAOActions.indexOf(action)===-1)this.config.DAOActions.push(action)});this.data=foam.dao.QueryCachingDAO.create({delegate:this.config.dao});var self=this;var filterView,cannedView,summaryView;var simpleSearch;this.addClass();this.SUPER();this.add(this.slot(function(config$cannedQueries,config$hideQueryBar){if(self.config.searchMode===self.SearchMode.SIMPLE){var simpleSearch=foam.u2.ViewSpec.createView(self.SimpleSearch,{showCount:false,data$:self.searchPredicate$},this,self.__subSubContext__.createSubContext({controllerMode:foam.u2.ControllerMode.EDIT}));var filterView=foam.u2.ViewSpec.createView(self.FilterView,{dao$:self.searchFilterDAO$,data$:self.searchPredicate$},this,self.__subContext__.createSubContext({controllerMode:foam.u2.ControllerMode.EDIT}))}else{var filterView=foam.u2.ViewSpec.createView(self.FilterView,{dao$:self.searchFilterDAO$,data$:self.searchPredicate$},this,self.__subContext__.createSubContext({controllerMode:foam.u2.ControllerMode.EDIT}))}if(config$cannedQueries.length>=1){cannedView=foam.u2.ViewSpec.createView(self.cannedQueriesView,{choices:config$cannedQueries.map(o=>[o.predicate,o.label]),data$:self.cannedPredicate$},this,filterView.__subContext__)}var summaryContext=cannedView?cannedView.__subContext__:filterView.__subContext__;summaryView=foam.u2.ViewSpec.createView(self.summaryView,{data:self.predicatedDAO$proxy,config:self.config},this,summaryContext);if(!self.config.browseContext){self.config.browseContext=summaryView}if(summaryView.selectedObjects)self.config.selectedObjs$=summaryView.selectedObjects$;var buttonStyle={buttonStyle:"SECONDARY",size:"SMALL",isIconAfter:true};return self.E().start(self.Rows).addClass(this.myClass("wrapper")).callIf(config$cannedQueries.length>=1,function(){this.start(self.Cols).addClass(self.myClass("top-bar")).start(self.Cols).callIf(config$cannedQueries.length>1,function(){this.start(cannedView).addClass(self.myClass("canned-queries")).end()}).end().end()}).callIf(!config$hideQueryBar,function(){this.start(self.Cols).addClass(self.myClass("query-bar")).startContext({dao:self.searchFilterDAO}).callIf(self.config.searchMode===self.SearchMode.SIMPLE,function(){this.add(simpleSearch)}).callIf(self.config.searchMode===self.SearchMode.FULL,function(){this.add(filterView)}).endContext().start(self.Cols).addClass(self.myClass("buttons")).add(self.maxActions$.map(function(maxActions){var visibleActions;if(self.config.DAOActions.length>Math.max(1,self.maxActions)){var extraActions=self.config.DAOActions.slice(self.maxActions);visibleActions=self.config.DAOActions.slice(0,self.maxActions)}else{visibleActions=self.config.DAOActions}var el=self.E();var actions=el.addClass(self.myClass("buttons")).startContext({data:self,controllerMode:foam.u2.ControllerMode.EDIT});for(action of visibleActions){actions.start(action,buttonStyle).addClass(self.myClass("actions")).end()}if(extraActions&&extraActions.length){el.start(self.OverlayActionListView,{label:self.ACTIONS,data:extraActions,obj:self}).addClass(self.myClass("buttons")).end()}return el.endContext()})).end().end().start().tag(filterView.filtersContainer$).addClass(self.myClass("filters")).end()}).start().add(summaryView).addClass(self.myClass("browse-view-container")).end().end()}))}]});
foam.CLASS({package:"foam.comics.v2",name:"DAOControllerConfig",requires:["foam.comics.SearchMode","foam.comics.v2.CannedQuery","foam.comics.v2.namedViews.NamedViewCollection"],messages:[{name:"VIEW_ALL",message:"View all "},{name:"CREATE_NEW",message:"Create a New "}],properties:[{name:"click",adapt:function(_,n){if(typeof n==="function")return n;var lastIndex=n.lastIndexOf(".");var classObj=foam.lookup(n.substring(0,lastIndex));return classObj[n.substring(lastIndex+1)]}},{class:"String",name:"daoKey"},{class:"Class",name:"factory"},{class:"FObjectProperty",of:"foam.mlang.predicate.Predicate",name:"predicate",view:{class:"foam.u2.view.JSONTextView"}},{class:"foam.dao.DAOProperty",name:"dao",hidden:true,expression:function(daoKey,predicate){var dao=this.__context__[daoKey]||foam.dao.NullDAO.create({of:foam.core.FObject});if(this.hasOwnProperty("of")){dao=foam.dao.ProxyDAO.create({of:this.of,delegate:dao})}if(predicate){dao=dao.where(predicate)}return dao}},{class:"foam.dao.DAOProperty",name:"unfilteredDAO",hidden:true,expression:function(dao){var delegate=dao;while(delegate&&foam.dao.ProxyDAO.isInstance(delegate)){if(foam.dao.FilteredDAO.isInstance(delegate)){return delegate.delegate}delegate=delegate.delegate}return dao}},{class:"Class",name:"of",expression:function(dao$of){return dao$of}},{class:"String",name:"browseTitle",factory:function(){return this.of.model_.plural}},{class:"FObjectProperty",name:"primaryAction",value:null},{class:"foam.u2.ViewSpec",name:"createView",factory:function(){return{class:"foam.u2.view.FObjectView",detailView:{class:"foam.u2.detail.SectionedDetailView"}}}},{class:"foam.u2.ViewSpec",name:"browseController",factory:function(){return{class:"foam.comics.v2.DAOBrowseControllerView"}}},{class:"foam.u2.ViewSpec",name:"summaryView",expression:function(tableColumns){return{class:"foam.u2.table.TableView",editColumnsEnabled:true,columns:tableColumns,css:{width:"100%"}}}},{class:"String",name:"createTitle",expression:function(of){return this.CREATE_NEW+of.model_.label}},{class:"Array",name:"tableColumns",factory:null,expression:function(of){var tableColumns=of.getAxiomByName("tableColumns");return tableColumns?tableColumns.columns:of.getAxiomsByClass(foam.core.Property).map(p=>p.name)}},{class:"StringArray",name:"searchColumns",factory:null,expression:function(of,tableColumns){var tableSearchColumns=of.getAxiomByName("searchColumns");var filteredDefaultColumns=tableColumns.filter(c=>{if(c.split(".").length>1)return false;var a=of.getAxiomByName(c);if(!a)console.warn("Column does not exist for "+of.name+": "+c);return a&&!a.storageTransient&&!a.networkTransient&&a.searchView&&!a.hidden});var allProps=of.getAxiomsByClass(foam.core.Property).filter(p=>{return!p.storageTransient&&!p.networkTransient&&p.searchView&&!p.hidden});return tableSearchColumns?tableSearchColumns.columns:filteredDefaultColumns?filteredDefaultColumns:allProps}},{class:"Enum",of:"foam.comics.SearchMode",name:"searchMode",help:`
The level of search capabilities that the controller should have.
`,value:"FULL"},{class:"foam.u2.ViewSpec",name:"browseBorder",factory:function(){return{class:"foam.u2.borders.NullBorder"}}},{class:"FObjectArray",of:"foam.comics.v2.namedViews.NamedViewCollection",name:"browseViews",factory:null,expression:function(of){return of&&of.getAxiomsByClass(this.NamedViewCollection)}},{class:"FObjectArray",of:"foam.comics.v2.CannedQuery",name:"cannedQueries",factory:null,expression:function(of){return of&&of.getAxiomsByClass(this.CannedQuery)}},{class:"foam.u2.ViewSpec",name:"viewBorder",factory:function(){return{class:"foam.u2.borders.NullBorder"}}},{class:"foam.mlang.predicate.PredicateProperty",name:"createPredicate",factory:function(){return foam.mlang.predicate.True.create()},},{class:"foam.mlang.predicate.PredicateProperty",name:"editPredicate",factory:function(){return foam.mlang.predicate.True.create()},},{class:"foam.mlang.predicate.PredicateProperty",name:"deletePredicate",factory:function(){return foam.mlang.predicate.True.create()},},{class:"foam.mlang.predicate.PredicateProperty",name:"refreshPredicate",factory:function(){return foam.mlang.predicate.True.create()},},{class:"foam.mlang.predicate.PredicateProperty",name:"exportPredicate",factory:function(){return foam.mlang.predicate.True.create()},},{class:"foam.mlang.predicate.PredicateProperty",name:"importPredicate",factory:function(){return foam.mlang.predicate.True.create()},},{of:"foam.mlang.predicate.Predicate",name:"filterExportPredicate",},{class:"FObjectProperty",of:"foam.comics.v2.CRUDEnabledActionsAuth",name:"CRUDEnabledActionsAuth"},{class:"Boolean",name:"hideQueryBar"},{class:"Int",name:"minHeight",value:424},{class:"foam.u2.ViewSpec",name:"createController",factory:function(){return{class:"foam.comics.v2.DAOCreateView"}}},{class:"foam.u2.ViewSpec",name:"detailView",},{class:"foam.u2.ViewSpec",name:"menu",},{class:"foam.u2.ViewSpec",name:"createControllerView",type:"foam.lib.json.UnknownFObject",javaInfoType:"foam.core.AbstractFObjectPropertyInfo",javaJSONParser:"new foam.lib.json.UnknownFObjectParser()",fromJSON:function fromJSON(value,ctx,prop,json){return value}},{class:"FObjectArray",of:"foam.core.Action",name:"browseActions",adaptArrayElement:function(o){if(foam.core.Action.isInstance(o))return o;var lastIndex=o.lastIndexOf(".");var classObj=foam.lookup(o.substring(0,lastIndex));return classObj[o.substring(lastIndex+1)]}},{name:"browseContext",value:null},{class:"foam.u2.ViewSpec",name:"createPopup",},{class:"FObjectArray",of:"foam.core.Action",name:"DAOActions",adaptArrayElement:function(o){if(foam.core.Action.isInstance(o))return o;var lastIndex=o.lastIndexOf(".");var classObj=foam.lookup(o.substring(0,lastIndex));return classObj[o.substring(lastIndex+1)]}},{class:"Map",name:"selectedObjs"},{class:"foam.mlang.predicate.PredicateProperty",name:"searchPredicate"},{class:"Int",name:"preSelectedCannedQuery"}]});
foam.CLASS({package:"foam.comics.v2",name:"DAOCreateView",extends:"foam.u2.View",topics:["finished","throwError"],axioms:[foam.pattern.Faceted.create()],css:`
^ {
padding: 32px
}
^ .foam-u2-ActionView-back {
display: flex;
align-self: flex-start;
}
^account-name {
font-size: 3.6rem;
font-weight: 600;
}
^create-view-container {
margin: auto;
}
`,requires:["foam.log.LogLevel","foam.u2.layout.Cols","foam.u2.layout.Rows","foam.u2.ControllerMode"],imports:["ctrl","currentMenu?","memento","stack","translationService"],exports:["controllerMode","currentMemento_ as memento"],messages:[{name:"CREATED",message:"Created"}],properties:[{class:"FObjectProperty",name:"data"},{class:"FObjectProperty",of:"foam.comics.v2.DAOControllerConfig",name:"config"},{name:"controllerMode",factory:function(){return this.ControllerMode.CREATE}},{class:"foam.u2.ViewSpec",name:"viewView",factory:function(){return this.config.createView}},{class:"String",name:"mementoHead",value:"create"},"currentMemento_"],actions:[{name:"save",isEnabled:function(data$errors_){return!data$errors_},code:function(){var cData=this.data;this.config.dao.put(cData).then(o=>{this.data=o;this.finished.pub();if(foam.comics.v2.userfeedback.UserFeedbackAware.isInstance(o)&&o.userFeedback){var currentFeedback=o.userFeedback;while(currentFeedback){this.ctrl.notify(currentFeedback.message,"",this.LogLevel.INFO,true);currentFeedback=currentFeedback.next}}else{var menuId=this.currentMenu?this.currentMenu.id:this.config.of.id;var title=this.translationService.getTranslation(foam.locale,menuId+".browseTitle",this.config.browseTitle);this.ctrl.notify(title+" "+this.CREATED,"",this.LogLevel.INFO,true)}this.stack.back()},e=>{this.throwError.pub(e);if(e.exception&&e.exception.userFeedback){var currentFeedback=e.exception.userFeedback;while(currentFeedback){this.ctrl.notify(currentFeedback.message,"",this.LogLevel.INFO,true);currentFeedback=currentFeedback.next}this.stack.back()}else{this.ctrl.notify(e.message,"",this.LogLevel.ERROR,true)}})}}],methods:[function render(){var self=this;this.SUPER();if(this.memento)this.currentMemento_$=this.memento.tail$;this.addClass(this.myClass()).add(self.slot(function(config$viewBorder){return self.E().start(self.Rows).start(self.Rows).startContext({data:self.stack}).tag(self.stack.BACK,{buttonStyle:foam.u2.ButtonStyle.LINK,icon:"images/back-icon.svg",themeIcon:"back"}).endContext().start(self.Cols).style({"align-items":"center"}).start().add(self.slot("config$createTitle")).addClass(this.myClass("account-name")).end().startContext({data:self}).tag(self.SAVE,{buttonStyle:foam.u2.ButtonStyle.PRIMARY}).endContext().end().end().start(config$viewBorder).start().addClass(this.myClass("create-view-container")).tag(this.viewView,{data$:self.data$}).end().end()}))}]});
foam.CLASS({package:"foam.comics.v2",name:"DAOSummaryView",extends:"foam.u2.View",mixins:["foam.u2.memento.Memorable"],topics:["finished","throwError"],axioms:[foam.pattern.Faceted.create()],css:`
^ {
padding: 32px
}
^ .foam-u2-ActionView-back {
display: flex;
align-self: flex-start;
}
^account-name {
font-size: 3.6rem;
font-weight: 600;
}
^actions-header .foam-u2-ActionView {
margin-right: 24px;
line-height: 1.5
}
^view-container {
margin: auto;
}
`,requires:["foam.u2.layout.Cols","foam.u2.layout.Rows","foam.u2.ControllerMode","foam.u2.dialog.Popup","foam.u2.stack.BreadcrumbView","foam.u2.stack.StackBlock"],imports:["auth","config? as importedConfig","currentMenu?","currentControllerMode?","setControllerMode?","stack?","translationService"],exports:["controllerMode"],messages:[{name:"DETAIL",message:"Detail"},{name:"TABBED",message:"Tabbed"},{name:"SECTIONED",message:"Sectioned"},{name:"MATERIAL",message:"Material"},{name:"WIZARD",message:"Wizard"},{name:"VERTICAL",message:"Vertical"},{name:"ALL",message:"All "}],properties:[{class:"FObjectProperty",name:"data"},{class:"FObjectProperty",of:"foam.comics.v2.DAOControllerConfig",name:"config",factory:function(){return importedConfig||foam.comics.v2.DAOControllerConfig.create({},this)}},{name:"controllerMode",factory:function(){return this.ControllerMode.VIEW}},{name:"primary",expression:function(config$of){var allActions=config$of.getAxiomsByClass(foam.core.Action);var defaultAction=allActions.filter(a=>a.isDefault);return defaultAction.length>=1?defaultAction[0]:allActions.length>=1?allActions[0]:null}},{class:"foam.u2.ViewSpec",name:"viewView",factory:function(){return this.config?.detailView??foam.u2.detail.TabbedDetailView}},{class:"String",name:"backLabel",expression:function(config$browseTitle){var allMsg=ctrl.__subContext__.translationService.getTranslation(foam.locale,"foam.comics.v2.DAOSummaryView.ALL",this.ALL);var menuId=this.currentMenu?this.currentMenu.id:this.config.of.id;var title=ctrl.__subContext__.translationService.getTranslation(foam.locale,menuId+".browseTitle",config$browseTitle);return allMsg+title}},{name:"onBack",factory:function(){return()=>this.stack.back()}},{class:"String",name:"route",memorable:true,factory:function(){if(!this.idOfRecord)return"";var id=""+this.idOfRecord;if(id&&foam.core.MultiPartID.isInstance(this.config.of.ID)){id=id.substr(1,id.length-2).replaceAll(":","=")}return id},postSet:function(_,n){if(!this.idOfRecord&&n)this.idOfRecord=n}},{name:"idOfRecord",factory:function(){return this.route?this.route:this.data?this.data.id:null}},{class:"String",name:"viewTitle",expression:function(data){var self=this;var maybePromise=data?.toSummary()??"";if(maybePromise.then){maybePromise.then(v=>{self.viewTitle=v});return""}return maybePromise}}],actions:[{name:"back",code:data=>data.onBack()},{name:"edit",isEnabled:function(config,data){if(config.CRUDEnabledActionsAuth&&config.CRUDEnabledActionsAuth.isEnabled){try{let permissionString=config.CRUDEnabledActionsAuth.enabledActionsAuth.permissionFactory(foam.nanos.dao.Operation.UPDATE,data);return this.auth.check(null,permissionString)}catch(e){return false}}return true},isAvailable:function(config){try{return config.editPredicate.f()}catch(e){return false}},code:function(){if(!this.stack||!this.data)return;this.stack.push(this.StackBlock.create({view:{class:"foam.comics.v2.DAOUpdateView",data:this.data,config:this.config,of:this.config.of},parent:this.__subContext__.createSubContext({memento:this.memento})}))}},{name:"copy",isEnabled:function(config,data){if(config.CRUDEnabledActionsAuth&&config.CRUDEnabledActionsAuth.isEnabled){try{let permissionString=config.CRUDEnabledActionsAuth.enabledActionsAuth.permissionFactory(foam.nanos.dao.Operation.CREATE,data);return this.auth.check(null,permissionString)}catch(e){return false}}return true},isAvailable:function(config){try{return config.createPredicate.f()}catch(e){return false}},code:function(){if(!this.stack)return;let newRecord=this.data.clone();newRecord.id=undefined;this.stack.push(this.StackBlock.create({view:{class:"foam.comics.v2.DAOCreateView",data:newRecord,config:this.config,of:this.config.of},parent:this}))}},{name:"delete",isEnabled:function(config,data){if(config.CRUDEnabledActionsAuth&&config.CRUDEnabledActionsAuth.isEnabled){try{let permissionString=config.CRUDEnabledActionsAuth.enabledActionsAuth.permissionFactory(foam.nanos.dao.Operation.REMOVE,data);return this.auth.check(null,permissionString)}catch(e){return false}}return true},isAvailable:function(config){try{return config.deletePredicate.f()}catch(e){return false}},code:function(){this.add(this.Popup.create({backgroundColor:"transparent"}).tag({class:"foam.u2.DeleteModal",dao:this.config.dao,onDelete:()=>{this.finished.pub();this.stack.back()},data:this.data}))}}],methods:[function init(){this.SUPER();var self=this;var id=this.data?.id??this.idOfRecord;self.config.unfilteredDAO.inX(self.__subContext__).find(id).then(d=>{self.data=d})},function render(){var self=this;this.SUPER();if(this.currentControllerMode==="edit"){self.edit()}else{if(this.setControllerMode)this.setControllerMode("view");this.addClass(this.myClass()).add(self.slot(function(data,config$viewBorder,viewView){if(!data)return;return self.E().start(self.Rows).start(self.Rows).startContext({onBack:self.onBack}).tag(self.BreadcrumbView).endContext().start(self.Cols).style({"align-items":"center","margin-bottom":"32px"}).start().add(data&&data.toSummary()?data.toSummary():"").addClass(self.myClass("account-name")).addClass("truncate-ellipsis").end().startContext({data:data}).tag(self.primary,{buttonStyle:"PRIMARY"}).endContext().end().end().start(self.Cols).start(self.Cols).addClass(self.myClass("actions-header")).startContext({data:self}).tag(self.EDIT,{buttonStyle:foam.u2.ButtonStyle.LINK,themeIcon:"edit",icon:"images/edit-icon.svg"}).tag(self.COPY,{buttonStyle:foam.u2.ButtonStyle.LINK,themeIcon:"copy",icon:"images/copy-icon.svg"}).tag(self.DELETE,{buttonStyle:foam.u2.ButtonStyle.LINK,themeIcon:"trash",icon:"images/delete-icon.svg"}).endContext().end().end().start(config$viewBorder).start(viewView,{data:data,memento_$:self.memento_$}).addClass(self.myClass("view-container")).end().end().end()}))}}]});
foam.CLASS({package:"foam.comics.v2",name:"DAOUpdateView",extends:"foam.u2.View",mixins:["foam.u2.memento.Memorable"],topics:["finished","throwError"],axioms:[foam.pattern.Faceted.create()],css:`
^ {
padding: 32px
}
^topContainer{
grid-gap: 32px 12px;
}
^ .foam-u2-ActionView-back {
display: flex;
align-self: flex-start;
}
^account-name {
font-size: 3.6rem;
font-weight: 600;
}
^actions-header .foam-u2-ActionView {
margin-right: 24px;
line-height: 1.5
}
^view-container {
margin: auto;
}
`,requires:["foam.log.LogLevel","foam.u2.layout.Cols","foam.u2.layout.Rows","foam.u2.layout.Grid","foam.u2.ControllerMode"],imports:["ctrl","currentControllerMode","currentMenu?","setControllerMode","stack","translationService"],exports:["controllerMode"],messages:[{name:"BACK",message:"Back"},{name:"DETAIL",message:"Detail"},{name:"TABBED",message:"Tabbed"},{name:"SECTIONED",message:"Sectioned"},{name:"MATERIAL",message:"Material"},{name:"WIZARD",message:"Wizard"},{name:"VERTICAL",message:"Vertical"},{name:"UPDATED",message:"Updated"}],properties:[{class:"FObjectProperty",name:"data"},{class:"FObjectProperty",name:"workingData",expression:function(data){return data.clone(this)}},{class:"FObjectProperty",of:"foam.comics.v2.DAOControllerConfig",name:"config"},{name:"controllerMode",factory:function(){return this.ControllerMode.EDIT}},{class:"foam.u2.ViewSpec",name:"viewView",expression:function(){return foam.u2.detail.TabbedDetailView}},"currentMemento_"],actions:[{name:"save",isEnabled:function(workingData$errors_){return!workingData$errors_},code:function(){this.config.dao.put(this.workingData).then(o=>{if(!this.data.equals(o)){this.data=o;this.finished.pub();if(foam.comics.v2.userfeedback.UserFeedbackAware.isInstance(o)&&o.userFeedback){var currentFeedback=o.userFeedback;while(currentFeedback){this.ctrl.notify(currentFeedback.message,"",this.LogLevel.INFO,true);currentFeedback=currentFeedback.next}}else{var menuId=this.currentMenu?this.currentMenu.id:this.config.of.id;var title=this.translationService.getTranslation(foam.locale,menuId+".browseTitle",this.config.browseTitle);this.ctrl.notify(title+" "+this.UPDATED,"",this.LogLevel.INFO,true)}}this.stack.back()},e=>{this.throwError.pub(e);if(e.exception&&e.exception.userFeedback){var currentFeedback=e.exception.userFeedback;while(currentFeedback){this.ctrl.notify(currentFeedback.message,"",this.LogLevel.INFO,true);currentFeedback=currentFeedback.next}this.stack.back()}else{this.ctrl.notify(e.message,"",this.LogLevel.ERROR,true)}})}}],methods:[function render(){var self=this;this.SUPER();this.setControllerMode("edit");this.addClass(this.myClass()).add(self.slot(function(data,config$viewBorder){return self.E().start(self.Grid).addClass(this.myClass("topContainer")).start(self.Rows).startContext({data:self.stack}).tag(self.stack.BACK,{buttonStyle:foam.u2.ButtonStyle.LINK,icon:"images/back-icon.svg",themeIcon:"back",label:this.BACK}).endContext().start(self.Cols).style({"align-items":"center"}).start().add(data&&data.toSummary()?data.toSummary():"").addClass(this.myClass("account-name")).addClass("truncate-ellipsis").end().startContext({data:self}).tag(self.SAVE,{buttonStyle:"PRIMARY"}).endContext().end().end().start(config$viewBorder).start().addClass(this.myClass("view-container")).add(self.slot(function(viewView){var view=foam.u2.ViewSpec.createView(viewView,{data$:self.workingData$},self,self);return self.E().add(view)})).end().end().end()}))}]});
foam.CLASS({package:"foam.comics.v2.namedViews",name:"NamedViewCollection",properties:[{class:"String",name:"name"},{class:"foam.u2.ViewSpec",name:"view"},{class:"String",name:"icon"}]});
foam.CLASS({package:"foam.comics.v2.namedViews",name:"NamedViewInstance",properties:[{class:"String",name:"name"},{class:"foam.u2.ViewSpec",name:"view"},{class:"String",name:"icon"}]});foam.INTERFACE({package:"foam.comics.v2.userfeedback",name:"UserFeedbackAware",methods:[{name:"getUserFeedback",type:"foam.comics.v2.userfeedback.UserFeedback"},{name:"setUserFeedback",args:[{name:"userFeedback",type:"foam.comics.v2.userfeedback.UserFeedback"}]}]});foam.ENUM({package:"foam.comics.v2.userfeedback",name:"UserFeedbackStatus",values:[{name:"SUCCESS",label:"Success"},{name:"INFO",label:"Info"},{name:"ERROR",label:"Error"}]});
foam.CLASS({package:"foam.comics.v2.userfeedback",name:"UserFeedback",properties:[{class:"Enum",name:"status",of:"foam.comics.v2.userfeedback.UserFeedbackStatus"},{class:"String",name:"message"},{class:"FObjectProperty",of:"foam.comics.v2.userfeedback.UserFeedback",name:"next",javaToCSV:`// intentionally left empty to prevent circular reference`,javaToCSVLabel:``}]});
foam.CLASS({package:"foam.comics.v2.userfeedback",name:"UserFeedbackException",implements:["foam.core.Exception"],javaExtends:["java.lang.RuntimeException"],properties:[{class:"FObjectProperty",of:"foam.comics.v2.userfeedback.UserFeedback",name:"userFeedback"}]});
foam.CLASS({package:"foam.layout",name:"Section",requires:["foam.core.Action","foam.core.Property"],properties:[{name:"name"},{name:"title"},{name:"subTitle"},{name:"navTitle",expression:function(title){return title}},{name:"help"},{class:"FObjectArray",of:"foam.core.Property",name:"properties"},{class:"FObjectArray",of:"foam.core.Action",name:"actions"},{name:"gridColumns"},{class:"Function",name:"createIsAvailableFor",value:function(data$){return foam.core.ConstantSlot.create({value:true})}},{class:"String",name:"fromClass",}],methods:[function createErrorSlotFor(data$){var errorSlots=data$.map(d=>{return foam.core.ArraySlot.create({slots:this.properties.filter(p=>p.validateObj).map(p=>d.slot(p.validateObj))})});var retSlot=foam.core.ProxySlot.create({delegate:errorSlots.get()});this.onDetach(errorSlots.sub(slot=>{retSlot.delegate=slot}));return retSlot},function fromSectionAxiom(a,cls){this.copyFrom(a);this.copyFrom({createIsAvailableFor:a.createIsAvailableFor.bind(a),fromClass:a.sourceCls_.name,actions:cls.getAxiomsByClass(this.Action).filter(action=>action.section==a.name)});if(a.hasOwnProperty("properties")){this.properties=a.properties.map(p=>{if(foam.String.isInstance(p))return cls.getAxiomByName(p);if(p.name)return cls.getAxiomByName(p.name).clone().copyFrom(p)}).sort(foam.core.Property.ORDER.compare)}else{this.properties=cls.getAxiomsByClass(foam.core.Property).filter(p=>p.section==a.name).filter(p=>!p.hidden).sort((p1,p2)=>p1.order-p2.order)}return this}]});
foam.CLASS({package:"foam.layout",name:"SectionAxiom",properties:[{class:"String",name:"name"},{name:"title",expression:function(name){if(name==="_defaultSection")return"";return foam.String.labelize(name)}},{name:"subTitle"},{name:"navTitle"},{name:"properties"},{name:"help"},{class:"Int",name:"order",value:Number.MAX_SAFE_INTEGER},{class:"Boolean",name:"permissionRequired"},{name:"gridColumns"},{class:"Function",name:"isAvailable",value:function(){return true}},{class:"String",name:"section",getter:function(){return this.section_},setter:function(m){this.section_=m}},{class:"Simple",name:"section_"}],methods:[function createIsAvailableFor(data$,controllerMode$){var self=this;var slot=foam.core.ProxyExpressionSlot.create({obj$:data$,code:this.isAvailable});var availabilitySlots=[slot];if(this.permissionRequired){var permSlot=foam.core.SimpleSlot.create({value:false});var update=function(){var data=data$.get();if(data&&data.__subContext__.auth){data.__subContext__.auth.check(null,`${data.cls_.id.toLowerCase()}.section.${self.name}`).then(hasAuth=>{permSlot.set(hasAuth)})}};update();data$.sub(update);availabilitySlots.push(permSlot)}var data=data$.get();let props;if(this.hasOwnProperty("properties")){props=this.properties.map(p=>{if(foam.String.isInstance(p))return data.cls_.getAxiomByName(p);if(p.name)return data.cls_.getAxiomByName(p.name).clone().copyFrom(p)})}else{props=data.cls_.getAxiomsByClass(foam.core.Property).filter(p=>p.section===this.name)}var propVisSlot=foam.core.ArraySlot.create({slots:props.map(p=>p.createVisibilityFor(data$,controllerMode$||data.__subContext__.controllerMode$||data.__subContext__.ctrl&&data.__subContext__.ctrl.controllerMode$||foam.core.ConstantSlot.create({value:foam.u2.ControllerMode.CREATE})))}).map(arr=>arr.some(m=>{return m!=foam.u2.DisplayMode.HIDDEN}));var actions=data.cls_.getAxiomsByClass(foam.core.Action).filter(a=>a.section===this.name);var actionAvailSlot=foam.core.ArraySlot.create({slots:actions.map(a=>a.createIsAvailable$(data.__subContext__,data))}).map(arr=>arr.some(isAvailable=>{return isAvailable}));var atLeastOnePropertyOrActionAvailableSlot=foam.core.ArraySlot.create({slots:[propVisSlot,actionAvailSlot]}).map(arr=>arr.some(isVisibleOrAvailable=>{return isVisibleOrAvailable}));availabilitySlots.push(atLeastOnePropertyOrActionAvailableSlot);var simpleSlot=foam.core.SimpleSlot.create();var arrSlot=foam.core.ArraySlot.create({slots:availabilitySlots}).map(arr=>{var ret=arr.every(b=>b);if(ret!=simpleSlot.get())simpleSlot.set(ret);return ret});arrSlot.get();arrSlot.sub(function(){arrSlot.get()});return simpleSlot},function installInClass(cls){cls["SECTION_"+foam.String.constantize(this.name)]=this}]});
foam.CLASS({package:"foam.layout",name:"PropertySectionRefine",refines:"foam.core.Property",properties:[{class:"String",name:"section",value:"_defaultSection"}]});
foam.CLASS({package:"foam.layout",name:"ActionSectionRefine",refines:"foam.core.Action",properties:[{class:"String",name:"section",value:"_defaultSection"}]});
foam.CLASS({package:"foam.layout",name:"ModelSectionRefine",refines:"foam.core.Model",properties:[{class:"AxiomArray",of:"foam.layout.SectionAxiom",name:"sections"}]});
foam.CLASS({package:"foam.u2.detail",name:"AbstractSectionedDetailView",extends:"foam.u2.View",flags:["web"],exports:["data as objData"],requires:["foam.core.Action","foam.core.Property","foam.layout.Section","foam.layout.SectionAxiom"],properties:[{class:"Array",name:"useSections",},{class:"FObjectProperty",name:"data",factory:function(){return this.hasOwnProperty("of")?this.of.create(null,this):null},postSet:function(oldValue,newValue){this.of=newValue?newValue.cls_:undefined}},{class:"Class",name:"of",expression:function(data){return data&&data.cls_}},{class:"Boolean",name:"hideActions"},{class:"FObjectArray",of:"foam.core.Property",name:"propertyWhitelist",factory:null,adapt:function(o,newValue,p){if(Array.isArray(newValue))return foam.core.FObjectArray.ADAPT.value.call(this,o,newValue,p);if(typeof newValue!=="object")throw new Error("You must set propertyWhitelist to an array of properties or a map from names to overrides encoded as an object.");return Object.entries(newValue).reduce((acc,[propertyName,overrides])=>{var axiom=this.of.getAxiomByName(propertyName);if(axiom)acc.push(axiom.clone().copyFrom(overrides));return acc},[])},preSet:function(_,ps){foam.assert(ps,"Properties required.");for(var i=0;i<ps.length;i++){foam.assert(foam.core.Property.isInstance(ps[i]),`Non-Property in 'properties' list:`,ps)}return ps}},{class:"FObjectArray",of:"foam.layout.Section",name:"sections",factory:null,expression:function(of,useSections,propertyWhitelist){if(!of)return[];sections=of.getAxiomsByClass(this.SectionAxiom).sort((a,b)=>a.order-b.order).reduce((map,a)=>{if(useSections.length){if(useSections.includes(a.name)){map.push(this.Section.create().fromSectionAxiom(a,of))}}else{map.push(this.Section.create().fromSectionAxiom(a,of))}return map},[]);var usedAxioms=sections.map(s=>s.properties.concat(s.actions)).flat().reduce((map,a)=>{map[a.name]=true;return map},{});if(!useSections.length){var unusedProperties=of.getAxiomsByClass(this.Property).filter(p=>!usedAxioms[p.name]).filter(p=>!p.hidden);var unusedActions=of.getAxiomsByClass(this.Action).filter(a=>!usedAxioms[a.name]);if(unusedProperties.length||unusedActions.length){sections.push(this.Section.create({properties:unusedProperties,actions:unusedActions}))}}if(propertyWhitelist){sections=sections.map(s=>{s.properties=s.properties.reduce((acc,sectionProp)=>{var prop=propertyWhitelist.find(whitelistProp=>whitelistProp.name===sectionProp.name);if(prop)acc.push(prop);return acc},[]);return s}).filter(s=>{return s.properties.length>0||!this.hideActions&&s.actions.length>0})}sections=sections.filter(s=>{return!this.hideActions&&s.actions.length>0||s.properties.some(p=>{var visVal=this.controllerMode.getVisibilityValue(p);return visVal!==foam.u2.DisplayMode.HIDDEN&&visVal!=="HIDDEN"})});return sections}}]});
foam.CLASS({package:"foam.u2.detail",name:"ChoiceSectionDetailView",extends:"foam.u2.detail.AbstractSectionedDetailView",requires:["foam.core.ArraySlot","foam.u2.detail.SectionView","foam.u2.view.ChoiceView"],css:`
^ .foam-u2-view-ScrollTableView table {
width: 100%;
}
^ .tag-Select {
text-align-last: center;
}
^ .choicePosition {
align-items: center;
display: flex;
flex-direction: row;
justify-content: center;
text-align: center;
}
^ .action-button {
border-radius: 10px;
font-size: 2.0rem;
font-weight: bold;
padding: 5px;
width: 100px;
}
`,properties:[{name:"currentIndex",preSet:function(o,n){if(n<1)return 0;if(n>=this.visibleSections.length)return this.visibleSections.length-1;return n},value:0},{name:"visibleSections"}],methods:[function render(){var self=this;this.SUPER();this.addClass(this.myClass()).add(this.slot(function(sections,data){if(!data)return;var arraySlot=self.ArraySlot.create({slots:sections.map(s=>s.createIsAvailableFor(self.data$))});return self.E().add(arraySlot.map(visibilities=>{self.visibleSections=sections.filter((s,i)=>visibilities[i]);return this.E().startContext({controllerMode:"EDIT"}).start().addClass("choicePosition").start("button").addClass("action-button").add("<").on("click",()=>{this.currentIndex-=1}).attrs({disabled:self.slot(function(currentIndex){return currentIndex===0})}).end().tag(this.ChoiceView,{choices:self.visibleSections.map((s,i)=>[i,s.title]),data$:self.currentIndex$}).addClass("tag-Select").start("button").addClass("action-button").add(">").on("click",()=>{this.currentIndex+=1}).attrs({disabled:self.slot(function(currentIndex){return currentIndex===self.visibleSections.length-1})}).end().end().endContext().add(this.slot(function(currentIndex){return this.E().tag(self.SectionView,{data$:self.data$,section:this.visibleSections[this.currentIndex],showTitle:true})}))}))}))}]});
foam.CLASS({package:"foam.u2.detail",name:"SectionView",extends:"foam.u2.View",requires:["foam.core.ArraySlot","foam.core.ConstantSlot","foam.core.ProxySlot","foam.core.SimpleSlot","foam.layout.Section","foam.u2.PropertyBorder","foam.u2.DisplayMode","foam.u2.layout.Cols","foam.u2.layout.Grid","foam.u2.layout.GUnit","foam.u2.layout.Rows"],css:`
^section-title {
padding-bottom: 16px;
}
.subtitle {
color: /*%GREY2%*/ #6B778C;
margin-bottom: 16px;
}
`,properties:[{class:"String",name:"sectionName"},{class:"FObjectProperty",of:"foam.layout.Section",name:"section",expression:function(data,sectionName){if(!data)return null;var of=data.cls_;var a=of.getAxiomByName(sectionName);return this.Section.create().fromSectionAxiom(a,of)}},{class:"Boolean",name:"showTitle",value:true},{name:"config"},{class:"Function",name:"evaluateMessage",factory:function(){var obj=this.data.clone();return msg=>msg.replace(/\${(.*?)}/g,(x,str)=>{return this.getNestedPropValue(obj,str)})}},{class:"Function",name:"getNestedPropValue",factory:function(){return(obj,path)=>{if(!path)return obj;const props=path.split(".");return this.getNestedPropValue(obj[props.shift()],props.join("."))}}},{class:"Boolean",name:"loadLatch",factory:function(){return this.selected}},{class:"Boolean",name:"selected",postSet:function(){if(this.selected)this.loadLatch=this.selected},value:true}],methods:[function render(){var self=this;self.SUPER();if(this.section)this.shown$=this.section.createIsAvailableFor(self.data$,self.__subContext__.controllerMode$);self.addClass(self.myClass()).callIf(self.section,function(){self.addClass(self.myClass(self.section.name))}).add(self.slot(function(section,showTitle,section$title,section$subTitle,shown){if(!section||!shown)return;return self.Rows.create().callIf(showTitle&&section$title,function(){if(foam.Function.isInstance(self.section.title)){const slot$=foam.core.ExpressionSlot.create({args:[self.evaluateMessage$,self.data$],obj$:self.data$,code:section.title});if(slot$.value){this.start().add(slot$.value.toUpperCase()).addClasses(["h500",self.myClass("section-title")]).end()}}else{this.start("h5").add(section.title.toUpperCase()).addClasses(["h500",self.myClass("section-title")]).end()}}).callIf(section$subTitle,function(){if(foam.Function.isInstance(self.section.subTitle)){const slot$=foam.core.ExpressionSlot.create({args:[self.evaluateMessage$,self.data$],obj$:self.data$,code:section.subTitle});if(slot$.value){this.start().addClasses(["p","subtitle"]).add(slot$.value).end()}}else{this.start().addClasses(["p","subtitle"]).add(section.subTitle).end()}}).add(this.slot(function(loadLatch){var view=this.E().start(self.Grid).style({"grid-gap":"16px 12px"});if(loadLatch){view.forEach(section.properties,function(p,index){var config=self.config&&self.config[p.name];if(config){p=p.clone();for(var key in config){if(config.hasOwnProperty(key)){p[key]=config[key]}}}var shown$=p.createVisibilityFor(self.data$,self.controllerMode$).map(mode=>mode!==self.DisplayMode.HIDDEN);this.start(self.GUnit,{columns:p.gridColumns}).show(shown$).add(shown$.map(shown=>{return shown?self.PropertyBorder.create({prop:p,data$:self.data$,reserveLabelSpace:p.reserveLabelSpace??true}):self.E()})).end()})}return view})).start(self.Cols).style({"justify-content":"end","margin-top":section.actions.length?"16px":"initial"}).forEach(section.actions,function(a){this.add(a)}).end()}))}]});
foam.CLASS({package:"foam.u2.detail",name:"SectionedDetailView",extends:"foam.u2.detail.AbstractSectionedDetailView",requires:["foam.u2.detail.SectionView","foam.u2.layout.Grid","foam.u2.layout.GUnit","foam.u2.borders.CardBorder"],css:`
^ .inner-card {
padding: 14px 24px
}
^ .foam-u2-view-ScrollTableView table {
width: 100%;
}
^ ^card-container + ^card-container {
margin-top: 16px;
}
`,properties:[{class:"foam.u2.ViewSpec",name:"border",factory:function(){return this.CardBorder}}],methods:[function render(){var self=this;this.SUPER();this.addClass(this.myClass()).add(this.slot(function(sections,data){if(!data)return;var grid=self.Grid.create().forEach(sections,function(s){var slot=s.createIsAvailableFor(self.data$,self.__subContext__.controllerMode$).map(function(isAvailable){if(!isAvailable)return self.E().style({display:"none"});var title$=foam.Function.isInstance(s.title)?foam.core.ExpressionSlot.create({obj$:self.data$,code:s.title}):s.title$;return self.GUnit.create({columns:s.gridColumns}).addClass(self.myClass("card-container")).start("h2").add(title$).show(title$).end().start(self.border).addClass("inner-card").tag(self.SectionView,{data$:self.data$,section:s,showTitle:false}).end()});this.add(slot);this.onDetach(slot.sub(this.framed(function(){grid.resizeChildren()})))});return grid}))}]});
foam.CLASS({package:"foam.u2.detail",name:"FlexSectionedDetailView",extends:"foam.u2.detail.AbstractSectionedDetailView",requires:["foam.u2.borders.NullBorder","foam.u2.detail.SectionView","foam.u2.layout.GUnit","foam.u2.layout.Grid"],css:`
^ {
display: flex;
flex-direction: column;
}
^slotElement {
display: flex;
flex-direction: column;
flex-grow: 1;
justify-content: center;
gap: 40pt;
}
`,properties:[{class:"foam.u2.ViewSpec",name:"border",factory:function(){return this.NullBorder}},{class:"Boolean",name:"showTitles"}],methods:[function render(){var self=this;this.SUPER();this.addClass(this.myClass()).add(this.slot(function(sections,data){return self.E().addClass(this.myClass("slotElement")).forEach(sections,function(section){const isAvailable$=section.createIsAvailableFor(self.data$,self.__subContext__.controllerMode$);this.add(isAvailable$.map(function(isAvailable){if(!isAvailable)return self.E().style({display:"none"});return self.border.create().tag(self.SectionView,{data$:self.data$,showTitle:self.showTitles,section:section})}))})}))}]});
foam.CLASS({package:"foam.u2.detail",name:"VerticalDetailView",extends:"foam.u2.detail.AbstractSectionedDetailView",requires:["foam.u2.detail.SectionView","foam.u2.layout.Rows"],properties:[{name:"config"},{class:"Boolean",name:"showTitle",value:true}],methods:[function render(){var self=this;this.SUPER();this.addClass(this.myClass()).add(this.slot(function(of,sections,data){if(!data)return;return self.E().start(self.Rows).forEach(sections,function(s){var slot=s.createIsAvailableFor(self.data$,self.__subContext__.controllerMode$).map(function(isAvailable){if(!isAvailable)return self.E().style({display:"none"});return self.E().start(self.SectionView,{data$:self.data$,section:s,config:self.config,showTitle:self.showTitle}).end()});this.add(slot)}).end()}))}]});
foam.CLASS({package:"foam.u2.detail",name:"WizardSectionsView",extends:"foam.u2.detail.AbstractSectionedDetailView",requires:["foam.u2.layout.Cols","foam.u2.layout.Rows"],css:`
^ .foam-u2-layout-Cols {
align-items: center;
}
^wizard-body {
height: 100%;
background-color: /*%WHITE%*/ #ffffff;
}
^footer {
min-height: 75px;
border-top: solid 1px /*%GREY5%*/ #f5f7fa;
padding: 0px 128px;
}
^next-button {
width: 156px;
height: 48px;
}
`,properties:[{class:"DateTime",name:"lastUpdate"},{class:"Int",name:"currentIndex"},{class:"Int",name:"prevIndex",expression:function(lastUpdate,currentIndex,sections,data){for(var i=currentIndex-1;i>=0;i--){if(sections[i].createIsAvailableFor(this.data$).get())return i}return-1}},{class:"Int",name:"nextIndex",expression:function(lastUpdate,currentIndex,sections,data){for(var i=currentIndex+1;i<sections.length;i++){if(sections[i].createIsAvailableFor(this.data$).get())return i}return-1}},{class:"foam.u2.ViewSpec",name:"sectionView",value:{class:"foam.u2.detail.SectionView"}}],reactions:[["","propertyChange.sections","restartWizard"],["","propertyChange.data","restartWizard"],["data","propertyChange","onDataUpdate"]],listeners:[{name:"restartWizard",isFramed:true,code:function(){for(var i=0;i<this.sections.length;i++){if(this.sections[i].createIsAvailableFor(this.data$).get()){this.currentIndex=i;return}}}},{name:"onDataUpdate",isFramed:true,code:function(){this.lastUpdate=new Date}}],actions:[{name:"prev",label:"Go back",code:function(){this.currentIndex=this.prevIndex},isAvailable:function(prevIndex){return prevIndex!=-1}},{name:"next",label:"Continue",code:function(){this.currentIndex=this.nextIndex},isAvailable:function(nextIndex){return nextIndex!=-1},isEnabled:function(lastUpdate,data$errors_,sections,currentIndex){return sections[currentIndex].createErrorSlotFor(this.data$).get().filter(e=>e).length==0}}],methods:[function render(){var self=this;this.addClass();self.SUPER();self.start(self.Rows).add(self.slot(function(sections,currentIndex){return self.E().tag(self.sectionView,{section:sections[currentIndex],data$:self.data$})})).addClass(this.myClass("wizard-body")).startContext({data:this}).start(self.Cols).addClass(this.myClass("footer")).add(this.PREV).add(this.NEXT).end().endContext().end()}]});
foam.CLASS({package:"foam.u2.detail",name:"DAOWizardSectionsView",extends:"foam.u2.detail.WizardSectionsView",properties:[{class:"Boolean",name:"isConnecting",value:false},{class:"Boolean",name:"isEdit",value:false},{name:"config"}],actions:[{name:"prev",label:"Go back",code:function(X){this.isConnecting=false;if(this.isEdit&&this.currentIndex===0){this.data.isEdit=false;X.closeDialog()}else if(this.currentIndex>0){this.currentIndex=this.prevIndex}else{X.closeDialog()}},isAvailable:function(prevIndex,nextIndex){return nextIndex!=-1||prevIndex!=-1}},{name:"next",label:"Next",isEnabled:function(lastUpdate,data$errors_,sections,currentIndex){return sections[currentIndex].createErrorSlotFor(this.data$).get().filter(e=>e).length==0},isAvailable:function(nextIndex){return nextIndex!==-1},code:function(){this.currentIndex=this.nextIndex}}]});
foam.CLASS({package:"foam.u2.detail",name:"TabbedDetailView",extends:"foam.u2.detail.AbstractSectionedDetailView",requires:["foam.core.ArraySlot","foam.u2.borders.CardBorder","foam.u2.detail.SectionView","foam.u2.Tab","foam.u2.Tabs"],css:`
^ .foam-u2-Tabs-content > div {
background: /*%WHITE%*/ #ffffff;
padding: 14px 16px;
border-bottom-left-radius: 6px;
border-bottom-right-radius: 6px;
}
^ .foam-u2-view-ScrollTableView table {
width: 100%;
}
^ .foam-u2-Tabs-tabRow {
border-top-left-radius: 6px;
border-top-right-radius: 6px;
}
^wrapper {
padding: 14px 24px;
}
`,properties:[{class:"String",name:"defaultSectionLabel",value:"Uncategorized"},"tabs"],methods:[function render(){var self=this;this.SUPER();this.addClass(this.myClass()).add(this.slot(function(sections,data){if(!data)return;var arraySlot=foam.core.ArraySlot.create({slots:sections.map(s=>s.createIsAvailableFor(self.data$,self.__subContext__.controllerMode$))});return self.E().add(arraySlot.map(visibilities=>{var availableSections=visibilities.length==sections.length?sections.filter((_,i)=>visibilities[i]):sections;var e=availableSections.length==1?this.E().start(self.CardBorder).addClass(self.myClass("wrapper")).tag(self.SectionView,{data$:self.data$,section:availableSections[0],showTitle:false}).end():this.E().start(self.Tabs,{},self.tabs$).forEach(availableSections,function(s){if(s.title){var title$=foam.Function.isInstance(s.title)?foam.core.ExpressionSlot.create({obj:self.data,code:s.title}):s.title$;var tab=foam.core.SimpleSlot.create();this.start(self.Tab,{label$:title$||self.defaultSectionLabel},tab).call(function(){this.tag(self.SectionView,{data$:self.data$,section:s,showTitle:false,selected$:tab.value.selected$})}).end()}}).end();return e}))}))}]});
foam.CLASS({package:"foam.u2.detail",name:"SectionedDetailPropertyView",extends:"foam.u2.View",css:`
^ {
/* Add for fixing UI issue in Safari */
display: grid;
grid-template-columns: repeat(auto-fit, minmax(0,1fr));
}
^validation-container {
margin-top: 6px;
}
^helper-icon {
cursor: pointer;
float: right;
padding-left: 12px;
user-select: none;
-moz-user-select: none;
-webkit-user-select: none;
}
^tooltip {
align-self: center;
position: relative;
}
^tooltip-container {
z-index: -1;
display: none;
width: 80%;
height: auto;
line-height: 1.5;
margin-right: 3px;
}
^arrow-right {
width: 0;
height: 0;
border-top: 10px solid transparent;
border-bottom: 10px solid transparent;
border-left:10px solid rgba(0, 0, 0, 0.8);
}
^tooltip:hover .foam-u2-detail-SectionedDetailPropertyView-tooltip-container{
position: absolute;
display: flex;
justify-content: flex-end;
top: 0;
right: 25px;
width: 380px;
z-index: 10;
}
^error .foam-u2-tag-TextArea,
^error .foam-u2-tag-Select,
^error .foam-u2-TextField,
^error .foam-u2-IntView,
^error .foam-u2-FloatView,
^error .foam-u2-DateView,
^error .foam-u2-CurrencyView,
^error .foam-u2-view-date-DateTimePicker .date-display-box,
^error .foam-u2-view-RichChoiceView-selection-view,
^error .foam-u2-view-RichChoiceView-clear-btn
{
border-color: /*%DESTRUCTIVE3%*/ #d9170e;
}
/*
!IMPORTANT!
For the following inputs below, we are planning
encode these changes in the actual foam files
*/
^ .foam-u2-view-date-DateTimePicker {
cursor: pointer;
}
^ .foam-u2-detail-SectionedDetailPropertyView .property-filter {
font-size: 1.4rem;
padding-left: 16px;
}
^ .foam-u2-CheckBox-label {
word-break: break-word;
white-space: normal;
margin-top: 6px;
}
^ .foam-u2-layout-Cols {
align-items: center;
}
`,requires:["foam.core.ConstantSlot","foam.core.ProxySlot","foam.u2.layout.Cols","foam.u2.layout.Rows","foam.u2.ControllerMode","foam.u2.DisplayMode","foam.u2.borders.ExpandableBorder","foam.u2.tag.CircleIndicator"],imports:["theme?"],properties:["prop",["helpEnabled",false]],messages:[{name:"HELP",message:"Help"},{name:"LEARN_MORE",message:"Click to learn more"}],methods:[function render(){console.warn("Deprecated: Use foam.u2.PropertyBorder instead");var self=this;this.SUPER();this.mode$.follow(self.prop.createVisibilityFor(self.data$,self.controllerMode$));this.addClass(this.myClass()).addClass(`sectioned-detail-property-${this.prop.name}`).add(this.slot(function(mode,prop,prop$label){var errorSlot=prop.validateObj&&prop.validationTextVisible?this.data.slot(prop.validateObj):foam.core.ConstantSlot.create({value:null});return self.E().addClass(this.myClass("wrapper")).start().start(self.Rows).callIf(prop$label,function(){this.start().addClass("p-semiBold").add(prop.label).style({"line-height":"2"}).end()}).start().style({position:"relative",display:"flex","flex-wrap":"wrap",width:"100%"}).start().style({"flex-grow":1,"max-width":"100%"}).tag(prop,{mode$:self.mode$}).callIf(prop.validationStyleEnabled,function(){this.enableClass(self.myClass("error"),errorSlot)}).end().callIf(prop.help,function(){this.start().addClass(self.myClass("helper-icon")).start("",{tooltip:self.LEARN_MORE}).start(self.CircleIndicator,{icon:self.theme?self.theme.glyphs.helpIcon.getDataUrl({fill:self.theme.black}):"/images/question-icon.svg",size:20}).on("click",()=>{self.helpEnabled=!self.helpEnabled}).end().end().end()}).end().callIf(prop.validationTextVisible&&(mode===self.DisplayMode.RW||mode===self.DisplayMode.DISABLED),function(){this.start().style({"align-items":"center"}).start(self.Cols).addClass(self.myClass("validation-container")).show(errorSlot).start({class:"foam.u2.tag.Image",data:"/images/inline-error-icon.svg",displayHeight:"16px",displayWidth:"16px"}).style({"justify-content":"flex-start",margin:"0 8px 0 0"}).end().start().style({flex:1}).add(errorSlot.map(s=>{return self.E().add(s)})).end().end().end()}).end().callIf(prop.help,function(){this.start(self.ExpandableBorder,{expanded$:self.helpEnabled$,title:self.HELP}).style({"flex-basis":"100%","margin-top":"8px",width:"100%"}).start("p").add(prop.help).end().end()}).end()}))}]});
foam.CLASS({package:"foam.u2.detail",name:"RowPropertyView",extends:"foam.u2.View",css:`
^ {
display: flex;
justify-content: space-between;
}
`,properties:["prop"],methods:[function render(){const self=this;this.addClass().start().add(this.prop.label).end().add(this.slot(function(data){const el=this.E();const prop=self.prop;prop.tableCellFormatter.format(el,prop.f?prop.f(data):null,data,prop);return el}))}]});
foam.CLASS({package:"foam.u2.detail",name:"TabularSectionView",extends:"foam.u2.detail.SectionView",description:`
Render a section as an unstyled table.
`,requires:["foam.u2.detail.RowPropertyView"],css:`
^ > .foam-u2-layout-Rows > .foam-u2-layout-Grid {
grid-row-gap: 4px !important;
}
`,properties:[{name:"config",expression:function(section){var newPropOverrides={};section.properties.forEach(prop=>{newPropOverrides[prop.name]={gridColumns:12}});return newPropOverrides}}],methods:[function init(){const x=this.__context__.createSubContext();x.register(this.RowPropertyView,"foam.u2.PropertyBorder");this.__context__=x}]});
foam.CLASS({package:"foam.u2.dialog",name:"SimpleActionDialog",extends:"foam.u2.Controller",imports:["closeDialog"],css:`
^ .headerTitle {
font-size: 2.4rem;
font-weight: 900;
font-style: normal;
font-stretch: normal;
line-height: 1.5;
letter-spacing: normal;
}
^ .Container > *:not(:last-of-type) {
margin-bottom: 24px;
}
^ {
margin: 24px;
}
`,properties:[{name:"title",class:"String"},{name:"body",class:"String"},{name:"context"},{name:"actions",class:"Array"},{name:"closeOnChoice",class:"Boolean",value:true}],methods:[function render(){var self=this;this.SUPER();this.startContext(this.context).start().addClass(this.myClass()).start().addClass("Container").start().addClass("headerTitle").add(this.title).end().start().addClass("content").add(this.body).end().start().addClass("actions").forEach(this.actions,function(action){var a=action.clone();a.code=function(...args){self.closeDialog();return action.code.call(action,...args)};this.add(a)}).end().end().end().end()}]});
foam.CLASS({package:"foam.u2.tag",name:"CircleIndicator",extends:"foam.u2.Element",flags:["web"],requires:["foam.core.ExpressionSlot","foam.u2.LoadingSpinner"],css:`
^ {
position: relative;
border-radius: 50%;
text-align: center;
display: inline-flex;
overflow: hidden;
align-items: stretch;
justify-content: center;
}
^ > img {
pointer-events: none;
}
`,properties:[{name:"label",class:"String"},{name:"borderColor",class:"String"},{name:"borderColorHover",class:"String"},{name:"textColor",class:"String",expression:function(stateBorderColor_){return stateBorderColor_}},{name:"backgroundColor",class:"String"},{name:"borderThickness",class:"Int"},{name:"icon",class:"Image"},{name:"size",class:"Int",value:30},{name:"hasMouseOver",class:"Boolean",value:false},{name:"stateBorderColor_",expression:function(borderColor,borderColorHover,hasMouseOver){return hasMouseOver?borderColorHover:borderColor}},{name:"clickable",class:"Boolean"},{name:"indicateProcessing",class:"Boolean"}],methods:[function render(){this.addClass(this.myClass()).style({"background-color":this.backgroundColor,"border-color":this.stateBorderColor_$,width:this.size+"px",height:this.size+"px","font-size":this.size*.65,color:this.textColor$,border:this.borderThickness+"px solid",cursor:this.ExpressionSlot.create({obj:this,code:function(clickable){return clickable?"pointer":"default"}})}).on("mouseover",()=>{this.hasMouseOver=true}).on("mouseout",()=>{this.hasMouseOver=false}).attr("border");if(this.icon){this.start("img").attr("src",this.icon$).end()}if(this.indicateProcessing){this.tag(this.LoadingSpinner)}if(this.label){this.add(this.label)}}]});
foam.CLASS({package:"foam.u2.wizard.agents",name:"ConfigureFlowAgent",implements:["foam.core.ContextAgent"],imports:["stack"],exports:["pushView","popView","wizardCloseSub","popupMode","flowAgent"],topics:["flowAgent"],requires:["foam.u2.dialog.Popup"],properties:[{class:"FObjectProperty",name:"wizardCloseSub",of:"foam.core.FObject",factory:function(){return foam.core.FObject.create()}},{name:"popupMode",class:"Boolean",value:true},{name:"ensureHash",class:"String"},{name:"pushView",class:"Function",deprecated:true,expression:function(){var self=this;return this.popupMode?function(viewSpec,onClose){ctrl.add(self.Popup.create({closeable:viewSpec.closeable?viewSpec.closeable:false,...onClose?{onClose:onClose}:{}}).tag(viewSpec))}:function(viewSpec){self.stack.push(viewSpec,self);if(self.ensureHash){location.hash=self.ensureHash}}}},{name:"popView",deprecated:true,class:"Function",expression:function(){var self=this;return this.popupMode?function(x){x.closeDialog()}:function(x){self.stack.back()}}}],methods:[async function execute(){}]});
foam.CLASS({package:"foam.u2.wizard.agents",name:"DeveloperModeAgent",implements:["foam.core.ContextAgent"],imports:["userCapabilityJunctionDAO"],exports:["developerMode"],properties:[{class:"Boolean",name:"developerMode"}],methods:[async function execute(){const e=foam.mlang.Expressions.create();const developerCapability=await this.userCapabilityJunctionDAO.find(e.EQ(foam.nanos.crunch.UserCapabilityJunction.TARGET_ID,"developer"));this.developerMode=developerCapability!==undefined}]});
foam.CLASS({package:"foam.u2.wizard.agents",name:"RootCapabilityAgent",implements:["foam.core.ContextAgent"],exports:["rootCapability"],properties:[{name:"rootCapability",class:"String"}],methods:[async function execute(){}]});
foam.CLASS({package:"foam.u2.wizard.agents",name:"LoadScenarioAgent",implements:["foam.core.ContextAgent"],requires:["foam.classloader.OrDAO","foam.dao.ArrayDAO"],properties:[{class:"Class",name:"scenario"}],methods:[async function execute(){let x=this.__subContext__;const scenario=this.scenario.create({},x);x=x.createSubContext({capabilityDAO:this.OrDAO.create({primary:this.ArrayDAO.create({of:"foam.nanos.crunch.Capability",array:scenario.capabilities}),delegate:x.capabilityDAO}),prerequisiteCapabilityJunctionDAO:this.OrDAO.create({primary:this.ArrayDAO.create({of:"foam.nanos.crunch.CapabilityCapabilityJunction",array:scenario.capabilityCapabilityJunctions}),delegate:x.prerequisiteCapabilityJunctionDAO})});return x}]});
foam.CLASS({package:"foam.u2.wizard.agents",name:"StepWizardAgent",implements:["foam.core.ContextAgent","foam.mlang.Expressions"],imports:["ctrl","config? as importedConfig","popupMode","flowAgent?","stack","wizardController?"],requires:["foam.u2.dialog.Popup","foam.u2.stack.StackBlock","foam.u2.wizard.ScrollingStepWizardView","foam.u2.wizard.StepWizardConfig"],properties:[{name:"config",class:"FObjectProperty",of:"foam.u2.wizard.StepWizardConfig",factory:function(){return this.importedConfig||this.StepWizardConfig.create()}},"wizardStackBlock"],methods:[async function execute(){if(!this.wizardController||!this.config)console.warn("Missing controller or config");const usingFormController=this.config&&this.config.controller;window.lastWizardController=this.wizardController;const view=usingFormController?{...this.config.controller,view:this.config.wizardView}:{...this.config.wizardView};view.data=this.wizardController;view.onClose=this.resolveAgent;if((view?.class||view?.cls_?.id).endsWith("ScrollingStepWizardView")){this.wizardController.autoPositionUpdates=false}this.wizardStackBlock=this.StackBlock.create({view:view,...this.popupMode?{popup:this.config.popup||{}}:{},parent:this});await new Promise(resolve=>{this.wizardStackBlock.removed.sub(()=>{resolve()});this.flowAgent?.sub(this.cls_.name,()=>{resolve()});this.stack.push(this.wizardStackBlock)})}],listeners:[function resolveAgent(){if(this.stack.BACK.isEnabled(this.stack.pos))this.stack.back();else this.wizardStackBlock.removed.pub()}]});
foam.CLASS({package:"foam.u2.wizard.agents",name:"ElementStepWizardAgent",extends:"foam.u2.wizard.agents.StepWizardAgent",implements:["foam.core.ContextAgent","foam.mlang.Expressions"],imports:["elSlot?","detachListener?","flowAgent?"],properties:[{name:"resolved_",}],methods:[async function execute(){if(!this.elSlot){console.warn("missing element");return}const usingFormController=this.config&&this.config.controller;const view=usingFormController?{...this.config.controller,view:this.config.wizardView}:{...this.config.wizardView};view.data=this.wizardController;view.onClose=this.resolveAgent;const v=foam.u2.ViewSpec.createView(view,{},this,this.__subContext__);this.elSlot.removeAllChildren();this.elSlot.add(v);await new Promise(resolve=>{this.resolved_=this.flowAgent?.sub(this.cls_.name,()=>{resolve();this.resolveAgent()})})}],listeners:[function resolveAgent(){this.elSlot.removeAllChildren();this.detachListener?.pub("res");this.resolved_?.detach()}]});
foam.CLASS({package:"foam.u2.wizard.agents",name:"CreateControllerAgent",implements:["foam.core.ContextAgent","foam.mlang.Expressions"],requires:["foam.u2.wizard.StepWizardConfig","foam.u2.wizard.StepWizardController"],imports:["initialPosition?","wizardlets"],exports:["config","submitted","wizardController"],properties:[{name:"config",class:"FObjectProperty",of:"foam.u2.wizard.StepWizardConfig",factory:function(){return this.StepWizardConfig.create()}},{name:"submitted",class:"Boolean"},"wizardController"],methods:[async function execute(){this.wizardController=this.StepWizardController.create({wizardlets:this.wizardlets,config:this.config,submitted$:this.submitted$,...this.initialPosition?{wizardPosition:this.initialPosition}:{}});this.wizardlets.forEach(v=>{v.wizardController$=this.wizardController$})}]});
foam.CLASS({package:"foam.u2.wizard.agents",name:"SpinnerAgent",implements:["foam.core.ContextAgent"],imports:["ctrl"],exports:["as spinnerAgent"],requires:["foam.u2.LoadingSpinner","foam.u2.dialog.Popup"],properties:[{name:"pushLast",class:"Boolean"}],methods:[async function execute(){var popup=this.Popup.create({closeable:false,isStyled:false,onClose:this.pushLast?()=>{ctrl.__subContext__.pushMenu(ctrl.__subContext__.lastMenuLaunched)}:undefined}).tag(this.LoadingSpinner,{size:56});this.ctrl.add(popup);this.onDetach(popup.close.bind(popup))}]});
foam.CLASS({package:"foam.u2.wizard.agents",name:"DetachSpinnerAgent",flags:["web"],imports:["spinnerAgent?"],implements:["foam.core.ContextAgent"],methods:[async function execute(){this.spinnerAgent&&this.spinnerAgent.detach()}]});
foam.CLASS({package:"foam.u2.wizard.agents",name:"ValueAgent",properties:[{name:"value",class:"Map"}],methods:[async function execute(){return this.__subContext__.createSubContext(this.value)}]});
foam.CLASS({package:"foam.u2.wizard.agents",name:"DetachAgent",flags:["web"],imports:["wizardCloseSub","spinnerAgent?"],implements:["foam.core.ContextAgent"],methods:[async function execute(){this.wizardCloseSub.detach()}]});
foam.CLASS({package:"foam.u2.wizard.agents",name:"WizardletsAgent",implements:["foam.core.ContextAgent"],imports:["wizardlets? as priorWizardlets"],exports:["laterWizardlets as wizardlets"],properties:[{class:"FObjectArray",of:"foam.u2.wizard.wizardlet.Wizardlet",name:"wizardlets",},{class:"FObjectArray",of:"foam.u2.wizard.wizardlet.Wizardlet",name:"laterWizardlets",factory:function(){const output=this.priorWizardlets||[];for(let wizardlet of this.wizardlets){let match=output.findIndex(pw=>pw.id==wizardlet.id);if(match!=-1){output[match]=wizardlet;continue}output.push(wizardlet)}return output}}],methods:[async function execute(){}]});
foam.CLASS({package:"foam.u2.wizard.agents",name:"AlternateFlowAgent",implements:["foam.core.ContextAgent"],properties:[{class:"FObjectProperty",of:"foam.u2.wizard.AlternateFlow",name:"alternateFlow"}],methods:[async function execute(){this.alternateFlow.execute(this.__context__)}]});
foam.CLASS({package:"foam.u2.wizard.agents",name:"AnalyticEventsAgent",implements:["foam.core.ContextAgent"],requires:["foam.nanos.analytics.AnalyticEvent"],imports:["analyticEventDAO","sessionID"],exports:["analyticsAgent"],topics:["analyticsAgent"],properties:[{class:"foam.u2.wizard.PathProperty",name:"traceIDKey",},{class:"foam.u2.wizard.PathProperty",name:"objectIDKey",}],methods:[async function execute(){var self=this;var trace=this.traceIDKey$get(this.__subContext__);var obj=this.objectIDKey$get(this.__subContext__);this.analyticsAgent.sub("event",function(_,__,___,evt){let analyticEvent=self.AnalyticEvent.create({...evt,traceId:trace,objectId:obj,sessionId:self.sessionID,timestamp:new Date});self.analyticEventDAO.put(analyticEvent)})}]});
foam.CLASS({package:"foam.u2.wizard.internal",name:"PropertyUpdate",flags:["web"],properties:[{name:"id",class:"String",factory:function(){return foam.uuid.randomGUID()}},{name:"path",class:"StringArray",tableCellFormatter:function(value,obj,axiom){this.add(value?value.join("."):"")}}]});
foam.CLASS({package:"foam.u2.wizard.internal",name:"FObjectRecursionSlot",extends:"foam.core.SimpleSlot",requires:["foam.core.ExpressionSlot","foam.u2.wizard.internal.PropertyUpdate"],properties:[{name:"obj",class:"FObjectProperty",of:"foam.core.FObject"},{name:"parentRefs",class:"Array",},{name:"path",class:"StringArray"},{name:"testProp",class:"Array"},{name:"value",factory:function(){return{obj:this.obj,cause:null}}},{name:"excludeAxioms",class:"StringArray",factory:function(){return["foam.dao.ManyToManyRelationshipAxiom","foam.dao.OneToManyRelationshipAxiom","foam.dao.DAOProperty"]}},{name:"excludeProperties",class:"StringArray",factory:()=>[]},"cleanup_"],methods:[function init(){this.onDetach(this.cleanup);var debug_updateCalls=0;var update=function(obj,parentRefs){debug_updateCalls++;if(parentRefs.includes(obj)){this.cleanup();return}this.value={obj:obj,cause:this.obj$};this.subToProps_(obj)};this.onDetach(this.obj$.sub(()=>{update.call(this,this.obj,this.parentRefs)}));this.onDetach(this.parentRefs$.sub(()=>{update.call(this,this.obj,this.parentRefs)}));update.call(this,this.obj,this.parentRefs)},function set(){},function subToProps_(o){this.cleanup();var cleanup=foam.core.FObject.create();this.cleanup_=cleanup;if(!(o&&o.cls_))return;var props=o.cls_.getAxiomsByClass(foam.core.Property);for(let prop of props){if(this.excludeAxioms.some(v=>prop.cls_.id==v))continue;if(this.excludeProperties.some(v=>prop.name==v))continue;let prop$=prop.toSlot(o);if(foam.core.FObjectProperty.isInstance(prop)){if(this.parentRefs.includes(prop$))continue;let propR$=this.cls_.create({obj$:prop$,parentRefs:[...this.parentRefs,prop$,o],path:[...this.path,prop.name]},this);cleanup.onDetach(propR$.sub(()=>{this.value=propR$.get()}));continue}if(foam.core.FObjectArray.isInstance(prop)){let innerCleanup=foam.core.FObject.create();let updateArray=arry=>{innerCleanup.detach();innerCleanup=foam.core.FObject.create();let i=0;for(let elem of arry){let elemR$=this.cls_.create({obj:elem,parentRefs:[...this.parentRefs,prop$,o],path:[...this.path,i++]},this);innerCleanup.onDetach(elemR$.sub(()=>{this.value={obj:elem,cause:elemR$}}))}};cleanup.onDetach(prop$.sub(()=>{updateArray(prop$.get());this.value=this.PropertyUpdate.create({path:[...this.path,prop.name]})}));updateArray(prop$.get());continue}prop$.sub(()=>{this.value={obj:o,cause:prop$};this.value=this.PropertyUpdate.create({path:[...this.path,prop.name]})})}}],listeners:[function cleanup(){this.cleanup_&&this.cleanup_.detach()},function invalidate(){this.clearProperty("value")}]});
foam.CLASS({package:"foam.u2.wizard.internal",name:"WizardletAutoSaveSlot",extends:"foam.core.SimpleSlot",requires:["foam.u2.borders.LoadingLevel"],properties:[{name:"delay",class:"Int",value:5e3},"saveEvent","other","timeout_","cleanup_"],methods:[function init(){this.saveEvent.sub(()=>{this.timeout_&&clearTimeout(this.timeout_)});var attach=function(delay,other){this.cleanup();this.cleanup_=foam.core.FObject.create();this.cleanup_.onDetach(other.sub(()=>{this.timeout_&&clearTimeout(this.timeout_);this.timeout_=setTimeout(this.update.bind(this,other),delay)}))};foam.core.ExpressionSlot.create({args:[this.delay$,this.other$],code:attach,obj:this});attach.call(this,this.delay,this.other)},function cleanup(){this.cleanup_&&this.cleanup_.detach()},function update(s){this.clearProperty("timeout_");this.value=s.get()}]});foam.LIB({name:"foam.u2.wizard.Slot",methods:[{name:"filter",code:function(from,f){var s=foam.core.SimpleSlot.create({value:from.get()});s.onDetach(from.sub(()=>{var v=from.get();if(f(v))s.set(v)}));return s}},{name:"blockFramed",code:function(){return new Promise(resolve=>{requestAnimationFrame(()=>{requestAnimationFrame(()=>{resolve()})})})}}]});
foam.CLASS({package:"foam.u2.wizard.debug",name:"WizardEvent",flags:["web"],tableColumns:["name","summary"],properties:[{name:"id",class:"String",factory:function(){return foam.uuid.randomGUID()}},{name:"name",class:"String",factory:function(){return this.cls_.name}},{name:"summary",class:"String"},{name:"seqNo",class:"Int"}]});
foam.CLASS({package:"foam.u2.wizard.debug",name:"PropertyEvent",extends:"foam.u2.wizard.debug.WizardEvent",flags:["web"],properties:[{name:"data",class:"FObjectProperty",of:"foam.u2.wizard.internal.PropertyUpdate"},{name:"summary",class:"String",expression:function(data){return data&&data.path.join(".")}}]});
foam.CLASS({package:"foam.u2.wizard.debug",name:"ServiceEvent",extends:"foam.u2.wizard.debug.WizardEvent",flags:["web"],properties:[{name:"serviceName",class:"String"},{name:"methodName",class:"String"},{name:"arguments",class:"Array"},{name:"summary",class:"String",expression:function(serviceName,methodName,arguments){return`${serviceName}.${methodName}(...)`}}]});
foam.CLASS({package:"foam.u2.wizard.debug",name:"WAOEvent",extends:"foam.u2.wizard.debug.WizardEvent",flags:["web"],properties:[{name:"method",class:"String"},{name:"summary",class:"String",expression:function(method){return method}}]});
foam.CLASS({package:"foam.u2.wizard.debug",name:"DebugWAO",extends:"foam.u2.wizard.wao.ProxyWAO",flags:["web"],topics:["waoEvent"],properties:[{class:"Boolean",name:"listen",value:true},{class:"Boolean",name:"trap"}],methods:[async function save(...args){if(this.listen)this.waoEvent.pub("save",...args);if(this.trap)return;return await this.SUPER(...args)},async function load(...args){if(this.listen)this.waoEvent.pub("load",...args);if(this.trap)return;return await this.SUPER(...args)}]});
foam.CLASS({package:"foam.u2.wizard.debug",name:"DebugContextIntercept",topics:["stubMethodCalled"],requires:["foam.u2.wizard.debug.ServiceEvent"],methods:[function createInterceptedValues(x){var self=this;var subContext={};for(let key in x){let contextValue=null;try{contextValue=x[key]}catch{continue}if(foam.core.Slot.isInstance(contextValue))continue;if(!foam.core.FObject.isInstance(contextValue))continue;let stubMethods=contextValue.cls_.getAxiomsByClass(foam.core.StubMethod).map(ax=>ax.name);if(stubMethods.length==0)continue;subContext[key]=new Proxy(contextValue,{get:function(target,prop){if(stubMethods.includes(prop)){return function(...args){self.stubMethodCalled.pub(self.ServiceEvent.create({serviceName:key,methodName:prop,arguments:args}));return contextValue[prop].call(target,...args)}}return contextValue[prop]}})}subContext["debugContextIntercept"]=this;return subContext}]});
foam.CLASS({package:"foam.u2.wizard.debug",name:"DebugWizardletView",extends:"foam.u2.Controller",imports:["debugContextIntercept","sequence","wizardlets"],requires:["foam.dao.MDAO","foam.u2.borders.CollapseBorder","foam.u2.borders.LoadingLevel","foam.u2.view.ScrollTableView","foam.u2.wizard.debug.DebugWAO","foam.u2.wizard.debug.PropertyEvent","foam.u2.wizard.debug.WAOEvent","foam.u2.wizard.debug.WizardEvent","foam.u2.wizard.internal.PropertyUpdate"],css:`
^ {
margin-top: 15pt;
border: 3pt solid /*%DESTRUCTIVE3%*/ #C00;
border-radius: 6px;
}
^title {
background-color: /*%DESTRUCTIVE3%*/ #C00;
color: #FFF;
padding: 2pt 8pt;
font-size: 12pt;
}
^ .foam-u2-borders-CollapseBorder.expanded {
border-bottom: 0;
border-left: 0;
border-right: 0;
}
`,properties:[{name:"wizardlet",class:"FObjectProperty",of:"foam.u2.wizard.wizardlet.Wizardlet"},{name:"reloadCount",label:"Reload Count",class:"Int"},"wizardEventDAO"],methods:[function init(){this.SUPER();if(!this.wizardlet){throw new Error("must be initialized with wizardlet")}this.wizardEventDAO=this.MDAO.create({of:this.WizardEvent});var s=this.wizardlet.getDataUpdateSub();var seqNo=0;this.debugContextIntercept.stubMethodCalled.sub((_1,_2,ev)=>{ev.seqNo=++seqNo;this.wizardEventDAO.put(ev)});if(this.DebugWAO.isInstance(this.wizardlet.wao)){this.wizardlet.wao.waoEvent.sub((_1,_2,ev)=>{this.wizardEventDAO.put(this.WAOEvent.create({method:ev,seqNo:++seqNo}))})}var autoSaveEnabled=this.sequence.contains("AutoSaveWizardletsAgent");s.sub(()=>{if(!autoSaveEnabled)this.wizardlet.loadingLevel=this.LoadingLevel.IDLE;var propertyUpdate=s.get();if(!this.PropertyUpdate.isInstance(propertyUpdate)){propertyUpdate=this.PropertyUpdate.create({path:"%unknown%"})}this.wizardEventDAO.put(this.PropertyEvent.create({data:propertyUpdate,seqNo:++seqNo}));this.reloadCount++})},function render(){this.SUPER();this.addClass(this.myClass()).start().addClass(this.myClass("title")).add("Developer Tools: ").add(this.wizardlet.title$).end().startContext({controllerMode:"VIEW"}).start(this.CollapseBorder,{title:"Property Updates",expanded:false}).tag(this.ScrollTableView,{data$:this.wizardEventDAO$.map(dao=>dao.orderBy(this.WizardEvent.SEQ_NO))}).end().start(this.CollapseBorder,{title:"Debug Actions",expanded:false}).start().tag(this.SAVE).tag(this.LOAD_ACTION).end().end().endContext()}],actions:[function save(){try{this.wizardlet.save()}catch(e){console.error(e)}},{name:"loadAction",label:"Load",code:function loadAction(){this.wizardlet.load()}}]});
foam.CLASS({package:"foam.u2.wizard.debug",name:"TestWizardMenu",extends:"foam.nanos.menu.Menu",imports:["stack"],requires:["foam.dao.ArrayDAO","foam.nanos.menu.Menu","foam.u2.wizard.debug.TestWizardScenarioMenu"],properties:[{class:"StringArray",name:"packages",factory:()=>["foam.u2.wizard.debug.scenarios"]},{name:"children_",factory:function(){const scenarioMenus=[];scenarioMenus.push(this.Menu.create({id:this.id+"/ElementWizardTest",label:"Element Wizard Test",parent:this.id,handler:foam.nanos.menu.ViewMenu.create({view:{class:"net.nanopay.cards.test.wizards.ElementTest"}},this)}));for(const packageString of this.packages){const pkg=packageString.split(".").reduce((o,k)=>o?.[k],globalThis);if(pkg===undefined)throw new Error(`could not load wizard scenarios from: ${packageString}`);scenarioMenus.push(...Object.getOwnPropertyNames(pkg).map(scenarioName=>this.Menu.create({id:this.id+"/"+scenarioName,label:foam.String.labelize(scenarioName),parent:this.id,handler:this.TestWizardScenarioMenu.create({scenarioCls:pkg[scenarioName]})})))}return this.ArrayDAO.create({array:scenarioMenus})}},{name:"children",getter:function(){return this.children_}}]});
foam.CLASS({package:"foam.u2.wizard.debug",name:"TestWizardScenarioMenu",extends:"foam.nanos.menu.AbstractMenu",imports:["crunchController","stack"],exports:["fakeCapabilityDAO as capabilityDAO","fakePrerequisiteCapabilityDAO as prerequisiteCapabilityJunctionDAO"],requires:["foam.dao.ArrayDAO","foam.u2.crunch.wizardflow.LoadCapabilityGraphAgent","foam.u2.crunch.wizardflow.GraphWizardletsAgent","foam.u2.stack.StackBlock","foam.u2.wizard.agents.RootCapabilityAgent","foam.u2.wizard.debug.scenarios.MinMaxChoicePrereqLiftScenario","foam.util.async.Sequence"],properties:[{class:"foam.dao.DAOProperty",name:"fakeCapabilityDAO",flags:["web"],expression:function(scenario){return this.ArrayDAO.create({of:"foam.nanos.crunch.Capability",array:scenario.capabilities})}},{class:"foam.dao.DAOProperty",name:"fakePrerequisiteCapabilityDAO",flags:["web"],expression:function(scenario){return this.ArrayDAO.create({of:"foam.nanos.crunch.CapabilityCapabilityJunction",array:scenario.capabilityCapabilityJunctions})}},{class:"Class",name:"scenarioCls",flags:["web"]},{class:"FObjectProperty",of:"foam.u2.wizard.debug.TestWizardScenario",name:"scenario",flags:["web"],expression:function(scenarioCls){if(!scenarioCls)return null;return scenarioCls.create({},this)}}],methods:[function launch(X){this.launch_(X)},async function launch_(X){X=X.createSubContext({capabilityDAO:this.fakeCapabilityDAO,prerequisiteCapabilityJunctionDAO:this.fakePrerequisiteCapabilityDAO});const sequence=this.crunchController.createTransientWizardSequence(X).addBefore("ConfigureFlowAgent",this.RootCapabilityAgent,{rootCapability:"Entry"}).addBefore("CreateWizardletsAgent",this.LoadCapabilityGraphAgent).addBefore("CreateWizardletsAgent",this.GraphWizardletsAgent).remove("CreateWizardletsAgent").remove("GrantedEditAgent").remove("CapabilityStoreAgent");this.scenario.installInSequence(sequence);await sequence.execute()}]});
foam.CLASS({package:"foam.u2.wizard.debug",name:"TestWizardScenario",properties:[{class:"FObjectArray",of:"foam.nanos.crunch.Capability",name:"capabilities",adapt:function(o,n,prop){n=n.map(o=>({...o,name:o.name||foam.String.labelize(o.id)}));return foam.json.parse(n,prop.of,this.__subContext__)}},{class:"FObjectArray",of:"foam.nanos.crunch.CapabilityCapabilityJunction",name:"capabilityCapabilityJunctions",adapt:function(o,n,prop){n=n.map(spec=>foam.Array.isInstance(spec)?{sourceId:spec[0],targetId:spec[1]}:spec);return foam.json.parse(n,prop.of,this.__subContext__)}}],methods:[function installInSequence(sequence){}]});[{name:"LiftOneAllowTwo",choices:["ChoiceA","ChoiceB","ChoiceC"],lifted:["ChoiceA"],max:2},{name:"LiftOneAllowOne",choices:["ChoiceA","ChoiceB","ChoiceC"],lifted:["ChoiceA"],max:1}].forEach(META=>
foam.CLASS({package:"foam.u2.wizard.debug.scenarios",name:META.name,extends:"foam.u2.wizard.debug.TestWizardScenario",properties:[{class:"FObjectArray",of:"foam.nanos.crunch.Capability",name:"capabilities",factory:()=>[{class:"foam.nanos.crunch.Capability",id:"Entry",wizardConfig:{class:"foam.u2.crunch.EasyCrunchWizard",incrementalWizard:true}},...META.choices.map((name,i)=>({class:"foam.nanos.crunch.Capability",id:name,of:["String","Int","Boolean"].map(v=>`foam.core.${v}Holder`)[i%3]})),{class:"foam.nanos.crunch.MinMaxCapability",id:"MinMax",min:1,max:META.max},{class:"foam.nanos.crunch.Capability",id:"Choice.D.A",of:"foam.core.IntHolder"},{class:"foam.nanos.crunch.Capability",id:"Choice.D.B",of:"foam.core.BooleanHolder"}]},{class:"FObjectArray",of:"foam.nanos.crunch.CapabilityCapabilityJunction",name:"capabilityCapabilityJunctions",factory:()=>[...META.lifted.map(name=>["Entry",name]),["Entry","MinMax"],...META.choices.map(name=>["MinMax",name])]}]}));
foam.CLASS({package:"foam.u2.wizard.debug.scenarios",name:"PrerequisiteLoaderScenario",extends:"foam.u2.wizard.debug.TestWizardScenario",properties:[{class:"FObjectArray",of:"foam.nanos.crunch.Capability",name:"capabilities",factory:()=>[{class:"foam.nanos.crunch.Capability",id:"Entry",wizardConfig:{class:"foam.u2.crunch.EasyCrunchWizard",incrementalWizard:true}},{class:"foam.nanos.crunch.Capability",id:`HasData`,of:"foam.core.StringHolder"},{class:"foam.nanos.crunch.Capability",id:`WantsData`,of:"foam.core.StringHolder",wizardlet:{class:"foam.nanos.crunch.ui.CapabilityWizardlet",wao:{class:"foam.u2.wizard.wao.SplitWAO",loader:{class:"foam.u2.wizard.data.PrerequisiteLoader",prerequisiteCapabilityId:"HasData"}}}}]},{class:"FObjectArray",of:"foam.nanos.crunch.CapabilityCapabilityJunction",name:"capabilityCapabilityJunctions",factory:()=>[["Entry","WantsData"],["WantsData","HasData"]]}]});
foam.CLASS({package:"foam.u2.wizard.debug.scenarios",name:"PrerequisiteWAOScenario",extends:"foam.u2.wizard.debug.TestWizardScenario",properties:[{class:"FObjectArray",of:"foam.nanos.crunch.Capability",name:"capabilities",factory:()=>[{class:"foam.nanos.crunch.Capability",id:"Entry",wizardConfig:{class:"foam.u2.crunch.EasyCrunchWizard",incrementalWizard:true}},{class:"foam.nanos.crunch.Capability",id:`HasData`,of:"foam.core.StringHolder"},{class:"foam.nanos.crunch.Capability",id:`WantsData`,of:"foam.core.StringHolder",wizardlet:{class:"foam.nanos.crunch.ui.CapabilityWizardlet",wao:{class:"foam.u2.wizard.wao.PrerequisiteWAO",of:"foam.core.StringHolder",prerequisiteCapabilityId:"HasData"}}}]},{class:"FObjectArray",of:"foam.nanos.crunch.CapabilityCapabilityJunction",name:"capabilityCapabilityJunctions",factory:()=>[["Entry","WantsData"],["WantsData","HasData"]]}]});
foam.CLASS({package:"foam.u2.wizard.controllers",name:"WizardController",extends:"foam.u2.Controller",issues:["should not depend on legacy controller"],properties:[{class:"FObjectProperty",name:"data",label:"legacy controller",},{class:"Function",name:"onClose"},{class:"foam.u2.ViewSpec",name:"view",value:{class:"foam.u2.borders.NullBorder"}}]});
foam.CLASS({package:"foam.u2.wizard.controllers",name:"IncrementalWizardController",extends:"foam.u2.wizard.controllers.WizardController",requires:["foam.u2.wizard.DynamicActionWizardlet","foam.u2.wizard.WizardStatus","foam.u2.wizard.axiom.WizardAction"],issues:["should not depend on legacy controller"],properties:[{name:"data",postSet:function(_,v){this.currentWizardlet$=v.currentWizardlet$;this.currentSection$=v.currentSection$;this.onDetach(v.status$.sub(()=>{if(v==this.WizardStatus.IN_PROGRESS)return;this.onClose({completed:v.status==this.WizardStatus.COMPLETED})}))}},"currentWizardlet","currentSection",{name:"backDisabled",class:"Boolean",value:false},{class:"Boolean",name:"discardAvailable"},{class:"Boolean",name:"isLoading_",value:false},{class:"FObjectArray",of:"foam.core.Action",name:"actionBar",getter:function(){const currentWizardlet=this.currentWizardlet;let wizardletActions=[];if(this.DynamicActionWizardlet.isInstance(currentWizardlet)&&currentWizardlet.dynamicActions?.length){wizardletActions=currentWizardlet.dynamicActions}else{wizardletActions=currentWizardlet.cls_.getAxiomsByClass(this.WizardAction)}let goNextAction=this.GO_NEXT;let goPrevAction=this.GO_PREV;const actionBar=[];for(let action of wizardletActions){if(action.name==="goNext"){if(action.cls_==foam.core.Action){goNextAction=this.GO_NEXT.clone().copyFrom(action);goNextAction.buttonStyle="PRIMARY";continue}goNextAction=action;goNextAction.buttonStyle="PRIMARY";const copyProperties=["isAvailable","isEnabled"];for(const k of copyProperties){if(!goNextAction[k])goNextAction[k]=this.GO_NEXT[k]}continue}if(action.name==="goPrev"){goPrevAction=action;continue}actionBar.push(action)}if(this.discardAvailable){actionBar.push(this.DISCARD)}actionBar.push(goPrevAction,goNextAction);return actionBar}}],actions:[{name:"saveAndClose",label:"Save and exit",code:function(x){this.data.saveProgress().then(()=>{this.onClose({})}).catch(e=>{console.error(e);x.ctrl.notify(this.ERROR_MSG_DRAFT,"",this.LogLevel.ERROR,true)})}},{name:"discard",icon:"images/ic-cancelblack.svg",isAvailable:function(discardAvailable){return discardAvailable},code:function(){this.data.discard()}},{name:"goPrev",label:"Back",icon:"images/arrow-back-24px.svg",isEnabled:function(isLoading_){return!isLoading_},isAvailable:function(data$canGoBack,backDisabled){return!backDisabled&&data$canGoBack},code:function(){this.data.back()}},{name:"goNext",label:"Next",buttonStyle:"PRIMARY",isEnabled:function(data$canGoNext,isLoading_){return data$canGoNext&&!isLoading_},isAvailable:function(isLoading_){return!isLoading_},code:function(x){this.isLoading_=true;this.data.next().then(isFinished=>{if(isFinished){for(let w of this.data.wizardlets){if(w.submit)w.submit()}}}).catch(e=>{console.error(e);x.ctrl.notify(this.ERROR_MSG,"",this.LogLevel.ERROR,true)}).finally(()=>{this.isLoading_=false})}}]});
foam.CLASS({package:"foam.u2.wizard.views",name:"FlexibleWizardContentsView",extends:"foam.u2.View",issues:["Add loading spinner support to ^"],imports:["actionProvider?","developerMode?"],requires:["foam.u2.ActionReference"],css:`
^ {
display: flex;
flex-direction: column;
justify-content: space-between;
gap: 40pt;
}
^flexButtons {
display: flex;
flex-direction: column;
gap: 20pt;
padding-bottom: 3.2rem;
}
}
^flexButtons > * {
flex-grow: 1;
margin-left: 0 !important;
}
`,properties:[{name:"onClose",class:""}],methods:[function render(){const self=this;console.log("FlexibleWizaard",self);const current$=this.slot(function(data,data$currentWizardlet,data$currentSection){return data$currentSection?.createView()??this.E()});let actionsDetachable=foam.core.FObject.create();this.addClass().add(current$).add(this.slot(function(data$actionBar,data$currentWizardlet){let actions=data$actionBar;actions=[...actions];actionsDetachable.detach();actionsDetachable=foam.core.FObject.create();if(self.actionProvider){const prevIndex=actions.findIndex(a=>a.name=="goPrev");if(prevIndex!=-1){actions=[...actions];const actionRef=this.ActionReference.create({action:actions[prevIndex],data:this.data});self.actionProvider.addAction(actionRef);actionsDetachable.onDetach(function(){self.actionProvider.removeAction(actionRef)});actions.splice(prevIndex,1)}const discardIndex=actions.findIndex(a=>a.name=="discard");if(discardIndex!=-1){self.actionProvider.closeAction=this.ActionReference.create({action:actions[discardIndex],data:this.data});actions.splice(discardIndex,1)}}let slots=[];actions.forEach(a=>{slots.push(a.createIsAvailable$(self.__subContext__,self.data))});let s=foam.core.ArraySlot.create({slots:slots},self);let anyAvailable=this.slot(function(slots){for(let slot of slots){if(slot)return true}return false},s);return this.E().addClass(self.myClass("flexButtons")).show(anyAvailable).callIf(self.developerMode,function(){this.startContext({data:self.data.data}).tag(self.data.data.OPEN_WIZARD_INSPECTOR).endContext()}).startContext({currentWizardletSectionView:current$}).forEach(actions.reverse(),function(action){this.tag(action,{size:"LARGE",label:self.data.currentWizardlet.actionLabel||action.label})}).endContext()}))}]});
foam.CLASS({package:"foam.u2.wizard.views",name:"ProgressBarWizardView",extends:"foam.u2.View",css:`
^ {
width: auto;
}
`,properties:[["nodeName","progress"]],methods:[function render(){this.addClass().attr("max",this.data$.dot("data").dot("wizardlets").map(w=>w?w.length:0)).attr("value",this.data$.dot("data").dot("wizardPosition").dot("wizardletIndex"))}]});
foam.CLASS({package:"foam.u2.wizard.views",name:"FocusWizardForm",extends:"foam.u2.wizard.controllers.IncrementalWizardController",imports:["popup?"],exports:["showTitle"],css:`
^ {
display: flex;
flex-direction: column;
width: 65vw;
min-height: 65vh;
padding: 3.2rem 0;
flex-grow: 1;
/**
* Make this work with conditional titles 
* gap: 1.6rem; 
*/
}
^:not(^isFullscreen) {
margin: 40pt;
margin-top: 0;
}
@media only screen and (min-width: /*%DISPLAYWIDTH.MD%*/ 768px) {
^:not(^isFullscreen) {
width: 45vw;
}
}
@media only screen and (min-width: /*%DISPLAYWIDTH.LG%*/ 960px) {
^:not(^isFullscreen) {
width: 25vw;
}
}
^contents {
flex: 1;
min-height: 0;
}
^wizardletTitle {
text-align: center;
margin-bottom: 1.6rem;
}
^wizardletSub {
font-size: 1.6rem;
}
`,properties:[{class:"foam.u2.ViewSpec",name:"progressWizardView",value:{class:"foam.u2.wizard.views.ProgressBarWizardView"}},{class:"Boolean",name:"showTitle"}],methods:[function render(){const self=this;this.addClass().enableClass(this.myClass("isFullscreen"),this.popup?.fullscreen$).start(this.progressWizardView,{data:this}).addClass(this.myClass("progress")).end().add(this.slot(function(showTitle,data$currentWizardlet){return showTitle&&data$currentWizardlet.showTitle?this.E().start().addClasses(["h300",self.myClass("wizardletTitle")]).add(data$currentWizardlet.title).end():null})).add(this.slot(function(data$currentWizardlet){return data$currentWizardlet.subTitle?this.E().start().addClasses([self.myClass("wizardletTitle"),"p",self.myClass("wizardletSub")]).add(data$currentWizardlet.subTitle).end():null})).start(this.view,{data:this}).addClass(this.myClass("contents")).end()}]});
foam.CLASS({package:"foam.u2.wizard",name:"PathProperty",extends:"foam.mlang.ExprProperty",implements:["foam.mlang.Expressions"],requires:["foam.core.Property","foam.mlang.expr.Dot"],properties:[{name:"adapt",value:function(_,o,p){if(!foam.String.isInstance(o))return p.adaptValue(o);const parts=o.split(".");let expr=null;for(let part of parts){const partialProperty=foam.core.Property.create({name:part});expr=expr?p.DOT(expr,partialProperty):partialProperty}return expr}}],methods:[function installInProto(proto){this.SUPER(proto);const prop=this;Object.defineProperty(proto,this.name+"$get",{configurable:true,get:function pathGetter(){return function(target){return this[prop.name]?.f(target)}}});Object.defineProperty(proto,this.name+"$set",{configurable:true,get:function pathSetter(){return function(target,value){const expr=this[prop.name];if(prop.Property.isInstance(expr)){target[expr.name]=value}else if(prop.Dot.isInstance(expr)){target=expr.arg1.f(target);target[expr.arg2.name]=value}}}})}]});
foam.CLASS({package:"foam.u2.wizard.debug",name:"WizardInspector",extends:"foam.u2.Controller",imports:["wizardController"],requires:["foam.u2.DetailPropertyView","foam.u2.borders.Block"],static:[function OPEN(opt_args,opt_x){const windowProps="width=800,height=800,scrollbars=no";const w=globalThis.window.open("","Wizard Inspector",windowProps,true);document.body.addEventListener("beforeunload",()=>w.close());w.document.body.innerText="";w.document.body.innerHTML="<title>Wizard Inspector</title>";w.document.$UID=foam.next$UID();var window=foam.core.Window.create({window:w},opt_x||ctrl);var v=this.create(opt_args||{},window);v.write(window.document)}],css:`
^, ^wizardlet-list {
display: flex;
flex-direction: column;
}
^wizardlet-row {
display: flex;
flex-direction: column;
}
^wizardlet-row:not(:last-of-type) {
margin-bottom: 4px;
}
^wizardlet-actions {
display: flex;
align-items: center;
}
^ .foam-u2-borders-Block {
border-color: #333;
}
^current.foam-u2-borders-Block {
border-color: /*%PRIMARY1%*/ #3F3;
}
`,methods:[function render(){const self=this;const wizardController=self.wizardController;this.addClass(this.myClass()).start("h1").add(wizardController.title||"Untitled Wizard").end().startContext({data:wizardController}).tag(self.STORE_GLOBAL).endContext().start("h2").add("wizardlets").end().start(this.Block).add(wizardController.wizardlets$.map(()=>this.E().addClass(self.myClass("wizardlet-list")).forEach(wizardController.wizardlets,function(wizardlet){this.start(self.Block).addClass(wizardController.currentWizardlet$.map(()=>wizardController.currentWizardlet===wizardlet?self.myClass("current"):self.myClass("not-current"))).addClass(self.myClass("wizardlet-row")).startContext({data:wizardlet}).add(wizardlet.TITLE).start().addClass(self.myClass("wizardlet-actions")).tag(wizardlet.IS_AVAILABLE).add("isAvailable").tag(wizardlet.IS_VISIBLE).add("isVisible").tag(self.STORE_GLOBAL,{size:"SMALL"}).end().endContext().end()}))).end()}],actions:[{name:"storeGlobal",label:"Store as Global Variable",code:function storeGlobal(){for(let i=1;true;i++){const nameToTry="temp"+i;if(globalThis.hasOwnProperty(nameToTry))continue;globalThis[nameToTry]=this;console.log(`%cstored wizardlet: %c${nameToTry} %o`,"font-weight: bold","color: #fc0373;",this);break}}}]});
foam.CLASS({package:"foam.u2.wizard",name:"AlternateFlow",imports:["wizardlets?"],properties:[{class:"String",name:"name"},{class:"String",name:"label"},{class:"StringArray",name:"available"},{class:"StringArray",name:"unavailable"},{class:"StringArray",name:"visible"},{class:"StringArray",name:"invisible"},{class:"StringArray",name:"removals"},{class:"Array",name:"select"}],methods:[function execute(x){[["unavailable","isAvailable",false],["available","isAvailable",true],["invisible","isVisible",false],["visible","isVisible",true]].forEach(([listProp,propToChange,newValue])=>{for(const wizardletId of this[listProp]){const w=x.wizardlets.find(w=>w.id==wizardletId);w[propToChange]=newValue}});if(this.select.length!=0){for(let item of this.select){foam.assert(item.length==2,"'select' entries in AlternateFlow must have two elements");let minMaxId=item[0];let choices=item[1];let w=x.wizardlets.find(w=>w.id===minMaxId);w.data.selectedData=choices}}}]});
foam.CLASS({package:"foam.u2.wizard.axiom",name:"WizardAction",extends:"foam.core.Action",properties:[{name:"code",value:function(slot){const wizardController=slot.data$.get();wizardController.goNext()}}]});
foam.CLASS({package:"foam.u2.wizard.axiom",name:"AlternateFlowAction",extends:"foam.u2.wizard.axiom.WizardAction",properties:[{name:"name",expression:function(alternateFlow){return alternateFlow.name}},{name:"label",expression:function(alternateFlow){return alternateFlow.label}},{class:"FObjectProperty",of:"foam.u2.wizard.AlternateFlow",name:"alternateFlow"},{name:"code",value:function(slot,action){const wizardController=slot.data$.get();action.alternateFlow.execute(wizardController.data.__subContext__);wizardController.goNext()}}]});
foam.CLASS({package:"foam.u2.wizard",name:"WizardPosition",properties:[{name:"wizardletIndex",class:"Int"},{name:"sectionIndex",class:"Int"}],methods:[function compareTo(b){let a=this;let wizardletDiff=a.wizardletIndex-b.wizardletIndex;if(wizardletDiff!=0)return wizardletDiff;return a.sectionIndex-b.sectionIndex},function apply(list){return list[this.wizardletIndex][this.sectionIndex]},{name:"hash",code:function hash(){var a=this.wizardletIndex;var b=this.sectionIndex;return(a+b)*(a+b+1)/2+a}},function getNext(wizardlets){let wi=this.wizardletIndex;if(this.sectionIndex<wizardlets[wi].sections.length-1){return this.cls_.create({wizardletIndex:wi,sectionIndex:this.sectionIndex+1},this.__context__)}wi++;while(wi<wizardlets.length){if(wizardlets[wi].sections.length>0)return this.cls_.create({wizardletIndex:wi,sectionIndex:0},this.__context__);wi++}return null},function getPrevious(wizardlets){let wi=this.wizardletIndex;if(this.sectionIndex>0){return this.cls_.create({wizardletIndex:wi,sectionIndex:this.sectionIndex-1},this.__context__)}wi--;while(wi>=0){if(wizardlets[wi].sections.length>0)return this.cls_.create({wizardletIndex:wi,sectionIndex:0},this.__context__);wi--}return null},function*iterate(wizardlets,isBackwards){const iterFunc=isBackwards?"getPrevious":"getNext";let pos=this;while(true){pos=pos[iterFunc](wizardlets);if(pos==null)return;yield pos}}]});foam.ENUM({package:"foam.u2.wizard",name:"WizardStatus",values:["IN_PROGRESS","DISCARDED","COMPLETED"]});foam.ENUM({package:"foam.u2.wizard",name:"WizardletIndicator",values:[{name:"PLEASE_FILL"},{name:"COMPLETED"},{name:"SAVING"},{name:"NETWORK_FAILURE"}]});foam.INTERFACE({package:"foam.u2.wizard",name:"DynamicActionWizardlet",properties:[{of:"foam.core.Action",name:"dynamicActions",expression:()=>[]}]});foam.INTERFACE({package:"foam.u2.wizard",name:"WizardletAware",methods:[{name:"getUpdateSlot"},{name:"installInWizardlet"}]});
foam.CLASS({package:"foam.u2.wizard",name:"AbstractWizardletAware",flags:[],implements:[{path:"foam.u2.wizard.WizardletAware",flags:["web"]}],requires:["foam.u2.wizard.internal.FObjectRecursionSlot"],properties:[{name:"customUpdateSlot",class:"Boolean",hidden:true,transient:true}],methods:[function installInWizardlet(w){},function getUpdateSlot(){var sl=this.FObjectRecursionSlot.create({obj:this});return sl}]});
foam.CLASS({package:"foam.u2.wizard",name:"WizardletView",extends:"foam.u2.View",properties:[{class:"String",name:"title"},{name:"wizardlets",class:"FObjectArray",of:"foam.u2.wizard.wizardlet.Wizardlet"}]});
foam.CLASS({package:"foam.u2.wizard",name:"StepWizardConfig",implements:["foam.core.ContextAware"],properties:[{class:"Boolean",name:"allowSkipping",},{class:"Boolean",name:"allowBacktracking",value:true,},{class:"Boolean",name:"requireAll",},{class:"Boolean",name:"rejectOnInvalidatedSave",value:false},{class:"foam.u2.ViewSpec",name:"controller"},{deprecated:true,class:"foam.u2.ViewSpec",name:"wizardView",flags:["web"],expression:function(controller){return controller?{class:"foam.u2.wizard.views.FlexibleWizardContentsView"}:{class:"foam.u2.wizard.ScrollingStepWizardView"}}},{class:"foam.u2.ViewSpec",name:"popup",factory:function(){return{class:"foam.u2.dialog.Popup"}}}],methods:[async function execute(){return}]});
foam.CLASS({package:"foam.u2.wizard",name:"StepWizardController",imports:["developerMode","analyticsAgent?"],requires:["foam.core.FObject","foam.u2.wizard.WizardPosition","foam.u2.wizard.WizardStatus","foam.u2.wizard.WizardletIndicator","foam.u2.wizard.StepWizardConfig","foam.u2.wizard.debug.WizardInspector"],properties:[{class:"String",name:"title"},{name:"config",class:"FObjectProperty",of:"foam.u2.wizard.StepWizardConfig",factory:function(){return this.StepWizardConfig.create()}},{name:"wsub",class:"FObjectProperty",of:"FObject",description:`
Subscription for listeners of wizardlets' state. This is replaced if the
list of wizardlets is updated.
`},{name:"wizardlets",class:"FObjectArray",of:"foam.u2.wizard.wizardlet.Wizardlet",postSet:function(_,n){this.setupWizardletListeners(n);this.determineWizardActions(n)}},{name:"wizardPosition",class:"FObjectProperty",of:"foam.u2.wizard.WizardPosition",factory:function(){return this.WizardPosition.create({wizardletIndex:0,sectionIndex:0})},preSet:function(_,n){this.wizardlets[n.wizardletIndex].load();return n},postSet:function(o,n){if(o&&n&&o.wizardletIndex!==n.wizardletIndex){this.wizardlets[o.wizardletIndex].isCurrent=false;this.wizardlets[n.wizardletIndex].isCurrent=true}}},{name:"nextScreen",expression:function(wizardPosition){return this.nextAvailable(wizardPosition)}},{name:"previousScreen",expression:function(wizardPosition){return this.nextAvailable(wizardPosition,true)}},{name:"visitedWizardlets",class:"FObjectArray",of:"foam.u2.wizard.wizardlet.Wizardlet"},{name:"currentWizardlet",expression:function(wizardlets,wizardPosition){var current=wizardlets[wizardPosition.wizardletIndex];if(this.visitedWizardlets.indexOf(current)==-1){this.visitedWizardlets.push(current)}return current}},{name:"currentSection",expression:function(wizardlets,wizardPosition$wizardletIndex,wizardPosition$sectionIndex){return wizardlets[wizardPosition$wizardletIndex].sections[wizardPosition$sectionIndex]}},{name:"isLastScreen",class:"Boolean",expression:function(nextScreen){return nextScreen==null}},{name:"canGoBack",class:"Boolean",expression:function(previousScreen){if(previousScreen==null)return false;const{wizardPosition,wizardlets}=this;for(let pos of wizardPosition.iterate(wizardlets,true)){if(pos.wizardletIndex==wizardPosition.wizardletIndex)continue;if(pos.compareTo(previousScreen)<0)break;if(wizardlets[pos.wizardletIndex].irreversible)return false}return true}},{name:"canGoNext",class:"Boolean",expression:function(wizardPosition,nextScreen,currentSection,currentWizardlet,currentSection$isValid,currentWizardlet$isValid,config$allowSkipping){if(config$allowSkipping)return true;if(!nextScreen||wizardPosition.wizardletIndex!=nextScreen.wizardletIndex){if(!currentWizardlet$isValid)return false}return currentSection$isValid}},{class:"Enum",name:"status",of:"foam.u2.wizard.WizardStatus",value:"IN_PROGRESS",postSet:function(o,n){if(o!=n)this.analyticsAgent?.pub("event",{name:"WIZARD_STATUS_"+n})}},{name:"submitted",class:"Boolean",deprecated:true,expression:function(status){return status==this.WizardStatus.COMPLETED}},{name:"allValid",class:"Boolean"},{name:"someFailures",class:"Boolean"},{class:"Boolean",name:"autoPositionUpdates",value:true}],methods:[function init(){this.analyticsAgent?.pub("event",{name:"WIZARD_STATUS_"+this.status})},function setupWizardletListeners(wizardlets){console.debug("step wizard",this);if(this.wsub)this.wsub.detach();this.wsub=this.FObject.create();this.onWizardletValidity();var wi=0,si=0;wizardlets.forEach((w,wizardletIndex)=>{var isAvailable$=w.isAvailable$;this.wsub.onDetach(isAvailable$.sub(()=>{this.onWizardletAvailability(wizardletIndex,isAvailable$.get())}));w.sections.forEach((section,sectionIndex)=>{var sectionPosition=this.WizardPosition.create({wizardletIndex:wizardletIndex,sectionIndex:sectionIndex});var isAvailable$=section.isAvailable$;this.wsub.onDetach(isAvailable$.sub(()=>{this.onSectionAvailability(sectionPosition,isAvailable$.get())}))});var isValid$=w.isValid$;this.wsub.onDetach(isValid$.sub(()=>{this.onWizardletValidity()}));var indicator$=w.indicator$;this.wsub.onDetach(indicator$.sub(()=>{this.onWizardletIndicator(wizardletIndex,indicator$.get())}))})},function determineWizardActions(wizardlets){},function detach(){this.wsub.detach();this.SUPER()},function nextAvailable(pos,goBackwards){if(!pos)return null;const iterator=pos.iterate(this.wizardlets,goBackwards);for(const p of iterator){let wizardlet=this.wizardlets[p.wizardletIndex];if(!wizardlet.isVisible)continue;if(wizardlet.sections.length>0&&wizardlet.sections[p.sectionIndex].isAvailable)return p}return null},function saveProgress(){return this.wizardlets.reduce((p,wizardlet)=>this.visitedWizardlets.indexOf(wizardlet)==-1?p:p.then(()=>wizardlet.save()),Promise.resolve())},async function next(){const canLandOn_=pos=>{const wizardlet=this.wizardlets[pos.wizardletIndex];if(!wizardlet.isVisible)return false;if(wizardlet.sections.length<1)return false;const section=wizardlet.sections[pos.sectionIndex];if(!section.isAvailable)return false;return true};let wizardlet=this.currentWizardlet;const iterator=this.wizardPosition.iterate(this.wizardlets);for(const pos of iterator){nextPositionWizardlet=this.wizardlets[pos.wizardletIndex];if(!nextPositionWizardlet.isAvailable)continue;if(nextPositionWizardlet!=wizardlet){await wizardlet.save();this.onWizardletCompleted(wizardlet);wizardlet=nextPositionWizardlet;await wizardlet.load()}if(canLandOn_(pos)){this.wizardPosition=pos;return false}}await wizardlet.save();this.status=this.WizardStatus.COMPLETED;return true},function back(){let previousScreen=this.previousScreen;if(previousScreen==null){throw new Error("back() called without checking canGoBack")}this.wizardPosition=previousScreen},function countAvailableSections(wizardletIndex){return this.wizardlets[wizardletIndex].sections.filter(s=>s.isAvailable).length},function canSkipTo(pos){var start=this.wizardPosition;var diff=pos.compareTo(this.wizardPosition);if(diff==0)return true;if(this.nextScreen&&pos.compareTo(this.nextScreen)==0)return this.canGoNext;if(this.previousScreen&&pos.compareTo(this.previousScreen)==0)return this.canGoBack;if(diff<0)return this.allowBacktracking;if(this.allowSkipping)return true;var lastWizardletIndex=start.wizardletIndex;for(let p=start;p!=null;p=p.getNext(this.wizardlets)){if(p.wizardletIndex!=lastWizardletIndex){if(!this.wizardlets[lastWizardletIndex].isValid){return false}}if(p.compareTo(pos)==0)return true;let wizardlet=this.wizardlets[p.wizardletIndex];let section=this.wizardlets[p.sectionIndex]}},function skipTo(pos){this.wizardPosition=pos},function discard(){this.status=this.WizardStatus.DISCARDED}],actions:[{name:"openWizardInspector",isAvailable:function(developerMode){return developerMode},code:function(x){this.WizardInspector.OPEN({},this.__subContext__.createSubContext({wizardController:this}))}}],listeners:[{name:"onWizardletAvailability",framed:true,code:function onWizardletAvailability(wizardletIndex,value){if(!this.autoPositionUpdates)return;this.wizardPosition=this.wizardPosition.clone()}},function onWizardletValidity(){this.allValid=this.wizardlets.filter(w=>!w.isValid).length==0},function onWizardletIndicator(wizardletIndex,value){if(value==this.WizardletIndicator.NETWORK_FAILURE){this.someFailures=true;return}this.someFailures=!!this.wizardlets.filter(w=>w.indicator==this.WizardletIndicator.NETWORK_FAILURE).length},function onSectionAvailability(sectionPosition,value){if(!this.autoPositionUpdates)return;if(value&&sectionPosition.compareTo(this.wizardPosition)<0){this.wizardPosition=sectionPosition;return}if(!value&&sectionPosition.compareTo(this.wizardPosition)==0){this.wizardPosition=this.nextScreen;return}this.wizardPosition=this.wizardPosition.clone()},function onWizardletCompleted(wizardlet){this.analyticsAgent?.pub("event",{name:foam.String.constantize(wizardlet.title||wizardlet.id||(wizardlet.of?.name??"UNKNOWN"))+"_COMPLETE",tags:["wizard"]})}]});
foam.CLASS({package:"foam.u2.wizard",name:"WizardletRenderUtils",methods:[function calculateWizardletDisplayNumber(w,list){var wSkipped=0;var i;for(i=0;i<list.length&&list[i]!=w;i++){if(!list[i].isAvailable||!list[i].isVisible){wSkipped++}}return i+1-wSkipped},function configureIndicator(wizardlet,isCurrent,number){var args={size:24,borderThickness:2};if(wizardlet.indicator==this.WizardletIndicator.COMPLETED){args={...args,borderColor:this.theme.approval3,backgroundColor:this.theme.approval3,borderColorHover:this.theme.approval3,icon:this.theme.glyphs.checkmark.getDataUrl({fill:this.theme.white})}}else if(wizardlet.indicator==this.WizardletIndicator.SAVING||wizardlet.indicator==this.WizardletIndicator.NETWORK_FAILURE){args={...args,indicateProcessing:true,borderColor:"rgba(0,0,0,0)",borderColorHover:"rgba(0,0,0,0)"}}else{args={...args,borderColor:this.theme.grey2,borderColorHover:this.theme.grey2,label:""+number}}if(isCurrent){args={...args,borderColor:this.theme.black,borderColorHover:this.theme.black}}return args}]});
foam.CLASS({package:"foam.u2.wizard",name:"StepWizardletStepsView",extends:"foam.u2.View",mixins:["foam.u2.wizard.WizardletRenderUtils"],css:`
^item {
margin-bottom: 24px;
}
^step-number-and-title {
display: flex;
align-items: center;
}
^step-number-and-title > .circle {
display: inline-block;
margin-right: 24px;
vertical-align: middle;
min-width: 24px;
}
^sub-item {
padding-left: calc(24px + 24px + 4px);
padding-top: 2px;
padding-bottom: 8px;
color: /*%GREY2%*/ #9ba1a6;
}
^sub-item:hover {
cursor: pointer;
color: /*%GREY1%*/ #5e6061 !important;
}
^sub-item:first-child {
padding-top: 16px;
}
^title {
display: inline-block;
margin: 0;
vertical-align: middle;
text-transform: uppercase;
}
^ .foam-u2-LoadingSpinner img {
width: 24px;
height: 24px;
}
^hide {
opacity: 0.3;
}
^search{
padding-bottom: 32px;
}
^search input{
width: 100%;
}
`,imports:["theme"],requires:["foam.core.ExpressionSlot","foam.u2.detail.AbstractSectionedDetailView","foam.u2.tag.CircleIndicator","foam.u2.wizard.WizardPosition","foam.u2.wizard.WizardletIndicator","foam.u2.wizard.WizardletSearchController"],messages:[{name:"PART_LABEL",message:"Part "}],properties:[{class:"FObjectProperty",of:"foam.u2.wizard.WizardletSearchController",name:"searchController"},{class:"Array",name:"stepElements"}],methods:[function render(){var self=this;this.searchController=this.WizardletSearchController.create({wizardlets$:this.data.wizardlets$});var wizardletIsVisibleSlots=foam.core.ArraySlot.create({slots:this.data.wizardlets.map(w=>w.isVisible$)});var slots_=[this.data.wizardlets$,this.data.wizardPosition$,wizardletIsVisibleSlots];var arraySlot=foam.core.ArraySlot.create({slots:slots_});this.addClass(this.myClass()).start().addClass(this.myClass("search")).tag(foam.u2.SearchField,{data$:this.searchController.data$,onKey:true}).end().add(arraySlot.map(a=>{let elem=this.E();let afterCurrent=false;this.stepElements=[];for(let w=0;w<this.data.wizardlets.length;w++){let wizardlet=this.data.wizardlets[w];let isCurrent=wizardlet===this.data.currentWizardlet;if(this.data.countAvailableSections(w)<1||!wizardlet.isAvailable||!wizardlet.isVisible){continue}elem=elem.start().call(function(){self.stepElements.push(this)}).setAttribute("data-wizardlet",wizardlet.id).addClass(self.myClass("item")).addClass(wizardlet.isHidden$.map(v=>v&&self.myClass("hide"))).add(this.ExpressionSlot.create({args:[wizardlet.indicator$],code:()=>{return self.E().addClass(self.myClass("step-number-and-title")).start(this.CircleIndicator,this.configureIndicator(wizardlet,isCurrent,this.calculateWizardletDisplayNumber(wizardlet,self.data.wizardlets))).addClass("circle").end().start("p").addClass(self.myClass("title")).translate(wizardlet.id+".name",wizardlet.title).style({color:isCurrent?this.theme.black:this.theme.grey2}).end()}})).start().end();let wi=this.data.wizardPosition.wizardletIndex;let si=this.data.wizardPosition.sectionIndex;let sections=this.data.wizardlets[w].sections;for(let s=0;s<sections.length;s++){let pos=this.WizardPosition.create({wizardletIndex:w,sectionIndex:s});let section=sections[s];let isCurrentSection=isCurrent&&si===s;let isBeforeCurrentSection=w<wi||isCurrent&&s<si;let allowedToSkip=self.data.canSkipTo(pos);let slot=section.isAvailable$.map(function(isAvailable){return isAvailable?self.renderSectionLabel(self.E().addClass(self.myClass("sub-item")),section,s+1,isCurrentSection).on("click",()=>{if(isCurrentSection)return;if(allowedToSkip){self.data.skipTo(pos)}return}):self.E("span")});elem.add(slot)}elem=elem.end();if(isCurrent)afterCurrent=true}elem.onload.sub(self.setScrollPos);return elem}))},function renderSectionLabel(elem,section,index,isCurrent){let title=section.title;if(!title||!foam.Function.isInstance(title)&&!title.trim())title=this.PART_LABEL+index;title=foam.Function.isInstance(title)?foam.core.ExpressionSlot.create({obj$:section.data$,code:title}):title;return elem.style({color:isCurrent?this.theme.black:this.theme.grey2}).translate(title,title)}],listeners:[{name:"setScrollPos",isFramed:true,code:async function(){var el=await this.parentNode.el();if(!this.data.currentWizardlet){console.warn("setScrollPos() failed; no current wizardlet",{data:this.data});return}var currChild=null;for(let node of this.stepElements){if(node.getAttribute("data-wizardlet")==this.data.currentWizardlet.id){currChild=node;break}}if(!currChild){console.warn("setScrollPos() failed; unable to find active wizardlet element",{"wizardlet id":this.data.currentWizardlet.id,data:this.data});return}var firstChild=await this.childNodes[0].childNodes[0].el();currChild=await currChild.el();var padding=firstChild.offsetTop;var scrollTop=currChild.offsetTop;el.scrollTop=scrollTop-padding}}]});
foam.CLASS({package:"foam.u2.wizard",name:"IncrementalStepWizardView",extends:"foam.u2.View",imports:["notify","stack","theme"],requires:["foam.core.Action","foam.log.LogLevel","foam.u2.detail.SectionView","foam.u2.dialog.Popup","foam.u2.dialog.SimpleActionDialog","foam.u2.stack.Stack","foam.u2.stack.StackView","foam.u2.detail.VerticalDetailView","foam.u2.layout.Grid","foam.u2.layout.GUnit","foam.u2.LoadingSpinner","foam.u2.wizard.StepWizardletStepsView","foam.u2.tag.CircleIndicator"],implements:["foam.mlang.Expressions"],messages:[{name:"ACTION_LABEL",message:"Submit"},{name:"CANCEL_LABEL",message:"Cancel"},{name:"SAVE_IN_PROGRESS",message:"Saving..."},{name:"ERROR_MSG",message:"Information was not successfully submitted, please try again later"},{name:"ERROR_MSG_DRAFT",message:"An error occured while saving your progress"},{name:"SUCCESS_MSG",message:"Information successfully submitted"},{name:"SUCCESS_MSG_DRAFT",message:"Your progress has been saved"},{name:"CONFIRM_MSG",message:"Exit"},{name:"DISMISS_MSG",message:"Are you sure you want to leave this screen?"},{name:"CONTINUE_MSG",message:"Go back"}],css:`
^ {
position: relative;
background-color: /*%GREY5%*/ #f5f7fa;
height: 100%;
width: 100%;
max-height: 100vh;
max-width: 100vw;
}
^status {
background-color: %WHITE%;
padding: 50px;
padding-top: 100px;
overflow-y: auto;
display: flex;
flex-direction: column;
justify-content: space-between;
}
^hide-X-status {
background-color: %WHITE%;
padding: 50px;
overflow-y: auto;
display: none;
flex-direction: column;
justify-content: space-between;
}
^rightside {
display: flex;
flex-direction: column;
justify-content: space-between;
background-color: /*%GREY5%*/ #f5f7fas;
overflow-y: hidden;
}
^rightside ^entry {
flex-grow: 1;
-webkit-mask-image: linear-gradient(rgb(0, 0, 0) 95%, rgba(0,0,0,0.5));
overflow-y: auto;
padding: 0px 50px 100px 50px;
}
^rightside ^hide-X-entry {
flex-grow: 1;
-webkit-mask-image: linear-gradient(rgb(0, 0, 0) 95%, rgba(0,0,0,0.5));
overflow-y: auto;
padding: 50px 50px 100px 50px;
}
^rightside ^top-buttons {
text-align: right;
margin-bottom: 15px;
padding: 25px;
padding-bottom: 0;
}
^rightside ^bottom-buttons {
background-color: %GREY6%;
padding: 0 50px 25px 50px;
text-align: right;
}
^buttons {
display: flex;
justify-content: flex-end;
}
^loading-spinner {
display: inline-flex;
justify-content: center;
align-items: center;
height: 100%;
width: 100%;
}
^loading-spinner .foam-u2-LoadingSpinner {
margin-bottom: 50px;
}
^loading-spinner img {
width: 100px;
height: 100px;
}
^ .foam-u2-stack-StackView {
height: auto;
margin-bottom: 30px;
}
^fix-grid {
height: 100%;
}
^fix-grid.foam-u2-layout-Grid {
grid-gap: 0;
}
/* tablet and desktop */
@media only screen and (min-width: 768px) {
^ {
height: 85vh;
width: 85vw;
max-height: 85vh;
max-width: 85vw;
width: auto;
}
^hide-X-status {
display: flex;
}
}
^fullscreen {
display: flex;
flex-direction: column;
background-color: /*%WHITE%*/ !important;
position: fixed !important;
top: 0;
left: 0;
height: 100vh !important;
width: 100vw;
max-height: 100vh;
max-width: 100vw;
z-index: 950;
margin: 0;
padding: 0;
}
`,properties:[{name:"onClose",class:"Function"},{name:"showDiscardOption",class:"Boolean"},{name:"fullScreen",class:"Boolean",value:false},{name:"hideX",class:"Boolean",value:true},{name:"backDisabled",class:"Boolean",value:false},{class:"Boolean",name:"isLoading_",value:false},{name:"loadingSpinner",factory:function(){return this.LoadingSpinner.create()}}],methods:[function render(){var btn={size:"LARGE"};var primaryBtn={...btn,buttonStyle:"PRIMARY"};var self=this;this.addClass(this.myClass()).enableClass(this.myClass("fullscreen"),this.fullScreen$).start(this.Grid).addClass(this.myClass("fix-grid")).start(this.GUnit,{columns:4}).enableClass(this.myClass("hide-X-status"),this.hideX$).enableClass(this.myClass("status"),this.hideX$,true).add(this.slot(function(data,data$currentWizardlet){return this.StepWizardletStepsView.create({data:data})})).end().start(this.GUnit,{columns:8}).addClass(this.myClass("rightside")).add(this.slot(function(hideX){return hideX?null:this.E().addClass(this.myClass("top-buttons")).start(this.CircleIndicator,{label:"X",borderThickness:2,borderColor:this.theme.grey2,borderColorHover:this.theme.primary1,clickable:true}).on("click",()=>this.showExitPrompt()).end()})).start().addClass(this.hideX?this.myClass("hide-X-entry"):this.myClass("entry")).start().add(this.slot(function(data,data$currentWizardlet,data$currentSection,isLoading_){if(isLoading_){return this.E().start().addClass(self.myClass("loading-spinner")).add(this.loadingSpinner).end()}return data$currentSection.createView()})).end().end().start().addClass(this.myClass("bottom-buttons")).add(this.slot(function(data$isLastScreen,isLoading_){return this.E().tag(this.data.OPEN_WIZARD_INSPECTOR).startContext({data:self}).addClass(self.myClass("buttons")).tag(this.GO_PREV,btn).tag(this.GO_NEXT,data$isLastScreen?{...primaryBtn,label:this.data.wizardlets[this.data.wizardPosition.wizardletIndex].actionLabel?this.data.wizardlets[this.data.wizardPosition.wizardletIndex].actionLabel:this.ACTION_LABEL}:primaryBtn).endContext()})).end().end().end()},function showExitPrompt(){var prompt=null;var actionWrap=action=>{let a=action.clone();a.code=action.code.bind(this,this.__subSubContext__);return a};prompt=this.Popup.create({closeable:false}).tag(this.SimpleActionDialog,{title:this.CONFIRM_MSG,body:this.DISMISS_MSG,actions:[this.Action.create({name:"cancel",label:this.CONTINUE_MSG,code:()=>{prompt.close()}}),actionWrap(this.SAVE_AND_CLOSE),actionWrap(this.DISCARD)]});ctrl.add(prompt)}],actions:[{name:"discard",label:"Dismiss",isAvailable:function(){return this.showDiscardOption},confirmationRequired:function(){return true},code:function(x){this.onClose(x,false)}},{name:"saveAndClose",label:"Save and exit",code:function(x){this.data.saveProgress().then(()=>{this.onClose(x,false)}).catch(e=>{console.error(e);x.ctrl.notify(this.ERROR_MSG_DRAFT,"",this.LogLevel.ERROR,true)})}},{name:"goPrev",label:"Back",isEnabled:function(data$canGoBack){return data$canGoBack},isAvailable:function(backDisabled,isLoading_){return!backDisabled&&!isLoading_},code:function(){this.data.back()}},{name:"goNext",label:"Next",isEnabled:function(data$canGoNext,isLoading_){return data$canGoNext&&!isLoading_},isAvailable:function(isLoading_){return!isLoading_},code:function(x){this.isLoading_=true;this.data.next().then(isFinished=>{if(isFinished){for(let w of this.data.wizardlets){if(w.submit)w.submit()}this.onClose(x,true)}}).catch(e=>{console.error(e);x.ctrl.notify(this.ERROR_MSG,"",this.LogLevel.ERROR,true)}).finally(()=>{this.isLoading_=false})}}]});
foam.CLASS({package:"foam.u2.wizard",name:"SearchableWizardlet",properties:[{name:"value",class:"String"},{name:"wizardlet",class:"FObjectProperty",of:"foam.u2.wizard.wizardlet.Wizardlet"}]});
foam.CLASS({package:"foam.u2.wizard",name:"WizardletSearchController",implements:["foam.mlang.Expressions"],requires:["foam.dao.ArrayDAO","foam.parse.QueryParser","foam.u2.wizard.SearchableWizardlet"],properties:[{class:"String",name:"data"},{class:"FObjectArray",of:"foam.u2.wizard.wizardlet.Wizardlet",name:"wizardlets"},{class:"foam.dao.DAOProperty",name:"searchDAO"},{name:"queryParser",factory:function(){return this.QueryParser.create({of:"foam.u2.wizard.SearchableWizardlet"})}}],methods:[function init(){this.generateSearchDao_();this.wizardlets$.sub(this.generateSearchDao_.bind(this));this.data$.sub(()=>{console.log("UPDATE TO SEARCH QUERY",this.data);if(this.data=="")this.affectVisibility(this.TRUE);else this.affectVisibility(this.OR(this.queryParser.parseString(this.data)||this.FALSE,this.KEYWORD(this.data)))})},function generateSearchDao_(){var array=[];for(let w of this.wizardlets){if(!w.of)continue;let str="";let writeClassProps;let seen=[];writeClassProps=cls=>{if(seen.includes(cls))return;seen.push(cls);for(let p of cls.getAxiomsByClass(foam.core.Property)){var visibilityEnum=p.visibility;if(p.visibility instanceof Function&&w.data){var args=p.visibility.toString().match(/\((?:.+(?=\s*\))|)/)[0].slice(1).split(/\s*,\s*/g).map(argumentStrings=>argumentStrings.trim()).map(cleanedArgumentStrings=>w.data[cleanedArgumentStrings]);visibilityEnum=p.visibility.apply(w.data,args)}if(!p.hidden&&visibilityEnum!==foam.u2.DisplayMode.HIDDEN){str+=`${p.name} ${p.label} `;if(foam.core.FObjectProperty.isInstance(p)){let ofCls=typeof p.of==="string"?foam.lookup(p.of):p.of;writeClassProps(ofCls)}}}};writeClassProps(w.of);if(w.delegates&&w.delegates.length>0){for(delegate of w.delegates){writeClassProps(delegate.of)}}array.push(this.SearchableWizardlet.create({value:str,wizardlet:w}))}this.searchDAO=this.ArrayDAO.create({array:array,of:"foam.u2.wizard.SearchableWizardlet"})},async function affectVisibility(predicate){let sink=await this.searchDAO.where(predicate).select();let visibleWizardlets=sink.array.map(v=>v.wizardlet);for(let w of this.wizardlets){if(!w.of)continue;w.isHidden=!visibleWizardlets.includes(w)}}]});
foam.CLASS({package:"foam.u2.wizard",name:"ScrollingStepWizardView",extends:"foam.u2.wizard.IncrementalStepWizardView",mixins:["foam.u2.wizard.WizardletRenderUtils"],imports:["sequence?"],messages:[{name:"NO_ACTION_LABEL",message:"Done"},{name:"SAVE_LABEL",message:"Save"},{name:"REJECT_LABEL",message:"Reject"},{name:"NETWORK_FAILURE_MESSAGE",message:"There is a problem connecting to the server. Please wait."}],requires:["foam.u2.tag.CircleIndicator","foam.u2.tag.Input","foam.u2.borders.LoadingBorder","foam.u2.crunch.wizardflow.SaveAllAgent","foam.u2.wizard.WizardPosition","foam.u2.wizard.WizardletIndicator","foam.u2.wizard.WizardletSearchController"],css:`
^ {
--foamMargin: 20px;
}
^mainView > * > *:not(:last-child):not(^heading) {
margin-bottom: 40px;
}
^rightside {
--actionBarTbPadding: 13px;
--buttonHeight: 38px;
--actionBarHeight: calc(
2*var(--actionBarTbPadding) + var(--buttonHeight));
--lrPadding: 48px;
--tbPadding: var(--lrPadding);
position: relative;
}
^ ^rightside ^entry, ^ ^rightside ^hide-X-entry {
flex-grow: 1;
overflow-y: auto;
padding: var(--tbPadding) var(--lrPadding);
padding-bottom: calc(var(--tbPadding) - var(--foamMargin));
/* padding-bottom: calc(var(--lrPadding) + var(--actionBarHeight)) */
}
^rightside ^bottomnav {
align-items: center;
background-color: rgba(255,255,255,0.7);
backdrop-filter: blur(5px);
box-shadow: 0px -1px 3px rgba(0, 0, 0, 0.1);
display: flex;
flex-grow: 0;
justify-content: flex-end;
padding: var(--actionBarTbPadding) var(--lrPadding);
}
^heading {
display: flex;
align-items: center;
margin-bottom: 40px;
}
^network-failure-banner {
backdrop-filter: blur(10px);
background-color: /*%DESTRUCTIVE2%*/ #A61414;
border-radius: 8px;
color: /*%WHITE%*/ white;
margin-bottom: 16px;
padding: 8px;
position: sticky;
text-align: center;
top: 0;
z-index: 1000;
}
^hide {
display: none !important;
}
`,properties:[{name:"scrollPosition",class:"Int"},{name:"wizardPositionElements",class:"Map"},{name:"scrollWizardPosition",expression:async function(scrollPosition,wizardPositionElements){var offset=50;var test_visible=el=>{while(el.offsetParent!=this.scrollOffsetElement){el=el.offsetParent;if(el===null)return false}var sectTop=el.offsetTop-offset;var sectBot=sectTop+el.clientHeight;var mainTop=this.mainScrollElement.scrollTop;var mainBot=mainTop+this.mainScrollElement.clientHeight;return sectTop<=mainTop&&sectBot>mainTop||sectBot>=mainBot&&sectTop<mainBot||sectTop>=mainTop&&sectBot<mainBot};var minTopPosition=null;for(let hash in wizardPositionElements){let el=await wizardPositionElements[hash].section.el();let pos=wizardPositionElements[hash].position;if(!el){delete wizardPositionElements[hash];continue}if(test_visible(el)){if(!minTopPosition||pos.compareTo(minTopPosition)<0)minTopPosition=pos}}return minTopPosition}},"mainScrollElement","scrollOffsetElement",{name:"hasAction",expression:function(data$wizardlets){return data$wizardlets.filter(w=>w.submit).length>0}},{name:"willSave",factory:function(){return this.sequence&&this.sequence.contains("SaveAllAgent")}},{name:"willReject",expression:function(data$config$rejectOnInvalidatedSave,data$allValid){return data$config$rejectOnInvalidatedSave&&!data$allValid}},{name:"primaryLabel",expression:function(hasAction,willReject,willSave){if(willReject)return this.REJECT_LABEL;if(hasAction)return this.ACTION_LABEL;if(willSave)return this.SAVE_LABEL;return this.NO_ACTION_LABEL}},{class:"Boolean",name:"displayWizardletSteps",value:true,}],methods:[function render(){var self=this;globalThis.testing_=self;this.onDetach(this.scrollWizardPosition$.sub(()=>{if(!this.scrollWizardPosition)return;this.data.wizardPosition=this.scrollWizardPosition}));this.addClass(this.myClass()).enableClass(this.myClass("fullscreen"),this.fullScreen$).start(this.Grid).addClass(this.myClass("fix-grid")).start(this.GUnit,{columns:4}).show(this.displayWizardletSteps).enableClass(this.myClass("hide-X-status"),this.hideX$).enableClass(this.myClass("status"),this.hideX$,true).add(this.slot(function(data,data$currentWizardlet){return this.StepWizardletStepsView.create({data:data})})).end().start(this.GUnit,{columns:this.displayWizardletSteps?8:12}).addClass(this.myClass("rightside")).call(function(){self.onDetach(async function(){self.scrollOffsetElement=await self.el()})}).start().call(function(){self.onDetach(async function(){self.mainScrollElement=await self.el();self.scrollWizardPosition$.get()})}).on("scroll",function(e){self.scrollPosition=e.srcElement.scrollTop}).addClass(this.myClass("mainView")).addClass(this.hideX?this.myClass("hide-X-entry"):this.myClass("entry")).add(this.slot(function(data$someFailures){return data$someFailures?this.E().addClasses(["p",this.myClass("network-failure-banner")]).add(this.NETWORK_FAILURE_MESSAGE):this.E()})).add(this.slot(function(data$wizardlets){return self.renderWizardlets(this.E(),data$wizardlets)})).end().start().addClass(this.myClass("bottomnav")).start().addClass(this.myClass("actions")).tag(this.data.OPEN_WIZARD_INSPECTOR).startContext({data:self}).tag(this.SUBMIT,{label$:this.primaryLabel$,buttonStyle:"PRIMARY"}).endContext().end().end().end().end()},function renderWizardlets(e,wizardlets){var self=this;return e.forEach(wizardlets,function(wizardlet,wi){this.add(wizardlet.slot(function(isAvailable,isVisible){if(!isVisible)return self.E();var e2=self.renderWizardletHeading(self.E(),wizardlet);return e2.start(self.LoadingBorder,{loadingLevel$:wizardlet.loadingLevel$}).call(function(){self.renderWizardletSections(this,wizardlet,wi)}).end()}))})},function renderWizardletHeading(e,wizardlet){var isCurrent=wizardlet==this.data.currentWizardlet;var self=this;return e.add(wizardlet.slot(function(isVisible){if(!isVisible)return self.E();return self.E().addClass(self.myClass("heading")).addClass(wizardlet.isHidden$.map(v=>v&&self.myClass("hide"))).add(wizardlet.slot(function(indicator){return self.E().style({display:"inline-block",float:"left","margin-right":"15px"}).start(self.CircleIndicator,self.configureIndicator(wizardlet,isCurrent,self.calculateWizardletDisplayNumber(wizardlet,self.data.wizardlets))).end()})).start().addClass("h300").translate(wizardlet.id+".name",wizardlet.title).end()}))},function renderWizardletSections(e,wizardlet,wi){var self=this;return e.start(self.Grid).addClass(wizardlet.isHidden$.map(v=>v&&self.myClass("hide"))).forEach(wizardlet.sections,function(section,si){var position=self.WizardPosition.create({wizardletIndex:wi,sectionIndex:si});this.add(section.createView().call(function(){this.onDetach(this.state$.sub(()=>{if(this.state.cls_==foam.u2.LoadedElementState){if(!self.wizardPositionElements[position.hash()])self.wizardPositionElements$set(position.hash(),{section:this,position:position})}}))}))}).end()}],actions:[{name:"submit",label:"Done",confirmationRequired:function(willReject){return willReject},isEnabled:function(data$config,data$allValid,data$someFailures){if(data$someFailures)return false;return!data$config.requireAll||data$allValid},isAvailable:function(mode){return mode==foam.u2.DisplayMode.RW},code:function(x){for(let w of this.data.wizardlets){if(w.submit)w.submit()}this.data.submitted=true;this.onClose(x,true)}}]});
foam.CLASS({package:"foam.u2.wizard",name:"ScrollWizardletView",extends:"foam.u2.wizard.WizardletView",requires:["foam.log.LogLevel"],imports:["notify","stack"],implements:["foam.mlang.Expressions"],messages:[{name:"ACTION_LABEL",message:"Submit"},{name:"SAVE_IN_PROGRESS",message:"Saving..."},{name:"ERROR_MSG",message:"Information was not successfully submitted, please try again later"},{name:"ERROR_MSG_DRAFT",message:"An error occured while saving your progress"},{name:"SUCCESS_MSG",message:"Information successfully submitted"},{name:"SUCCESS_MSG_DRAFT",message:"Your progress has been saved"}],css:`
^ {
margin: 30px;
}
`,requires:["foam.u2.detail.VerticalDetailView"],properties:[{class:"Boolean",name:"isErrorFree",expression:function(wizardlets){var check=true;wizardlets.forEach(wizardlet=>{if(!wizardlet.validate()){check=false}});return check}}],methods:[function render(){var self=this;this.addClass();this.start("h1").add(this.title).end().start().add(this.slot(wizardlets=>{return this.E().forEach(wizardlets.filter(section=>section.of),wizardlet=>{var subThis=this.startContext({});subThis.__subSubContext__.register(this.VerticalDetailView,"foam.u2.detail.SectionedDetailView");subThis.tag(this.VerticalDetailView,{data:wizardlet.data})})})).end().startContext({data:this}).tag(this.EXIT,{size:"LARGE"}).callIfElse(this.isErrorFree,function(){self.tag(this.SAVE,{size:"LARGE",label:this.ACTION_LABEL})},function(){self.tag(this.SAVE,{size:"LARGE"})}).endContext()}],actions:[{name:"exit",confirmationRequired:function(){return true},code:function(x){x.stack.back()}},{name:"save",code:function(x){var p=Promise.resolve();this.wizardlets.reduce((p,wizardlet)=>p.then(()=>wizardlet.save()),p).then(()=>{x.ctrl.notify(this.isErrorFree?this.SUCCESS_MSG:this.SUCCESS_MSG_DRAFT,"",this.LogLevel.INFO,true);x.stack.back()}).catch(e=>{x.ctrl.notify((this.isErrorFree?this.ERROR_MSG:this.ERROR_MSG_DRAFT)+": "+e,"",this.LogLevel.INFO,true)})}}]});
foam.CLASS({package:"foam.u2.wizard",name:"FObjectHolder",properties:[{class:"FObjectProperty",name:"fobject"}]});
foam.CLASS({package:"foam.u2.wizard",name:"PrereqPropertySpec",properties:[{class:"String",name:"capabilityId"},{class:"foam.u2.wizard.PathProperty",name:"path"}]});foam.INTERFACE({package:"foam.u2.wizard.data",name:"Loader",proxy:true,methods:[{name:"load",async:true}]});
foam.CLASS({package:"foam.u2.wizard.data",name:"NullLoader",implements:["foam.u2.wizard.data.Loader"],methods:[function load({old}){return old||null}]});foam.INTERFACE({package:"foam.u2.wizard.data",name:"Saver",proxy:true,nullStrategy:true,methods:[{name:"save",async:true}]});
foam.CLASS({package:"foam.u2.wizard.data",name:"NullSaver",implements:["foam.u2.wizard.data.Saver"],methods:[function save(){}]});
foam.CLASS({package:"foam.u2.wizard.data",name:"DebugSaver",extends:"foam.u2.wizard.data.ProxySaver",properties:["breakpoint","name"],methods:[function save(...a){console.log(`DebugSaver(${this.name}).save`,...a);if(this.breakpoint)debugger;return this.delegate.save(...a)}]});foam.INTERFACE({package:"foam.u2.wizard.data",name:"Canceler",nullStrategy:true,methods:[{name:"cancel",async:true}]});
foam.CLASS({package:"foam.u2.wizard.data",name:"NullCanceler",implements:["foam.u2.wizard.data.Canceler"],methods:[function cancel(){}]});
foam.CLASS({package:"foam.u2.wizard.data",name:"DAOSaver",extends:"foam.u2.wizard.data.ProxySaver",properties:[{name:"of",class:"Class"},{name:"daoKey",class:"String",expression:function(of,path){if(path){const parts=path.split(".");let of_=of;let obj=null;for(let part of parts){obj=of_.getAxiomByName(part);of=obj.cls_}return foam.String.daoize(obj.of.name)}return foam.String.daoize(of.name)}},{name:"dao",class:"foam.dao.DAOProperty",expression:function(daoKey){return this.__context__[daoKey]}},{class:"foam.u2.wizard.PathProperty",name:"path",}],methods:[async function save(data){const dataToPut=this.path?this.path.f(data):data;return await this.dao.put(dataToPut)}]});
foam.CLASS({package:"foam.u2.wizard.data",name:"WrapSaver",extends:"foam.u2.wizard.data.ProxySaver",properties:[{class:"FObjectProperty",name:"wrapper"},{class:"foam.u2.wizard.PathProperty",name:"saveIntoPath"}],methods:[async function save(data){const outputData=this.wrapper.clone();this.saveIntoPath$set(outputData,data);return await this.delegate.save(outputData)}]});
foam.CLASS({package:"foam.u2.wizard.data",name:"PrerequisiteLoader",extends:"foam.u2.wizard.data.ProxyLoader",issues:['Property "of" needs to specified, which is inconvenient.'],imports:["capabilityToPrerequisite","wizardletId","wizardletOf","wizardlets"],properties:[{class:"String",name:"prerequisiteCapabilityId"},{class:"foam.u2.wizard.PathProperty",name:"loadFromPath"},{class:"foam.u2.wizard.PathProperty",name:"loadIntoPath"},{class:"Boolean",name:"isWrappedInFObjectHolder"},{class:"Class",name:"of",expression:function(wizardletOf){return wizardletOf}},{class:"Boolean",name:"cloneValue",value:true}],methods:[async function load({old}){let initialData=this.delegate?await this.delegate.load({old:old}):old;const prereqWizardlet=this.wizardlets.filter(wizardlet=>wizardlet.id===this.prerequisiteCapabilityId)[0];if(!prereqWizardlet.isAvailable){if(this.loadIntoPath){if(!initialData){initialData=this.of.create({},this)}this.loadIntoPath$set(initialData,null);return initialData}return null}if(!prereqWizardlet.of){console.error(`prerequisiteCapabilityId: ${this.prerequisiteCapabilityId} has no data`);return}let prereqWizardletData=prereqWizardlet.data;if(!prereqWizardletData){prereqWizardletData=this.of.create({},this)}let clonedPrereqWizardletData;if(this.loadFromPath){var loadedFromData=this.loadFromPath.f(prereqWizardletData);if(!loadedFromData){console.error(`prerequisiteCapabilityId: ${this.prerequisiteCapabilityId}'s data returns null for the path ${this.loadFromPath.toString()}`);if(this.of){return this.of.create({},this)}}clonedPrereqWizardletData=loadedFromData.clone&&this.cloneValue?loadedFromData.clone():loadedFromData}else{clonedPrereqWizardletData=this.cloneValue?prereqWizardletData.clone():prereqWizardletData}if(this.isWrappedInFObjectHolder){return this.FObjectHolder.create({fobject:clonedPrereqWizardletData})}if(this.loadIntoPath){if(!initialData){initialData=this.of.create({},this)}this.loadIntoPath$set(initialData,clonedPrereqWizardletData);return initialData}return clonedPrereqWizardletData}]});
foam.CLASS({package:"foam.u2.wizard.data",name:"EasyLoader",implements:["foam.u2.wizard.data.Loader"],properties:[{class:"FObjectArray",of:"foam.core.FObject",name:"loaders",postSet:function(_,n){if(n.length<2)return;for(let i=1;i<n.length;i++){n[i].delegate=n[i-1]}}}],methods:[async function load({old}){return await this.loaders[this.loaders.length-1].load(...arguments)}]});
foam.CLASS({package:"foam.u2.wizard.data",name:"CreateLoader",implements:["foam.u2.wizard.data.Loader"],imports:["wizardletOf?"],properties:[{class:"foam.util.FObjectSpec",name:"spec",factory:function(){return{class:this.wizardletOf.id}}},{class:"Class",name:"of",expression:function(spec){return this.__subContext__.lookup(spec.class)}},{class:"Object",name:"args",expression:function(spec){const cloned={...spec};delete cloned.class;return cloned}}],methods:[async function load(){return this.of.create(this.args,this)}]});
foam.CLASS({package:"foam.u2.wizard.data",name:"FacadeWizardletSaver",extends:"foam.u2.wizard.data.ProxySaver",imports:["wizardlets"],properties:[{class:"FObjectArray",name:"facadeWizardletSpecs",of:"foam.u2.wizard.wizardlet.FacadeWizardletSpec"}],methods:[async function save(data){this.facadeWizardletSpecs.forEach(facadeSpec=>{const wizardletToOverride=this.grabWizardletFromFacadeSpec(facadeSpec);let dataToSave=facadeSpec.loadFromFacadePath?facadeSpec.loadFromFacadePath.f(data):data;let dataToOverride=wizardletToOverride.data;if(facadeSpec.loadIntoRealPath){facadeSpec.loadIntoRealPath$set(dataToOverride,dataToSave)}else{wizardletToOverride.data=null;wizardletToOverride.data=dataToSave}wizardletToOverride.isVisible=facadeSpec.isOverridedWizardletVisible})},function grabWizardletFromFacadeSpec(facadeSpec){let foundWizardlet;for(let wizardlet of this.wizardlets){if(wizardlet.id===facadeSpec.wizardletId){foundWizardlet=wizardlet;break}}return foundWizardlet}]});foam.INTERFACE({package:"foam.u2.wizard.wao",name:"WAO",label:"Wizardlet Access Object",todo:["add AbstractWAO to handle wizardlet.loading checks"],flags:["web"],methods:[{name:"save",async:true},{name:"cancel",async:true},{name:"load",async:true}]});
foam.CLASS({package:"foam.u2.wizard.wao",name:"SplitWAO",extends:"foam.u2.wizard.wao.ProxyWAO",requires:["foam.u2.wizard.data.NullCanceler","foam.u2.wizard.data.NullLoader","foam.u2.wizard.data.NullSaver","foam.u2.wizard.data.ProxyCanceler","foam.u2.wizard.data.ProxyLoader","foam.u2.wizard.data.ProxySaver"],properties:[{class:"foam.util.FObjectSpec",of:"foam.u2.wizard.data.Canceler",name:"canceler",factory:()=>({class:"foam.u2.wizard.data.NullCanceler"})},{class:"foam.util.FObjectSpec",of:"foam.u2.wizard.data.Loader",name:"loader",factory:()=>({class:"foam.u2.wizard.data.NullLoader"})},{class:"foam.util.FObjectSpec",of:"foam.u2.wizard.data.Saver",name:"saver",factory:()=>({class:"foam.u2.wizard.data.NullSaver"})}],methods:[async function cancel(wizardlet){const canceler=foam.json.parse(this.canceler,undefined,wizardlet.__subContext__);this.ensure_terminal(canceler,this.ProxyCanceler,this.NullCanceler);await canceler.cancel()},async function load(wizardlet){const loader=foam.json.parse(this.loader,undefined,wizardlet.__subContext__);this.ensure_terminal(loader,this.ProxyLoader,this.NullLoader);if(wizardlet.loading)return;wizardlet.loading=true;wizardlet.data=await loader.load({old:wizardlet.data});wizardlet.loading=false},async function save(wizardlet){const saver=foam.json.parse(this.saver,undefined,wizardlet.__subContext__);this.ensure_terminal(saver,this.ProxySaver,this.NullSaver);if(this.NullSaver.isInstance(saver)&&this.delegate){await this.delegate.save(wizardlet)}else{if(wizardlet.loading)return;if(!wizardlet.isAvailable)return;wizardlet.loading=true;await saver.save(wizardlet.data)}wizardlet.loading=false},function ensure_terminal(obj,proxyCls,nullCls){while(proxyCls.isInstance(obj)){if(!obj.delegate){obj.delegate=nullCls.create()}obj=obj.delegate}}]});
foam.CLASS({package:"foam.u2.wizard.wao",name:"DAOWAO",implements:["foam.mlang.Expressions","foam.u2.wizard.wao.WAO"],requires:["foam.core.Slot","foam.mlang.expr.Dot","foam.core.Property"],flags:["web"],properties:[{name:"of",class:"Class"},{name:"daoKey",class:"String",expression:function(of,path){if(path){const parts=path.split(".");let of_=of;let obj=null;for(let part of parts){obj=of_.getAxiomByName(part);of=obj.cls_}return foam.String.daoize(obj.of.name)}return foam.String.daoize(of.name)}},{name:"dao",class:"foam.dao.DAOProperty",expression:function(daoKey){return this.__context__[daoKey]}},{class:"foam.u2.wizard.PathProperty",name:"path",},{class:"Boolean",name:"disableFind"}],methods:[async function save(wizardlet){if(wizardlet.loading)return;if(!wizardlet.isAvailable)return;wizardlet.loading=true;let dataToPut=this.path?this.path.f(wizardlet.data):wizardlet.data;return await this.dao.put(dataToPut).then(savedData=>{this.setValue_(wizardlet,savedData);return savedData}).catch(e=>{console.error(e);wizardlet.reportNetworkFailure(e)}).finally(()=>{wizardlet.loading=false})},async function load(wizardlet){if(wizardlet.loading)return;if(!this.disableFind){let dataToFind=this.path?this.path.f(wizardlet.data):wizardlet.data;if(!dataToFind||dataToFind&&!dataToFind.id)return;let loadedData=await this.dao.find(dataToFind).catch(e=>{console.error(e);wizardlet.reportNetworkFailure(e)});this.setValue_(wizardlet,loadedData)}wizardlet.loading=false},async function cancel(){return},function setValue_(wizardlet,data){let path=this.path;let lastObject=null;let lastKey=null;if(!path){lastObject=wizardlet;lastKey="data"}else if(this.Property.isInstance(path)){lastObject=wizardlet.data;lastKey=path}else if(this.Dot.isInstance(path)){lastObject=path.arg1.f(obj);lastKey=path.arg2.name}else{throw new Error("Unexpected case in DAOWAO.setValue")}if(!lastObject)return false;if(foam.core.Slot.isInstance(lastObject[lastKey])){lastObject[lastKey]=data$}else{lastObject[lastKey]=data}return true}]});
foam.CLASS({package:"foam.u2.wizard.wao",name:"ProxyWAO",implements:["foam.u2.wizard.wao.WAO"],flags:["web"],properties:[{class:"Proxy",of:"foam.u2.wizard.wao.WAO",name:"delegate"}]});
foam.CLASS({package:"foam.u2.wizard.wao",name:"NullWAO",implements:["foam.u2.wizard.wao.WAO"],flags:["web"],methods:[async function save(){},async function load(){},async function cancel(){}]});
foam.CLASS({package:"foam.u2.wizard.wao",name:"XORMinMaxWAO",implements:["foam.u2.wizard.wao.WAO"],flags:["web"],extends:"foam.u2.wizard.wao.ProxyWAO",imports:["wizardlets","capabilityToPrerequisite"],requires:["foam.u2.wizard.FObjectHolder"],properties:[{class:"String",name:"minMaxCapabilityId"},{class:"Boolean",name:"isWrappedInFObjectHolder"},{class:"Class",name:"of"},{class:"foam.u2.wizard.PathProperty",name:"loadFromPath"},{class:"foam.u2.wizard.PathProperty",name:"loadIntoPath"}],methods:[async function load(wizardlet){wizardlet.isLoaded=false;const isDescendantCheck=this.capabilityToPrerequisite[`${wizardlet.id}:${this.minMaxCapabilityId}`];if(!isDescendantCheck){console.error(`MinMaxCapabilityId: ${this.minMaxCapabilityId} is not a prerequisite to ${wizardlet.id}`);return}const prereqMinMaxWizardlet=this.wizardlets.filter(wizardlet=>wizardlet.id===this.minMaxCapabilityId)[0];let selectedCapabilityId;if(!prereqMinMaxWizardlet.isVisible){var impliedChoiceArray=prereqMinMaxWizardlet.choiceWizardlets.filter(cw=>cw.isAvailable);if(impliedChoiceArray.length!=1){console.error(`Cannot apply XOR to MinMaxCapabilityId: ${this.minMaxCapabilityId}`);return}selectedCapabilityId=impliedChoiceArray[0].id}else{const minMaxSelectedData=prereqMinMaxWizardlet.data.selectedData;if(minMaxSelectedData.length!=1){console.error(`Cannot apply XOR to MinMaxCapabilityId: ${this.minMaxCapabilityId}`);if(this.of){wizardlet.data=this.of.create({},this)}return}selectedCapabilityId=minMaxSelectedData[0]}const selectedCapabilityWizardlet=prereqMinMaxWizardlet.prerequisiteWizardlets.find(w=>w.capability&&w.capability.id==selectedCapabilityId);if(!selectedCapabilityWizardlet){console.error(`Cannot find prerequisite for Selected Capability Id: ${selectedCapabilityId}`);return}let selectedCapabilityWizardletData=selectedCapabilityWizardlet.data;if(!selectedCapabilityWizardletData){selectedCapabilityWizardletData=this.of.create({},this)}let clonedSelectedWizardletData;if(this.loadFromPath){var loadedFromData=this.loadFromPath.f(selectedCapabilityWizardletData);if(!loadedFromData){console.error(`xorCapabilityId: ${this.minMaxCapabilityId}'s data returns null for the path ${this.loadFromPath.toSummary()}`);if(this.of){wizardlet.data=this.of.create({},this);return}}clonedSelectedWizardletData=loadedFromData.clone()}else{clonedSelectedWizardletData=selectedCapabilityWizardletData.clone()}if(this.isWrappedInFObjectHolder){const fObjectHolder=this.FObjectHolder.create({fobject:clonedSelectedWizardletData});wizardlet.data=fObjectHolder;wizardlet.isLoaded=true;return fObjectHolder}if(this.loadIntoPath){if(!wizardlet.data){wizardlet.data=this.of.create({},this)}this.loadIntoPath$set(wizardlet.data,clonedSelectedWizardletData);wizardlet.isLoaded=true;return}wizardlet.data=clonedSelectedWizardletData;wizardlet.isLoaded=true;return clonedSelectedWizardletData}]});
foam.CLASS({package:"foam.u2.wizard.wao",name:"PrerequisiteWAO",extends:"foam.u2.wizard.wao.SplitWAO",flags:["web"],properties:[{class:"String",name:"prerequisiteCapabilityId"},{class:"foam.u2.wizard.PathProperty",name:"loadFromPath"},{class:"foam.u2.wizard.PathProperty",name:"loadIntoPath"},{class:"Boolean",name:"isWrappedInFObjectHolder"},{class:"Class",name:"of"},{class:"Boolean",name:"cloneValue",value:true},{name:"loader",factory:function(){const spec={class:"foam.u2.wizard.data.PrerequisiteLoader",delegate:{class:"foam.u2.wizard.data.NullLoader"}};foam.u2.wizard.data.PrerequisiteLoader.getOwnAxiomsByClass(foam.core.Property).forEach(a=>{const v=a.toJSON(this[a.name]);if(v!=null)spec[a.name]=v});return spec}}]});
foam.CLASS({package:"foam.u2.wizard.wao",name:"CompositeWAO",extends:"foam.u2.wizard.wao.ProxyWAO",flags:["web"],properties:[{class:"FObjectArray",of:"foam.u2.wizard.wao.WAO",name:"delegates"}],methods:[async function load(...args){for(const delegate of this.delegates)await delegate.load(...args)},async function save(...args){for(const delegate of this.delegates)await delegate.save(...args)},async function cancel(...args){for(const delegate of this.delegates)await delegate.cancel(...args)},function clone(opt_X){const o=this.SUPER(opt_X);for(let i=0;i<o.delegates.length;i++){o.delegates[i]=o.delegates[i].clone(opt_X)}return o}]});
foam.CLASS({package:"foam.u2.wizard.wao",name:"ArrayFromPrerequisiteWAO",implements:["foam.u2.wizard.wao.WAO"],flags:["web"],extends:"foam.u2.wizard.wao.ProxyWAO",imports:["wizardlets","capabilityToPrerequisite"],requires:["foam.nanos.crunch.CapabilityJunctionPayload"],properties:[{class:"FObjectArray",of:"foam.u2.wizard.PrereqPropertySpec",name:"loadFromSpecs",factory:function(){return[]}},{class:"foam.u2.wizard.PathProperty",name:"loadIntoPath"},{class:"Boolean",name:"isDataConvertedToPayload"}],methods:[async function load(wizardlet){wizardlet.isLoaded=false;var prereqDataArray=this.loadFromSpecs.map(spec=>this.prereqPropertySpecHandler(wizardlet,spec));if(this.loadIntoPath){this.loadIntoPath$set(wizardlet.data,prereqDataArray);wizardlet.isLoaded=true;return}wizardlet.data=prereqDataArray;wizardlet.isLoaded=true},function prereqPropertySpecHandler(wizardlet,spec){if(!this.isDescendant(wizardlet.id,spec.capabilityId))return null;var prereqWizardlet=this.grabWizardletFromPrereqSpec(spec);var prereqData=this.grabDataFromWizardletWithPrereqSpec(prereqWizardlet,spec);return this.isDataConvertedToPayload?this.makePayload(prereqWizardlet?prereqWizardlet.id:spec.id,prereqData):prereqData},function grabWizardletFromPrereqSpec(spec){let prereqWizardlet=this.wizardlets.filter(wizardlet=>wizardlet.id===spec.capabilityId)[0];if(foam.nanos.crunch.ui.MinMaxCapabilityWizardlet.isInstance(prereqWizardlet)){prereqWizardlet=this.grabSelectedWizardletFromMinMax(prereqWizardlet)}return prereqWizardlet},function grabDataFromWizardletWithPrereqSpec(wizardlet,spec){if(!wizardlet)return null;if(!wizardlet.of){console.error(`prerequisiteCapabilityId: ${this.prerequisiteCapabilityId} has no data`);return null}let prerequisiteData=wizardlet.data;if(spec.path)prerequisiteData=spec.path.f(prerequisiteData);if(!prerequisiteData){return null}return prerequisiteData.clone()},function isDescendant(capabilityId,descendantId){const isDescendantCheck=this.capabilityToPrerequisite[`${capabilityId}:${descendantId}`];if(!isDescendantCheck){console.error(`prerequisiteCapabilityId: ${descendantId} is not a prerequisite to ${capabilityId}`)}return isDescendantCheck},function grabSelectedWizardletFromMinMax(minMaxWizardlet){const minMaxSelectedData=minMaxWizardlet.data.selectedData;if(minMaxSelectedData.length!=1){console.error(`Cannot apply XOR to MinMaxCapabilityId: ${minMaxWizardlet.id}`);return null}const selectedCapabilityId=minMaxSelectedData[0];var selectedWizardlet=this.wizardlets.filter(wizardlet=>wizardlet.id===selectedCapabilityId)[0];if(!selectedWizardlet){console.error(`Cannot find prerequisite for Selected Capability Id: ${selectedCapabilityId}`);return null}return selectedWizardlet},function makePayload(capabilityId,data){return this.CapabilityJunctionPayload.create({capability:capabilityId,data:data})}]});foam.INTERFACE({package:"foam.u2.wizard.wizardlet",name:"Wizardlet",properties:[{name:"of",class:"Class",},{name:"data",},{name:"title",class:"String",},{name:"isAvailable",class:"Boolean",value:true,},{name:"isVisible",class:"Boolean",value:true,}],methods:[{flags:["web"],name:"save",async:true,args:[{name:"options",type:"Object"}],},{flags:["web"],name:"cancel",async:true,},{flags:["web"],name:"createView",args:[{name:"data"}]}]});
foam.CLASS({package:"foam.u2.wizard.wizardlet",name:"BaseWizardlet",todo:["rename wizardlet.loading to wizardlet.busy","add support for notification banner"],topics:["saveEvent"],implements:["foam.u2.wizard.wizardlet.Wizardlet"],imports:["wizardCloseSub?"],exports:["id as wizardletId","of as wizardletOf"],requires:["foam.core.SimpleSlot","foam.u2.borders.LoadingLevel","foam.u2.detail.AbstractSectionedDetailView","foam.u2.wizard.WizardletAware","foam.u2.wizard.WizardletIndicator","foam.u2.wizard.wizardlet.WizardletSection","foam.u2.wizard.wao.WAO","foam.u2.wizard.wao.ProxyWAO","foam.u2.wizard.internal.FObjectRecursionSlot","foam.u2.wizard.internal.WizardletAutoSaveSlot"],constants:[{name:"SAVE_DELAY",value:1e3,}],properties:[{class:"Boolean",name:"reloadOnAutoSave"},{name:"id",class:"String",factory:function(){return foam.uuid.randomGUID()}},{name:"of",class:"Class"},{name:"data",postSet:function(_,n){if(this.of&&this.WizardletAware.isInstance(n)){n.installInWizardlet(this)}}},{name:"title",class:"String"},{name:"subTitle",class:"String",},{name:"isValid",class:"Boolean",expression:function(of,data,data$errors_){if(!this.of)return true;if(!data||data$errors_){return false}return true}},{name:"isAvailable",class:"Boolean",value:true,},{name:"isVisible",class:"Boolean",expression:function(of,isAvailable,atLeastOneSectionVisible_){return isAvailable&&of&&atLeastOneSectionVisible_}},{name:"isHidden",class:"Boolean",value:false},{class:"Boolean",name:"irreversible"},{name:"isCurrent",class:"Boolean",},{name:"atLeastOneSectionVisible_",class:"Boolean",value:true},{name:"reloadAfterSave",class:"Boolean",value:true},{name:"loading",class:"Boolean",postSet:function(_,n){if(!n)this.LoadingLevel=this.LoadingLevel.IDLE}},{name:"combinedSection",class:"Boolean",description:`
Setting this to true makes this wizardlet render only one section with
a SectionedDetailView for the entire model specified by 'of'.
This is a convenient shorthand for overriding 'sections'.
`},{name:"defaultSections",class:"StringArray",factory:function(){return this.AbstractSectionedDetailView.create({of:this.of},this).sections.map(s=>s.name)}},{name:"sections",flags:["web"],transient:true,class:"FObjectArray",of:"foam.u2.wizard.wizardlet.WizardletSection",preSet:function(_,val){for(let wizardletSection of val){wizardletSection.wizardlet=this}return val},factory:function(){if(this.combinedSection){return[this.WizardletSection.create({title:this.title,isAvailable:true,customView:{class:"foam.u2.detail.FlexSectionedDetailView"}})]}const sections=this.createWizardletSectionsFromModel_();this.commitToSections_(sections);return sections}},{class:"FObjectArray",of:"foam.u2.wizard.wizardlet.BaseWizardlet",name:"prerequisiteWizardlets"},{name:"wao",class:"FObjectProperty",of:"foam.u2.wizard.wao.WAO",flags:["web"],factory:function(){this.ProxyWAO.create()}},{name:"indicator",class:"Enum",of:"foam.u2.wizard.WizardletIndicator",expression:function(isValid){return isValid?this.WizardletIndicator.COMPLETED:this.WizardletIndicator.PLEASE_FILL}},{name:"loadingLevel",class:"Enum",of:"foam.u2.borders.LoadingLevel",},{name:"__subSubContext__",factory:function(){return this.__subContext__}},{name:"wizardController",},{class:"Boolean",name:"showTitle",value:true}],methods:[function validate(){return this.isValid},function createView(data){return null},async function save(options){this.indicator=this.WizardletIndicator.SAVING;var ret=await this.wao.save(this,options);this.clearProperty("indicator");this.saveEvent.pub(ret);return ret},async function cancel(){this.indicator=this.WizardletIndicator.SAVING;var ret=await this.wao.cancel(this);this.clearProperty("indicator");return ret},async function load(){await this.wao.load(this);return this},function reportNetworkFailure(){this.indicator=this.WizardletIndicator.NETWORK_FAILURE},{name:"getDataUpdateSub",code:function(){var filter=foam.u2.wizard.Slot.filter;var s=this.SimpleSlot.create();var slotSlot=this.data$.map(data=>{var updateSlot=this.WizardletAware.isInstance(data)&&data.customUpdateSlot?data.getUpdateSlot():this.FObjectRecursionSlot.create({obj:data});return this.WizardletAutoSaveSlot.create({saveEvent:this.loading$,other:filter(updateSlot,()=>!this.loading),delay:this.SAVE_DELAY})});slotSlot.valueSub(()=>{s.set(slotSlot.get().get())});if(this.wizardCloseSub){this.wizardCloseSub.onDetach(s);this.wizardCloseSub.onDetach(slotSlot)}else{console.error("wizardlet update listener will not detach! "+"This wizardlet my be used from an invalid context")}return s}},function pushContext(m){this.__subSubContext__=this.__subSubContext__.createSubContext(m);if(this.data)this.data=this.data.clone(this.__subSubContext__)},function createWizardletSectionsFromModel_(){if(!this.data){if(!this.of)return[];this.warn("initializing wizardlet data to initialize sections");this.data=this.of.create({},this)}var sections=this.AbstractSectionedDetailView.create({of:this.of},this).sections.filter(section=>this.defaultSections.includes(""+section.name)).map(section=>{return this.WizardletSection.create({section:section,wizardlet:this,isAvailable$:section.createIsAvailableFor(this.data$)})});return sections},function commitToSections_(sections){for(let section of sections){this.onDetach(section.isAvailable$.sub(this.updateVisibilityFromSectionCount))}this.updateVisibilityFromSectionCount()},function warn(...args){console.warn(`[wizardlet:${this.id}]`,...args,{wizardlet:this})}],listeners:[{name:"updateVisibilityFromSectionCount",isFramed:true,code:function(){if(!this.sections)return;this.atLeastOneSectionVisible_=this.sections.filter(v=>v.isAvailable).length>0}}]});
foam.CLASS({package:"foam.u2.wizard.wizardlet",name:"ValidationFeedbackWizardlet",extends:"foam.nanos.crunch.ui.CapabilityWizardlet",requires:["foam.u2.wizard.axiom.WizardAction"],properties:[{name:"dynamicActions",factory:function(){return[this.WizardAction.create({name:"goNext",code:async function(slot){const wizardController=slot.data$.get();await wizardController.currentWizardlet.save();if(!wizardController.currentWizardlet.isValid)return;wizardController.goNext()}})]}}]});
foam.CLASS({package:"foam.u2.wizard.wizardlet",name:"WizardletSection",flags:["web"],imports:["showWizardletSectionTitles?"],requires:["foam.u2.detail.SectionView","foam.u2.detail.VerticalDetailView","foam.u2.ViewSpec"],properties:[{name:"section",class:"FObjectProperty",of:"foam.layout.Section",},{name:"title",class:"String",expression:function(section){return section&&section.title}},{name:"wizardlet",class:"FObjectProperty",of:"foam.u2.wizard.wizardlet.Wizardlet",cloneProperty:function(v,m){m[this.name]=v}},{name:"data",expression:function(wizardlet$data){return wizardlet$data}},{name:"isAvailable",class:"Boolean",expression:function(customView){return customView??false}},{name:"isValid",class:"Boolean",expression:function(wizardlet$of,data,data$errors_){if(!wizardlet$of)return true;if(!data)return false;if(!this.section){return!data.errors_||data.errors_.length<1}let sectionErrors=[];if(data$errors_){sectionErrors=data$errors_.filter(error=>this.section.properties.includes(error[0]))}return!sectionErrors.length>0}},{name:"customView",class:"foam.u2.ViewSpec",},{name:"navTitle",class:"String",expression:function(section){return section&&section.navTitle}}],methods:[function createView(opt_spec){if(!opt_spec)opt_spec={};var ctx=this.wizardlet.__subSubContext__.createSubContext({wizardController:this.wizardlet.wizardController});if(this.customView){return this.ViewSpec.createView(this.customView,{data$:this.wizardlet.data$},this,ctx)}ctx.register(this.VerticalDetailView,"foam.u2.detail.SectionedDetailView");return this.SectionView.create({section:this.section,data$:this.wizardlet.data$,...opt_spec,...this.showWizardletSectionTitles!==undefined?{showTitle:this.showWizardletSectionTitles}:{}},ctx)}]});
foam.CLASS({package:"foam.u2.wizard.wizardlet",name:"SuccessWizardlet",extends:"foam.u2.wizard.wizardlet.BaseWizardlet",imports:["currentMenu"],properties:[{class:"String",name:"message"},{class:"String",name:"actionLabel",factory:function(){return"Return to "+this.currentMenu.label}},{name:"sections",class:"FObjectArray",of:"foam.u2.wizard.wizardlet.WizardletSection",preSet:function(_,val){for(let wizardletSection of val){wizardletSection.wizardlet=this}return val},factory:function(){return[this.WizardletSection.create({title:this.title,isAvailable:true,customView:{class:"foam.u2.wizard.wizardlet.SuccessWizardletView",message$:this.message$}})]}}]});
foam.CLASS({package:"foam.u2.wizard.wizardlet",name:"SuccessWizardletView",extends:"foam.u2.View",css:`
^ {
text-align: center;
display: flex;
flex-direction: column;
justify-content: center;
align-items: center;
height: 100%;
}
^image {
width: 120pt;
margin-bottom: 69px;
margin-top: 122px;
}
`,properties:[{class:"String",name:"message",value:"Success!"},{class:"Image",name:"image",view:"foam.u2.view.ImageView",value:"/images/checkmark-outline-green.svg"}],methods:[function render(){this.addClass(this.myClass()).startContext({data:this}).start(this.IMAGE).addClass(this.myClass("image")).end().endContext().start().addClass("h200").add(this.message$).end()}]});
foam.CLASS({package:"foam.u2.wizard.wizardlet",name:"ReviewWizardletView",extends:"foam.u2.View",requires:["foam.core.AnyHolder","foam.u2.ControllerMode"],exports:["controllerMode"],css:`
^ .h200 {
text-align: center;
margin: 32px 0;
}
^generic-container {
display: flex;
flex-direction: column;
gap: 24px;
}
`,properties:[{class:"String",name:"title",factory:function(){return"Review Your Request"}},{class:"FObjectArray",of:"foam.u2.wizard.wizardlet.ReviewItem",name:"items"},{class:"Boolean",name:"showTitle",value:true},{name:"controllerMode",factory:function(){return this.ControllerMode.VIEW}}],methods:[function render(){var self=this;this.SUPER();this.addClass(this.myClass()).start().start().addClass("h200").show(this.showTitle$).add(this.title$).end().start().addClass(this.myClass("generic-container")).forEach(this.items,function(item){if(!item.predicate.f(self.AnyHolder.create({value:self.data.value[item.name]})))return;this.start(item.border).callIf(item.title,function(){this.start().addClass("h600").add(item.title).end()}).start(item.headingBorder).tag(item.view,{data:self.data.value[item.name]}).end().end()}).end().end()}]});
foam.CLASS({package:"foam.u2.wizard.wizardlet",name:"ReviewItem",extends:"foam.comics.v2.namedViews.NamedViewInstance",implements:["foam.mlang.Expressions"],requires:["foam.core.AnyHolder"],properties:[{name:"border",class:"foam.u2.ViewSpec",value:{class:"foam.u2.borders.NullBorder"}},{name:"headingBorder",class:"foam.u2.ViewSpec",value:{class:"foam.u2.borders.NullBorder"}},{class:"foam.mlang.predicate.PredicateProperty",name:"predicate",factory:function(){return this.HAS(this.AnyHolder.VALUE)}},{class:"String",name:"title"}]});
foam.CLASS({package:"foam.u2.wizard.wizardlet",name:"ReviewWizardlet",extends:"foam.u2.wizard.wizardlet.BaseWizardlet",requires:["foam.u2.detail.TabularSectionView","foam.u2.wizard.wizardlet.WizardletSection"],properties:[{class:"String",name:"actionLabel"},{class:"FObjectArray",of:"foam.u2.wizard.wizardlet.ReviewItem",name:"items"},{class:"String",name:"title",factory:function(){return"Review Your Request"}},{class:"Boolean",name:"showTitles"},{name:"sections",factory:function(){return[this.WizardletSection.create({isAvailable:true,title:"Review",customView:{class:"foam.u2.wizard.wizardlet.ReviewWizardletView",title$:this.title$,items$:this.items$,showTitle$:this.showTitles$}})]}}],methods:[function init(){const x=this.__subContext__;x.register(this.TabularSectionView,"foam.u2.detail.SectionView")}]});
foam.CLASS({package:"foam.u2.wizard.wizardlet",name:"AlternateFlowWizardlet",extends:"foam.u2.wizard.wizardlet.BaseWizardlet",implements:["foam.u2.wizard.DynamicActionWizardlet"],requires:["foam.u2.wizard.axiom.AlternateFlowAction"],properties:[{class:"FObjectArray",of:"foam.u2.wizard.AlternateFlow",name:"choices"},{name:"dynamicActions",expression:function(choices){return choices.map(alternateFlow=>this.AlternateFlowAction.create({alternateFlow:alternateFlow}))}}]});
foam.CLASS({package:"foam.u2.wizard.wizardlet",name:"SubmitWizardlet",extends:"foam.nanos.crunch.ui.CapabilityWizardlet",imports:["wizardlets"],properties:[["isVisible",false],{name:"of",value:"foam.core.RequiredBooleanHolder"},{name:"sections",factory:function(){return[]}},{name:"isValid",value:true}],actions:[{class:"foam.u2.wizard.axiom.WizardAction",name:"submit",code:function(x){let availableWizardlets=this.wizardlets.filter(w=>w.isAvailable);for(let i in availableWizardlets){if(!availableWizardlets[i].isValid)return}this.data.value=true}}]});
foam.CLASS({package:"foam.u2.wizard.wizardlet",name:"FlowAgentWizardlet",extends:"foam.u2.wizard.wizardlet.BaseWizardlet",imports:["flowAgent?"],properties:[["isVisible",false],["of",null],"pubMessage"],methods:[function save(){if(this.flowAgent)this.flowAgent.pub(this.pubMessage)}]});
foam.CLASS({package:"foam.u2.wizard.wizardlet",name:"DAOWizardlet",extends:"foam.u2.wizard.wizardlet.BaseWizardlet",requires:["foam.u2.wizard.wao.DAOWAO"],properties:[{name:"of",class:"Class"},{name:"data",class:"FObjectProperty",of:"foam.core.FObject",factory:function(){return this.of.create({},this.__context__)}},{class:"String",name:"path"},{name:"wao",factory:function(){return this.DAOWAO.create({path:this.path,of:this.data.cls_},this.__context__)}}]});
foam.CLASS({package:"foam.u2.wizard.wizardlet",name:"FacadeCapabilityWizardlet",extends:"foam.nanos.crunch.ui.CapabilityWizardlet",requires:["foam.u2.wizard.wao.SplitWAO","foam.u2.wizard.data.FacadeWizardletSaver","foam.u2.wizard.data.ProxyLoader"],properties:[{class:"FObjectArray",name:"facadeWizardletSpecs",of:"foam.u2.wizard.wizardlet.FacadeWizardletSpec"},{name:"wao",factory:function(){var splitWAO=this.SplitWAO.create({loader:{class:"foam.u2.wizard.data.CreateLoader"},saver:{class:"foam.u2.wizard.data.FacadeWizardletSaver",facadeWizardletSpecs$:this.facadeWizardletSpecs$}},this.__context__);return splitWAO}}]});
foam.CLASS({package:"foam.u2.wizard.wizardlet",name:"FacadeWizardletSpec",properties:[{class:"String",name:"wizardletId"},{class:"foam.u2.wizard.PathProperty",name:"loadFromFacadePath"},{class:"foam.u2.wizard.PathProperty",name:"loadIntoRealPath"},{class:"Boolean",name:"isOverridedWizardletVisible"}]});foam.ENUM({package:"foam.u2.crunch.wizardflow",name:"SkipMode",values:[{name:"HIDE",label:"hide",},{name:"SHOW",label:"show",},{name:"SKIP",label:"skip",}]});
foam.CLASS({package:"foam.u2.crunch",name:"EasyCrunchWizard",requires:["foam.u2.crunch.wizardflow.SkipGrantedAgent","foam.u2.crunch.wizardflow.SkipMode","foam.u2.wizard.StepWizardConfig"],properties:[{class:"Boolean",name:"allowSkipping",},{class:"Boolean",name:"allowBacktracking",value:true,},{name:"skipMode",class:"Enum",of:"foam.u2.crunch.wizardflow.SkipMode",factory:function(){return this.SkipMode.SKIP}},{name:"incrementalWizard",class:"Boolean",},{class:"foam.u2.ViewSpec",name:"controller"},{class:"String",name:"view",value:"foam.nanos.crunch.ui.UCJView"},{class:"Boolean",name:"rejectOnInvalidatedSave",},{class:"Boolean",name:"requireAll",},{class:"Boolean",name:"preventApprovableCreation",},{class:"foam.u2.ViewSpec",name:"popup"},{class:"FObjectArray",of:"foam.core.FObject",name:"sequenceExtras"}],methods:[function applyTo(sequence){var config=this.StepWizardConfig.create({allowSkipping:this.allowSkipping,allowBacktracking:this.allowBacktracking,rejectOnInvalidatedSave:this.rejectOnInvalidatedSave,controller:this.controller,requireAll:this.requireAll,...this.incrementalWizard?{wizardView:{class:"foam.u2.wizard.IncrementalStepWizardView"}}:{}});if(this.popup){sequence.reconfigure("ConfigureFlowAgent",{popupMode:true});config.popup={class:"foam.u2.dialog.Popup",...this.popup}}sequence.reconfigure("CreateControllerAgent",{config:config});if(this.skipMode)sequence.reconfigure("SkipGrantedAgent",{mode:this.skipMode});if(this.statelessWizard)sequence.remove("WizardStateAgent");if(this.preventApprovableCreation)sequence.remove("GrantedEditAgent");for(const fluentSpec of this.sequenceExtras){fluentSpec.apply(sequence)}},async function execute(){}]});
foam.CLASS({package:"foam.graphics",name:"ZoomMapView",extends:"foam.graphics.CView",requires:["foam.graphics.Box","foam.graphics.CView","foam.graphics.Circle"],properties:[{class:"Color",name:"navBorder",value:"black"},{class:"Color",name:"viewBorder",value:"red"},{class:"Int",name:"viewBorderWidth",value:5},{class:"Int",name:"navBorderWidth",value:10},{class:"Map",visibility:"RO",name:"viewPortPosition",preSet:function(_,n){if(!this.hasOwnProperty("navView_")||!this.hasOwnProperty("viewPortView_")){return{x:0,y:0}}return{x:Math.max(0,Math.min(n.x||0,this.navView_.width-this.viewPortView_.width)),y:Math.max(0,Math.min(n.y||0,this.navView_.height-this.viewPortView_.height))}}},{class:"Float",name:"navSize",value:.2,postSet:function(o,n){this.viewPortPosition={x:this.viewPortPosition.x*(n/o),y:this.viewPortPosition.y*(n/o)}}},{class:"Float",name:"scale",value:1},{name:"view",hidden:true,required:true},{class:"Color",name:"handleColor",value:"green"},{class:"Float",name:"handleHeight",value:20},{class:"Float",name:"navScalerSize",value:20},{name:"navView_",hidden:true,factory:function(){var v=this.Box.create({x:this.navBorderWidth/2,y:this.handleHeight+this.navBorderWidth/2,borderWidth$:this.navBorderWidth$,border$:this.navBorder$,clip:true,width$:this.innerNavView_.slot(function(scaleX,width){return scaleX*width}),height$:this.innerNavView_.slot(function(scaleY,height){return scaleY*height})});v.add(this.innerNavView_);v.add(this.viewPortView_);return v}},{name:"viewPortView_",hidden:true,factory:function(){var v=this.Box.create({borderWidth$:this.viewBorderWidth$,border$:this.viewBorder$,height$:this.slot(function(scale,height,innerNavView_$scaleY){return height*innerNavView_$scaleY/scale}),width$:this.slot(function(scale,width,innerNavView_$scaleX){return width*innerNavView_$scaleX/scale}),x$:this.slot(function(viewPortPosition){return viewPortPosition.x}),y$:this.slot(function(viewPortPosition){return viewPortPosition.y})});return v}},{name:"navViewHandle_",hidden:true,factory:function(){return this.Box.create({width$:this.slot(function(navView_$width,navBorderWidth){return navView_$width+navBorderWidth}),height$:this.handleHeight$,color$:this.handleColor$,x$:this.slot(function(navView_$x,navBorderWidth){return navView_$x-navBorderWidth/2}),y$:this.slot(function(navView_$y,navBorderWidth,handleHeight){return navView_$y-handleHeight-navBorderWidth/2})})}},{name:"navScaler_",hidden:true,factory:function(){return this.CView.create({height$:this.navScalerSize$,width$:this.navScalerSize$,x$:this.slot(function(navScalerSize,navView_$x,navView_$width,navBorderWidth){return navView_$x+navView_$width+navBorderWidth/2-navScalerSize/2}),y$:this.slot(function(navScalerSize,navView_$y,navView_$height,navBorderWidth){return navView_$y+navView_$height+navBorderWidth/2-navScalerSize/2})})}},{name:"innerNavView_",hidden:true,factory:function(){var viewScale$=this.slot(function(navSize,width,view$width,height,view$height){return navSize*Math.min(width/view$width,height/view$height)});var v=this.CView.create({width$:this.view$.dot("width"),height$:this.view$.dot("height"),scaleX$:viewScale$,scaleY$:viewScale$});v.add(this.view);return v}},{name:"scaledView_",hidden:true,factory:function(){var v=this.Box.create({clip:true,height$:this.view$.dot("height"),width$:this.view$.dot("width"),scaleX$:this.scale$,scaleY$:this.scale$,x$:this.slot(function(scale,viewPortView_$x,navView_$width,view$width){return-scale*view$width*viewPortView_$x/navView_$width}),y$:this.slot(function(scale,viewPortView_$y,navView_$height,view$height){return-scale*view$height*viewPortView_$y/navView_$height})});v.add(this.view);return v}}],methods:[function initCView(){this.SUPER();this.add(this.scaledView_);this.add(this.navView_);this.add(this.navViewHandle_);this.add(this.navScaler_);this.view.parent=this.scaledView_;this.attachViewPortListener();this.attachHandleListener();this.attachNavScalerListener()},function attachViewPortListener(){var drag=false;var moveViewPort=e=>{if(!drag)return;this.viewPortPosition={x:e.offsetX-this.navView_.x-this.viewPortView_.width/2,y:e.offsetY-this.navView_.y-this.viewPortView_.height/2}};this.onDetach(this.canvas.on("mousedown",e=>{drag=this.innerNavView_.hitTest(this.innerNavView_.globalToLocalCoordinates({w:1,x:e.offsetX,y:e.offsetY}));moveViewPort(e)}));this.onDetach(this.canvas.on("mouseup",_=>drag=false));this.onDetach(this.canvas.on("mousemove",moveViewPort))},function attachNavScalerListener(){var drag=null;var doHitTest=e=>{return this.navScaler_.hitTest(this.navScaler_.globalToLocalCoordinates({w:1,x:e.offsetX,y:e.offsetY}))};var scaleNavView=e=>{if(!drag)return;var desiredWidth=drag.width+e.offsetX-drag.x;var desiredHeight=drag.height+e.offsetY-drag.y;this.navSize=Math.max(drag.navSize*desiredWidth/drag.width,drag.navSize*desiredHeight/drag.height)};this.onDetach(this.canvas.on("mousedown",e=>{var p={x:e.offsetX-this.navScaler_.x,y:e.offsetY-this.navScaler_.y};drag=doHitTest(e)?{x:e.offsetX,y:e.offsetY,width:this.navView_.width,height:this.navView_.height,navSize:this.navSize}:null;scaleNavView(e)}));this.onDetach(this.canvas.on("mouseup",_=>drag=null));this.onDetach(this.canvas.on("mousemove",e=>{if(drag||doHitTest(e)){this.canvas.style({cursor:"se-resize"})}scaleNavView(e)}))},function attachHandleListener(){var drag=null;var doHitTest=e=>{var p=this.navViewHandle_.globalToLocalCoordinates({w:1,x:e.offsetX,y:e.offsetY});return this.navViewHandle_.hitTest(p)?p:null};var moveNavView=e=>{if(!drag)return;this.navView_.x=Math.max(this.navBorderWidth/2,Math.min(e.offsetX-drag.x,this.width-this.navView_.width));this.navView_.y=Math.max(this.handleHeight+this.navBorderWidth/2,Math.min(e.offsetY-drag.y+this.handleHeight,this.height-this.navView_.height))};this.onDetach(this.canvas.on("mousedown",e=>{drag=doHitTest(e);moveNavView(e)}));this.onDetach(this.canvas.on("mouseup",_=>drag=null));this.onDetach(this.canvas.on("mousemove",e=>{if(drag||doHitTest(e)){this.canvas.style({cursor:"move"})}else{this.canvas.style({cursor:"default"})}moveNavView(e)}))}]});
foam.CLASS({package:"foam.strategy",name:"StrategyReference",tableColumns:["desiredModelId","target","strategy"],properties:[{class:"String",name:"id",},{class:"String",name:"desiredModelId",help:"The id of the model that the referenced strategy is a strategy for.",required:true},{class:"Class",name:"strategy",help:"The strategy for the desired model.",required:true},{class:"String",name:"target",},{class:"String",name:"label",}]});foam.INTERFACE({package:"foam.strategy",name:"StrategizerService",proxy:true,skeleton:true,methods:[{name:"query",async:true,type:"foam.strategy.StrategyReference[]",args:[{type:"Context",name:"x"},{type:"String",name:"desiredModelId",},{type:"String",name:"target",},{name:"strategyPredicate",}]}]});
foam.CLASS({package:"foam.strategy",name:"BasicStrategizer",implements:["foam.strategy.StrategizerService"],imports:["DAO strategyDAO"],methods:[{name:"query",}]});
foam.CLASS({package:"foam.strategy",name:"ClientStrategizerService",implements:["foam.strategy.StrategizerService"],properties:[{class:"Stub",of:"foam.strategy.StrategizerService",name:"delegate"}]});
foam.CLASS({package:"foam.core",name:"Unit",properties:[{class:"String",name:"name",required:true},{class:"String",name:"id",label:"Code",required:true},{class:"Int",name:"precision",required:true}],methods:[{name:"format",args:[{class:"foam.core.UnitValue",name:"amount"}],type:"String",}]});
foam.CLASS({package:"foam.core",name:"Currency",extends:"foam.core.Unit",imports:["translationService"],tableColumns:["name","id","country","symbol","emoji"],axioms:[{buildJavaClass:function(cls){cls.extras.push(`
public String format(X x, long amount) {
return format(x, amount, false);
}
`)}}],properties:[{class:"Long",name:"numericCode",required:true},{class:"Reference",of:"foam.nanos.auth.Country",name:"country",required:true},{class:"String",name:"delimiter",required:true},{class:"String",name:"decimalCharacter",required:true},{class:"String",name:"symbol",required:true},{class:"String",name:"leftOrRight",required:true,validateObj:function(leftOrRight){if(leftOrRight!=="left"&&leftOrRight!=="right")return`Property 'leftOrRight' must be set to either "left" or "right".`}},{class:"String",name:"flagImage",},{class:"String",name:"colour",value:"#406dea",},{class:"String",name:"emoji",value:"💰"},{class:"Boolean",name:"showSpace",required:true}],methods:[{name:"toSummary",type:"String",code:function(x){return this.id+" - "+this.translationService.getTranslation(foam.locale,`${this.id}.name`,this.name)},},{name:"format",code:function(amount,hideId,hideSymbol){amount=Math.round(amount);var isNegative=amount<0;amount=amount.toString();if(isNegative)amount=amount.substring(1);while(amount.length<this.precision)amount="0"+amount;var beforeDecimal=amount.substring(0,amount.length-this.precision);var formatted=isNegative?"-":"";if(!hideId&&this.leftOrRight==="right"){formatted+=this.id;formatted+=" "}if(!hideSymbol&&this.leftOrRight==="left"){formatted+=this.symbol;if(this.showSpace)formatted+=" "}var delimiter=this.translationService.getTranslation(foam.locale,"Currency.delimiter",this.delimiter);var decimal=this.translationService.getTranslation(foam.locale,"Currency.decimalCharacter",this.decimalCharacter);formatted+=beforeDecimal.replace(/\B(?=(\d{3})+(?!\d))/g,delimiter)||"0";if(this.precision>0){formatted+=decimal;formatted+=amount.substring(amount.length-this.precision)}if(!hideSymbol&&this.leftOrRight==="right"){if(this.showSpace)formatted+=" ";formatted+=this.symbol}if(!hideId&&this.leftOrRight==="left"){formatted+=" ";formatted+=this.id}return formatted},args:[{name:"x",type:"Context"},{class:"foam.core.UnitValue",name:"amount"},{class:"Boolean",name:"hideId",}],type:"String",},{name:"formatPrecision",code:function(amount){return(amount/Math.pow(10,this.precision)).toFixed(this.precision)},args:[{name:"x",type:"Context"},{class:"foam.core.UnitValue",name:"amount"}],type:"String",}]});
foam.CLASS({package:"foam.core",name:"NumberSet",properties:[{class:"List",name:"pseudoSet",factory:function(){return[]}}],methods:[{name:"add",type:"Boolean",args:[{name:"element",type:"Long"}],code:function(element){if(!Number.isInteger(element)){console.error("Element is not an integer");return false}if(!this.pseudoSet.includes(element)){this.pseudoSet.push(element);return true}return false},},{name:"remove",type:"Boolean",args:[{name:"element",type:"Long"}],code:function(element){if(!Number.isInteger(element)){console.error("Element is not an integer");return false}if(this.pseudoSet.includes(element)){var newArray=this.pseudoSet.filter(value=>value!==element);this.pseudoSet=newArray;return true}return false},},{name:"contains",type:"Boolean",args:[{name:"element",type:"Long"}],code:function(element){if(!Number.isInteger(element)){console.error("Element is not an integer");return false}return this.pseudoSet.includes(element)},},{name:"getAsRealSet",},{name:"setAsRealSet",type:"void",args:[{name:"set",type:"Set<Long>"}],}]});
foam.CLASS({package:"foam.util.concurrent",name:"AbstractAssembly",implements:["foam.util.concurrent.Assembly"],properties:[{name:"isCompleted",class:"Boolean",synchronized:true,value:false,}],methods:[{name:"requestLocks",},{name:"executeUnderLock",},{name:"startJob",},{name:"executeJob",},{name:"endJob",args:["boolean isLast"],},{name:"complete",synchronized:true,},{name:"waitToComplete",synchronized:true,}]});foam.INTERFACE({name:"Assembly",package:"foam.util.concurrent",methods:[{name:"requestLocks",type:"Object[]",},{name:"executeUnderLock",},{name:"startJob",},{name:"executeJob",},{name:"endJob",args:["boolean isLast"],},{name:"complete",},{name:"waitToComplete",}]});
foam.CLASS({package:"foam.foamlink",name:"FoamlinkData",flags:["node"],properties:[{name:"filesToClasses",class:"Map",value:{}},{name:"classesToFiles",class:"Map",value:{}}],methods:[function add(fileName,idsPresent){this.filesToClasses[fileName]=idsPresent;if(!Array.isArray(idsPresent)){idsPresent=Object.keys(idsPresent)}for(var i=0;i<idsPresent.length;i++){this.classesToFiles[idsPresent[i]]=fileName}},function saveToDisk(filepath){require("fs").writeFileSync(filepath,JSON.stringify({filesToClasses:this.filesToClasses,classesToFiles:this.classesToFiles}))}]});
foam.CLASS({package:"foam.foamlink",name:"FoamlinkExec",properties:[["repositories_",{}],["ignorePaths_",{}],["injectFiles_",{}],["reservedNames_",["files.js","files2.js","classes.js"]],{name:"results",class:"FObjectProperty",factory:function(){return foam.foamlink.FoamlinkData.create()}}],methods:[function init(){this.nodejs_={};this.require_("path");this.require_("fs")},function require_(name,asName){Object.defineProperty(this.nodejs_,asName||name,{value:require(name),writable:false})},function exec(path){var self=this;path=path||process.cwd();return new Promise((resolve,reject)=>{this.processFoamlinkFile(path,true);Promise.all(Object.keys(this.repositories_).map(repoPath=>this.startWalking(repoPath,reject))).then(resolve)})},function startWalking(repoPath,reject){var self=this;try{this.processFoamlinkFile(repoPath,false,true)}catch(e){reject(e)}var walker=foam.util.filesystem.FileWalker.create();walker.files.sub((_1,_2,info)=>{try{self.handleDirectory(repoPath,info)}catch(e){console.error(e);reject(e)}});return walker.walk(repoPath)},function handleDirectory(repoPath,info){var tag="[36;1m<<<FOAMLINK>>>[0m ";var g=s=>"[32;1m"+s+"[0m ";var w="[33;1m[WARN][0m ";for(k in this.ignorePaths_){if(info.directory===k||info.directory.startsWith(k+"/"))return}var relPath=this.nodejs_.path.relative(repoPath,info.directory);var expectedPackage=relPath.replace(/[\\/]/g,".");this.processFoamlinkFile(info.directory,false,false);for(name in info.files){let fileInfo=info.files[name];if(fileInfo.name==="foamlink.js"||fileInfo.name==="foam.js"||!fileInfo.name.endsWith(".js")||fileInfo.name.startsWith(".")||fileInfo.name.startsWith("#")||this.reservedNames_.includes(fileInfo.name)||this.ignorePaths_[fileInfo.fullPath])continue;let text=this.nodejs_.fs.readFileSync(fileInfo.fullPath);text=text.toString();if(this.injectFiles_[fileInfo.fullPath]){injectCode=this.injectFiles_[fileInfo.fullPath].join("\n")+"\n";text=injectCode+text}let idsPresent=null;try{idsPresent=foam.foamlink.lib.processSourceForMeta(text)}catch(e){e.message="Error processing <"+fileInfo.fullPath+">: "+e.message;throw e}for(id in idsPresent){if(!(id===expectedPackage||id.startsWith(expectedPackage+"."))){}}this.results.add(fileInfo.fullPath,idsPresent)}},function processFoamlinkFile(path,required,encouraged){var tag="[36;1m<<<FOAMLINK>>>[0m ";var g=s=>"[32;1m"+s+"[0m ";var w="[33;1m[WARN][0m ";var self=this;filePath=this.nodejs_.path.join(path,"foamlink.js");try{this.nodejs_.fs.lstatSync(filePath)}catch(e){if(required){throw new Error("unable to open foamlink.js in "+path,e)}if(encouraged){console.warn(tag+w+"No foamlink.js file; using default settings: "+path)}return false}var text=null;try{text=this.nodejs_.fs.readFileSync(filePath);text=text.toString()}catch(e){throw e}var foamlinkFileInfo={version:"0.0.0"};var __foamlink__={};__foamlink__.RUNNING_IN_FOAMLINK=true;__foamlink__.REPO=function(repoPath){console.log(tag+g("[REPOSITORY]")+repoPath);let fullPath=self.nodejs_.path.join(path,repoPath);self.repositories_[fullPath]={}};__foamlink__.ABORT=function(msg){throw new Error(msg)};__foamlink__.VERSION=function(v){if(typeof v!=="string"){throw new Error("foamlink version must be string")}foamlinkFileInfo.version=v};__foamlink__.IGNORE=function(ignorePath){let fullPath=self.nodejs_.path.join(path,ignorePath);self.ignorePaths_[fullPath]={}};__foamlink__.BROKEN=__foamlink__.IGNORE;__foamlink__.INJECT=function(injectFile,code){let fullPath=self.nodejs_.path.join(path,injectFile);if(self.injectFiles_[fullPath]){self.injectFiles_[fullPath].push(code)}else{self.injectFiles_[fullPath]=[code]}};__foamlink__.MANUAL=function(filePath,classes){let fullPath=self.nodejs_.path.join(path,filePath);self.results.add(fullPath,classes);self.ignorePaths_[fullPath]={}};__foamlink__.ROOTS=function(){for(var i=0;i<arguments.length;i++){foam.foamlink.lib.addRoot(arguments[i])}};with(__foamlink__){eval(text)}}]});foam.LIB({name:"foam.foamlink.lib",methods:[function addRoot(newRoot){if(!foam.foamlink.lib.roots)foam.foamlink.lib.roots=[];foam.foamlink.lib.roots.push(newRoot)},{name:"processSourceForMeta",code:function(text){var idsPresent={};var context={foam_:{}};["CLASS","INTERFACE","ENUM","SCRIPT","RELATIONSHIP","LIB"].forEach(typ=>{context.foam_[typ]=m=>{var id=m.package?m.package+"."+m.name:m.name||"";idsPresent[id]={type:typ}}});context.foam_.LIB=m=>{idsPresent[m.name]={type:"LIB"}};context.foam_.realfoam=foam;var srcMeta=`
//@ sourceURL=filename_unknown.js
`;var restoreObjectDefineProperty__=Object.defineProperty;Object.defineProperty=()=>{};var requiredVars={roots:foam.foamlink.lib.roots};try{(function(){with(context){var __infiniteProxy__=null;__infiniteProxy__=source=>{var p=new Proxy(source,{get:function(obj,name){var newObj=function(){};newObj.parent=obj;newObj.myName=name;return __infiniteProxy__(newObj)},apply:function(obj,thisArg,argumentList){if(obj.myName==="toString")return"";return __infiniteProxy__(obj)},construct:function(obj,args){return __infiniteProxy__(obj)}});p[Symbol.toPrimitive]=hint=>{if(hint=="number")return 0;if(hint=="string")return"";return null};return p};var foam=new Proxy(foam_,{get:function(obj,name){return obj[name]===undefined?__infiniteProxy__(function(){}):obj[name]}});for(var i=0;i<requiredVars.roots.length;i++){eval("var "+requiredVars.roots[i]+" = __infiniteProxy__(function(){})")}eval(text+srcMeta)}})()}catch(e){throw e}finally{Object.defineProperty=restoreObjectDefineProperty__}return idsPresent}}]});
foam.CLASS({package:"foam.util.filesystem",name:"FileWalker",topics:["files","directoryStart","directoryEnd","error","skip"],properties:[{name:"order",value:"BFS",},"nodejs_",["skipNext",false]],methods:[function init(){this.nodejs_={};this.require_("path");this.require_("fs");this.skip.sub(()=>{this.skipNext=true})},function require_(name,asName){Object.defineProperty(this.nodejs_,asName||name,{value:require(name),writable:false})},function walk(path,depth){if(typeof depth==="undefined"){depth=0}var self=this;return new Promise(function(resolve,reject){self.nodejs_.fs.readdir(path,function(err,files){if(err){reject(err);return}filesMessage={directory:path,files:{}};directoriesToWalk=[];let fileInfos=files.map(file=>{let fullPath=self.nodejs_.path.join(path,file);try{stats=self.nodejs_.fs.lstatSync(fullPath);return{name:file,fullPath:fullPath,stats:stats}}catch(e){console.warn("Failed to stat file: "+fullPath);self.error.pub("stat",e)}return null}).filter(info=>info!==null);directoriesToWalk=fileInfos.filter(info=>info.stats.isDirectory()).map(info=>info.fullPath);filesMessage.files=fileInfos.filter(info=>!info.stats.isDirectory());let recursePromises=[];switch(self.order){case"BFS":self.directoryStart.pub(path);self.files.pub(filesMessage);if(this.skipNext){this.skipNext=false;break}Promise.all(directoriesToWalk.map(fullPath=>self.walk(fullPath,depth+1))).then(()=>{self.directoryEnd.pub(path);resolve()});break;case"DFS":self.directoryStart.pub(path);Promise.all(directoriesToWalk.map(fullPath=>self.walk(fullPath,depth+1))).then(()=>{self.files.pub(filesMessage);self.directoryEnd.pub(path);resolve()});break}})})}]});
foam.CLASS({package:"foam.nanos.column",name:"ColumnConfigToPropertyConverter",properties:[{name:"columnHandler",class:"FObjectProperty",of:"foam.nanos.column.CommonColumnHandler",flags:["js"],factory:function(){return foam.nanos.column.CommonColumnHandler.create()}}],methods:[{name:"filterExportedProps",code:function(of,propNames){var props=of.getAxiomsByClass(foam.core.Property);var allColumnNames=props.map(p=>p.name);if(!propNames)return props.map(p=>p.name);return propNames.filter(n=>{return allColumnNames.includes(n.split(".")[0])})}},{name:"returnColumnHeader",type:"String",args:[{name:"of",type:"ClassInfo"},{name:"propName",class:"String"}],code:function(of,propName){var cls=of;var axiom;var colPath=[];var colLabel="";if(foam.String.isInstance(propName)){var propNames=propName.split(".");for(var i=0;i<propNames.length;i++){axiom=cls.getAxiomByName(this.columnHandler.propertyNamesForColumnArray(propNames[i]));if(!axiom)return"";colPath.push(axiom.label||foam.String.labelize(axiom.name));if(i==propNames.length-1){colLabel=axiom.columnLabel}cls=axiom.of}}else{if(propName.label)colPath.push(propName.label);else{if(!propName.name)colPath.push("-");else{axiom=cls.getAxiomByName(propName.name);if(axiom)colPath.push(axiom.columnLabel);else colPath.push("-")}}}return{colPath:colPath,colLabel:colLabel}}},{name:"returnProperty",type:"PropertyInfo",args:[{name:"of",type:"ClassInfo"},{name:"propName",class:"String"}],code:function(of,propName){var cls=of;var property;if(foam.String.isInstance(propName)){var propNames=propName.split(".");for(var i=0;i<propNames.length;i++){property=foam.String.isInstance(propNames[i])?cls.getAxiomByName(propNames[i]):foam.Array.isInstance(propNames[i])?cls.getAxiomByName(propNames[i]):propNames[i];if(!property)break;cls=property.of}}else{property=propName}return property},},{name:"returnPropertyAndObject",type:"foam.nanos.column.ColumnPropertyValue",args:[{name:"x",type:"Context"},{name:"of",type:"ClassInfo"},{name:"propName",class:"String"},{name:"obj",type:"FObject"}],code:async function(of,propName,obj){var cls=of;var property;var obj1=obj;if(foam.String.isInstance(propName)){var propNames=propName.split(".");for(var i=0;i<propNames.length;i++){property=foam.String.isInstance(propNames[i])?cls.getAxiomByName(propNames[i]):foam.Array.isInstance(propNames[i])?cls.getAxiomByName(propNames[i]):propNames[i];if(!property)break;cls=property.of;if(i!==propNames.length-1&&obj1){if(foam.core.Reference.isInstance(property)){obj1=await obj1[property.name+"$find"]}else{obj1=property.f(obj1)}}}}else property=propName;return foam.nanos.column.ColumnPropertyValue.create({propertyValue:property,objValue:obj1})},},async function returnValueForPropertyName(x,of,propName,obj){var columnPropertyVal=await this.returnPropertyAndObject(x,of,propName,obj);if(foam.core.Reference.isInstance(columnPropertyVal.propertyValue))return foam.nanos.column.ColumnPropertyValue.create({propertyValue:columnPropertyVal.propertyValue,objValue:await columnPropertyVal.objValue[columnPropertyVal.propertyValue.name+"$find"]});return foam.nanos.column.ColumnPropertyValue.create({propertyValue:columnPropertyVal.propertyValue,objValue:columnPropertyVal.propertyValue.f(columnPropertyVal.objValue)})},function returnProperties(of,propNames){var arr=[];for(var prop of propNames){arr.push(this.returnProperty(of,prop))}return arr},function returnPropertyColumnMappings(of,propertyNamesToQuery){var result=[];for(var propName of propertyNamesToQuery){result.push(foam.u2.table.PropertyColumnMapping.create({fullPropertyName:propName,property:this.returnProperty(of,propName)}))}return result},function returnPropertyNameForLabel(of,label){var labels=label.split(" / ");var names=[];var of=of;for(var i=0;i<labels.length;i++){var prop=of.getAxioms().find(a=>a.label&&a.label==labels[i]);if(!prop)return"";names.push(prop.name);of=prop.of}return names.join(".")},function returnPropertyLabelForName(of,name){var names=name.split(".");var labels=[];var of=of;for(var i=0;i<names.length;i++){var prop=of.getAxioms().find(a=>a.name&&a.name==names[i]);if(!prop)return"";labels.push(prop.label);of=prop.of}return labels.join(" / ")}]});
foam.CLASS({package:"foam.nanos.column",name:"ColumnPropertyValue",properties:[{name:"propertyValue",class:"FObjectProperty",},{name:"objValue",class:"FObjectProperty",of:"FObject"}]});
foam.CLASS({package:"foam.nanos.column",name:"CommonColumnHandler",requires:["foam.nanos.column.ColumnConfigToPropertyConverter"],methods:[function returnColumnNameForNLevelName(col,n){if(!col.split)return null;var propNames=col.split(".");if(n===-1){if(propNames.length===0)n=0;else n=propNames.length-1}return propNames[n]},function propertyNamesForColumnArray(col){return this.returnPropertyNamesForColumn(this.returnNElementIfArray(col,0))},function returnPropertyNamesForColumn(col){return this.canColumnBeTreatedAsAnAxiom(col)?col.name:col},function checkIfArrayAndReturnColumnLastLevelName(col){return this.returnColumnLastLevelName(this.returnNElementIfArray(col,0))},function returnColumnLastLevelName(col){return this.canColumnBeTreatedAsAnAxiom(col)?col.name:this.returnColumnNameForNLevelName(col,-1)},function checkIfArrayAndReturnFirstLevelColumnName(col){return this.returnColumnFirstLevelName(this.returnNElementIfArray(col,0))},function returnColumnFirstLevelName(col){return this.canColumnBeTreatedAsAnAxiom(col)?col.name:this.returnColumnNameForNLevelName(col,0)},function returnNElementIfArray(col,n){return foam.Array.isInstance(col)?col[n]:col},function canColumnBeTreatedAsAnAxiom(col){return foam.core.Property.isInstance(col)||foam.core.Action.isInstance(col)||foam.Object.isInstance(col)},function mapArrayColumnsToArrayOfColumnNames(cols){return cols.map(c=>this.propertyNamesForColumnArray(c))},function checkIfArrayAndReturnPropertyNameForRootProperty(rootProperty){return this.returnPropertyNameForRootProperty(this.returnNElementIfArray(rootProperty,0))},function returnPropertyNameForRootProperty(rootProperty){return this.canColumnBeTreatedAsAnAxiom(rootProperty)?rootProperty.name:rootProperty},function checkIfArrayAndReturnRootPropertyHeader(rootProperty){return this.returnRootPropertyHeader(this.returnNElementIfArray(rootProperty,1))},function returnRootPropertyHeader(rootProperty){return this.canColumnBeTreatedAsAnAxiom(rootProperty)?this.returnAxiomHeader(rootProperty):rootProperty},function checkIfArrayAndReturnAxiomHeader(rootProperty){return this.returnAxiomHeader(this.returnNElementIfArray(rootProperty,0))},function returnAxiomHeader(axiom){return axiom.columnLabel},function getClassForNestedPropertyObject(cls,propNames){var of_=cls;for(var i=0;i<propNames.length-1;i++){of_=of_.getAxiomByName(propNames[i]).of}return of_},function returnPropNamesToQuery(props){var propertyNamesToQuery=props.filter(p=>foam.core.Property.isInstance(p.property)).map(p=>p.fullPropertyName);props.forEach(p=>{var propPrefix=!p.fullPropertyName.includes(".")?"":this.getNestedPropertyNameExcludingLastProperty(p.fullPropertyName)+".";if(foam.core.UnitValue.isInstance(p.property)&&p.property.unitPropName)propertyNamesToQuery.push(propPrefix+p.property.unitPropName);for(var i=0;i<p.property.dependsOnPropertiesWithNames.length;i++){propertyNamesToQuery.push(propPrefix+p.property.dependsOnPropertiesWithNames[i])}});return propertyNamesToQuery},function returnPropertyForColumn(props,of,col,property){var colObj=foam.Array.isInstance(col)?col[1]&&col[1][property]?col[1]:col[0]:col;if(colObj&&this.canColumnBeTreatedAsAnAxiom(colObj)){if(colObj[property])return colObj[property]}var prop=props.find(p=>p.fullPropertyName===this.returnPropertyNamesForColumn(colObj));return prop?prop.property[property]:of.getAxiomByName(this.returnPropertyNamesForColumn(colObj))[property]},function groupRelatedObjects(of,arrayOfNestedPropertiesName,arrayOfValues){var map={};for(var i=0;i<arrayOfNestedPropertiesName.length;i++){var key=this.getNestedPropertyNameExcludingLastProperty(arrayOfNestedPropertiesName[i]);var objsClass=this.getClassForNestedPropertyObject(of,arrayOfNestedPropertiesName[i].split("."));if(!map[key]){map[key]=objsClass.create({},this)}if(arrayOfValues[i])objsClass.getAxiomByName(this.getNameOfLastPropertyForNestedProperty(arrayOfNestedPropertiesName[i])).set(map[key],arrayOfValues[i])}return map},function getNestedPropertyNameExcludingLastProperty(nestedPropertyName){var lastIndex=nestedPropertyName.lastIndexOf(".");return nestedPropertyName.substr(0,lastIndex)},function getNameOfLastPropertyForNestedProperty(nestedPropertyName){var lastIndex=nestedPropertyName.lastIndexOf(".");return nestedPropertyName.substr(lastIndex+1)},function buildPropNameAndIndexArray(propNames){var nestedPropertyNames=[];var indexOfValuesForCorrespondingPropertyNames=[];for(var i=0;i<propNames.length;i++){if(!propNames[i].includes("."))continue;nestedPropertyNames.push(propNames[i]);indexOfValuesForCorrespondingPropertyNames.push(i)}var result=[nestedPropertyNames,indexOfValuesForCorrespondingPropertyNames];return result},function filterNestedPropertyValues(valuesArray,indexes){var filteredArr=[];for(var i=0;i<indexes.length;i++){filteredArr.push(valuesArray[indexes[i]])}return filteredArr}]});
foam.CLASS({package:"foam.nanos.column",name:"CSVTableOutputter",extends:"foam.nanos.column.TableColumnOutputter",methods:[function arrayToCSV(arrayOfValues){var output=[];for(var row of arrayOfValues){row=row.map(v=>{return'"'+(v.replaceAll&&v.replaceAll('"','""')||v)+'"'});output.push(row.join(","))}return output.join("\n")}]});
foam.CLASS({package:"foam.nanos.column",name:"NestedPropertiesExpression",extends:"foam.mlang.AbstractExpr",implements:["foam.core.Serializable"],properties:[{name:"objClass",class:"Object",},{name:"nestedProperty",class:"String"}],methods:[{name:"set",args:[{name:"o",type:"Object"},{name:"value",type:"Object"}],code:function(o,val){if(this.nestedProperty.includes("."))return;o.cls_.getAxiomByName(this.nestedProperty).set(o,val)},},{name:"toString",code:function(){return this.cls_.name+"("+this.objClass.id+", "+this.nestedProperty+")"},},{name:"f",type:"Any",code:function(obj){var e=this.returnDotExprForNestedProperty(this.objClass,this.nestedProperty.split("."),0);if(!e)return null;return e.f(obj)},},{name:"returnDotExprForNestedProperty",args:[{name:"of",type:"Object",},{name:"propName",class:"StringArray"},{name:"i",class:"Int"},{name:"expr",}],code:function(of,propName,i,expr){var prop=of.getAxiomByName(propName[i]);if(!prop)return null;if(i===propName.length-1)return!expr?prop:foam.mlang.Expressions.create().DOT(expr,prop);var propExpr=this.buildPropertyExpr(prop,expr);return this.returnDotExprForNestedProperty(prop.of,propName,++i,propExpr)},},{name:"getPropertyClassInfo",args:[{name:"prop",}],},{name:"buildPropertyExpr",args:[{name:"prop",},{name:"expr",}],code:function(prop,expr){if(foam.core.Reference.isInstance(prop))prop=foam.mlang.Expressions.create().REF(prop);return!expr?prop:foam.mlang.Expressions.create().DOT(expr,prop)},},{name:"isPropertyAReference",args:[{name:"prop",}],},{name:"getFinderMethod",args:[{name:"prop",}],}]});
foam.CLASS({package:"foam.nanos.column",name:"ExpressionForArrayOfNestedPropertiesBuilder",methods:[{name:"returnArrayOfExprForArrayOfProperties",type:"foam.mlang.Expr[]",args:[{name:"x",type:"Context"},{name:"objClass",class:"Object",},{name:"propNames",class:"StringArray"}],code:function(objClass,propNames){var exprArray=[];for(var propName of propNames){var expr=foam.nanos.column.NestedPropertiesExpression.create({objClass:objClass,nestedProperty:propName});if(expr)exprArray.push(expr)}return exprArray},},{name:"buildProjectionForPropertyNamesArray",type:"Any",args:[{name:"x",type:"Context"},{name:"of",class:"Class",},{name:"propNames",class:"StringArray"}],code:function(of,propNames,useProjection){return foam.mlang.sink.Projection.create({exprs:this.returnArrayOfExprForArrayOfProperties(of,propNames),useProjection:useProjection})},}]});
foam.CLASS({package:"foam.nanos.column",name:"TableColumnOutputter",methods:[{name:"returnStringValueForProperty",type:"String",code:async function(x,prop,val,unitPropName,addUnitPropValueToStr){if(val==0||val){if(foam.Array.isInstance(val)){var stringArr=[];for(var i=0;i<val.length;i++){stringArr.push(await this.valueToString(val[i]))}return stringArr.join(" ")}if(foam.core.UnitValue.isInstance(prop)){if(addUnitPropValueToStr){if(unitPropName){if(prop.unitPropValueToString){return await prop.unitPropValueToString(x,val,unitPropName)}return unitPropName+" "+(val/100).toString()}}return(val/100).toString()}if(foam.core.DateTime.isInstance(prop)){return val.toString()}if(foam.core.Date.isInstance(prop)){return val.toLocaleDateString(foam.locale)}if(foam.core.Time.isInstance(prop)){return val.toString().substring(0,8)}return await this.valueToString(val)}return""}},async function valueToString(val){if(val.toSummary){if(val.toSummary()instanceof Promise)return await val.toSummary();return val.toSummary()}return val.toString()},{name:"arrayOfValuesToArrayOfStrings",code:async function(x,props,values,lengthOfPrimaryPropsRequested,addUnitPropValueToStr){var stringValues=[];for(var value of values){var stringArrayForValue=[];for(var i=0;i<lengthOfPrimaryPropsRequested;i++){if(foam.core.UnitValue.isInstance(props[i])){var indexOfUnitProp=props.findIndex(p=>p.name===props[i].unitPropName);if(indexOfUnitProp!==-1){stringArrayForValue.push(await this.returnStringValueForProperty(x,props[i],value[i],value[indexOfUnitProp],addUnitPropValueToStr));continue}}stringArrayForValue.push(await this.returnStringValueForProperty(x,props[i],value[i]))}stringValues.push(stringArrayForValue)}return stringValues}},async function objToArrayOfStringValues(x,of,propNames,obj){var columnConfig=x.columnConfigToPropertyConverter;var values=[];for(var propName of propNames){values.push(await columnConfig.returnValueForPropertyName(x,of,propName,obj))}return values},{name:"objectToTable",code:async function(x,of,propNames,obj,lengthOfPrimaryPropsRequested){var values=await this.objToArrayOfStringValues(x,of,propNames,obj);return this.returnTable(x,of,propNames,values,lengthOfPrimaryPropsRequested)}},{name:"returnTable",code:async function(x,of,propNames,values,lengthOfPrimaryPropsRequested,addUnitPropValueToStr){var columnConfig=x.columnConfigToPropertyConverter;var props=columnConfig.returnProperties(of,propNames);var table=[this.getColumnHeaders(x,of,propNames.slice(0,lengthOfPrimaryPropsRequested))];var values=await this.arrayOfValuesToArrayOfStrings(x,props,values,lengthOfPrimaryPropsRequested,addUnitPropValueToStr);table=table.concat(values);return table}},{name:"getAllPropertyNames",type:"StringArray",code:function(cls){var props=cls.getAxiomsByClass(foam.core.Property);var propNames=[];for(var i=0;i<props.length;i++){propNames.push(props[i].name)}return propNames}},{name:"getColumnHeaders",type:"String",code:function(x,of,arrOfPropNames){var columnConfig=x.columnConfigToPropertyConverter;var columnHeaders=[];for(var propName of arrOfPropNames){columnHeaders.push(columnConfig.returnColumnHeader(of,propName).colPath.join("/"))}return columnHeaders}},{name:"returnTableForMetadata",args:[{name:"x",type:"Context"},{name:"metadata",type:"foam.nanos.export.GoogleSheetsPropertyMetadata[]"},{name:"arrOfObjectValues",}],},{name:"returnStringValueForMetadata",type:"Object",args:[{name:"x",type:"Context"},{name:"metadata",type:"foam.nanos.export.GoogleSheetsPropertyMetadata"},{name:"obj",},{name:"unitPropValue",type:"String"}],}]});
foam.CLASS({package:"foam.i18n",name:"XLIFFTranslationValue",properties:[{class:"String",name:"id"},{class:"String",name:"source",},{class:"String",name:"target",},{class:"String",name:"note",}]});
foam.CLASS({package:"foam.i18n",name:"Locale",ids:["locale","variant","source"],implements:["foam.nanos.auth.LastModifiedAware","foam.nanos.auth.LastModifiedByAware"],properties:[{class:"String",name:"locale",factory:function(){foam.locale=foam.locale||"en"}},{class:"String",name:"variant",},{class:"String",name:"source",},{class:"String",name:"target",},{class:"String",name:"note",},{class:"DateTime",name:"lastModified",createVisibility:"HIDDEN",updateVisibility:"RO"},{class:"Reference",of:"foam.nanos.auth.User",name:"lastModifiedBy",createVisibility:"HIDDEN",updateVisibility:"RO",tableCellFormatter:function(value,obj){this.__subSubContext__.userDAO.find(value).then(function(user){if(user){this.add(user.legalName)}}.bind(this))}},{class:"Reference",of:"foam.nanos.auth.User",name:"lastModifiedByAgent",createVisibility:"HIDDEN",updateVisibility:"RO",tableCellFormatter:function(value,obj){this.__subSubContext__.userDAO.find(value).then(function(user){if(user){this.add(user.legalName)}}.bind(this))}}]});foam.INTERFACE({package:"foam.i18n",name:"TranslationService",proxy:true,skeleton:true,methods:[{name:"getTranslations",args:["String locale"],async:true,},{name:"getTranslation",async:true,args:[{name:"locale",type:"String"},{name:"source",type:"String"},{name:"defaultText",type:"String",}],type:"String"}]});
foam.CLASS({package:"foam.i18n",name:"ClientCacheTranslationService",implements:["foam.i18n.TranslationService","foam.mlang.Expressions"],imports:["localeDAO"],requires:["foam.core.Latch","foam.dao.MDAO","foam.i18n.Locale"],topics:["translation"],properties:[{name:"initLatch",factory:function(){return this.Latch.create()}},{name:"locale",factory:function(){return(foam.locale||"en").substring(0,2)}},{name:"variant",factory:function(){return(foam.locale||"").substring(3)}},{class:"Map",name:"localeEntries",factory:function(){return{}}}],methods:[function init(){this.loadLanguageLocales().then(()=>{if(this.hasVariant()){this.loadVariantLocales().then(()=>this.initLatch.resolve())}else{this.initLatch.resolve()}})},function maybeReload(){var originalLocale=this.locale;if(this.variant)originalLocale=originalLocale+"-"+this.variant;if(foam.locale!=originalLocale){this.locale=this.variant=undefined;this.initLatch=this.Latch.create();this.localeEntries={};this.init()}return this.initLatch},function loadLanguageLocales(){return this.localeDAO.where(this.AND(this.EQ(this.Locale.LOCALE,this.locale),this.EQ(this.Locale.VARIANT,""))).select(this.addLocale.bind(this))},function loadVariantLocales(){return this.localeDAO.where(this.AND(this.EQ(this.Locale.LOCALE,this.locale),this.EQ(this.Locale.VARIANT,this.variant))).select(this.addLocale.bind(this))},function addLocale(l){this.localeEntries[l.source]=l.target},function hasVariant(){return!!this.variant},{name:"getTranslation",args:["String locale","String source","String defaultText"],type:"String",code:function(locale,source,defaultText){var txt=this.localeEntries[source];this.translation.pub(locale,source,txt,defaultText);return txt||defaultText}}]});
foam.CLASS({package:"foam.i18n",name:"TranslationConsole",extends:"foam.u2.Controller",implements:["foam.mlang.Expressions"],static:[function OPEN(){var w=globalThis.window.open("","Translation Console","width=800,height=800,scrollbars=no",true);document.body.addEventListener("beforeunload",()=>w.close());w.document.body.innerText="";w.document.head.innerHTML="<title>Translation Console</title>";w.document.$UID=foam.next$UID();var window=foam.core.Window.create({window:w},ctrl);var v=this.create({},window);v.write(window.document);foam.core.I18NString.GETTER__=function(proto,prop,obj,key){if(obj.sourceCls_){var source=obj.sourceCls_.id+"."+obj.name+"."+prop.name;var translation=v.translationService.getTranslation(v.locale,source,"");v.onTranslation(null,null,foam.locale,source,translation,obj.instance_[key]);console.log("**************************** ",source,obj.instance_[key])}return obj.instance_[key]}}],css:`
* {
font-family: Roboto, sans-serif;
color: #555;
}
body {
font-family: Roboto;
background: rgb(238, 238, 238);
overflow: none;
}
button { padding: 6px; background: /*%WHITE%*/ !important; }
button span { background:/*%WHITE%*/ #ffffff; }
.foam-u2-ActionView-medium { height: 34px !important; background: pink; }
.foam-u2-view-TableView-th-editColumns { display: none; }
.foam-u2-view-TableView-td[name="contextMenuCell"] { display: none; }
.foam-u2-view-ScrollTableView { height: auto !important; }
`,classes:[{name:"Row",requires:["foam.i18n.Locale"],imports:["locale","localeDAO","translationService"],tableColumns:["source","defaultText","text","update"],ids:["source"],properties:[{class:"String",name:"source",tableWidth:380},{class:"String",name:"defaultText",displayWidth:300},{class:"String",name:"text",tableCellFormatter:function(val,obj,prop){this.startContext({data:obj}).add(prop).endContext()},displayWidth:50,tableWidth:400}],actions:[function update(){var l=this.Locale.create({locale:this.locale.substring(0,2),variant:this.locale.substring(3),source:this.source,target:this.text});this.localeDAO.put(l);this.translationService.localeEntries[this.source]=this.text}]}],imports:["translationService"],exports:["locale"],requires:["foam.dao.MDAO","foam.u2.borders.CardBorder"],properties:[{class:"String",name:"search",view:{class:"foam.u2.TextField",type:"search",placeholder:"Search",onKey:true}},{name:"dao",factory:function(){return this.MDAO.create({of:this.Row})}},{name:"filteredDAO",expression:function(search,dao){search=search.trim();if(search=="")return dao;return dao.where(this.OR(this.CONTAINS_IC(this.Row.SOURCE,search),this.CONTAINS_IC(this.Row.DEFAULT_TEXT,search),this.CONTAINS_IC(this.Row.TEXT,search)))},view:"foam.u2.view.ScrollTableView"},{class:"String",name:"locale",factory:function(){return foam.locale.substring(0,2)}}],methods:[function init(){this.SUPER();this.translationService.translation.sub(this.onTranslation)},function render(){this.addClass(this.myClass()).start(this.CardBorder).style({height:"32px"}).start("span").style({"padding-top":"5px",display:"inline-block","font-size":"larger"}).add("Translation Console").end().start("div").style({float:"right"}).add(this.SEARCH,"  Locale: ").tag({class:"foam.u2.TextField",data$:this.locale$,size:10}).add(" ",this.CLEAR).end().end().start(this.CardBorder,{},this.content$).style({"overflow-y":"auto"}).style({"margin-top":"10px",height:"90%"}).add(this.FILTERED_DAO).end()}],actions:[function clear(){this.dao.removeAll()}],listeners:[function onTranslation(_,__,locale,source,txt,defaultText){this.dao.put(this.Row.create({source:source,text:txt,defaultText:defaultText}))}]});
foam.CLASS({package:"foam.i18n",name:"TranslationConsoleMenu",extends:"foam.u2.Element",css:`
^ { padding: 200px; }
`,requires:["foam.i18n.TranslationConsole"],methods:[function render(){foam.i18n.TranslationConsole.OPEN();this.start().addClass(this.myClass()).add("The Translation Console has opened in a new tab.").end()}]});
foam.CLASS({package:"foam.i18n",name:"ClientTranslationService",implements:["foam.i18n.TranslationService"],properties:[{class:"Stub",of:"foam.i18n.TranslationService",name:"delegate"}]});
foam.CLASS({package:"foam.i18n",name:"InlineLocaleEditor",extends:"foam.u2.tag.Input",css:`
^ { border: 1px solid red; padding: 4px; }
`,requires:["foam.i18n.Locale"],imports:["localeDAO","translationService"],properties:[{name:"source"},{name:"defaultText"},{name:"mode",value:foam.u2.DisplayMode.RW}],methods:[function render(){this.SUPER();this.addClass();this.data$.sub(this.onDataUpdate)}],listeners:[function onDataUpdate(){console.log("**********",this.source,this.defaultText,this.data);var l=this.Locale.create({locale:foam.lang,variant:foam.variant,source:this.source,target:this.data});this.localeDAO.put(l);this.translationService.localeEntries[this.source]=this.data}]});
foam.CLASS({package:"foam.u2.layout",name:"MDDAOUpdateController",extends:"foam.u2.View",topics:["finished","throwError"],axioms:[foam.pattern.Faceted.create()],requires:["foam.u2.ControllerMode","foam.u2.ToolbarAction","foam.u2.layout.MDToolbarView","foam.log.LogLevel"],imports:["stack","ctrl"],exports:["controllerMode"],properties:[{class:"FObjectProperty",name:"data"},{name:"controllerMode",factory:function(){return this.ControllerMode.CREATE}},{class:"foam.u2.ViewSpec",name:"detailView",expression:function(){return foam.u2.detail.MDDetailView}},{name:"title",expression:function(data){return data.model_.label}},{name:"dao"},{name:"obj",factory:function(){var self=this;this.dao.find(this.data).then(function(obj){self.obj=obj.clone()});return null}}],actions:[{name:"save",iconFontName:"check",label:"",code:function(){if(this.data.errors_){this.ctrl.notify("Some fields are not valid","",this.LogLevel.ERROR,true);return}var self=this;this.dao.put(this.data.clone()).then(function(){this.ctrl.notify("Successfully Updated","",self.LogLevel.INFO,true);self.stack.back()},function(e){self.exception=e;self.throwError.pub();this.ctrl.notify(e.message,"",self.LogLevel.ERROR,true)})}},{name:"back",iconFontName:"arrow_back",label:"",code:function(x){x.stack.back()}},{name:"delete",code:function(){var self=this;this.dao.remove(this.data).then(function(){self.finished.pub()},function(e){self.exception=e;self.throwError.pub()})}}],methods:[function render(){var self=this;this.SUPER();this.addClass().startContext({data:this}).tag({class:"foam.u2.layout.MDToolbarView",title:self.title,leftAction:self.BACK,rightAction:self.SAVE}).endContext();this.start().addClass("main-container").tag(this.detailView,{data:this.data}).add(this.DELETE).end()}],css:`
^ .foam-u2-ActionView-delete {
width: -webkit-fill-available;
height: 6rem;
color: #2e2379;
font-weight: 400;
margin: 2rem 4rem;
font-size: 2.5rem;
bottom: 0;
background-color: unset;
border: 2px solid red!important;
border-radius: 73px;
}
^ .main-container {
overflow: auto;
height: 90%;
margin-top: 15px;
}
`});
foam.CLASS({package:"foam.u2.layout",name:"MDStackView",extends:"foam.u2.View",requires:["foam.u2.stack.Stack"],exports:["data as stack"],properties:[{name:"data",factory:function(){return this.Stack.create()}},{class:"Boolean",name:"showActions",value:true},{name:"curPos",value:0},"curView"],css:"%CUSTOMCSS%",methods:[function init(){this.curView$.sub(this.onViewUpdate);var self=this;this.addClass();this.start("div").addClass("primary-stack").add(this.slot(function(data){var s=data.top;if(!s)return this.E("span");var view=s[0];var parent=s[1];var X;if(!parent){X=this.__subSubContext__}else{if(parent.isContext){X=parent}else if(parent.__subContext__){X=parent.__subContext__}else{X=this.__subSubContext__.createSubContext(parent)}}var e=foam.u2.ViewSpec.createView(view,null,this,X);this.children[0].removeClass("slide-in");this.children[0].style({left:data.pos>self.curPos?"100%":"-100%"});self.curPos=data.pos;self.curView=e;return self.curView},this.data$,this.data$.dot("top"))).end()}],listeners:[{name:"onViewUpdate",isMerged:true,mergeDelay:1,code:function(){this.children[0].addClass("slide-in")}}],css:`
^ .slide-in {
left: 0 !important;
transition: left 300ms ease;
}
^ .primary-stack {
position: absolute;
width: 100%;
height: 100%;
}
`});
foam.CLASS({package:"foam.u2.layout",name:"MDDAOCreateController",extends:"foam.u2.View",topics:["finished","throwError"],axioms:[foam.pattern.Faceted.create()],requires:["foam.log.LogLevel","foam.u2.ControllerMode"],imports:["stack","ctrl"],exports:["controllerMode"],properties:[{class:"FObjectProperty",name:"data"},{name:"controllerMode",factory:function(){return this.ControllerMode.CREATE}},{class:"foam.u2.ViewSpec",name:"detailView",expression:function(){return foam.u2.detail.MDDetailView}},{name:"title",expression:function(data){return data.model_.label}},{name:"dao"},{name:"obj",factory:function(){return this.dao.of.create({},null)}}],actions:[{name:"save",iconFontName:"check",label:"",code:function(){if(this.data.errors_){this.ctrl.notify("Some fields are not valid","",this.LogLevel.ERROR,true);return}var self=this;this.dao.put(this.obj.clone()).then(function(){this.ctrl.notify("Successfully Created","",self.LogLevel.INFO,true);self.stack.back()},function(e){self.exception=e;self.throwError.pub();this.ctrl.notify(e.message,"",self.LogLevel.ERROR,true)})}},{name:"back",iconFontName:"arrow_back",label:"",code:function(x){x.stack.back()}}],methods:[function render(){var self=this;this.SUPER();this.startContext({data:this}).tag({class:"foam.u2.layout.MDToolbarView",title:self.title,leftAction:self.BACK,rightAction:self.SAVE}).endContext();this.dao.inX(this.__subContext__).find(this.data).then(d=>{if(d)self.data=d;this.addClass(this.myClass()).add(self.slot(function(data,detailView){return self.E().start().start(detailView,{data:data}).end().end()}))})}],css:`
^ {
padding-top: 20%;
overflow: auto;
height: 90%;
}
`});
foam.CLASS({package:"foam.u2.property",name:"MDInput",extends:"foam.u2.View",imports:["warn"],properties:[{name:"data",preSet:function(o,d){var f=!d||typeof d==="string"||typeof d==="number"||typeof d==="boolean"||foam.Date.isInstance(d);if(!f){this.warn("Set Input data to non-primitive:"+d);return o}return d}},{class:"Boolean",name:"onKey",attribute:true},{class:"Int",name:"size"},{class:"Int",name:"maxLength",attribute:true},"type",{name:"placeholder",factory:function(){return this.placeholder||this.prop?this.prop.placeholder:""}},{name:"label"},{type:"Boolean",name:"focused_",value:false},"isInvalid","prop",{name:"choices",factory:function(){return[]},adapt:function(old,nu){if(typeof nu==="object"&&!Array.isArray(nu)){var out=[];for(var key in nu){if(nu.hasOwnProperty(key))out.push([key,nu[key]])}if(this.dynamicSize){this.size=Math.min(out.length,this.maxSize)}return out}nu=foam.Array.clone(nu);for(var i=0;i<nu.length;i++){if(!Array.isArray(nu[i])){nu[i]=[nu[i],nu[i]]}}if(this.dynamicSize)this.size=Math.min(nu.length,this.maxSize);return nu}}],methods:[function render(){this.SUPER();this.addClass();var self=this;this.start("label").addClass("label").addClass(this.slot(function(data,focused){return typeof data!="undefined"&&data!==""||focused||this.placeholder!==""?"label-up":""},this.data$,this.focused_$)).add(this.label$).end().add(this.inputE());if(this.prop){var errorSlot=this.prop.validateObj&&this.prop.validationTextVisible?this.__context__.data.slot(this.prop.validateObj):foam.core.ConstantSlot.create({value:null});this.start().addClass("validation-error").addClass(this.slot(function(isInvalid){return isInvalid?"error-msg":""},this.isInvalid$)).add(errorSlot.map(s=>{self.isInvalid=s!==null&&s!=="";return self.E().add(s)})).end()}},function inputE(){var self=this;var input=this.start("input").attrs({type:this.type,onKey:this.onKey,value:this.data$,size:this.size,placeholder:this.placeholder}).on("focus",function(){self.focused_=true}).on("blur",function(){self.focused_=false}).on("change",function(e){self.data=e.target.value});if(this.choices&&this.choices.length){input.setAttribute("list",this.id+"-datalist");this.start("datalist").call(function(){this.id=self.id+"-datalist"}).forEach(this.choices,function(c){var key=c[0];var label=c[1];this.start("option").attrs({value:key}).add(label).end()}).end()}input.attrSlot(null,this.onKey?"input":null).linkFrom(this.data$);input.end()},function initCls(){this.addClass()},function link(){this.attrSlot(null,this.onKey?"input":null).linkFrom(this.data$)},function fromProperty(p){this.SUPER(p);this.label=this.label||p.label;this.prop=p;if(!this.hasOwnProperty("onKey")&&p.validateObj)this.onKey=true},function updateMode_(mode){this.setAttribute("readonly",mode===foam.u2.DisplayMode.RO);this.setAttribute("disabled",mode===foam.u2.DisplayMode.DISABLED);this.show(mode!==foam.u2.DisplayMode.HIDDEN)}],css:`
^ {
display: flex;
flex-direction: column;
height: 5rem;
position: relative;
background-color: #e7eaec;
padding-left: 1rem;
padding-top: 1rem;
padding-right: 1rem;
border-radius: 10px;
}
^ .label {
transition: font-size 0.5s, top 0.5s;
top: 20%;
position: relative;
font-size: 2rem;
font-weight: 500;
color: #5a5a5a
}
^ .label-up {
font-size: 1.5rem;
font-weight: unset;
top: 0;
}
^ .input-container {
background-color: #e7eaec;
}
^ input {
width: 92%;
height: 3rem;
outline: none;
background: transparent;
border-bottom: 2px solid #888;
border-left: none;
border-top: none;
border-right: none;
font-size: 2rem;
resize: none;
bottom: 0;
position: absolute;
}
^ input:focus {
border-bottom: 2px solid #4285f4;
}
^ .validation-error {
font-size: 0rem;
position: absolute;
top: 100%;
color: #db4437;
opacity: 0;
position: absolute;
bottom: 0;
transition: opacity .5s;
}
^ .error-msg {
font-size: 1.5rem;
opacity: 1;
//      transition: opacity 3s;
}
`});
foam.CLASS({package:"foam.u2.property",name:"MDTextField",extends:"foam.u2.property.MDInput",imports:["setTimeout"],properties:[{name:"showLabel",attribute:true,factory:function(){return!this.inline}},{type:"Boolean",name:"inline",value:false},{type:"Boolean",name:"onKey",value:true,},{type:"Boolean",name:"focused_",value:false,postSet:function(old,nu){if(!old&&nu&&this.autocompleter){this.autocompleteView_=this.autocompleteView({rowView:this.autocompleteRowView||undefined,dao:this.autocompleter.filteredDAO$Proxy},this.Y);this.autocompleteView_.data$.addListener(function(_,__,old,nu){if(nu){var str=this.autocompleter.objToString(nu);this.data=str;this.autocompleter.partial=str}}.bind(this));this.autocompletePopup_=this.AutocompletePopup.create({inline:this.inline},this.Y);this.autocompletePopup_.add(this.autocompleteView_);this.add(this.autocompletePopup_)}else if(old&&!nu&&this.autocompleteView_){this.setTimeout(function(){if(this.autocompleteView_){this.autocompleteView_.dao=undefined;this.autocompleteView_=null}if(this.autocompletePopup_){this.autocompletePopup_.remove();this.autocompletePopup_=null}}.bind(this),200)}}},{name:"autocompleter",},{type:"ViewFactory",name:"autocompleteView",defaultValue:"foam.u2.search.AutocompleteView"},{type:"ViewFactory",name:"autocompleteRowView",},{name:"autocompleteView_",},{name:"autocompletePopup_",},"isInvalid"],classes:[{name:"AutocompletePopup",extends:"foam.u2.Element",properties:["inline"],methods:[function render(){this.addClass().enableClass(this.myClass("inline"),this.inline$)}]}]});
foam.CLASS({package:"foam.u2.property",name:"MDCalendar",extends:"foam.u2.View",imports:["MONTH_NAMES","document"],properties:[{name:"data",adapt:function(old,nu){if(typeof nu==="string")return new Date(nu);return nu}},{name:"day",expression:function(){return this.data&&this.data.getDate()}},{name:"month",expression:function(){return this.data.getMonth()}},{name:"year",expression:function(){return this.data.getFullYear()}},{name:"hour",expression:function(){return this.data.getHours()}},{name:"minute",expression:function(){return this.data.getMinutes()}},{name:"preferredWidth",defaultValue:300}],methods:[function isToday(day){var today=new Date;return this.month===today.getMonth()&&this.year===today.getFullYear()&&day===today.getDate()},function isSelected(day){if(!this.data)return false;return this.month===this.data.getMonth()&&this.year===this.data.getFullYear()&&day===this.data.getDate()},function render(){this.addClass();this.start().addClass(this.myClass("heading")).start("span").addClass(this.myClass("heading-month")).add(this.MONTH_NAMES[this.month]+" "+this.year).end().end();var table=this.start().addClass(this.myClass("body")).start("table");table.addClass(this.myClass("table"));table.start("tr").start("th").add("S").end().start("th").add("M").end().start("th").add("T").end().start("th").add("W").end().start("th").add("T").end().start("th").add("F").end().start("th").add("S").end().end();var firstDay=new Date(this.year,this.month,1).getDay();for(var row=0;row<6;row++){var tr=table.start("tr");for(var col=0;col<7;col++){if(row===0&&col<firstDay){tr.start("td").end()}else{var day=row*7+(col-firstDay)+1;var testDate=new Date(this.year,this.month,day,this.hour,this.minute);if(testDate.getMonth()!=this.month){tr.start("td").end()}else{tr.start("td").addClass("foam-u2-md-toolbar-colors").addClass(this.slot(function(day){return this.isSelected(day)?this.myClass("selected"):this.isToday(day)?this.myClass("today"):""}.bind(this,day),this.data$)).add(day).end()}}}tr.end()}table.on("click",this.onClick);table.end().end()}],listeners:[{name:"onClick",code:function(e){var element=e.target;if(element&&element.tagName==="TD"){var newDay=element.innerText;this.data=new Date(this.year,this.month,newDay,this.hour,this.minute)}}}],css:`
^heading {
align-items: center;
display: flex;
font-size: 2rem;
height: 48px;
justify-content: center;
}
^body {
display: flex;
justify-content: center;
}
^table {
font-size: 4rem;
}
^table th {
color: #999;
font-weight: normal;
text-align: center;
}
^table td {
height: 40px;
text-align: center;
width: 38px;
padding: 0.5rem;
}
^ td^selected {
border-radius: 50%;
}
^ td:not(^selected) {
background-color: inherit;
color: inherit;
}
^today {
color: #4285f4;
font-weight: bolder;
}
`});
foam.CLASS({package:"foam.u2.property",name:"MDDateField",extends:"foam.u2.View",requires:["foam.u2.EasyDialog","foam.u2.property.MDDatePicker"],properties:[["nodeName","div"],{name:"data",postSet:function(old,nu){this.realData=nu}},{type:"Date",name:"realData",factory:function(){return new Date}},{name:"showLabel",attribute:true,factory:function(){return!this.inline}},{type:"Boolean",name:"inline",attribute:true},{name:"label",attribute:true},{name:"placeholder",attribute:true,factory:function(){return this.label}},{type:"Function",name:"dateFormatter",value:function(date){return date.toLocaleDateString(foam.locale)}},"dialog_","datePicker_"],methods:[function render(){var self=this;this.addClass();if(this.showLabel){this.start("label").addClass("label").addClass(this.slot(function(data,focused){return typeof data==="undefined"||data===""||focused?"label-offset":""},this.realData$,this.focused$)).add(this.label$).end()}else{this.addClass(this.myClass("no-label"))}this.inputE();if(this.showValidation){this.enableClass(this.myClass("invalid"),this.validationError_$);this.start().addClass(this.myClass("validation-error")).add(this.validationError_$).end()}},function inputE(){var self=this;var input=this.start("span").addClass(this.myClass("inner")).on("click",this.onDateClick);input.add(this.slot(function(data,placeholder,showLabel){return data?this.dateFormatter(data):placeholder&&!showLabel?placeholder:this.Entity.create({name:"nbsp"})}.bind(this),this.realData$,this.placeholder$,this.showLabel$));input.end()},function fromProperty(prop){this.label=this.label||prop.label;return this.SUPER(prop)}],listeners:[function onDateClick(){var active=this.document.activeElement;if(active)active.blur();this.datePicker_=this.MDDatePicker.create({data$:this.realData$});this.dialog_=this.EasyDialog.create({title:this.datePicker_.titleE,body:this.datePicker_.bodyE,padding:false,onConfirm:function(){this.data=this.datePicker_.softData;this.datePicker_=null;this.dialog_=null}.bind(this)});this.add(this.dialog_)}],css:`
^ {
align-items: stretch;
display: inline-grid;
flex-direction: column;
padding: 2rem 0 0 0;
position: relative;
z-index: 1;
width: 100%;
}
^label {
color: #999;
flex-grow: 1;
font-size: inherit;
font-weight: 500;
transition: font-size 0.5s, top 0.5s;
z-index: 0;
}
^no-label {
padding-top: 8px;
}
^inner {
background: transparent;
border-bottom: 1px solid #e0e0e0;
border-left: none;
border-top: none;
border-right: none;
color: #444;
flex-grow: 1;
font-family: inherit;
font-size: inherit;
margin-bottom: -8px;
padding: 1rem 0 0 0;
resize: none;
z-index: 1;
}
^invalid ^inner {
border-bottom: 2px solid #db4437;
margin-bottom: 4px;
}
^validation-error {
color: #db4437;
}
`});
foam.CLASS({package:"foam.u2.property",name:"MDDatePicker",extends:"foam.u2.View",requires:["foam.input.touch.GestureTarget","foam.u2.property.MDCalendar"],imports:["popup"],exports:["MONTH_NAMES"],constants:{DAY_NAMES:["Sun","Mon","Tue","Wed","Thu","Fri","Sat"],MONTH_NAMES:["January","February","March","April","May","June","July","August","September","October","November","December"]},properties:[{name:"data",postSet:function(old,nu){this.softData=nu},factory:function(){return new Date}},{name:"softData",factory:function(){return new Date},adapt:function(old,nu){if(typeof nu==="string")return new Date(nu);if(!nu)return new Date;return nu},postSet:function(old,nu){this.year=nu.getFullYear();this.month=nu.getMonth();this.date=nu.getDate();this.day=nu.getDay()}},{name:"years",factory:function(){var years=[];for(var i=1900;i<=2100;i++){years.push(i)}return years}},{name:"year",},{name:"month",},{name:"date",},{name:"day",},{name:"viewYear",factory:function(){return this.year},postSet:function(old,nu){if(old!==nu)this.reconstructCalendars()}},{name:"viewMonth",factory:function(){return this.month},postSet:function(old,nu){if(old!==nu)this.reconstructCalendars()}},{name:"leftYear",getter:function(){return this.leftMonth===11?this.viewYear-1:this.viewYear}},{name:"leftMonth",getter:function(){return Math.max(0,this.viewMonth-1)}},{name:"rightYear",getter:function(){return this.rightMonth===0?this.viewYear+1:this.viewYear}},{name:"rightMonth",defaultValueFn:function(){var m=this.viewMonth+1;if(m>11)m=0;return m}},{name:"sliderE"},{name:"innerE"},{name:"width",defaultValue:300},{name:"xPos",hidden:true,transient:true,postSet:function(old,nu){this.adjustX(nu)}},{name:"swipeGesture",factory:function(){return this.GestureTarget.create({containerID:this.bodyE.id,handler:this,gesture:"horizontalScroll"})}},{name:"calendarViews_",factory:function(){return[]}},{type:"Boolean",name:"showYears_",defaultValue:false},{name:"titleE",factory:function(){var header=this.E().addClass(this.myClass("header")).addClass("foam-u2-md-toolbar-colors");header.start().addClass(this.myClass("header-year")).enableClass(this.myClass("selected"),this.showYears_$).add(this.year$).end();header.start().addClass(this.myClass("header-date")).enableClass(this.myClass("selected"),this.showYears_$,true).add(this.slot(function(day,month,date){return this.DAY_NAMES[day]+", "+this.MONTH_NAMES[month]+" "+date}.bind(this),this.day$,this.month$,this.date$)).end();header.on("click",this.headerClick);return header}},{name:"bodyE",factory:function(){var body=this.E().addClass(this.myClass("body"));body.startContext({data:this}).start("span").addClass(this.myClass("switcher")).addClass(this.myClass("switcher-left")).add(this.LEFT).end();body.start("span").addClass(this.myClass("switcher")).addClass(this.myClass("switcher-right")).add(this.RIGHT).end();this.sliderE=body.start().addClass(this.myClass("slider")).style({transform:this.slot(function(x){return"translate3d(-"+x+"px, 0, 0)"},this.xPos$)});this.innerE=this.sliderE.start().addClass(this.myClass("slider-inner"));this.innerE.end();this.sliderE.end();body.enableClass(this.myClass("hidden"),this.showYears_$);var years=this.E().addClass(this.myClass("years"));for(var i=1900;i<=2100;i++){years.start("span").setID(this.id+"-year-"+i).addClass(this.myClass("years-year")).add(""+i).enableClass(this.myClass("selected"),this.slot(function(index,viewYear){return index===viewYear}.bind(this,i),this.viewYear$)).on("click",this.pickYear.bind(this,i)).end()}years.enableClass(this.myClass("hidden"),this.showYears_$,true);return[body,years]}}],listeners:[{name:"adjustX",isFramed:true,code:function(){this.rawAdjustX(this.xPos)}},{name:"horizontalScrollMove",code:function(dx,tx){var x=this.width-tx;if(x<0)x=0;if(x>2*this.width)x=2*this.width;this.xPos=x}},{name:"horizontalScrollEnd",code:function(dx,tx,x){var adj=0;if(Math.abs(tx)>this.width/3){if(tx>0){adj=-1}else{adj=1}}this.snapToView(adj)}},{name:"reconstructCalendars",isFramed:true,code:function(){var newCals=[this.MDCalendar.create({data$:this.softData$,year:this.leftYear,month:this.leftMonth}),this.MDCalendar.create({data$:this.softData$,year:this.viewYear,month:this.viewMonth}),this.MDCalendar.create({data$:this.softData$,year:this.rightYear,month:this.rightMonth})];this.xPos=this.width;this.rawAdjustX(this.width);for(i=0;i<3;i++){if(this.calendarViews_[i]){this.innerE.replaceChild(newCals[i],this.calendarViews_[i])}else{this.innerE.add(newCals[i])}this.calendarViews_[i]=newCals[i]}}},{name:"headerClick",isFramed:true,code:function(){this.showYears_=!this.showYears_;if(this.showYears_)this.scrollToYear()}},{name:"scrollToYear",isFramed:true,code:function(){var targetYear=Math.max(1900,this.viewYear-3);var e=this.getElementById(this.id+"-year-"+targetYear);if(e)e.scrollIntoView()}},{name:"pickYear",code:function(year){this.year=this.viewYear=year;this.softData=new Date(this.year,this.month,this.date,this.softData.getHours(),this.softData.getMinutes());this.showYears_=false}}],methods:[function snapToView(adj){var month=this.viewMonth;var year=this.viewYear;var targetX=this.width;if(adj<0){month--;if(month<0){month=11;year--}targetX=0}else if(adj>0){month++;if(month>11){month=0;year++}targetX=this.width*2}var time=300*(Math.abs(targetX-this.xPos)/this.width);var self=this;self.viewYear=year;self.viewMonth=month},function rawAdjustX(x){var str="translate3d(-"+x+"px, 0, 0)";this.sliderE.style({transform:str})}],actions:[{name:"cancel",label:"CANCEL",code:function(){this.popup.close()}},{name:"ok",label:"OK",code:function(){this.data=this.softData;this.popup.close()}},{name:"left",label:"<",code:function(){this.snapToView(-1)}},{name:"right",label:">",code:function(){this.snapToView(1)}}],css:`
^hidden {
display: none !important;
}
^header {
cursor: pointer;
font-size: 2.5rem;
padding: 12px 16px;
font-weight: 500;
}
^header div {
opacity: 0.8;
}
^header div^selected {
opacity: 1;
}
^header-year {
margin: 8px 0;
}
^header-date {
font-size: 2.4rem;
font-weight: bolder;
}
^body {
cursor: pointer;
font-size: 1.6rem;
height: 40rem;
width: 100%;
overflow: hidden;
position: relative;
-webkit-user-select: none;
-khtml-user-select: none;
-moz-user-select: none;
-ms-user-select: none;
user-select: none;
}
^slider {
position: absolute;
height: 100%;
top: 0;
width: 900px;
}
^slider-inner {
//      display: flex;
height: 100%;
position: relative;
width: 100%;
}
^switcher {
align-items: center;
display: flex;
height: 48px;
position: absolute;
z-index: 3;
}
^switcher-left {
left: 0;
}
^switcher-right {
right: 0;
}
^years {
align-items: center;
display: flex;
flex-direction: column;
height: 310px;
overflow-y: auto;
width: 300px;
}
^years-year {
flex-shrink: 0;
padding: 16px;
}
^years-year^selected {
color: #3e50b4;
font-size: 2.4rem;
font-weight: bold;
}
`});
foam.CLASS({package:"foam.u2.property",name:"MDSelect",extends:"foam.u2.view.ChoiceView",requires:["foam.u2.property.MDPopup"],properties:[{name:"placeholder",factory:function(){return"--"}},{name:"objToChoice",value:function(obj){return[obj.id,obj.toSummary()]}},"popup"],listeners:[{name:"onClick",isFramed:true,code:function(){if(this.mode===foam.u2.DisplayMode.RO)return;if(this.popup&&!this.popup.isHidden){this.popup.close();return}if(!this.popup||this.popup.isHidden){var self=this;this.popup=this.MDPopup.create({data:this.data$,choices$:this.choices$,index$:this.index$});this.popup.open(this.index,this.el_())}}}],methods:[function render(){if(this.data==null&&!this.index){this.index=0}this.onDAOUpdate();var self=this;this.addClass();this.start("label").addClass("label").addClass(this.slot(function(data){return typeof data!="undefined"&&data!==""?"label-up":""},this.data$)).add(this.label$).end();this.start("div").addClass("value").add(this.text$).end().start("div").addClass("down-arrow").addClass("material-icons").add(this.slot(function(isHidden){return self.popup&&!isHidden?"expand_less":"expand_more"},this.popup$.dot("isHidden"))).on("click",this.onClick).end();this.dao$proxy.on.sub(this.onDAOUpdate)},function fromProperty(prop){this.SUPER(prop);if(!this.dao){var dao=this.__context__[prop.targetDAOKey];this.dao=dao}}],css:`
^ {
flex-direction: column;
height: 5rem;
position: relative;
background-color: #e7eaec;
padding-left: 1rem;
padding-top: 1rem;
padding-right: 1rem;
border-radius: 10px;
}
^ .label {
transition: font-size 0.5s, top 0.5s;
top: 20%;
position: relative;
font-size: 2rem;
font-weight: 500;
color: #5a5a5a
}
^ .label-up {
font-size: 1.5rem;
font-weight: unset;
top: 0;
}
^ .value {
flex-grow: 1;
border-bottom: 2px solid #888;
font-size: 2rem;
position: absolute;
bottom: 0;
width: 92%;
}
^ .down-arrow {
font-weight: 800;
font-size: 3rem;
float: right;
top: 1rem;
position: relative;
}
`});
foam.CLASS({package:"foam.u2.property",name:"MDRichSelect",extends:"foam.u2.property.MDSelect",properties:[{name:"sections",postSet:function(old,nu){var self=this;nu.forEach(function(section){section.dao.select(obj=>{self.choices.push([obj.id,obj.toSummary()])})})}}]});
foam.CLASS({package:"foam.u2.property",name:"MDFloatView",extends:"foam.u2.property.MDInput",css:`
^:read-only:not(:disabled) {
border: none;
background: rgba(0,0,0,0);
}
`,properties:[["type","number"],{class:"Float",name:"data"},"precision","min","max",{class:"Float",name:"step",value:.01}],methods:[function render(){this.SUPER();this.addClass();if(this.min!=undefined)this.setAttribute("min",this.min);if(this.max!=undefined)this.setAttribute("max",this.max);if(this.step!=undefined)this.setAttribute("step",this.step)},function link(){if(foam.Undefined.isInstance(this.precision)){this.attrSlot(null,this.onKey?"input":null).relateFrom(this.data$,this.textToData.bind(this),this.dataToText.bind(this));return}var data=this.data$;var view=this.attrSlot(null,this.onKey?"input":null);var self=this;if(!foam.Undefined.isInstance(this.data))view.set(this.dataToText(this.data));this.on("blur",function(){view.set(self.dataToText(data.get()))});var preventFeedback=false;view.sub(function(){if(preventFeedback)return;preventFeedback=true;data.set(self.textToData(view.get()));preventFeedback=false});data.sub(function(){if(preventFeedback)return;preventFeedback=true;view.set(self.dataToText(data.get()));preventFeedback=false})},function fromProperty(p){this.SUPER(p);this.precision=p.precision;this.min=p.min;this.max=p.max},function formatNumber(val){if(!val)val=0;val=val.toFixed(this.precision);return val},function dataToText(val){return this.precision!==undefined?this.formatNumber(val):""+val},function textToData(text){return parseFloat(text)||0}]});
foam.CLASS({package:"foam.u2.property",name:"MDPopup",extends:"foam.u2.View",requires:["foam.u2.property.MenuElement"],imports:["window","setTimeout"],exports:["as popup"],properties:[["hMargin",8],["vMargin",8],["maxDisplayCount",5],["itemHeight",48],["itemWidth",100],["isHidden",true],["removeTimeout",0],["isClosing",false],"choices","data","index"],methods:[function open(index,sourceElement){var startingClientRect=sourceElement.getBoundingClientRect();var vp={height:this.window.innerHeight||this.document.documentElement.clientHeight,width:this.window.innerWidth||this.document.documentElement.clientWidth};this.itemHeight=startingClientRect.height;this.itemWidth=startingClientRect.width-16;var pxAbove=startingClientRect.top-this.vMargin-4;var pxBelow=vp.height-startingClientRect.bottom-this.vMargin-4;var slotsAbove=Math.floor(pxAbove>0?pxAbove/this.itemHeight:0);var slotsBelow=Math.floor(pxBelow>0?pxBelow/this.itemHeight:0);var itemsAbove=index;var itemsBelow=this.choices.length-index-1;var menuCount=Math.min(this.choices.length,this.maxDisplayCount,slotsAbove+slotsBelow+1);var halfMenuCount=Math.floor(menuCount/2);var itemForFirstSlot=0;var selectedOffset=0;if(menuCount<this.choices.length){if(itemsBelow>=halfMenuCount&&itemsAbove>=halfMenuCount&&slotsAbove>=halfMenuCount&&slotsBelow>=halfMenuCount){slotsAbove=halfMenuCount;slotsBelow=menuCount-slotsAbove-1;selectedOffset=0;itemForFirstSlot=index-slotsAbove}else if(itemsAbove<=slotsAbove&&itemsAbove<menuCount){slotsAbove=Math.min(slotsAbove,Math.max(itemsAbove,menuCount-slotsBelow-1));selectedOfset=itemsAbove-slotsAbove;itemForFirstSlot=0;slotsBelow=Math.min(slotsBelow,menuCount-slotsAbove-1)}else if(itemsBelow<=slotsBelow&&itemsBelow<menuCount){slotsBelow=Math.min(slotsBelow,Math.max(itemsBelow,menuCount-slotsAbove-1));selectedOffset=-(itemsBelow-slotsBelow);itemForFirstSlot=this.choices.length-menuCount;slotsAbove=Math.min(slotsAbove,menuCount-slotsBelow-1)}else{if(slotsAbove<halfMenuCount){slotsBelow=Math.min(slotsBelow,menuCount-slotsAbove-1)}else if(slotsBelow<halfMenuCount){slotsAbove=Math.min(slotsAbove,menuCount-slotsBelow-1)}else{slotsAbove=Math.min(slotsAbove,halfMenuCount);slotsBelow=Math.min(slotsBelow,menuCount-slotsAbove-1)}selectedOffset=0;itemForFirstSlot=index-slotsAbove}}else{if(itemsAbove>slotsAbove){selectedOffset=itemsAbove-slotsAbove;slotsBelow=menuCount-slotsAbove-1}else if(itemsBelow>slotsBelow){selectedOffset=-(itemsBelow-slotsBelow);slotsAbove=menuCount-slotsBelow-1}else{selectedOffset=0;slotsAbove=itemsAbove;slotsBelow=itemsBelow}itemForFirstSlot=0}menuCount=Math.min(menuCount,slotsAbove+slotsBelow+1);if(selectedOffset!==0){}var bodyRect=this.document.body.getBoundingClientRect();var finalRect={top:-bodyRect.top+startingClientRect.top-slotsAbove*this.itemHeight-2,bottom:-bodyRect.top+startingClientRect.top+startingClientRect.height+slotsBelow*this.itemHeight+2+this.vMargin*2,height:(menuCount+2)*this.itemHeight+this.vMargin*2,left:-bodyRect.left+startingClientRect.left-2-this.hMargin,right:-bodyRect.left+startingClientRect.left+startingClientRect.width+2,width:startingClientRect.width+this.hMargin*2+4};this.delegate_=this.MenuElement.create({choices:this.choices,data:this.data$,autoSetData:this.autoSetData,itemHeight:this.itemHeight,itemWidth:this.itemWidth,hMargin:this.hMargin,index$:this.index$});sourceElement.insertAdjacentHTML("beforeend",this.delegate_.outerHTML);this.delegate_.load();this.initializePosition(startingClientRect,finalRect);this.scrollToIndex(itemForFirstSlot);this.animateToExpanded()},function initializePosition(startingClientRect,finalRect){var vDiff=startingClientRect.top-finalRect.top+startingClientRect.height/2;var transformOrigin="0 "+vDiff+"px";this.delegate_.style({padding:"0px 0px "+this.vMargin*2+"px 0px",height:finalRect.height+"px",bottom:-finalRect.height-40+"px",width:"100%","z-index":10,transition:"all 0.5s ease-in-out",transform:"scaleY(0)"})},function animateToExpanded(){this.delegate_.style({transition:"transform cubic-bezier(0.0, 0.0, 0.2, 1) .1s",transform:"scaleY(1)","-webkit-transform":"scaleY(1)"});this.isHidden=false},function animateToHidden(){this.isHidden=true;this.delegate_.style({transition:"opacity cubic-bezier(0.4, 0.0, 1, 1) .1s",opacity:"0","pointer-events":"none"})},function close(){if(this.isClosing)return;this.isClosing=true;this.animateToHidden();this.removeTimeout=this.setTimeout(function(){this.delegate_.remove();this.delegate_=null}.bind(this),500)},async function scrollToIndex(index){var e=this.delegate_.children[index];if(!e)return;delegateE=await this.delegate_.el();childrenE=await e.el();delegateE.scrollTop=childrenE.offsetTop-this.vMargin}]});
foam.CLASS({package:"foam.u2.property",name:"MenuElement",extends:"foam.u2.View",imports:["document","popup"],properties:[["nodeName","ul"],"itemHeight","itemWidth","hMargin","choices","data","index"],methods:[function render(){this.addClass();if(this.choices.length==0){this.start("li").addClass("choice").add("Nothing to select :(").end();return}for(var i=0;i<this.choices.length;i++){this.start("li").addClass("choice").addClass(this.index===i?"selected":"").on("click",this.onClick.bind(this,i)).add(this.choices[i][1]).end()}},function load(){this.SUPER();this.document.body.addEventListener("touchstart",this.onTouch)},function unload(){this.SUPER();this.document.body.removeEventListener("touchstart",this.onTouch)}],listeners:[{name:"onMouseMove",code:function(evt){var pos=this.el_().getBoundingClientRect();var margin=50;if(evt.clientX<pos.left-margin||pos.right+margin<evt.clientX||evt.clientY<pos.top-margin||pos.bottom+margin<evt.clientY){this.popup.close()}}},{name:"onTouch",code:function(evt){if(!this.el_().contains(evt.target)){this.popup.close()}}},{name:"onClick",code:function(index){this.index=index;this.popup.close()}}],css:`
^ {
background: inherit;
box-shadow: 0px 0px 30px 0px #b7b7b7;
margin: 0;
overflow-y: auto;
position: relative;
bottom: -3rem !important;
max-height: 25rem;
border-radius: 10px;
}
^ .choice {
align-content: flex-start;
align-items: flex-end;
cursor: pointer;
margin: 0px;
font-size: 80%;
color: /*%GREY1%*/ #5e6061;
padding: 2.5rem;
}
^ .choice.selected {
font-weight: bold;
border-left: 0.7rem solid #868686;
background-color: #cacaca;
}
`});
foam.CLASS({package:"foam.u2.property",name:"MDCheckBox",extends:"foam.u2.property.AbstractCheckBox",css:`
^ {
-webkit-appearance: none;
border: solid 2px #5a5a5a;
float: right;
width: 3rem;
height: 3rem;
transition: background-color 140ms, border-color 140ms;
}
^:checked {
background-color: /*%BLACK%*/ #1e1f21;
}
^ .label {
// WHY DOESN"T WORK?
font-size: larger;
font-weight: 500;
color: red;
}
`,methods:[function render(){this.SUPER();this.setAttribute("type","checkbox");this.addClass().on("click",function(){if(this.getAttribute("disabled"))return;this.data=!this.data}.bind(this));this.start().addClass("label").add(this.label$).end()}]});
foam.CLASS({package:"foam.u2.property",name:"MDRangeView",extends:"foam.u2.property.MDInput",css:"^ { padding: 12px 0; width: 300px; }",properties:[["type","range"],["step",0],["minValue",0],["maxValue",100],["onKey",true]],methods:[function render(){this.SUPER();if(this.step)this.attrs({step:this.step});this.attrs({min:this.minValue,max:this.maxValue$})},function updateMode_(mode){if(mode===foam.u2.DisplayMode.RO||mode===foam.u2.DisplayMode.DISABLED)this.setAttribute("disabled",true);this.show(mode!==foam.u2.DisplayMode.HIDDEN)}]});
foam.CLASS({package:"foam.u2.property",name:"AbstractCheckBox",extends:"foam.u2.tag.Input",css:`
^label {
flex-grow: 1;
margin-left: 12px;
overflow: hidden;
display: inline;
}
^noselect {
-webkit-touch-callout: none;
-webkit-user-select: none;
-khtml-user-select: none;
-moz-user-select: none;
-ms-user-select: none;
user-select: none;
}
`,properties:[{class:"Boolean",name:"data"},{class:"Boolean",name:"showLabel",factory:function(){return this.label||this.labelFormatter}},{class:"String",name:"label"},{name:"labelFormatter"}],methods:[function updateMode_(mode){var disabled=mode===foam.u2.DisplayMode.RO||mode===foam.u2.DisplayMode.DISABLED;this.setAttribute("disabled",disabled)},function link(){this.data$.linkTo(this.attrSlot("checked"))}]});
foam.CLASS({package:"foam.u2.detail",name:"MDDetailView",extends:"foam.u2.View",requires:["foam.u2.property.MDDateField","foam.u2.property.MDTextField","foam.u2.property.MDIntView","foam.u2.property.MDRichSelect","foam.u2.property.MDSelect","foam.u2.property.MDCheckBox","foam.u2.property.MDFloatView","foam.u2.MDCurrencyView","foam.u2.property.MDRangeView"],exports:["data"],css:`
^ {
display: grid;
}
^ .property-item {
padding: 3rem;
font-size: 3em;
border: 1px solid #e9ebff;
height: fit-content;
}
//    TODO: move to calendar
^ .foam-u2-property-MDCalendar-heading {
font-size: 1.5rem;
padding-bottom: 1rem;
}
^ span button {
font-size: 2rem;
}
^ .foam-u2-Dialog {
background-color: unset;
}
^ .foam-u2-Dialog-body:focus {
outline: none;
}
^ .foam-u2-Dialog-buttons button, .foam-u2-property-MDDatePicker-switcher button {
background-color: #868686;
}
`,properties:[{name:"data",attribute:true,preSet:function(_,data){var of=data&&data.cls_;if(of!==this.of)this.of=of;return data},factory:function(){return this.of&&this.of.create(null,this)}},{class:"Class",name:"of"},{name:"properties",preSet:function(_,ps){foam.assert(ps,"Properties required.");for(var i=0;i<ps.length;i++){foam.assert(foam.core.Property.isInstance(ps[i]),`Non-Property in 'properties' list:`,ps)}return ps},expression:function(of){if(!of)return[];return this.of.getAxiomsByClass(foam.core.Property).filter(function(p){return!(p.hidden||p.visibility===foam.u2.DisplayMode.HIDDEN)})}}],methods:[function render(){var self=this;this.__subContext__.register(this.MDSelect,"foam.u2.view.ChoiceView");this.__subContext__.register(this.MDSelect,"foam.u2.view.ReferenceView");this.__subContext__.register(this.MDSelect,"foam.u2.tag.Select");this.__subContext__.register(this.MDRichSelect,"foam.u2.view.RichChoiceView");this.__subContext__.register(this.MDDateField,"foam.u2.DateTimeView");this.__subContext__.register(this.MDTextField,"foam.u2.FloatView");this.__subContext__.register(this.MDTextField,"foam.u2.TextField");this.__subContext__.register(this.MDTextField,"foam.u2.IntView");this.__subContext__.register(this.MDTextField,"foam.u2.tag.TextArea");this.__subContext__.register(this.MDTextField,"foam.u2.view.StringView");this.__subContext__.register(this.MDCheckBox,"foam.u2.CheckBox");this.__subContext__.register(this.MDRangeView,"foam.u2.RangeView");this.add(this.slot(function(of,properties){if(!of)return"";this.addClass(this.myClass()).forEach(properties,function(p){if(!foam.dao.OneToManyRelationshipProperty.isInstance(p)&&!foam.dao.ManyToManyRelationshipProperty.isInstance(p)&&!foam.core.FObjectProperty.isInstance(p)&&!foam.core.FObjectArray.isInstance(p)&&p.name!=="desiredPassword"&&p.name!=="status"){this.start().addClass("property-item").add(p).end()}})}))}]});
foam.CLASS({package:"foam.u2.layout",name:"MDSearchView",extends:"foam.u2.Element",requires:["foam.u2.filter.FilterController","foam.u2.search.TextSearchView"],imports:["isSearchActive"],exports:["as data","filterController"],properties:[{class:"Class",name:"of"},{name:"dao"},{name:"data"},{name:"generalSearchField",postSet:function(o,n){this.filterController.add(n,n.name,0)}},{name:"filterController",factory:function(){return this.FilterController.create({dao$:this.dao$,finalPredicate$:this.data$})}}],methods:[function render(){var self=this;self.addClass();this.start().addClass("container-search").start(self.TextSearchView,{richSearch:true,of:this.dao.of.id,onKey:true,view:{class:"foam.u2.tag.Input",placeholder:"Search"}},this.generalSearchField$).addClass("general-field").end().end().start().addClass("clear-btn").add(this.CLEAR).end()},function init(){this.onload.sub(this.addStyleOpenClose)}],actions:[{name:"clear",iconFontName:"close",label:"",code:function(){this.filterController.clearAll();this.generalSearchField.view.data="";this.isSearchActive=false}}],listeners:[{name:"addStyleOpenClose",isFramed:true,code:function(){this.addClass("open-close")}}],css:`
^ {
display: flex;
}
^ .clear-btn {
display: flex;
align-items: center;
}
^ .clear-btn i {
background-color: unset;
color: white;
font-size: 3.5rem;
}
^ input {
background-color: unset;
border: none;
border-bottom: solid 1px white;
font-size: 3rem;
color: white;
right: 0;
width: 0%;
//      transition: 1s;
position: absolute;
}
^ .container-search {
flex: 1;
}
.open-close .container-search .general-field input {
width: 100%;
transition: .5s;
}
.test .container-search .general-field input {
width: 0% !important;
}
`});
foam.CLASS({package:"foam.u2.layout",name:"MDSideNavigation",extends:"foam.u2.View",implements:["foam.mlang.Expressions"],imports:["auth","currentMenu","isMenuOpen","menuDAO","pushMenu","theme","subject"],requires:["foam.nanos.menu.Menu","foam.u2.layout.MDProfileImageView"],properties:[{class:"foam.dao.DAOProperty",name:"dao_",factory:function(){return this.menuDAO}},{class:"String",name:"menuSearch",view:{class:"foam.u2.TextField",type:"search",onKey:true},value:""},{name:"profileImg",factory:function(){return this.MDProfileImageView.create({label:this.subject.user.legalName,src:"images/ic-placeholder.png"})}}],methods:[function render(){var self=this;this.addClass(this.myClass()).addClass(this.slot(function(isMenuOpen){return isMenuOpen?"menuOpen":"menuClosed"},this.isMenuOpen$)).startContext({data:this}).tag({class:"foam.u2.layout.MDToolbarView",title:self.profileImg,leftAction:self.CLOSE_MENU,rightAction:self.LOGOUT}).endContext();this.start().addClass("side-nav-view").start().startContext({data:this}).start().add(this.MENU_SEARCH).addClass("foam-u2-search-TextSearchView").end().endContext().start().tag({class:"foam.u2.view.TreeView",data:self.dao_,relationship:foam.nanos.menu.MenuMenuChildrenRelationship,startExpanded:true,query:self.menuSearch$,onClickAddOn:function(data){self.openMenu(data)},selection$:self.currentMenu$,formatter:function(data){this.add(data.label)},defaultRoot:self.theme.navigationRootMenu}).end().end().end()},function openMenu(menu){if(menu.handler){this.pushMenu(menu,true)}}],actions:[{name:"closeMenu",iconFontName:"arrow_back",label:"",code:function(){this.isMenuOpen=!this.isMenuOpen}},{name:"logout",code:function(){this.pushMenu("sign-out")}}],css:`
^ {
z-index: 1000;
width: 50rem;
position: absolute;
box-shadow: 0px 0px 50px 0px #000;
height: 100%;
}
^ input[type="search"] {
height: 7rem;
font-size: 3rem;
}
^ .side-nav-view {
height: 109em;
overflow-x: hidden;
position: relative;
background-color: #f5f7fa;
}
^ .foam-u2-layout-MDToolbarView {
position: relative;
z-index: 1;
}
^ .foam-u2-search-TextSearchView {
padding-top: 2rem;
width: 100%;
display: flex;
justify-content: center;
}
^ .foam-u2-view-TreeViewRow {
width: 100%;
}
^ .foam-u2-view-TreeViewRow .toggle-icon {
font-size: 3rem !important;
}
^ .foam-u2-view-TreeViewRow-label {
font-size: 2.5rem;
font-weight: 500;
display: inline-flex;
justify-content: space-between;
align-items: center;
color: /*%GREY1%*/ #5e6061;
}
^ .foam-u2-view-TreeViewRow-selected > .foam-u2-view-TreeViewRow-heading {
border-left: 1rem solid /*%PRIMARY3%*/ #406dea;
}
^ .foam-u2-view-TreeViewRow-heading {
height: 10rem;
padding-left: 3rem !important;
border-bottom: 1px solid #efefef;
}
^ .foam-u2-view-TreeViewRow-label-icon {
display: none;
}
^ toolbar .right .foam-u2-ActionView {
font-size: 2rem;
}
^ .img-container img {
width: 5rem;
}
^ .foam-u2-layout-MDProfileImageView .label {
font-size: 2.5rem;
padding-left: 2rem;
}
^ .child-menu {
padding-left: 3rem;
}
^ .child-menu .foam-u2-view-TreeViewRow {
display: unset;
height: unset;
}
^ .child-menu .foam-u2-view-TreeViewRow-label {
font-weight: 300;
}
^ .child-menu .foam-u2-view-TreeViewRow-heading {
padding: unset;
}
`});
foam.CLASS({package:"foam.u2.layout",name:"MDProfileImageView",extends:"foam.u2.View",properties:["label","src"],methods:[function render(){this.addClass().start("div").addClass("img-container").start("img").attrs({src:this.src}).end().end().start().addClass("label").show(this.label).add(this.label).end()}],css:`
^ {
display: flex;
align-items: center;
}
^ img {
border-radius: 50%;
}
`});
foam.CLASS({package:"foam.u2.layout",name:"MDToolbarView",extends:"foam.u2.Element",requires:["foam.u2.ActionView"],properties:["title","leftAction","rightAction"],methods:[function render(){this.addClass();this.start("toolbar").start("div").add(this.leftAction$).addClass("left").end().start("div").show(this.title$).tag(this.title$).addClass("title").end().start("div").add(this.rightAction$).addClass("right").end().end()}],css:`
^ {
top: 0;
height: 10em;
width: 100%;
z-index: 10;
}
^ toolbar {
display: flex;
align-items: center;
height: 100%;
justify-content: space-between;
background-color: /*%PRIMARY1%*/ #2e2379;
box-shadow: 0px 0px 50px 0px /*%PRIMARY1%*/ #2e2379;
color: /*%GREY4%*/ #e7eaec;
}
`});
foam.CLASS({package:"foam.u2.dao",name:"MDDAOList",extends:"foam.u2.Element",topics:["rowClick"],exports:["data as dao"],imports:["dblclick"],properties:[{class:"foam.dao.DAOProperty",name:"data"},{class:"foam.u2.ViewSpec",name:"rowView"}],methods:[function render(){var self=this;this.addClass(this.myClass()).select(this.data$proxy,function(obj){var rowView=foam.u2.ViewSpec.createView(this.rowView,{data:obj},this,this.__subSubContext__);return self.E().start().addClass("md-row").add(rowView).on("click",function(){if(!obj){dao.find(val[0]).then(function(v){obj=v;self.dblclick&&self.dblclick(obj)})}else self.dblclick&&self.dblclick(obj)}).end()})}],css:`
^ {
height: 100%;
overflow: auto;
overflow-x: hidden;
}
^ .md-row {
display: flex;
color: /*%GREY1%*/ #5e6061;
height: 150px;
padding: 3rem;
font-size: 2.5rem;
font-weight: 300;
border-bottom: 1px solid /*%GREY3%*/ #cbcfd4;
}
`});
foam.CLASS({package:"foam.u2.layout",name:"MDRowView",extends:"foam.u2.View",requires:["foam.u2.layout.MDCitationView"],exports:["as rowView"],methods:[function render(){this.tag(this.MDCitationView,{of:this.data.cls_,data:this.data})}]});
foam.CLASS({package:"foam.u2.layout",name:"MDCitationView",extends:"foam.u2.View",axioms:[foam.pattern.Faceted.create()],properties:[{class:"Class",name:"of"},{class:"String",name:"summary"}],reactions:[["","propertyChange.data","updateSummary"],["data","propertyChange","updateSummary"]],listeners:[{name:"updateSummary",isFramed:true,code:function(){this.summary=this.data?this.data.toSummary():undefined}}],methods:[function render(){this.SUPER();this.updateSummary();this.add(this.summary$)}]});
foam.CLASS({package:"foam.u2.layout",name:"MDDAOController",extends:"foam.u2.View",requires:["foam.comics.v2.DAOControllerConfig","foam.u2.layout.MDSearchView","foam.u2.layout.MDToolbarView"],implements:["foam.mlang.Expressions"],imports:["isMenuOpen","stack"],exports:["dblclick","filteredTableColumns","isSearchActive","selection"],properties:[{class:"StringArray",name:"filteredTableColumns"},{class:"foam.dao.DAOProperty",name:"data"},{class:"FObjectProperty",of:"foam.comics.v2.DAOControllerConfig",name:"config",factory:function(){return this.DAOControllerConfig.create({dao:this.data})}},{class:"foam.u2.ViewSpec",name:"summaryView",factory:function(){return{class:"foam.u2.dao.MDDAOList",data:this.data,rowView:{class:"foam.u2.layout.MDRowView"}}}},{class:"foam.mlang.predicate.PredicateProperty",name:"cannedPredicate",expression:function(config$cannedQueries){return config$cannedQueries&&config$cannedQueries.length?config$cannedQueries[0].predicate:foam.mlang.predicate.True.create()}},{class:"foam.mlang.predicate.PredicateProperty",name:"searchPredicate",expression:function(){return foam.mlang.predicate.True.create()}},{class:"foam.dao.DAOProperty",name:"predicatedDAO",expression:function(config,cannedPredicate,searchPredicate){return config.dao$proxy.where(this.AND(cannedPredicate,searchPredicate))}},{class:"foam.dao.DAOProperty",name:"searchFilterDAO",expression:function(config,cannedPredicate){return config.dao$proxy.where(cannedPredicate)}},{name:"title",expression:function(data$of,isSearchActive){return data$of.model_.plural}},{name:"rightAction",expression:function(){return this.SEARCH}},"selection",{class:"Boolean",name:"isSearchActive"}],actions:[{name:"openMenu",iconFontName:"menu",label:"",code:function(){this.isMenuOpen=true}},{name:"search",iconFontName:"search",label:"",code:function(){this.isSearchActive=!this.isSearchActive}},{name:"create",iconFontName:"add",label:"",code:function(){if(!this.stack)return;this.stack.push({class:"foam.u2.layout.MDDAOCreateController",data:this.data.of.create({mode:"create"},this),of:this.data.of},this)}}],methods:[function render(){this.SUPER();var self=this;this.isMenuOpen=false;this.isSearchActive$.sub(this.onSearchActiveChanged);this.addClass().startContext({data:this}).tag({class:"foam.u2.layout.MDToolbarView",title$:self.title$,leftAction:self.OPEN_MENU,rightAction:self.rightAction$}).endContext().start(self.summaryView,{data:self.predicatedDAO$proxy}).addClass(self.myClass("browse-view-container")).end();this.startContext({data:this}).start("div").addClass("create-btn").addClass("material-icons").add("add").on("click",this.onCreate).end().endContext()},function dblclick(obj){if(!this.stack)return;this.stack.push({class:"foam.u2.layout.MDDAOUpdateController",data:obj,config:this.config,of:this.config.of,dao:this.data},this)},function resetActions(){this.title=this.data.of.model_.plural;this.rightAction=this.SEARCH}],listeners:[function onCreate(){if(!this.stack)return;this.stack.push({class:"foam.u2.layout.MDDAOCreateController",data:this.data.of.create({mode:"create"},this),of:this.data.of,dao:this.data},this.__subContext__)},function onSearchActiveChanged(){if(this.isSearchActive){this.rightAction=this.MDSearchView.create({dao$:this.searchFilterDAO$,data$:this.searchPredicate$});this.title=""}else{this.resetActions()}}],css:`
^ .right .foam-u2-search-TextSearchView {
position: relative;
}
^ .right {
flex: 1;
}
^ .create-btn {
position: absolute;
bottom: 3rem;
right: 3rem;
border-radius: 100%;
padding: 3rem;
color: white;
font-weight: 900;
font-size: 4rem;
background-color: /*%PRIMARY2%*/ #937dff;
box-shadow: inset 0px 0px 15px 0px white;
}
`});
foam.CLASS({package:"foam.u2.md",name:"AppController",extends:"foam.nanos.controller.ApplicationController",requires:["foam.core.Latch","foam.u2.layout.MDDAOController","foam.u2.layout.MDLoginView","foam.u2.layout.MDNotificationMessage","foam.u2.layout.MDStackView"],exports:["isMenuOpen"],css:`
^ body {
height: 100%;
overflow: hidden;
}
^ .foam-u2-ActionView {
border: none !important;
}
^ .foam-u2-ActionView:hover {
background-color: unset !important;
}
^ .foam-u2-layout-MDStackView {
position: relative;
height: 100%;
overflow: hidden;
}
^ .menuOpen {
left: -00px;
transition: .2s;
}
^ .menuClosed {
left: -60rem;
transition: .2s;
}
^ toolbar .right {
padding-right: 3rem;
}
^ toolbar .left i {
padding-left: 3rem;
}
^ toolbar .title {
padding-left: 4rem;
font-weight: 500;
font-size: 3.5rem;
width: 100%;
}
^ toolbar .foam-u2-ActionView {
background-color: unset;
font-size: 4rem;
}
//    TODO: move to toolbar ^
`,properties:[{class:"foam.core.FObjectProperty",of:"foam.core.Latch",name:"themeInstalled",factory:function(){return this.Latch.create()}},{class:"Boolean",name:"isMenuOpen"}],methods:[async function render(){window.addEventListener("resize",this.updateDisplayWidth);this.updateDisplayWidth();await this.clientPromise;await this.fetchTheme();this.client.nSpecDAO.find("appConfig").then(config=>{this.appConfig.copyFrom(config.service);this.__subContext__.register(this.MDDAOController,"foam.comics.v2.DAOBrowseControllerView");this.__subContext__.register(this.MDDAOController,"foam.comics.BrowserView");this.__subContext__.register(this.MDLoginView,"foam.u2.view.LoginView");this.__subContext__.register(this.MDNotificationMessage,"foam.u2.dialog.NotificationMessage");this.themeInstalled.resolve()});await this.themeInstalled;this.addClass(this.myClass()).start().enableClass("login-stack",this.loginSuccess$.map(ls=>!ls)).start("div").tag({class:"foam.u2.layout.MDSideNavigation"}).end().tag(this.MDStackView.create({data:this.stack,showActions:false})).end()}]});
foam.CLASS({package:"foam.u2.md",name:"OverlayDropdown",extends:"foam.u2.Element",imports:["document","window"],exports:["as dropdown"],css:`
^overlay {
position: absolute;
z-index: 1009;
}
^ {
background-color: /*%WHITE%*/ #ffffff;
border: 1px solid /*%GREY4%*/ #DADDE2;
box-sizing: border-box;
box-shadow: 0px 10px 15px rgba(0, 0, 0, 0.1), 0px 4px 6px rgba(0, 0, 0, 0.05);
border-radius: 4px;
display: block;
font-size: 1.4rem;
font-weight: 400;
overflow-x: hidden;
overflow-y: hidden;
position: absolute;
padding: 8px;
z-index: 1010;
}
^open {
overflow-y: auto;
}
^zeroOverlay {
top: 0;
bottom: 0;
left: 0;
right: 0;
}
^initialOverlay {
top: initial;
bottom: initial;
left: initial;
right: initial;
}
^parents {
z-index: 1000 !important;
}
`,properties:[{class:"Boolean",name:"opened",},{name:"dropdownE_",factory:function(){return this.E("dropdown")}},{name:"addToSelf_",value:false},{name:"left"},{name:"right"},{name:"top"},{name:"bottom"},"parentEl",{class:"Boolean",name:"closeOnLeave",value:true}],methods:[function add(){if(this.addToSelf_){this.SUPER(...arguments)}else{this.dropdownE_.add(...arguments)}return this},function open(x,y){var screenWidth=this.window.innerWidth;var domRect=this.parentEl.getBoundingClientRect();var screenHeight=this.window.innerHeight;var scrollY=this.window.scrollY;if(domRect.top-scrollY<screenHeight/2){this.top=y;this.bottom="auto"}else{this.top="auto";this.bottom=screenHeight-y}if(domRect.left>3*(screenWidth/4)){this.left="auto";this.right=screenWidth-x+10}else{this.left=x+10;this.right="auto"}this.opened=true;window.addEventListener("resize",this.onResize)},function close(){this.opened=false},function render(){this.addToSelf_=true;this.addClass(this.myClass("container"));var view=this;this.addClass(this.slot(function(opened){this.shown=opened},this.opened$));this.start("dropdown-overlay").addClass(this.myClass("overlay")).show(this.opened$).addClass(this.slot(function(opened){return opened?view.myClass("zeroOverlay"):view.myClass("initialOverlay")},this.opened$)).on("click",this.onCancel).end();this.dropdownE_.addClass(this.myClass()).show(this.opened$).style({top:this.top$,left:this.left$,right:this.right$,bottom:this.bottom$}).on("mouseenter",this.onMouseEnter).on("mouseleave",this.onMouseLeave).on("keydown",this.onKeyDown).on("click",this.onClick);this.add(this.dropdownE_);this.addToSelf_=false}],listeners:[function onCancel(){this.close()},function onKeyDown(e){var isEsc=e.key==="Escape"||e.keyCode===27;if(isEsc){this.close();this.document.getElementById(this.parentEl.id).focus()}},function onMouseEnter(e){if(this.timer!==undefined){clearTimeout(this.timer)}},function onMouseLeave(e){console.assert(e.target===this.dropdownE_.el_(),"mouseleave should only fire on this, not on children");if(e.toElement?.nodeName=="DROPDOWN"||!this.closeOnLeave)return;this.timer=setTimeout(()=>{this.close()},500)},function onClick(e){e.stopPropagation()},function onResize(){this.close();window.removeEventListener("resize",onResize)}]});
foam.CLASS({package:"foam.u2.layout",name:"MDLoginView",extends:"foam.u2.View",imports:["appConfig","loginVariables"],requires:["foam.nanos.u2.navigation.SignIn","foam.nanos.u2.navigation.SignUp"],css:`
^ .title-top {
font-size: 1.7em;
padding-bottom: 5rem;
text-align: center;
}
^ .center-footer {
text-align: center;
font-size: 2rem;
display: grid;
position: relative;
top: -52px;
color: /*%GREY1%*/ #5e6061;
}
^ .link {
font-size: larger;
font-weight: bold;
padding-bottom: 2rem;
}
^ .foam-u2-ActionView-login {
margin: auto;
padding: 2rem;
font-size: 2.5rem;
position: relative;
bottom: -2rem;
width: 90%;
border-radius: 50px;
background-image: linear-gradient(#604aff, #2e2379);
background-color: unset;
box-shadow: 0 0px 5px 4px #2e2379;
}
^ .foam-u2-detail-SectionedDetailPropertyView m3 {
font-size: 2rem;
}
^ .foam-u2-detail-SectionedDetailPropertyView input {
height: 4rem;
font-size: 2rem;
border: none;
border-bottom: 1px solid black;
}
^ .foam-u2-detail-SectionedDetailPropertyView input:focus {
border-bottom: 2px solid blue;
}
^ .content-form {
font-size: 2rem;
width: 75%;
padding: 3rem;
top: -10rem;
position: relative;
background: /*%GREY5%*/ #f5f7fa;
margin: auto;
box-shadow: 0px 0px 30px 0px #b7b7b7;
border-radius: 30px;
color: /*%GREY1%*/ #5e6061;
}
^ .background-container {
--parent-mainfill: linear-gradient(#604aff, #2e2379);
background-image: var(--parent-mainfill);
height: 40%;
display: flex;
align-items: center;
justify-content: center;
}
^ .home-logo {
background-color: /*%GREY5%*/ #f5f7fa;
padding: 3rem;
border-radius: 50%;
margin-bottom: 13rem;
box-shadow: 0 0px 5px 3px white;
}
^ .foam-u2-layout-Cols {
height: 0px;
}
^ input:-webkit-autofill {
-webkit-box-shadow: 0 0 0px 1000px #f5f7fa inset;
}
^ .input-image {
display: none;
}
^ .home-img {
font-size: 9rem;
background: -webkit-linear-gradient(#604aff, #2e2379);
-webkit-background-clip: text;
-webkit-text-fill-color: transparent;
}
`,properties:[{class:"Boolean",name:"topBarShow_",factory:function(){return!!this.backLink_},hidden:true},{name:"model",factory:()=>{return{}},view:{class:"foam.u2.detail.VerticalDetailView"}},{name:"param",factory:function(){return{}}},{class:"String",name:"mode_",hidden:true},{class:"String",name:"backLink_",factory:function(){return this.model.backLink_||this.appConfig.externalUrl||undefined},hidden:true}],messages:[{name:"GO_BACK",message:"Go to "},{name:"MODE1",message:"SignUp"}],methods:[function init(){this.param.dao_=!!this.param.dao_?this.param.dao_:this.loginVariables.dao_;if(this.mode_===this.MODE1){this.model=this.SignUp.create(this.param,this)}else{this.model=this.SignIn.create(this.param,this)}},function render(){this.SUPER();this.document.addEventListener("keyup",this.onKeyPressed);this.onDetach(()=>{this.document.removeEventListener("keyup",this.onKeyPressed)});this.addClass();this.start("div").addClass("background-container").start("div").addClass("home-logo").start("div").addClass("home-img").addClass("material-icons").add("home").end().end().end();this.start("div").start().addClass("title-top").add("Login").end().startContext({data:this}).addClass("content-form").tag(this.MODEL).br().endContext().end();this.start().addClass("center-footer").start("span").add(this.model.FOOTER_TXT).end().start("span").addClass("link").add(this.model.FOOTER_LINK).on("click",()=>{this.model.footerLink(this.topBarShow_,this.param)}).end().start("span").add(this.model.SUB_FOOTER_TXT).end().start("span").addClass("link").add(this.model.SUB_FOOTER_LINK).on("click",()=>{this.model.subfooterLink()}).end().end()}],listeners:[function onKeyPressed(e){e.preventDefault();var key=e.key||e.keyCode;if(key==="Enter"||key===13){this.model.login()}}]});
foam.CLASS({package:"foam.u2.layout",name:"MDNotificationMessage",extends:"foam.u2.View",requires:["foam.log.LogLevel","foam.u2.tag.CircleIndicator"],imports:["theme"],css:`
^ {
display: flex;
justify-content: center;
position: fixed;
top: 0;
width: 100vw;
z-index: 15000;
}
^inner {
width: 100%;
height: 5rem;
max-width: 1024px;
margin: auto;
padding: 8px 24px;
animation-name: fade;
animation-duration: 5s;
font-size: 1.4rem;
line-height: 1.33;
letter-spacing: 0.2px;
border-radius: 3px;
box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.08);
background: #e2f2dd;
display: flex;
justify-content: space-between;
align-items: center;
}
^banner {
background-color: #32bf5e;
height: 4px;
width: inherit;
max-width: 1072px;
margin-left: -24px;
border-top-left-radius: 3px;
border-top-right-radius: 3px;
position: absolute;
top: 0;
}
@keyframes fade {
0% { opacity: 0; }
10% { opacity: 1; }
80% { opacity: 1; }
100% { opacity: 0; }
}
^status-icon {
width: 20px;
height: 20px;
margin-right: 16px;
vertical-align: middle;
}
^content {
display: inline-block;
vertical-align: middle;
font-size: 2.5em;
font-weight: 800;
color: #19402e;
letter-spacing: normal;
}
^description {
font-size: 1.4rem;
font-weight: normal;
line-height: 1.43;
letter-spacing: normal;
color: #19402e;
margin-left: 36px;
}
^error-background {
background: #fff6f6;
}
^warning-background {
background: #fdf8de;
}
^error-banner {
background: #d9170e;
}
^warning-banner {
background: #eedc00;
}
^error-content {
color: #631414;
}
^warning-content {
color: #816819;
}
^link-icon {
display: inline-block;
margin-top: 2px;
vertical-align: middle;
margin-right: 0 !important;
width: 16px;
height: 16px;
}
^close-icon {
background-image: url("images/round-close-icon.svg");
background-size: 12px 12px;
cursor:pointer;
height: 12px;
opacity: 0.5;
width: 12px;
position: absolute;
top: 18;
}
^close-icon:hover {
opacity: 1;
}
`,properties:[{class:"String",name:"type"},"message","description"],methods:[function render(){var self=this;var indicator;if(this.type==this.LogLevel.ERROR){indicator={size:40,backgroundColor:this.theme.destructive3,borderColor:this.theme.destructive3,icon:this.theme.glyphs.exclamation.getDataUrl({fill:this.theme.white})}}else if(this.type==this.LogLevel.WARN){indicator={size:40,icon:"images/baseline-warning-yellow.svg"}}else{indicator={size:40,backgroundColor:this.theme.approval3,borderColor:this.theme.approval3,icon:this.theme.glyphs.checkmark.getDataUrl({fill:this.theme.white})}}this.addClass(this.myClass()).start().addClass(this.myClass("inner")).enableClass(this.myClass("error-background"),this.type==this.LogLevel.ERROR).enableClass(this.myClass("warning-background"),this.type==this.LogLevel.WARN).start("div").addClass(this.myClass("banner")).enableClass(this.myClass("error-banner"),this.type==this.LogLevel.ERROR).enableClass(this.myClass("warning-banner"),this.type==this.LogLevel.WARN).end().start().start(this.CircleIndicator,indicator).addClass(this.myClass("status-icon")).end().start().addClass(this.myClass("content")).enableClass(this.myClass("error-content"),this.type==this.LogLevel.ERROR).enableClass(this.myClass("warning-content"),this.type==this.LogLevel.WARN).callIfElse(foam.String.isInstance(this.message),function(){this.add(self.message);console.log(self.message)},function(){this.tag(self.message);console.log(self.message)}).end().start().addClass(this.myClass("description")).enableClass(this.myClass("error-content"),this.type==this.LogLevel.ERROR).enableClass(this.myClass("warning-content"),this.type==this.LogLevel.WARN).callIfElse(foam.String.isInstance(this.description),function(){this.add(self.description);console.log(self.description)},function(){this.tag(self.description);console.log(self.description)}).end().end().startContext({data:this}).start().addClass(this.myClass("link-icon")).start().addClass(this.myClass("close-icon")).on("click",()=>this.remove()).end().end().endContext().end();setTimeout(()=>{this.remove()},5e3)}]});
foam.CLASS({package:"foam.u2.md.tag",name:"PaperDropdown",extends:"foam.u2.tag.Select",css:`
^unrolled paper-item {
font-size: 1.2rem;
min-height: 36px;
}
^label {
color: #737373;
font-size: 1.2rem;
font-weight: 400;
line-height: 18px;
overflow: hidden;
text-overflow: ellipsis;
white-space: nowrap;
}
`,properties:[{name:"nodeName",expression:function(unrolled){return unrolled?"div":"paper-dropdown-menu"}},{class:"String",name:"label"},{class:"Boolean",name:"unrolled",expression:function(size){return size>1}},{class:"Int",name:"size",value:1},{class:"Boolean",name:"alwaysFloatLabel"}],methods:[function render(){this.attrs({label:this.label$,"always-float-label":this.alwaysFloatLabel,"no-label-float":this.slot(function(label){return!label},this.label$)});if(this.unrolled){this.addClass(this.myClass("unrolled"));this.start("div").addClass(this.myClass("label")).add(this.label$).end()}var listbox;this.add(this.slot(function(choices,unrolled){listbox=this.E("paper-listbox").addClass("dropdown-content");for(var i=0;i<choices.length;i++){listbox.start("paper-item").attrs({name:i}).add(choices[i][1]).end()}var extras=Math.max(0,this.size-choices.length);for(var i=0;i<extras;i++){listbox.start("paper-item").end()}listbox.attrs({selected:this.data});return listbox}.bind(this),this.choices$));this.data$.sub(function(){listbox.attrs({selected:this.data})}.bind(this));this.on("iron-select",function(e){this.data=e.target.selected}.bind(this))}]});
foam.CLASS({package:"foam.counter",name:"Counter",implements:["foam.nanos.auth.CreatedAware"],properties:[{class:"DateTime",name:"created"},{class:"Long",name:"id"},{name:"name",class:"String",},{name:"key",class:"Object",}]});
foam.CLASS({package:"foam.dashboard.view",name:"DashboardCitationView",extends:"foam.u2.View",axioms:[foam.pattern.Faceted.create()],requires:["foam.comics.v2.DAOControllerConfig"],imports:["stack"],exports:["as rowView"],properties:[{class:"Class",name:"of"}],methods:[function render(){var self=this;this.on("click",function(){self.openFilteredListView(self.data)}).addClass(this.myClass()).start().addClass(this.myClass("id")).add(this.data["id"]).end().start().addClass(this.myClass("value")).add(this.data["value"]).end()},function openFilteredListView(obj){var dao=this.__subContext__[obj.listDAOName].where(this.EQ(obj.searchKey,obj.id));var config=this.DAOControllerConfig.create({dao:dao,hideQueryBar:false});this.stack.push({class:"foam.comics.v2.DAOBrowserView",config:config})}],css:`
^ {
display: flex;
justify-content: space-between;
padding-top: 15px;
padding-bottom: 15px;
border-bottom: 1px solid #e4e3e3;
}
^id {
font-weight: 300;
font-size: 1.3rem;
color: gray;
}
^value {
font-size: 1.3rem;
font-weight: 500;
}
`});
foam.CLASS({package:"foam.dashboard.view",name:"DateRangeChoiceView",extends:"foam.u2.Controller",css:`
^ .foam-u2-tag-Select {
border: none;
font-size: 1.3rem;
color: gray;
padding: 0;
}
`,properties:[{name:"property",},{class:"String",name:"qualifier",view:{class:"foam.u2.view.ChoiceView",choices:[[0,"All Time"],[1,"Today"],[7,"Last 7 days"],[30,"Last 30 days"]],defaultValue:0}},{name:"predicate",expression:function(qualifier){if(qualifier==0)return foam.mlang.predicate.True.create();var date=new Date;date.setDate(date.getDate()-qualifier);return foam.mlang.predicate.Gt.create({arg1:this.property,arg2:date})}}],methods:[function render(){var self=this;this.addClass().start(this.QUALIFIER).end()}]});
foam.CLASS({package:"foam.nanos.fs",name:"AgreementView",extends:"foam.u2.Controller",imports:["fileDAO"],css:`
^text {
overflow-y: auto;
height: 500px;
width: 100%;
border: 1px solid #DDD;
padding: 10px;
}
^pdf embed {
width: 100%;
height: 500px;
}
`,properties:[{name:"fileId"}],methods:[async function render(){this.SUPER();const url=window.location.origin+"/service/file/"+this.fileId;this.addClass(this.myClass("pdf")).start("embed").attrs({src:url,type:"application/pdf"}).end()}]});
foam.CLASS({package:"foam.nanos.crunch.ruler",name:"UCJDataExpiryRule",extends:"foam.nanos.ruler.Rule",properties:[{class:"Int",name:"expiredIn",value:365},{name:"daoKey",value:"userCapabilityJunctionDAO"},{name:"after",value:false},{name:"action",transient:true,},{name:"asyncAction",transient:true,}],classes:[{name:"UCJDataExpiryRuleAction",implements:["foam.nanos.ruler.RuleAction"],methods:[{name:"applyAction",}]}]});
foam.CLASS({package:"foam.time",name:"Hours",properties:[{class:"Enum",of:"foam.time.DayOfWeek",name:"day"},{class:"Boolean",name:"open"},{class:"String",name:"startTime"},{class:"String",name:"endTime"}]});
foam.CLASS({package:"foam.time",name:"TimeZone",properties:[{class:"String",name:"id"},{class:"String",name:"displayName"},{class:"Reference",targetDAOKey:"countryDAO",name:"countryId",of:"foam.nanos.auth.Country"}]});foam.ENUM({package:"foam.time",name:"DayOfWeek",properties:[{class:"String",name:"shortName"}],values:[{name:"MONDAY",label:"Monday",shortName:"Mon"},{name:"TUESDAY",label:"Tuesday",shortName:"Tue"},{name:"WEDNESDAY",label:"Wednesday",shortName:"Wed"},{name:"THURSDAY",label:"Thursday",shortName:"Thu"},{name:"FRIDAY",label:"Friday",shortName:"Fri"},{name:"SATURDAY",label:"Saturday",shortName:"Sat"},{name:"SUNDAY",label:"Sunday",shortName:"Sun"}]});foam.ENUM({package:"foam.time",name:"TimeUnit",properties:[{class:"String",name:"shorthand"},{class:"String",name:"plural",factory:function(){return this.label+"s"}},{class:"Long",name:"conversionFactorMs"}],values:[{name:"YEAR",shorthand:"Y",conversionFactorMs:31556926e3},{name:"MONTH",shorthand:"M",conversionFactorMs:2629743833},{name:"WEEK",shorthand:"W",conversionFactorMs:6048e5},{name:"DAY",shorthand:"d",conversionFactorMs:864e5},{name:"HOUR",shorthand:"h",conversionFactorMs:36e5},{name:"MINUTE",shorthand:"m",conversionFactorMs:6e4},{name:"SECOND",shorthand:"s",conversionFactorMs:1e3},{name:"MILLISECOND",shorthand:"ms",conversionFactorMs:1}]});
foam.CLASS({package:"foam.u2.table",name:"TableComponentView",extends:"foam.u2.View",requires:["foam.nanos.column.ColumnConfigToPropertyConverter","foam.nanos.column.CommonColumnHandler","foam.nanos.column.ExpressionForArrayOfNestedPropertiesBuilder"],imports:["columnConfigToPropertyConverter as importedColumnConfigConverter"],properties:[{name:"columnHandler",class:"FObjectProperty",of:"foam.nanos.column.CommonColumnHandler",factory:function(){return foam.nanos.column.CommonColumnHandler.create({},this)}},{name:"columnConfigToPropertyConverter",factory:function(){if(!this.importedColumnConfigConverter)return foam.nanos.column.ColumnConfigToPropertyConverter.create();return this.importedColumnConfigConverter}},{name:"subStack",factory:function(){return foam.nanos.approval.NoBackStack.create({delegate:this.stack})}}],methods:[function returnRecords(of,dao,propertyNamesToQuery,useProjection){var expr=this.ExpressionForArrayOfNestedPropertiesBuilder.create().buildProjectionForPropertyNamesArray(of,propertyNamesToQuery,useProjection);return dao.select(expr)},function doesAllColumnsContainsColumnName(obj,col){return obj.allColumns.contains(obj.columnHandler.checkIfArrayAndReturnFirstLevelColumnName(col))},function filterColumnsThatAllColumnsDoesNotIncludeForArrayOfColumns(obj,columns){return columns.filter(c=>obj.allColumns.includes(obj.columnHandler.checkIfArrayAndReturnFirstLevelColumnName(c)))},function returnPropertiesForColumns(obj,columns_){var propertyNamesToQuery=columns_.length===0?columns_:["id"].concat(obj.filterColumnsThatAllColumnsDoesNotIncludeForArrayOfColumns(obj,columns_).filter(c=>!foam.core.Action.isInstance(obj.of.getAxiomByName(obj.columnHandler.propertyNamesForColumnArray(c)))).map(c=>obj.columnHandler.propertyNamesForColumnArray(c)));return obj.columnConfigToPropertyConverter.returnPropertyColumnMappings(obj.of,propertyNamesToQuery)},function shouldColumnBeSorted(c){return c[c.length-1]===this.DESCENDING_ORDER_CHAR||c[c.length-1]===this.ASCENDING_ORDER_CHAR},function returnMementoColumnNameDisregardSorting(c){return c&&this.shouldColumnBeSorted(c)?c.substr(0,c.length-1):c},async function filterUnpermitted(arr){if(this.auth){const results=await Promise.all(arr.map(async p=>p.hidden?false:!p.columnPermissionRequired||await this.auth.check(ctrl.__subContext__,`${this.of.name.toLowerCase()}.column.${p.name}`)));return arr.filter((_v,index)=>results[index])}return arr},function getCellData(obj,prop,nestedPropertiesObjsMap){var objForCurrentProperty=obj;var propName=this.columnHandler.propertyNamesForColumnArray(prop);var prop=this.props.find(p=>p.fullPropertyName===propName);if(prop&&prop.fullPropertyName.includes(".")){objForCurrentProperty=nestedPropertiesObjsMap[this.columnHandler.getNestedPropertyNameExcludingLastProperty(prop.fullPropertyName)]}return[objForCurrentProperty?objForCurrentProperty.cls_.getAxiomByName(this.columnHandler.getNameOfLastPropertyForNestedProperty(propName)):prop&&prop.property?prop.property:this.data.of.getAxiomByName(propName),objForCurrentProperty]}],listeners:[{name:"shouldEscapeEvts",code:function(evt){if(evt.target.nodeName==="DROPDOWN-OVERLAY"||evt.target.classList.contains(this.myClass("vertDots"))||evt.target.nodeName==="INPUT"){return true}}}]});
foam.CLASS({package:"foam.u2.table",name:"TableView",extends:"foam.u2.table.UnstyledTableView",css:`
^ {
border-spacing: 0px;
overflow-x: unset;
width: 100%;
}
^tbody {
display: flow-root;
}
^full-height{
height: 100%;
}
^table-wrapper{
/*Scroll*/
flex: 1;
max-height: 100%;
position: relative;
overflow: auto;
overscroll-behavior: contain;
scroll-behavior: smooth;
}
^tr {
background: /*%WHITE%*/ white;
display: flex;
height: 48px;
justify-content: space-between;
}
^tbody ^tr:hover {
background: /*%GREY5%*/ #f5f7fa;
border-radius: 4px;
cursor: pointer;
}
^thead {
position: sticky;
top: 0;
z-index: 1;
}
^thead > ^tr {
border-bottom: 2px solid /*%GREY4%*/ #DADDE2;
box-sizing: border-box;
border-radius: 4px 4px 0 0;
width: 100%;
position: relative;
}
^td,
^th {
align-self: center;
box-sizing: border-box;
color: /*%BLACK%*/ #1e1f21;
display: block;
font-size: 1.4rem;
line-height: 1.5;
overflow: hidden;
padding-left: 16px;
text-align: left;
text-overflow: ellipsis;
white-space: nowrap;
min-width: 40px; /* So when the table's width decreases, columns aren't hidden completely */
}
^th:not(:last-child) > img {
margin-left: 8px;
}
^th:hover {
cursor: pointer;
}
/**
* OTHER
*/
^selected {
background: /*%PRIMARY5%*/ #e5f1fc;
}
^noselect {
-webkit-touch-callout: none;
-webkit-user-select: none;
-khtml-user-select: none;
-moz-user-select: none;
-ms-user-select: none;
user-select: none;
}
^ .disabled {
color: #aaa;
}
^td .foam-u2-ActionView {
padding: 4px 12px;
}
^row-group{
background: /*%GREY5%*/ #F5F7FA;
}
^resizeButton {
padding: 4px;
position: sticky;
right: 4px;
}
^resizeButton:hover:not(:disabled), ^resizeCursor {
cursor: col-resize;
}
^resizeButton svg{
width: 0.8em;
height: 0.8em;
}
/* PAGINATION */
^nav{
align-items: center;
background: /*%WHITE%*/ white;
border-radius: 0 0 4px 4px;
border-top: 1px solid /*%GREY4%*/ #DADDE2;
box-sizing: border-box;
gap: 8px;
justify-content: flex-end;
max-height: 56px;
padding: 16px 24px;
width: 100%;
}
^buttons svg{
width: 1em;
height: 1em;
}
^counters > *:focus {
border: 0px;
border-radius: 0px;
padding: 0px;
height: auto;
border-bottom: 2px solid /*%PRIMARY3%*/ #406DEA;
}
`,messages:[{name:"MESSAGE_OF",message:"of"}]});
foam.CLASS({package:"foam.u2.table",name:"UnstyledTableGroup",extends:"foam.u2.table.TableComponentView",requires:["foam.core.SimpleSlot","foam.u2.CheckBox","foam.u2.view.OverlayActionListView"],imports:["canBuildObjfromProj","nestedPropsAndIndexes","propertyNamesToQuery","props"],messages:[{name:"EMPTY_MSG",message:"No"}],properties:["obj","projection"],methods:[function render(){var self=this;var objForCurrentProperty=this.obj;var expr=foam.mlang.Expressions.create();var nestedPropertyValues=this.columnHandler.filterNestedPropertyValues(this.projection,this.nestedPropsAndIndexes[1]);var nestedPropertiesObjsMap=this.columnHandler.groupRelatedObjects(this.data.of,this.nestedPropsAndIndexes[0],nestedPropertyValues);this.addClass(this.data.myClass("tr")).addClasses([this.data.myClass("row-group"),this.data.myClass("row")]).callIf(this.data.multiSelectEnabled,function(){var slot=self.SimpleSlot.create();this.start().addClass(self.data.myClass("th")).tag(self.CheckBox,{},slot).style({width:"42px"}).end();self.onDetach(slot.value.dot("data").sub(function(_,__,___,newValueSlot){var checked=newValueSlot.get();if(checked){self.data.selectedObjects={};self.data.data.where(expr.EQ(self.data.groupBy,self.data.groupBy.f(objForCurrentProperty))).select(function(obj){self.data.selectedObjects[obj.id]=obj;self.data.idsOfObjectsTheUserHasInteractedWith_[obj.id]=true;if(self.data.checkboxes_[obj.id])self.data.checkboxes_[obj.id].data=checked})}else{Object.keys(self.data.checkboxes_).forEach(function(key){if(self.data.selectedObjects[key]&&self.data.groupBy.f(self.data.selectedObjects[key])==self.data.groupBy.f(objForCurrentProperty))self.data.checkboxes_[key].data=checked});self.data.selectedObjects={}}}))}).style({"min-width":this.data.tableWidth_$});[prop,objReturned]=this.getCellData(objForCurrentProperty,this.data.groupBy,nestedPropertiesObjsMap);var elmt=this.E().style({flex:"3 0 0"}).addClasses(["h500",this.data.myClass("td")]).call(function(){prop.tableCellFormatter.format(this,prop.f?prop.f(objReturned):null,objReturned,prop);if(!prop.f(objReturned)){this.add(self.EMPTY_MSG+" "+prop.label)}});this.add(elmt)}]});
foam.CLASS({package:"foam.u2.table",name:"UnstyledTableRow",extends:"foam.u2.table.TableComponentView",requires:["foam.core.SimpleSlot","foam.u2.CheckBox","foam.u2.tag.Image","foam.u2.view.OverlayActionListView","foam.u2.table.UnstyledTableRowComponent"],imports:["canBuildObjfromProj","click?","dblclick?","nestedPropsAndIndexes","propertyNamesToQuery","props","stack?"],properties:["obj","projection",{name:"actionDAO",factory:function(){return this.data.data}}],methods:[function render(){this.SUPER();const obj=this.obj;var self=this;var nestedPropertyValues=this.columnHandler.filterNestedPropertyValues(this.projection,this.nestedPropsAndIndexes[1]);var nestedPropertiesObjsMap=this.columnHandler.groupRelatedObjects(this.data.of,this.nestedPropsAndIndexes[0],nestedPropertyValues);this.addClass(this.data.myClass("tr")).callIf(this.dblclick&&!this.data.disableUserSelection,function(){this.on("dblclick",function(evt){if(self.data.shouldEscapeEvts(evt))return;self.dblclick.call(self,null,obj.id)})}).callIf(this.click&&!this.data.disableUserSelection,function(){this.on("click",function(evt){if(self.data.shouldEscapeEvts(evt))return;self.data.selection=obj.id;self.click.call(self,null,obj.id)})}).addClass(this.data.myClass("row")).style({"min-width":this.data.tableWidth_$}).callIf(this.data.multiSelectEnabled,function(){var slot=self.SimpleSlot.create();self.start("").addClass(self.data.myClass("td")).tag(self.CheckBox,{data:self.data.idsOfObjectsTheUserHasInteractedWith_[obj.id]?!!self.data.selectedObjects[obj.id]:self.data.allCheckBoxesEnabled_},slot).end().enableClass(self.data.myClass("selected"),slot.value$.dot("data"));self.data.onDetach(slot.value$.dot("data").sub(function(_,__,___,newValueSlot){if(self.data.togglingCheckBoxes_)return;self.data.idsOfObjectsTheUserHasInteractedWith_[obj.id]=true;var checked=newValueSlot.get();if(checked){var modification={};self.data.data.find(obj.id).then(v=>{modification[obj.id]=v;self.data.selectedObjects=Object.assign({},self.data.selectedObjects,modification)})}else{var temp=Object.assign({},self.data.selectedObjects);delete temp[obj.id];self.data.selectedObjects=temp}}));var checkbox=slot.get();self.data.checkboxes_[obj.id]=checkbox;checkbox.onDetach(function(){delete self.data.checkboxes_[obj.id]})});for(var j=0;j<this.data.columns_.length;j++){self.tag(self.UnstyledTableRowComponent,{data:self.data,col:this.data.columns_[j],nestedPropertiesObjsMap:nestedPropertiesObjsMap,obj:obj})}var actions=this.data.getActionsForRow(obj);self.start("").addClass(this.data.myClass("td")).on("dblClick",e=>{e.preventDefault();e.stopPropogation()}).attrs({name:"contextMenuCell"}).style({flex:`0 0 ${this.data.EDIT_COLUMNS_BUTTON_CONTAINER_WIDTH}px`}).startContext({stack:this.subStack}).tag(this.OverlayActionListView,{data:Object.values(actions),obj:obj,dao:self.actionDAO,showDropdownIcon:false,buttonStyle:"TERTIARY",icon:"images/Icon_More_Resting.svg"}).endContext().end()}]});
foam.CLASS({package:"foam.u2.table",name:"UnstyledTableRowComponent",extends:"foam.u2.table.TableComponentView",imports:["colWidthUpdated","props","selectedColumnsWidth"],properties:[{name:"colWidth",factory:function(){return this.selectedColumnsWidth&&this.selectedColumnsWidth[this.propName]?this.selectedColumnsWidth[this.propName]:this.columnHandler.returnPropertyForColumn(this.props,this.data.of,this.col,"tableWidth")}},"col","propName","nestedPropertiesObjsMap","obj"],methods:[function render(){var self=this;this.propName=this.columnHandler.propertyNamesForColumnArray(this.col);[prop,objReturned]=this.getCellData(this.obj,this.col,this.nestedPropertiesObjsMap);if(this.colWidthUpdated$&&this.selectedColumnsWidth$){this.onDetach(this.colWidthUpdated$.sub(function(){if(self.selectedColumnsWidth[self.propName])self.colWidth=self.selectedColumnsWidth[self.propName]}))}this.startContext({controllerMode:"VIEW"}).addClass(this.data.myClass("td")).style({flex:this.slot(function(colWidth){return colWidth?`1 0 ${colWidth}px`:`1 0 ${this.data.MIN_COLUMN_WIDTH_FALLBACK}px`})}).call(function(){prop.tableCellFormatter.format(this,prop.f?prop.f(objReturned):null,objReturned,prop)}).endContext()}]});
foam.CLASS({package:"foam.u2.table",name:"UnstyledTableView",extends:"foam.u2.table.TableComponentView",implements:["foam.mlang.Expressions"],mixins:["foam.u2.memento.Memorable"],requires:["foam.core.SimpleSlot","foam.comics.v2.DAOControllerConfig","foam.dao.ProxyDAO","foam.nanos.column.TableColumnOutputter","foam.u2.CheckBox","foam.u2.layout.Rows","foam.u2.layout.Cols","foam.u2.stack.StackBlock","foam.u2.table.TableHeaderComponent","foam.u2.tag.Image","foam.u2.view.EditColumnsView","foam.u2.view.LazyScrollManager","foam.u2.view.OverlayActionListView"],exports:["columns","colWidthUpdated","config","currentMemento_ as memento","nestedPropsAndIndexes","props","propertyNamesToQuery","selectedColumnsWidth","selectedObjects","selection"],imports:["auth?","config? as importedConfig","filteredTableColumns?","memento","stack?","selection? as importSelection"],constants:[{type:"Int",name:"MIN_COLUMN_WIDTH_FALLBACK",value:100},{type:"Int",name:"EDIT_COLUMNS_BUTTON_CONTAINER_WIDTH",value:60},{type:"Int",name:"CHECKBOX_CONTAINER_WIDTH",value:42},{type:"Char",name:"DESCENDING_ORDER_CHAR",value:"-"},{type:"Char",name:"ASCENDING_ORDER_CHAR",value:"+"}],properties:[{class:"Class",name:"of"},{class:"foam.dao.DAOProperty",name:"data",postSet:function(_,data){if(!this.of&&data)this.of=data.of}},{class:"FObjectProperty",of:"foam.comics.v2.DAOControllerConfig",name:"config",factory:function(){if(this.importedConfig)return this.importedConfig;return this.DAOControllerConfig.create({dao:this.data})}},{name:"selection",expression:function(importSelection){return importSelection||null}},{name:"order"},{name:"columns_",factory:function(){return[]}},{name:"allColumns",},{name:"selectedColumnNames",memorable:true,expression:function(columns,of){var ls=JSON.parse(localStorage.getItem(of.id))?.map(c=>foam.Array.isInstance(c)?c[0]:c);return ls||columns},adapt:function(_,n){return foam.Array.isInstance(n)?n:n.split(",")}},{name:"selectedColumnsWidth",factory:function(){var local={};JSON.parse(localStorage.getItem(this.of.id))?.map(c=>{foam.Array.isInstance(c)?local[c[0]]=c[1]:local[c]=undefined});return local}},{class:"Boolean",name:"colWidthUpdated",},{name:"columns",expression:function(of,allColumns){if(!of)return[];var tc=of.getAxiomByName("tableColumns");return tc?tc.columns:allColumns}},{class:"FObjectArray",of:"foam.core.Action",name:"contextMenuActions",},{class:"Boolean",name:"editColumnsEnabled",value:true,},{class:"Boolean",name:"disableUserSelection",value:false,},{name:"restingIcon",value:"/images/resting-arrow.svg"},{name:"ascIcon",value:"/images/up-arrow.svg"},{name:"descIcon",value:"/images/down-arrow.svg"},{type:"Boolean",name:"showHeader",value:true,},{class:"Boolean",name:"multiSelectEnabled",},{class:"Map",name:"selectedObjects",},{name:"idsOfObjectsTheUserHasInteractedWith_",factory:function(){return{}}},{name:"checkboxes_",factory:function(){return{}}},{class:"Boolean",name:"togglingCheckBoxes_",},{class:"Boolean",name:"allCheckBoxesEnabled_",},{class:"Int",name:"tableWidth_",expression:function(props,colWidthUpdated,multiSelectEnabled,editColumnsEnabled){var self=this;var base=0;if(this.multiSelectEnabled)base+=this.CHECKBOX_CONTAINER_WIDTH;if(this.editColumnsEnabled)base+=this.EDIT_COLUMNS_BUTTON_CONTAINER_WIDTH;return this.columns_.reduce((acc,col)=>{var width=this.selectedColumnsWidth[self.columnHandler.propertyNamesForColumnArray(col)];return acc+(width||this.columnHandler.returnPropertyForColumn(this.props,this.of,col,"tableWidth")||this.MIN_COLUMN_WIDTH_FALLBACK)},base)+"px"}},{name:"isColumnChanged",class:"Boolean",value:false,},{name:"outputter",factory:function(){return this.TableColumnOutputter.create()}},{name:"props",expression:function(of,columns_){return this.returnPropertiesForColumns(this,columns_)}},{name:"updateValues",class:"Boolean",value:false,},"currentMemento_",{name:"propertyNamesToQuery",expression:function(props){return this.columnHandler.returnPropNamesToQuery(props)}},{class:"Boolean",name:"canObjBeBuildFromProjection",value:undefined,expression:function(props){for(var p of props){if(p.property.tableCellFormatter&&!p.property.cls_.hasOwnProperty("tableCellFormatter")){return false}if(!foam.lookup(p.property.cls_.id)){return false}}return true}},{name:"nestedPropsAndIndexes",expression:function(propertyNamesToQuery){return this.columnHandler.buildPropNameAndIndexArray(propertyNamesToQuery)}},{name:"groupBy",description:"Property that stores the current column that the table is being grouped by"},{class:"Boolean",name:"showPagination",value:true},"tableEl_","scrollEl_",["tableHeadHeight",52]],methods:[function sortBy(column){var isNewOrderDesc=this.order===column;this.order=isNewOrderDesc?this.DESC(column):column;if(!this.memento||this.memento.head.length==0)return;var columns=this.memento.head.split(",");var mementoColumn=columns.find(c=>this.returnMementoColumnNameDisregardSorting(c)===column.name);var orderChar=isNewOrderDesc?this.DESCENDING_ORDER_CHAR:this.ASCENDING_ORDER_CHAR;if(!mementoColumn){columns.push(column.name+orderChar)}else{var index=columns.indexOf(mementoColumn);columns[index]=column.name+orderChar}this.memento.head=columns.join(",")},function groupByCol(column){this.groupBy=column},function updateColumns(){this.updateLocalStorage();this.isColumnChanged=!this.isColumnChanged},async function render(){var view=this;var nextViewMemento;const asyncRes=await this.filterUnpermitted(view.of.getAxiomsByClass(foam.core.Property));this.allColumns=!view.of?[]:[].concat(asyncRes.map(a=>a.name),view.of.getAxiomsByClass(foam.core.Action).map(a=>a.name).filter(a=>view.of.getAxiomByName("tableColumns")?view.of.getAxiomByName("tableColumns").columns.includes(a):false));this.editColumnsEnabled$.sub(this.updateColumns_);this.selectedColumnNames$.sub(this.updateColumns_);this.isColumnChanged$.sub(this.updateColumns_);this.updateColumns_();this.onDetach(this.colWidthUpdated$.sub(this.updateLocalStorage));if(view.editColumnsEnabled)var editColumnView=foam.u2.view.EditColumnsView.create({data:view},this);if(this.filteredTableColumns$){this.onDetach(this.filteredTableColumns$.follow(this.columns_$.map(cols=>this.columnHandler.mapArrayColumnsToArrayOfColumnNames(this.filterColumnsThatAllColumnsDoesNotIncludeForArrayOfColumns(this,cols)))))}this.start(this.Rows).enableClass(this.myClass("full-height"),this.showPagination$).start("",{},this.tableEl_$).addClass(this.myClass("table-wrapper")).start().addClass(this.myClass()).addClass(this.myClass(this.of.id.replace(/\./g,"-"))).start().addClass(this.myClass("thead")).style({"min-width":this.tableWidth_$}).show(this.showHeader$).add(this.slot(function(columns_){view.props=this.returnPropertiesForColumns(view,columns_);view.updateValues=!view.updateValues;return this.E().addClass(view.myClass("tr")).callIf(view.multiSelectEnabled,function(){var slot=view.SimpleSlot.create();this.start().addClass(view.myClass("th")).tag(view.CheckBox,{},slot).style({width:`${this.CHECKBOX_CONTAINER_WIDTH}px`,"min-width":`${this.CHECKBOX_CONTAINER_WIDTH}px`}).end();view.onDetach(slot.value.dot("data").sub(function(_,__,___,newValueSlot){var checked=newValueSlot.get();view.allCheckBoxesEnabled_=checked;if(checked){view.selectedObjects={};view.data.select(function(obj){view.selectedObjects[obj.id]=obj})}else{view.selectedObjects={}}view.togglingCheckBoxes_=true;Object.keys(view.checkboxes_).forEach(function(key){view.checkboxes_[key].data=checked});view.togglingCheckBoxes_=false}))}).forEach(columns_,function([col,overrides]){this.tag(view.TableHeaderComponent,{data:view,col:col,overrides:overrides})}).call(function(){this.start().addClass(view.myClass("th")).style({flex:`0 0 ${view.EDIT_COLUMNS_BUTTON_CONTAINER_WIDTH}px`,"min-width":view.EDIT_COLUMNS_BUTTON_CONTAINER_WIDTH,"text-align":"unset!important;"}).callIf(view.editColumnsEnabled,function(){this.addClass(view.myClass("th-editColumns")).on("click",function(e){editColumnView.parentId=this.id;if(!editColumnView.selectColumnsExpanded)editColumnView.selectColumnsExpanded=!editColumnView.selectColumnsExpanded}).tag(view.Image,{data:"/images/Icon_More_Resting.svg"}).addClass(view.myClass("vertDots")).addClass(view.myClass("noselect"))}).end()})})).end().callIf(view.editColumnsEnabled,function(){this.add(editColumnView)}).start().addClass(view.myClass("tbody")).tag(view.LazyScrollManager,{data$:view.data$,order$:view.order$,rowView:{class:"foam.u2.table.UnstyledTableRow",data:view},groupHeaderView:{class:"foam.u2.table.UnstyledTableGroup",data:view},rootElement:this.tableEl_,ctx:view,prepDAO:view.prepDAO,groupBy$:view.groupBy$,offsetTop:view.tableHeadHeight},view.scrollEl_$).end().end().end().add(this.slot(showPagination=>{var buttonStyle={label:"",buttonStyle:"TERTIARY",size:"SMALL"};return showPagination?this.E().start(view.Cols).addClass(view.myClass("nav")).style({"justify-content":"flex-end"}).startContext({data:view.scrollEl_}).start(view.Cols).style({gap:"4px","box-sizing":"border-box"}).start("").add(view.scrollEl_$.dot("topRow")).addClass(this.myClass("counters")).end().add("-").start("").add(view.scrollEl_$.dot("bottomRow")).addClass(this.myClass("counters")).end().start().addClass(view.myClass("separator")).translate(this.cls_.id+".MESSAGE_OF",this.MESSAGE_OF).end().add(view.scrollEl_.daoCount$).end().start(view.scrollEl_.FIRST_PAGE,{...buttonStyle,themeIcon:"first"}).addClass(view.myClass("buttons")).end().start(view.scrollEl_.PREV_PAGE,{...buttonStyle,themeIcon:"back"}).addClass(view.myClass("buttons")).end().start(view.scrollEl_.NEXT_PAGE,{...buttonStyle,themeIcon:"next"}).addClass(view.myClass("buttons")).end().start(view.scrollEl_.LAST_PAGE,{...buttonStyle,themeIcon:"last"}).addClass(view.myClass("buttons")).end().endContext().end():this.E()})).end().end();this.onDetach(this.updateValues$.sub(this.scrollEl_.refresh))},{name:"prepDAO",code:function(dao,ctx){return ctx.returnRecords(ctx.of,dao,ctx.propertyNamesToQuery,ctx.canObjBeBuildFromProjection)}},{name:"getActionsForRow",code:function(obj){var actions={};var actionsMerger=action=>{actions[action.name]=action};if(obj?.cls_){obj.cls_.getAxiomsByClass(foam.core.Action).forEach(actionsMerger)}else{console.error("FObject is missing cls_",obj)}this.contextMenuActions.forEach(actionsMerger);return actions}}],listeners:[function resetColWidths(){this.selectedColumnsWidth={};for(var s of this.selectedColumnNames){this.selectedColumnsWidth[s]=this.columnHandler.returnPropertyForColumn(this.props,this.of,s,"tableWidth")||null}},{name:"updateLocalStorage",isMerged:true,mergeDelay:5e3,code:function(){localStorage.removeItem(this.of.id);localStorage.setItem(this.of.id,JSON.stringify(this.selectedColumnNames.map(c=>{var name=foam.String.isInstance(c)?c:c.name;var size=this.selectedColumnsWidth[name]==undefined?undefined:this.selectedColumnsWidth[name];return[name,size]})))}},{name:"updateColumns_",isFramed:true,code:function(){if(!this.of)return[];var cols=this.editColumnsEnabled?this.selectedColumnNames:this.columns;Promise.all(this.filterColumnsThatAllColumnsDoesNotIncludeForArrayOfColumns(this,cols).map(c=>foam.Array.isInstance(c)?c:[c,null])).then(columns=>this.columns_=columns)}}]});
foam.CLASS({package:"foam.u2.table",name:"TableViewPropertyRefinement",refines:"foam.core.Property",properties:[{class:"Boolean",name:"columnHidden"},{class:"Boolean",name:"columnPermissionRequired"}]});
foam.CLASS({package:"foam.u2.table",name:"PropertyColumnMapping",properties:[{name:"fullPropertyName",class:"String"},{name:"property",class:"FObjectProperty",of:"Property"}]});
foam.CLASS({package:"foam.u2.table",name:"TableHeaderComponent",extends:"foam.u2.table.TableComponentView",imports:["colWidthUpdated?","props","selectedColumnsWidth?"],messages:[{name:"TOOLTIP",message:"Drag to Resize"}],properties:[{class:"Boolean",name:"showResize"},{class:"Int",name:"colWidth",factory:function(){return this.selectedColumnsWidth&&this.selectedColumnsWidth[this.propName]?this.selectedColumnsWidth[this.propName]:this.columnHandler.returnPropertyForColumn(this.props,this.data.of,[this.col,this.overrides],"tableWidth")},postSet:function(o,n){this.updateWidths(n)}},{name:"col",},{name:"overrides",},{class:"Boolean",name:"resizeable",value:true},"propName","oldX_","oldCW_",["isDragging_",false],"dragImg_"],methods:[function render(){var self=this;var view=this.data;this.propName=this.columnHandler.propertyNamesForColumnArray(this.col);var found=this.props.find(p=>p.fullPropertyName===self.propName);var prop=found?found.property:this.data.of.getAxiomByName(self.propName);var isFirstLevelProperty=this.columnHandler.canColumnBeTreatedAsAnAxiom(this.col)?true:this.col.indexOf(".")===-1;if(!prop)return;this.dragImg_=document.createElement("img");this.dragImg_.src="data:image/gif;base64,R0lGODlhAQABAAAAACH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==";var colData=this.columnConfigToPropertyConverter.returnColumnHeader(this.data.of,this.col);var colHeader=(colData.colPath.length>1?"../":"")+(colData.colLabel||colData.colPath.slice(-1)[0]);var colTooltip=colData.colPath.join("/");this.addClass(view.myClass("th")).on("mouseenter",this.onMouseEnter).on("mouseleave",this.onMouseLeave).addClass(view.myClass("th-"+prop.name)).style({"align-items":"center",display:"flex",flex:this.slot(function(colWidth){return colWidth?`1 0 ${colWidth}px`:`1 0 ${this.data.MIN_COLUMN_WIDTH_FALLBACK}px`}),"justify-content":"space-between","word-wrap":"break-word"}).start().style({display:"flex",overflow:"hidden"}).start("",{tooltip:colTooltip}).addClass("h600").style({overflow:"hidden","text-overflow":"ellipsis"}).add(colHeader).end().callIf(isFirstLevelProperty&&prop.sortable,function(){var currArrow=view.restingIcon;this.on("click",function(e){view.sortBy(prop)}).callIf(prop.label!=="",function(){this.start().start("img").style({"max-width":"initial"}).attr("src",this.slot(function(view$order){var order=view$order;if(prop===order){currArrow=view.ascIcon}else{if(view.Desc.isInstance(order)&&order.arg1===prop)currArrow=view.descIcon}return currArrow},view.order$)).end().end()})}).end().startContext({data:this}).start(this.DRAG_TO_RESIZE,{buttonStyle:"TERTIARY",themeIcon:"drag",size:"SMALL"}).addClass(this.data.myClass("resizeButton")).enableClass(this.data.myClass("resizeCursor"),this.showResize$).attrs({draggable:"true"}).on("dragstart",self.dragStart.bind(self)).on("drag",self.drag.bind(self)).on("dragend",self.dragEnd.bind(self)).show(this.showResize$).end().endContext()}],listeners:[{name:"dragStart",code:function(evt){this.isDragging_=true;evt.dataTransfer.effectAllowed="none";evt.dataTransfer.dropEffect="none";evt.dataTransfer.setDragImage(this.dragImg_,0,0);this.oldX_=evt.clientX;this.oldCW_=this.colWidth||this.data.MIN_COLUMN_WIDTH_FALLBACK}},{name:"drag",code:function(evt){evt.preventDefault();var w=this.oldCW_+evt.clientX-this.oldX_;if(w>this.data.MIN_COLUMN_WIDTH_FALLBACK){this.colWidth=w}}},{name:"dragEnd",code:function(evt){this.drag(evt);this.isDragging_=false;this.showResize=false}},function onMouseEnter(){this.showResize=true},function onMouseLeave(){if(this.isDragging_)return;this.showResize=false},{name:"updateWidths",isFramed:true,code:function(width){if(!this.selectedColumnsWidth$||!this.colWidthUpdated$)return;this.selectedColumnsWidth[this.propName]=width;this.colWidthUpdated=!this.colWidthUpdated}}],actions:[{name:"DragToResize",label:"",toolTip:"Drag to resize",isAvailable:function(resizeable){return resizeable},code:function(){}}]});
foam.CLASS({package:"foam.u2.memento",name:"Memento",properties:[{name:"memento_",},{name:"obj",},{name:"props",factory:function(){return this.obj.cls_.getAxiomsByClass(foam.core.Property).filter(p=>p.memorable)}},{class:"String",name:"str",displayWidth:100,postSet:function(_,s){var bs=[];s=this.addRouteKeys(s);if(s){bs=this.createBindings(s)}function consumeBinding(k){for(var i=0;i<bs.length;i++){var kv=bs[i];if(kv[0]==k){bs.splice(i,1);return kv[1]}}}this.props.forEach(p=>{var value=consumeBinding(p.shortName||p.name);if(!!value)this.obj[p.name]=value});this.tailStr=this.encodeBindings(bs)}},{class:"Boolean",name:"shouldDetach"},{class:"FObjectArray",of:"foam.core.FObject",name:"tails",},{name:"tail",},{name:"tailStr",postSet:function(_,s){if(this.tail)this.tail.str=s}},{name:"usedStr",factory:function(){return this.toString()}}],methods:[function init(){if(!this.obj)return;this.props.forEach(p=>{this.obj.slot(p.name).sub(this.update)});if(this.memento_){this.memento_.tails.push(this);this.memento_.tail=this;this.str=this.memento_.tailStr}},function createBindings(s){let arr=[];s.split(/&(?=[^\}]*(?:\{|$))/).forEach(p=>{var[k,v]=p.split(/=(.*)/,2);arr.push([k,v])});return arr},function getBoundNames(set){if(this.obj){this.props.forEach(p=>set[p.shortName||p.name]=true);if(this.tail)this.tail.getBoundNames(set)}},function addRouteKeys(s){if(s&&s.indexOf("=")==-1)s+="?";var i=s.indexOf("?");if(i!=-1){var route=s.substring(0,i).split("/");s=s.substring(i+1);s=route.map(p=>"route="+p).join("&")+(s?"&"+s:"")}return s},function encodeBindings(bs){var s="";bs.forEach(b=>{if(s)s+="&";s+=b[0]+"="+b[1]});return s},function toString(encoded,opt_limit){var e=encoded||this.encode(opt_limit);var s=e.route;if(e.params){if(s)s+="?";s+=e.params}return s},function encode(opt_limit){var s="",route="",hasRoute=false,set={};if(this.tail)this.tail.getBoundNames(set);if(this.obj)this.props.forEach(p=>{var value=this.obj[p.name];if(p.name==="route"||p.shortName==="route"){route=this.obj[p.name];hasRoute=true}else{if(this.obj[p.name]||set[p.shortName||p.name]){if(s)s+="&";var val=this.obj[p.name];if(val&&this.cls_.isInstance(val))val=`{${val.usedStr}}`;if(val===undefined)val="";s+=(p.shortName||p.name)+"="+val}}});if(this.tail&&this.tail!=opt_limit){var e2=this.tail.encode();this.tail.usedStr=this.tail.toString(e2);var s2=e2.params;if(e2.route){if(hasRoute)route+="/";route+=e2.route}if(s2){if(s){s=s+"&"+s2}else{s=s2}}}return{route:route,params:s}}],listeners:[function removeMementoTail(){console.log("Detaching tail ",this.obj?.cls_.name,this.tailStr);this.tail=null;this.tails=[];this.tailStr=undefined;this.update()},{name:"update",isMerged:true,mergeDelay:32,code:function(){if(this.memento_){if(this.memento_.tails.length>1&&this.memento_.tail!=this){this.memento_.tail=this}this.memento_.update()}else{this.usedStr=this.toString()}}}]});
foam.CLASS({package:"foam.u2.memento",name:"WindowHashMemento",extends:"foam.u2.memento.Memento",imports:["window"],properties:[{class:"Boolean",name:"feedback_"}],methods:[function init(){this.SUPER();this.onHashChange();this.window.onpopstate=this.onHashChange;this.usedStr$.sub(this.onMementoChange)},function deFeedback(fn){if(this.feedback_)return;this.feedback_=true;try{fn()}catch(x){}this.feedback_=false}],listeners:[{name:"onHashChange",code:function(){this.deFeedback(()=>{this.str=decodeURI(this.window.location.hash.substring(1))})}},{name:"onMementoChange",code:function(){this.deFeedback(()=>this.window.location.hash="#"+this.usedStr)}}]});
foam.CLASS({package:"foam.u2.memento",name:"MemorablePropertyRefinement",refines:"foam.core.Property",properties:[{class:"Boolean",name:"memorable"}]});
foam.CLASS({package:"foam.u2.memento",name:"Memorable",requires:["foam.u2.memento.Memento","foam.u2.memento.WindowHashMemento"],imports:["memento_? as parentMemento_"],exports:["memento_"],properties:[{name:"memento_",hidden:true,initObject:function(obj){obj.memento_},factory:function(){return this.parentMemento_?this.Memento.create({obj:this,memento_:this.parentMemento_},this):this.WindowHashMemento.create({obj:this},this)}}]});foam.INTERFACE({package:"foam.util.retry",name:"RetryStrategy",methods:[{name:"getMaxRetry",type:"Integer"},{name:"getRetryDelay",type:"Long",args:["Context x"]},{name:"canRetry",type:"Boolean",args:["Context x"]}]});
foam.CLASS({package:"foam.util.retry",name:"NoRetryStrategy",implements:["foam.util.retry.RetryStrategy"],methods:[{name:"getMaxRetry",},{name:"getRetryDelay",},{name:"canRetry",}]});
foam.CLASS({package:"foam.util.retry",name:"SimpleRetryStrategy",implements:["foam.util.retry.RetryStrategy"],properties:[{class:"Int",name:"maxRetry"},{class:"Long",name:"retryDelay"}],methods:[{name:"getRetryDelay",args:["Context x"],},{name:"canRetry",}]});
foam.CLASS({package:"foam.util.retry",name:"BackoffRetryStrategy",extends:"foam.util.retry.SimpleRetryStrategy",properties:[{class:"Int",name:"factorBase",value:2}],methods:[{name:"getRetryDelay",}]});
foam.CLASS({package:"foam.util.retry",name:"RetryForeverStrategy",extends:"foam.util.retry.SimpleRetryStrategy",properties:[{name:"maxRetry",}],methods:[{name:"canRetry",}]});
foam.CLASS({package:"foam.util.retry",name:"RetryUntilStrategy",extends:"foam.util.retry.RetryForeverStrategy",properties:[{class:"DateTime",name:"until"}],methods:[{name:"canRetry",}]});
foam.CLASS({package:"foam.util.retry",name:"RetryStrategyFactory",properties:[{class:"FObjectProperty",name:"prototype"}],methods:[{name:"create",args:["Context x"],type:"Object",}]});
foam.CLASS({package:"foam.util.retry",name:"RetryLimitReachedException",extends:"foam.core.FOAMException",});
foam.CLASS({package:"foam.u2.view",name:"DateChoiceView",extends:"foam.u2.view.DayChoiceView",css:`
^ {
padding: 0.28em;
width: 4ch;
}
`});
foam.CLASS({package:"foam.u2.view",name:"DayOfMonthView",extends:"foam.u2.view.MultiChoiceView",properties:[{class:"foam.u2.ViewSpec",name:"choiceView",value:{class:"foam.u2.view.DateChoiceView"}},{name:"maxSelected",value:31},{name:"showMinMaxHelper",value:false},{name:"numberColumns",value:7}],methods:[function init(){this.SUPER();var days=[];for(var i=1;i<=31;i++)days.push(i);this.choices=days}]});
foam.CLASS({package:"foam.u2.view",name:"DayOfWeekView",extends:"foam.u2.view.MultiChoiceView",requires:["foam.time.DayOfWeek"],css:`
^flexer > div {
width: fit-content !important;
}
`,properties:[{class:"foam.u2.ViewSpec",name:"choiceView",value:{class:"foam.u2.view.DayChoiceView"}},{name:"maxSelected",value:7},{name:"showMinMaxHelper",value:false},{name:"numberColumns",value:7}],methods:[function init(){this.SUPER();this.choices=this.DayOfWeek.VALUES.map(v=>[v,v.shortName])}]});
foam.CLASS({package:"foam.u2.view",name:"DayChoiceView",extends:"foam.u2.view.CardSelectView",css:`
^ {
background-color: /*%WHITE%*/ #ffffff;
border: 1px solid /*%GREY3%*/ #b2b6bd;
border-radius: 4px;
padding: 8px 16px;
transition: all 0.2s ease;
width: 8ch;
}
^:hover {
cursor: pointer;
}
^selected {
background-color: /*%PRIMARY3%*/ #406dea;
border-color: /*%PRIMARY3%*/ #406dea;
color: /*%WHITE%*/ #ffffff;
line-height: 1.5;
}
`,methods:[function render(){this.addClass().enableClass(this.myClass("selected"),this.isSelected$).enableClass(this.myClass("disabled"),this.isDisabled$).enableClass(this.myClass("selected-disabled"),this.slot((isSelected,isDisabled)=>{return isSelected&&isDisabled})).on("click",this.onClick).add(this.label).enableClass("h600",this.isSelected$)}]});
foam.CLASS({package:"foam.core",name:"FOAMExceptionTestTestException",extends:"foam.core.FOAMException",properties:[{name:"exceptionMessage",value:"ExceptionMessage {{message}}, ErrorCode: {{errorCode}}"}],});foam.INTERFACE({package:"foam.core",name:"Identifiable",methods:[{name:"getPrimaryKey",type:"Any"}]});
foam.CLASS({package:"foam.net",name:"IPSupport",methods:[{name:"getRemoteIp",args:[{name:"x",type:"Context"}],type:"String",},{name:"ip2long",args:[{name:"ip",type:"String"}],type:"Long",},{name:"long2ip",args:[{name:"ip",type:"Long"}],type:"String",}]});
foam.CLASS({package:"foam.box",name:"AbstractSkeleton",implements:["foam.box.Skeleton"],abstract:true,methods:[{name:"getMessageX",type:"Context",args:[{name:"msg",type:"foam.box.Message"}],},{name:"tobyte",type:"Byte",args:[{type:"Object",name:"o"}],},{name:"todouble",type:"Double",args:[{type:"Object",name:"o"}],},{name:"tofloat",type:"Float",args:[{type:"Object",name:"o"}],},{name:"toint",type:"Integer",args:[{type:"Object",name:"o"}],},{name:"tolong",type:"Long",args:[{type:"Object",name:"o"}],},{name:"toshort",type:"Short",args:[{type:"Object",name:"o"}],}]});
foam.CLASS({package:"foam.demos.heroes",name:"Hero",properties:[{class:"Int",name:"id",final:true},{class:"String",name:"name",view:{class:"foam.u2.TextField",onKey:true}},{class:"Boolean",name:"starred"}]});foam.INTERFACE({package:"com.google.auth",name:"TokenVerifier",methods:[{name:"verify",type:"String",args:[{name:"token",type:"String"}]}]});
foam.CLASS({package:"foam.box.sf",name:"SFBOX",extends:"foam.box.sf.SF",implements:["foam.box.Box"],properties:[{class:"String",name:"delegateNspecId"},{class:"Proxy",of:"foam.box.Box",name:"delegate",transient:true}],methods:[{name:"send",},{name:"submit",args:"Context x, SFEntry entry",},{name:"createDelegate",}]});
foam.CLASS({package:"foam.box.sf",name:"SFSink",extends:"foam.box.sf.SF",implements:["foam.dao.Sink"],properties:[{class:"String",name:"delegateNspecId"},{class:"Proxy",of:"foam.dao.Sink",name:"delegate",transient:true}],methods:[{name:"put",code:function(){},},{name:"submit",args:"Context x, SFEntry entry",},{name:"createDelegate",},{name:"remove",code:function(){},},{name:"eof",code:function(){},},{name:"reset",code:function(){},}]});
foam.CLASS({package:"foam.box.sf",name:"SFDAO",extends:"foam.box.sf.SF",implements:["foam.dao.DAO"],properties:[{class:"String",name:"delegateNspecId"},{class:"Proxy",of:"foam.dao.DAO",name:"delegate",transient:true}],methods:[{name:"put",code:function(){},},{name:"put_",code:function(){},},{name:"submit",args:"Context x, SFEntry entry",},{name:"createDelegate",},{name:"remove",code:function(){},},{name:"remove_",code:function(){},},{name:"find",code:function(){},},{name:"find_",code:function(){},},{name:"select",code:function(){},},{name:"select_",code:function(){},},{name:"removeAll",code:function(){},},{name:"removeAll_",code:function(){},},{name:"listen",code:function(){},},{name:"listen_",code:function(){},},{name:"pipe",code:function(){},},{name:"pipe_",code:function(){},},{name:"where",code:function(){},},{name:"orderBy",code:function(){},},{name:"skip",code:function(){},},{name:"limit",code:function(){},},{name:"inX",code:function(){},},{name:"cmd",code:function(){},},{name:"cmd_",code:function(){},},{name:"getOf",code:function(){},}]});
foam.CLASS({package:"foam.box.sf",name:"DUGSFRuleAction",extends:"foam.nanos.dig.DUGRuleAction",properties:[{class:"String",name:"sfId"}],methods:[{name:"getDelegateSink",args:"X agencyX, foam.nanos.ruler.Rule rule",type:"foam.dao.Sink",}]});
foam.CLASS({package:"foam.box.sf",name:"DUGSFRule",extends:"foam.nanos.dig.DUGRule",properties:[{class:"String",name:"sfId"},{name:"asyncAction",section:"dugInfo",view:{class:"foam.u2.tag.TextArea"},}]});
foam.CLASS({package:"foam.box.sf",name:"SFEntry",extends:"foam.nanos.medusa.MedusaEntry",properties:[{class:"FObjectProperty",of:"foam.core.FObject",name:"object",storageTransient:false},{class:"Long",name:"scheduledTime",storageTransient:true,clusterTransient:true,value:0},{class:"FObjectProperty",of:"foam.box.sf.SF",name:"sf",storageTransient:true,clusterTransient:true},{name:"retryStrategy",class:"FObjectProperty",of:"foam.util.retry.RetryStrategy",storageTransient:true,clusterTransient:true}]});
foam.CLASS({package:"foam.box.sf",name:"SFManager",implements:["foam.nanos.NanoService"],properties:[{class:"Object",name:"prorityQueue",javaCloneProperty:"//noop",},{name:"sfs",class:"Map",javaCloneProperty:"//noop",},{class:"String",name:"threadPoolName",value:"threadPool"},{name:"logger",class:"FObjectProperty",of:"foam.nanos.logger.Logger",visibility:"HIDDEN",transient:true,javaCloneProperty:"//noop",}],methods:[{name:"enqueue",args:"SFEntry e",},{name:"initForwarder",args:"Context x",},{name:"start",}],axioms:[{name:"javaExtras",buildJavaClass:function(cls){cls.extras.push(foam.java.Code.create({data:`
private final ReentrantLock lock_ = new ReentrantLock();
private final Condition notAvailable_ = lock_.newCondition();
`}))}}]});
foam.CLASS({package:"foam.box.sf",name:"SF",abstract:true,tableColumns:["id","filePrefix","fileName","fileCapacity","inFlightLimit"],properties:[{class:"String",name:"id"},{class:"String",name:"filePrefix",value:"../saf/"},{class:"String",name:"fileName"},{class:"Int",name:"fileCapacity",value:1024},{name:"retryStrategy",class:"FObjectProperty",of:"foam.util.retry.RetryStrategy",},{class:"Int",name:"timeWindow",units:"s",value:-1},{class:"Boolean",name:"ready",storageTransient:true,value:false,},{class:"Int",name:"inFlightLimit",value:1024},{class:"Object",name:"delegateObject",visibility:"HIDDEN",transient:true},{class:"Object",name:"nullDao",transient:true,visibility:"HIDDEN",},{class:"Object",name:"manager",transient:true,visibility:"HIDDEN",}],methods:[{name:"createWriteJournal",args:"String fileName",},{name:"forward",args:"SFEntry e",},{name:"storeAndForward",args:"FObject fobject",},{name:"successForward",args:"SFEntry e",},{name:"updateJournalOffsetAndForwardNext",args:"SFEntry e",},{name:"updateJournalOffset",args:"SFEntry e",},{name:"failForward",args:"SFEntry e, Throwable t",},{name:"submit",args:"Context x, SFEntry entry",},{name:"createDelegate",},{name:"initial",args:"Context x",},{name:"updateNextScheduledTime",args:"SFEntry e",},{name:"getStackTrace",args:"SFEntry e, Throwable t",},{name:"toFileName",args:"SFEntry entry",},{name:"getJournal",args:"String filename",},{name:"fetchJournal",args:"SFEntry entry",},{name:"getFileSuffix",args:"String filename",},{name:"getSimpleFilename",args:"String filename",},{name:"cleanEntryInfos",}],axioms:[{name:"javaExtras",buildJavaClass:function(cls){cls.extras.push(foam.java.Code.create({data:`
protected Logger logger_ = null;
protected volatile long entryCurStep_ = 0;
final protected AtomicLong entryIndex_ = new AtomicLong(0);
final protected Map<String, SFFileJournal> journalMap_ = new ConcurrentHashMap<String, SFFileJournal>();
final protected Object writeLock_ = new Object();
final protected Object onHoldListLock_ = new Object();
final protected AtomicBoolean isReady_ = new AtomicBoolean(false);
final protected List<SFEntry> onHoldList_ = new LinkedList<SFEntry>();
protected volatile int maxFileIndex_ = 0;
static private class TempDAO extends ProxyDAO {
public foam.core.ClassInfo getOf() {
return SFEntry.getOwnClassInfo();
}
protected List<SFEntry> list;
@Override
public FObject put_(X x, FObject obj) {
SFEntry entry = (SFEntry) obj;
list.add(entry);
return obj;
}
public TempDAO(X x, List<SFEntry> l) {
super(x, null);
this.list = l;
}
}
`}))}}]});
foam.CLASS({package:"foam.box.sf",name:"SFFileJournal",extends:"foam.dao.F3FileJournal",properties:[{class:"Long",name:"fileSize",},{class:"Boolean",name:"fileExist",},{class:"Long",name:"fileLastAccessTime",},{class:"Long",name:"fileOffset",}],methods:[{name:"put",type:"FObject",args:"Context x, String prefix, DAO dao, FObject obj",},{name:"createJournalFile",args:"",},{name:"calculateSize",args:"FObject obj",},{name:"replayFrom",args:"Context x, foam.dao.DAO dao, long offset",}]});
foam.CLASS({package:"foam.box.sf",name:"SFTestObject",extends:"foam.nanos.medusa.test.MedusaTestObject"});
foam.CLASS({package:"foam.box.sf",name:"SFException",});
foam.CLASS({package:"foam.box.sf",name:"SFMonitorDAO",extends:"foam.dao.ProxyDAO",properties:[{class:"FObjectProperty",name:"sfManager",of:"foam.box.sf.SFManager",}],methods:[{name:"find_",},{name:"select_",}]});
foam.CLASS({package:"foam.box.sf",name:"SFMonitor",extends:"foam.box.sf.SF",tableColumns:["id","ready","inFlightCount","inFlightLimit"],properties:[{class:"Int",name:"inFlightCount"},{class:"Boolean",name:"ready"},{class:"Long",name:"initialIndex"}],});
foam.CLASS({package:"foam.box.socket",name:"BoxHolder",properties:[{name:"box",class:"FObjectProperty",of:"foam.box.Box"},{name:"pm",class:"FObjectProperty",of:"foam.nanos.pm.PM"}]});
foam.CLASS({package:"foam.box.socket",name:"SocketConnectionBox",implements:["foam.box.Box","foam.core.ContextAgent"],constants:[{name:"REPLY_BOX_ID",value:"REPLY_BOX_ID",type:"String"}],properties:[{name:"key",class:"String"},{name:"host",class:"String"},{name:"port",class:"Int"},{name:"socket",class:"Object",visibility:"HIDDEN"},{name:"id",class:"String",},{name:"valid",class:"Object",visibility:"HIDDEN",},{name:"replyBoxes",class:"Map",visibility:"HIDDEN"},{name:"logger",class:"FObjectProperty",of:"foam.nanos.logger.Logger",visibility:"HIDDEN",transient:true,javaCloneProperty:"//noop",}],methods:[{name:"send",},{name:"execute",args:[{name:"x",type:"Context"}],},{name:"releaseHoldingThread",args:"Throwable t",synchronized:true,}]});
foam.CLASS({package:"foam.box.socket",name:"SocketConnectionReplyBox",implements:["foam.box.Box"],properties:[{name:"key",class:"String",transient:true},{name:"logger",class:"FObjectProperty",of:"foam.nanos.logger.Logger",visibility:"HIDDEN",transient:true,javaCloneProperty:"//noop",}],methods:[{name:"send",}]});
foam.CLASS({package:"foam.dao",name:"SlowDAO",extends:"foam.dao.ProxyDAO",properties:[{class:"Int",name:"delayMs"}],methods:[{name:"select_",},{name:"put_",},{name:"remove_",},{name:"removeAll_",},{name:"find_",}]});
foam.CLASS({package:"foam.dao",name:"JSONFormatParseDAO",extends:"foam.dao.ProxyDAO",methods:[{name:"put_",}]});
foam.CLASS({package:"foam.dao",name:"RemoveChildrenOnRemoveDAO",extends:"foam.dao.ProxyDAO",properties:[{class:"Object",name:"sourceKey",},{class:"Object",name:"targetKey",},{class:"String",name:"targetDAOKey"}],methods:[{name:"remove_",code:function(x,id){},}],axioms:[{buildJavaClass:function(cls){cls.extras.push(`
public RemoveChildrenOnRemoveDAO(foam.core.X x, foam.dao.DAO delegate, foam.core.PropertyInfo sourceKey, foam.core.PropertyInfo targetKey, String targetDAOKey) {
setSourceKey(sourceKey);
setTargetKey(targetKey);
setTargetDAOKey(targetDAOKey);
setDelegate(delegate);
}
`)}}]});
foam.CLASS({package:"foam.dao",name:"AbstractF3FileJournal",abstract:true,flags:["java"],properties:[{class:"Object",name:"line",},{class:"Object",name:"timeStamper",},{class:"FObjectProperty",of:"foam.nanos.logger.Logger",name:"logger",javaCloneProperty:"//noop"},{class:"String",name:"filename",required:true},{class:"Boolean",name:"multiLineOutput",value:false},{class:"Boolean",name:"createFile",value:true},{class:"Object",name:"reader",},{class:"Object",name:"writer",},{class:"Long",name:"lastUser"},{class:"Long",name:"lastTimestamp"}],methods:[{name:"put",type:"FObject",args:["Context x","String prefix","DAO dao","foam.core.FObject obj"],},{name:"writePut_",args:["Context x","CharSequence record","String c","String prefix"],},{name:"remove",type:"FObject",args:["Context x","String prefix","DAO dao","foam.core.FObject obj"],},{name:"writeRemove_",args:["Context x","CharSequence record","String prefix"],},{name:"write_",args:["CharSequence data"],},{name:"writeComment_",args:["Context x","foam.core.FObject obj"],},{name:"getEntry",type:"CharSequence",args:["BufferedReader reader"],},{name:"getParsingErrorMessage",type:"CharSequence",args:["String line"],},{name:"mergeFObject",type:"foam.core.FObject",args:["FObject oldFObject","FObject diffFObject"],},{name:"mergeProperty",args:["FObject oldFObject","FObject diffFObject","foam.core.PropertyInfo prop"],}]});
foam.CLASS({package:"foam.dao",name:"F3FileJournal",extends:"foam.dao.AbstractF3FileJournal",flags:["java"],implements:["foam.dao.Journal"],properties:[{class:"foam.dao.DAOProperty",name:"dao"},{class:"Boolean",name:"syncReplay"}],methods:[{name:"replay",args:[{name:"x",type:"Context"},{name:"dao",type:"foam.dao.DAO"}],}]});
foam.CLASS({package:"foam.dao",name:"ReadOnlyF3FileJournal",extends:"foam.dao.F3FileJournal",methods:[{name:"put",},{name:"remove",}]});
foam.CLASS({package:"foam.dao",name:"WriteOnlyJDAO",extends:"foam.dao.java.JDAO",properties:[{name:"delegate",class:"foam.dao.DAOProperty",}]});
foam.CLASS({package:"foam.dao",name:"WriteOnlyFileJournal",extends:"foam.dao.FileJournal",properties:[{name:"outputClassNames",class:"Boolean",value:false}],methods:[{name:"replay",}]});
foam.CLASS({package:"foam.dao",name:"WriteOnlyF3FileJournal",extends:"foam.dao.F3FileJournal",methods:[{name:"replay",},{name:"put",type:"FObject",args:["Context x","String prefix","DAO dao","foam.core.FObject obj"],}]});
foam.CLASS({package:"foam.dao",name:"PMDAO",extends:"foam.dao.ProxyDAO",implements:["foam.nanos.auth.EnabledAware","foam.nanos.boot.NSpecAware"],requires:["foam.nanos.pm.PM"],properties:[{name:"enabled",class:"Boolean",value:true},{name:"name",class:"String",},{name:"nSpec",class:"FObjectProperty",type:"foam.nanos.boot.NSpec"},{name:"classType",class:"Class",hidden:true},{name:"putName",class:"String",visibility:"RO"},{name:"findName",class:"String",visibility:"RO"},{name:"selectName",class:"String",visibility:"RO"},{name:"removeName",class:"String",visibility:"RO"},{name:"removeAllName",class:"String",visibility:"RO"},{name:"cmdName",class:"String",visibility:"RO"}],methods:[{name:"createPM",args:[{name:"x",type:"X"},{name:"op",type:"String"}],},{name:"log",args:[{name:"x",type:"X"},{name:"pm",type:"PM"}],},{name:"put_",},{name:"find_",},{name:"select_",},{name:"removeAll_",},{name:"cmd_",}]});
foam.CLASS({package:"foam.dao",name:"ORBRequest",flags:["java"],properties:[{name:"receiverObject",class:"FObjectProperty",},{name:"receiverObjectID",class:"String"},{name:"methodName",class:"String"},{name:"args",class:"Array"}]});
foam.CLASS({package:"foam.dao",name:"ORBitalDAO",extends:"foam.dao.ProxyDAO",flags:["java"],properties:[],methods:[{name:"cmd_",type:"Object",args:[{name:"x",type:"foam.core.X"},{name:"obj",type:"Object"}],}]});
foam.CLASS({package:"foam.nanos.actioncommand",name:"ActionCommand",properties:[{class:"String",name:"objectID",required:true},{class:"String",name:"actionName",required:true}]});
foam.CLASS({package:"foam.nanos.session",name:"LocalSettingSessionDAO",extends:"foam.dao.ProxyDAO",methods:[{name:"put_",},{name:"remove_",}]});
foam.CLASS({package:"foam.nanos.session",name:"SimpleSessionService",implements:["foam.nanos.session.SessionService"],imports:["AuthService auth","DAO localSessionDAO","DAO localUserDAO"],methods:[{name:"createSession",},{name:"createSessionWithTTL",},{name:"hasSPIDPermission",args:[{name:"x",type:"Context"},{name:"operation",type:"String"},{name:"userId",type:"Long"}],type:"Boolean",},{name:"expireSession",}]});
foam.CLASS({package:"foam.nanos.pool",name:"AbstractFixedThreadPool",abstract:true,extends:"foam.core.AbstractAgency",properties:[{class:"String",name:"prefix",value:"nanos"},{name:"threadsPerCore",class:"Int",value:8},{description:`Calculate total threads based on available cores.  Set minimum threads to avoid resource exhaustion in small VMs and small development hardware.`,class:"Int",name:"numberOfThreads",},{class:"Long",name:"queued"},{class:"Long",name:"executed"},{class:"Long",name:"executing"}]});
foam.CLASS({package:"foam.nanos.om",name:"OMLogger",extends:"foam.nanos.logger.AbstractLogger",properties:[{name:"foldManagerContextKey",class:"String",value:"omFoldManager"}],methods:[{name:"log",},{name:"info",},{name:"warning",},{name:"error",},{name:"debug",},{name:"combine",}]});
foam.CLASS({package:"foam.nanos.google.api.sheets",name:"GoogleSheetsApiService",implements:["foam.nanos.export.GoogleSheetsExport"],constants:[{name:"JSON_FACTORY",javaValue:`JacksonFactory.getDefaultInstance()`},{name:"DRIVE_FILE",javaValue:`Collections.singletonList(SheetsScopes.DRIVE_FILE)`},{name:"READ_AND_EDIT_ALL_SCOPES",javaValue:`Collections.singletonList(SheetsScopes.DRIVE)`},{name:"COLUMN_TITLES_ROW_INDEX",javaValue:`1`},{name:"NUMBER_FORMAT",javaValue:`"userEnteredFormat.numberFormat"`},{name:"DEFAULT_CURRENCY",javaValue:`"CAD"`}],methods:[{name:"populateWithDataSheetWithObj",args:[{name:"x",type:"Context"},{name:"fileId",type:"String"},{name:"obj",},{name:"metadata",type:"foam.nanos.export.GoogleSheetsPropertyMetadata[]"},{name:"extraConfig",type:"Object",}],},{name:"populateWithDataSheetWithId",args:[{name:"x",type:"Context"},{name:"fileId",type:"String"},{name:"listOfValues",},{name:"metadata",type:"foam.nanos.export.GoogleSheetsPropertyMetadata[]"},{name:"extraConfig",type:"Object",}],},{name:"createSheetAndPopulateWithData",type:"String",async:true,args:[{name:"x",type:"Context"},{name:"metadataObj",type:"foam.nanos.export.GoogleSheetsPropertyMetadata[]",},{name:"extraConfig",type:"foam.nanos.export.GoogleSheetsServiceConfig"}],},{name:"deleteSheet",args:[{name:"x",type:"Context"},{name:"sheetId",}],},{name:"createSheetByCopyingTemplate",async:true,args:[{name:"x",type:"Context"},{name:"metadataObj",type:"foam.nanos.export.GoogleSheetsPropertyMetadata[]",},{name:"extraConfig",type:"foam.nanos.export.GoogleSheetsServiceConfig"}],},{name:"retrieveTemplateData",args:[{name:"x",type:"Context"},{name:"of",class:"Class",},{name:"daoName",class:"String"},{name:"metadata",type:"foam.nanos.export.GoogleSheetsPropertyMetadata[]"}],},{name:"getFormatedValues",type:"Object",args:[{name:"x",type:"Context"},{name:"spreadsheetId",type:"String"},{name:"range",type:"String"}],},{name:"createAndExecuteBatchUpdateWithListOfValuesForCellsRange",args:[{name:"x",type:"Context"},{name:"sheetId",},{name:"values",},{name:"cellsRanges",}],},{name:"createSheetAndPopulateWithFrontEndData",type:"String",async:true,args:[{name:"x",type:"Context"},{name:"obj",},{name:"metadataObj",type:"foam.nanos.export.GoogleSheetsPropertyMetadata[]",},{name:"extraConfig",type:"Object",}],},{name:"createSheetByCopyingTemplateAndFronEndData",async:true,args:[{name:"x",type:"Context"},{name:"obj",},{name:"metadataObj",type:"foam.nanos.export.GoogleSheetsPropertyMetadata[]",},{name:"extraConfig",type:"foam.nanos.export.GoogleSheetsServiceConfig"}],}]});
foam.CLASS({package:"foam.lib",name:"ExternalPropertyPredicate",implements:["foam.lib.PropertyPredicate"],methods:[{name:"propertyPredicateCheck",}]});
foam.CLASS({package:"foam.lib",name:"StorageTransientPropertyPredicate",implements:["foam.lib.PropertyPredicate"],methods:[{name:"propertyPredicateCheck",}]});
foam.CLASS({package:"foam.lib",name:"ClusterPropertyPredicate",implements:["foam.lib.PropertyPredicate"],methods:[{name:"propertyPredicateCheck",}]});
foam.CLASS({package:"foam.lib.parse",name:"SymbolParser",implements:["foam.lib.parse.Parser"],properties:[{class:"Map",name:"symbols"},{class:"String",name:"symbolName"}],methods:[{name:"parse",type:"foam.lib.parse.PStream",args:[{name:"ps",type:"foam.lib.parse.PStream"},{name:"x",}],}]});
foam.CLASS({package:"foam.lib.parse",name:"Grammar",properties:[{class:"Map",name:"symbols",}],methods:[{name:"addSymbol",args:[{name:"symName",type:"String"},{name:"symParser",type:"Parser"}],},{name:"parse",type:"foam.lib.parse.PStream",args:[{name:"ps",type:"PStream"},{name:"parserX",type:"ParserContext"},{name:"optName",type:"String"}],},{name:"sym",args:[{name:"name",type:"String"}],type:"foam.lib.parse.Parser",},{name:"addAction",args:[{name:"name",type:"String"},{name:"action",type:"foam.lib.parse.Action"}],}]});foam.INTERFACE({package:"foam.lib.parse",name:"Action",constants:[{type:"Object",name:"NO_PARSE",javaValue:"new Object()"}],methods:[{name:"execute",args:[{name:"val",type:"Object"},{name:"x",type:"foam.lib.parse.ParserContext"}],type:"Object"}]});
foam.CLASS({package:"foam.lib.parse",name:"ActionParser",implements:["foam.lib.parse.Parser"],properties:[{class:"FObjectProperty",of:"foam.lib.parse.Parser",name:"parser"},{class:"FObjectProperty",of:"foam.lib.parse.Action",name:"action"}],methods:[{name:"parse",type:"foam.lib.parse.PStream",args:[{name:"ps",type:"foam.lib.parse.PStream"},{name:"x",}],}]});
foam.CLASS({package:"foam.lib.json",name:"UnknownFObjectArray",implements:["foam.lib.json.OutputJSON"],properties:[{class:"String",name:"json"}],methods:[{name:"outputJSON",args:[{name:"outputter",}],},{name:"formatJSON",args:[{name:"formatter",}],}]});foam.INTERFACE({package:"foam.lib.xml",name:"OutputXML",methods:[{name:"outputXML",args:[{name:"outputter",}]}]});
foam.CLASS({package:"foam.nanos.geocode",name:"GoogleMapsAddressComponent",properties:[{class:"String",name:"long_name",},{class:"String",name:"short_name",},{class:"StringArray",name:"types",}]});
foam.CLASS({package:"foam.nanos.geocode",name:"GoogleMapsCoordinates",properties:[{class:"Double",name:"lat",},{class:"Double",name:"lng",}]});
foam.CLASS({package:"foam.nanos.geocode",name:"GoogleMapsGeocodeResponse",properties:[{class:"FObjectArray",of:"foam.nanos.geocode.GoogleMapsGeocodeResult",name:"results",},{class:"String",name:"status",},{class:"String",name:"error_message",}]});
foam.CLASS({package:"foam.nanos.geocode",name:"GoogleMapsGeocodeResult",properties:[{class:"FObjectArray",of:"foam.nanos.geocode.GoogleMapsAddressComponent",name:"address_components",},{class:"String",name:"formatted_address",},{class:"FObjectProperty",of:"foam.nanos.geocode.GoogleMapsGeometry",name:"geometry",},{class:"String",name:"place_id",},{class:"StringArray",name:"types",}]});
foam.CLASS({package:"foam.nanos.geocode",name:"GoogleMapsGeometry",properties:[{class:"FObjectProperty",of:"foam.nanos.geocode.GoogleMapsBoundary",name:"bounds",},{class:"FObjectProperty",of:"foam.nanos.geocode.GoogleMapsCoordinates",name:"location",},{class:"String",name:"location_type",},{class:"FObjectProperty",of:"foam.nanos.geocode.GoogleMapsBoundary",name:"viewport",}]});
foam.CLASS({package:"foam.nanos.geocode",name:"GoogleMapsBoundary",properties:[{class:"FObjectProperty",of:"foam.nanos.geocode.GoogleMapsCoordinates",name:"northeast",},{class:"FObjectProperty",of:"foam.nanos.geocode.GoogleMapsCoordinates",name:"southwest",}]});
foam.CLASS({package:"foam.nanos.geocode",name:"GoogleMapsAddressParser",constants:{API_HOST_AUTOCOMPLETE:"https://maps.googleapis.com/maps/api/place/autocomplete/json?input=",API_HOST_PLACES:"https://maps.googleapis.com/maps/api/geocode/json?place_id="},methods:[{name:"buildHttpRequest",args:[{name:"builder",type:"java.lang.StringBuilder"}],type:"java.lang.StringBuilder",},{name:"buildURLString",args:[{class:"String",name:"paramValue"},{class:"String",name:"mapsUri"}],type:"java.lang.StringBuilder",},{name:"parseAddress",args:[{name:"x",type:"Context"},{name:"address",type:"String"},{name:"foamAddress",type:"foam.nanos.auth.Address"}],type:"foam.nanos.auth.Address",},{name:"constructAddress",args:[{name:"addressComponents",type:"foam.nanos.geocode.GoogleMapsAddressComponent[]"},{class:"String",name:"suite"},{name:"initialAddress",type:"foam.nanos.auth.Address"}],type:"foam.nanos.auth.Address",},{name:"getAddressComponent",args:[{class:"String",name:"type"},{name:"addressComponents",type:"foam.nanos.geocode.GoogleMapsAddressComponent[]"},{class:"Boolean",name:"shortName"}],type:"String",},{name:"getApiKey",type:"String",}]});
foam.CLASS({package:"foam.nanos.geocode",name:"GoogleMapsPlacesPredictions",properties:[{class:"String",name:"description",},{class:"String",name:"place_id",}]});
foam.CLASS({package:"foam.nanos.geocode",name:"GoogleMapsPlacesResponse",properties:[{class:"FObjectArray",of:"foam.nanos.geocode.GoogleMapsPlacesPredictions",name:"predictions",},{class:"String",name:"status",},{class:"String",name:"error_message",}]});
foam.CLASS({package:"foam.nanos.demo.relationship.test",name:"RelationshipTest",extends:"foam.nanos.test.Test",methods:[{name:"runTest",}]});
foam.CLASS({package:"foam.nanos.fs",name:"FileDataClearSink",extends:"foam.dao.ProxySink",methods:[{name:"put",args:[{name:"obj",type:"Object"},{name:"sub",type:"foam.core.Detachable"}],},{name:"remove",},{name:"eof",},{name:"reset",}]});
foam.CLASS({package:"foam.nanos.fs",name:"FileDataDAO",extends:"foam.dao.ProxyDAO",properties:[{class:"Long",name:"maxStringDataSize",value:1024*3}],methods:[{name:"put_",},{name:"select_",}]});
foam.CLASS({package:"foam.nanos.fs",name:"FileUpdateDecorator",extends:"foam.dao.ProxyDAO",methods:[{name:"put_",}]});
foam.CLASS({package:"foam.nanos.fs",name:"TempFileDAO",extends:"foam.dao.ProxyDAO",methods:[{name:"remove_",}]});
foam.CLASS({package:"foam.nanos.dig",name:"FieldNameMapGrammar",properties:[{class:"FObjectProperty",of:"foam.lib.parse.Grammar",name:"grammar",}],methods:[{name:"replaceFields",args:[{name:"data",type:"String"},{name:"fields",type:"Map"}],type:"String",}],});
foam.CLASS({package:"foam.lib.query",name:"TestModel",properties:[{class:"String",name:"name",shortName:"n",aliases:["fname","fn","first"]},{class:"Int",name:"age"},{class:"DateTime",name:"birthdate"}]});foam.ENUM({package:"foam.lib.query",name:"FooEnum",values:["FOO","BAR"]});
foam.CLASS({package:"foam.nanos.ruler",name:"RulerData",properties:[{class:"FObjectProperty",name:"o",},{class:"FObjectProperty",name:"n",},{class:"StringArray",name:"diff",},{class:"FObjectProperty",name:"user",},{class:"FObjectProperty",name:"realUser",},{class:"String",name:"spid",},{class:"DateTime",name:"dateTime"}]});
foam.CLASS({package:"foam.nanos.actioncommand",name:"ActionCommandDAO",extends:"foam.dao.ProxyDAO",methods:[{name:"cmd_",}]});
foam.CLASS({package:"foam.nanos.audit",name:"AuditDAO",extends:"foam.dao.ProxyDAO",properties:[{class:"Object",name:"outputter",}],methods:[{name:"formatMessage",type:"String",args:[{type:"FObject",name:"currentValue"},{type:"FObject",name:"newValue"}],},{name:"put_",},{name:"remove_",}]});
foam.CLASS({package:"foam.nanos.auth.email",name:"EmailVerificationDAO",extends:"foam.dao.ProxyDAO",properties:[{class:"FObjectProperty",of:"foam.nanos.auth.email.EmailTokenService",name:"emailToken"}],methods:[{name:"put_",}]});
foam.CLASS({package:"foam.dao",name:"FreezingDAO",extends:"foam.dao.ProxyDAO",methods:[{name:"find_",},{name:"select_",}]});
foam.CLASS({package:"foam.nanos.geocode",name:"GoogleMapsGeocodingDAO",extends:"foam.dao.ProxyDAO",messages:[{name:"INVALID_RESPONSE_ERROR_MSG",message:"Invalid response"},{name:"NOT_FOUND_ERROR_MSG",message:"Results not found"},{name:"GEOMETRY_ERROR_MSG",message:"Unable to determine latitude and longitude"}],constants:[{name:"API_HOST",type:"String",value:"https://maps.googleapis.com/maps/api/geocode/json?address="}],properties:[{class:"String",name:"apiKey"},{class:"Object",name:"prop",}],methods:[{name:"put_",}]});
foam.CLASS({package:"foam.dao.history",name:"HistoryDAO",extends:"foam.dao.ProxyDAO",messages:[{name:"CREATE_ERROR_MSG",message:"Unexpected error creating history record for"}],properties:[{class:"foam.dao.DAOProperty",name:"historyDAO"},{class:"foam.mlang.predicate.PredicateProperty",name:"putPredicate",factory:function(){return foam.mlang.predicate.True.create()},}],methods:[{name:"getUpdatedProperties",visibility:"protected",type:"PropertyUpdate[]",args:[{type:"Context",name:"x"},{type:"FObject",name:"currentValue"},{type:"FObject",name:"newValue"}],},{name:"put_",},{name:"remove_",}]});
foam.CLASS({package:"foam.dao",name:"UnreliableDAO",extends:"foam.dao.ProxyDAO",messages:[{name:"CANNOT_PERFORM_ERROR_MSG",message:"UnreliableDAO decided you are unlucky."}],properties:[{class:"Double",name:"errorRate",value:.5}],methods:[{name:"put_",},{name:"remove_",},{name:"select_",},{name:"removeAll_",}]});
foam.CLASS({package:"foam.nanos.auth",name:"UserPasswordHashingDAO",extends:"foam.dao.ProxyDAO",methods:[{name:"put_",}]});
foam.CLASS({package:"foam.dao",name:"ValidatingDAO",extends:"foam.dao.ProxyDAO",properties:[{class:"FObjectProperty",of:"Validator",name:"validator"}],methods:[{name:"put_",}]});
foam.CLASS({package:"foam.nanos.test",name:"StockSnapshot",implements:["foam.nanos.analytics.Foldable"],ids:["time","symbol"],properties:[{class:"DateTime",name:"time"},{class:"String",name:"symbol"},{class:"Float",name:"price"}],methods:[{name:"doFolds",}]});foam.INTERFACE({package:"foam.nanos.analytics",name:"FoldManager",methods:[{name:"foldForState",args:[{type:"Object",name:"key"},{type:"DateTime",name:"time"},{type:"Float",name:"value"}]}]});
foam.CLASS({package:"foam.nanos.analytics",name:"FoldManagerDAODecorator",extends:"foam.dao.ProxyDAO",properties:[{class:"FObjectProperty",of:"foam.nanos.analytics.FoldManager",name:"fm"}],methods:[{name:"put_",}]});
foam.CLASS({package:"foam.nanos.analytics",name:"DAOFoldManager",implements:["foam.nanos.analytics.FoldManager"],requires:["foam.nanos.analytics.Candlestick"],properties:[{class:"foam.dao.DAOProperty",name:"dao"},{class:"Long",name:"periodLengthMs",},{class:"foam.mlang.ExprProperty",name:"closeTimeExpr"},{class:"Object",name:"locks",transient:true,}],methods:[{name:"getLock",type:"Object",args:[{name:"key",type:"Object"}],},{name:"foldForState",}]});
foam.CLASS({package:"foam.nanos.analytics",name:"DAOReduceManager",properties:[{class:"foam.dao.DAOProperty",name:"sourceDAO"},{class:"foam.dao.DAOProperty",name:"destDAO"},{class:"Long",name:"periodLengthMs",},{class:"foam.mlang.ExprProperty",name:"closeTimeExpr"}],methods:[{name:"doReduce",synchronized:true,}]});
foam.CLASS({package:"foam.java",name:"ParseTemplateTestModel",templates:[{template:`Hello, my name is <%= name %>`,name:`testRawValue`},{name:"testRawValueWithArg",args:[{name:"name",type:"String"}],template:"argument name value: <%= name %>"},{template:`<% if ( testsPassed ) %>This is my legacy<% else %>Please find somebody to blame`,name:`testCode`,args:[{name:"testsPassed",type:"Boolean"}]}],properties:[{class:"String",name:"name",value:"Kristina"}]});
foam.CLASS({package:"foam.java",name:"ParseTemplateTest",extends:"foam.nanos.test.Test",methods:[{name:"runTest",}]});
foam.CLASS({package:"foam.i18n",name:"LocaleTranslationService",implements:["foam.i18n.TranslationService"],methods:[{name:"getTranslations",},{name:"getTranslation",}]});
foam.CLASS({package:"foam.u2.view",name:"ComparisonView",extends:"foam.u2.View",requires:["foam.core.FObject","foam.u2.ModalHeader","foam.u2.DetailView","foam.u2.detail.VerticalDetailView","foam.u2.layout.Cols"],properties:[{name:"left",type:"FObject"},{name:"right",type:"FObject"}],methods:[function render(){this.SUPER();this.addClass().startContext({controllerMode:"VIEW"}).start().start(this.Cols).start().addClass("h500").add("Before").tag(this.VerticalDetailView,{showTitle:true,title:"Before",data:this.left}).end().start().addClass("h500").add("After").tag(this.VerticalDetailView,{showTitle:true,title:"After",data:this.right}).end().end().end().endContext()}]});
foam.CLASS({package:"foam.u2.view",name:"SuggestedTextField",extends:"foam.u2.View",requires:["foam.u2.Autocompleter","foam.u2.CitationView","foam.u2.TextField"],imports:["onRowSelect?"],css:`
^ {
position: relative;
}
^suggestions {
box-shadow: 0px 2px 4px rgba(0, 0, 0, 0.06), 0px 4px 6px rgba(0, 0, 0, 0.1);
background-color: /*%WHITE%*/ #ffffff;
border: 1px solid /*%GREY3%*/ #cbcfd4;
border-radius: 4px;
display: flex;
flex-direction: column;
height: auto;
margin-top: 2px;
max-height: 14em;
overflow: auto;
padding: 6px;
position: absolute;
width: 100%;
z-index: 100;
}
^suggestions > * + * {
margin-top: 4px;
}
^row {
color: /*%GREY1%*/ #5e6061;
cursor: pointer;
padding: 4px 8px;
}
`,messages:[{name:"SUGGESTIONS_MSG",message:"Suggestions"},{name:"NO_SUGGESTIONS_MSG",message:"No Suggestions"}],properties:["prop",{class:"String",name:"daoKey"},{class:"FObjectProperty",of:"foam.u2.Autocompleter",name:"autocompleter",factory:function(){if(!this.daoKey)console.error("No daokey");return this.Autocompleter.create({dao:this.__subContext__[this.daoKey]})}},{class:"foam.u2.ViewSpec",name:"rowView",value:{class:"foam.u2.CitationView"}},{name:"onSelect",value:function(obj){this.data=obj.toSummary()}},{class:"String",name:"title",factory:function(){return this.SUGGESTIONS_MSG}},{class:"String",name:"emptyTitle",factory:function(){return this.NO_SUGGESTIONS_MSG}},{class:"Array",name:"filteredValues"},{class:"String",name:"placeholder"},{class:"Boolean",name:"suggestOnFocus"},"inputFocused"],methods:[function render(){var self=this;this.SUPER();var callFromProperty=function(){self.prop&&this.fromProperty&&this.fromProperty(self.prop)};if(this.autocompleter)this.autocompleter.partial$=this.data$;this.onDetach(this.onload.sub(this.loaded));this.addClass().start(this.TextField,{data$:this.data$,onKey:true,placeholder$:this.placeholder$,autocomplete:false}).call(callFromProperty).on("focus",()=>{this.inputFocused=true}).on("blur",()=>{this.inputFocused=false}).end().add(this.slot(this.populate))},function populate(filteredValues,data,inputFocused,suggestOnFocus){const self=this;if(!data&&!suggestOnFocus||!inputFocused)return this.E();if(!filteredValues.length)return this.E().addClass(this.myClass("suggestions")).add(this.emptyTitle);return this.E().addClass(this.myClass("suggestions")).add(this.title).forEach(this.filteredValues,function(obj){this.start(self.rowView,{data:obj}).addClass(self.myClass("row")).on("mousedown",function(e){self.onRowSelect?self.onRowSelect(obj):self.onSelect.call(self,obj);self.inputFocused=false;e.preventDefault()}).end()})},function fromProperty(prop){this.prop=prop}],listeners:[{name:"onUpdate",isFramed:true,code:function(){this.autocompleter.filteredDAO.select().then(sink=>{this.filteredValues=sink.array})}},function loaded(){this.onDetach(this.autocompleter.filteredDAO$proxy.sub(this.onUpdate));this.onUpdate()}]});
foam.CLASS({package:"foam.dashboard.view",name:"CenteredDashboardCitationView",extends:"foam.dashboard.view.DashboardCitationView",css:`
^ {
align-items: center;
margin: auto;
width: 75%;
height: 100%;
padding: 0;
}
^id {
font-size: 1.5rem;
font-weight: 400;
}
^value {
font-size: 1.5rem;
font-weight: 400;
}
`});
foam.CLASS({package:"foam.dashboard.view",name:"GroupedDAOTableWidget",extends:"foam.dashboard.view.DAOTable",implements:["foam.mlang.Expressions"],properties:[{name:"daoKey",},{class:"foam.mlang.ExprProperty",name:"arg1"},{class:"foam.mlang.SinkProperty",name:"arg2"}],methods:[async function init(){this.SUPER();var self=this;result=await self.__subContext__[self.daoKey].where(self.predicate).select(self.GROUP_BY(self.arg1,self.arg2));var a=[];for(var i=0;i<result.groupKeys.length;i++){var value=await self.format(result.groupKeys[i],result.groups[result.groupKeys[i]].value);a.push(value)}self.dao=foam.dao.ArrayDAO.create({array:a},self)},function format(key,value){return{id:key,value:value}}],listeners:[{name:"fetchValues",code:function(){var self=this;if(!this.dao)return;this.dao.limit(this.limit).select().then(objects=>{var fetchedValues=objects.array;if(JSON.stringify(self.currentValues.map(o=>o.id))!=JSON.stringify(fetchedValues.map(o=>o.id))){self.currentValues=fetchedValues}})}}]});
foam.CLASS({package:"foam.u2.view",name:"GlobalFuidSearch",extends:"foam.u2.view.SuggestedTextField",requires:["foam.core.Action","foam.nanos.menu.Menu","foam.u2.FUIDAutocompleter","foam.u2.md.OverlayDropdown","foam.u2.stack.StackBlock"],implements:["foam.mlang.Expressions"],imports:["stack","ctrl"],css:`
^suggestions {
background-color: /*%GREY5%*/ #5e6061;
border: none;
position: relative;
}
^suggestions > * + * {
margin-top: 8px;
}
^row {
background-color: /*%GREY5%*/ #5e6061
cursor: pointer;
padding: 8px;
text-align: center;
}
`,properties:[{class:"FObjectProperty",of:"foam.u2.FUIDAutocompleter",name:"autocompleter",factory:function(){return this.FUIDAutocompleter.create()}},{class:"String",name:"title",value:""},{class:"String",name:"emptyTitle",value:""},{name:"onSelect",value:async function(obj,e){var menus=[];var menuDAOS=this.saltMap[obj.daoKey];for(var i=0;i<menuDAOS.length;i++){var result=await menuDAOS[i].handler.config.dao.find(obj.data);if(result)menus.push(menuDAOS[i])}var selection=menus.map(c=>{return this.Action.create({label:c.label+" ("+c.id+")",code:function(){this.menuPush(obj.data,c)}})});var overlay=this.OverlayDropdown.create({parentEl:this});this.ctrl.add(overlay);var el=this.E().startContext({data:this,dropdown:overlay}).forEach(selection,function(action,index){this.start().addClass(this.myClass("button-container")).tag(action,{buttonStyle:"UNSTYLED"}).attrs({tabindex:-1}).end()}).endContext();overlay.add(el);overlay.open(e.clientX,e.clientY)}},{class:"Map",name:"saltMap"}],methods:[function populate(filteredValues,data,inputFocused){var self=this;if(!data)return this.E();if(!filteredValues.length)return this.E().addClass(this.myClass("suggestions")).add(this.emptyTitle);var a=this.E().addClass(this.myClass("suggestions")).add(this.title);for(var i=0;i<self.filteredValues.length;i++){let obj=self.filteredValues[i];a.start(this.rowView,{data:obj.data,of:obj.data.cls_.id}).addClass(self.myClass("row")).on("mousedown",function(e){self.onRowSelect?self.onRowSelect(obj,e):self.onSelect.call(self,obj,e)}).end()}return a}],listeners:[{name:"onUpdate",isFramed:true,code:function(){this.filteredValues=this.autocompleter.filtered;var self=this;var menuDao=this.__subContext__["menuDAO"];if(Object.keys(this.saltMap).length>0)return;menuDao.select(async function(obj){if(!obj?.handler?.config?.daoKey&&!self.__subContext__[obj?.handler?.config?.daoKey])return;try{var salt=await self.__subContext__[obj.handler.config.daoKey].cmd_(self,foam.dao.FUIDDAO.SALT_CMD)}catch{}if(salt){if(!self.saltMap[salt])self.saltMap[salt]=[];if(!self.saltMap[salt].includes(obj))self.saltMap[salt].push(obj)}})}},function loaded(){this.onDetach(this.autocompleter.filtered$.sub(this.onUpdate))},function menuPush(obj,menu){if(!this.stack)return;this.stack.push(this.StackBlock.create({view:{class:"foam.comics.v2.DAOSummaryView",data:obj,config:menu.handler.config,idOfRecord:obj.id},parent:this.__subContext__.createSubContext({currentControllerMode:"view"})},this))}]});
foam.CLASS({package:"foam.u2",name:"FUIDAutocompleter",extends:"foam.u2.Autocompleter",imports:["globalSearchService"],properties:["filtered"],listeners:[{name:"onUpdate",isFramed:true,code:async function onUpdate(){var res=this.partial?await this.globalSearchService.searchById(this,this.partial):[];var temp=[];for(var[daoKey,data]of Object.entries(res)){temp.push({daoKey:daoKey,data:data})}this.filtered=temp}}]});
foam.CLASS({package:"foam.u2.view",name:"FUIDSearch",extends:"foam.u2.View",requires:["foam.u2.view.GlobalFuidSearch"],css:`
^{
display: flex;
flex-direction: column;
gap: 16px;
height: 100%;
justify-content: flex-start;
padding: 36px 16px 8px 16px;
}
^search {
align-self: center;
width: 75%;
}
@media only screen and (min-width: 768px) {
^{
padding: 24px 32px 16px 32px;
}
}
`,messages:[{name:"TITLE",message:"FUID Search"}],properties:[{name:"viewTitle",value:"FUID Search"}],methods:[function render(){this.addClass(this.myClass()).start().addClass("h300").add(this.TITLE).end().start(this.GlobalFuidSearch,{placeholder:"Search..."}).addClass(this.myClass("search")).end()}]});
foam.CLASS({package:"foam.nanos.cron",name:"SimpleIntervalScheduleView",extends:"foam.u2.View",imports:["displayWidth?"],css:`
^ {
width: 100%;
display: flex;
align-self: center;
}
^container {
display: grid;
gap: 12px 8px;
}
^fullWidth {
grid-column: span 12;
}
^halfWidth {
grid-column: span 6;
}
`,methods:[function render(){var self=this;let data=this.data;this.addClass().start().style({"grid-template-columns":this.displayWidth$.map(dw=>{dw=dw||foam.u2.layout.DisplayWidth.XL;return`repeat(${dw.cols}, 1fr)`})}).addClass(this.myClass("container")).start(data.START_DATE.__).addClass(this.myClass("fullWidth")).end().start(data.REPEAT.__).addClass(this.myClass("halfWidth")).end().start(data.FREQUENCY.__).addClass(this.myClass("halfWidth")).end().add(this.slot(function(data$frequency){if(data$frequency=="WEEK")return this.E().add(data.DAY_OF_WEEK.__).addClass(this.myClass("fullWidth"));if(data$frequency=="MONTH")return self.addGrid().addClass(this.myClass("fullWidth")).start(data.MONTHLY_CHOICE.__).addClass(this.myClass("fullWidth")).end().start().addClass(this.myClass("fullWidth")).add(this.slot(function(data$monthlyChoice){if(!data$monthlyChoice)return this.E().show(false);if(data$monthlyChoice=="EACH")return this.E().add(data.DAY_OF_MONTH.__);return self.addGrid().start(data.SYMBOLIC_FREQUENCY.__).addClass(this.myClass("halfWidth")).end().start(data.EXPANDED_DAY_OF_WEEK.__).addClass(this.myClass("halfWidth")).end()})).end();return this.E().show(false)})).start(data.ENDS.__).addClass(this.myClass("halfWidth")).end().start().addClass(this.myClass("halfWidth")).add(this.slot(function(data$ends){return data$ends?data$ends==foam.nanos.cron.ScheduleEnd.ON?self.data.ENDS_ON.__:self.data.ENDS_AFTER.__:""})).end().end()},function addGrid(){return this.E().style({"grid-template-columns":this.displayWidth$.map(dw=>{dw=dw||foam.u2.layout.DisplayWidth.XL;return`repeat(${dw.cols}, 1fr)`})}).addClass(this.myClass("container"))}]});
foam.CLASS({package:"foam.u2.view",name:"ClassCompleterView",extends:"foam.u2.view.SuggestedTextField",classes:[{name:"ClassHolder",properties:["id","cls"],methods:[function toSummary(){return this.id}]}],properties:[{name:"clsDAO",factory:function(){let a=foam.dao.ArrayDAO.create({of:this.ClassHolder},this);Object.keys(foam.USED).map(v=>{a.put(this.ClassHolder.create({id:v,cls:foam.USED[v]}))});return a}},{name:"autocompleter",factory:function(){return this.Autocompleter.create({dao:this.clsDAO})}},{name:"placeholder",value:"Enter Class Name"}]});
foam.CLASS({package:"foam.css",name:"TokenExpr",properties:[{name:"arg1"}],methods:[function f(o){return foam.CSS.returnTokenValue(this.arg1,o.cls_,o.__subContext__)}]});
foam.CLASS({package:"foam.css",name:"LightenExpr",requires:["foam.mlang.Constant"],properties:[{name:"arg1",adapt:function(_,n){if(foam.String.isInstance(n)){return this.Constant.create({value:n})}return n}},{name:"arg2",adapt:function(_,n){if(foam.Number.isInstance(n)){return this.Constant.create({value:n})}return n}}],methods:[function f(o){const color=this.arg1.f(o);const amount=this.arg2.f(o);return foam.Color.lighten(color,amount)}]});
foam.CLASS({package:"foam.css",name:"FindForegroundExpr",requires:["foam.mlang.Constant"],properties:[{name:"baseColor",adapt:function(_,n){if(foam.String.isInstance(n)){return this.Constant.create({value:n})}return n}},{name:"darkColor",adapt:function(_,n){if(foam.String.isInstance(n)){return this.Constant.create({value:n})}return n}},{name:"lightColor",adapt:function(_,n){if(foam.String.isInstance(n)){return this.Constant.create({value:n})}return n}}],methods:[function f(o){const color=this.baseColor.f(o);const dark=this.darkColor.f(o);const light=this.lightColor.f(o);return foam.Color.getBestForeground(color,dark,light)}]});
foam.CLASS({package:"foam.css",name:"TokenUtilsBuilder",requires:["foam.css.FindForegroundExpr","foam.css.LightenExpr","foam.css.TokenExpr"],methods:[function TOKEN(name){return this.TokenExpr.create({arg1:name})},function LIGHTEN(a,b){return this.LightenExpr.create({arg1:a,arg2:b})},function FOREGROUND(a,b,c){return this.FindForegroundExpr.create({baseColor:a,darkColor:b,lightColor:c})}]});
foam.CLASS({package:"com.example",name:"Product",constants:[{name:"PRODUCTS",value:[{name:"cheese grater",description:"it makes cheese smaller",cost:5},{name:"frying pan",description:"helps make food get hotter",cost:10},{name:"monkey wrench",description:"used to make things tight or loose",cost:8}]}],properties:[{class:"String",name:"id",factory:function(){return foam.uuid.randomGUID()}},{class:"String",name:"name"},{class:"String",name:"description"},{class:"Long",name:"cost"}]});
foam.CLASS({package:"com.example",name:"ProductCitationView",extends:"foam.u2.CitationView",requires:["com.example.CartItem"],css:`
^ {
display: flex;
flex-gap: 20px;
padding: 15px;
cursor: pointer;
border-radius: 5px;
}
^:hover {
background-color: #CCCCCC;
}
^name {
font-family: Helvetica, sans-serif;
font-weight: 600;
flex-basis: 200px;
}
^cost {
font-family: Helvetica, sans-serif;
font-weight: 600;
color: orange;
flex-basis: 60px;
}
^count {
font-family: Helvetica, sans-serif;
font-weight: 600;
color: blue;
flex-basis: 60px;
}
`,properties:[{class:"Boolean",name:"isCart",expression:function(data){return this.CartItem.isInstance(data)}}],methods:[function render(){this.addClass().start().addClass(this.myClass("name")).add(this.data.name).end().start().addClass(this.myClass("cost")).add(this.data.cost).end().start().show(this.isCart$).addClass(this.myClass("count")).addClass(this.myClass("count")).add(this.data.count).end().start().add(this.data.description).end()}]});
foam.CLASS({package:"com.example",name:"CartItem",properties:[{class:"Reference",of:"com.example.Product",name:"id"},{class:"Int",name:"count"},{class:"String",name:"name"},{class:"String",name:"description"},{class:"Long",name:"cost"}]});
foam.CLASS({package:"com.example",name:"ShoppingController",extends:"foam.u2.Controller",exports:["productDAO"],requires:["com.example.Product","com.example.CartItem","foam.dao.MDAO"],properties:[{name:"productDAO",factory:function(){const dao=this.MDAO.create({of:"com.example.Product"});for(const product of this.Product.PRODUCTS){dao.put(foam.json.parse(product,this.Product,this.__subContext__))}return dao},view:function(_,x){const view=foam.u2.DAOList.create({rowView:"com.example.ProductCitationView"});view.rowClick.sub(x.data.productClick);return view}},{name:"cartDAO",factory:function(){const dao=this.MDAO.create({of:"com.example.Product"});return dao},view:function(_,x){const view=foam.u2.DAOList.create({rowView:"com.example.ProductCitationView"});return view}}],methods:[function render(){this.start("h1").add("Hello, FOAM!").end().start("h2").add("Products").end().add(this.PRODUCT_DAO).start("h2").add("Cart").end().add(this.CART_DAO)}],listeners:[{name:"productClick",code:async function(sub,_,obj){console.log("clicked item: "+obj.name);let item=await this.cartDAO.find(obj.id);if(!item){item=this.CartItem.create({id:obj.id,count:1});item.copyFrom(obj)}else{item.count++}this.cartDAO.put(item)}}]});